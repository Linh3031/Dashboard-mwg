SNAPSHOT GROUP: snapshot_features.txt


================================================================================
File: src/components/health-staff/CategoryRevenueView.svelte
================================================================================

<script>
  import { onMount } from 'svelte';
  import { customRevenueTables, modalState, isAdmin, selectedWarehouse } from '../../stores.js';
  import { adminService } from '../../services/admin.service.js';
  import { datasyncService } from '../../services/datasync.service.js';
  import DynamicRevenueTable from './DynamicRevenueTable.svelte';

  export let reportData = [];

  let isLoading = false;
  // Bi·∫øn tƒ©nh (module-level) ƒë·ªÉ ghi nh·ªõ kho ƒë√£ t·∫£i l·∫ßn cu·ªëi c√πng component n√†y ƒë∆∞·ª£c mount
  let lastLoadedWarehouse = '';

  // [FIX CRASH] Logic t√≠nh to√°n visibleTables an to√†n tuy·ªát ƒë·ªëi
  $: visibleTables = ($customRevenueTables || []).reduce((acc, table, index) => {
      // Ch·ªâ l·∫•y b·∫£ng ch∆∞a b·ªã ·∫©n
      if (table.isVisible !== false) {
          acc.push({
              ...table,
              // N·∫øu id null/undefined, t·∫°o id t·∫°m d·ª±a tr√™n index ƒë·ªÉ Svelte kh√¥ng b√°o duplicate key
              id: table.id ? table.id : `fallback_render_id_${index}` 
          });
      }
      return acc;
  }, []);

  // [LOGIC M·ªöI] Khi Kho thay ƒë·ªïi -> T·∫£i l·∫°i d·ªØ li·ªáu (C√≥ ki·ªÉm tra Cache)
  $: if ($selectedWarehouse) {
      handleWarehouseDataLoad($selectedWarehouse);
  }

  async function handleWarehouseDataLoad(kho) {
      // CASE 1: D·ªØ li·ªáu ƒë√£ c√≥ trong Store v√† ƒë√∫ng l√† c·ªßa kho hi·ªán t·∫°i (ho·∫∑c ch∆∞a ch·ªçn kho specific)
      // -> KH√îNG T·∫¢I L·∫†I (Instant load)
      if ($customRevenueTables.length > 0 && lastLoadedWarehouse === kho) {
          console.log(`[CategoryView] D√πng Cache Store cho kho: ${kho}`);
          return;
      }

      // CASE 2: Ch∆∞a c√≥ d·ªØ li·ªáu ho·∫∑c ƒë·ªïi kho -> Ti·∫øn h√†nh t·∫£i
      await loadData(kho);
  }

  async function loadData(kho) {
      console.log(`[CategoryView] Loading tables for warehouse: ${kho}`);
      
      // Ch·ªâ hi·ªán loading n·∫øu Store ƒëang r·ªóng (tr√°nh ch·ªõp nh√°y khi refresh ng·∫ßm)
      if ($customRevenueTables.length === 0) {
          isLoading = true;
      }
      
      try {
          // 1. T·∫£i b·∫£ng H·ªá th·ªëng (Global)
          const systemTables = await adminService.loadSystemRevenueTables();
          
          // 2. T·∫£i b·∫£ng C√° nh√¢n (Warehouse Cloud)
          const personalTables = await datasyncService.loadPersonalRevenueTables(kho);

          // 3. T·∫£i Preferences ·∫©n/hi·ªán (Local)
          const hiddenSystemIds = JSON.parse(localStorage.getItem('hiddenSystemTableIds') || '[]');

          // 4. Merge & Sanitize (L√†m s·∫°ch d·ªØ li·ªáu)
          const finalSystemTables = (systemTables || []).map((t, index) => ({
              ...t,
              id: t.id || `sys_gen_${index}_${Date.now()}`, 
              isSystem: true,
              isVisible: !hiddenSystemIds.includes(t.id)
          }));

          const safePersonalTables = (personalTables || []).map((t, index) => ({
              ...t,
              id: t.id || `per_gen_${index}_${Date.now()}` 
          }));

          // C·∫≠p nh·∫≠t Store
          customRevenueTables.set([...finalSystemTables, ...safePersonalTables]);
          
          // Ghi nh·ªõ kho ƒë√£ t·∫£i th√†nh c√¥ng
          lastLoadedWarehouse = kho;

      } catch (e) {
          console.error("[CategoryView] L·ªói t·∫£i d·ªØ li·ªáu b·∫£ng:", e);
      } finally {
          isLoading = false;
      }
  }

  // --- C√ÅC H√ÄM X·ª¨ L√ù S·ª∞ KI·ªÜN ---
  async function savePersonalTables() {
      if (!$selectedWarehouse) return;
      const personalTables = $customRevenueTables.filter(t => !t.isSystem);
      await datasyncService.savePersonalRevenueTables($selectedWarehouse, personalTables);
  }

  function saveHiddenPreferences() {
      const hiddenIds = $customRevenueTables
          .filter(t => t.isSystem && t.isVisible === false)
          .map(t => t.id);
      localStorage.setItem('hiddenSystemTableIds', JSON.stringify(hiddenIds));
  }

  function toggleTableVisibility(id) {
      if (!id || String(id).startsWith('fallback_render_id_')) return;
      customRevenueTables.update(items => items.map(t => t.id === id ? { ...t, isVisible: !t.isVisible } : t));
      savePersonalTables();
      saveHiddenPreferences();
  }

  function editTable(table) {
      if (String(table.id).startsWith('fallback_render_id_')) {
          alert("B·∫£ng n√†y ƒëang b·ªã l·ªói d·ªØ li·ªáu, kh√¥ng th·ªÉ s·ª≠a.");
          return;
      }
      if (table.isSystem && !$isAdmin) {
          alert("B·∫°n kh√¥ng c√≥ quy·ªÅn ch·ªânh s·ª≠a B·∫£ng h·ªá th·ªëng.");
          return;
      }
      modalState.update(s => ({ ...s, activeModal: 'add-revenue-table-modal', payload: table }));
  }

  async function deleteTable(id) {
      if (!id || String(id).startsWith('fallback_render_id_')) {
          customRevenueTables.update(items => items.filter(t => t.id)); 
          return;
      }

      const targetTable = $customRevenueTables.find(t => t.id === id);
      if (!targetTable) return;

      if (targetTable.isSystem) {
          if ($isAdmin) {
               if (!confirm("C·∫¢NH B√ÅO ADMIN: X√≥a b·∫£ng H·ªÜ TH·ªêNG n√†y vƒ©nh vi·ªÖn?")) return;
              const newTables = $customRevenueTables.filter(t => t.id !== id);
              customRevenueTables.set(newTables);
              await adminService.saveSystemRevenueTables(newTables);
          } else {
              if (!confirm("·∫®n b·∫£ng n√†y kh·ªèi m√†n h√¨nh c·ªßa b·∫°n?")) return;
              customRevenueTables.update(items => items.map(t => t.id === id ? { ...t, isVisible: false } : t));
              saveHiddenPreferences();
          }
      } else {
          if (!confirm("B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a b·∫£ng n√†y? H√†nh ƒë·ªông n√†y s·∫Ω x√≥a tr√™n Cloud c·ªßa kho hi·ªán t·∫°i.")) return;
          customRevenueTables.update(items => items.filter(t => t.id !== id));
          await savePersonalTables();
      }
  }

  function openAddModal() {
      if (!$selectedWarehouse) {
          alert("Vui l√≤ng ch·ªçn Kho tr∆∞·ªõc khi t·∫°o b·∫£ng m·ªõi.");
          return;
      }
     modalState.update(s => ({ ...s, activeModal: 'add-revenue-table-modal', payload: null }));
  }

  $: hasAnyData = reportData.length > 0;
  const colors = ['blue', 'green', 'orange', 'purple', 'teal', 'indigo', 'rose'];
  const getColor = (index) => colors[index % colors.length];
</script>

{#if isLoading}
    <div class="flex flex-col items-center justify-center p-12 text-blue-500">
        <svg class="animate-spin h-8 w-8 mb-3" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
        </svg>
        <p class="text-sm font-semibold">ƒêang t·∫£i c·∫•u h√¨nh b·∫£ng...</p>
    </div>
{:else}

    {#if $customRevenueTables.length > 0}
    <div class="mb-6 flex flex-wrap items-center gap-2 bg-white p-3 rounded-xl border border-gray-200 shadow-sm">
        <div class="text-xs font-bold uppercase text-gray-500 mr-2 flex items-center gap-1">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z" /></svg>
            B·∫£ng hi·ªÉn th·ªã:
        </div>
        {#each $customRevenueTables as table, index}
            <button 
                class="px-3 py-1.5 rounded-full text-xs font-medium border transition-all 
                    duration-200 flex items-center gap-1.5 select-none
                    {table.isVisible !== false ? 'bg-blue-600 text-white border-blue-600 shadow-md transform -translate-y-0.5' : 'bg-gray-100 text-gray-500 border-gray-200 hover:bg-gray-200'}
                    {table.isSystem ? 'border-dashed' : ''}"
                on:click={() => toggleTableVisibility(table.id || `fallback_render_id_${index}`)}
                title={table.isSystem ? "B·∫£ng h·ªá th·ªëng" : "B·∫£ng c√° nh√¢n"}
            >
                {#if table.isSystem}<span class="text-[10px] mr-0.5 opacity-70">üåê</span>{/if}
                {table.title || '(Kh√¥ng t√™n)'}
            </button>
        {/each}
        <button class="px-3 py-1.5 rounded-full text-xs font-bold border 
    border-dashed border-gray-300 text-gray-500 hover:text-blue-600 hover:border-blue-400 hover:bg-blue-50 transition-colors ml-auto flex items-center gap-1" on:click={openAddModal}>
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" /></svg>
            T·∫°o m·ªõi
        </button>
    </div>
    {/if}

    {#if !hasAnyData}
        <div class="p-12 text-center bg-gray-50 rounded-xl border border-gray-200 border-dashed">
            <p class="text-gray-500 font-medium">Ch∆∞a c√≥ d·ªØ li·ªáu b√°o c√°o nh√¢n vi√™n.</p>
        </div>
    {:else if $customRevenueTables.length === 0}
        <div class="p-12 text-center bg-white rounded-xl border border-blue-100 shadow-sm flex flex-col items-center">
            <div class="w-16 h-16 bg-blue-50 rounded-full flex items-center justify-center mb-4 text-blue-500">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 
    0 01.293.707V19a2 2 0 01-2 2z" /></svg>
            </div>
            <h4 class="text-lg font-bold text-gray-800 mb-2">Ch∆∞a c√≥ B·∫£ng b√°o c√°o n√†o</h4>
            <p class="text-gray-500 mb-6 max-w-md">B·∫°n ch∆∞a t·∫°o b·∫£ng theo d√µi n√†o.</p>
            <button class="px-6 py-2.5 bg-blue-600 text-white rounded-lg font-bold hover:bg-blue-700 shadow-md flex items-center gap-2" on:click={openAddModal}>
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" /></svg>
                T·∫°o b·∫£ng ngay
            </button>
        </div>
    {:else if visibleTables.length === 0}
        <div class="p-12 text-center bg-gray-50 rounded-xl border border-gray-200">
            <p class="text-gray-500 font-medium">B·∫°n ƒë√£ ·∫©n t·∫•t c·∫£ c√°c b·∫£ng. Vui 
    l√≤ng b·∫≠t l·∫°i tr√™n thanh c√¥ng c·ª•.</p>
        </div>
    {:else}
        <div class="grid grid-cols-1 xl:grid-cols-2 gap-6 pb-10">
            {#each visibleTables as table, index (table.id)}
                <div data-capture-group="category-revenue">
                    <DynamicRevenueTable 
                        config={table}
                        {reportData}
                        colorTheme={getColor(index)}
                        on:edit={() => editTable(table)}
                        on:delete={() => deleteTable(table.id)}
                    />
                </div>
            {/each}
        </div>
    {/if}

{/if}

================================================================================
File: src/components/health-staff/CompetitionTab.svelte
================================================================================

<script>
  import { onMount } from 'svelte';
  import { 
      ycxData, 
      globalCompetitionConfigs, 
      localCompetitionConfigs,
      pastedThiDuaReportData 
  } from '../../stores.js';
  import { services } from '../../services.js';

  import CompetitionModeSelector from './competition/CompetitionModeSelector.svelte';
  import ProgramView from './competition/ProgramView.svelte';
  import EmployeeView from './competition/EmployeeView.svelte';
  // [NEW] Import view chi ti·∫øt m·ªõi
  import CompetitionDetailView from './competition/CompetitionDetailView.svelte';

  // [Y√äU C·∫¶U] M·∫∑c ƒë·ªãnh v√†o l√† xem theo nh√¢n vi√™n
  let activeView = 'employee'; 
  let programReportData = [];
  
  // [NEW] State cho view chi ti·∫øt
  let isDetailView = false;
  let selectedEmployeeId = null;

  // Logic t√≠nh to√°n cho Program View (T·ª± ƒë·ªông khi YCX ho·∫∑c Config thay ƒë·ªïi)
  $: {
      if ($ycxData.length > 0) {
          const allConfigs = [...$globalCompetitionConfigs, ...$localCompetitionConfigs];
          programReportData = services.calculateCompetitionFocusReport($ycxData, allConfigs);
      } else {
          programReportData = [];
      }
  }

  function handleViewChange(event) {
      activeView = event.detail;
      // Reset v·ªÅ list khi ƒë·ªïi tab con
      isDetailView = false;
      selectedEmployeeId = null;
  }

  // [NEW] X·ª≠ l√Ω khi click v√†o nh√¢n vi√™n
  function handleViewDetail(event) {
      selectedEmployeeId = event.detail.employeeId;
      isDetailView = true;
  }

  // [NEW] X·ª≠ l√Ω quay l·∫°i
  function handleBackToList() {
      isDetailView = false;
      selectedEmployeeId = null;
  }
</script>

<div class="space-y-6">
    <div class="flex flex-wrap items-center justify-between gap-4 bg-white p-4 rounded-xl border border-gray-200 shadow-sm">
        <div class="flex items-center gap-3">
            <div class="p-2 bg-purple-100 rounded-lg text-purple-600">
                <i data-feather="award" class="w-5 h-5"></i>
            </div>
            <div>
                <h3 class="text-lg font-bold text-gray-800 uppercase leading-tight">Thi ƒêua L≈©y K·∫ø</h3>
                <p class="text-xs text-gray-500">Theo d√µi ti·∫øn ƒë·ªô c√°c ch∆∞∆°ng tr√¨nh thi ƒëua</p>
            </div>
        </div>
        
        <CompetitionModeSelector {activeView} on:change={handleViewChange} />
    </div>

    <div class="min-h-[400px]">
        {#if activeView === 'program'}
            <ProgramView reportData={programReportData} />
        {:else}
            {#if isDetailView && selectedEmployeeId}
                <CompetitionDetailView 
                    employeeId={selectedEmployeeId}
                    allReportData={$pastedThiDuaReportData}
                    on:back={handleBackToList}
                />
            {:else}
                <EmployeeView 
                    reportData={$pastedThiDuaReportData} 
                    on:viewChange={(e) => activeView = e.detail}
                    on:viewDetail={handleViewDetail} 
                />
            {/if}
        {/if}
    </div>
</div>

================================================================================
File: src/components/health-staff/DynamicRevenueTable.svelte
================================================================================

<script>
  import { createEventDispatcher, onMount } from 'svelte';
  
  // [FIX IMPORT] ƒê∆∞·ªùng d·∫´n t∆∞∆°ng ƒë·ªëi
  import { formatters } from '../../utils/formatters.js';
  import { isAdmin } from '../../stores.js';
  import { dynamicTableProcessor } from '../../services/processing/logic/dynamicTable.processor.js';
  
  import DynamicTableHeader from './revenue/DynamicTableHeader.svelte';
  import DynamicTableRow from './revenue/DynamicTableRow.svelte';
  
  export let config;
  export let reportData = []; 
  export let colorTheme = 'blue'; 

  const dispatch = createEventDispatcher();

  let sortKey = 'mainValue';
  let sortDirection = 'desc';

  $: tableMetrics = config.mainColumn?.metrics || config.tableMetrics || { sl: false, dt: true, dtqd: false };

  // X·ª≠ l√Ω d·ªØ li·ªáu
  $: processedResult = dynamicTableProcessor.processTableData(reportData, config);
  $: processedData = processedResult.processedData;
  $: totals = processedResult.totals;

  // [FIX CRITICAL] H√†m l·∫•y gi√° tr·ªã sort th√¥ng minh
  function getSortValue(item, key) {
      let val;

      // 1. X·ª≠ l√Ω c√°c tr∆∞·ªùng c∆° b·∫£n
      if (key === 'hoTen') return item.hoTen;
      if (key === 'mainValue') val = item.mainValue;
      else if (key === 'totalSL') val = item.mainValue_sl;
      else if (key === 'totalDTQD') val = item.mainValue_dtqd;
      else {
          // 2. X·ª≠ l√Ω c·ªôt ƒë·ªông (Dynamic Columns)
          // Tr∆∞·ªùng h·ª£p key c√≥ d·∫°ng "ColID|Metric" (VD: Laptop|sl)
          if (key.includes('|')) {
              const [colId, metric] = key.split('|');
              if (item.cells && item.cells[colId]) {
                  // Map metric sang t√™n tr∆∞·ªùng d·ªØ li·ªáu th·ª±c t·∫ø
                  if (metric === 'sl') val = item.cells[colId].value_sl || item.cells[colId].sl;
                  else if (metric === 'dt') val = item.cells[colId].value || item.cells[colId].dt;
                  else if (metric === 'dtqd') val = item.cells[colId].value_dtqd || item.cells[colId].dtqd;
                  else val = item.cells[colId].value; // M·∫∑c ƒë·ªãnh l·∫•y DT
              }
          } 
          // Tr∆∞·ªùng h·ª£p key l√† ID c·ªôt ƒë∆°n thu·∫ßn
          else if (item.cells && item.cells[key]) {
              val = item.cells[key].value; 
          } else {
              val = 0;
          }
      }

      // 3. √âp ki·ªÉu s·ªë an to√†n (Ch·ªëng l·ªói NaN)
      let finalVal = 0;
      if (typeof val === 'string') {
          // X√≥a t·∫•t c·∫£ k√Ω t·ª± kh√¥ng ph·∫£i s·ªë/d·∫•u ch·∫•m/d·∫•u tr·ª´ (VD: "1,200" -> 1200)
          const cleanStr = val.replace(/[^\d.-]/g, '');
          finalVal = parseFloat(cleanStr);
      } else {
          finalVal = Number(val);
      }
      
      return isNaN(finalVal) ? 0 : finalVal;
  }

  // Logic Sort
  $: sortedData = [...processedData].sort((a, b) => {
      let valA = getSortValue(a, sortKey);
      let valB = getSortValue(b, sortKey);

      if (sortKey === 'hoTen') {
          return sortDirection === 'asc' ? String(valA).localeCompare(String(valB)) : String(valB).localeCompare(String(valA));
      } else {
          return sortDirection === 'asc' ? valA - valB : valB - valA;
      }
  });

  function handleSort(event) {
      const key = event.detail;
      // ƒê·ªïi h∆∞·ªõng n·∫øu sort l·∫°i c√πng 1 c·ªôt
      if (sortKey === key) sortDirection = sortDirection === 'desc' ? 'asc' : 'desc';
      else { sortKey = key; sortDirection = 'desc'; }
  }
  
  function handleManualSort(event) {
      const key = event.detail;
      if (sortKey === key) sortDirection = sortDirection === 'desc' ? 'asc' : 'desc';
      else { sortKey = key; sortDirection = 'asc'; }
  }

  const themeMap = {
      blue: { header: 'bg-blue-50 border-blue-200', title: 'text-blue-800' },
      green: { header: 'bg-green-50 border-green-200', title: 'text-green-800' },
      orange: { header: 'bg-orange-50 border-orange-200', title: 'text-orange-800' },
      purple: { header: 'bg-purple-50 border-purple-200', title: 'text-purple-800' },
      teal: { header: 'bg-teal-50 border-teal-200', title: 'text-teal-800' },
      indigo: { header: 'bg-indigo-50 border-indigo-200', title: 'text-indigo-800' },
      rose: { header: 'bg-rose-50 border-rose-200', title: 'text-rose-800' },
  };
  $: theme = themeMap[colorTheme] || themeMap.blue;
  $: totalColSpan = (tableMetrics.sl ? 1 : 0) + (tableMetrics.dt ? 1 : 0) + (tableMetrics.dtqd ? 1 : 0);
</script>

<div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden h-full flex flex-col transition-all hover:shadow-md relative group/card" 
     data-capture-table="true"
     data-table-debug={config.title}>
    
    {#if $isAdmin || !config.isSystem}
        <div class="absolute top-3 right-3 opacity-0 group-hover/card:opacity-100 transition-opacity flex gap-1 z-10 bg-white/80 backdrop-blur rounded-lg p-1 shadow-sm border border-gray-100">
             {#if !config.isSystem}<button class="p-1.5 text-gray-400 hover:text-blue-600 rounded hover:bg-blue-50" on:click|stopPropagation={() => dispatch('edit')}><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" /></svg></button>{/if}
            <button class="p-1.5 text-gray-400 hover:text-red-600 rounded hover:bg-red-50" on:click|stopPropagation={() => dispatch('delete')}><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg></button>
        </div>
    {/if}

    <div class="px-5 py-4 border-b {theme.header} flex justify-between items-center">
        <div class="flex items-center gap-3 w-full">
            <h4 class="text-lg font-bold uppercase {theme.title} truncate" title={config.title}>{config.title}</h4>
        </div>
    </div>
    
    {#if sortedData.length === 0}
        <div class="flex-grow flex items-center justify-center p-8 bg-slate-50/30">
             <p class="text-gray-400 italic text-sm">Ch∆∞a c√≥ ph√°t sinh d·ªØ li·ªáu.</p>
        </div>
    {:else}
        <div class="overflow-x-auto flex-grow custom-scrollbar relative">
            <table class="min-w-full text-sm border-collapse border-0">
                <DynamicTableHeader 
                    {config} {tableMetrics} {totalColSpan} {sortKey} {sortDirection}
                    on:sort={handleSort}
                    on:manualSort={handleManualSort}
                 />

                <tbody class="divide-y divide-gray-100">
                    {#each sortedData as item (item.maNV)}
                        <DynamicTableRow {item} {config} {tableMetrics} />
                    {/each}
                </tbody>

                <tfoot class="bg-gray-100 font-bold text-gray-800 border-t border-gray-300 sticky bottom-0 z-20">
                    <tr>
                        <td class="px-5 py-2 sticky left-0 bg-gray-200 z-30 border-r border-gray-300 shadow-[2px_0_5px_-2px_rgba(0,0,0,0.1)]">T·ªîNG</td>
                        {#if tableMetrics.sl}
                              <td class="px-2 py-2 text-right border-r border-gray-300 bg-gray-200">
                                 {formatters.formatNumber(totals.cells?.mainValue?.value_sl || totals.mainValue_sl)}
                              </td>
                        {/if}
                        {#if tableMetrics.dt}
                             <td class="px-2 py-2 text-right border-r border-gray-300 bg-gray-200 text-blue-800">
                                 {formatters.formatRevenue(totals.cells?.mainValue?.value || totals.mainValue)}
                             </td>
                        {/if}
                        {#if tableMetrics.dtqd}
                            <td class="px-2 py-2 text-right border-r border-gray-300 bg-gray-200 text-purple-800">
                                {formatters.formatRevenue(totals.cells?.mainValue?.value_dtqd || totals.mainValue_dtqd)}
                            </td>
                        {/if}

                        {#each config.subColumns as col}
                            {@const total = totals.cells ? (totals.cells[col.id] || totals.cells[col.header]) : null}
                            {@const metrics = col.metrics || { sl: false, dt: true, dtqd: false }}
                            
                            {#if metrics.sl}
                                <td class="px-2 py-2 text-right border-r border-gray-300">{formatters.formatNumber(total?.value_sl || total?.sl)}</td>
                            {/if}
                            {#if metrics.dt}
                                <td class="px-2 py-2 text-right border-r border-gray-300 text-blue-700">{formatters.formatRevenue(total?.value || total?.dt)}</td>
                            {/if}
                            {#if metrics.dtqd}
                                <td class="px-2 py-2 text-right border-r border-gray-300 text-purple-700">{formatters.formatRevenue(total?.value_dtqd || total?.dtqd)}</td>
                            {/if}
                        {/each}
                    </tr>
                </tfoot>
            </table>
        </div>
    {/if}
</div>

<style>
    .custom-scrollbar::-webkit-scrollbar { width: 6px; height: 6px; }
    .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
    .custom-scrollbar::-webkit-scrollbar-thumb { background: #e5e7eb; border-radius: 3px; }
    .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #d1d5db; }
</style>

================================================================================
File: src/components/health-staff/EfficiencyTable.svelte
================================================================================

<script>
    import { createEventDispatcher } from 'svelte';
    import { fly } from 'svelte/transition';
    import { formatters } from '../../utils/formatters.js';
    import { efficiencyConfig } from '../../stores.js';
    
    export let data = [];
    export let isLoading = false;
    
    const dispatch = createEventDispatcher();
    
    // --- STATE ---
    let sortKey = 'doanhThu';
    let sortDirection = 'desc';
    let currentPage = 1;
    let itemsPerPage = 10;
    
    // --- CONFIG COLUMNS ---
    // [FIX] ƒê√£ x√≥a { id: 'pctPhuKien', ... } kh·ªèi danh s√°ch c·ª©ng ƒë·ªÉ tr√°nh tr√πng l·∫∑p
    const FIXED_COLUMNS = [
        { id: 'dtICT', label: 'DT ICT', isRate: false, headerClass: 'bg-blue-100 text-blue-900', format: 'revenue' },
        { id: 'dtPhuKien', label: 'DT Ph·ª• ki·ªán', isRate: false, headerClass: 'bg-blue-100 text-blue-900', format: 'revenue' },
        
        { id: 'dtCE', label: 'DT CE', isRate: false, headerClass: 'bg-green-100 text-green-900', format: 'revenue' },
        { id: 'dtGiaDung', label: 'DT Gia d·ª•ng', isRate: false, headerClass: 'bg-green-100 text-green-900', format: 'revenue' },
        
        { id: 'pctMLN', label: '% MLN', isRate: true, targetKey: 'phanTramMLN', headerClass: 'bg-green-100 text-green-900', format: 'percent' },
        { id: 'pctSim', label: '% Sim', isRate: true, targetKey: 'phanTramSim', headerClass: 'bg-yellow-100 text-yellow-900', format: 'percent' },
        { id: 'pctVAS', label: '% VAS', isRate: true, targetKey: 'phanTramVAS', headerClass: 'bg-yellow-100 text-yellow-900', format: 'percent' },
        { id: 'pctBaoHiem', label: '% B·∫£o hi·ªÉm', isRate: true, targetKey: 'phanTramBaoHiem', headerClass: 'bg-yellow-100 text-yellow-900', format: 'percent' }
    ];

    // K·∫øt h·ª£p c·ªôt c·ª©ng v√† c·ªôt ƒë·ªông t·ª´ c·∫•u h√¨nh Admin ($efficiencyConfig)
    $: columns = [
        ...FIXED_COLUMNS,
        ...($efficiencyConfig || []).map(conf => ({
            id: conf.id,
            label: conf.name,
            isRate: conf.type === 'percent',
            targetKey: conf.targetKey, // Key ch·ª©a m·ª•c ti√™u (n·∫øu c√≥) ƒë·ªÉ so s√°nh m√†u s·∫Øc
            headerClass: 'bg-indigo-50 text-indigo-900',
            format: conf.type === 'percent' ? 'percent' : 'revenue',
            isDynamic: true
        }))
    ];

    // --- SORTING ---
    function handleSort(key) {
        if (sortKey === key) {
            sortDirection = sortDirection === 'desc' ? 'asc' : 'desc';
        } else {
            sortKey = key;
            sortDirection = 'desc';
        }
    }

    $: sortedData = [...data].sort((a, b) => {
        let valA = a[sortKey] || 0;
        let valB = b[sortKey] || 0;
        return sortDirection === 'asc' ? valA - valB : valB - valA;
    });

    // --- PAGINATION ---
    $: totalPages = Math.ceil(sortedData.length / itemsPerPage);
    $: paginatedData = sortedData.slice((currentPage - 1) * itemsPerPage, currentPage * itemsPerPage);

    function goToPage(page) {
        if (page >= 1 && page <= totalPages) {
            currentPage = page;
        }
    }
    
    // --- HELPER: COLOR LOGIC ---
    function getCellColor(value, target, isRate) {
        if (!isRate || target === undefined || target === null) return 'text-gray-700';
        return value >= target ? 'text-green-600 font-bold' : 'text-red-500';
    }

    // --- HELPER: FORMAT ---
    function formatValue(value, type) {
        if (type === 'percent') return formatters.formatPercent(value);
        if (type === 'revenue') return formatters.formatRevenue(value);
        return value;
    }
</script>

<div class="bg-white border border-gray-200 rounded-xl shadow-sm overflow-hidden flex flex-col h-full">
    <div class="p-4 border-b border-gray-200 flex justify-between items-center bg-gray-50">
        <h3 class="font-bold text-gray-800 uppercase text-sm">B·∫£ng Hi·ªáu Qu·∫£ Chi Ti·∫øt</h3>
        <div class="flex gap-2 text-xs">
            <span class="px-2 py-1 bg-green-100 text-green-700 rounded">ƒê·∫°t ch·ªâ ti√™u</span>
            <span class="px-2 py-1 bg-red-100 text-red-700 rounded">Ch∆∞a ƒë·∫°t</span>
        </div>
    </div>

    <div class="overflow-x-auto flex-1 custom-scrollbar relative">
        {#if isLoading}
            <div class="absolute inset-0 bg-white/80 z-10 flex items-center justify-center">
                <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"></div>
            </div>
        {/if}

        <table class="min-w-full text-xs text-left border-collapse">
            <thead class="bg-gray-100 text-gray-600 font-bold sticky top-0 z-20 shadow-sm">
                <tr>
                    <th class="p-3 border-b border-r border-gray-200 min-w-[50px] text-center sticky left-0 bg-gray-100 z-30">#</th>
                    <th 
                        class="p-3 border-b border-r border-gray-200 min-w-[180px] cursor-pointer hover:bg-gray-200 sticky left-[50px] bg-gray-100 z-30 transition-colors"
                        on:click={() => handleSort('hoTen')}
                    >
                        <div class="flex items-center justify-between">
                            NH√ÇN VI√äN
                            {#if sortKey === 'hoTen'}
                                <span>{sortDirection === 'asc' ? '‚ñ≤' : '‚ñº'}</span>
                            {/if}
                        </div>
                    </th>
                    <th 
                        class="p-3 border-b border-r border-gray-200 min-w-[120px] cursor-pointer hover:bg-gray-200 text-right"
                        on:click={() => handleSort('doanhThu')}
                    >
                         <div class="flex items-center justify-end gap-1">
                            T·ªîNG DT
                            {#if sortKey === 'doanhThu'}
                                <span>{sortDirection === 'asc' ? '‚ñ≤' : '‚ñº'}</span>
                            {/if}
                        </div>
                    </th>
                    
                    {#each columns as col}
                        <th 
                            class="p-3 border-b border-r border-gray-200 min-w-[100px] cursor-pointer hover:brightness-95 transition-colors text-right whitespace-nowrap {col.headerClass}"
                            on:click={() => handleSort(col.id)}
                            title={col.label}
                        >
                            <div class="flex items-center justify-end gap-1">
                                {col.label}
                                {#if sortKey === col.id}
                                    <span>{sortDirection === 'asc' ? '‚ñ≤' : '‚ñº'}</span>
                                {/if}
                            </div>
                        </th>
                    {/each}
                </tr>
            </thead>
            
            <tbody class="divide-y divide-gray-100">
                {#each paginatedData as row, index (row.maNV)}
                    <tr class="hover:bg-blue-50 transition-colors group">
                        <td class="p-3 border-r border-gray-200 text-center text-gray-500 sticky left-0 bg-white group-hover:bg-blue-50 z-10">
                            {(currentPage - 1) * itemsPerPage + index + 1}
                        </td>
                        <td class="p-3 border-r border-gray-200 font-medium text-gray-800 sticky left-[50px] bg-white group-hover:bg-blue-50 z-10 shadow-[2px_0_5px_-2px_rgba(0,0,0,0.05)]">
                            <div class="flex flex-col">
                                <span class="truncate max-w-[160px]" title={row.hoTen}>{row.hoTen}</span>
                                <span class="text-[10px] text-gray-400 font-mono">{row.maNV}</span>
                            </div>
                        </td>
                        <td class="p-3 border-r border-gray-200 text-right font-bold text-gray-800">
                            {formatters.formatRevenue(row.doanhThu)}
                        </td>

                        {#each columns as col}
                            {@const val = row[col.id]}
                            {@const target = col.isRate && col.targetKey ? row.targets?.[col.targetKey] : undefined}
                            <td class="p-3 border-r border-gray-200 text-right {getCellColor(val, target, col.isRate)}">
                                {formatValue(val, col.format)}
                            </td>
                        {/each}
                    </tr>
                {:else}
                    <tr>
                        <td colspan={columns.length + 3} class="p-8 text-center text-gray-400 italic">
                            Kh√¥ng c√≥ d·ªØ li·ªáu hi·ªÉn th·ªã.
                        </td>
                    </tr>
                {/each}
            </tbody>
        </table>
    </div>

    {#if totalPages > 1}
    <div class="p-3 border-t border-gray-200 flex justify-between items-center bg-gray-50">
        <span class="text-xs text-gray-500">
            Hi·ªÉn th·ªã {(currentPage - 1) * itemsPerPage + 1}-{Math.min(currentPage * itemsPerPage, sortedData.length)} / {sortedData.length}
        </span>
        <div class="flex gap-1">
            <button 
                class="px-3 py-1 border rounded bg-white hover:bg-gray-100 disabled:opacity-50 text-xs font-medium"
                disabled={currentPage === 1}
                on:click={() => goToPage(currentPage - 1)}
            >
                Tr∆∞·ªõc
            </button>
            {#each Array(totalPages) as _, i}
                {#if i + 1 === currentPage || i + 1 === 1 || i + 1 === totalPages || (i + 1 >= currentPage - 1 && i + 1 <= currentPage + 1)}
                    <button 
                        class="px-3 py-1 border rounded text-xs font-medium {currentPage === i + 1 ? 'bg-blue-600 text-white border-blue-600' : 'bg-white hover:bg-gray-100'}"
                        on:click={() => goToPage(i + 1)}
                    >
                        {i + 1}
                    </button>
                {:else if i + 1 === currentPage - 2 || i + 1 === currentPage + 2}
                    <span class="px-2 py-1 text-gray-400">...</span>
                {/if}
            {/each}
            <button 
                class="px-3 py-1 border rounded bg-white hover:bg-gray-100 disabled:opacity-50 text-xs font-medium"
                disabled={currentPage === totalPages}
                on:click={() => goToPage(currentPage + 1)}
            >
                Sau
            </button>
        </div>
    </div>
    {/if}
</div>

<style>
    .custom-scrollbar::-webkit-scrollbar { height: 8px; width: 8px; }
    .custom-scrollbar::-webkit-scrollbar-track { background: #f1f1f1; }
    .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
    .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
</style>

================================================================================
File: src/components/health-staff/EmployeeDetailModal.svelte
================================================================================

<script>
    import { createEventDispatcher } from 'svelte';
    
    // Props nh·∫≠n v√†o t·ª´ cha
    export let isOpen = false;
    export let employeeCode = '';
    export let employeeName = '';
    export let employeeDept = '';
    export let rawData = []; // D·ªØ li·ªáu g·ªëc (reportData) ƒë·ªÉ l·ªçc

    const dispatch = createEventDispatcher();

    // Bi·∫øn n·ªôi b·ªô
    let history = [];
    let summary = {
        totalErrors: 0,
        totalDeducted: 0,
        totalBonus: 0,
        finalScore: 100 // Gi·∫£ s·ª≠ ƒëi·ªÉm g·ªëc l√† 100, ho·∫∑c t√≠nh theo logic d·ª± √°n
    };

    // Reactive: Khi employeeCode ho·∫∑c rawData thay ƒë·ªïi, t√≠nh to√°n l·∫°i
    $: if (isOpen && employeeCode && rawData.length > 0) {
        analyzeEmployeeData();
    }

    function analyzeEmployeeData() {
        // 1. L·ªçc d·ªØ li·ªáu c·ªßa nh√¢n vi√™n n√†y
        const records = rawData.filter(item => item.maNV === employeeCode);

        // 2. S·∫Øp x·∫øp theo ng√†y m·ªõi nh·∫•t -> c≈© nh·∫•t
        history = records.sort((a, b) => {
            const dateA = new Date(a.ngayViPham.split('/').reverse().join('-'));
            const dateB = new Date(b.ngayViPham.split('/').reverse().join('-'));
            return dateB - dateA;
        });

        // 3. T√≠nh to√°n t·ªïng h·ª£p
        let errors = 0;
        let deducted = 0;
        let bonus = 0;

        history.forEach(item => {
            const point = parseFloat(item.diemTru) || 0;
            if (point < 0) {
                // ƒêi·ªÉm √¢m l√† ƒëi·ªÉm tr·ª´ (tu·ª≥ quy ∆∞·ªõc data g·ªëc c·ªßa b·∫°n, ·ªü ƒë√¢y gi·∫£ s·ª≠ < 0 l√† tr·ª´)
                // Ho·∫∑c n·∫øu data g·ªëc l∆∞u s·ªë d∆∞∆°ng cho c·ªôt ƒëi·ªÉm tr·ª´:
                // C·∫ßn check logic g·ªëc. Th∆∞·ªùng l√† c·ªôt 'diemTru' l∆∞u s·ªë ƒëi·ªÉm b·ªã tr·ª´.
                // ·ªû ƒë√¢y t√¥i gi·∫£ ƒë·ªãnh theo logic th√¥ng th∆∞·ªùng:
                
                // N·∫øu item.loai === 'ƒêi·ªÉm c·ªông' ho·∫∑c diemTru > 0 trong ng·ªØ c·∫£nh c·ªông...
                // D·ª±a v√†o file g·ªëc: th∆∞·ªùng c√≥ ph√¢n lo·∫°i ho·∫∑c check d·∫•u
            }
            
            // Logic b√°m s√°t d·ª± √°n g·ªëc: 
            // D·ª± √°n g·ªëc th∆∞·ªùng c·ªông d·ªìn ƒëi·ªÉm. Gi·∫£ s·ª≠ diemTru l√† s·ªë ƒëi·ªÉm t√°c ƒë·ªông.
            if (item.loaiViPham === 'ƒêi·ªÉm c·ªông' || (item.ghiChu && item.ghiChu.includes('ƒêi·ªÉm c·ªông'))) {
                 bonus += Math.abs(point);
            } else {
                 errors++;
                 deducted += Math.abs(point);
            }
        });

        summary = {
            totalErrors: errors,
            totalDeducted: deducted,
            totalBonus: bonus,
            finalScore: 100 - deducted + bonus // C√¥ng th·ª©c v√≠ d·ª•
        };
    }

    function close() {
        dispatch('close');
    }
</script>

{#if isOpen}
    <div class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4" on:click={close}>
        <div class="bg-white rounded-lg shadow-xl w-full max-w-4xl max-h-[90vh] flex flex-col overflow-hidden" on:click|stopPropagation>
            
            <div class="bg-blue-600 text-white p-4 flex justify-between items-center">
                <div>
                    <h3 class="text-xl font-bold uppercase">Chi ti·∫øt thi ƒëua: {employeeName}</h3>
                    <p class="text-sm opacity-90">{employeeCode} - {employeeDept}</p>
                </div>
                <button on:click={close} class="text-white hover:text-gray-200">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>

            <div class="p-4 bg-gray-50 border-b flex flex-wrap gap-4 justify-around text-center">
                <div class="bg-white p-3 rounded shadow-sm border border-gray-200 min-w-[150px]">
                    <span class="block text-gray-500 text-xs uppercase">S·ªë l·ªói vi ph·∫°m</span>
                    <span class="block text-2xl font-bold text-red-500">{summary.totalErrors}</span>
                </div>
                <div class="bg-white p-3 rounded shadow-sm border border-gray-200 min-w-[150px]">
                    <span class="block text-gray-500 text-xs uppercase">T·ªïng ƒëi·ªÉm tr·ª´</span>
                    <span class="block text-2xl font-bold text-red-600">-{summary.totalDeducted}</span>
                </div>
                <div class="bg-white p-3 rounded shadow-sm border border-gray-200 min-w-[150px]">
                    <span class="block text-gray-500 text-xs uppercase">T·ªïng ƒëi·ªÉm c·ªông</span>
                    <span class="block text-2xl font-bold text-green-600">+{summary.totalBonus}</span>
                </div>
                 </div>

            <div class="flex-1 overflow-y-auto p-4">
                {#if history.length === 0}
                    <div class="text-center text-gray-500 py-10">Nh√¢n vi√™n n√†y ch∆∞a c√≥ ghi nh·∫≠n thi ƒëua n√†o.</div>
                {:else}
                    <table class="min-w-full text-sm border-collapse border border-gray-200">
                        <thead class="bg-gray-100 sticky top-0 shadow-sm">
                            <tr>
                                <th class="border p-2 text-left">Ng√†y</th>
                                <th class="border p-2 text-left">Lo·∫°i/Vi ph·∫°m</th>
                                <th class="border p-2 text-left">N·ªôi dung chi ti·∫øt</th>
                                <th class="border p-2 text-center text-nowrap">ƒêi·ªÉm</th>
                            </tr>
                        </thead>
                        <tbody>
                            {#each history as item}
                                <tr class="hover:bg-gray-50">
                                    <td class="border p-2 whitespace-nowrap">{item.ngayViPham}</td>
                                    <td class="border p-2 font-medium">
                                        {#if item.loaiViPham === 'ƒêi·ªÉm c·ªông'}
                                            <span class="text-green-600">ƒêi·ªÉm c·ªông</span>
                                        {:else}
                                            <span class="text-red-600">{item.loaiViPham || 'Vi ph·∫°m'}</span>
                                        {/if}
                                    </td>
                                    <td class="border p-2">{item.noiDung || item.tenLoi}</td>
                                    <td class="border p-2 text-center font-bold" 
                                        class:text-red-600={parseFloat(item.diemTru) < 0 || (item.loaiViPham !== 'ƒêi·ªÉm c·ªông')}
                                        class:text-green-600={item.loaiViPham === 'ƒêi·ªÉm c·ªông'}
                                    >
                                        {item.diemTru}
                                    </td>
                                </tr>
                            {/each}
                        </tbody>
                    </table>
                {/if}
            </div>

            <div class="p-4 border-t bg-gray-50 text-right">
                <button on:click={close} class="px-4 py-2 bg-gray-200 hover:bg-gray-300 rounded text-gray-700 font-medium">
                    ƒê√≥ng
                </button>
            </div>
        </div>
    </div>
{/if}

================================================================================
File: src/components/health-staff/IncomeTable.svelte
================================================================================

<script>
  import { formatters } from '../../utils/formatters.js';
  export let reportData = [];

  let sortKey = 'tongThuNhap';
  let sortDirection = 'desc';
  // C·∫•u h√¨nh c·ªôt
  const columns = [
      { key: 'hoTen', label: 'Nh√¢n vi√™n', align: 'left' },
      { key: 'gioCong', label: 'Gi·ªù c√¥ng', align: 'right' },
      { key: 'tongThuNhap', label: 'T·ªïng Thu Nh·∫≠p', align: 'right' },
      { key: 'thuNhapDuKien', label: 'Thu nh·∫≠p DK', align: 'right' },
      { key: 'thuNhapThangTruoc', label: 'Th√°ng tr∆∞·ªõc', align: 'right' },
      { key: 'chenhLechThuNhap', label: '+/- Th√°ng tr∆∞·ªõc', align: 'right' }
  ];
  function handleSort(key) {
      if (sortKey === key) {
          sortDirection = sortDirection === 'desc' ?
'asc' : 'desc';
      } else {
          sortKey = key;
sortDirection = 'desc';
      }
  }

  // Logic s·∫Øp x·∫øp
  $: sortedData = [...reportData].sort((a, b) => {
      let valA = a[sortKey];
      let valB = b[sortKey];

      if (sortKey === 'hoTen') {
          return sortDirection === 'asc' ? String(valA).localeCompare(String(valB)) : String(valB).localeCompare(String(valA));
      }
      // X·ª≠ l√Ω s·ªë
      return sortDirection === 'asc' ? (Number(valA)||0) - (Number(valB)||0) : (Number(valB)||0) - (Number(valA)||0);
  });
  // T√≠nh t·ªïng
  $: totals = reportData.reduce((acc, item) => {
      acc.gioCong += item.gioCong || 0;
      acc.tongThuNhap += item.tongThuNhap || 0;
      acc.thuNhapDuKien += item.thuNhapDuKien || 0;
      acc.thuNhapThangTruoc += item.thuNhapThangTruoc || 0;
      acc.chenhLechThuNhap += item.chenhLechThuNhap || 0;
      return acc;
  }, { gioCong: 0, tongThuNhap: 0, thuNhapDuKien: 0, thuNhapThangTruoc: 0, chenhLechThuNhap: 0 });
  // T√≠nh trung b√¨nh Thu nh·∫≠p d·ª± ki·∫øn ƒë·ªÉ so s√°nh
  $: avgIncome = reportData.length > 0 ?
totals.thuNhapDuKien / reportData.length : 0;

  // H√†m style cho √¥ d·ªØ li·ªáu
  function getCellClass(item, colKey) {
      if (colKey === 'tongThuNhap') return 'font-bold text-blue-700';
      if (colKey === 'thuNhapDuKien') {
          // D∆∞·ªõi trung b√¨nh th√¨ m√†u ƒë·ªè, tr√™n th√¨ xanh
          return item.thuNhapDuKien < avgIncome 
              ?
'font-bold text-red-600 bg-red-50' 
              : 'font-bold text-green-700 bg-green-50';
      }

      if (colKey === 'chenhLechThuNhap') {
          return item.chenhLechThuNhap >= 0 
              ?
'font-bold text-green-600' 
              : 'font-bold text-red-600';
      }

      return 'text-gray-700';
  }
</script>

<div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden mt-4 animate-fade-in" data-capture-group="income-table">
    <div class="px-6 py-4 border-b border-gray-200 flex justify-between items-center bg-orange-50">
        <div class="flex items-center gap-2">
            <div class="p-2 bg-orange-100 rounded-lg text-orange-600">
                <i data-feather="briefcase" class="w-5 h-5"></i>
            </div>
            <div>
  
              <h3 class="font-bold text-gray-800 text-lg uppercase">B·∫£ng L∆∞∆°ng & Thu Nh·∫≠p</h3>
                <p class="text-xs text-gray-500">
                    Thu nh·∫≠p DK TB: <span class="font-bold text-orange-600">{formatters.formatRevenue(avgIncome)}</span>
                </p>
            </div>
      
  </div>
        <span class="text-xs font-bold bg-orange-100 text-orange-700 px-3 py-1 rounded-full shadow-sm">ƒê∆°n v·ªã: VNƒê</span>
    </div>

    <div class="overflow-x-auto">
        <table class="min-w-full text-sm text-left border-collapse">
            <thead class="bg-gray-100 text-xs uppercase text-gray-500 font-bold sticky top-0 z-10 shadow-sm">
                <tr>
                    {#each columns 
as col}
                        <th 
                            class="px-4 py-3 cursor-pointer hover:bg-gray-200 transition select-none whitespace-nowrap {col.align === 'right' ?
'text-right' : 'text-left'}"
                            on:click={() => handleSort(col.key)}
                        >
                            <div class="flex items-center gap-1 {col.align === 'right' ?
'justify-end' : ''}">
                                {col.label}
                                {#if sortKey === col.key}
                               
     <span class="ml-1 text-orange-600">{sortDirection === 'asc' ? '‚ñ≤' : '‚ñº'}</span>
                                {/if}
                            </div>
                        </th>
   
                 {/each}
                </tr>
            </thead>
            <tbody class="divide-y divide-gray-100">
                {#if sortedData.length === 0}
                    <tr><td colspan={columns.length} 
class="p-12 text-center text-gray-400 italic bg-gray-50">Ch∆∞a c√≥ d·ªØ li·ªáu. Vui l√≤ng t·∫£i file Th∆∞·ªüng/Gi·ªù c√¥ng.</td></tr>
                {:else}
                    {#each sortedData as item, index (item.maNV)}
                        <tr class="hover:bg-orange-50 transition-colors duration-150 group {index % 2 === 0 ?
'bg-white' : 'bg-slate-50/50'}">
                            <td class="px-4 py-3 font-semibold text-gray-700 whitespace-nowrap border-r border-gray-100 group-hover:text-orange-800">
                                {formatters.getShortEmployeeName(item.hoTen, item.maNV)}
                            </td>
 
                           <td class="px-4 py-3 text-right border-r border-gray-100 font-medium">
                                {formatters.formatNumberOrDash(item.gioCong)}
                            </td>
       
                     <td class="px-4 py-3 text-right {getCellClass(item, 'tongThuNhap')}">
                                {formatters.formatRevenue(item.tongThuNhap)}
                            </td>
              
              <td class="px-4 py-3 text-right {getCellClass(item, 'thuNhapDuKien')}">
                                {formatters.formatRevenue(item.thuNhapDuKien)}
                            </td>
                     
       <td class="px-4 py-3 text-right text-gray-600 font-medium">
                                {formatters.formatRevenue(item.thuNhapThangTruoc)}
                            </td>
                            
<td class="px-4 py-3 text-right border-l border-gray-100 {getCellClass(item, 'chenhLechThuNhap')}">
                                {formatters.formatRevenue(item.chenhLechThuNhap)}
                            </td>
                        </tr>
         
           {/each}
                {/if}
            </tbody>
            <tfoot class="bg-gray-100 font-bold text-gray-900 border-t-2 border-gray-300 text-xs uppercase">
                <tr>
                    <td class="px-4 py-3">T·ªîNG C·ªòNG</td>
   
                 <td class="px-4 py-3 text-right">{formatters.formatNumberOrDash(totals.gioCong)}</td>
                    <td class="px-4 py-3 text-right text-blue-700">{formatters.formatRevenue(totals.tongThuNhap)}</td>
                    <td class="px-4 py-3 text-right text-green-700">{formatters.formatRevenue(totals.thuNhapDuKien)}</td>
                    <td class="px-4 py-3 text-right">{formatters.formatRevenue(totals.thuNhapThangTruoc)}</td>
         
           <td class="px-4 py-3 text-right">{formatters.formatRevenue(totals.chenhLechThuNhap)}</td>
                </tr>
            </tfoot>
        </table>
    </div>
</div>

<style>
    .animate-fade-in { animation: fadeIn 0.4s ease-out;
}
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0);
} }
</style>

================================================================================
File: src/components/health-staff/ProgramGoalTables.svelte
================================================================================

<script>
  import { createEventDispatcher } from 'svelte';
  
  export let programTables = [];
  const dispatch = createEventDispatcher();
  let localTables = [];

  // Logic ƒë·ªìng b·ªô: Store -> Bi·∫øn c·ª•c b·ªô
  $: if (programTables) {
      const isDiff = JSON.stringify(programTables.map(t => t.id)) !== JSON.stringify(localTables.map(t => t.id));
      if (localTables.length === 0 || isDiff) {
          localTables = JSON.parse(JSON.stringify(programTables));
      }
  }

  function syncToStore() {
      dispatch('update', localTables);
  }
</script>

<div class="w-full space-y-6">
  {#if localTables && localTables.length > 0}
    {#each localTables as table, index (index)}
      <div class="bg-white border border-gray-200 rounded-lg shadow-sm overflow-hidden">
        
        <div class="bg-gray-50 px-4 py-3 border-b border-gray-200 flex items-center justify-between gap-4">
          
          <h3 class="font-bold text-blue-700 text-sm uppercase tracking-wide border-l-4 border-blue-600 pl-2 truncate">
            {table.name || table.programName || `Ch∆∞∆°ng tr√¨nh ${index + 1}`}
          </h3>

          <div class="flex items-center gap-2 flex-shrink-0">
             <label class="text-xs font-bold text-gray-600 whitespace-nowrap cursor-pointer">
                M·ª•c ti√™u:
             </label>
             
             <div class="relative"> 
                <input 
                  type="number" 
                  bind:value={table.target} 
                  on:input={syncToStore}
                  class="block w-32 rounded border border-gray-300 bg-white text-right font-bold text-red-600 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-sm py-1 px-2 shadow-sm"
                  placeholder="0"
                />
                <span class="absolute right-0 top-0 text-[10px] text-gray-400 pointer-events-none mr-1 mt-1.5">ƒë</span>
             </div>
          </div>

        </div>

        <div class="p-4 grid grid-cols-1 md:grid-cols-2 gap-4">
          <div class="space-y-1">
            <label class="block text-xs font-medium text-gray-500 uppercase">Th·ª±c ƒë·∫°t (Actual)</label>
            <div class="relative">
                <input 
                    type="number" 
                    bind:value={table.actual} 
                    on:input={syncToStore}
                    class="block w-full rounded-md border-gray-300 shadow-sm focus:border-green-500 focus:ring-green-500 sm:text-sm py-2 px-3 border font-bold text-gray-700"
                />
                <span class="absolute right-0 top-0 text-[10px] text-gray-400 pointer-events-none mr-2 mt-2.5">ƒë</span>
            </div>
          </div>

          <div class="space-y-1">
            <label class="block text-xs font-medium text-gray-500 uppercase">Ghi ch√∫</label>
            <textarea 
              bind:value={table.note} 
              on:input={syncToStore}
              rows="1"
              class="block w-full rounded-md border-gray-300 shadow-sm sm:text-sm py-2 px-3 border resize-none"
            ></textarea>
          </div>
        </div>
        
        <div class="bg-gray-50 px-4 py-2 border-t border-gray-200 flex justify-end items-center gap-3">
             <span class="text-xs text-gray-500">Ti·∫øn ƒë·ªô:</span>
             <div class="w-24 h-2 bg-gray-200 rounded-full overflow-hidden">
                <div class="h-full {table.actual >= table.target ? 'bg-green-500' : 'bg-orange-400'}" style="width: {Math.min((table.actual / (table.target || 1)) * 100, 100)}%"></div>
             </div>
             <span class="font-bold text-base {table.actual >= table.target ? 'text-green-600' : 'text-orange-600'}">
                {table.target > 0 ? ((table.actual / table.target) * 100).toFixed(1) : 0}%
             </span>
        </div>

      </div>
    {/each}
  {/if}
</div>

================================================================================
File: src/components/health-staff/RevenueTable.svelte
================================================================================

<script>
  import { createEventDispatcher, onMount } from 'svelte';
  import { formatters } from '../../utils/formatters.js';
  import { kpiStore } from '../../stores.js';
  import { getCompletionColor } from '../../utils/kpi.utils.js';
  
  export let reportData = [];

  // [LOGGER] Theo d√µi d·ªØ li·ªáu ƒë·∫ßu v√†o
  $: {
      console.log(`[RevenueTable ${new Date().toLocaleTimeString()}] Store Value:`, $kpiStore);
      console.log(`[RevenueTable] Report Data Length:`, reportData.length);
  }

  const dispatch = createEventDispatcher();
  let sortKey = 'doanhThu';
  let sortDirection = 'desc';
  // [C·∫§U H√åNH] Gi·ªØ nguy√™n header
  const columns = [
      { key: 'hoTen', label: 'Nh√¢n vi√™n', align: 'left', headerClass: 'bg-gray-100 text-gray-700' },
      // [STYLE FIX] ƒê·ªïi border-blue-200 ƒë·ªÉ kh·ªõp t√¥ng m√†u header xanh
      { key: 'doanhThu', label: 'DT Th·ª±c', align: 'right', headerClass: 'bg-blue-100 text-blue-800 border-l border-blue-200' },
      { key: 'doanhThuQuyDoi', label: 'DT Quy ƒê·ªïi', align: 'right', headerClass: 'bg-blue-100 text-blue-800' },
      { key: 'hieuQuaQuyDoi', label: '% Qƒê', align: 'right', headerClass: 'bg-blue-100 text-blue-800' },
   
      // [STYLE FIX] ƒê·ªïi border-green-200
      { key: 'doanhThuTraGop', label: 'DT Tr·∫£ ch·∫≠m', align: 'right', headerClass: 'bg-green-100 text-green-800 border-l border-green-200' },
      { key: 'tyLeTraCham', label: '% Tr·∫£ ch·∫≠m', align: 'right', headerClass: 'bg-green-100 text-green-800' },
      // [STYLE FIX] ƒê·ªïi border-yellow-200
      { key: 'doanhThuChuaXuat', label: 'DT Ch∆∞a Xu·∫•t', align: 'right', headerClass: 'bg-yellow-50 text-yellow-800 border-l border-yellow-200' }
  ];
  function handleSort(key) {
      if (sortKey === key) sortDirection = sortDirection === 'desc' ?
'asc' : 'desc';
      else { sortKey = key; sortDirection = 'desc';
}
  }

  $: sortedData = [...reportData].sort((a, b) => {
      let valA = a[sortKey];
      let valB = b[sortKey];
      if (sortKey === 'hoTen') return sortDirection === 'asc' ? String(valA).localeCompare(String(valB)) : String(valB).localeCompare(String(valA));
      return sortDirection === 'asc' ? (Number(valA)||0) - (Number(valB)||0) : (Number(valB)||0) - (Number(valA)||0);
  });
  $: totals = reportData.reduce((acc, item) => {
      acc.doanhThu += item.doanhThu || 0;
      acc.doanhThuQuyDoi += item.doanhThuQuyDoi || 0;
      acc.doanhThuTraGop += item.doanhThuTraGop || 0;
      acc.doanhThuChuaXuat += item.doanhThuChuaXuat || 0;
      return acc;
  }, { doanhThu: 0, doanhThuQuyDoi: 0, doanhThuTraGop: 0, doanhThuChuaXuat: 0 });
  $: totalPctQD = totals.doanhThu > 0 ? (totals.doanhThuQuyDoi / totals.doanhThu) - 1 : 0;
  $: totalPctTC = totals.doanhThu > 0 ? totals.doanhThuTraGop / totals.doanhThu : 0;
  function getCellClass(item, colKey) {
      const isBoldCol = ['doanhThu', 'doanhThuQuyDoi', 'doanhThuTraGop', 'doanhThuChuaXuat', 'hieuQuaQuyDoi', 'tyLeTraCham'].includes(colKey);
      let baseClass = isBoldCol ? 'font-bold text-gray-800' : 'text-gray-600';

      const userTarget = $kpiStore.targets[item.maNV];
      const targetSettings = userTarget || $kpiStore.globalSettings;
      if (!targetSettings || Object.keys(targetSettings).length === 0) {
          return baseClass;
      }

      if (colKey === 'hieuQuaQuyDoi') {
          const actual = item.hieuQuaQuyDoi;
          const target = (targetSettings.phanTramQD || 0) / 100; 
          const colorClass = getCompletionColor(actual, target);
          return colorClass ? `${colorClass} font-bold` : baseClass;
      }
      
      if (colKey === 'tyLeTraCham') {
          const actual = item.tyLeTraCham;
          const target = (targetSettings.phanTramTC || 0) / 100;
          const colorClass = getCompletionColor(actual, target);
          return colorClass ? `${colorClass} font-bold` : baseClass;
      }

      return baseClass;
  }

  function handleRowClick(employeeId) { dispatch('viewDetail', { employeeId });
}
</script>

<div class="bg-white rounded-xl shadow-md border border-gray-200 overflow-hidden mt-6 animate-fade-in" data-capture-group="revenue-table">
    <div class="px-6 py-4 border-b border-gray-200 flex justify-between items-center bg-gray-50">
        <div class="flex items-center gap-2">
            <div class="p-2 bg-blue-100 rounded-lg text-blue-600"><i data-feather="dollar-sign" class="w-5 h-5"></i></div>
            <div>
                <h3 class="font-bold text-gray-800 text-lg uppercase">Chi ti·∫øt Doanh Thu L≈©y K·∫ø</h3>
             
   <p class="text-xs text-gray-500">D·ªØ li·ªáu ƒë∆∞·ª£c c·∫≠p nh·∫≠t t·ª´ file YCX m·ªõi nh·∫•t</p>
            </div>
        </div>
        <span class="text-xs font-bold bg-blue-100 text-blue-700 px-3 py-1 rounded-full shadow-sm">ƒê∆°n v·ªã: Tri·ªáu</span>
    </div>

    <div class="overflow-x-auto">
        <table class="min-w-full text-sm text-left border-collapse">
            <thead class="uppercase text-xs font-bold sticky top-0 z-10 shadow-sm">
        
        <tr>
                    {#each columns as col}
                        <th class="px-4 py-3 cursor-pointer transition select-none whitespace-nowrap {col.headerClass} {col.align === 'right' ?
'text-right' : 'text-left'}" on:click={() => handleSort(col.key)}>
                            <div class="flex items-center gap-1 {col.align === 'right' ?
'justify-end' : ''}">
                                {col.label}
                                {#if sortKey === col.key}<span class="ml-1 text-blue-600">{sortDirection === 'asc' ? '‚ñ≤' : '‚ñº'}</span>{/if}
                       
     </div>
                        </th>
                    {/each}
                </tr>
            </thead>
            <tbody class="divide-y divide-gray-200">
         
       {#if sortedData.length === 0}
                    <tr><td colspan={columns.length} class="p-12 text-center text-gray-400 italic bg-gray-50">Ch∆∞a c√≥ d·ªØ li·ªáu hi·ªÉn th·ªã.</td></tr>
                {:else}
                    {#each sortedData as item, index (item.maNV)}
                  
      <tr class="hover:bg-blue-50 transition-colors duration-150 group cursor-pointer {index % 2 === 0 ?
'bg-white' : 'bg-slate-50/50'}" on:click={() => handleRowClick(item.maNV)}>
                            <td class="px-4 py-3 font-semibold text-blue-700 whitespace-nowrap border-r border-gray-200 group-hover:text-blue-800 group-hover:underline">
                                {formatters.getShortEmployeeName(item.hoTen, item.maNV)}
                         
   </td>
                            <td class="px-4 py-3 text-right border-r border-gray-200 {getCellClass(item, 'doanhThu')}">{formatters.formatRevenue(item.doanhThu)}</td>
                            <td class="px-4 py-3 text-right {getCellClass(item, 'doanhThuQuyDoi')}">{formatters.formatRevenue(item.doanhThuQuyDoi)}</td>
                            <td 
class="px-4 py-3 text-right {getCellClass(item, 'hieuQuaQuyDoi')}">{formatters.formatPercentage(item.hieuQuaQuyDoi)}</td>
                            <td class="px-4 py-3 text-right border-l border-gray-200 {getCellClass(item, 'doanhThuTraGop')}">{formatters.formatRevenue(item.doanhThuTraGop)}</td>
                            <td class="px-4 py-3 text-right {getCellClass(item, 'tyLeTraCham')}">{formatters.formatPercentage(item.tyLeTraCham)}</td>
                            
<td class="px-4 py-3 text-right border-l border-gray-200 text-gray-500 font-medium">{formatters.formatRevenue(item.doanhThuChuaXuat)}</td>
                        </tr>
                    {/each}
                {/if}
            </tbody>
            <tfoot class="bg-gray-100 font-bold text-gray-900 border-t-2 border-gray-300 text-xs uppercase">
  
              <tr>
                    <td class="px-4 py-3">T·ªîNG C·ªòNG</td>
                    <td class="px-4 py-3 text-right text-base">{formatters.formatRevenue(totals.doanhThu)}</td>
                    <td class="px-4 py-3 text-right text-base text-blue-700">{formatters.formatRevenue(totals.doanhThuQuyDoi)}</td>
              
      <td class="px-4 py-3 text-right text-base text-blue-700">{formatters.formatPercentage(totalPctQD)}</td>
                    <td class="px-4 py-3 text-right text-base">{formatters.formatRevenue(totals.doanhThuTraGop)}</td>
                    <td class="px-4 py-3 text-right text-base">{formatters.formatPercentage(totalPctTC)}</td>
                    <td class="px-4 py-3 text-right text-base text-gray-600">{formatters.formatRevenue(totals.doanhThuChuaXuat)}</td>
                
</tr>
            </tfoot>
        </table>
    </div>
</div>
<style>.animate-fade-in { animation: fadeIn 0.4s ease-out;
} @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0);
} }</style>

================================================================================
File: src/components/health-staff/competition/CompetitionCard.svelte
================================================================================

<script>
  import { formatters } from '../../../utils/formatters.js';
  
  export let item; // D·ªØ li·ªáu c·ªßa 1 ch∆∞∆°ng tr√¨nh
  
  // T√≠nh to√°n logic hi·ªÉn th·ªã
  $: hoanThanhValue = item.hoanThanhValue || 0;
  $: isCompleted = hoanThanhValue >= 100;
  $: progressColor = isCompleted ? 'bg-blue-600' : 'bg-yellow-400';
  
  // T√≠nh m·ª•c ti√™u ng√†y (n·∫øu ch∆∞a ƒë·∫°t)
  $: targetRemaining = (item.target || 0) - (item.luyKe || 0);
  $: daysLeft = Math.max(30 - (new Date().getDate()), 1);
  $: dailyTarget = (item.target > 0 && targetRemaining > 0) ? (targetRemaining / daysLeft) : 0;
</script>

<div class="bg-white border border-gray-200 rounded-lg p-3 shadow-sm hover:shadow-md transition-all hover:-translate-y-0.5">
    <p class="font-semibold text-gray-800 mb-2 text-sm line-clamp-2 h-10" title={item.name}>
        {item.name}
    </p>
    
    <div class="w-full bg-gray-200 rounded-full h-3 overflow-hidden mb-2 relative">
        <div 
            class="h-full rounded-full transition-all duration-500 {progressColor}" 
            style="width: {Math.min(hoanThanhValue, 100)}%;"
        ></div>
        <span class="absolute inset-0 flex items-center justify-center text-[10px] font-bold text-gray-700 drop-shadow-md">
            {formatters.formatPercentage(hoanThanhValue / 100)}
        </span>
    </div>

    <div class="flex justify-between items-end text-xs text-gray-600">
        <div>
            <div class="flex flex-col">
                <span>L≈©y k·∫ø: <strong>{formatters.formatNumberOrDash(item.luyKe)}</strong></span>
                <span>Target: <strong>{formatters.formatNumberOrDash(item.target)}</strong></span>
            </div>
        </div>
        
        {#if isCompleted}
            <span class="font-bold text-green-600 bg-green-50 px-2 py-1 rounded">ƒê·∫°t</span>
        {:else}
            <div class="text-right">
                <span class="block text-gray-400">C·∫ßn/ng√†y:</span>
                <strong class="text-red-600">{formatters.formatNumberOrDash(dailyTarget)}</strong>
            </div>
        {/if}
    </div>
</div>

================================================================================
File: src/components/health-staff/competition/CompetitionDetailView.svelte
================================================================================

<script>
    import { createEventDispatcher, afterUpdate } from 'svelte'; // [QUAN TR·ªåNG] Th√™m afterUpdate
    import { formatters } from '../../../utils/formatters.js';
    import { competitionNameMappings } from '../../../stores.js';
    import { settingsService } from '../../../services/settings.service.js';

    export let employeeId;
    export let allReportData = []; 

    const dispatch = createEventDispatcher();

    // --- LOGIC T√çNH TO√ÅN ---
    let employee = null;
    let stats = {
        dat: [],
        ganDat: [],
        canCoGang: [],
        summary: { total: 0, dat: 0, rate: 0, ganDat: 0, canCoGang: 0 }
    };

    $: {
        if (employeeId && allReportData.length > 0) {
            employee = allReportData.find(e => e.maNV === employeeId);

            if (employee) {
                // L·∫•y c·∫•u h√¨nh t√™n c·ªôt hi·ªÉn th·ªã
                let columnSettings = settingsService.loadPastedCompetitionViewSettings();
                if (!columnSettings || columnSettings.length === 0) {
                     columnSettings = settingsService.loadPastedCompetitionViewSettings(); 
                }
                
                const activeColumns = columnSettings
                    .filter(col => col.visible)
                    .map(col => ({
                        ...col,
                        label: $competitionNameMappings[col.tenGoc] || col.label || col.tenGoc
                    }));

                // T√≠nh Trung b√¨nh b·ªô ph·∫≠n
                const deptEmployees = allReportData.filter(e => e.boPhan === employee.boPhan);
                const deptAvgs = {};
                
                activeColumns.forEach(col => {
                    let sum = 0;
                    let count = 0;
                    deptEmployees.forEach(e => {
                        const comp = e.competitions.find(c => c.tenGoc === col.tenGoc);
                        if (comp && comp.giaTri > 0) {
                            sum += comp.giaTri;
                            count++;
                        }
                    });
                    deptAvgs[col.tenGoc] = count > 0 ? sum / count : 0;
                });

                // Ph√¢n lo·∫°i ch·ªâ s·ªë
                let datList = [], ganDatList = [], canCoGangList = [];

                activeColumns.forEach(col => {
                    const compData = employee.competitions.find(c => c.tenGoc === col.tenGoc);
                    const val = compData ? compData.giaTri : 0;
                    const avg = deptAvgs[col.tenGoc] || 0;
                    
                    if (avg > 0 || val > 0) {
                        const item = {
                            name: col.label,
                            value: val,
                            avg: avg,
                            diff: val - avg,
                            percentOfAvg: avg > 0 ? (val / avg) * 100 : 0
                        };

                        if (val >= avg) {
                            datList.push(item);
                        } else if (item.percentOfAvg >= 70) {
                            ganDatList.push(item);
                        } else {
                            canCoGangList.push(item);
                        }
                    }
                });

                stats = {
                    dat: datList.sort((a,b) => b.percentOfAvg - a.percentOfAvg),
                    ganDat: ganDatList.sort((a,b) => b.percentOfAvg - a.percentOfAvg),
                    canCoGang: canCoGangList.sort((a,b) => a.percentOfAvg - b.percentOfAvg),
                    summary: {
                        total: datList.length + ganDatList.length + canCoGangList.length,
                        dat: datList.length,
                        ganDat: ganDatList.length,
                        canCoGang: canCoGangList.length,
                        rate: 0
                    }
                };
                stats.summary.rate = stats.summary.total > 0 
                    ? (stats.summary.dat / stats.summary.total) * 100 
                    : 0;
            }
        }
    }

    function goBack() {
        dispatch('back');
    }

    // [QUAN TR·ªåNG] K√≠ch ho·∫°t icon sau khi render
    afterUpdate(() => {
        if (typeof feather !== 'undefined') feather.replace();
    });
</script>

<div class="animate-fade-in pb-10 bg-gray-50 min-h-screen p-4 sm:p-6">
    <button on:click={goBack} class="mb-4 flex items-center gap-2 text-gray-500 hover:text-blue-600 transition-colors font-semibold">
        <i data-feather="arrow-left" class="w-5 h-5"></i> Quay l·∫°i b·∫£ng t·ªïng h·ª£p
    </button>

    {#if employee}
        <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-5 mb-6 flex items-center gap-5">
            <div class="w-16 h-16 rounded-full bg-gray-100 flex items-center justify-center text-gray-500 border border-gray-200 shadow-inner">
                <i data-feather="user" class="w-8 h-8"></i>
            </div>
            <div>
                <h2 class="text-2xl font-bold text-gray-800">{employee.hoTen} <span class="text-gray-400 font-medium text-lg">- {employee.maNV}</span></h2>
                <span class="inline-block mt-1 px-3 py-1 rounded-full bg-blue-50 text-blue-700 text-xs font-bold border border-blue-100">
                    {employee.boPhan}
                </span>
            </div>
        </div>

        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 mb-8">
            <div class="bg-white p-4 rounded-xl border border-gray-200 shadow-sm text-center">
                <p class="text-xs font-bold text-gray-500 uppercase mb-1">Ng√†nh h√†ng ƒê·∫°t</p>
                <p class="text-3xl font-extrabold text-gray-800">
                    <span class="text-blue-600">{stats.summary.dat}</span>
                    <span class="text-gray-300 text-xl">/ {stats.summary.total}</span>
                </p>
            </div>

            <div class="bg-white p-4 rounded-xl border border-gray-200 shadow-sm text-center">
                <p class="text-xs font-bold text-gray-500 uppercase mb-1">T·ª∑ l·ªá ƒë·∫°t (tr√™n nh√≥m c√≥ TB)</p>
                <p class="text-3xl font-extrabold text-red-500">
                    {formatters.formatNumber(stats.summary.rate, 0)}%
                </p>
            </div>

            <div class="bg-white p-4 rounded-xl border border-gray-200 shadow-sm text-center">
                <p class="text-xs font-bold text-gray-500 uppercase mb-1">G·∫ßn ƒê·∫°t (>=70%)</p>
                <p class="text-3xl font-extrabold text-yellow-500">{stats.summary.ganDat}</p>
            </div>

            <div class="bg-white p-4 rounded-xl border border-gray-200 shadow-sm text-center">
                <p class="text-xs font-bold text-gray-500 uppercase mb-1">C·∫ßn C·ªë G·∫Øng</p>
                <p class="text-3xl font-extrabold text-red-600">{stats.summary.canCoGang}</p>
            </div>
        </div>

        <div class="space-y-8">
            
            <div class="bg-blue-50/50 rounded-xl border border-blue-100 overflow-hidden">
                <div class="px-5 py-3 bg-blue-100/50 border-b border-blue-200 flex items-center gap-2">
                    <i data-feather="check-circle" class="w-5 h-5 text-blue-600"></i>
                    <h3 class="font-bold text-blue-800 uppercase text-lg">Nh√≥m ƒê·∫°t ({stats.dat.length})</h3>
                </div>
                <div class="p-5 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                    {#each stats.dat as item}
                        <div class="bg-white p-4 rounded-lg border border-blue-100 shadow-sm hover:shadow-md transition-shadow">
                            <h4 class="font-bold text-gray-800 mb-2 truncate" title={item.name}>{item.name}</h4>
                            <div class="w-full bg-gray-100 rounded-full h-2 mb-3">
                                <div class="bg-blue-500 h-2 rounded-full" style="width: 100%"></div>
                            </div>
                            <div class="text-xs space-y-1">
                                <div class="flex justify-between">
                                    <span class="text-gray-500">Th·ª±c hi·ªán:</span>
                                    <span class="font-bold text-gray-800">{formatters.formatNumber(item.value)}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-500">TB B·ªô ph·∫≠n:</span>
                                    <span class="font-bold text-gray-800">{formatters.formatNumber(item.avg)}</span>
                                </div>
                                <div class="flex justify-between border-t border-dashed border-gray-200 pt-1 mt-1">
                                    <span class="text-gray-500">Ch√™nh l·ªách:</span>
                                    <span class="font-bold text-green-600">+{formatters.formatNumber(item.diff)}</span>
                                </div>
                            </div>
                        </div>
                    {/each}
                    {#if stats.dat.length === 0}
                        <p class="text-sm text-gray-400 italic col-span-full text-center py-4">Kh√¥ng c√≥ ng√†nh h√†ng n√†o ƒë·∫°t.</p>
                    {/if}
                </div>
            </div>

            <div class="bg-yellow-50/50 rounded-xl border border-yellow-100 overflow-hidden">
                <div class="px-5 py-3 bg-yellow-100/50 border-b border-yellow-200 flex items-center gap-2">
                    <i data-feather="trending-up" class="w-5 h-5 text-yellow-600"></i>
                    <h3 class="font-bold text-yellow-800 uppercase text-lg">Nh√≥m G·∫ßn ƒê·∫°t ({stats.ganDat.length})</h3>
                </div>
                <div class="p-5 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                    {#each stats.ganDat as item}
                        <div class="bg-white p-4 rounded-lg border border-yellow-100 shadow-sm hover:shadow-md transition-shadow">
                            <h4 class="font-bold text-gray-800 mb-2 truncate" title={item.name}>{item.name}</h4>
                            <div class="w-full bg-gray-100 rounded-full h-2 mb-3">
                                <div class="bg-yellow-400 h-2 rounded-full" style="width: {item.percentOfAvg}%"></div>
                            </div>
                            <div class="text-xs space-y-1">
                                <div class="flex justify-between">
                                    <span class="text-gray-500">Th·ª±c hi·ªán:</span>
                                    <span class="font-bold text-gray-800">{formatters.formatNumber(item.value)}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-500">TB B·ªô ph·∫≠n:</span>
                                    <span class="font-bold text-gray-800">{formatters.formatNumber(item.avg)}</span>
                                </div>
                                <div class="flex justify-between border-t border-dashed border-gray-200 pt-1 mt-1">
                                    <span class="text-gray-500">Ch√™nh l·ªách:</span>
                                    <span class="font-bold text-red-500">{formatters.formatNumber(item.diff)}</span>
                                </div>
                            </div>
                        </div>
                    {/each}
                    {#if stats.ganDat.length === 0}
                        <p class="text-sm text-gray-400 italic col-span-full text-center py-4">Kh√¥ng c√≥ ng√†nh h√†ng n√†o.</p>
                    {/if}
                </div>
            </div>

            <div class="bg-red-50/50 rounded-xl border border-red-100 overflow-hidden">
                <div class="px-5 py-3 bg-red-100/50 border-b border-red-200 flex items-center gap-2">
                    <i data-feather="alert-circle" class="w-5 h-5 text-red-600"></i>
                    <h3 class="font-bold text-red-800 uppercase text-lg">Nh√≥m C·∫ßn C·ªë G·∫Øng ({stats.canCoGang.length})</h3>
                </div>
                <div class="p-5 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                    {#each stats.canCoGang as item}
                        <div class="bg-white p-4 rounded-lg border border-red-100 shadow-sm hover:shadow-md transition-shadow">
                            <h4 class="font-bold text-gray-800 mb-2 truncate" title={item.name}>{item.name}</h4>
                            <div class="w-full bg-gray-100 rounded-full h-2 mb-3">
                                <div class="bg-red-400 h-2 rounded-full" style="width: {Math.max(item.percentOfAvg, 5)}%"></div>
                            </div>
                            <div class="text-xs space-y-1">
                                <div class="flex justify-between">
                                    <span class="text-gray-500">Th·ª±c hi·ªán:</span>
                                    <span class="font-bold text-gray-800">{formatters.formatNumber(item.value)}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-500">TB B·ªô ph·∫≠n:</span>
                                    <span class="font-bold text-gray-800">{formatters.formatNumber(item.avg)}</span>
                                </div>
                                <div class="flex justify-between border-t border-dashed border-gray-200 pt-1 mt-1">
                                    <span class="text-gray-500">Ch√™nh l·ªách:</span>
                                    <span class="font-bold text-red-600">{formatters.formatNumber(item.diff)}</span>
                                </div>
                            </div>
                        </div>
                    {/each}
                    {#if stats.canCoGang.length === 0}
                        <p class="text-sm text-gray-400 italic col-span-full text-center py-4">Tuy·ªát v·ªùi! Kh√¥ng c√≥ ng√†nh h√†ng y·∫øu k√©m.</p>
                    {/if}
                </div>
            </div>

        </div>

    {:else}
        <div class="p-10 text-center">
            <p class="text-gray-500">ƒêang t·∫£i d·ªØ li·ªáu chi ti·∫øt...</p>
        </div>
    {/if}
</div>

<style>
    .animate-fade-in { animation: fadeIn 0.3s ease-out; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
</style>

================================================================================
File: src/components/health-staff/competition/CompetitionModeSelector.svelte
================================================================================

<script>
  import { createEventDispatcher } from 'svelte';
  export let activeView = 'employee'; // 'program' | 'employee'

  const dispatch = createEventDispatcher();

  function setView(view) {
      dispatch('change', view);
  }
</script>

<div class="flex justify-start items-center">
    <div class="flex bg-gray-200 p-1 rounded-lg shadow-inner">
        <button 
            class="px-4 py-1.5 rounded-md text-sm font-medium transition-all duration-200 {activeView === 'employee' ? 'bg-white text-blue-600 shadow-sm' : 'text-gray-500 hover:text-gray-700'}"
            on:click={() => setView('employee')}
        >
            Theo Nh√¢n Vi√™n
        </button>
        <button 
            class="px-4 py-1.5 rounded-md text-sm font-medium transition-all duration-200 {activeView === 'program' ? 'bg-white text-blue-600 shadow-sm' : 'text-gray-500 hover:text-gray-700'}"
            on:click={() => setView('program')}
        >
            Theo Ch∆∞∆°ng Tr√¨nh
        </button>
    </div>
</div>

================================================================================
File: src/components/health-staff/competition/EmployeeView.svelte
================================================================================

<script>
  import { createEventDispatcher, afterUpdate } from 'svelte';
  import { pastedThiDuaReportData, competitionNameMappings } from '../../../stores.js'; 
  import { settingsService } from '../../../services/settings.service.js';
  import { formatters } from '../../../utils/formatters.js';
  
  export let reportData = []; 
  const dispatch = createEventDispatcher();

  // --- STATE ---
  let columnSettings = [];
  let sortKey = 'hoTen';
  let sortDirection = 'asc';
  
  // D·ªØ li·ªáu ph·∫≥ng
  let allEmployees = [];
  let deptAverages = {}; 

  // Palette m√†u cho header
  const headerColors = [
      'bg-red-100 text-red-900 border-red-200',
      'bg-orange-100 text-orange-900 border-orange-200',
      'bg-amber-100 text-amber-900 border-amber-200',
      'bg-lime-100 text-lime-900 border-lime-200',
      'bg-teal-100 text-teal-900 border-teal-200',
      'bg-cyan-100 text-cyan-900 border-cyan-200',
      'bg-sky-100 text-sky-900 border-sky-200',
      'bg-indigo-100 text-indigo-900 border-indigo-200',
      'bg-fuchsia-100 text-fuchsia-900 border-fuchsia-200',
      'bg-rose-100 text-rose-900 border-rose-200'
  ];

  function getHeaderColor(index) {
      return headerColors[index % headerColors.length];
  }

  // --- REACTIVE PROCESSING ---
  $: {
      if (reportData && reportData.length > 0) {
          let savedSettings = settingsService.loadPastedCompetitionViewSettings();
          // N·∫øu ch∆∞a c√≥ setting l∆∞u, load m·∫∑c ƒë·ªãnh (logic loadPastedCompetitionViewSettings ƒë√£ handle vi·ªác t·∫°o default t·ª´ d·ªØ li·ªáu)
          if (!savedSettings || savedSettings.length === 0) {
              savedSettings = settingsService.loadPastedCompetitionViewSettings();
          }
          columnSettings = savedSettings;

          // Map t√™n hi·ªÉn th·ªã
          columnSettings = columnSettings.map(col => ({
              ...col,
              label: $competitionNameMappings[col.tenGoc] || col.label || col.tenGoc
          }));

          const groups = {};
          reportData.forEach(item => {
              const dept = item.boPhan || 'Ch∆∞a ph√¢n lo·∫°i';
              if (!groups[dept]) groups[dept] = [];
              groups[dept].push(item);
          });

          const avgs = {};
          Object.keys(groups).forEach(deptName => {
              const deptData = groups[deptName];
              const deptAvg = {};
              columnSettings.forEach(col => {
                  let total = 0;
                  let count = 0;
                  deptData.forEach(emp => {
                      const compData = emp.competitions.find(c => c.tenGoc === col.tenGoc);
                      const giaTri = compData?.giaTri || 0;
                      if (giaTri > 0) { 
                          total += giaTri;
                          count++;
                      }
                  });
                  deptAvg[col.tenGoc] = count > 0 ? total / count : 0;
              });
              avgs[deptName] = deptAvg;
          });
          deptAverages = avgs;

          allEmployees = [...reportData];
      } else {
          allEmployees = [];
      }
  }

  $: visibleColumns = columnSettings.filter(col => col.visible);

  // --- SORT LOGIC ---
  function handleSort(key) {
      if (sortKey === key) {
          sortDirection = sortDirection === 'desc' ? 'asc' : 'desc';
      } else {
          sortKey = key;
          sortDirection = key.startsWith('comp_') || key === 'totalScore' ? 'desc' : 'asc';
      }
  }

  $: sortedEmployees = [...allEmployees].sort((a, b) => {
      let valA, valB;
      
      if (sortKey.startsWith('comp_')) {
            const sortCol = columnSettings.find(c => c.id === sortKey);
            if (!sortCol) return 0;
            valA = a.competitions.find(c => c.tenGoc === sortCol.tenGoc)?.giaTri || 0;
            valB = b.competitions.find(c => c.tenGoc === sortCol.tenGoc)?.giaTri || 0;
            return sortDirection === 'asc' ? valA - valB : valB - valA;

      } else if (sortKey === 'totalScore') {
            const getScore = (emp) => {
                const deptAvg = deptAverages[emp.boPhan] || {};
                let score = 0;
                emp.competitions.forEach(comp => {
                    if (deptAvg[comp.tenGoc] > 0 && comp.giaTri >= deptAvg[comp.tenGoc]) score++;
                });
                return score;
            };
            valA = getScore(a);
            valB = getScore(b);
            return sortDirection === 'asc' ? valA - valB : valB - valA;

      } else {
            valA = a[sortKey] || '';
            valB = b[sortKey] || '';
            return sortDirection === 'asc' ? valA.localeCompare(valB) : valB.localeCompare(valA);
      }
  });

  // --- TOGGLE LOGIC ---
  function toggleColumn(col) {
      const newSettings = columnSettings.map(c => 
          c.tenGoc === col.tenGoc ? { ...c, visible: !c.visible } : c
      );
      columnSettings = newSettings;
      settingsService.savePastedCompetitionViewSettings(newSettings);
  }

  // --- FOOTER CALCULATION ---
  function calculateTotal(col) {
      return allEmployees.reduce((sum, emp) => {
          const comp = emp.competitions.find(c => c.tenGoc === col.tenGoc);
          return sum + (comp?.giaTri || 0);
      }, 0);
  }

  function calculateTotalScore() {
      return allEmployees.reduce((total, item) => {
          const avgScores = deptAverages[item.boPhan] || {};
          const score = item.competitions.reduce((acc, c) => (avgScores[c.tenGoc] > 0 && c.giaTri >= avgScores[c.tenGoc]) ? acc + 1 : acc, 0);
          return total + score;
      }, 0);
  }

  // --- VIEW SWITCHING ---
  function switchToProgram() {
      dispatch('viewChange', 'program');
  }

  afterUpdate(() => {
    if (typeof feather !== 'undefined') feather.replace();
  });
</script>

<div class="space-y-4 animate-fade-in">
    {#if reportData.length === 0}
        <div class="p-8 text-center bg-gray-50 border-2 border-dashed border-gray-300 rounded-lg">
            <p class="text-gray-500">Vui l√≤ng d√°n d·ªØ li·ªáu "Thi ƒëua nh√¢n vi√™n" ·ªü tab "C·∫≠p nh·∫≠t d·ªØ li·ªáu".</p>
        </div>
    {:else}
        
        <div class="bg-slate-50 p-3 rounded-lg border border-slate-200">
            <p class="text-xs font-bold text-gray-500 uppercase mb-2">Hi·ªÉn th·ªã c·ªôt:</p>
            <div class="flex flex-wrap gap-2">
                {#each columnSettings as col}
                    <button 
                        type="button"
                        class="px-3 py-1 rounded-full text-xs font-medium border transition-all select-none
                                {col.visible ? 'bg-blue-600 text-white border-blue-600' : 'bg-white text-gray-500 border-gray-300 hover:bg-gray-50'}"
                        on:click={() => toggleColumn(col)}
                        title={col.loaiSoLieu}
                    >
                        {col.label}
                    </button>
                {/each}
            </div>
        </div>

        <div class="bg-white rounded-xl shadow-md border border-gray-200 overflow-hidden" data-capture-group="pasted-competition">
            
            <div class="p-4 bg-white border-b border-gray-200 flex justify-between items-center">
                <div>
                    <h3 class="text-lg font-bold text-purple-800 uppercase flex items-center gap-2">
                        <i data-feather="award" class="w-5 h-5"></i>
                        Thi ƒêua L≈©y K·∫ø
                    </h3>
                    <p class="text-xs text-gray-500 mt-0.5 ml-7">Theo d√µi ti·∫øn ƒë·ªô c√°c ch∆∞∆°ng tr√¨nh thi ƒëua</p>
                </div>

                <div class="flex items-center bg-gray-100 rounded-lg p-1 border border-gray-200 shadow-inner">
                    <button 
                        type="button"
                        class="px-4 py-1.5 rounded-md text-xs font-bold transition-all shadow-sm bg-white text-blue-700 cursor-default"
                    >
                        Nh√¢n vi√™n
                    </button>
                    <button 
                        type="button"
                        class="px-4 py-1.5 rounded-md text-xs font-medium text-gray-500 hover:text-gray-900 hover:bg-gray-200 transition-colors cursor-pointer"
                        on:click={switchToProgram}
                    >
                        Ch∆∞∆°ng tr√¨nh
                    </button>
                </div>
            </div>
            
            <div class="overflow-x-auto sknv-pasted-competition-scroller relative" style="max-height: 700px;">
                <table class="w-full text-sm text-left border-separate border-spacing-0">
                    <thead class="text-xs uppercase font-bold text-gray-700 sticky top-0 z-20 shadow-sm">
                        <tr>
                            <th class="bg-gray-100 border-b border-r border-gray-200 min-w-[150px] w-[150px] sticky left-0 z-30 px-2 py-2 cursor-pointer hover:bg-gray-200 transition select-none align-middle text-sm" on:click={() => handleSort('hoTen')}>
                                Nh√¢n vi√™n
                            </th>
                            
                            <th class="bg-gray-100 border-b border-r border-gray-200 w-[100px] min-w-[100px] sticky left-[150px] z-30 px-1 py-2 text-center cursor-pointer hover:bg-gray-200 transition select-none align-middle" on:click={() => handleSort('totalScore')}>
                                ƒê·∫°t
                            </th>

                            {#each visibleColumns as col, index}
                                <th 
                                    class="px-1 py-1 w-auto min-w-[60px] max-w-[90px] whitespace-normal break-words border-b border-r border-gray-200 {getHeaderColor(index)} align-middle cursor-pointer hover:opacity-80 transition select-none"
                                    on:click={() => handleSort(col.id)}
                                    title="{col.label} (B·∫•m ƒë·ªÉ s·∫Øp x·∫øp)"
                                >
                                    <div class="text-[10px] font-bold leading-3 text-center whitespace-normal break-words min-h-[32px] flex items-center justify-center">
                                        {col.label}
                                    </div>
                                </th>
                            {/each}
                        </tr>
                    </thead>
                    
                    <tbody class="divide-y divide-gray-100">
                        {#each sortedEmployees as item (item.maNV)}
                            {@const avgScores = deptAverages[item.boPhan] || {}}
                            {@const score = item.competitions.reduce((acc, c) => (avgScores[c.tenGoc] > 0 && c.giaTri >= avgScores[c.tenGoc]) ? acc + 1 : acc, 0)}
                            
                            <tr 
                                class="hover:bg-blue-50 transition-colors group cursor-pointer"
                                on:click={() => dispatch('viewDetail', { employeeId: item.maNV })}
                            >
                                <td class="px-2 py-1.5 font-semibold text-blue-700 bg-white group-hover:bg-blue-50 sticky left-0 z-10 border-r border-gray-200 whitespace-nowrap text-[13px] truncate max-w-[150px]" title="{item.hoTen} - {item.maNV}">
                                    {formatters.getShortEmployeeName(item.hoTen, item.maNV)}
                                </td>
                                
                                <td class="px-1 py-1.5 w-[100px] min-w-[100px] text-center font-bold text-green-600 bg-white group-hover:bg-blue-50 border-r border-gray-200 text-[14px] sticky left-[150px] z-10">
                                    {score}
                                </td>

                                {#each visibleColumns as col}
                                    {@const comp = item.competitions.find(c => c.tenGoc === col.tenGoc)}
                                    {@const val = comp?.giaTri || 0}
                                    {@const avg = avgScores[col.tenGoc] || 0}
                                    {@const isBelow = avg > 0 && val < avg}
                                    {@const isRevenue = col.loaiSoLieu && col.loaiSoLieu.includes('DT')}
                                    {@const textColorClass = isRevenue ? 'text-blue-700' : 'text-gray-900'}
                                    
                                    <td class="px-1 py-1.5 text-right border-r border-gray-100 font-bold text-[13px] {isBelow ? 'bg-red-50' : ''} {textColorClass} whitespace-nowrap overflow-hidden">
                                        {#if val === 0}
                                            <span class="text-gray-300 font-normal">-</span>
                                        {:else}
                                            {formatters.formatNumber(val)}
                                        {/if}
                                    </td>
                                {/each}
                            </tr>
                        {/each}
                    </tbody>
                    
                    <tfoot class="text-xs uppercase sticky bottom-0 z-20 shadow-[0_-1px_2px_rgba(0,0,0,0.1)]">
                        <tr class="bg-yellow-50 text-yellow-800 font-semibold border-t-2 border-gray-300">
                            <td class="px-2 py-2 sticky left-0 bg-yellow-100 border-r border-gray-300 z-30 text-center text-[13px]">
                                TRUNG B√åNH
                            </td>
                            <td class="px-2 py-2 border-r border-gray-300 bg-yellow-100 sticky left-[150px] z-30 text-center text-[13px] font-bold text-green-700">
                                {allEmployees.length > 0 ? formatters.formatNumber(calculateTotalScore() / allEmployees.length, 1) : 0}
                            </td>
                            {#each visibleColumns as col}
                                <td class="px-1 py-2 text-right border-r border-gray-300 text-[13px]">
                                    {allEmployees.length > 0 ? formatters.formatNumber(calculateTotal(col) / allEmployees.length, 0) : 0}
                                </td>
                            {/each}
                        </tr>

                        <tr class="bg-gray-200 text-gray-900 font-bold border-t border-gray-300">
                            <td class="px-2 py-2 sticky left-0 bg-gray-300 border-r border-gray-300 z-30 text-center text-[13px]">
                                T·ªîNG
                            </td>
                            <td class="px-2 py-2 border-r border-gray-300 bg-gray-300 sticky left-[150px] z-30 text-center text-[13px]">
                                {calculateTotalScore()}
                            </td>
                            {#each visibleColumns as col}
                                <td class="px-1 py-2 text-right border-r border-gray-300 text-[13px]">
                                    {formatters.formatNumber(calculateTotal(col))}
                                </td>
                            {/each}
                        </tr>
                    </tfoot>
                </table>
            </div>
        </div>
    {/if}
</div>

<style>
    .animate-fade-in { animation: fadeIn 0.4s ease-out; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    .sticky { position: sticky; }
    
    .custom-scrollbar::-webkit-scrollbar { width: 4px; height: 4px; }
    .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
    .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 2px; }

    table { border-spacing: 0; }
    /* CSS cho Line Clamp 2 d√≤ng */
    .line-clamp-2 {
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
    }
</style>

================================================================================
File: src/components/health-staff/competition/FocusCompetitionTable.svelte
================================================================================

<script>
    import { formatters } from '../../../utils/formatters.js';
    import { datasyncService } from '../../../services/datasync.service.js';
    import { selectedWarehouse, localCompetitionConfigs } from '../../../stores.js';
  
    // Nh·∫≠n d·ªØ li·ªáu t·ª´ component cha
    export let competitionResult;
  
    // Destructure d·ªØ li·ªáu ƒë·ªÉ d·ªÖ d√πng
    $: competition = competitionResult.competition;
    $: employeeData = competitionResult.employeeData;
    $: brands = competition.brands || [];
  
    // --- [1] LOGIC M·ª§C TI√äU & T√î M√ÄU (NEW) ---
    
    // Bi·∫øn l∆∞u m·ª•c ti√™u ng∆∞·ªùi d√πng nh·∫≠p (M·∫∑c ƒë·ªãnh 0)
    let localTarget = 0;
    let isSaving = false;
  
    // T·ª± ƒë·ªông load m·ª•c ti√™u c≈© ƒë√£ l∆∞u (n·∫øu c√≥) khi m·ªü trang
    $: if ($localCompetitionConfigs && competition) {
        const savedConfig = $localCompetitionConfigs.find(c => c.id === competition.id);
        if (savedConfig && !isSaving) {
            localTarget = savedConfig.target || 0;
        }
    }
  
    // X·ª≠ l√Ω d·ªØ li·ªáu hi·ªÉn th·ªã & T√≠nh m√†u s·∫Øc
    $: processedData = sortedData.map(item => {
        // Quy ƒë·ªïi m·ª•c ti√™u t·ª´ % (VD: 80) sang s·ªë th·∫≠p ph√¢n (0.8) ƒë·ªÉ so s√°nh
        const targetDecimal = localTarget > 0 ? localTarget / 100 : 0;
        const hasTarget = localTarget > 0;
  
        // Logic ki·ªÉm tra: Ch·ªâ so s√°nh n·∫øu c√≥ ƒë·∫∑t m·ª•c ti√™u
        const isLowSL = hasTarget && item.tyLeSL < targetDecimal;
        const isLowDT = hasTarget && item.tyLeDT < targetDecimal;
  
        return {
            ...item,
            // N·∫øu d∆∞·ªõi m·ª•c ti√™u -> T√¥ ƒë·ªè & In ƒë·∫≠m. Ng∆∞·ª£c l·∫°i -> M√†u x√°m th∆∞·ªùng
            classSL: isLowSL ? 'text-red-600 font-bold bg-red-50' : 'text-gray-600',
            classDT: isLowDT ? 'text-red-600 font-bold bg-red-50' : 'text-gray-900 font-medium'
        };
    });
  
    // --- [2] LOGIC L∆ØU TR·ªÆ ---
    let saveTimer;
    let saveStatus = '';
  
    function handleInput() {
        isSaving = true;
        saveStatus = 'saving';
        
        // Debounce: Ch·ªù ng∆∞·ªùi d√πng g√µ xong 0.8s m·ªõi l∆∞u
        if (saveTimer) clearTimeout(saveTimer);
        
        saveTimer = setTimeout(async () => {
            try {
                if (!$selectedWarehouse) return;
  
                // C·∫≠p nh·∫≠t Store (ƒë·ªÉ c√°c tab kh√°c th·∫•y ngay)
                let currentConfigs = $localCompetitionConfigs ? [...$localCompetitionConfigs] : [];
                const idx = currentConfigs.findIndex(c => c.id === competition.id);
                
                if (idx >= 0) {
                    currentConfigs[idx] = { ...currentConfigs[idx], target: localTarget };
                } else {
                    currentConfigs.push({ id: competition.id, target: localTarget });
                }
                localCompetitionConfigs.set(currentConfigs);
  
                // L∆∞u xu·ªëng Database
                await datasyncService.saveCompetitionConfigs($selectedWarehouse, currentConfigs);
                
                saveStatus = 'success';
                setTimeout(() => { saveStatus = ''; isSaving = false; }, 2000);
            } catch (error) {
                console.error(error);
                saveStatus = 'error';
                isSaving = false;
            }
        }, 800);
    }
  
    // --- [3] LOGIC S·∫ÆP X·∫æP & UI KH√ÅC (GI·ªÆ NGUY√äN) ---
    let sortKey = 'tyLeDT';
    let sortDirection = 'desc';
  
    function handleSort(key) {
        if (sortKey === key) {
            sortDirection = sortDirection === 'desc' ? 'asc' : 'desc';
        } else {
            sortKey = key;
            sortDirection = 'desc';
        }
    }
  
    $: sortedData = [...employeeData].sort((a, b) => {
        let valA = 0, valB = 0;
        // Logic l·∫•y gi√° tr·ªã s·∫Øp x·∫øp
        if (sortKey === 'hoTen') {
            return sortDirection === 'asc' ? a.hoTen.localeCompare(b.hoTen) : b.hoTen.localeCompare(a.hoTen);
        } else if (sortKey.includes('_quantity') || sortKey.includes('_revenue')) {
            const [brandName, type] = sortKey.split('_');
            valA = (a.performanceByBrand[brandName] || {})[type] || 0;
            valB = (b.performanceByBrand[brandName] || {})[type] || 0;
        } else {
            valA = Number(a[sortKey]) || 0;
            valB = Number(b[sortKey]) || 0;
        }
        return sortDirection === 'asc' ? valA - valB : valB - valA;
    });
  
    // T√≠nh t·ªïng ch√¢n trang
    $: totals = employeeData.reduce((acc, item) => {
        acc.baseCategoryQuantity += item.baseCategoryQuantity;
        acc.baseCategoryRevenue += item.baseCategoryRevenue;
        brands.forEach(brand => {
            if (!acc.performanceByBrand[brand]) acc.performanceByBrand[brand] = { quantity: 0, revenue: 0 };
            acc.performanceByBrand[brand].quantity += item.performanceByBrand[brand]?.quantity || 0;
            acc.performanceByBrand[brand].revenue += item.performanceByBrand[brand]?.revenue || 0;
        });
        return acc;
    }, { baseCategoryQuantity: 0, baseCategoryRevenue: 0, performanceByBrand: {} });
  
    $: totalTyLeDT = totals.baseCategoryRevenue > 0 ? 
        Object.values(totals.performanceByBrand).reduce((sum, b) => sum + b.revenue, 0) / totals.baseCategoryRevenue : 0;
  
    const headerClass = (key) => `px-2 py-3 cursor-pointer select-none transition text-xs font-bold uppercase ${sortKey === key ? 'bg-indigo-100 text-indigo-800' : 'hover:bg-gray-200'}`;
  </script>
  
  <div class="bg-white rounded-lg shadow border border-gray-200 overflow-hidden flex flex-col h-full">
      <div class="p-3 bg-gray-50 border-b border-gray-200 flex justify-between items-center">
          <div>
              <h3 class="text-base font-bold text-gray-800 uppercase">{competition.name}</h3>
              <p class="text-[11px] text-gray-500 mt-0.5">
                  Ph·∫°m vi: <span class="font-semibold text-indigo-600">{brands.join(', ')}</span>
              </p>
          </div>
          
          <div class="flex items-center gap-2 bg-white px-2 py-1 rounded border border-gray-300 shadow-sm relative">
              <span class="text-xs font-semibold text-gray-600">M·ª•c ti√™u:</span>
              <input 
                  type="number" 
                  bind:value={localTarget}
                  on:input={handleInput}
                  on:focus={(e) => e.target.select()}
                  class="w-10 text-center font-bold text-indigo-700 border-b border-gray-300 focus:border-indigo-500 outline-none text-sm p-0"
                  placeholder="0"
              />
              <span class="text-xs font-bold text-gray-500">%</span>
  
              {#if saveStatus === 'saving'}
                  <span class="absolute -bottom-4 right-0 text-[9px] text-orange-500 animate-pulse">L∆∞u...</span>
              {:else if saveStatus === 'success'}
                  <span class="absolute -bottom-4 right-0 text-[9px] text-green-600">ƒê√£ l∆∞u</span>
              {/if}
          </div>
      </div>
  
      <div class="overflow-x-auto flex-grow">
          <table class="min-w-full text-sm text-left border-collapse">
              <thead class="text-xs text-slate-700 bg-slate-100 sticky top-0 z-10 shadow-sm">
                  <tr>
                      <th rowspan="2" class="{headerClass('hoTen')} bg-gray-200 min-w-[160px] border-r border-gray-300" on:click={() => handleSort('hoTen')}>
                          Nh√¢n vi√™n {sortKey === 'hoTen' ? (sortDirection === 'asc' ? '‚ñ≤' : '‚ñº') : ''}
                      </th>
                      {#each brands as brand}
                          <th colspan="2" class="px-2 py-1 text-center border-l border-gray-300 bg-purple-50 text-purple-900 font-bold">{brand}</th>
                      {/each}
                      <th colspan="2" class="px-2 py-1 text-center border-l border-gray-300 bg-blue-50 text-blue-900 font-bold">T·ªïng Nh√≥m</th>
                      <th colspan="2" class="px-2 py-1 text-center border-l border-gray-300 bg-orange-50 text-orange-900 font-bold">T·ª∑ l·ªá</th>
                  </tr>
                  <tr>
                      {#each brands as brand}
                          <th class="{headerClass(`${brand}_quantity`)} text-right border-l border-gray-200" on:click={() => handleSort(`${brand}_quantity`)}>SL</th>
                          <th class="{headerClass(`${brand}_revenue`)} text-right" on:click={() => handleSort(`${brand}_revenue`)}>DT</th>
                      {/each}
                      
                      <th class="{headerClass('baseCategoryQuantity')} text-right border-l border-gray-200" on:click={() => handleSort('baseCategoryQuantity')}>SL</th>
                      <th class="{headerClass('baseCategoryRevenue')} text-right" on:click={() => handleSort('baseCategoryRevenue')}>DT</th>
                      
                      <th class="{headerClass('tyLeSL')} text-right border-l border-gray-200 text-orange-800" on:click={() => handleSort('tyLeSL')}>% SL</th>
                      <th class="{headerClass('tyLeDT')} text-right text-orange-800" on:click={() => handleSort('tyLeDT')}>% DT</th>
                  </tr>
              </thead>
              
              <tbody class="divide-y divide-gray-100">
                  {#each processedData as item}
                      <tr class="hover:bg-indigo-50/50 transition-colors">
                          <td class="px-3 py-2 font-semibold text-indigo-900 whitespace-nowrap sticky left-0 bg-white hover:bg-indigo-50 border-r border-gray-200 shadow-[2px_0_5px_-2px_rgba(0,0,0,0.1)]">
                              {formatters.getShortEmployeeName(item.hoTen, item.maNV)}
                          </td>
                          
                          {#each brands as brand}
                              {@const perf = item.performanceByBrand[brand] || {quantity: 0, revenue: 0}}
                              <td class="px-2 py-2 text-right border-l border-gray-100 text-gray-500">{formatters.formatNumberOrDash(perf.quantity)}</td>
                              <td class="px-2 py-2 text-right text-gray-700">{formatters.formatRevenue(perf.revenue)}</td>
                          {/each}
  
                          <td class="px-2 py-2 text-right border-l border-gray-200 font-medium bg-blue-50/20">{formatters.formatNumberOrDash(item.baseCategoryQuantity)}</td>
                          <td class="px-2 py-2 text-right font-medium bg-blue-50/20">{formatters.formatRevenue(item.baseCategoryRevenue)}</td>
                          
                          <td class="px-2 py-2 text-right border-l border-gray-200 {item.classSL}">
                              {formatters.formatPercentage(item.tyLeSL)}
                          </td>
  
                          <td class="px-2 py-2 text-right {item.classDT}">
                              {formatters.formatPercentage(item.tyLeDT)}
                          </td>
                      </tr>
                  {/each}
              </tbody>
              
              <tfoot class="bg-gray-100 font-bold text-gray-800 border-t-2 border-gray-300 text-xs">
                  <tr>
                      <td class="px-3 py-2 sticky left-0 bg-gray-100 border-r border-gray-300">T·ªïng C·ªông</td>
                      {#each brands as brand}
                          {@const perf = totals.performanceByBrand[brand] || {quantity: 0, revenue: 0}}
                          <td class="px-2 py-2 text-right border-l border-gray-200">{formatters.formatNumberOrDash(perf.quantity)}</td>
                          <td class="px-2 py-2 text-right">{formatters.formatRevenue(perf.revenue)}</td>
                      {/each}
                      <td class="px-2 py-2 text-right border-l border-gray-200">{formatters.formatNumberOrDash(totals.baseCategoryQuantity)}</td>
                      <td class="px-2 py-2 text-right">{formatters.formatRevenue(totals.baseCategoryRevenue)}</td>
                      <td class="px-2 py-2 text-right border-l border-gray-200">-</td>
                      <td class="px-2 py-2 text-right text-blue-700">{formatters.formatPercentage(totalTyLeDT)}</td>
                  </tr>
              </tfoot>
          </table>
      </div>
  </div>

================================================================================
File: src/components/health-staff/competition/ProgramView.svelte
================================================================================

<script>
  import FocusCompetitionTable from './FocusCompetitionTable.svelte';

  export let reportData = []; // M·∫£ng k·∫øt qu·∫£ t√≠nh to√°n t·ª´ service
</script>

{#if reportData.length === 0}
    <div class="p-12 text-center bg-white border-2 border-dashed border-gray-300 rounded-xl">
        <p class="text-gray-500 font-medium">Kh√¥ng c√≥ d·ªØ li·ªáu ch∆∞∆°ng tr√¨nh thi ƒëua.</p>
        <p class="text-sm text-gray-400 mt-2">
            Vui l√≤ng ki·ªÉm tra:
            1. ƒê√£ t·∫°o ch∆∞∆°ng tr√¨nh trong "Thi·∫øt l·∫≠p m·ª•c ti√™u"?
            2. ƒê√£ t·∫£i file YCX?
            3. C√≥ ph√°t sinh doanh thu cho c√°c nh√≥m h√†ng ƒë√£ ch·ªçn?
        </p>
    </div>
{:else}
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 pb-10">
        {#each reportData as result (result.competition.id)}
            <div class="h-full">
                <FocusCompetitionTable competitionResult={result} />
            </div>
        {/each}
    </div>
{/if}

================================================================================
File: src/components/health-staff/detail/CardFilter.svelte
================================================================================

<script>
    import { createEventDispatcher } from 'svelte';
    
    export let items = []; // Array { id, label, visible }

    const dispatch = createEventDispatcher();
    let isOpen = false;
    let containerRef; 

    function toggleDropdown() {
        isOpen = !isOpen;
    }

    function toggleItem(id) {
        dispatch('change', id);
    }

    // ƒê√≥ng dropdown khi click ra ngo√†i container c·ªßa ch√≠nh component n√†y
    function close(e) {
        if (isOpen && containerRef && !containerRef.contains(e.target)) {
            isOpen = false;
        }
    }
</script>

<svelte:window on:click={close} />

<div class="relative inline-block text-left" bind:this={containerRef}>
    <button 
        type="button" 
        class="text-white/70 hover:text-white p-1 rounded-full hover:bg-white/20 transition-colors"
        on:click|stopPropagation={toggleDropdown}
        title="L·ªçc ch·ªâ s·ªë hi·ªÉn th·ªã"
    >
        <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z" />
        </svg>
    </button>

    {#if isOpen}
        <div class="absolute right-0 mt-2 w-64 bg-white rounded-lg shadow-xl border border-gray-200 z-[100] animate-fade-in-fast origin-top-right">
            <div class="p-2 border-b border-gray-100 bg-gray-50 rounded-t-lg">
                <span class="text-xs font-bold text-gray-500 uppercase">Hi·ªÉn th·ªã ch·ªâ s·ªë</span>
            </div>
            <div class="p-1 max-h-60 overflow-y-auto custom-scrollbar">
                {#if items.length === 0}
                    <div class="px-3 py-2 text-xs text-gray-400 text-center">Kh√¥ng c√≥ m·ª•c n√†o.</div>
                {:else}
                    {#each items as item (item.id)}
                        <label class="flex items-center px-3 py-2 hover:bg-gray-50 cursor-pointer rounded transition-colors group">
                            <input 
                                type="checkbox" 
                                checked={item.visible !== false} 
                                on:change={() => toggleItem(item.id)}
                                class="mr-3 h-4 w-4 text-blue-600 rounded border-gray-300 focus:ring-blue-500 cursor-pointer"
                            >
                            <span class="text-sm text-gray-700 group-hover:text-blue-700 truncate select-none" title={item.label}>
                                {item.label}
                            </span>
                        </label>
                    {/each}
                {/if}
            </div>
        </div>
    {/if}
</div>

<style>
    .animate-fade-in-fast { animation: fadeIn 0.1s ease-out; }
    @keyframes fadeIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
    
    .custom-scrollbar::-webkit-scrollbar { width: 4px; }
    .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
    .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 2px; }
</style>

================================================================================
File: src/components/health-staff/detail/DetailHeader.svelte
================================================================================

<script>
  // Component hi·ªÉn th·ªã Header c·ªßa trang chi ti·∫øt
  export let employee;
  export let totalAbove = 0;
  export let totalCriteria = 0;
  // [M·ªöI] Prop ƒë·ªÉ ƒëi·ªÅu khi·ªÉn hi·ªÉn th·ªã d√≤ng ƒë√°nh gi√°
  export let showStats = true;
</script>

<div class="flex items-center gap-6 p-4 bg-purple-50 border border-purple-200 border-t-4 border-t-purple-500 rounded-lg shadow-sm mb-6">
    <div class="w-16 h-16 rounded-full bg-purple-200 flex items-center justify-center flex-shrink-0 text-purple-800">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-8 h-8">
            <path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/>
        </svg>
    </div>
    
    <div class="flex-grow">
        <p class="text-2xl font-extrabold text-purple-800 leading-tight">
             {employee.hoTen} <span class="text-lg font-semibold text-purple-600">- {employee.maNV}</span>
        </p>
        <p class="text-gray-700 font-medium text-base">{employee.boPhan}</p>
        
        {#if showStats}
            <p class="mt-1 text-sm font-semibold text-gray-800">
                Ch·ªâ s·ªë tr√™n TB: <span class="text-green-600 font-bold text-lg">{totalAbove}</span> 
                <span class="text-gray-400 mx-1">/</span> 
                T·ªïng: <span class="font-bold text-gray-600">{totalCriteria}</span>
            </p>
        {/if}
    </div>
</div>

================================================================================
File: src/components/health-staff/detail/DetailTableCategory.svelte
================================================================================

<script>
  import { formatters } from '../../../utils/formatters.js';
  import { cleanCategoryName } from '../../../utils.js';
  import { categoryStructure, macroCategoryConfig } from '../../../stores.js'; 
  import CardFilter from './CardFilter.svelte';

  export let data = []; 
  export let rawEmployee = null; 

  const headerClass = "bg-[#7e22ce]";

  // H√†m chu·∫©n h√≥a key ƒë·ªÉ so s√°nh (vi·∫øt th∆∞·ªùng + b·ªè kho·∫£ng tr·∫Øng th·ª´a)
  const normalizeKey = (str) => {
      if (!str) return '';
      return String(str).trim().toLowerCase();
  };

  let displayData = [];
  let filterItems = [];
  
  // State hi·ªÉn th·ªã (L∆∞u danh s√°ch c√°c KEY ƒë√£ chu·∫©n h√≥a)
  let visibleKeys = new Set();
  let isInitialized = false;

  // Logic x·ª≠ l√Ω d·ªØ li·ªáu ch√≠nh
  $: {
      // 1. Thu th·∫≠p t·∫•t c·∫£ c√°c t√™n ng√†nh h√†ng t·ª´ m·ªçi ngu·ªìn
      const source1 = ($macroCategoryConfig || []).map(m => m.name);
      const source2 = ($categoryStructure || []).map(c => cleanCategoryName(c.nganhHang)).filter(Boolean);
      const source3 = data.map(i => i.name);
      
      // Danh s√°ch t√™n g·ªëc ƒë·ªÉ hi·ªÉn th·ªã
      const allRawNames = [...source1, ...source2, ...source3];

      // 2. G·ªôp d·ªØ li·ªáu v√†o Map ƒë·ªÉ kh·ª≠ tr√πng l·∫∑p d·ª±a tr√™n key chu·∫©n h√≥a
      const mergedMap = new Map();

      allRawNames.forEach(rawName => {
          const key = normalizeKey(rawName);
          if (!key) return;

          // N·∫øu ch∆∞a c√≥ trong Map, t·∫°o m·ªõi
          if (!mergedMap.has(key)) {
              // ∆Øu ti√™n l·∫•y s·ªë li·ªáu t·ª´ 'data' (ƒë√£ t√≠nh to√°n)
              let existingItem = data.find(i => normalizeKey(i.name) === key);
              
              // N·∫øu kh√¥ng c√≥, l·∫•y t·ª´ rawEmployee (tra c·ª©u an to√†n)
              if (!existingItem && rawEmployee?.doanhThuTheoNganhHang) {
                  // C·∫ßn t√¨m key g·ªëc trong object rawEmployee kh·ªõp v·ªõi key chu·∫©n h√≥a
                  const rawKey = Object.keys(rawEmployee.doanhThuTheoNganhHang).find(k => normalizeKey(k) === key);
                  if (rawKey) {
                      existingItem = rawEmployee.doanhThuTheoNganhHang[rawKey];
                  }
              }

              // T·∫°o object hi·ªÉn th·ªã
              mergedMap.set(key, {
                  id: key, // D√πng key chu·∫©n h√≥a l√†m ID duy nh·∫•t cho v√≤ng l·∫∑p
                  name: rawName, // T√™n hi·ªÉn th·ªã (l·∫•y c√°i ƒë·∫ßu ti√™n t√¨m th·∫•y)
                  quantity: existingItem ? existingItem.quantity : 0,
                  revenue: existingItem ? existingItem.revenue : 0,
                  revenueQuyDoi: existingItem ? existingItem.revenueQuyDoi : 0
              });
          }
      });

      // 3. Kh·ªüi t·∫°o tr·∫°ng th√°i filter (ch·ªâ ch·∫°y 1 l·∫ßn ƒë·∫ßu)
      if (!isInitialized && mergedMap.size > 0) {
          // M·∫∑c ƒë·ªãnh hi·ªán nh·ªØng c√°i c√≥ s·ªë li·ªáu > 0
          mergedMap.forEach((val, key) => {
              if (val.revenue > 0 || val.quantity > 0) {
                  visibleKeys.add(key);
              }
          });
          // N·∫øu nh√¢n vi√™n kh√¥ng c√≥ d·ªØ li·ªáu g√¨, hi·ªán t·∫•t c·∫£ ho·∫∑c top 10 (tu·ª≥ ch·ªçn), ·ªü ƒë√¢y ta ƒë·ªÉ tr·ªëng
          visibleKeys = new Set(visibleKeys);
          isInitialized = true;
      }

      // 4. T·∫°o danh s√°ch hi·ªÉn th·ªã cu·ªëi c√πng
      displayData = Array.from(mergedMap.values())
          .filter(item => visibleKeys.has(item.id))
          .sort((a, b) => b.revenue - a.revenue);

      // 5. T·∫°o danh s√°ch cho b·ªô l·ªçc
      // Sort b·ªô l·ªçc theo t√™n A-Z ƒë·ªÉ d·ªÖ t√¨m
      filterItems = Array.from(mergedMap.values())
          .map(item => ({
              id: item.id,
              label: item.name,
              visible: visibleKeys.has(item.id)
          }))
          .sort((a, b) => a.label.localeCompare(b.label));
  }

  function handleFilterChange(event) {
      const id = event.detail; // id nh·∫≠n ƒë∆∞·ª£c l√† key ƒë√£ chu·∫©n h√≥a
      if (visibleKeys.has(id)) {
          visibleKeys.delete(id);
      } else {
          visibleKeys.add(id);
      }
      visibleKeys = new Set(visibleKeys); // Trigger reactivity
  }
</script>

<div class="bg-white rounded-xl shadow-md border border-gray-200 overflow-hidden flex flex-col h-full">
    <div class="{headerClass} flex justify-between items-center p-3 text-white">
        <div class="flex items-center gap-2">
            <i data-feather="list" class="w-5 h-5"></i>
            <h4 class="text-lg font-bold">Doanh thu ng√†nh h√†ng</h4>
        </div>
        <CardFilter items={filterItems} on:change={handleFilterChange} />
    </div>
    
    <div class="overflow-x-auto max-h-96">
        <table class="w-full text-sm table-bordered table-striped">
            <thead class="bg-gray-50 font-bold text-gray-700 sticky top-0 z-10">
                <tr>
                    <th class="px-3 py-2 text-left">Ng√†nh h√†ng</th>
                    <th class="px-3 py-2 text-right">SL</th>
                    <th class="px-3 py-2 text-right">Doanh thu</th>
                    <th class="px-3 py-2 text-right">DTQƒê</th>
                </tr>
            </thead>
            <tbody>
                {#if displayData.length === 0}
                    <tr><td colspan="4" class="p-4 text-center text-gray-500">ƒê√£ ·∫©n h·∫øt d·ªØ li·ªáu.</td></tr>
                {:else}
                    {#each displayData as item (item.id)}
                        <tr class="border-t hover:bg-slate-50 transition-colors">
                            <td class="px-3 py-2 font-medium capitalize text-gray-800">{item.name}</td>
                            <td class="px-3 py-2 text-right font-bold text-gray-600">{formatters.formatNumber(item.quantity)}</td>
                            <td class="px-3 py-2 text-right font-bold text-gray-800">{formatters.formatRevenue(item.revenue, 0)}</td>
                            <td class="px-3 py-2 text-right font-bold text-purple-600">{formatters.formatRevenue(item.revenueQuyDoi, 0)}</td>
                        </tr>
                    {/each}
                {/if}
            </tbody>
        </table>
    </div>
</div>

================================================================================
File: src/components/health-staff/detail/DetailTableQDC.svelte
================================================================================

<script>
  import { formatters } from '../../../utils/formatters.js';
  import { cleanCategoryName } from '../../../utils.js';
  import { categoryStructure, macroProductGroupConfig } from '../../../stores.js'; 
  import CardFilter from './CardFilter.svelte';

  export let data = []; 
  export let rawEmployee = null; 

  const headerClass = "bg-[#4f46e5]"; 

  const normalizeKey = (str) => {
      if (!str) return '';
      return String(str).trim().toLowerCase();
  };

  let displayData = [];
  let filterItems = [];
  let visibleKeys = new Set();
  let isInitialized = false;

  $: {
      const source1 = ($macroProductGroupConfig || []).map(m => m.name);
      const source2 = ($categoryStructure || []).map(c => cleanCategoryName(c.nhomHang)).filter(Boolean);
      const source3 = data.map(i => i.name);
      const allRawNames = [...source1, ...source2, ...source3];

      const mergedMap = new Map();

      allRawNames.forEach(rawName => {
          const key = normalizeKey(rawName);
          if (!key) return;

          if (!mergedMap.has(key)) {
              let existingItem = data.find(i => normalizeKey(i.name) === key);
              
              if (!existingItem) {
                  // Th·ª≠ t√¨m trong nhomHangChiTiet
                  if (rawEmployee?.doanhThuTheoNhomHang) {
                      const rawKey = Object.keys(rawEmployee.doanhThuTheoNhomHang).find(k => normalizeKey(k) === key);
                      if (rawKey) existingItem = rawEmployee.doanhThuTheoNhomHang[rawKey];
                  }
                  // N·∫øu kh√¥ng th·∫•y, th·ª≠ t√¨m trong qdc (v√¨ QƒêC c≈©ng l√† nh√≥m h√†ng)
                  if (!existingItem && rawEmployee?.qdc) {
                      const rawKey = Object.keys(rawEmployee.qdc).find(k => normalizeKey(k) === key);
                      if (rawKey) existingItem = rawEmployee.qdc[rawKey];
                  }
              }

              mergedMap.set(key, {
                  id: key,
                  name: rawName,
                  sl: existingItem ? (existingItem.sl || existingItem.quantity || 0) : 0,
                  dtqd: existingItem ? (existingItem.dtqd || existingItem.revenueQuyDoi || 0) : 0
              });
          }
      });

      if (!isInitialized && mergedMap.size > 0) {
          mergedMap.forEach((val, key) => {
              if (val.dtqd > 0 || val.sl > 0) visibleKeys.add(key);
          });
          visibleKeys = new Set(visibleKeys);
          isInitialized = true;
      }

      displayData = Array.from(mergedMap.values())
          .filter(item => visibleKeys.has(item.id))
          .sort((a, b) => b.dtqd - a.dtqd);

      filterItems = Array.from(mergedMap.values())
          .map(item => ({
              id: item.id,
              label: item.name,
              visible: visibleKeys.has(item.id)
          }))
          .sort((a, b) => a.label.localeCompare(b.label));
  }

  function handleFilterChange(event) {
      const id = event.detail;
      if (visibleKeys.has(id)) visibleKeys.delete(id);
      else visibleKeys.add(id);
      visibleKeys = new Set(visibleKeys);
  }
</script>

<div class="bg-white rounded-xl shadow-md border border-gray-200 overflow-hidden flex flex-col h-full">
    <div class="{headerClass} flex justify-between items-center p-3 text-white">
        <div class="flex items-center gap-2">
            <i data-feather="star" class="w-5 h-5"></i>
            <h4 class="text-lg font-bold">Nh√≥m h√†ng Quy ƒë·ªïi cao</h4>
        </div>
        <CardFilter items={filterItems} on:change={handleFilterChange} />
    </div>
    
    <div class="overflow-x-auto max-h-96">
        <table class="w-full text-sm table-bordered table-striped">
            <thead class="bg-gray-50 font-bold text-gray-700 sticky top-0 z-10">
                <tr>
                    <th class="px-3 py-2 text-left">Nh√≥m h√†ng</th>
                    <th class="px-3 py-2 text-right">SL</th>
                    <th class="px-3 py-2 text-right">DTQƒê (Tr)</th>
                </tr>
            </thead>
            <tbody>
                {#if displayData.length === 0}
                    <tr><td colspan="3" class="p-4 text-center text-gray-500">ƒê√£ ·∫©n h·∫øt d·ªØ li·ªáu.</td></tr>
                {:else}
                    {#each displayData as item (item.id)}
                        <tr class="border-t hover:bg-slate-50 transition-colors">
                            <td class="px-3 py-2 font-medium text-gray-800">{item.name}</td>
                            <td class="px-3 py-2 text-right font-bold text-gray-600">{formatters.formatNumber(item.sl)}</td>
                            <td class="px-3 py-2 text-right font-bold text-blue-600">{formatters.formatRevenue(item.dtqd)}</td>
                        </tr>
                    {/each}
                {/if}
            </tbody>
        </table>
    </div>
</div>

================================================================================
File: src/components/health-staff/detail/DetailView.svelte
================================================================================

<script>
  import { afterUpdate, createEventDispatcher, onMount } from 'svelte';
  import { masterReportData, selectedWarehouse, warehouseCustomMetrics } from '../../../stores.js';
  import { sknvService } from '../../../services/sknv.service.js';
  import { datasyncService } from '../../../services/datasync.service.js';
  
  import DetailHeader from './DetailHeader.svelte';
  import MetricGrid from './MetricGrid.svelte';
  import DetailTableQDC from './DetailTableQDC.svelte';
  import DetailTableCategory from './DetailTableCategory.svelte';
  
  import AddEfficiencyColumnModal from '../../modals/AddEfficiencyColumnModal.svelte';
  import AddMetricModal from '../../modals/AddMetricModal.svelte';

  export let employeeId;

  const dispatch = createEventDispatcher();

  let employeeData = null;
  let rawEmployeeData = null;
  let detailStats = {};
  let qdcData = [];
  let nganhHangData = [];
  
  let kpiCounts = {
      'Doanh thu': { above: 0, total: 0 },
      'Hi·ªáu qu·∫£ khai th√°c': { above: 0, total: 0 },
      'NƒÉng su·∫•t': { above: 0, total: 0 },
      'ƒê∆°n gi√°': { above: 0, total: 0 }
  };
  
  // State qu·∫£n l√Ω hi·ªÉn th·ªã Modal
  let isEffModalOpen = false;
  let isMetricModalOpen = false;
  let itemToEdit = null;

  // [KH√îI PH·ª§C] Hai d√≤ng quan tr·ªçng b·ªã thi·∫øu g√¢y l·ªói ReferenceError
  $: totalAbove = Object.values(kpiCounts).reduce((sum, item) => sum + item.above, 0);
  $: totalCriteria = Object.values(kpiCounts).reduce((sum, item) => sum + item.total, 0);

  // Logic t·∫£i d·ªØ li·ªáu t·ª´ Cloud khi Warehouse thay ƒë·ªïi
  $: if ($selectedWarehouse) {
      loadMetricsFromCloud($selectedWarehouse);
  }

  async function loadMetricsFromCloud(kho) {
      const data = await datasyncService.loadCustomMetrics(kho);
      warehouseCustomMetrics.set(data);
  }

  // Reactive: T√≠nh to√°n l·∫°i khi Store metrics thay ƒë·ªïi HO·∫∂C employeeId thay ƒë·ªïi
  $: calculateEmployeeData(employeeId, $masterReportData, $warehouseCustomMetrics);

  function calculateEmployeeData(id, masterData, metrics) {
      if (!id || masterData.sknv.length === 0) return;

      const rawEmployee = masterData.sknv.find(e => String(e.maNV) === String(id));
      
      if (rawEmployee) {
          rawEmployeeData = rawEmployee;
          const deptAvg = sknvService.calculateDepartmentAverages(rawEmployee.boPhan, masterData.sknv);
          
          // T√≠nh to√°n c√°c ch·ªâ s·ªë custom (L·∫•y t·ª´ Store)
          if(metrics && metrics.length > 0) {
              const departmentEmployees = masterData.sknv.filter(e => e.boPhan === rawEmployee.boPhan);
              metrics.forEach(m => {
                  let totalVal = 0;
                  let count = 0;
                  departmentEmployees.forEach(emp => {
                      totalVal += sknvService.calculateDynamicMetricValue(emp, m);
                      count++;
                  });
                  deptAvg[`custom_${m.id}`] = count > 0 ? totalVal / count : 0;
              });
          }

          // G√°n d·ªØ li·ªáu
          employeeData = rawEmployee;
          detailStats = sknvService.getDetailStats(rawEmployee, deptAvg, metrics);

          if (rawEmployee.qdc) {
              qdcData = Object.entries(rawEmployee.qdc)
                  .map(([id, val]) => ({ id, ...val }))
                  .filter(item => (item.sl || 0) > 0)
                  .sort((a, b) => b.dtqd - a.dtqd);
          } else { qdcData = []; }

          if (rawEmployee.doanhThuTheoNganhHang) {
              nganhHangData = Object.entries(rawEmployee.doanhThuTheoNganhHang)
                  .map(([name, val]) => ({ name, ...val }))
                  .filter(item => (item.revenue || 0) > 0)
                  .sort((a, b) => b.revenue - a.revenue);
          } else { nganhHangData = []; }
      }
  }

  function handleCountUpdate(event) {
      const { title, above, total } = event.detail;
      let key = title;
      if (title === 'Hi·ªáu qu·∫£') key = 'Hi·ªáu qu·∫£ khai th√°c'; 
      if (kpiCounts[key]) {
          kpiCounts[key] = { above, total };
          kpiCounts = { ...kpiCounts };
      }
  }

  function handleEditMetric(event) {
      const metricItem = event.detail;
      if (metricItem && metricItem.rawConfig) {
          itemToEdit = metricItem.rawConfig;
          if (metricItem.rawConfig.type === 'UNIT_PRICE') {
              isMetricModalOpen = true;
          } else {
              isEffModalOpen = true;
          }
      }
  }

  async function handleDeleteMetric(event) {
      const idToDelete = event.detail;
      if (confirm("B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a ch·ªâ s·ªë n√†y kh√¥ng?")) {
          // X√≥a kh·ªèi Store v√† Cloud
          const newMetrics = $warehouseCustomMetrics.filter(m => m.id !== idToDelete);
          warehouseCustomMetrics.set(newMetrics);
          
          if ($selectedWarehouse) {
              await datasyncService.saveCustomMetrics($selectedWarehouse, newMetrics);
          }
      }
  }

  async function handleSaveMetric(event) {
      const savedMetric = event.detail;
      let currentMetrics = [...$warehouseCustomMetrics]; 
      
      const existingIndex = currentMetrics.findIndex(m => m.id === savedMetric.id);
      
      if (existingIndex >= 0) {
          currentMetrics[existingIndex] = savedMetric;
      } else {
          currentMetrics = [...currentMetrics, savedMetric];
      }
      
      // C·∫≠p nh·∫≠t Store v√† L∆∞u Cloud
      warehouseCustomMetrics.set(currentMetrics);
      if ($selectedWarehouse) {
          await datasyncService.saveCustomMetrics($selectedWarehouse, currentMetrics);
      }
      
      itemToEdit = null;
  }

  function handleCloseModal() {
      isEffModalOpen = false;
      isMetricModalOpen = false;
      itemToEdit = null;
  }

  function goBack() { dispatch('back'); }

  afterUpdate(() => { if (window.feather) window.feather.replace(); });
</script>

<div class="animate-fade-in pb-10 max-w-7xl mx-auto">
    <div class="mb-4">
        <button on:click={goBack} class="text-blue-600 hover:underline font-semibold flex items-center gap-1">
           <i data-feather="chevron-left" class="w-4 h-4"></i> Quay l·∫°i b·∫£ng t·ªïng h·ª£p
        </button>
    </div>

    {#if employeeData}
        <DetailHeader employee={employeeData} {totalAbove} {totalCriteria} showStats={true} />

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-6 items-start">
            <div class="space-y-6">
                <MetricGrid 
                    title="Doanh thu" icon="trending-up" colorClass="sknv-header-blue" 
                    data={detailStats.doanhThu || []} 
                    on:updateCount={handleCountUpdate} 
                />
                
                <MetricGrid 
                    title="Hi·ªáu qu·∫£ khai th√°c" icon="award" colorClass="sknv-header-orange" 
                    data={detailStats.hieuQua || []} 
                    allowAdd={true}
                    on:add={() => { itemToEdit = null; isEffModalOpen = true; }} 
                    on:edit={handleEditMetric}
                    on:delete={handleDeleteMetric}
                    on:updateCount={handleCountUpdate} 
                />
            </div>
            <div class="space-y-6">
                <MetricGrid 
                    title="NƒÉng su·∫•t" icon="dollar-sign" colorClass="sknv-header-green" 
                    data={detailStats.nangSuat || []} 
                    on:updateCount={handleCountUpdate} 
                />
                
                <MetricGrid 
                    title="ƒê∆°n gi√°" icon="tag" colorClass="sknv-header-yellow" 
                    data={detailStats.donGia || []}
                    allowAdd={true}
                    on:add={() => { itemToEdit = null; isMetricModalOpen = true; }} 
                    on:edit={handleEditMetric}
                    on:delete={handleDeleteMetric}
                    on:updateCount={handleCountUpdate} 
                />
            </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-6 items-start">
            <DetailTableQDC data={qdcData} rawEmployee={rawEmployeeData} />
            <DetailTableCategory data={nganhHangData} rawEmployee={rawEmployeeData} />
        </div>

    {:else}
        <div class="p-12 text-center bg-red-50 rounded-lg border border-red-200">
            <p class="text-red-600 font-semibold">Kh√¥ng t√¨m th·∫•y d·ªØ li·ªáu cho nh√¢n vi√™n n√†y.</p>
        </div>
    {/if}
</div>

<AddEfficiencyColumnModal 
    isOpen={isEffModalOpen} 
    editItem={itemToEdit} 
    on:close={handleCloseModal}
    on:save={handleSaveMetric}
/>

<AddMetricModal
    isOpen={isMetricModalOpen}
    editItem={itemToEdit}
    on:close={handleCloseModal}
    on:save={handleSaveMetric}
/>

<style>
    :global(.sknv-header-blue) { background-color: #2563eb; }
    :global(.sknv-header-green) { background-color: #16a34a; }
    :global(.sknv-header-orange) { background-color: #f97316; }
    :global(.sknv-header-yellow) { background-color: #ca8a04; }
    .animate-fade-in { animation: fadeIn 0.3s ease-out; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
</style>

================================================================================
File: src/components/health-staff/detail/MetricGrid.svelte
================================================================================

<script>
  import { afterUpdate, createEventDispatcher } from 'svelte';
  import EvaluationBadge from '../shared/EvaluationBadge.svelte';
  import CardFilter from './CardFilter.svelte';

  export let title = '';
  export let icon = '';
  export let colorClass = 'sknv-header-blue';
  export let data = []; // Array of metrics { id, label, value, average, ... }
  export let allowAdd = false; 

  const dispatch = createEventDispatcher();

  let sortKey = 'label';
  let sortDirection = 'asc';
  
  // Tr·∫°ng th√°i hi·ªÉn th·ªã c·ª•c b·ªô
  let visibilityState = {};

  $: {
      if(data) {
          data.forEach(item => {
              if (visibilityState[item.id] === undefined) {
                  visibilityState[item.id] = true;
              }
          });
          calculateAndEmitCount();
      }
  }

  function handleSort(key) {
    if (sortKey === key) {
      sortDirection = sortDirection === 'desc' ? 'asc' : 'desc';
    } else {
      sortKey = key;
      sortDirection = 'asc';
    }
  }

  function handleFilterChange(event) {
      const id = event.detail;
      visibilityState[id] = !visibilityState[id];
      visibilityState = { ...visibilityState }; 
      calculateAndEmitCount();
  }

  function calculateAndEmitCount() {
      const visibleItems = data.filter(item => visibilityState[item.id] !== false);
      const aboveCount = visibleItems.filter(item => isAboveAverage(item.rawValue, item.rawAverage)).length;
      const totalCount = visibleItems.length;
      dispatch('updateCount', { title, above: aboveCount, total: totalCount });
  }

  function isAboveAverage(val, avg) {
      if (!isFinite(val) || avg === undefined || !isFinite(avg)) return false;
      return val >= avg;
  }

  $: sortedData = [...data]
      .filter(item => visibilityState[item.id] !== false)
      .sort((a, b) => {
          let valA, valB;
          if (sortKey === 'label') {
              valA = a.label || ''; valB = b.label || '';
              return sortDirection === 'asc' ? valA.localeCompare(valB) : valB.localeCompare(valA);
          } else if (sortKey === 'value') {
              valA = a.rawValue || 0; valB = b.rawValue || 0;
          } else {
              valA = a.rawAverage || 0; valB = b.rawAverage || 0;
          }
          return sortDirection === 'asc' ? valA - valB : valB - valA;
      });

  afterUpdate(() => {
      if (typeof feather !== 'undefined') feather.replace();
  });
</script>

<div class="bg-white rounded-xl shadow-md border border-gray-200 overflow-hidden h-full flex flex-col">
    <div class="sknv-detail-card-header {colorClass} flex justify-between items-center p-3 text-white">
        <div class="flex items-center gap-2">
            <i data-feather={icon} class="w-5 h-5"></i>
            <h4 class="text-lg font-bold">{title}</h4>
        </div>
        
        <div class="flex items-center gap-1">
            {#if allowAdd}
                <button 
                    class="text-white/80 hover:text-white hover:bg-white/20 p-1 rounded-full transition-colors"
                    title="Th√™m ch·ªâ s·ªë m·ªõi"
                    on:click={() => dispatch('add')}
                >
                    <i data-feather="plus" class="w-4 h-4"></i>
                </button>
            {/if}
            
            <CardFilter 
                items={data.map(i => ({ id: i.id, label: i.label, visible: visibilityState[i.id] !== false }))} 
                on:change={handleFilterChange} 
            />
        </div>
    </div>
    
    <div class="overflow-x-auto flex-grow">
        <table class="w-full text-sm">
            <thead class="bg-gray-50 border-b border-gray-200">
                <tr>
                    <th class="px-3 py-2 text-left font-semibold text-gray-600 cursor-pointer hover:bg-gray-100 select-none" on:click={() => handleSort('label')}>
                        Ch·ªâ s·ªë {sortKey==='label' ? (sortDirection==='asc' ? '‚ñ≤' : '‚ñº') : ''}
                    </th>
                    <th class="px-3 py-2 text-right font-semibold text-gray-600 cursor-pointer hover:bg-gray-100 select-none" on:click={() => handleSort('value')}>
                        Th·ª±c hi·ªán {sortKey==='value' ? (sortDirection==='asc' ? '‚ñ≤' : '‚ñº') : ''}
                    </th>
                    <th class="px-3 py-2 text-right font-semibold text-gray-600 cursor-pointer hover:bg-gray-100 select-none" on:click={() => handleSort('average')}>
                        Trung b√¨nh {sortKey==='average' ? (sortDirection==='asc' ? '‚ñ≤' : '‚ñº') : ''}
                    </th>
                    <th class="px-3 py-2 text-right font-semibold text-gray-600">ƒê√°nh gi√°</th>
                </tr>
            </thead>
            <tbody class="divide-y divide-gray-100">
                {#if sortedData.length === 0}
                    <tr><td colspan="4" class="p-4 text-center text-gray-400 italic text-xs">ƒê√£ ·∫©n t·∫•t c·∫£ ch·ªâ s·ªë.</td></tr>
                {:else}
                    {#each sortedData as row (row.id)}
                        <tr class="hover:bg-slate-50 transition-colors group/row">
                            <td class="px-3 py-2 font-medium text-gray-700 flex items-center gap-1">
                                {row.label}
                                {#if row.isCustom}
                                    <span class="text-[10px] px-1.5 py-0.5 rounded bg-blue-100 text-blue-700 font-bold whitespace-nowrap">M·ªõi</span>
                                    <div class="flex gap-1 ml-2 opacity-0 group-hover/row:opacity-100 transition-opacity">
                                        <button 
                                            class="p-1 text-gray-400 hover:text-blue-600 rounded hover:bg-blue-50" 
                                            title="S·ª≠a"
                                            on:click|stopPropagation={() => dispatch('edit', row)}
                                        >
                                            <i data-feather="edit-2" class="w-3 h-3"></i>
                                        </button>
                                        <button 
                                            class="p-1 text-gray-400 hover:text-red-600 rounded hover:bg-red-50" 
                                            title="X√≥a"
                                            on:click|stopPropagation={() => dispatch('delete', row.id)}
                                        >
                                            <i data-feather="trash-2" class="w-3 h-3"></i>
                                        </button>
                                    </div>
                                {/if}
                            </td>
                            <td class="px-3 py-2 text-right font-bold text-gray-900 {row.valueClass || ''}">{row.value}</td>
                            <td class="px-3 py-2 text-right text-gray-500 italic">{row.average}</td>
                            <td class="px-3 py-2 text-right">
                                <EvaluationBadge isAbove={isAboveAverage(row.rawValue, row.rawAverage)} />
                            </td>
                        </tr>
                    {/each}
                {/if}
            </tbody>
        </table>
    </div>
</div>

================================================================================
File: src/components/health-staff/performance/DynamicPerformanceTable.svelte
================================================================================

<script>
    import { createEventDispatcher } from 'svelte';
    import { formatters } from '../../../utils/formatters.js';
    import { dynamicTableProcessor } from '../../../services/processing/logic/dynamicTable.processor.js';
    import { isAdmin } from '../../../stores.js';
    
    // Components
    import SortableTh from '../../common/SortableTh.svelte';

    export let config = {};      // C·∫•u h√¨nh b·∫£ng (t·ª´ Admin/User)
    export let reportData = [];  // D·ªØ li·ªáu nh√¢n vi√™n (Master Data)
    export let colorTheme = 'blue';

    const dispatch = createEventDispatcher();

    // --- STATE ---
    let sortKey = 'hoTen';
    let sortDirection = 'asc';

    // --- PROCESSING ---
    // 1. Bi·∫øn ƒë·ªïi d·ªØ li·ªáu th√¥ -> D·ªØ li·ªáu hi·ªÉn th·ªã (k√®m logic t√≠nh %)
    $: processedResult = dynamicTableProcessor.processTableData(reportData, config);
    $: tableData = processedResult.processedData;
    $: totals = processedResult.totals;

    // 2. S·∫Øp x·∫øp
    $: sortedData = dynamicTableProcessor.sortTableData(tableData, sortKey, sortDirection);

    // --- HANDLERS ---
    function handleSort(event) {
        const key = event.detail;
        if (sortKey === key) sortDirection = sortDirection === 'desc' ? 'asc' : 'desc';
        else { sortKey = key; sortDirection = 'desc'; }
    }

    // --- STYLING HELPERS ---
    const themeMap = {
        blue: { header: 'bg-blue-50 border-blue-200', title: 'text-blue-800' },
        green: { header: 'bg-green-50 border-green-200', title: 'text-green-800' },
        orange: { header: 'bg-orange-50 border-orange-200', title: 'text-orange-800' },
        purple: { header: 'bg-purple-50 border-purple-200', title: 'text-purple-800' },
        teal: { header: 'bg-teal-50 border-teal-200', title: 'text-teal-800' },
    };
    $: theme = themeMap[colorTheme] || themeMap.blue;

    // H√†m l·∫•y m√†u s·∫Øc cho gi√° tr·ªã (So s√°nh v·ªõi Target n·∫øu l√† %)
    function getValueColor(cell, targetObj) {
        if (cell.config.type === 'PERCENT') {
            // L·∫•y target t·ª´ config b·∫£ng ho·∫∑c goal settings (n·∫øu c√≥ logic override)
            // ·ªû ƒë√¢y ta d√πng targetId ƒë·ªÉ map v√†o object mucTieu c·ªßa nh√¢n vi√™n
            const targetId = cell.config.targetId;
            const targetVal = targetId && targetObj && targetObj[targetId] 
                ? parseFloat(targetObj[targetId]) 
                : 0;

            const currentVal = cell.value * 100; // ƒê∆∞a v·ªÅ thang 100
            
            if (targetVal > 0) {
                return currentVal >= targetVal ? 'text-blue-600 font-bold' : 'text-red-600 font-bold bg-red-50';
            }
            return 'text-red-600'; // M·∫∑c ƒë·ªãnh % l√† m√†u ƒë·ªè (ho·∫∑c cam)
        }
        if (cell.config.type === 'SL') return 'text-gray-800';
        return 'text-blue-700 font-semibold'; // DT, DTQD
    }
</script>

<div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden h-full flex flex-col transition-all hover:shadow-md relative group/card">
    
    <div class="absolute top-3 right-3 opacity-0 group-hover/card:opacity-100 transition-opacity flex gap-1 z-20 bg-white/90 backdrop-blur rounded-lg p-1 shadow-sm border border-gray-100">
        {#if !config.isSystem || $isAdmin}
            <button class="p-1.5 text-gray-400 hover:text-blue-600 rounded hover:bg-blue-50" title="S·ª≠a" on:click|stopPropagation={() => dispatch('edit', config)}>
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" /></svg>
            </button>
            <button class="p-1.5 text-gray-400 hover:text-red-600 rounded hover:bg-red-50" title="X√≥a" on:click|stopPropagation={() => dispatch('delete', config.id)}>
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
            </button>
        {/if}
    </div>

    <div class="px-5 py-3 border-b {theme.header} flex justify-between items-center">
        <h4 class="text-base font-bold uppercase {theme.title} truncate flex items-center gap-2" title={config.title}>
            <i data-feather="bar-chart-2" class="w-4 h-4"></i> {config.title}
        </h4>
    </div>

    {#if sortedData.length === 0}
        <div class="flex-grow flex items-center justify-center p-8 bg-slate-50/30">
             <p class="text-gray-400 italic text-sm">Ch∆∞a c√≥ ph√°t sinh d·ªØ li·ªáu.</p>
        </div>
    {:else}
        <div class="overflow-x-auto flex-grow custom-scrollbar relative">
            <table class="min-w-full text-sm border-collapse border-0">
                <thead class="bg-gray-50 text-xs uppercase text-gray-600 font-bold sticky top-0 z-20 shadow-sm">
                    <tr>
                        <SortableTh 
                            key="hoTen" 
                            label="Nh√¢n vi√™n" 
                            className="sticky left-0 z-30 bg-gray-100 border-r border-b border-gray-300 min-w-[150px]" 
                            {sortKey} {sortDirection} 
                            on:sort={handleSort} 
                        />
                        
                        {#each config.columns as col (col.id)}
                            {@const bgClass = col.color ? `bg-${col.color}-50` : 'bg-gray-50'}
                            {@const textClass = col.color ? `text-${col.color}-800` : 'text-gray-700'}
                            <SortableTh 
                                key={col.id} 
                                label={col.header} 
                                align="right" 
                                className="{bgClass} {textClass} border-r border-b border-gray-200 min-w-[100px]" 
                                {sortKey} {sortDirection} 
                                on:sort={handleSort} 
                            />
                        {/each}
                    </tr>
                </thead>

                <tbody class="divide-y divide-gray-100">
                    {#each sortedData as row (row.maNV)}
                        <tr class="hover:bg-blue-50/50 transition-colors group">
                            <td class="px-3 py-2 font-semibold text-gray-700 border-r border-b border-gray-300 bg-white group-hover:bg-blue-50/50 sticky left-0 z-10 whitespace-nowrap shadow-[2px_0_5px_-2px_rgba(0,0,0,0.05)]">
                                <span class="text-blue-700 text-sm block truncate" title="{row.hoTen} - {row.maNV}">
                                    {formatters.getShortEmployeeName(row.hoTen, row.maNV)}
                                </span>
                            </td>

                            {#each config.columns as col (col.id)}
                                {@const cell = row.cells[col.id]}
                                <td class="px-2 py-2 text-right border-r border-gray-200 border-b {getValueColor(cell, row.mucTieu)}">
                                    {cell ? cell.display : '-'}
                                </td>
                            {/each}
                        </tr>
                    {/each}
                </tbody>

                <tfoot class="bg-gray-100 font-bold text-gray-800 border-t-2 border-gray-300 sticky bottom-0 z-20">
                    <tr>
                        <td class="px-3 py-2 sticky left-0 bg-gray-200 z-30 border-r border-gray-300">T·ªîNG</td>
                        {#each config.columns as col (col.id)}
                            <td class="px-2 py-2 text-right border-r border-gray-300 bg-gray-100">
                                {totals.cells[col.id]?.display || '-'}
                            </td>
                        {/each}
                    </tr>
                </tfoot>
            </table>
        </div>
    {/if}
</div>

<style>
    .custom-scrollbar::-webkit-scrollbar { width: 6px; height: 6px; }
    .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
    .custom-scrollbar::-webkit-scrollbar-thumb { background: #e5e7eb; border-radius: 3px; }
    .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #d1d5db; }
</style>

================================================================================
File: src/components/health-staff/performance/PerformanceView.svelte
================================================================================

<script>
    import { onMount } from 'svelte';
    import { customPerformanceTables, isAdmin, modalState, selectedWarehouse } from '../../../stores.js';
    import { adminService } from '../../../services/admin.service.js';
    import { datasyncService } from '../../../services/datasync.service.js';
    
    import DynamicPerformanceTable from './DynamicPerformanceTable.svelte';

    export let reportData = [];

    // [FIX 1] M·∫∑c ƒë·ªãnh l√† ƒëang t·∫£i ƒë·ªÉ tr√°nh hi·ªán th√¥ng b√°o l·ªói ngay khi m·ªü
    let isLoading = true;
    let lastLoadedWarehouse = '';

    // --- LOGIC LOAD D·ªÆ LI·ªÜU ---
    $: if ($selectedWarehouse) {
        handleWarehouseDataLoad($selectedWarehouse);
    }

    async function handleWarehouseDataLoad(kho) {
        // CASE 1: Store First - N·∫øu ƒë√£ c√≥ data ƒë√∫ng kho, kh√¥ng t·∫£i l·∫°i
        if ($customPerformanceTables.length > 0 && lastLoadedWarehouse === kho) {
             console.log(`[PerformanceView] D√πng Cache Store cho kho: ${kho}`);
             isLoading = false; // [FIX] T·∫Øt loading n·∫øu d√πng cache
             return;
        }
        // CASE 2: Fetch
        await loadData(kho);
    }

    async function loadData(kho) {
        isLoading = true; // [FIX] Lu√¥n b·∫≠t loading khi b·∫Øt ƒë·∫ßu t·∫£i
        try {
            // 1. Load System Tables (Admin)
            const sysTables = await adminService.loadSystemPerformanceTables();
            // 2. Load Personal Tables (User)
            const perTables = await datasyncService.loadPersonalPerformanceTables(kho);
            // 3. Load tr·∫°ng th√°i ·∫©n/hi·ªán local
            const hiddenIds = JSON.parse(localStorage.getItem('hiddenPerformanceTableIds') || '[]');
            // 4. Merge
            const merged = [
                ...sysTables.map(t => ({ ...t, isSystem: true, isVisible: !hiddenIds.includes(t.id) })),
                ...perTables.map(t => ({ ...t, isSystem: false, isVisible: true }))
            ];
            customPerformanceTables.set(merged);
            lastLoadedWarehouse = kho;

        } catch (e) {
            console.error("[PerformanceView] L·ªói t·∫£i d·ªØ li·ªáu:", e);
        } finally {
            isLoading = false; // [FIX] ƒê·∫£m b·∫£o lu√¥n t·∫Øt loading khi xong
        }
    }

    // --- VISIBILITY LOGIC ---
    function toggleTableVisibility(tableId) {
        customPerformanceTables.update(items => {
            const newItems = items.map(t => t.id === tableId ? { ...t, isVisible: !t.isVisible } : t);
            
            // Save preference for System tables
            const hiddenIds = newItems.filter(t => t.isSystem && !t.isVisible).map(t => t.id);
            localStorage.setItem('hiddenPerformanceTableIds', JSON.stringify(hiddenIds));
            
            return newItems;
        });
    }

    // --- CRUD ACTIONS ---
    function openAddModal() {
        if (!$selectedWarehouse) return alert("Vui l√≤ng ch·ªçn Kho tr∆∞·ªõc.");
        // M·ªü modal t·∫°o m·ªõi (User context)
        modalState.update(s => ({ ...s, activeModal: 'add-performance-table-modal', payload: null, isSystem: false }));
    }

    function editTable(table) {
        // Check quy·ªÅn
        if (table.isSystem && !$isAdmin) return alert("B·∫°n kh√¥ng c√≥ quy·ªÅn s·ª≠a b·∫£ng h·ªá th·ªëng.");
        modalState.update(s => ({ 
            ...s, 
            activeModal: 'add-performance-table-modal', 
            payload: table,
            isSystem: table.isSystem 
        }));
    }

    async function deleteTable(id) {
        const table = $customPerformanceTables.find(t => t.id === id);
        if (!table) return;

        if (table.isSystem) {
            if (!$isAdmin) return alert("B·∫°n kh√¥ng c√≥ quy·ªÅn x√≥a b·∫£ng h·ªá th·ªëng.");
            if (!confirm("X√≥a vƒ©nh vi·ªÖn b·∫£ng h·ªá th·ªëng n√†y?")) return;
            const newTables = $customPerformanceTables.filter(t => t.id !== id && t.isSystem);
            await adminService.saveSystemPerformanceTables(newTables);
        } else {
            if (!confirm("X√≥a b·∫£ng c√° nh√¢n n√†y?")) return;
            const newTables = $customPerformanceTables.filter(t => t.id !== id && !t.isSystem);
            await datasyncService.savePersonalPerformanceTables($selectedWarehouse, newTables);
        }
        // Reload local store
        customPerformanceTables.update(items => items.filter(t => t.id !== id));
    }

    $: visibleTables = $customPerformanceTables.filter(t => t.isVisible);
    const colors = ['blue', 'green', 'orange', 'purple', 'teal'];
</script>

{#if isLoading}
    <div class="flex flex-col items-center justify-center p-12 text-teal-600">
        <svg class="animate-spin h-8 w-8 mb-3" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
        </svg>
        <p class="text-sm font-semibold">ƒêang t·∫£i b·∫£ng hi·ªáu qu·∫£...</p>
    </div>
{:else}

    {#if $customPerformanceTables.length > 0}
        <div class="mb-6 flex flex-wrap items-center gap-2 bg-white p-3 rounded-xl border border-gray-200 shadow-sm">
            <div class="text-xs font-bold uppercase text-gray-500 mr-2 flex items-center gap-1">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01" /></svg>
                B·∫£ng hi·ªÉn th·ªã:
            </div>
            
            {#each $customPerformanceTables as table}
                <button 
                    class="px-3 py-1.5 rounded-full text-xs font-medium border transition-all duration-200 flex items-center gap-1.5 select-none
                    {table.isVisible ?
                        'bg-blue-600 text-white border-blue-600 shadow-md transform -translate-y-0.5' : 'bg-gray-100 text-gray-500 border-gray-200 hover:bg-gray-200'}
                    {table.isSystem ?
                        'border-dashed' : ''}"
                    on:click={() => toggleTableVisibility(table.id)}
                    title={table.isSystem ? "B·∫£ng h·ªá th·ªëng" : "B·∫£ng c√° nh√¢n"}
                >
                    {#if table.isSystem}<span class="text-[10px] opacity-70">üåê</span>{/if}
                    {table.title}
                </button>
            {/each}

            <button 
                class="px-3 py-1.5 rounded-full text-xs font-bold border border-dashed border-gray-300 text-gray-500 hover:text-blue-600 hover:border-blue-400 hover:bg-blue-50 transition-colors ml-auto flex items-center gap-1"
                on:click={openAddModal}
            >
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" /></svg>
                T·∫°o b·∫£ng m·ªõi
            </button>
        </div>
    {/if}

    {#if $customPerformanceTables.length === 0}
        <div class="p-12 text-center bg-white rounded-xl border border-blue-100 shadow-sm flex flex-col items-center">
            <div class="w-16 h-16 bg-blue-50 rounded-full flex items-center justify-center mb-4 text-blue-500">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" /></svg>
            </div>
            <h4 class="text-lg font-bold text-gray-800 mb-2">Ch∆∞a c√≥ B·∫£ng hi·ªáu qu·∫£ n√†o</h4>
            <p class="text-gray-500 mb-6 max-w-md">B·∫°n ch∆∞a t·∫°o b·∫£ng theo d√µi n√†o.</p>
            <button class="px-6 py-2.5 bg-blue-600 text-white rounded-lg font-bold hover:bg-blue-700 shadow-md flex items-center gap-2" on:click={openAddModal}>
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" /></svg>
                T·∫°o b·∫£ng ngay
            </button>
        </div>
    {:else if visibleTables.length === 0}
        <div class="p-12 text-center bg-gray-50 rounded-xl border border-gray-200 border-dashed">
             <p class="text-gray-500 font-medium">B·∫°n ƒë√£ ·∫©n t·∫•t c·∫£ c√°c b·∫£ng. Vui l√≤ng b·∫≠t l·∫°i tr√™n thanh c√¥ng c·ª•.</p>
        </div>
    {:else}
        <div class="grid grid-cols-1 xl:grid-cols-2 gap-6 pb-10">
            {#each visibleTables as table, index (table.id)}
                <div data-capture-group="performance-table">
                    <DynamicPerformanceTable 
                        config={table} 
                        {reportData} 
                        colorTheme={colors[index % colors.length]}
                        on:edit={() => editTable(table)}
                        on:delete={() => deleteTable(table.id)}
                    />
                </div>
            {/each}
        </div>
    {/if}

{/if}

================================================================================
File: src/components/health-staff/revenue/DailyPerfChart.svelte
================================================================================

<script>
  import { onMount, afterUpdate } from 'svelte';
  import { formatters } from '../../../utils/formatters.js';
  
  export let dailyStats = []; // D·ªØ li·ªáu: [{ date, revenue, convertedRevenue }]

  let chartInstanceDTQD;
  let chartInstanceTLQD;
  let filterDays = 7; // M·∫∑c ƒë·ªãnh 7 ng√†y

  // L·ªçc d·ªØ li·ªáu d·ª±a tr√™n s·ªë ng√†y
  $: filteredData = filterDays === 'all' 
      ? dailyStats 
      : dailyStats.slice(-filterDays);

  $: labels = filteredData.map(d => new Date(d.date).toLocaleDateString('vi-VN', { day: '2-digit', month: '2-digit' }));
  $: dtqdData = filteredData.map(d => d.convertedRevenue / 1000000);
  $: tlqdData = filteredData.map(d => (d.revenue > 0 ? (d.convertedRevenue / d.revenue) - 1 : 0));

  const chartOptions = (title, isPercent = false) => ({
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
          legend: { display: false },
          tooltip: {
              callbacks: {
                  label: (context) => {
                      const val = context.raw;
                      return isPercent ? formatters.formatPercentage(val) : `${formatters.formatRevenue(val * 1000000)} Tr`;
                  }
              }
          },
          datalabels: {
              anchor: 'end', align: 'end',
              formatter: (val) => isPercent ? formatters.formatPercentage(val) : formatters.formatRevenue(val * 1000000),
              color: '#4b5563', font: { weight: 'bold', size: 10 }
          }
      },
      scales: { y: { beginAtZero: true, grace: '10%' } }
  });

  function renderCharts() {
      if (typeof Chart === 'undefined') return;

      // 1. Bi·ªÉu ƒë·ªì DTQƒê
      const ctxDTQD = document.getElementById('daily-dtqd-chart');
      if (ctxDTQD) {
          if (chartInstanceDTQD) chartInstanceDTQD.destroy();
          chartInstanceDTQD = new Chart(ctxDTQD, {
              type: 'bar',
              data: {
                  labels: labels,
                  datasets: [{ label: 'DTQƒê', data: dtqdData, backgroundColor: '#3b82f6', borderRadius: 4 }]
              },
              options: chartOptions('Doanh thu Qƒê', false),
              plugins: [ChartDataLabels]
          });
      }

      // 2. Bi·ªÉu ƒë·ªì T·ª∑ l·ªá Qƒê
      const ctxTLQD = document.getElementById('daily-tlqd-chart');
      if (ctxTLQD) {
          if (chartInstanceTLQD) chartInstanceTLQD.destroy();
          chartInstanceTLQD = new Chart(ctxTLQD, {
              type: 'bar',
              data: {
                  labels: labels,
                  datasets: [{ label: 'T·ª∑ l·ªá', data: tlqdData, backgroundColor: '#16a34a', borderRadius: 4 }]
              },
              options: chartOptions('T·ª∑ l·ªá Qƒê', true),
              plugins: [ChartDataLabels]
          });
      }
  }

  // Render l·∫°i khi d·ªØ li·ªáu thay ƒë·ªïi
  $: if (filteredData.length > 0) {
      // D√πng setTimeout ƒë·ªÉ ƒë·ª£i DOM c·∫≠p nh·∫≠t xong canvas
      setTimeout(renderCharts, 0);
  }

  function setFilter(days) {
      filterDays = days;
  }
</script>

<div class="mb-6">
    <div class="flex items-center justify-center flex-wrap gap-2 mb-4">
        <span class="text-sm font-medium text-gray-600">Xem theo:</span>
        {#each [3, 5, 7, 10, 'all'] as days}
            <button 
                class="px-3 py-1 text-xs font-medium rounded-full transition-colors 
                       {filterDays === days ? 'bg-blue-600 text-white' : 'bg-gray-200 text-gray-700 hover:bg-gray-300'}"
                on:click={() => setFilter(days)}
            >
                {days === 'all' ? 'T·∫•t c·∫£' : `${days} ng√†y`}
            </button>
        {/each}
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <div class="bg-white p-4 rounded-lg shadow-md border h-[300px]">
            <h4 class="text-md font-bold text-gray-700 mb-2 text-center">Doanh thu Qƒê theo ng√†y (Tr)</h4>
            <div class="relative h-[240px] w-full">
                <canvas id="daily-dtqd-chart"></canvas>
            </div>
        </div>
        <div class="bg-white p-4 rounded-lg shadow-md border h-[300px]">
            <h4 class="text-md font-bold text-gray-700 mb-2 text-center">T·ª∑ l·ªá Qƒê theo ng√†y</h4>
            <div class="relative h-[240px] w-full">
                <canvas id="daily-tlqd-chart"></canvas>
            </div>
        </div>
    </div>
</div>

================================================================================
File: src/components/health-staff/revenue/DynamicTableHeader.svelte
================================================================================

<script>
    import { createEventDispatcher } from 'svelte';
    import SortableTh from '../../common/SortableTh.svelte';

    export let config = {};
    export let tableMetrics = {};
    export let totalColSpan = 0;
    export let sortKey = '';
    export let sortDirection = 'desc';

    const dispatch = createEventDispatcher();

    // Helper m√†u s·∫Øc header ph·ª•
    const getSubHeaderColor = (index) => {
        const colors = [
            'bg-indigo-100 text-indigo-900 border-indigo-200', 
            'bg-emerald-100 text-emerald-900 border-emerald-200', 
            'bg-amber-100 text-amber-900 border-amber-200', 
            'bg-rose-100 text-rose-900 border-rose-200', 
            'bg-cyan-100 text-cyan-900 border-cyan-200'
        ];
        return colors[index % colors.length];
    };

    function handleSort(event) {
        dispatch('sort', event.detail);
    }

    function handleManualSort(key) {
        dispatch('manualSort', key);
    }
</script>

<thead class="bg-gray-50 text-xs uppercase text-gray-600 font-bold sticky top-0 z-20 shadow-sm">
    <tr>
        <th 
            class="px-4 py-2 pl-5 min-w-[180px] sticky left-0 z-30 bg-gray-100 border-r border-b border-gray-300 shadow-[2px_0_5px_-2px_rgba(0,0,0,0.1)] cursor-pointer hover:bg-gray-200 transition select-none text-left"
            rowspan="2"
            on:click={() => handleManualSort('hoTen')}
        >
            <div class="flex items-center gap-1 justify-start">
                <span class="font-bold uppercase text-xs {sortKey === 'hoTen' ? 'text-blue-800' : 'text-slate-700'}">Nh√¢n vi√™n</span>
                <span class="flex flex-col items-center justify-center w-4 h-4">
                    {#if sortKey !== 'hoTen'}
                        <svg xmlns="http://www.w3.org/2000/svg" class="w-3 h-3 text-gray-400 opacity-50" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M7 16V4m0 0L3 8m4-4l4 4m6 0v12m0 0l4-4m-4 4l-4-4" /></svg>
                    {:else if sortDirection === 'asc'}
                        <svg xmlns="http://www.w3.org/2000/svg" class="w-3.5 h-3.5 text-blue-700" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="3"><path stroke-linecap="round" stroke-linejoin="round" d="M5 15l7-7 7 7" /></svg>
                    {:else}
                        <svg xmlns="http://www.w3.org/2000/svg" class="w-3.5 h-3.5 text-blue-700" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="3"><path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7" /></svg>
                    {/if}
                </span>
            </div>
        </th>
        
        {#if totalColSpan > 0}
            <th colspan={totalColSpan} class="px-2 py-2 text-center border-b border-r border-gray-300 text-gray-900 bg-gray-200">
                T·ªîNG H·ª¢P
            </th>
        {/if}

        {#each config.subColumns as col, index}
            {@const metrics = col.metrics || { sl: false, dt: true, dtqd: false }}
            {@const colSpan = (metrics.sl ? 1 : 0) + (metrics.dt ? 1 : 0) + (metrics.dtqd ? 1 : 0)}
            {#if colSpan > 0}
                <th colspan={colSpan} class="px-2 py-2 text-center border-b border-r border-gray-200 {getSubHeaderColor(index)}">
                    {col.header}
                </th>
            {/if}
        {/each}
    </tr>

    <tr>
        {#if tableMetrics.sl}
            <SortableTh key="totalSL" label="SL" align="right" className="min-w-[60px] text-gray-700 bg-gray-100 border-r border-gray-300 border-b" {sortKey} {sortDirection} on:sort={handleSort} />
        {/if}
        {#if tableMetrics.dt}
                <SortableTh key="mainValue" label="DT" align="right" className="min-w-[80px] text-blue-800 bg-gray-100 border-r border-gray-300 border-b" {sortKey} {sortDirection} on:sort={handleSort} />
        {/if}
        {#if tableMetrics.dtqd}
                <SortableTh key="totalDTQD" label="Qƒê" align="right" className="min-w-[80px] text-purple-800 bg-gray-100 border-r border-gray-300 border-b" {sortKey} {sortDirection} on:sort={handleSort} />
        {/if}

        {#each config.subColumns as col}
            {@const metrics = col.metrics || { sl: false, dt: true, dtqd: false }}
            {#if metrics.sl}
                <SortableTh key={`${col.header}|sl`} label="SL" align="right" className="min-w-[60px] text-gray-500 bg-white border-r border-gray-200 border-b" {sortKey} {sortDirection} on:sort={handleSort} />
            {/if}
            {#if metrics.dt}
                <SortableTh key={`${col.header}|dt`} label="DT" align="right" className="min-w-[80px] text-blue-600 bg-white border-r border-gray-200 border-b" {sortKey} {sortDirection} on:sort={handleSort} />
            {/if}
            {#if metrics.dtqd}
                <SortableTh key={`${col.header}|dtqd`} label="Qƒê" align="right" className="min-w-[80px] text-purple-600 bg-white border-r border-gray-200 border-b" {sortKey} {sortDirection} on:sort={handleSort} />
            {/if}
        {/each}
    </tr>
</thead>

================================================================================
File: src/components/health-staff/revenue/DynamicTableRow.svelte
================================================================================

<script>
    import { formatters } from '../../../utils/formatters.js';

    export let item = {}; // D·ªØ li·ªáu 1 d√≤ng (ƒë√£ processed)
    export let config = {};
    export let tableMetrics = {}; // { sl, dt, dtqd }

    // T√≠nh to√°n tr∆∞·ªõc ƒë·ªÉ tr√°nh logic trong template
    $: columns = config.subColumns || [];
</script>

<tr class="hover:bg-blue-50/50 transition-colors group">
    <td class="px-5 py-2 font-semibold text-gray-700 border-r border-b border-gray-300 bg-white group-hover:bg-blue-50/50 sticky left-0 z-10 whitespace-nowrap shadow-[2px_0_5px_-2px_rgba(0,0,0,0.05)]">
        <span class="text-blue-700">{formatters.getShortEmployeeName(item.hoTen, item.maNV)}</span>
    </td>
    
    {#if tableMetrics.sl}
        <td class="px-2 py-2 text-right font-bold text-gray-800 bg-gray-50/50 border-r border-gray-300 border-b">
            {formatters.formatNumber(item.cells?.mainValue?.value_sl || item.mainValue_sl)}
        </td>
    {/if}
    {#if tableMetrics.dt}
        <td class="px-2 py-2 text-right font-bold text-blue-800 bg-gray-50/50 border-r border-gray-300 border-b">
            {formatters.formatRevenue(item.cells?.mainValue?.value || item.mainValue)}
        </td>
    {/if}
    {#if tableMetrics.dtqd}
        <td class="px-2 py-2 text-right font-bold text-purple-800 bg-gray-50/50 border-r border-gray-300 border-b">
            {formatters.formatRevenue(item.cells?.mainValue?.value_dtqd || item.mainValue_dtqd)}
        </td>
    {/if}

    {#each columns as col}
        {@const cell = item.cells ? (item.cells[col.id] || item.cells[col.header]) : null}
        {@const metrics = col.metrics || { sl: false, dt: true, dtqd: false }}
        
        {#if metrics.sl}
            <td class="px-2 py-2 text-right border-r border-gray-200 border-b text-gray-600" title={cell?.tooltip}>
                {formatters.formatNumber(cell?.value_sl || cell?.sl)}
            </td>
        {/if}
        {#if metrics.dt}
            <td class="px-2 py-2 text-right border-r border-gray-200 border-b font-medium text-gray-800" title={cell?.tooltip}>
                {formatters.formatRevenue(cell?.value || cell?.dt)}
            </td>
        {/if}
        {#if metrics.dtqd}
            <td class="px-2 py-2 text-right border-r border-gray-200 border-b font-medium text-purple-600" title={cell?.tooltip}>
                {formatters.formatRevenue(cell?.value_dtqd || cell?.dtqd)}
            </td>
        {/if}
    {/each}
</tr>

================================================================================
File: src/components/health-staff/revenue/RevenueDetailView.svelte
================================================================================

<script>
  import { createEventDispatcher } from 'svelte';
  import { masterReportData, ycxData, modalState } from '../../../stores.js'; // [FIX] Import modalState
  import { reportService } from '../../../services/reportService.js';
  import { settingsService } from '../../../services/settings.service.js';
  import { formatters } from '../../../utils/formatters.js';
  
  import DetailHeader from '../detail/DetailHeader.svelte';
  import RevenueKpiBoard from './RevenueKpiBoard.svelte';
  import DailyPerfChart from './DailyPerfChart.svelte';
  import RevenueTopGroups from './RevenueTopGroups.svelte';

  export let employeeId;
  const dispatch = createEventDispatcher();

  let detailData = null;
  let employeeData = null;
  let goals = {};

  $: if (employeeId && $ycxData.length > 0) {
      employeeData = $masterReportData.sknv.find(e => String(e.maNV) === String(employeeId));

      if (employeeData) {
          const settings = settingsService.getLuykeGoalSettings(employeeData.maKho);
          goals = settings.goals || {};
          detailData = reportService.generateLuyKeEmployeeDetailReport(employeeId, $ycxData);
      }
  }

  function goBack() { dispatch('back'); }

  // [M·ªöI] H√†m x·ª≠ l√Ω m·ªü Modal
  function openUnexportedModal() {
      if (detailData && detailData.unexportedDetails) {
          modalState.update(s => ({ 
              ...s, 
              activeModal: 'unexported-detail-modal',
              payload: { unexportedDetails: detailData.unexportedDetails }
          }));
      }
  }

  function openOrdersModal() {
      if (detailData && detailData.byCustomer) {
          modalState.update(s => ({ 
              ...s, 
              activeModal: 'customer-detail-modal',
              payload: { 
                  customers: detailData.byCustomer,
                  mucTieu: employeeData.mucTieu
              }
          }));
      }
  }
</script>

<div class="animate-fade-in pb-10 max-w-7xl mx-auto">
    <div class="mb-4 flex justify-between items-center">
        <button on:click={goBack} class="text-blue-600 hover:underline font-semibold flex items-center gap-1">
            <i data-feather="chevron-left" class="w-4 h-4"></i> Quay l·∫°i b·∫£ng t·ªïng h·ª£p
        </button>
    </div>

    {#if employeeData && detailData}
        <DetailHeader employee={employeeData} showStats={false} />
        
        <RevenueKpiBoard 
            summary={detailData.summary} 
            {goals} 
            on:viewUnexported={openUnexportedModal}
            on:viewOrders={openOrdersModal}
        />
        
        <DailyPerfChart dailyStats={detailData.dailyStats} />
        
        <RevenueTopGroups 
            topProductGroups={detailData.topProductGroups} 
            categoryChartData={detailData.categoryChartData} 
        />

    {:else}
        <div class="p-12 text-center bg-red-50 rounded-lg border border-red-200">
            <p class="text-red-600 font-semibold">Kh√¥ng t√¨m th·∫•y d·ªØ li·ªáu chi ti·∫øt cho nh√¢n vi√™n n√†y.</p>
        </div>
    {/if}
</div>

<style>
    .animate-fade-in { animation: fadeIn 0.3s ease-out; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
</style>

================================================================================
File: src/components/health-staff/revenue/RevenueKpiBoard.svelte
================================================================================

<script>
  import { createEventDispatcher } from 'svelte';
  import { formatters } from '../../../utils/formatters.js';

  export let summary = {};
  export let goals = {};

  const dispatch = createEventDispatcher();

  // T√≠nh to√°n target
  $: targetQD = (goals?.phanTramQD || 0);
  $: isPositive = (summary.conversionRate * 100) >= targetQD;
</script>

<div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-4 mb-6">
    <div class="bg-white p-4 rounded-lg shadow border border-gray-100 text-center">
        <div class="text-sm text-gray-500 font-medium uppercase">T·ªïng DT Th·ª±c</div>
        <div class="text-xl font-bold text-blue-600 mt-1">{formatters.formatRevenue(summary.totalRealRevenue, 1)}</div>
    </div>

    <div class="bg-white p-4 rounded-lg shadow border border-gray-100 text-center">
        <div class="text-sm text-gray-500 font-medium uppercase">T·ªïng DTQƒê</div>
        <div class="text-xl font-bold text-purple-600 mt-1">{formatters.formatRevenue(summary.totalConvertedRevenue, 1)}</div>
    </div>

    <div class="bg-white p-4 rounded-lg shadow border border-gray-100 text-center">
        <div class="text-sm text-gray-500 font-medium uppercase">T·ª∑ l·ªá Qƒê</div>
        <div class="text-xl font-bold mt-1 {isPositive ? 'text-green-600' : 'text-red-600'}">
            {formatters.formatPercentage(summary.conversionRate)}
        </div>
    </div>

    <div 
        class="bg-white p-4 rounded-lg shadow border border-gray-100 text-center cursor-pointer hover:bg-yellow-50 transition-colors hover:shadow-md"
        on:click={() => dispatch('viewUnexported')}
    >
        <div class="text-sm text-gray-500 font-medium uppercase flex items-center justify-center gap-1">
            DT Ch∆∞a Xu·∫•t <i data-feather="external-link" class="w-3 h-3"></i>
        </div>
        <div class="text-xl font-bold text-yellow-600 mt-1">{formatters.formatRevenue(summary.unexportedRevenue, 1)}</div>
    </div>

    <div 
        class="bg-white p-4 rounded-lg shadow border border-gray-100 text-center cursor-pointer hover:bg-blue-50 transition-colors hover:shadow-md"
        on:click={() => dispatch('viewOrders')}
    >
        <div class="text-sm text-gray-500 font-medium uppercase flex items-center justify-center gap-1">
            T·ªïng ƒê∆°n <i data-feather="external-link" class="w-3 h-3"></i>
        </div>
        <div class="text-xl font-bold text-gray-800 mt-1">{summary.totalOrders}</div>
    </div>

    <div class="bg-white p-4 rounded-lg shadow border border-gray-100 text-center">
        <div class="text-sm text-gray-500 font-medium uppercase">ƒê∆°n B√°n K√®m</div>
        <div class="text-xl font-bold text-gray-800 mt-1">{summary.bundledOrderCount}</div>
    </div>
</div>

================================================================================
File: src/components/health-staff/revenue/RevenueTopGroups.svelte
================================================================================

<script>
  import { onMount } from 'svelte';
  import { formatters } from '../../../utils/formatters.js';
  import { getRandomBrightColor } from '../../../utils.js';

  export let topProductGroups = [];
  export let categoryChartData = [];

  let chartInstance;

  // 1. Top 5 Nh√≥m h√†ng
  $: top5Groups = topProductGroups.slice(0, 5);
  $: maxRevenue = top5Groups.length > 0 ? top5Groups[0].realRevenue : 0;

  // 2. Bi·ªÉu ƒë·ªì
  function renderPieChart() {
      const ctx = document.getElementById('revenue-category-chart');
      if (!ctx || !categoryChartData.length) return;

      if (chartInstance) chartInstance.destroy();

      // Sort v√† l·∫•y top 10 cho bi·ªÉu ƒë·ªì
      const sortedChartData = [...categoryChartData].sort((a, b) => b.revenue - a.revenue).slice(0, 10);

      chartInstance = new Chart(ctx, {
          type: 'bar',
          data: {
              labels: sortedChartData.map(d => d.name),
              datasets: [{
                  label: 'Doanh thu',
                  data: sortedChartData.map(d => d.revenue / 1000000),
                  backgroundColor: sortedChartData.map(() => getRandomBrightColor()),
                  borderRadius: 4,
              }]
          },
          options: {
              indexAxis: 'x',
              responsive: true,
              maintainAspectRatio: false,
              plugins: {
                  legend: { display: false },
                  tooltip: {
                      callbacks: { label: ctx => `${ctx.label}: ${formatters.formatRevenue(ctx.raw * 1000000)}` }
                  },
                  datalabels: {
                      anchor: 'end', align: 'end',
                      formatter: (val) => formatters.formatRevenue(val * 1000000),
                      color: '#4b5563', font: { weight: 'bold', size: 10 }
                  }
              },
              scales: { y: { beginAtZero: true, grace: '10%' } }
          },
          plugins: [ChartDataLabels]
      });
  }

  $: if (categoryChartData.length > 0) {
      setTimeout(renderPieChart, 0);
  }
</script>

<div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
    <div class="bg-white p-4 rounded-lg shadow-md border">
        <h4 class="text-md font-bold text-gray-700 border-b pb-2 mb-3">Top 5 Nh√≥m H√†ng Doanh Thu Cao</h4>
        {#if top5Groups.length === 0}
            <p class="text-sm text-gray-500">Kh√¥ng c√≥ d·ªØ li·ªáu.</p>
        {:else}
            <div class="space-y-4">
                {#each top5Groups as group}
                    {@const percent = maxRevenue > 0 ? (group.realRevenue / maxRevenue) * 100 : 0}
                    <div>
                        <div class="flex justify-between items-end mb-1">
                            <div>
                                <span class="font-semibold text-sm block">{group.name}</span>
                                <span class="text-xs text-gray-500">SL: {formatters.formatNumber(group.quantity)} | %Qƒê: {formatters.formatPercentage(group.conversionRate)}</span>
                            </div>
                            <div class="text-right">
                                <div class="text-sm font-bold text-gray-800">{formatters.formatRevenue(group.realRevenue)}</div>
                                <div class="text-xs text-blue-600 font-medium">{formatters.formatRevenue(group.convertedRevenue)} (Qƒê)</div>
                            </div>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-2">
                            <div class="bg-blue-600 h-2 rounded-full transition-all duration-500" style="width: {percent}%"></div>
                        </div>
                    </div>
                {/each}
            </div>
        {/if}
    </div>

    <div class="bg-white p-4 rounded-lg shadow-md border">
        <h4 class="text-md font-bold text-gray-700 mb-2">T·ª∑ Tr·ªçng Doanh Thu Ng√†nh H√†ng</h4>
        <div class="relative h-[300px] w-full">
            <canvas id="revenue-category-chart"></canvas>
        </div>
    </div>
</div>

================================================================================
File: src/components/health-staff/shared/EvaluationBadge.svelte
================================================================================

<script>
  export let isAbove = false;
</script>

<span class="px-2 py-0.5 rounded text-[10px] font-bold uppercase tracking-wide {isAbove ? 'bg-green-100 text-green-700' : 'bg-yellow-100 text-yellow-700'}">
  {isAbove ? 'Tr√™n TB' : 'D∆∞·ªõi TB'}
</span>

================================================================================
File: src/components/health-staff/shared/MedalIcon.svelte
================================================================================

<script>
  export let rank = 0; // 0: Base (Index + 1)

  // Logic m√†u s·∫Øc cho Top 3
  const isGold = rank === 1;
  const isSilver = rank === 2;
  const isBronze = rank === 3;
  const isStandard = rank > 3;
</script>

<div class="relative w-12 h-12 flex-shrink-0 -ml-2 -mt-2">
  {#if isGold}
    <svg viewBox="0 0 100 100" class="w-full h-full drop-shadow-sm absolute top-0 left-0 z-10">
        <defs><linearGradient id="gold-grad" x1="0%" y1="0%" x2="0%" y2="100%"><stop offset="0%" stop-color="#FFDF00"/><stop offset="100%" stop-color="#FFB800"/></linearGradient></defs>
        <path d="M 20 75 L 35 95 L 35 75 L 50 90 L 65 75 L 65 95 L 80 75 L 50 85 Z" fill="#E53935"/>
        <circle cx="50" cy="45" r="38" fill="#BDBDBD"/><circle cx="50" cy="45" r="35" fill="url(#gold-grad)"/>
        <circle cx="50" cy="45" r="28" fill="#FFC107" stroke="#FFFFFF" stroke-width="2"/>
    </svg>
  {:else if isSilver}
    <svg viewBox="0 0 100 100" class="w-full h-full drop-shadow-sm absolute top-0 left-0 z-10">
        <defs><linearGradient id="silver-grad" x1="0%" y1="0%" x2="0%" y2="100%"><stop offset="0%" stop-color="#F5F5F5"/><stop offset="100%" stop-color="#B0BEC5"/></linearGradient></defs>
        <path d="M 20 75 L 35 95 L 35 75 L 50 90 L 65 75 L 65 95 L 80 75 L 50 85 Z" fill="#E53935"/>
        <circle cx="50" cy="45" r="38" fill="#78909C"/><circle cx="50" cy="45" r="35" fill="url(#silver-grad)"/>
        <circle cx="50" cy="45" r="28" fill="#B0BEC5" stroke="#FFFFFF" stroke-width="2"/>
    </svg>
  {:else if isBronze}
    <svg viewBox="0 0 100 100" class="w-full h-full drop-shadow-sm absolute top-0 left-0 z-10">
        <defs><linearGradient id="bronze-grad" x1="0%" y1="0%" x2="0%" y2="100%"><stop offset="0%" stop-color="#FFCC80"/><stop offset="100%" stop-color="#D84315"/></linearGradient></defs>
        <path d="M 20 75 L 35 95 L 35 75 L 50 90 L 65 75 L 65 95 L 80 75 L 50 85 Z" fill="#E53935"/>
        <circle cx="50" cy="45" r="38" fill="#A1887F"/><circle cx="50" cy="45" r="35" fill="url(#bronze-grad)"/>
        <circle cx="50" cy="45" r="28" fill="#D84315" stroke="#FFFFFF" stroke-width="2"/>
    </svg>
  {:else}
    <div class="sknv-card__avatar--standard">
        <span class="sknv-card__avatar-rank">{rank}</span>
    </div>
  {/if}
  
  {#if !isStandard}
      <div class="absolute top-0 left-0 w-full h-[90%] flex items-center justify-center z-20">
        <span class="sknv-card__avatar-rank text-white text-lg font-bold">{rank}</span>
      </div>
  {/if}
</div>

================================================================================
File: src/components/health-staff/shared/UMedalIcon.svelte
================================================================================

<script>
  export let rank = 0; // 0: Base (Index + 1)

  // Logic m√†u s·∫Øc cho Top 3
  const isGold = rank === 1;
  const isSilver = rank === 2;
  const isBronze = rank === 3;
</script>

<div class="relative w-12 h-12 flex-shrink-0 -ml-2 -mt-2">
  {#if isGold}
    <svg viewBox="0 0 100 100" class="w-full h-full drop-shadow-sm">
        <defs><linearGradient id="gold-grad" x1="0%" y1="0%" x2="0%" y2="100%"><stop offset="0%" stop-color="#FFDF00"/><stop offset="100%" stop-color="#FFB800"/></linearGradient></defs>
        <path d="M 20 75 L 35 95 L 35 75 L 50 90 L 65 75 L 65 95 L 80 75 L 50 85 Z" fill="#E53935"/>
        <circle cx="50" cy="45" r="38" fill="#BDBDBD"/><circle cx="50" cy="45" r="35" fill="url(#gold-grad)"/>
        <circle cx="50" cy="45" r="28" fill="#FFC107" stroke="#FFFFFF" stroke-width="2"/>
    </svg>
  {:else if isSilver}
    <svg viewBox="0 0 100 100" class="w-full h-full drop-shadow-sm">
        <defs><linearGradient id="silver-grad" x1="0%" y1="0%" x2="0%" y2="100%"><stop offset="0%" stop-color="#F5F5F5"/><stop offset="100%" stop-color="#B0BEC5"/></linearGradient></defs>
        <path d="M 20 75 L 35 95 L 35 75 L 50 90 L 65 75 L 65 95 L 80 75 L 50 85 Z" fill="#E53935"/>
        <circle cx="50" cy="45" r="38" fill="#78909C"/><circle cx="50" cy="45" r="35" fill="url(#silver-grad)"/>
        <circle cx="50" cy="45" r="28" fill="#B0BEC5" stroke="#FFFFFF" stroke-width="2"/>
    </svg>
  {:else if isBronze}
    <svg viewBox="0 0 100 100" class="w-full h-full drop-shadow-sm">
        <defs><linearGradient id="bronze-grad" x1="0%" y1="0%" x2="0%" y2="100%"><stop offset="0%" stop-color="#FFCC80"/><stop offset="100%" stop-color="#D84315"/></linearGradient></defs>
        <path d="M 20 75 L 35 95 L 35 75 L 50 90 L 65 75 L 65 95 L 80 75 L 50 85 Z" fill="#E53935"/>
        <circle cx="50" cy="45" r="38" fill="#A1887F"/><circle cx="50" cy="45" r="35" fill="url(#bronze-grad)"/>
        <circle cx="50" cy="45" r="28" fill="#D84315" stroke="#FFFFFF" stroke-width="2"/>
    </svg>
  {:else}
    <div class="w-12 h-12 rounded-full bg-gray-200 flex items-center justify-center border-4 border-white shadow-sm">
        </div>
  {/if}
  
  <div class="absolute top-0 left-0 w-full h-[90%] flex items-center justify-center z-10">
    <span class="text-lg font-bold {rank <= 3 ? 'text-white' : 'text-gray-600'}">{rank}</span>
  </div>
</div>

================================================================================
File: src/components/health-staff/summary/DepartmentGroup.svelte
================================================================================

<script>
  import EmployeeCard from './card/EmployeeCard.svelte';
  
  export let departmentName;
  export let employees = [];
  
  // Priority styling cho "T∆∞ V·∫•n - ƒêM"
  $: isPriority = departmentName.includes('T∆∞ V·∫•n');
  $: headerClass = isPriority 
    ? 'bg-blue-50 text-blue-800 border-blue-200' 
    : 'bg-gray-50 text-gray-700 border-gray-200';
</script>

<div class="mb-8 last:mb-0">
  <div class="flex items-center gap-3 px-4 py-3 rounded-t-lg border-b-2 {headerClass}">
    <h3 class="text-lg font-bold uppercase tracking-wide">{departmentName}</h3>
    <span class="bg-white/50 px-2 py-0.5 rounded text-xs font-bold">{employees.length} NV</span>
  </div>
  
  <div class="p-4 bg-slate-50/30 border-x border-b border-gray-200 rounded-b-lg">
    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4">
      {#each employees as emp, index (emp.maNV)}
        <EmployeeCard employee={emp} rank={index + 1} on:click />
      {/each}
    </div>
  </div>
</div>

================================================================================
File: src/components/health-staff/summary/SummaryView.svelte
================================================================================

<script>
  import DepartmentGroup from './DepartmentGroup.svelte';
  
  // [FIX L·ªñI QUAN TR·ªåNG]
  // Sai: import { utils } from '../../../utils.js';
  // ƒê√∫ng: Import t·∫•t c·∫£ h√†m (*) v√† ƒë·∫∑t t√™n l√† 'utils'
  import * as utils from '../../../utils.js'; 
  
  export let reportData = [];

  // Gom nh√≥m nh√¢n vi√™n theo b·ªô ph·∫≠n
  $: groupedData = reportData.reduce((acc, item) => {
      const dept = item.boPhan || 'Kh√°c';
      if (!acc[dept]) acc[dept] = [];
      acc[dept].push(item);
      return acc;
  }, {});

  // S·∫Øp x·∫øp th·ª© t·ª± b·ªô ph·∫≠n (∆Øu ti√™n T∆∞ V·∫•n)
  // H√†m n√†y n·∫±m trong utils.js, gi·ªù g·ªçi qua namespace 'utils' s·∫Ω ho·∫°t ƒë·ªông
  $: departmentOrder = utils.getSortedDepartmentList(reportData);
</script>

<div class="animate-fade-in pb-10">
  {#if reportData.length === 0}
    <div class="p-12 text-center bg-gray-50 rounded-lg border border-gray-200">
      <p class="text-gray-500">Kh√¥ng c√≥ d·ªØ li·ªáu hi·ªáu su·∫•t ƒë·ªÉ hi·ªÉn th·ªã.</p>
    </div>
  {:else}
    {#each departmentOrder as deptName}
      {#if groupedData[deptName]}
        {@const sortedEmployees = [...groupedData[deptName]].sort((a, b) => b.totalAbove - a.totalAbove)}
        <DepartmentGroup 
          departmentName={deptName} 
          employees={sortedEmployees} 
          on:click 
        />
      {/if}
    {/each}
  {/if}
</div>

<style>
  .animate-fade-in { animation: fadeIn 0.5s ease-out; }
  @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
</style>

================================================================================
File: src/components/health-staff/summary/card/CardHeader.svelte
================================================================================

<script>
  import { formatters } from '../../../../utils/formatters.js';
  export let hoTen;
  export let maNV;
  export let boPhan;
  export let rank = 999; // [M·ªöI] Nh·∫≠n rank ƒë·ªÉ check Top 3

  // Logic m√†u t√™n: Top 3 m√†u xanh d∆∞∆°ng ƒë·∫≠m, c√≤n l·∫°i m√†u ƒëen x√°m
  $: nameColorClass = rank <= 3 ? 'text-blue-700 font-extrabold' : 'text-gray-900 font-bold';
</script>

<div class="flex-grow min-w-0 ml-3">
  <p class="{nameColorClass} text-base truncate leading-tight" title="{hoTen} - {maNV}">
    {formatters.getShortEmployeeName(hoTen, maNV)}
  </p>
  <p class="text-xs text-gray-500 truncate">{boPhan}</p>
</div>

================================================================================
File: src/components/health-staff/summary/card/CardMainKpi.svelte
================================================================================

<script>
  export let aboveCount = 0;
  export let totalCount = 0;

  $: percentage = totalCount > 0 ? aboveCount / totalCount : 0;
  $: colorClass = percentage >= 0.7 ? 'text-green-600' : percentage >= 0.4 ? 'text-yellow-500' : 'text-red-500';
  $: borderColorClass = percentage >= 0.7 ? 'border-t-green-500' : percentage >= 0.4 ? 'border-t-yellow-500' : 'border-t-red-500';
</script>

<div class="text-center py-2 border-t-4 {borderColorClass} bg-slate-50/50 mt-2">
  <div class="flex items-baseline justify-center gap-1">
    <span class="text-3xl font-extrabold {colorClass} leading-none">{aboveCount}</span>
    <span class="text-sm font-bold text-gray-400">/ {totalCount}</span>
  </div>
  <span class="text-[10px] uppercase font-bold text-gray-500 tracking-wider">Ch·ªâ s·ªë ƒë·∫°t</span>
</div>

================================================================================
File: src/components/health-staff/summary/card/CardSubKpiGrid.svelte
================================================================================

<script>
  export let summary; 

  // ƒê·ªãnh nghƒ©a m√†u n·ªÅn c·ªë ƒë·ªãnh cho t·ª´ng lo·∫°i th·∫ª (Style ƒë·ªìng b·ªô)
  const groups = [
    { key: 'doanhthu', label: 'Doanh Thu', icon: 'trending-up', bgClass: 'bg-blue-50 border-blue-100 text-blue-800' },
    { key: 'nangsuat', label: 'NƒÉng Su·∫•t', icon: 'dollar-sign', bgClass: 'bg-green-50 border-green-100 text-green-800' },
    { key: 'hieuqua', label: 'Hi·ªáu Qu·∫£', icon: 'award', bgClass: 'bg-orange-50 border-orange-100 text-orange-800' },
    { key: 'dongia', label: 'ƒê∆°n Gi√°', icon: 'tag', bgClass: 'bg-purple-50 border-purple-100 text-purple-800' }
  ];
</script>

<div class="grid grid-cols-2 gap-2 px-3 pb-3 pt-1 border-t border-gray-100">
  {#each groups as g}
    {@const data = summary[g.key]}
    {@const ratio = data.total > 0 ? data.above / data.total : 0}
    
    {@const valueColor = ratio > 0.5 ? 'text-blue-600' : 'text-red-600'}
    
    <div class="flex items-center justify-between p-1.5 rounded border {g.bgClass}">
      <div class="flex items-center gap-1">
        <i data-feather={g.icon} class="w-3 h-3 opacity-70"></i>
        <span class="text-[10px] font-bold uppercase opacity-90">{g.label}</span>
      </div>
      <span class="text-xs font-extrabold {valueColor}">{data.above}/{data.total}</span>
    </div>
  {/each}
</div>

================================================================================
File: src/components/health-staff/summary/card/EmployeeCard.svelte
================================================================================

<script>
  import MedalIcon from '../../shared/MedalIcon.svelte';
  import CardHeader from './CardHeader.svelte';
  import CardMainKpi from './CardMainKpi.svelte';
  import CardSubKpiGrid from './CardSubKpiGrid.svelte';
  import { createEventDispatcher } from 'svelte';

  export let employee;
  export let rank; // 1, 2, 3...

  const dispatch = createEventDispatcher();
  
  $: summary = employee.summary;
  $: totalAbove = employee.totalAbove;
  $: totalCriteria = employee.totalCriteria;

  function handleClick() {
    dispatch('click', { employeeId: employee.maNV });
  }
</script>

<div 
  class="bg-white rounded-xl border border-gray-200 shadow-sm hover:shadow-md hover:-translate-y-1 transition-all cursor-pointer overflow-hidden relative group"
  on:click={handleClick}
  role="button"
  tabindex="0"
>
  <div class="p-3 flex items-start relative z-10">
    <MedalIcon {rank} />
    <CardHeader hoTen={employee.hoTen} maNV={employee.maNV} boPhan={employee.boPhan} {rank} />
  </div>

  <CardMainKpi aboveCount={totalAbove} totalCount={totalCriteria} />
  <CardSubKpiGrid {summary} />
</div>

================================================================================
File: src/components/realtime/RealtimeSection.svelte
================================================================================

<script>
  import { onMount } from 'svelte';
  
  // [FIX] S·ª≠a 'import * as dataService' th√†nh 'import { dataService }'
  import { dataService } from '../../services/dataService.js';
  
  import { warehouseList, modalState, selectedWarehouse } from '../../stores.js';
  import { actionService } from '../../services/action.service.js';

  import SummaryTab from './summary/SummaryTab.svelte';
  import EmployeeTab from './employee/EmployeeTab.svelte';
  import EfficiencyTab from './efficiency/EfficiencyTab.svelte';
  import CategoryTab from './category/CategoryTab.svelte';
  import BrandTab from './brand/BrandTab.svelte';
  import CompetitionTab from './competition/CompetitionTab.svelte';

  export let activeTab;
  let activeSubTabId = 'subtab-realtime-sieu-thi'; 
  
  function handleSubTabClick(event) {
      const button = event.currentTarget;
      activeSubTabId = button.dataset.target;
  }

  function handleWarehouseChange(event) {
      selectedWarehouse.set(event.target.value);
  }

  async function handleFileUpload(event) {
    // B√¢y gi·ªù h√†m n√†y s·∫Ω ho·∫°t ƒë·ªông ƒë√∫ng
    await dataService.handleRealtimeFileInput(event);
  }

  // === ACTIONS ===
  function handleCompose() {
    modalState.update(s => ({ ...s, activeModal: 'composer-modal', context: 'realtime' }));
  }
  function handleExport() {
    actionService.handleExport('realtime');
  }
  function handleCapture() {
    actionService.handleCapture('realtime');
  }

  $: if (activeTab === 'realtime-section') {
    Promise.resolve().then(() => {
      if (typeof window.feather !== 'undefined') window.feather.replace();
    });
  }
</script>

<section id="realtime-section" class="page-section {activeTab === 'realtime-section' ? '' : 'hidden'}">
    
    <div class="content-card mb-6 !p-0">
        <div class="modern-page-header flex flex-wrap justify-between items-center">
            
            <div class="title-wrapper flex items-center gap-4 flex-wrap">
                <i data-feather="trending-up" class="main-icon hidden sm:block"></i>
                
                <div class="flex items-center gap-2">
                    <h2 class="page-title text-xl sm:text-2xl font-bold text-blue-800">Doanh Thu Realtime</h2>
                    <button class="page-header__help-btn" data-help-id="realtime" title="Xem h∆∞·ªõng d·∫´n">
                        <i data-feather="help-circle"></i>
                    </button>
                </div>

                <div class="flex items-center gap-2 pl-4 border-l-2 border-blue-100 ml-2">
                    <label for="realtime-filter-warehouse" class="text-sm font-semibold text-gray-600 whitespace-nowrap">Kho:</label>
                     <select 
                       id="realtime-filter-warehouse" 
                       class="p-2 border rounded-lg text-sm shadow-sm bg-white border-blue-200 text-blue-700 font-bold min-w-[120px] focus:ring-2 focus:ring-blue-500 outline-none cursor-pointer hover:bg-blue-50 transition"
                       value={$selectedWarehouse}
                       on:change={handleWarehouseChange}
                     >
                       <option value="">-- To√†n b·ªô --</option>
                       {#each $warehouseList as kho}
                          <option value={kho}>{kho}</option>
                       {/each}
                    </select>
                </div>
            </div>

            <div class="flex flex-wrap items-center gap-3 ml-auto mt-2 sm:mt-0">
                
                <div class="flex items-center gap-2 pr-4 border-r border-blue-100">
                    <a href="https://report.mwgroup.vn/home/dashboard/077" target="_blank" class="text-blue-600 hover:text-blue-800 hover:underline text-xs font-medium flex items-center gap-1 bg-blue-50 px-2 py-1.5 rounded transition-colors">
                        <i data-feather="external-link" class="w-3 h-3"></i> L·∫•y file
                    </a>
                    <label for="realtime-file-input" class="cursor-pointer bg-white text-blue-700 px-3 py-1.5 rounded-lg hover:bg-blue-50 transition text-sm font-bold flex items-center gap-2 shadow-sm border border-blue-200">
                         <i data-feather="upload" class="w-4 h-4"></i>
                        <span>T·∫£i file</span>
                    </label>
                    <input 
                        type="file" 
                        id="realtime-file-input" 
                        class="hidden" 
                        accept=".xlsx, .xls, .csv"
                        on:change={handleFileUpload}
                    >
                </div>

                <div class="flex items-center gap-2">
                     <button id="compose-realtime-notification-btn" class="action-btn action-btn--composer" title="Nh·∫≠n x√©t" on:click={handleCompose}>
                        <i data-feather="pen-tool" class="w-4 h-4"></i>
                        <span class="hidden lg:inline">Nh·∫≠n x√©t</span>
                     </button>
                    <button id="export-realtime-btn" class="action-btn action-btn--export" title="Xu·∫•t Excel" on:click={handleExport}>
                         <i data-feather="download" class="w-4 h-4"></i>
                        <span class="hidden lg:inline">Xu·∫•t Excel</span>
                    </button>
                    <button id="capture-realtime-btn" class="action-btn action-btn--capture" title="Ch·ª•p ·∫£nh" on:click={handleCapture}>
                        <i data-feather="camera" class="w-4 h-4"></i>
                        <span class="hidden lg:inline">Ch·ª•p</span>
                     </button>
                </div>
            </div>
        </div>

        <div class="content-card__body p-4">
            <div class="mb-6 overflow-x-auto pb-2">
                <nav id="realtime-subtabs-nav" class="flex space-x-2 border-b border-gray-100 pb-1 w-full min-w-max" aria-label="Tabs">
                    <button 
                        class="sub-tab-btn {activeSubTabId === 'subtab-realtime-sieu-thi' ? 'active' : ''}" 
                        data-target="subtab-realtime-sieu-thi"
                        data-title="SieuThiRealtime"
                        on:click={handleSubTabClick}
                    >
                        <i data-feather="zap"></i>
                        <span>Si√™u th·ªã Realtime</span>
                    </button>
                       
                    <button 
                        class="sub-tab-btn {activeSubTabId === 'subtab-realtime-nhan-vien' ? 'active' : ''}" 
                        data-target="subtab-realtime-nhan-vien"
                        data-title="DTNVRealtime"
                        on:click={handleSubTabClick}
                    >
                        <i data-feather="pie-chart"></i>
                        <span>DT NV Realtime</span>
                    </button>

                    <button 
                        class="sub-tab-btn {activeSubTabId === 'subtab-realtime-hieu-qua-nhan-vien' ? 'active' : ''}" 
                        data-target="subtab-realtime-hieu-qua-nhan-vien"
                        data-title="HieuQuaKhaiThacRealtime"
                        on:click={handleSubTabClick}
                    >
                        <i data-feather="bar-chart-2"></i>
                        <span>Hi·ªáu qu·∫£ NV Realtime</span>
                    </button>

                      <button 
                        class="sub-tab-btn {activeSubTabId === 'subtab-realtime-nganh-hang' ? 'active' : ''}" 
                        data-target="subtab-realtime-nganh-hang"
                        data-title="NganhHangRealtime"
                        on:click={handleSubTabClick}
                    >
                        <i data-feather="layers"></i>
                        <span>Ng√†nh h√†ng Realtime</span>
                    </button>

                    <button 
                        class="sub-tab-btn {activeSubTabId === 'subtab-realtime-hang-ban' ? 'active' : ''}" 
                        data-target="subtab-realtime-hang-ban"
                        data-title="HangRealtime"
                        on:click={handleSubTabClick}
                    >
                        <i data-feather="tag"></i>
                        <span>DT H√£ng Realtime</span>
                    </button>

                    <button 
                        class="sub-tab-btn {activeSubTabId === 'subtab-realtime-thi-dua' ? 'active' : ''}" 
                        data-target="subtab-realtime-thi-dua"
                        data-title="ThiDuaNhanVienRealtime"
                        on:click={handleSubTabClick}
                    >
                        <i data-feather="award"></i>
                        <span>Thi ƒëua NV Realtime</span>
                    </button>
                </nav>
            </div>

            <div id="realtime-subtabs-content">
                {#if activeSubTabId === 'subtab-realtime-sieu-thi'}
                    <div id="subtab-realtime-sieu-thi" class="sub-tab-content">
                        <SummaryTab {selectedWarehouse} />
                    </div>
                
                {:else if activeSubTabId === 'subtab-realtime-nhan-vien'}
                    <div id="subtab-realtime-nhan-vien" class="sub-tab-content" data-capture-preset="large-font-report">
                        <EmployeeTab {selectedWarehouse} />
                    </div>
                    
                {:else if activeSubTabId === 'subtab-realtime-hieu-qua-nhan-vien'}
                    <div id="subtab-realtime-hieu-qua-nhan-vien" class="sub-tab-content" data-capture-preset="landscape-table">
                        <EfficiencyTab {selectedWarehouse} />
                    </div>

                {:else if activeSubTabId === 'subtab-realtime-nganh-hang'}
                    <div id="subtab-realtime-nganh-hang" class="sub-tab-content" data-capture-preset="mobile-portrait">
                        <CategoryTab {selectedWarehouse} />
                    </div>

                {:else if activeSubTabId === 'subtab-realtime-hang-ban'}
                    <div id="subtab-realtime-hang-ban" class="sub-tab-content">
                        <BrandTab {selectedWarehouse} />
                    </div>

                {:else if activeSubTabId === 'subtab-realtime-thi-dua'}
                    <div id="subtab-realtime-thi-dua" class="sub-tab-content">
                        <CompetitionTab {selectedWarehouse} />
                    </div>
                    
                {:else}
                    <div class="p-12 text-center bg-gray-50 rounded-lg border border-dashed border-gray-300">
                        <p class="text-gray-500 font-medium">Ch·ª©c nƒÉng tab <strong>{activeSubTabId}</strong> ƒëang ƒë∆∞·ª£c ph√°t tri·ªÉn.</p>
                    </div>
                {/if}
            </div>
        </div>
    </div>

</section>

================================================================================
File: src/components/realtime/brand/BrandTab.svelte
================================================================================

<script>
  import { onMount } from 'svelte';
  import { realtimeYCXData } from '../../../stores.js';
  import { reportService } from '../../../services/reportService.js';
  import { cleanCategoryName } from '../../../utils.js';
  import BrandTable from './BrandTable.svelte';

  export let selectedWarehouse = '';

  let viewType = 'brand'; // 'brand' | 'employee'
  let selectedCategory = '';
  let selectedBrand = '';
  
  let categories = [];
  let brands = [];
  let reportData = [];

  // 1. L·∫•y danh s√°ch Ng√†nh h√†ng t·ª´ d·ªØ li·ªáu (Reactive)
  $: {
      if ($realtimeYCXData.length > 0) {
          categories = [...new Set($realtimeYCXData
              .map(row => cleanCategoryName(row.nganhHang))
              .filter(Boolean))
          ].sort();
      }
  }

  // 2. L·∫•y danh s√°ch H√£ng d·ª±a tr√™n Ng√†nh h√†ng ƒë√£ ch·ªçn (Reactive)
  $: {
      let filteredData = $realtimeYCXData;
      if (selectedCategory) {
          filteredData = filteredData.filter(row => cleanCategoryName(row.nganhHang) === selectedCategory);
      }
      
      if (filteredData.length > 0) {
          brands = [...new Set(filteredData
              .map(row => row.nhaSanXuat || 'H√£ng kh√°c')
              .filter(Boolean))
          ].sort();
      } else {
          brands = [];
      }
      
      // Reset selectedBrand n·∫øu n√≥ kh√¥ng c√≤n trong danh s√°ch m·ªõi
      if (selectedBrand && !brands.includes(selectedBrand)) {
          selectedBrand = '';
      }
  }

  // 3. T√≠nh to√°n d·ªØ li·ªáu b√°o c√°o (Reactive)
  $: {
      // L·ªçc theo kho tr∆∞·ªõc (Logic ƒë∆°n gi·∫£n h√≥a, s·ª≠ d·ª•ng d·ªØ li·ªáu ƒë√£ t·∫£i v·ªÅ)
      // L∆∞u √Ω: N·∫øu c·∫ßn l·ªçc ch√≠nh x√°c theo kho c·ªßa user, c·∫ßn ƒë·∫£m b·∫£o realtimeYCXData ƒë√£ ƒë∆∞·ª£c l·ªçc ho·∫∑c l·ªçc l·∫°i ·ªü ƒë√¢y
      // Hi·ªán t·∫°i service s·∫Ω x·ª≠ l√Ω vi·ªác t√≠nh to√°n t·ªïng h·ª£p.
      
      const result = reportService.generateRealtimeBrandReport(
          $realtimeYCXData, 
          selectedCategory,
          selectedBrand
      );
      
      if (viewType === 'brand') {
          reportData = result.byBrand;
      } else {
          reportData = result.byEmployee;
      }
  }
</script>

<div class="animate-fade-in pb-10">
    <div class="content-card mb-6">
        <div class="flex flex-wrap items-center justify-between gap-4 mb-4 border-b pb-4">
            <h3 class="text-xl font-bold text-gray-700 uppercase">Th·ªëng k√™ theo H√£ng</h3>
            <div class="view-switcher bg-gray-200 p-1 rounded-lg flex">
                <button 
                    class="px-4 py-2 rounded-md text-sm font-medium transition-all {viewType === 'brand' ? 'bg-white text-blue-600 shadow-sm' : 'text-gray-600 hover:bg-gray-300'}"
                    on:click={() => viewType = 'brand'}
                >
                    Theo H√£ng
                </button>
                <button 
                    class="px-4 py-2 rounded-md text-sm font-medium transition-all {viewType === 'employee' ? 'bg-white text-blue-600 shadow-sm' : 'text-gray-600 hover:bg-gray-300'}"
                    on:click={() => viewType = 'employee'}
                >
                    Theo Nh√¢n vi√™n
                </button>
            </div>
        </div>
        
        <div class="flex flex-wrap items-center gap-4">
            <div class="flex flex-col">
                <label for="rt-brand-cat-select" class="text-sm font-semibold text-gray-600 mb-1">Ng√†nh h√†ng:</label>
                <select 
                    id="rt-brand-cat-select"
                    class="p-2 border rounded-lg text-sm shadow-sm bg-white min-w-[200px] focus:ring-2 focus:ring-blue-500 outline-none"
                    bind:value={selectedCategory}
                >
                    <option value="">-- T·∫•t c·∫£ ng√†nh h√†ng --</option>
                    {#each categories as cat}
                        <option value={cat}>{cat}</option>
                    {/each}
                </select>
            </div>

            <div class="flex flex-col">
                <label for="rt-brand-select" class="text-sm font-semibold text-gray-600 mb-1">H√£ng:</label>
                <select 
                    id="rt-brand-select"
                    class="p-2 border rounded-lg text-sm shadow-sm bg-white min-w-[200px] focus:ring-2 focus:ring-blue-500 outline-none"
                    bind:value={selectedBrand}
                >
                    <option value="">-- T·∫•t c·∫£ c√°c h√£ng --</option>
                    {#each brands as brand}
                        <option value={brand}>{brand}</option>
                    {/each}
                </select>
            </div>
        </div>
    </div>

    <BrandTable {viewType} {reportData} />
</div>

<style>
  .animate-fade-in { animation: fadeIn 0.3s ease-out; }
  @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
</style>

================================================================================
File: src/components/realtime/brand/BrandTable.svelte
================================================================================

<script>
  import { formatters } from '../../../utils/formatters.js';
  // Import component m·ªõi
  import SortableTh from '../../common/SortableTh.svelte';

  export let viewType = 'brand'; // 'brand' ho·∫∑c 'employee'
  export let reportData = [];

  let sortKey = 'revenue';
  let sortDirection = 'desc';

  // Reset sort khi ƒë·ªïi ch·∫ø ƒë·ªô xem
  $: if (viewType) {
      sortKey = 'revenue';
      sortDirection = 'desc';
  }

  // H√†m x·ª≠ l√Ω s·ª± ki·ªán sort t·ª´ component con
  function handleSort(event) {
    const key = event.detail; // Nh·∫≠n key t·ª´ dispatch('sort', key)
    if (sortKey === key) {
      sortDirection = sortDirection === 'desc' ? 'asc' : 'desc';
    } else {
      sortKey = key;
      sortDirection = 'desc';
    }
  }

  // H√†m sort d·ªØ li·ªáu
  function sortData(items, key, dir) {
      return [...items].sort((a, b) => {
          // Sort ch·ªØ
          if (key === 'name') {
             const valA = a.name || '';
             const valB = b.name || '';
             return dir === 'asc' ? valA.localeCompare(valB) : valB.localeCompare(valA);
          }
          // Sort s·ªë
          let valA = Number(a[key]) || 0;
          let valB = Number(b[key]) || 0;
          return dir === 'asc' ? valA - valB : valB - valA;
      });
  }

  // C·∫•u h√¨nh c·ªôt cho t·ª´ng ch·∫ø ƒë·ªô xem
  $: columns = viewType === 'brand' 
    ? [
        { id: 'name', label: 'H√£ng', align: 'left' },
        { id: 'quantity', label: 'S·ªë l∆∞·ª£ng', align: 'right' },
        { id: 'revenue', label: 'Doanh thu', align: 'right' },
        { id: 'avgPrice', label: 'ƒê∆°n gi√° TB', align: 'right' }
      ]
    : [
        { id: 'name', label: 'Nh√¢n vi√™n', align: 'left' },
        { id: 'quantity', label: 'S·ªë l∆∞·ª£ng', align: 'right' },
        { id: 'revenue', label: 'Doanh thu', align: 'right' }
    ];
</script>

<div class="bg-white rounded-xl shadow-md border border-gray-200 overflow-hidden">
  <div class="p-4 border-b bg-gray-50 border-gray-200 flex justify-between items-center">
      <h4 class="text-lg font-bold uppercase text-gray-700">
          {viewType === 'brand' ? 'Th·ªëng k√™ theo H√£ng' : 'Th·ªëng k√™ theo Nh√¢n vi√™n'}
      </h4>
  </div>

  <div class="overflow-x-auto">
    <table class="min-w-full text-sm text-left text-gray-600 table-bordered">
      <thead class="text-xs text-slate-800 uppercase bg-slate-200 font-bold sticky top-0 z-20 shadow-sm">
        <tr>
          {#each columns as col}
            <SortableTh 
              key={col.id}
              label={col.label}
              align={col.align}
              {sortKey}
              {sortDirection}
              on:sort={handleSort} 
            />
          {/each}
        </tr>
      </thead>
      <tbody class="divide-y divide-gray-200">
        {#if reportData.length === 0}
            <tr><td colspan={columns.length} class="p-4 text-center text-gray-500 italic">Kh√¥ng c√≥ d·ªØ li·ªáu.</td></tr>
        {:else}
            {#each sortData(reportData, sortKey, sortDirection) as item}
              <tr class="hover:bg-blue-50 transition">
                <td class="px-4 py-2 font-semibold text-blue-600 {viewType === 'employee' ? 'sticky left-0 bg-white hover:bg-blue-50 z-10 border-r' : ''}">
                  {item.name}
                </td>
                <td class="px-4 py-2 text-right font-bold text-gray-900">{formatters.formatNumber(item.quantity)}</td>
                <td class="px-4 py-2 text-right font-bold text-gray-900">{formatters.formatRevenue(item.revenue)}</td>
                {#if viewType === 'brand'}
                    <td class="px-4 py-2 text-right font-bold text-green-600">{formatters.formatRevenue(item.avgPrice)}</td>
                {/if}
              </tr>
            {/each}
        {/if}
      </tbody>
    </table>
  </div>
</div>

================================================================================
File: src/components/realtime/category/CategoryTab.svelte
================================================================================

<script>
  import { realtimeYCXData, selectedWarehouse } from '../../../stores.js';
  import { reportService } from '../../../services/reportService.js';
  import { settingsService } from '../../../services/settings.service.js';
  
  // [THAY ƒê·ªîI QUAN TR·ªåNG] Import b·∫£ng Doanh thu ƒë·ªông t·ª´ Health Staff
  // Component n√†y t·ª± ƒë·ªông ƒë·ªçc store `customRevenueTables` n√™n s·∫Ω ƒë·ªìng b·ªô c·∫•u h√¨nh b·∫£ng
  import CategoryRevenueView from '../../health-staff/CategoryRevenueView.svelte';

  export let selectedWarehouseProp = ''; // Nh·∫≠n prop t·ª´ cha n·∫øu c√≥, ho·∫∑c d√πng store

  let filteredReport = [];

  $: {
    // 1. ∆Øu ti√™n d√πng prop, n·∫øu kh√¥ng th√¨ d√πng store global
    const currentWarehouse = selectedWarehouseProp || $selectedWarehouse;
    
    // 2. L·∫•y m·ª•c ti√™u (ƒë·ªÉ t√≠nh % ƒë·∫°t n·∫øu c·∫ßn)
    const settings = settingsService.getRealtimeGoalSettings(currentWarehouse);
    const goals = settings.goals || {};

    // 3. T√≠nh to√°n Master Report t·ª´ d·ªØ li·ªáu Realtime
    // isRealtime = true ƒë·ªÉ logic t√≠nh to√°n x·ª≠ l√Ω ƒë√∫ng c√°c tr∆∞·ªùng ƒë·∫∑c th√π
    const masterReport = reportService.generateMasterReportData($realtimeYCXData, goals, true);
    
    // 4. L·ªçc theo kho
    if (currentWarehouse) {
      filteredReport = masterReport.filter(nv => nv.maKho == currentWarehouse);
    } else {
      filteredReport = masterReport;
    }
  }
</script>

<div class="animate-fade-in pb-10">
    <CategoryRevenueView reportData={filteredReport} />
</div>

<style>
  .animate-fade-in { animation: fadeIn 0.3s ease-out; }
  @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
</style>

================================================================================
File: src/components/realtime/competition/CompetitionTab.svelte
================================================================================

<script>
  import { 
      realtimeYCXData, 
      globalSpecialPrograms, 
      globalCompetitionConfigs, 
      localCompetitionConfigs, // Store ch·ª©a c·∫•u h√¨nh thi ƒëua user
      selectedWarehouse 
  } from '../../../stores.js';
  import { services } from '../../../services.js'; 
  
  import SpecialProgramTable from './SpecialProgramTable.svelte';
  
  // [REFACTOR] D√πng chung component t·ª´ health-staff (ƒë√£ c√≥ logic t√¥ m√†u)
  import FocusCompetitionTable from '../../health-staff/competition/FocusCompetitionTable.svelte';

  let specialReportData = [];
  let competitionReportData = [];
  let hasData = false;

  // Reactive Statement: Ch·∫°y l·∫°i khi store thay ƒë·ªïi
  $: {
      // Fallback v·ªÅ m·∫£ng r·ªóng n·∫øu ch∆∞a c√≥ d·ªØ li·ªáu
      let filteredData = $realtimeYCXData || [];
      
      // 1. T√≠nh to√°n SP ƒê·∫∑c Quy·ªÅn
      // H√†m n√†y t√™n ƒë√∫ng l√† calculateSpecialProductReport (trong competition.report.js)
      const spReport = services.calculateSpecialProductReport(
          filteredData, 
          $globalSpecialPrograms || []
      );

      // 2. T√≠nh to√°n Thi ƒêua T√πy Ch·ªânh (H√£ng)
      // K·∫øt h·ª£p c·∫£ Global v√† Local Configs
      const allConfigs = [ ...($globalCompetitionConfigs || []), ...($localCompetitionConfigs || []) ];
      
      // L·ªçc tr√πng l·∫∑p Config (∆Øu ti√™n c√°i m·ªõi nh·∫•t n·∫øu tr√πng ID)
      const uniqueConfigs = Array.from(new Map(allConfigs.map(item => [item.id, item])).values());

      // [FIX CRITICAL]: S·ª≠a t√™n h√†m t·ª´ calculateCompetitionReport -> calculateCompetitionFocusReport
      // Nguy√™n nh√¢n: Trong src/services/reports/competition.report.js ƒë·ªãnh nghƒ©a l√† calculateCompetitionFocusReport
      const compReport = services.calculateCompetitionFocusReport(
          filteredData,
          uniqueConfigs
      );

      console.groupCollapsed(`[DEBUG REALTIME] Calc Result`);
      console.log("SP Report:", spReport);
      console.log("Comp Report:", compReport);
      console.groupEnd();
      
      specialReportData = spReport;
      competitionReportData = compReport;
      
      // C·ªù check xem c√≥ d·ªØ li·ªáu ƒë·ªÉ hi·ªÉn th·ªã kh√¥ng
      hasData = (specialReportData.length > 0 || competitionReportData.length > 0);
  }
</script>

<div class="h-full flex flex-col p-4 bg-gray-50 overflow-y-auto custom-scrollbar">
    {#if !hasData}
        <div class="flex flex-col items-center justify-center h-full text-gray-400 border-2 border-dashed border-gray-300 rounded-xl bg-white p-8">
            <i data-feather="inbox" class="w-12 h-12 mb-3 opacity-50"></i>
            <p class="text-gray-500 font-medium mb-2">Ch∆∞a c√≥ d·ªØ li·ªáu thi ƒëua hi·ªÉn th·ªã.</p>
            <div class="text-xs text-gray-400 space-y-1">
                <p>Vui l√≤ng ki·ªÉm tra (Xem Console F12 ƒë·ªÉ bi·∫øt chi ti·∫øt):</p>
                <p>1. ƒê√£ t·∫£i file <strong>Realtime</strong> ch∆∞a?</p>
                <p>2. ƒê√£ t·∫°o ch∆∞∆°ng tr√¨nh thi ƒëua trong <strong>"Thi·∫øt l·∫≠p m·ª•c ti√™u"</strong> ch∆∞a?</p>
                <p>3. D·ªØ li·ªáu b√°n h√†ng c√≥ kh·ªõp v·ªõi <strong>H√£ng/Nh√≥m h√†ng</strong> ƒë√£ ch·ªçn kh√¥ng?</p>
                {#if $localCompetitionConfigs.length === 0 && $globalCompetitionConfigs.length === 0}
                    <p class="text-orange-500 font-bold mt-2">‚Üí B·∫°n ch∆∞a t·∫°o ch∆∞∆°ng tr√¨nh thi ƒëua n√†o.</p>
                {/if}
            </div>
        </div>
    {:else}
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            {#each specialReportData as programResult (programResult.program.id)}
                <div class="h-full">
                    <SpecialProgramTable {programResult} />
                </div>
            {/each}

            {#each competitionReportData as competitionResult (competitionResult.competition.id)}
                <div class="h-full">
                    <FocusCompetitionTable {competitionResult} />
                </div>
            {/each}
        </div>
    {/if}
</div>

<style>
    @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
    
    .grid > div {
        animation: fadeIn 0.3s ease-out forwards;
    }

    .custom-scrollbar::-webkit-scrollbar { width: 6px; }
    .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
    .custom-scrollbar::-webkit-scrollbar-thumb { background-color: #cbd5e1; border-radius: 3px; }
    .custom-scrollbar::-webkit-scrollbar-thumb:hover { background-color: #94a3b8; }
</style>

================================================================================
File: src/components/realtime/competition/SpecialProgramTable.svelte
================================================================================

<script>
  import { formatters } from '../../../utils/formatters.js';
  import SortableTh from '../../common/SortableTh.svelte';

  // Nh·∫≠n v√†o d·ªØ li·ªáu c·ªßa M·ªòT ch∆∞∆°ng tr√¨nh SPƒêQ
  export let programResult;

  const { program, employeeData } = programResult;

  let sortKey = 'tyLeSL';
  let sortDirection = 'desc';

  function handleSort(event) {
    const key = event.detail;
    if (sortKey === key) {
      sortDirection = sortDirection === 'desc' ? 'asc' : 'desc';
    } else {
      sortKey = key;
      sortDirection = 'desc';
    }
  }

  $: sortedData = [...employeeData].sort((a, b) => {
    let valA = Number(a[sortKey]) || 0;
    let valB = Number(b[sortKey]) || 0;

    if (sortKey === 'hoTen') {
        const nameA = a.hoTen || '';
        const nameB = b.hoTen || '';
        return sortDirection === 'asc' ? nameA.localeCompare(nameB) : nameB.localeCompare(nameA);
    }
    return sortDirection === 'asc' ? valA - valB : valB - valA;
  });

  // T√≠nh t·ªïng
  $: totals = employeeData.reduce((acc, item) => {
      acc.slDacQuyen += item.slDacQuyen;
      acc.slNhomHang += item.slNhomHang;
      acc.dtDacQuyen += item.dtDacQuyen;
      acc.dtNhomHang += item.dtNhomHang;
      return acc;
  }, { slDacQuyen: 0, slNhomHang: 0, dtDacQuyen: 0, dtNhomHang: 0 });

  $: totalTyLeSL = totals.slNhomHang > 0 ? (totals.slDacQuyen / totals.slNhomHang) : 0;
  $: totalTyLeDT = totals.dtNhomHang > 0 ? (totals.dtDacQuyen / totals.dtNhomHang) : 0;
</script>

<div class="bg-white rounded-xl shadow-md border border-gray-200 overflow-hidden flex flex-col h-full" data-capture-group="special-program">
    <div class="p-4 bg-purple-50 border-b-2 border-purple-200">
        <h3 class="text-lg font-bold text-purple-800 uppercase">{program.name}</h3>
        <p class="text-xs text-purple-700 font-medium mt-1">Nh√≥m h√†ng: {program.groups.join(', ')}</p>
    </div>

    <div class="overflow-x-auto flex-grow">
        <table class="min-w-full text-sm text-left text-gray-600 table-bordered table-striped">
            <thead class="text-xs text-slate-800 uppercase bg-slate-200 font-bold sticky top-0 z-10">
                <tr>
                    <SortableTh key="hoTen" label="Nh√¢n vi√™n" className="min-w-[150px]" {sortKey} {sortDirection} on:sort={handleSort} />
                    <SortableTh key="slDacQuyen" label="SL SPƒêQ" align="right" {sortKey} {sortDirection} on:sort={handleSort} />
                    <SortableTh key="slNhomHang" label="SL Nh√≥m" align="right" {sortKey} {sortDirection} on:sort={handleSort} />
                    <SortableTh key="tyLeSL" label="% SL" align="right" className="bg-yellow-50" {sortKey} {sortDirection} on:sort={handleSort} />
                    <SortableTh key="dtDacQuyen" label="DT SPƒêQ" align="right" {sortKey} {sortDirection} on:sort={handleSort} />
                    <SortableTh key="dtNhomHang" label="DT Nh√≥m" align="right" {sortKey} {sortDirection} on:sort={handleSort} />
                    <SortableTh key="tyLeDT" label="% DT" align="right" className="bg-yellow-50" {sortKey} {sortDirection} on:sort={handleSort} />
                </tr>
            </thead>
            <tbody class="divide-y divide-gray-200">
                {#each sortedData as item (item.maNV)}
                    <tr class="hover:bg-purple-50 transition">
                        <td class="px-4 py-2 font-semibold text-purple-900 sticky left-0 bg-white hover:bg-purple-50 border-r">
                            {formatters.getShortEmployeeName(item.hoTen, item.maNV)}
                        </td>
                        <td class="px-2 py-2 text-right font-bold">{formatters.formatNumber(item.slDacQuyen)}</td>
                        <td class="px-2 py-2 text-right font-bold">{formatters.formatNumber(item.slNhomHang)}</td>
                        <td class="px-2 py-2 text-right font-bold {item.tyLeSL > 0 ? 'text-blue-600' : 'text-gray-400'} bg-yellow-50/30">
                            {formatters.formatPercentage(item.tyLeSL)}
                        </td>
                        <td class="px-2 py-2 text-right font-bold">{formatters.formatRevenue(item.dtDacQuyen)}</td>
                        <td class="px-2 py-2 text-right font-bold">{formatters.formatRevenue(item.dtNhomHang)}</td>
                        <td class="px-2 py-2 text-right font-bold {item.tyLeDT > 0 ? 'text-green-600' : 'text-gray-400'} bg-yellow-50/30">
                            {formatters.formatPercentage(item.tyLeDT)}
                        </td>
                    </tr>
                {/each}
            </tbody>
            <tfoot class="table-footer font-bold bg-gray-100 border-t-2 border-gray-300">
                <tr>
                    <td class="px-4 py-2">T·ªïng</td>
                    <td class="px-2 py-2 text-right">{formatters.formatNumber(totals.slDacQuyen)}</td>
                    <td class="px-2 py-2 text-right">{formatters.formatNumber(totals.slNhomHang)}</td>
                    <td class="px-2 py-2 text-right">{formatters.formatPercentage(totalTyLeSL)}</td>
                    <td class="px-2 py-2 text-right">{formatters.formatRevenue(totals.dtDacQuyen)}</td>
                    <td class="px-2 py-2 text-right">{formatters.formatRevenue(totals.dtNhomHang)}</td>
                    <td class="px-2 py-2 text-right">{formatters.formatPercentage(totalTyLeDT)}</td>
                </tr>
            </tfoot>
        </table>
    </div>
</div>

================================================================================
File: src/components/realtime/efficiency/EfficiencyTab.svelte
================================================================================

<script>
  import { realtimeYCXData, selectedWarehouse } from '../../../stores.js';
  import { reportService } from '../../../services/reportService.js';
  import { settingsService } from '../../../services/settings.service.js';
  
  // [NEW] S·ª≠ d·ª•ng View m·ªõi thay v√¨ EfficiencyTable c≈©
  import PerformanceView from '../../health-staff/performance/PerformanceView.svelte';

  let filteredReport = [];

  $: {
    const currentWarehouse = $selectedWarehouse;
    // L·∫•y m·ª•c ti√™u Realtime
    const settings = settingsService.getRealtimeGoalSettings(currentWarehouse);
    const goals = settings.goals || {};

    // T√≠nh to√°n Master Report (isRealtime = true ƒë·ªÉ x·ª≠ l√Ω ƒë√∫ng logic realtime)
    const masterReport = reportService.generateMasterReportData($realtimeYCXData, goals, true);
    
    // L·ªçc theo kho
    if (currentWarehouse) {
       filteredReport = masterReport.filter(nv => nv.maKho == currentWarehouse);
    } else {
       filteredReport = masterReport;
    }
  }
</script>

<div class="animate-fade-in pb-10">
    <PerformanceView reportData={filteredReport} />
</div>

<style>
  .animate-fade-in { animation: fadeIn 0.3s ease-out; }
  @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
</style>

================================================================================
File: src/components/realtime/efficiency/EfficiencyTable.svelte
================================================================================

<script>
  import { afterUpdate, createEventDispatcher, onMount } from 'svelte';
  import { formatters } from '../../../utils/formatters.js';

  export let items = []; 
  export let dynamicItems = [];
  export let supermarketData = {}; 
  export let goals = {}; // Nh·∫≠n goals t·ª´ component cha
  
  const dispatch = createEventDispatcher();

  // --- PH·∫¶N STATE X·ª¨ L√ù ·∫®N/HI·ªÜN C·ªòT (FILTER) ---
  let isSettingsOpen = false;
  let filterSearch = '';
  let hiddenIds = new Set(); 
  const STORAGE_KEY = 'realtime_efficiency_hidden_ids';

  onMount(() => {
      // Load tr·∫°ng th√°i ·∫©n hi·ªán t·ª´ localStorage
      const saved = localStorage.getItem(STORAGE_KEY);
      if (saved) { 
          try { hiddenIds = new Set(JSON.parse(saved)); } catch (e) {} 
      }
      if (typeof feather !== 'undefined') feather.replace();
  });

  afterUpdate(() => { 
      if (typeof feather !== 'undefined') feather.replace(); 
  });

  function saveHiddenState() { 
      localStorage.setItem(STORAGE_KEY, JSON.stringify([...hiddenIds])); 
  }

  // Map icon cho c√°c ch·ªâ s·ªë c·ªë ƒë·ªãnh
  const iconMap = { 
      'pctPhuKien': 'headphones', 
      'pctGiaDung': 'home', 
      'pctMLN': 'droplet', 
      'pctSim': 'cpu', 
      'pctVAS': 'layers', 
      'pctBaoHiem': 'shield', 
      'tyLeTraCham': 'credit-card' 
  };

  // Map key ƒë·ªÉ l·∫•y m·ª•c ti√™u t∆∞∆°ng ·ª©ng t·ª´ settings
  const targetMap = {
      'pctPhuKien': 'phanTramPhuKien', 
      'pctGiaDung': 'phanTramGiaDung', 
      'pctMLN': 'phanTramMLN',
      'pctSim': 'phanTramSim', 
      'pctVAS': 'phanTramVAS', 
  
     'pctBaoHiem': 'phanTramBaoHiem', 
      'tyLeTraCham': 'phanTramTC'
  };

  // G·ªôp items c·ªë ƒë·ªãnh v√† dynamic items l·∫°i th√†nh danh s√°ch hi·ªÉn th·ªã
  $: displayItems = [
      // C√°c ch·ªâ s·ªë c·ªë ƒë·ªãnh (Hardcoded)
      ...items.map(i => ({
          ...i,
          // L·∫•y target t·ª´ goals truy·ªÅn v√†o, n·∫øu kh√¥ng c√≥ th√¨ b·∫±ng 0
          target: goals?.[targetMap[i.id]] || 0 
      })),
      // C√°c ch·ªâ s·ªë ƒë·ªông t·ª´ Admin Config
      ...(dynamicItems || []).map(cfg => {
          const metric = 
            supermarketData.dynamicMetrics?.[cfg.id];
          return {
              id: cfg.id,
              label: cfg.label,
              value: metric ? metric.value : 0,
              // ∆Øu ti√™n target trong Goals (User setting)
              target: goals?.[cfg.id] || cfg.target,
              isDynamic: true,
              rawConfig: cfg
          };
      })
  ];

  // Logic l·ªçc danh s√°ch trong dropdown filter
  $: filterList = displayItems.filter(item => item.label.toLowerCase().includes(filterSearch.toLowerCase()));

  // Danh s√°ch 
  // c√°c item th·ª±c s·ª± ƒë∆∞·ª£c hi·ªÉn th·ªã ra ngo√†i (ƒë√£ tr·ª´ c√°c item b·ªã ·∫©n)
  $: visibleItems = displayItems.filter(item => !hiddenIds.has(item.id));

  // H√†m toggle ·∫©n/hi·ªán 1 item
  function toggleVisibility(id) {
      if (hiddenIds.has(id)) hiddenIds.delete(id); 
      else hiddenIds.add(id);
      hiddenIds = new Set(hiddenIds); // Trigger reactivity
      saveHiddenState();
  }

  // H√†m ·∫©n/hi·ªán t·∫•t c·∫£
  function toggleAllVisibility(show) {
      if (show) {
          hiddenIds = new Set();
      } else {
          hiddenIds = new Set(displayItems.map(i => i.id));
      }
      saveHiddenState();
  }

  // --- LOGIC M√ÄU S·∫ÆC & C·∫¢NH B√ÅO ---
  // [C·∫¨P NH·∫¨T] Xanh d∆∞∆°ng cho ƒê·∫°t, ƒê·ªè cho R·ªõt
  function getProgressColor(val, target) {
      const t = (target || 0) / 100;
      if (t <= 0) return '#3b82f6'; // Xanh d∆∞∆°ng m·∫∑c ƒë·ªãnh n·∫øu kh√¥ng c√≥ target
      return val >= t ? '#2563eb' : '#ef4444'; // ƒê·∫°t -> Xanh d∆∞∆°ng, R·ªõt -> ƒê·ªè
  }
  
  // ƒê√≥ng dropdown khi click ra ngo√†i
  function handleWindowClick(e) { 
      if (isSettingsOpen && !e.target.closest('.filter-wrapper')) {
          isSettingsOpen = false;
      }
  }

  function handleDelete(id) { 
      if(confirm('B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a ch·ªâ s·ªë n√†y?')) {
          dispatch('delete', id);
      }
  }
</script>

<svelte:window on:click={handleWindowClick} />

<div class="luyke-widget h-full bg-white border border-gray-200 rounded-xl shadow-sm">
  <div class="luyke-widget-header">
    <div class="luyke-widget-title">
      <div class="p-1.5 bg-blue-100 rounded text-blue-600 mr-2">
     
           <i data-feather="bar-chart-2" class="w-4 h-4"></i>
      </div>
      <span>HI·ªÜU QU·∫¢ KHAI TH√ÅC</span>
    </div>
    
    <div class="flex items-center gap-2">
        <button class="text-blue-600 hover:bg-blue-50 p-1.5 rounded text-xs font-bold flex items-center gap-1 border border-blue-200" on:click={() => dispatch('add')}>
            <i data-feather="plus" class="w-3 h-3"></i> Th√™m
        </button>
        
        <div class="relative filter-wrapper">
            <button class="luyke-icon-btn {isSettingsOpen ? 'active' : ''}" on:click={() => isSettingsOpen = !isSettingsOpen}>
                <i 
 data-feather="filter" class="w-4 h-4"></i>
            </button>
            
            {#if isSettingsOpen}
                <div class="filter-dropdown">
                    <div class="filter-header">
                        <input type="text" class="filter-search" placeholder="T√¨m ch·ªâ s·ªë..." bind:value={filterSearch} />
                    </div>
              
                     <div class="filter-body custom-scrollbar" style="max-height: 250px;">
                        {#each filterList as item (item.id)}
                            <div class="filter-item" on:click={() => toggleVisibility(item.id)}>
                                <input type="checkbox" checked={!hiddenIds.has(item.id)} /> 
                                <label>{item.label}</label>
    
                            </div>
                        {/each}
                    </div>
                    <div class="filter-actions">
                        <button class="filter-btn-link" on:click={() => toggleAllVisibility(true)}>Hi·ªán t·∫•t c·∫£</button>
                       
 <button class="filter-btn-link text-red-600" on:click={() => toggleAllVisibility(false)}>·∫®n t·∫•t c·∫£</button>
                    </div>
                </div>
            {/if}
        </div>
    </div>
  </div>

  <div class="luyke-widget-body custom-scrollbar p-0">
    {#if visibleItems.length === 0}
       <div class="flex flex-col items-center justify-center h-full text-gray-400 py-10">
           <p class="text-sm">ƒê√£ ·∫©n h·∫øt d·ªØ li·ªáu.</p>
       </div>
    {:else}
      <div class="flex flex-col gap-0">
        {#each visibleItems 
 as item (item.id)}
          {@const targetVal = (item.target || 0) / 100}
          {@const color = getProgressColor(item.value, item.target)}
          {@const percent = Math.min((item.value * 100), 100)}
          
          <div class="eff-item-compact group relative hover:bg-gray-50 transition-colors px-4">
            <div class="eff-icon-compact">
                <i data-feather={iconMap[item.id] || 'activity'} class="w-4 h-4"></i>
            </div>
            
         
            <div class="eff-content-compact">
                <div class="eff-row-top">
                    <span class="eff-label-text">{item.label}</span>
                    <div class="flex items-center gap-2">
                        {#if item.target > 0}
                             <span class="text-[10px] text-gray-400 font-medium whitespace-nowrap">- M·ª•c ti√™u : {item.target}%</span>
                        {/if}
                        <span class="eff-value-text" style="color: {color}">
                            {formatters.formatPercentage(item.value)}
                        </span>
                    </div>
                </div>
                
 
                <div class="eff-row-bottom">
                    <div class="eff-bar-container">
                         <div class="eff-bar-fill" style="width: {percent}%; background-color: {color};"></div>
                    </div>
                    
                    </div>
            </div>

            {#if item.isDynamic}
       
                 <div class="absolute right-2 top-2 hidden group-hover:flex gap-1 bg-white shadow-sm border border-gray-200 rounded p-1 z-10">
                     <button on:click|stopPropagation={() => dispatch('edit', item.rawConfig)} class="text-gray-500 hover:text-blue-600 p-1" title="S·ª≠a">
                         <i data-feather="edit-2" class="w-3 h-3"></i>
                     </button>
                    <button on:click|stopPropagation={() => handleDelete(item.id)} class="text-gray-500 hover:text-red-600 p-1" title="X√≥a">
               
                         <i data-feather="trash-2" class="w-3 h-3"></i>
                    </button>
                </div>
            {/if}
          </div>
        {/each}
      </div>
    {/if}
  </div>
</div>

================================================================================
File: src/components/realtime/employee/EmployeeDetail.svelte
================================================================================

<script>
  import { createEventDispatcher } from 'svelte';
  import { realtimeYCXData, employeeMaNVMap } from '../../../stores.js';
  import { reportService } from '../../../services/reportService.js';
  // [FIX] C·∫≠p nh·∫≠t ƒë∆∞·ªùng d·∫´n ƒë√∫ng: modules -> services
  import { settingsService } from '../../../services/settings.service.js';
  import { formatters } from '../../../utils/formatters.js';
  
  export let employeeId;

  const dispatch = createEventDispatcher();
  let detailData = null;
  let employeeName = 'N/A';
  let goals = {};

  // Reactive: T√≠nh to√°n d·ªØ li·ªáu chi ti·∫øt khi employeeId thay ƒë·ªïi
  $: {
    if (employeeId && $realtimeYCXData.length > 0) {
      const info = $employeeMaNVMap.get(String(employeeId));
      employeeName = info ? formatters.getShortEmployeeName(info.hoTen, info.maNV) : `NV ${employeeId}`;
      
      const warehouse = info ? info.maKho : '';
      const settings = settingsService.getRealtimeGoalSettings(warehouse);
      goals = settings.goals || {};
      
      detailData = reportService.generateRealtimeEmployeeDetailReport(employeeId, $realtimeYCXData);
    }
  }

  function goBack() {
      dispatch('back');
  }
</script>

<div class="max-w-4xl mx-auto animate-fade-in pb-10">
    <div class="mb-4 flex justify-between items-center">
        <button class="text-blue-600 hover:underline font-semibold flex items-center gap-1" on:click={goBack}>
            ‚Äπ Quay l·∫°i b·∫£ng t·ªïng h·ª£p
        </button>
    </div>

    {#if detailData}
        {@const summary = detailData.summary}
        {@const conversionRateTarget = (goals?.phanTramQD || 0) / 100}
        {@const isPositive = summary.conversionRate >= conversionRateTarget}

        <div class="bg-white rounded-lg shadow-md p-6 border border-gray-200 mb-6 text-center">
            <h3 class="text-2xl font-extrabold text-gray-800">{employeeName}</h3>
            <p class="text-gray-500 font-medium">Chi ti·∫øt doanh thu Realtime</p>
        </div>

        <div class="grid grid-cols-2 md:grid-cols-3 gap-4 mb-6">
             <div class="bg-white p-4 rounded-lg shadow border border-gray-100 text-center">
                 <div class="text-sm text-gray-500 font-medium uppercase">T·ªïng DT Th·ª±c</div>
                 <div class="text-2xl font-bold text-blue-600 mt-1">{formatters.formatRevenue(summary.totalRealRevenue, 1)}</div>
             </div>
             <div class="bg-white p-4 rounded-lg shadow border border-gray-100 text-center">
                 <div class="text-sm text-gray-500 font-medium uppercase">T·ªïng DTQƒê</div>
                 <div class="text-2xl font-bold text-purple-600 mt-1">{formatters.formatRevenue(summary.totalConvertedRevenue, 1)}</div>
             </div>
             <div class="bg-white p-4 rounded-lg shadow border border-gray-100 text-center">
                 <div class="text-sm text-gray-500 font-medium uppercase">T·ª∑ l·ªá Qƒê</div>
                 <div class="text-2xl font-bold mt-1 {isPositive ? 'text-green-600' : 'text-red-600'}">
                    {formatters.formatPercentage(summary.conversionRate)}
                 </div>
             </div>
             <div class="bg-white p-4 rounded-lg shadow border border-gray-100 text-center">
                <div class="text-sm text-gray-500 font-medium uppercase">DT Ch∆∞a Xu·∫•t</div>
                 <div class="text-2xl font-bold text-yellow-600 mt-1">{formatters.formatRevenue(summary.unexportedRevenue, 1)}</div>
            </div>
             <div class="bg-white p-4 rounded-lg shadow border border-gray-100 text-center">
                <div class="text-sm text-gray-500 font-medium uppercase">T·ªïng ƒê∆°n</div>
                <div class="text-2xl font-bold text-gray-800 mt-1">{summary.totalOrders}</div>
            </div>
            <div class="bg-white p-4 rounded-lg shadow border border-gray-100 text-center">
                 <div class="text-sm text-gray-500 font-medium uppercase">ƒê∆°n B√°n K√®m</div>
                <div class="text-2xl font-bold text-gray-800 mt-1">{summary.bundledOrderCount}</div>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            
            <div class="bg-white rounded-lg shadow-md border border-gray-200 p-5">
                <h4 class="text-lg font-bold text-gray-800 mb-4 border-b pb-2">T·ª∑ tr·ªçng Nh√≥m h√†ng</h4>
                <div class="space-y-4">
                    {#each detailData.byProductGroup as group}
                        {@const percent = summary.totalRealRevenue > 0 ? (group.realRevenue / summary.totalRealRevenue) * 100 : 0}
                        <div>
                             <div class="flex justify-between text-sm mb-1">
                                <span class="font-semibold">{group.name}</span>
                                <span class="font-bold text-gray-700">{formatters.formatRevenue(group.realRevenue, 0)}</span>
                             </div>
                            <div class="w-full bg-gray-200 rounded-full h-2.5">
                                <div class="bg-blue-600 h-2.5 rounded-full" style="width: {percent}%"></div>
                            </div>
                        </div>
                    {/each}
                </div>
            </div>

            <div class="bg-white rounded-lg shadow-md border border-gray-200 p-5">
                <h4 class="text-lg font-bold text-gray-800 mb-4 border-b pb-2">Chi ti·∫øt Kh√°ch h√†ng ({detailData.byCustomer.length})</h4>
                <div class="space-y-2 max-h-[500px] overflow-y-auto pr-2">
                     {#each detailData.byCustomer as customer, index}
                        <details class="group border border-gray-200 rounded-lg bg-gray-50 open:bg-white open:shadow-sm transition-all">
                            <summary class="flex justify-between items-center p-3 cursor-pointer list-none select-none">
                                <div class="flex items-center gap-2">
                                    <span class="font-bold text-gray-500 text-sm">{index + 1}.</span>
                                    <span class="font-semibold text-gray-800 text-sm">{customer.name}</span>
                                    <span class="text-xs font-bold bg-blue-100 text-blue-800 px-2 py-0.5 rounded-full">{customer.totalQuantity} SP</span>
                                </div>
                                <span class="transform group-open:rotate-180 transition-transform text-gray-400">‚ñº</span>
                            </summary>
                             <div class="p-3 border-t border-gray-100 text-sm">
                                <table class="w-full">
                                    {#each customer.products as p}
                                        <tr class="border-b last:border-0 border-gray-100">
                                            <td class="py-2 text-gray-600">{p.productName}</td>
                                            <td class="py-2 text-right font-bold text-gray-800">{formatters.formatRevenue(p.realRevenue)}</td>
                                        </tr>
                                    {/each}
                                </table>
                             </div>
                        </details>
                    {/each}
                </div>
            </div>
        </div>

    {:else}
        <div class="p-12 text-center bg-gray-50 rounded-lg border border-dashed border-gray-300">
             <p class="text-gray-500">ƒêang t·∫£i ho·∫∑c kh√¥ng c√≥ d·ªØ li·ªáu chi ti·∫øt...</p>
        </div>
    {/if}
</div>

<style>
  .animate-fade-in { animation: fadeIn 0.3s ease-out; }
  @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
</style>

================================================================================
File: src/components/realtime/employee/EmployeeList.svelte
================================================================================

<script>
  import { createEventDispatcher } from 'svelte';
  import { formatters } from '../../../utils/formatters.js';
  import { getSortedDepartmentList } from '../../../utils.js';
  
  // [CODEGENESIS] Import Store & Logic m√†u s·∫Øc m·ªõi
  import { kpiStore } from '../../../stores.js';
  import { getCompletionColor } from '../../../utils/kpi.utils.js';

  export let reportData = [];
  const dispatch = createEventDispatcher();

  let sortKey = 'doanhThu';
  let sortDirection = 'desc';
  let groupedData = {};
  let departmentOrder = [];

  // Reactive statement ƒë·ªÉ nh√≥m d·ªØ li·ªáu
  $: {
      groupedData = {};
      if (reportData && reportData.length > 0) {
          reportData.forEach(item => {
            const dept = item.boPhan || 'Kh√°c';
            if (!groupedData[dept]) groupedData[dept] = [];
            groupedData[dept].push(item);
          });
          departmentOrder = getSortedDepartmentList(reportData);
      } else {
          departmentOrder = [];
      }
  }

  function handleSort(key) {
    if (sortKey === key) {
      sortDirection = sortDirection === 'desc' ? 'asc' : 'desc';
    } else {
      sortKey = key;
      sortDirection = 'desc';
    }
  }

  // S·ª¨A L·ªñI: Th√™m tham s·ªë key v√† dir v√†o h√†m ƒë·ªÉ Svelte nh·∫≠n bi·∫øt s·ª± thay ƒë·ªïi
  function sortEmployees(employees, key, dir) {
    return [...employees].sort((a, b) => {
      if (key === 'hoTen') {
        const nameA = a.hoTen || '';
        const nameB = b.hoTen || '';
        return dir === 'asc' ? nameA.localeCompare(nameB) : nameB.localeCompare(nameA);
      }
      
      // √âp ki·ªÉu s·ªë an to√†n
      let valA = Number(a[key]) || 0;
      let valB = Number(b[key]) || 0;
      
      return dir === 'asc' ? valA - valB : valB - valA;
    });
  }

  function getHeaderDeptClass(deptName) {
    if (deptName.includes('T∆∞ V·∫•n')) return 'bg-blue-100 text-blue-800 border-blue-200';
    if (deptName.includes('Kho')) return 'bg-green-100 text-green-800 border-green-200';
    if (deptName.includes('Trang Tr√≠')) return 'bg-yellow-100 text-yellow-800 border-yellow-200';
    return 'bg-gray-100 text-gray-800 border-gray-200';
  }
</script>

<div class="space-y-8">
  {#each departmentOrder as deptName}
    {#if groupedData[deptName]}
      <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
        <div class="p-4 border-b {getHeaderDeptClass(deptName)}">
          <h4 class="text-lg font-bold uppercase">{deptName}</h4>
        </div>

        <div class="overflow-x-auto">
          <table class="min-w-full text-sm text-left text-gray-600 table-bordered">
            <thead class="text-xs text-slate-800 uppercase bg-slate-200 font-bold sticky top-0 z-20 shadow-sm">
              <tr>
                <th class="px-4 py-3 cursor-pointer hover:bg-slate-300 transition sticky left-0 bg-slate-200 z-30 min-w-[180px] select-none" on:click={() => handleSort('hoTen')}>
                  <div class="flex items-center gap-1">
                    <span>Nh√¢n vi√™n</span>
                    <svg class="w-3 h-3 {sortKey === 'hoTen' ? 'text-blue-600 opacity-100' : 'text-gray-400 opacity-50'}" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="{sortKey === 'hoTen' && sortDirection === 'asc' ? 'M5 15l7-7 7 7' : 'M19 9l-7 7-7-7'}" />
                    </svg>
                  </div>
                </th>
                
                {#each [
                  { id: 'doanhThu', label: 'DT Th·ª±c', group: 'bg-blue-50 text-blue-800' },
                  { id: 'doanhThuQuyDoi', label: 'DT Qƒê', group: 'bg-blue-50 text-blue-800' },
                  { id: 'hieuQuaQuyDoi', label: '% Qƒê', group: 'bg-blue-50 text-blue-800' },
                  { id: 'doanhThuTraGop', label: 'DT Tr·∫£ ch·∫≠m', group: 'bg-green-50 text-green-800' },
                  { id: 'tyLeTraCham', label: '% Tr·∫£ ch·∫≠m', group: 'bg-green-50 text-green-800' },
                  { id: 'doanhThuChuaXuat', label: 'DT Ch∆∞a xu·∫•t', group: 'bg-yellow-50 text-yellow-800' }
                ] as col}
                  <th class="px-4 py-3 cursor-pointer hover:opacity-80 transition select-none {col.group}" on:click={() => handleSort(col.id)}>
                    <div class="flex items-center justify-end gap-1 whitespace-nowrap">
                      <span>{col.label}</span>
                      <svg class="w-3 h-3 {sortKey === col.id ? 'opacity-100' : 'opacity-40'}" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="{sortKey === col.id ? 3 : 2}" d="{sortKey === col.id && sortDirection === 'asc' ? 'M5 15l7-7 7 7' : 'M19 9l-7 7-7-7'}" />
                      </svg>
                    </div>
                  </th>
                {/each}
              </tr>
            </thead>
            <tbody class="divide-y divide-gray-200">
              {#each sortEmployees(groupedData[deptName], sortKey, sortDirection) as item (item.maNV)}
                {@const userTarget = $kpiStore.targets[item.maNV] || $kpiStore.globalSettings}
                {@const targetQD = (userTarget?.phanTramQD || 0) / 100}
                {@const targetTC = (userTarget?.phanTramTC || 0) / 100}

                {@const qdClass = getCompletionColor(item.hieuQuaQuyDoi, targetQD)}
                {@const tcClass = getCompletionColor(item.tyLeTraCham, targetTC)}
                 
                <tr class="hover:bg-blue-50 transition cursor-pointer interactive-row" on:click={() => dispatch('viewDetail', { employeeId: item.maNV })}>
                  <td class="px-4 py-2 font-semibold text-blue-600 sticky left-0 bg-white hover:bg-blue-50 z-10 border-r border-gray-200">
                    {formatters.getShortEmployeeName(item.hoTen, item.maNV)}
                  </td>
                  <td class="px-4 py-2 text-right font-bold text-gray-900">{formatters.formatRevenue(item.doanhThu)}</td>
                  <td class="px-4 py-2 text-right font-bold text-gray-900">{formatters.formatRevenue(item.doanhThuQuyDoi)}</td>
                  
                  <td class="px-4 py-2 text-right font-bold {qdClass}">{formatters.formatPercentage(item.hieuQuaQuyDoi)}</td>
                  
                  <td class="px-4 py-2 text-right font-bold text-gray-900">{formatters.formatRevenue(item.doanhThuTraGop)}</td>
                  
                  <td class="px-4 py-2 text-right font-bold {tcClass}">{formatters.formatPercentage(item.tyLeTraCham)}</td>
                  
                  <td class="px-4 py-2 text-right font-bold text-gray-500">{formatters.formatRevenue(item.doanhThuChuaXuat)}</td>
                </tr>
              {/each}
            </tbody>
          </table>
        </div>
      </div>
    {/if}
  {/each}
</div>

================================================================================
File: src/components/realtime/employee/EmployeeTab.svelte
================================================================================

<script>
  // [FIX] Th√™m import selectedWarehouse
  import { realtimeYCXData, selectedWarehouse } from '../../../stores.js';
  import { reportService } from '../../../services/reportService.js';
  import { settingsService } from '../../../services/settings.service.js';
  
  import EmployeeList from './EmployeeList.svelte';
  import EmployeeDetail from './EmployeeDetail.svelte';

  // [FIX] B·ªè export let selectedWarehouse
  
  let selectedEmployeeId = null;
  let filteredReport = [];

  $: {
    // [FIX] D√πng $selectedWarehouse
    const currentWarehouse = $selectedWarehouse;
    const settings = settingsService.getRealtimeGoalSettings(currentWarehouse);
    const goals = settings.goals || {};
    
    const masterReport = reportService.generateMasterReportData($realtimeYCXData, goals, true);
    
    if (currentWarehouse) {
      filteredReport = masterReport.filter(nv => nv.maKho == currentWarehouse);
    } else {
      filteredReport = masterReport;
    }
    
    console.log(`[EmployeeTab] Report generated for ${filteredReport.length} employees (Warehouse: ${currentWarehouse}).`);
  }

  function handleViewDetail(event) {
    selectedEmployeeId = event.detail.employeeId;
  }

  function handleBack() {
    selectedEmployeeId = null;
  }
</script>

<div class="animate-fade-in">
  {#if selectedEmployeeId}
    <EmployeeDetail 
      employeeId={selectedEmployeeId} 
      on:back={handleBack}
    />
  {:else}
    {#if filteredReport.length > 0}
      <EmployeeList 
        reportData={filteredReport} 
        on:viewDetail={handleViewDetail}
      />
    {:else}
      <div class="p-8 text-center bg-gray-50 rounded-lg border border-gray-200">
       <p class="text-gray-500">Kh√¥ng c√≥ d·ªØ li·ªáu nh√¢n vi√™n n√†o ph√π h·ª£p v·ªõi b·ªô l·ªçc.</p>
      </div>
    {/if}
  {/if}
</div>

================================================================================
File: src/components/realtime/summary/CategoryTable.svelte
================================================================================

<script>
  import { afterUpdate, tick, onMount } from 'svelte';
  import { formatters } from '../../../utils/formatters.js';
  import { cleanCategoryName, getRandomBrightColor } from '../../../utils.js';
  import { datasyncService } from '../../../services/datasync.service.js';
  import { selectedWarehouse, macroCategoryConfig } from '../../../stores.js';
  import { adminService } from '../../../services/admin.service.js';

  export let items = []; 
  export let unexportedItems = []; 
  export let rawSource = []; 

  let showUnexported = false;
  let viewMode = 'grid'; 
  let sortMode = 'revenue_desc';
  let searchText = '';
  
  let isSettingsOpen = false;
  let filterSearch = '';
  let hiddenCategories = new Set(); 
  let isLoadingConfig = false;

  let chartInstancePie = null;
  let chartInstanceBar = null;

  onMount(async () => {
      if (!$macroCategoryConfig || $macroCategoryConfig.length === 0) {
          try {
              if (typeof adminService.loadMacroCategoryConfig === 'function') {
                  const configs = await adminService.loadMacroCategoryConfig();
                  macroCategoryConfig.set(configs);
              }
          } catch (e) { console.error(e); }
      }
  });

  // --- THEME ---
  $: titleText = showUnexported ? "CHI TI·∫æT CH∆ØA XU·∫§T (Qƒê)" : "CHI TI·∫æT NG√ÄNH H√ÄNG";
  $: titleIcon = showUnexported ? "alert-circle" : "layers";
  $: titleClass = showUnexported ? "text-red-700" : "text-blue-700";
  $: iconClass = showUnexported ? "text-red-600" : "text-blue-600";

  function getCategoryTheme(name) {
      const n = name ? name.toLowerCase() : '';
      if (n.includes('ƒëi·ªán t·ª≠') || n.includes('tivi')) return { icon: 'tv', theme: 'theme-teal' };
      if (n.includes('m√°y gi·∫∑t') || n.includes('s·∫•y')) return { icon: 'disc', theme: 'theme-blue' };
      if (n.includes('m√°y l·∫°nh') || n.includes('ƒëi·ªÅu h√≤a')) return { icon: 'wind', theme: 'theme-blue' };
      if (n.includes('t·ªß l·∫°nh') || n.includes('t·ªß ƒë√¥ng')) return { icon: 'server', theme: 'theme-blue' };
      if (n.includes('l·ªçc n∆∞·ªõc')) return { icon: 'droplet', theme: 'theme-blue' };
      if (n.includes('laptop') || n.includes('pc')) return { icon: 'monitor', theme: 'theme-teal' };
      if (n.includes('ƒëi·ªán tho·∫°i') || n.includes('smartphone')) return { icon: 'smartphone', theme: 'theme-blue' };
      if (n.includes('gia d·ª•ng') || n.includes('b·∫øp')) return { icon: 'home', theme: 'theme-orange' };
      if (n.includes('ph·ª• ki·ªán')) return { icon: 'headphones', theme: 'theme-purple' };
      if (n.includes('ƒë·ªìng h·ªì')) return { icon: 'watch', theme: 'theme-gray' };
      return { icon: 'tag', theme: 'theme-gray' };
  }

  // --- CLOUD SYNC ---
  $: if ($selectedWarehouse) {
      loadCloudConfig($selectedWarehouse);
  }

  async function loadCloudConfig(kho) {
      isLoadingConfig = true;
      const hiddenList = await datasyncService.loadRealtimeHiddenCategories(kho);
      hiddenCategories = new Set(hiddenList);
      isLoadingConfig = false;
  }

  async function saveCloudConfig() {
      if ($selectedWarehouse) {
          await datasyncService.saveRealtimeHiddenCategories($selectedWarehouse, [...hiddenCategories]);
      }
  }

  // --- LOGIC AGGREGATION TR·ª∞C TI·∫æP ---
  $: sourceData = showUnexported ? unexportedItems : items;

  $: allGroups = (() => {
      const macroItems = ($macroCategoryConfig || []).map(m => ({
          key: m.name, 
          label: m.name,
          type: 'macro'
      })).sort((a, b) => a.label.localeCompare(b.label));

      const simpleItemsMap = new Map();
      sourceData.forEach((i, index) => {
          const name = i.name || i.nganhHang;
          const safeKey = i.id || name || `unknown_${index}`;
          if (name) {
              simpleItemsMap.set(safeKey, { key: safeKey, label: name, type: 'simple' });
          }
      });
      const simpleItems = Array.from(simpleItemsMap.values()).sort((a, b) => a.label.localeCompare(b.label));

      return [...macroItems, ...simpleItems];
  })();
  
  $: filterList = allGroups.filter(g => 
      g.label.toLowerCase().includes(filterSearch.toLowerCase())
  );

  function toggleCategoryVisibility(key) {
      if (hiddenCategories.has(key)) hiddenCategories.delete(key);
      else hiddenCategories.add(key);
      hiddenCategories = new Set(hiddenCategories);
      saveCloudConfig();
  }

  function toggleAllVisibility(show) {
      hiddenCategories = show ? new Set() : new Set(allGroups.map(g => g.key));
      saveCloudConfig();
  }

  $: aggregatedItems = (() => {
      const result = [];
      const macroConfigs = $macroCategoryConfig || [];

      // A. Macro (Lu√¥n hi·ªán n·∫øu kh√¥ng ·∫©n)
      macroConfigs.forEach(macro => {
          if (!hiddenCategories.has(macro.name)) {
              const keywords = (macro.items || []).map(k => k.toLowerCase());
              const childItems = sourceData.filter(item => {
                  const iName = (item.name || item.nganhHang || '').toLowerCase();
                  const iId = (item.id || '').toLowerCase();
                  return keywords.some(k => iName.includes(k) || iId === k);
              });

              if (childItems.length > 0) {
                  result.push({
                      id: `MACRO_${macro.name}`,
                      name: macro.name,
                      isMacro: true,
                      revenue: childItems.reduce((sum, i) => sum + (i.revenue || 0), 0),
                      doanhThuQuyDoi: childItems.reduce((sum, i) => sum + (i.doanhThuQuyDoi || 0), 0),
                      quantity: childItems.reduce((sum, i) => sum + (i.quantity || i.soLuong || 0), 0),
                      soLuong: childItems.reduce((sum, i) => sum + (i.soLuong || 0), 0)
                  });
              }
          }
      });

      // B. Simple (Lu√¥n hi·ªán n·∫øu kh√¥ng ·∫©n)
      sourceData.forEach((item, index) => {
          const name = item.name || item.nganhHang || 'Ch∆∞a ƒë·∫∑t t√™n';
          const safeId = item.id || name || `ITEM_${index}`;
          
          if (!hiddenCategories.has(safeId) && !hiddenCategories.has(name)) {
              result.push({ 
                  ...item, 
                  id: safeId,
                  name: name,
                  isMacro: false 
              });
          }
      });

      return result;
  })();

  $: filteredItems = aggregatedItems.filter(item => {
      const name = item.name || '';
      return !searchText || name.toLowerCase().includes(searchText.toLowerCase());
  });

  $: sortedItems = [...filteredItems].sort((a, b) => {
      const getRev = (i) => showUnexported ? (i.doanhThuQuyDoi || 0) : (i.revenue || 0);
      const getQty = (i) => showUnexported ? (i.soLuong || 0) : (i.quantity || 0);
      if (sortMode === 'revenue_desc') return getRev(b) - getRev(a);
      if (sortMode === 'quantity_desc') return getQty(b) - getQty(a);
      return 0;
  });

  $: totalRevenue = sourceData.reduce((sum, item) => sum + (showUnexported ? (item.doanhThuQuyDoi || 0) : (item.revenue || 0)), 0);
  $: maxVal = Math.max(...sortedItems.map(i => showUnexported ? (i.doanhThuQuyDoi || 0) : (i.revenue || 0)), 1);

  // --- CHART LOGIC ---
  $: pieData = (() => {
      const sorted = sortedItems.slice(); 
      if (sorted.length <= 14) return sorted;
      const top13 = sorted.slice(0, 13);
      const others = sorted.slice(13);
      const otherRevenue = others.reduce((sum, item) => sum + (showUnexported ? item.doanhThuQuyDoi : item.revenue), 0);
      return [...top13, { name: 'Kh√°c', revenue: otherRevenue, doanhThuQuyDoi: otherRevenue }];
  })();

  // [FIX CHART]
  $: barData = calculateBrandData(rawSource, aggregatedItems, $macroCategoryConfig); 

  function calculateBrandData(source, visibleItems, configs) {
      if (!source || source.length === 0) return [];

      // Bung n√©n danh s√°ch ƒë∆∞·ª£c ph√©p
      const allowedNames = new Set();
      visibleItems.forEach(item => {
          if (item.isMacro) {
              const conf = (configs || []).find(c => c.name === item.name);
              if (conf && conf.items) conf.items.forEach(k => allowedNames.add(cleanCategoryName(k)));
          } else {
              allowedNames.add(cleanCategoryName(item.name || item.nganhHang));
          }
      });

      const brands = {};
      source.forEach(row => {
          const rowCatName = cleanCategoryName(row.nganhHang || '');
          if (allowedNames.has(rowCatName)) {
              const brandName = row.nhaSanXuat || 'Kh√°c';
              const revenue = parseFloat(String(row.thanhTien || "0").replace(/,/g, '')) || 0;
              if (!brands[brandName]) brands[brandName] = { name: brandName, revenue: 0 };
              brands[brandName].revenue += revenue;
          }
      });
      return Object.values(brands).sort((a, b) => b.revenue - a.revenue).slice(0, 15);
  }

  async function renderCharts() {
      if (typeof Chart === 'undefined') return;
      await tick();

      const ctxPie = document.getElementById('rt-cat-chart');
      if (ctxPie) {
          if (chartInstancePie) chartInstancePie.destroy();
          const totalPieRev = pieData.reduce((sum, d) => sum + (showUnexported ? d.doanhThuQuyDoi : d.revenue), 0);
          chartInstancePie = new Chart(ctxPie, {
              type: 'doughnut',
              data: {
                  labels: pieData.map(d => d.name),
                  datasets: [{
                      data: pieData.map(d => showUnexported ? d.doanhThuQuyDoi : d.revenue),
                      backgroundColor: pieData.map(() => getRandomBrightColor()), borderWidth: 1
                  }]
              },
              options: { 
                  responsive: true, maintainAspectRatio: false,
                  plugins: { 
                      legend: { position: 'right', labels: { boxWidth: 10, font: { size: 11 } } },
                      datalabels: {
                          formatter: (value) => {
                              const pct = totalPieRev > 0 ? (value / totalPieRev * 100) : 0;
                              return pct > 3 ? pct.toFixed(1) + "%" : "";
                          },
                          color: '#fff', font: { weight: 'bold', size: 10 }
                      }
                  } 
              },
              plugins: [ChartDataLabels]
          });
      }
      
      const ctxBar = document.getElementById('rt-brand-chart');
      if (ctxBar) {
          if (chartInstanceBar) chartInstanceBar.destroy();
          chartInstanceBar = new Chart(ctxBar, {
              type: 'bar',
              data: {
                  labels: barData.map(d => d.name),
                  datasets: [{
                      label: 'Doanh thu (Tr)',
                      data: barData.map(d => d.revenue / 1000000),
                      backgroundColor: barData.map(() => getRandomBrightColor()), borderRadius: 4
                  }]
              },
              options: {
                  indexAxis: 'y', responsive: true, maintainAspectRatio: false,
                  plugins: {
                      legend: { display: false },
                      datalabels: { anchor: 'end', align: 'end', formatter: (val) => formatters.formatNumber(val, 0), color: '#4b5563', font: { weight: 'bold', size: 10 } },
                      tooltip: { callbacks: { label: (ctx) => formatters.formatRevenue(ctx.raw * 1000000) } }
                  },
                  scales: { x: { beginAtZero: true } }
              },
              plugins: [ChartDataLabels]
          });
      }
  }

  $: if (viewMode === 'chart') setTimeout(renderCharts, 0);

  function handleWindowClick(e) {
      if (isSettingsOpen && !e.target.closest('.filter-wrapper')) {
          isSettingsOpen = false;
      }
  }

  afterUpdate(() => { if (typeof feather !== 'undefined') feather.replace(); });
</script>

<style>
    :global(.filter-dropdown) {
        display: flex;
        flex-direction: column;
        max-height: 400px; 
    }
    :global(.filter-body) {
        flex: 1;
        overflow-y: auto;
        min-height: 0;
    }
    :global(.filter-actions) {
        flex-shrink: 0;
        border-top: 1px solid #eee;
    }
</style>

<svelte:window on:click={handleWindowClick} />

<div class="luyke-widget h-full">
    <div class="luyke-toolbar">
        <div class="luyke-toolbar-left flex-grow min-w-0">
            <h3 class="text-base sm:text-lg font-bold uppercase flex items-center gap-2 {titleClass} truncate">
                <i data-feather={titleIcon} class="{iconClass} flex-shrink-0"></i>
                <span class="truncate">{titleText}</span>
            </h3>
        </div>

        <div class="luyke-toolbar-right flex items-center gap-2">
            <div class="flex bg-gray-100 p-0.5 rounded-lg border border-gray-200">
                <button class="view-mode-btn {viewMode === 'grid' ? 'active' : ''}" on:click={() => viewMode = 'grid'}><i data-feather="grid" class="w-4 h-4"></i></button>
                <button class="view-mode-btn {viewMode === 'table' ? 'active' : ''}" on:click={() => viewMode = 'table'}><i data-feather="list" class="w-4 h-4"></i></button>
                <button class="view-mode-btn {viewMode === 'chart' ? 'active' : ''}" on:click={() => viewMode = 'chart'}><i data-feather="pie-chart" class="w-4 h-4"></i></button>
            </div>

            <div class="toggle-wrapper {showUnexported ? 'active' : ''}" on:click={() => showUnexported = !showUnexported} style="padding: 4px 8px;">
                <div class="toggle-switch" style="width: 28px; height: 16px;"></div>
                <span class="toggle-label text-xs whitespace-nowrap">Ch∆∞a xu·∫•t</span>
            </div>

            <div class="relative filter-wrapper">
                <button class="luyke-icon-btn {isSettingsOpen ? 'active' : ''}" on:click={() => isSettingsOpen = !isSettingsOpen}>
                    {#if isLoadingConfig}<div class="w-4 h-4 border-2 border-blue-600 border-t-transparent rounded-full animate-spin"></div>{:else}<i data-feather="filter" class="w-4 h-4"></i>{/if}
                </button>

                {#if isSettingsOpen}
                    <div class="filter-dropdown">
                        <div class="filter-header">
                            <input type="text" class="filter-search" placeholder="T√¨m ng√†nh h√†ng..." bind:value={filterSearch} />
                        </div>
                        <div class="filter-body custom-scrollbar">
                            {#if filterList.length === 0}
                                <p class="text-xs text-gray-500 text-center p-2">Kh√¥ng t√¨m th·∫•y.</p>
                            {:else}
                                {#each filterList as group (group.key)}
                                    <div class="filter-item" on:click={() => toggleCategoryVisibility(group.key)}>
                                        <input type="checkbox" checked={!hiddenCategories.has(group.key)} />
                                        {#if group.type === 'macro'}
                                            <label class="text-teal-700 font-bold text-xs flex items-center gap-1 flex-1">
                                                <i data-feather="layers" class="w-3 h-3"></i> {group.label}
                                            </label>
                                        {:else}
                                            <label class="text-gray-700 text-xs flex-1 truncate" title={group.label}>{group.label}</label>
                                        {/if}
                                    </div>
                                {/each}
                            {/if}
                        </div>
                        <div class="filter-actions">
                            <button class="filter-btn-link" on:click={() => toggleAllVisibility(true)}>Hi·ªán t·∫•t c·∫£</button>
                            <button class="filter-btn-link text-red-600" on:click={() => toggleAllVisibility(false)}>·∫®n t·∫•t c·∫£</button>
                        </div>
                    </div>
                {/if}
            </div>
        </div>
    </div>

    <div class="luyke-widget-body bg-white border-t border-gray-100 p-4">
        {#if sortedItems.length === 0}
            <div class="text-center py-10 text-gray-400 italic">Kh√¥ng c√≥ d·ªØ li·ªáu hi·ªÉn th·ªã.</div>
        
        {:else if viewMode === 'grid'}
            <div class="luyke-cat-grid">
                {#each sortedItems as item (item.id)}
                    {@const name = item.name}
                    {@const revenue = showUnexported ? item.doanhThuQuyDoi : item.revenue}
                    {@const quantity = showUnexported ? item.soLuong : item.quantity}
                    {@const style = getCategoryTheme(name)}
                    {@const percent = maxVal > 0 ? (revenue / maxVal) * 100 : 0}
                    
                    {@const finalTheme = showUnexported ? 'theme-warning' : (item.isMacro ? 'bg-indigo-50 border-indigo-200 ring-1 ring-indigo-100' : style.theme)}
                    {@const iconName = item.isMacro ? 'layers' : style.icon}
                    {@const textColor = item.isMacro ? 'text-indigo-800' : ''}

                    <div class="cat-card-colorful {finalTheme}">
                        <div class="cat-top-row">
                            <div class="cat-icon-box {item.isMacro ? 'bg-indigo-100 text-indigo-600' : ''}">
                                <i data-feather={iconName} class="w-5 h-5"></i>
                            </div>
                            {#if !showUnexported && totalRevenue > 0}
                                <span class="cat-percent-text text-xs {item.isMacro ? 'text-indigo-600' : ''}">
                                    {formatters.formatPercentage(revenue/totalRevenue)}
                                </span>
                            {/if}
                        </div>
                        
                        <h4 class="cat-name-text {textColor}" title={name}>
                            {name} 
                            {#if item.isMacro}<span class="text-[10px] bg-white border px-1 rounded text-gray-500 ml-1 font-normal">G·ªòP</span>{/if}
                        </h4>
                        
                        <div class="cat-value-text {textColor}">{formatters.formatRevenue(revenue, 0)}</div>
                        
                        <div class="cat-footer-row">
                            <span>SL: <strong>{formatters.formatNumber(quantity)}</strong></span>
                        </div>
                        
                        <div class="cat-bar-bg">
                            <div class="cat-bar-fill {item.isMacro ? 'bg-indigo-500' : ''}" style="width: {percent}%"></div>
                        </div>
                    </div>
                {/each}
            </div>

        {:else if viewMode === 'table'}
            <div class="overflow-x-auto">
                <table class="w-full text-sm table-bordered">
                    <thead class="bg-gray-100 font-bold text-gray-700">
                        <tr>
                            <th class="px-3 py-2 text-left">Ng√†nh h√†ng</th>
                            <th class="px-3 py-2 text-right">SL</th>
                            <th class="px-3 py-2 text-right">Doanh thu</th>
                            {#if showUnexported}<th class="px-3 py-2 text-right">DT Th·ª±c</th>{/if}
                        </tr>
                    </thead>
                    <tbody>
                        {#each sortedItems as item (item.id)}
                            <tr class="hover:bg-gray-50 {item.isMacro ? 'bg-indigo-50/50' : ''}">
                                <td class="px-3 py-2 {item.isMacro ? 'font-bold text-indigo-800' : ''}">{item.name}</td>
                                <td class="px-3 py-2 text-right font-bold">{formatters.formatNumber(showUnexported ? item.soLuong : item.quantity)}</td>
                                <td class="px-3 py-2 text-right font-bold text-blue-600">{formatters.formatRevenue(showUnexported ? item.doanhThuQuyDoi : item.revenue)}</td>
                                {#if showUnexported}
                                    <td class="px-3 py-2 text-right text-gray-500">{formatters.formatRevenue(item.doanhThuThuc)}</td>
                                {/if}
                            </tr>
                        {/each}
                    </tbody>
                </table>
            </div>

        {:else}
            <div class="luyke-charts-container p-0 border-0 rounded-none">
                <div class="chart-box">
                    <h4 class="text-sm font-bold text-gray-700 mb-2 text-center">T·ª∑ tr·ªçng Doanh Thu (Tri·ªáu)</h4>
                    <div class="relative h-full w-full"><canvas id="rt-cat-chart"></canvas></div>
                </div>
                <div class="chart-box">
                    <h4 class="text-sm font-bold text-gray-700 mb-2 text-center">Top 15 H√£ng (Tri·ªáu)</h4>
                    <div class="relative h-full w-full"><canvas id="rt-brand-chart"></canvas></div>
                </div>
            </div>
        {/if}
    </div>
</div>

================================================================================
File: src/components/realtime/summary/EfficiencyTable.svelte
================================================================================

<script>
  import { formatters } from '../../../utils/formatters.js';
  import SortableTh from '../../common/SortableTh.svelte';

  export let items = []; 

  let sortKey = 'label';
  let sortDirection = 'asc';

  function handleSort(event) {
    const key = event.detail;
    if (sortKey === key) {
      sortDirection = sortDirection === 'desc' ? 'asc' : 'desc';
    } else {
      sortKey = key;
      sortDirection = 'desc';
    }
  }

  $: sortedItems = [...items].sort((a, b) => {
    let valA, valB;

    if (sortKey === 'label') {
        valA = a.label || '';
        valB = b.label || '';
        return sortDirection === 'asc' ? valA.localeCompare(valB) : valB.localeCompare(valA);
    } 
    
    valA = a[sortKey] || 0;
    valB = b[sortKey] || 0;
    return sortDirection === 'asc' ? valA - valB : valB - valA;
  });
</script>

<div class="bg-white rounded-xl shadow-md p-4 border border-gray-200 h-full">
  <h3 class="text-lg font-bold text-gray-700 mb-4 uppercase border-b pb-2 bg-yellow-50 p-2 rounded">Hi·ªáu qu·∫£ khai th√°c</h3>

  {#if items.length === 0}
    <p class="text-gray-500 font-bold p-4 text-center">Vui l√≤ng t·∫£i file realtime ƒë·ªÉ xem chi ti·∫øt.</p>
  {:else}
    <div class="overflow-x-auto">
      <table class="min-w-full text-sm table-bordered">
        <thead class="text-xs text-slate-800 uppercase bg-slate-200 font-bold">
          <tr>
            <SortableTh key="label" label="Ch·ªâ s·ªë" align="left" {sortKey} {sortDirection} on:sort={handleSort} />
            <SortableTh key="value" label="Th·ª±c hi·ªán" align="right" {sortKey} {sortDirection} on:sort={handleSort} />
            <SortableTh key="target" label="M·ª•c ti√™u" align="right" {sortKey} {sortDirection} on:sort={handleSort} />
          </tr>
        </thead>
        <tbody>
          {#each sortedItems as item (item.id)}
            {@const isBelow = item.value < ((item.target || 0) / 100)}
            <tr class="border-t hover:bg-gray-50">
              <td class="px-4 py-2 font-semibold text-gray-800">{item.label}</td>
              <td class="px-4 py-2 text-right font-bold text-lg {isBelow ? 'bg-red-100 text-red-700' : 'text-blue-600'}">
                {formatters.formatPercentage(item.value)}
              </td>
              <td class="px-4 py-2 text-right text-gray-600">{item.target || 0}%</td>
            </tr>
          {/each}
        </tbody>
      </table>
    </div>
  {/if}
</div>

================================================================================
File: src/components/realtime/summary/KpiCards.svelte
================================================================================

<script>
  import { formatters } from '../../../utils/formatters.js';

  export let supermarketReport = {};
  export let goals = {};

  // Reactive variables ƒë·ªÉ hi·ªÉn th·ªã
  $: doanhThu = supermarketReport.doanhThu || 0;
  $: doanhThuQD = supermarketReport.doanhThuQuyDoi || 0;
  $: doanhThuTraGop = supermarketReport.doanhThuTraGop || 0;
  $: doanhThuChuaXuat = supermarketReport.doanhThuChuaXuat || 0;
  $: doanhThuQDChuaXuat = supermarketReport.doanhThuQuyDoiChuaXuat || 0;
  
  $: hieuQuaQuyDoi = supermarketReport.hieuQuaQuyDoi || 0;
  $: tyLeTraCham = supermarketReport.tyLeTraCham || 0;

  // M·ª•c ti√™u
  $: targetDTT = parseFloat(goals?.doanhThuThuc) || 0;
  $: targetDTQD = parseFloat(goals?.doanhThuQD) || 0;
  $: targetTLQD = parseFloat(goals?.phanTramQD) || 0;

  // T√≠nh % Ho√†n th√†nh
  $: percentDTT = targetDTT > 0 ? ((doanhThu / 1000000) / targetDTT) : 0;
  $: percentDTQD = targetDTQD > 0 ? ((doanhThuQD / 1000000) / targetDTQD) : 0;

</script>

<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
  <div class="kpi-card p-6 rounded-2xl shadow-lg bg-[#38bdf8]">
    <h4 class="kpi-card-title font-semibold uppercase tracking-wider text-white opacity-90">Doanh thu th·ª±c</h4>
    <p class="font-bold mt-2 mb-3 text-white text-4xl">
      {formatters.formatNumber(doanhThu / 1000000, 1)}
    </p>
    <div class="text-sm text-white opacity-90">
      <p>% HT: <span class="font-bold">{formatters.formatPercentage(percentDTT)}</span> / Target: {formatters.formatNumber(targetDTT)}</p>
      <p class="mt-1 text-xs border-t border-white/30 pt-1">DT Ch∆∞a xu·∫•t: <strong>{formatters.formatNumber(doanhThuChuaXuat / 1000000, 1)}</strong></p>
    </div>
  </div>

  <div class="kpi-card p-6 rounded-2xl shadow-lg bg-[#34d399]">
    <h4 class="kpi-card-title font-semibold uppercase tracking-wider text-white opacity-90">Doanh thu Quy ƒë·ªïi</h4>
    <p class="font-bold mt-2 mb-3 text-white text-4xl">
      {formatters.formatNumber(doanhThuQD / 1000000, 1)}
    </p>
    <div class="text-sm text-white opacity-90">
      <p>% HT: <span class="font-bold">{formatters.formatPercentage(percentDTQD)}</span> / Target: {formatters.formatNumber(targetDTQD)}</p>
      <p class="mt-1 text-xs border-t border-white/30 pt-1">DTQƒê Ch∆∞a xu·∫•t: <strong>{formatters.formatNumber(doanhThuQDChuaXuat / 1000000, 1)}</strong></p>
    </div>
  </div>

  <div class="kpi-card p-6 rounded-2xl shadow-lg bg-[#fbbf24]">
    <h4 class="kpi-card-title font-semibold uppercase tracking-wider text-white opacity-90">T·ª∑ l·ªá quy ƒë·ªïi</h4>
    <p class="font-bold mt-2 mb-3 text-white text-4xl">
      {formatters.formatPercentage(hieuQuaQuyDoi)}
    </p>
    <div class="text-sm text-white opacity-90">
      <p>M·ª•c ti√™u: <span class="font-bold">{formatters.formatNumber(targetTLQD)}%</span></p>
      <p class="mt-1 text-xs italic">So v·ªõi doanh thu th·ª±c</p>
    </div>
  </div>

  <div class="kpi-card p-6 rounded-2xl shadow-lg bg-[#2dd4bf]">
    <h4 class="kpi-card-title font-semibold uppercase tracking-wider text-white opacity-90">Doanh thu tr·∫£ ch·∫≠m</h4>
    <p class="font-bold mt-2 mb-3 text-white text-4xl">
      {formatters.formatNumber(doanhThuTraGop / 1000000, 1)}
    </p>
    <div class="text-sm text-white opacity-90">
      <p>% th·ª±c tr·∫£ ch·∫≠m: <span class="font-bold">{formatters.formatPercentage(tyLeTraCham)}</span></p>
      <p class="mt-1 text-xs italic">Tr√™n t·ªïng doanh thu</p>
    </div>
  </div>
</div>

<style>
  .kpi-card {
    transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
  }
  .kpi-card:hover {
    transform: translateY(-4px);
    box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
  }
</style>

================================================================================
File: src/components/realtime/summary/QdcTable.svelte
================================================================================

<script>
  import { onMount, afterUpdate } from 'svelte';
  import { formatters } from '../../../utils/formatters.js';
  import { cleanCategoryName } from '../../../utils.js';
  import { 
      categoryStructure, 
      macroProductGroupConfig, 
      selectedWarehouse 
  } from '../../../stores.js';
  import { datasyncService } from '../../../services/datasync.service.js';
  import { adminService } from '../../../services/admin.service.js';

  export let items = []; 
  export let numDays = 1;

  let isSettingsOpen = false;
  let filterSearch = '';
  let saveTimer;
  let localConfig = []; 

  // B·∫£ng m√†u r·ª±c r·ª° cho thanh ti·∫øn tr√¨nh
  const BAR_COLORS = [
      'bg-red-500', 'bg-orange-500', 'bg-amber-500', 'bg-yellow-400',
      'bg-lime-500', 'bg-green-500', 'bg-emerald-500', 'bg-teal-500',
      'bg-cyan-500', 'bg-sky-500', 'bg-blue-500', 'bg-indigo-500',
      'bg-violet-500', 'bg-fuchsia-500', 'bg-pink-500', 'bg-rose-500'
  ];

  // 1. Load config Nh√≥m H√†ng L·ªõn n·∫øu ch∆∞a c√≥
  onMount(async () => {
      if (!$macroProductGroupConfig || $macroProductGroupConfig.length === 0) {
          try {
              const configs = await adminService.loadMacroProductGroupConfig();
              macroProductGroupConfig.set(configs);
          } catch (e) {
              console.error("L·ªói load Macro Product Groups:", e);
          }
      }
  });

  // 2. T·∫°o danh s√°ch Filter (∆Øu ti√™n Nh√≥m L·ªõn l√™n ƒë·∫ßu)
  $: allGroups = (() => {
      // A. Nh√≥m L·ªõn
      const macroNames = ($macroProductGroupConfig || []).map(m => ({
          name: m.name,
          type: 'macro'
      })).sort((a, b) => a.name.localeCompare(b.name));

      // B. Nh√≥m Th∆∞·ªùng
      const structureNames = new Set(($categoryStructure || []).map(c => cleanCategoryName(c.nhomHang)).filter(Boolean));
      const presentNames = new Set(items.map(i => i.name).filter(Boolean));
      
      const simpleNames = [...new Set([...structureNames, ...presentNames])]
          .sort()
          .map(name => ({
              name: name,
              type: 'simple'
          }));

      return [...macroNames, ...simpleNames];
  })();

  $: filterList = allGroups.filter(g => 
      g.name.toLowerCase().includes(filterSearch.toLowerCase())
  );

  // 3. Logic Load/Save Config (D√πng chung config v·ªõi L≈©y k·∫ø ƒë·ªÉ ƒë·ªìng b·ªô tr·∫£i nghi·ªám)
  $: if ($selectedWarehouse) {
      loadConfigForWarehouse($selectedWarehouse);
  } else {
      localConfig = allGroups.map(g => g.name);
  }

  async function loadConfigForWarehouse(kho) {
      try {
          const savedConfig = await datasyncService.loadQdcConfig(kho);
          if (savedConfig && Array.isArray(savedConfig)) {
              localConfig = savedConfig;
          } else {
              localConfig = allGroups.map(g => g.name);
          }
      } catch (e) {
          localConfig = allGroups.map(g => g.name);
      }
  }

  function toggleQdcSelection(name) {
      if (localConfig.includes(name)) {
          localConfig = localConfig.filter(n => n !== name);
      } else {
          localConfig = [...localConfig, name];
      }
      
      clearTimeout(saveTimer);
      saveTimer = setTimeout(() => {
          if ($selectedWarehouse) {
              datasyncService.saveQdcConfig($selectedWarehouse, localConfig);
          }
      }, 500); 
  }

  function toggleAllVisibility(show) {
      if (show) {
          localConfig = allGroups.map(g => g.name);
      } else {
          localConfig = [];
      }
      if ($selectedWarehouse) {
         datasyncService.saveQdcConfig($selectedWarehouse, localConfig);
      }
  }

  // 4. Aggregation Logic (C·ªông g·ªôp Nh√≥m L·ªõn)
  $: sortedItems = (() => {
      if (localConfig.length === 0) return [];

      let finalResults = [];
      const macroConfigs = $macroProductGroupConfig || [];
      
      const selectedMacros = localConfig.filter(name => macroConfigs.some(m => m.name === name));
      const selectedSimples = localConfig.filter(name => !macroConfigs.some(m => m.name === name));

      // A. X·ª≠ l√Ω Macro Group
      selectedMacros.forEach(macroName => {
          const config = macroConfigs.find(m => m.name === macroName);
          if (!config) return;

          const childIds = new Set(config.items || []);
          const childItems = items.filter(i => childIds.has(i.id));

          if (childItems.length > 0) {
              // T√≠nh t·ªïng (H·ªó tr·ª£ c·∫£ field Realtime v√† Luyke)
              const aggregatedItem = {
                  id: config.id, 
                  name: config.name,
                  isMacro: true, 
                  dtqd: childItems.reduce((sum, i) => sum + (i.dtqd || i.revenueQuyDoi || 0), 0),
                  dt: childItems.reduce((sum, i) => sum + (i.dt || i.revenue || 0), 0),
                  quantity: childItems.reduce((sum, i) => sum + (i.quantity || i.soLuong || i.sl || 0), 0),
                  _children: childItems 
              };
              finalResults.push(aggregatedItem);
          } 
      });

      // B. X·ª≠ l√Ω Simple Items
      selectedSimples.forEach(simpleName => {
          const item = items.find(i => i.name === simpleName);
          if (item) {
              // Chu·∫©n h√≥a data field n·∫øu c·∫ßn ƒë·ªÉ hi·ªÉn th·ªã th·ªëng nh·∫•t
              finalResults.push({ 
                  ...item, 
                  dtqd: (item.dtqd || item.revenueQuyDoi || 0),
                  dt: (item.dt || item.revenue || 0),
                  quantity: (item.quantity || item.soLuong || item.sl || 0),
                  isMacro: false 
              });
          }
      });

      // S·∫Øp x·∫øp gi·∫£m d·∫ßn theo doanh thu Qƒê
      return finalResults.sort((a, b) => (b.dtqd || 0) - (a.dtqd || 0));
  })();

  $: maxVal = sortedItems.length > 0 ? (sortedItems[0].dtqd || 1) : 1;

  function handleWindowClick(e) {
      if (isSettingsOpen && !e.target.closest('.filter-wrapper')) {
          isSettingsOpen = false;
      }
  }

  afterUpdate(() => {
    if (typeof feather !== 'undefined') feather.replace();
  });
</script>

<svelte:window on:click={handleWindowClick} />

<div class="bg-white rounded-xl shadow-md border border-gray-200 overflow-hidden h-full flex flex-col">
  <div class="p-3 border-b border-gray-100 flex justify-between items-center bg-gray-50/50">
    <div class="flex items-center gap-2 font-bold text-slate-700 text-sm uppercase">
      <div class="p-1.5 bg-blue-100 rounded text-blue-600">
          <i data-feather="zap" class="w-4 h-4"></i>
      </div>
      <span>TOP NH√ìM H√ÄNG</span>
    </div>

    <div class="relative filter-wrapper">
        <button class="p-1.5 hover:bg-gray-100 rounded text-gray-500 transition-colors {isSettingsOpen ? 'bg-blue-50 text-blue-600' : ''}" on:click={() => isSettingsOpen = !isSettingsOpen} title="Ch·ªçn nh√≥m h√†ng">
             <i data-feather="filter" class="w-4 h-4"></i>
        </button>
        {#if isSettingsOpen}
            <div class="absolute right-0 top-full mt-2 w-64 bg-white rounded-lg shadow-xl border border-gray-200 z-50 flex flex-col overflow-hidden">
                <div class="p-2 border-b border-gray-100 bg-gray-50">
                    <input type="text" class="w-full p-1.5 text-xs border border-gray-300 rounded focus:border-blue-500 outline-none" placeholder="T√¨m nh√≥m h√†ng..." bind:value={filterSearch} />
                </div>
                <div class="overflow-y-auto custom-scrollbar p-1" style="max-height: 250px;">
                    {#if filterList.length === 0}
                         <p class="text-xs text-gray-500 text-center p-2">Kh√¥ng t√¨m th·∫•y.</p>
                    {:else}
                        {#each filterList as group}
                            {@const isChecked = localConfig.includes(group.name)}
                            <div class="flex items-center gap-2 p-2 hover:bg-gray-50 rounded cursor-pointer" on:click={() => toggleQdcSelection(group.name)}>
                                 <input type="checkbox" checked={isChecked} class="rounded text-blue-600 focus:ring-blue-500" />
                                 {#if group.type === 'macro'}
                                    <label class="{isChecked ? 'font-bold text-teal-700' : 'text-teal-600 font-semibold'} text-xs flex items-center gap-1 cursor-pointer flex-1">
                                        <i data-feather="layers" class="w-3 h-3"></i>
                                        {group.name}
                                    </label>
                                 {:else}
                                    <label class="{isChecked ? 'font-bold text-blue-700' : 'text-gray-700'} text-xs cursor-pointer flex-1">{group.name}</label>
                                 {/if}
                            </div>
                        {/each}
                    {/if}
                 </div>
                <div class="p-2 border-t border-gray-100 bg-gray-50 flex justify-between text-xs">
                    <button class="text-blue-600 font-semibold hover:underline" on:click={() => toggleAllVisibility(true)}>Hi·ªán t·∫•t c·∫£</button>
                    <button class="text-red-600 font-semibold hover:underline" on:click={() => toggleAllVisibility(false)}>·∫®n t·∫•t c·∫£</button>
                </div>
            </div>
        {/if}
    </div>
  </div>

  <div class="custom-scrollbar flex-1 overflow-y-auto p-2">
    {#if sortedItems.length === 0}
        <div class="flex flex-col items-center justify-center h-full text-gray-400 py-10">
          <p class="text-sm">Kh√¥ng c√≥ d·ªØ li·ªáu hi·ªÉn th·ªã.</p>
          {#if items.length > 0}
             <p class="text-xs mt-1">H√£y ki·ªÉm tra b·ªô l·ªçc nh√≥m h√†ng.</p>
          {/if}
       </div>
    {:else}
      <div class="flex flex-col gap-0">
        {#each sortedItems as item, index (item.name)}
          {@const percent = maxVal > 0 ? (item.dtqd / maxVal) * 100 : 0}
          
          {@const barColor = BAR_COLORS[index % BAR_COLORS.length]}
          
          <div class="py-2.5 border-b border-dashed border-gray-100 last:border-0 transition-colors px-1.5 rounded
                      {item.isMacro ? 'bg-teal-50/40 hover:bg-teal-50/60' : 'hover:bg-gray-50'}">
            
            <div class="flex items-center gap-3">
               <div class="w-6 text-center font-bold text-gray-400 text-xs">#{index + 1}</div>
               
               <div class="flex-grow min-w-0">
                   <div class="flex justify-between items-center mb-1.5">
                       <span class="text-sm font-semibold truncate pr-2 flex items-center gap-1.5 {item.isMacro ? 'text-teal-800' : 'text-slate-700'}" title={item.name}>
                           {#if item.isMacro}
                                <i data-feather="layers" class="w-3.5 h-3.5 text-teal-600"></i>
                           {/if}
                           {item.name}
                       </span>
                       <span class="text-sm font-bold whitespace-nowrap text-slate-800">
                           {formatters.formatRevenue(item.dtqd)}
                       </span>
                   </div>
                   
                   <div class="w-full h-2 bg-gray-100 rounded-full overflow-hidden mb-1.5 shadow-inner">
                        <div class="h-full rounded-full {barColor} shadow-sm transition-all duration-500 ease-out" style="width: {percent}%"></div>
                   </div>
                   
                   <div class="flex justify-between text-[10px] text-gray-500 flex-wrap gap-y-1 font-medium">
                       <div class="flex gap-3">
                           <span>DT: <strong class="text-slate-600">{formatters.formatRevenue(item.dt)}</strong></span>
                           <span class="{item.isMacro ? 'text-teal-600' : 'text-blue-600'}">Qƒê: <strong>{formatters.formatRevenue(item.dtqd)}</strong></span>
                       </div>
                       <div class="flex gap-3">
                           <span>SL: {formatters.formatNumber(item.quantity)}</span>
                           {#if numDays > 1}
                                <span>TB: <strong>{formatters.formatNumber(item.quantity / numDays, 0)}</strong>/ng√†y</span>
                           {/if}
                       </div>
                    </div>
               </div>
            </div>
          </div>
        {/each}
      </div>
    {/if}
  </div>
</div>

<style>
    .custom-scrollbar::-webkit-scrollbar { width: 6px; }
    .custom-scrollbar::-webkit-scrollbar-track { background: #f1f1f1; }
    .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
    .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
</style>

================================================================================
File: src/components/realtime/summary/SummaryTab.svelte
================================================================================

<script>
  import { 
    realtimeYCXData, 
    selectedWarehouse, 
    efficiencyConfig, 
    warehouseCustomMetrics 
  } from '../../../stores.js';
  import { reportService } from '../../../services/reportService.js';
  import { settingsService } from '../../../services/settings.service.js';
  import { formatters } from '../../../utils/formatters.js';
  import { datasyncService } from '../../../services/datasync.service.js';
  import { adminService } from '../../../services/admin.service.js';
  
  import QdcTable from './QdcTable.svelte';
  import CategoryTable from './CategoryTable.svelte';
  import EfficiencyTable from '../efficiency/EfficiencyTable.svelte';
  import { onMount } from 'svelte';

  let supermarketReport = {};
  let goals = {};
  
  let qdcItems = [];
  let categoryItems = [];
  let unexportedItems = []; 
  let rawSourceData = [];

  let combinedEfficiencyItems = [];

  onMount(async () => {
      const globalConfig = await adminService.loadEfficiencyConfig();
      efficiencyConfig.set(globalConfig);
  });

  $: if ($selectedWarehouse) {
      loadLocalMetrics($selectedWarehouse);
  }

  async function loadLocalMetrics(kho) {
      const localData = await datasyncService.loadCustomMetrics(kho);
      warehouseCustomMetrics.set(localData);
  }

  $: combinedEfficiencyItems = [
      ...($efficiencyConfig || []).map(i => ({ ...i, isSystem: true })),
      ...($warehouseCustomMetrics || []).map(i => ({ ...i, isSystem: false }))
  ];

  async function handleDeleteMetric(event) {
      const id = event.detail;
      const item = combinedEfficiencyItems.find(i => i.id === id);
      
      if (item && item.isSystem) {
          alert("ƒê√¢y l√† ch·ªâ s·ªë h·ªá th·ªëng, b·∫°n kh√¥ng th·ªÉ x√≥a. H√£y d√πng b·ªô l·ªçc ƒë·ªÉ ·∫©n n√≥ ƒëi.");
          return;
      }

      if (confirm("X√≥a ch·ªâ s·ªë c√° nh√¢n n√†y?")) {
          const newLocalMetrics = $warehouseCustomMetrics.filter(i => i.id !== id);
          warehouseCustomMetrics.set(newLocalMetrics);
          if ($selectedWarehouse) {
              await datasyncService.saveCustomMetrics($selectedWarehouse, newLocalMetrics);
          }
      }
  }

  $: {
    const currentWarehouse = $selectedWarehouse;
    const settings = settingsService.getRealtimeGoalSettings(currentWarehouse);
    goals = settings.goals || {};

    const masterReport = reportService.generateMasterReportData($realtimeYCXData, goals, true);
    
    let filteredReport = masterReport;
    let filteredRawData = $realtimeYCXData;

    if (currentWarehouse) {
      filteredReport = masterReport.filter(nv => nv.maKho == currentWarehouse);
      const visibleEmployees = new Set(filteredReport.map(nv => String(nv.maNV)));
      filteredRawData = $realtimeYCXData.filter(row => {
          const msnvMatch = String(row.nguoiTao || '').match(/(\d+)/);
          return msnvMatch && visibleEmployees.has(msnvMatch[1].trim());
      });
    }
    
    rawSourceData = filteredRawData;

    supermarketReport = reportService.aggregateReport(filteredReport, currentWarehouse);

    qdcItems = supermarketReport.nhomHangChiTiet 
        ? Object.entries(supermarketReport.nhomHangChiTiet)
            .map(([name, values]) => ({
                id: name,
                name,
                dtqd: values.revenueQuyDoi,
                sl: values.quantity,
                dt: values.revenue,
                ...values
            }))
            .filter(i => i.sl > 0 || i.dt > 0) 
        : [];

    categoryItems = supermarketReport.nganhHangChiTiet 
        ? Object.values(supermarketReport.nganhHangChiTiet).filter(i => i.revenue > 0 || i.quantity > 0)
        : [];

    unexportedItems = reportService.generateRealtimeChuaXuatReport(filteredRawData);
  }

  $: pctDTT = (parseFloat(goals?.doanhThuThuc) || 0) > 0 ? (supermarketReport.doanhThu / 1000000) / parseFloat(goals.doanhThuThuc) : 0;
  $: pctDTQD = (parseFloat(goals?.doanhThuQD) || 0) > 0 ? (supermarketReport.doanhThuQuyDoi / 1000000) / parseFloat(goals.doanhThuQD) : 0;
</script>

<div class="luyke-dashboard-container pb-10">
  
  <h2 id="realtime-supermarket-title" class="text-2xl font-bold text-gray-800 flex items-center justify-center gap-2">
    <i data-feather="zap" class="text-yellow-500 fill-current"></i>
    B√°o c√°o Realtime {$selectedWarehouse ? `- Kho ${$selectedWarehouse}` : '(To√†n b·ªô)'}
    <span class="text-sm font-normal text-gray-500 ml-2 pt-1">
      (C·∫≠p nh·∫≠t: {new Date().toLocaleTimeString('vi-VN')})
    </span>
  </h2>

  <div id="realtime-kpi-cards-container" class="kpi-grid-fixed">
      <div class="kpi-card-solid card-1">
          <div class="kpi-solid-header">Doanh Thu Th·ª±c <i data-feather="dollar-sign"></i></div>
          <div class="kpi-solid-value">{formatters.formatNumber((supermarketReport.doanhThu || 0) / 1000000, 1)}</div>
          <div class="kpi-solid-sub">
              <span>% HT: {formatters.formatPercentage(pctDTT)}</span>
              <span>MT: {formatters.formatNumber(goals?.doanhThuThuc || 0)}</span>
          </div>
          <div class="kpi-bg-icon"><i data-feather="dollar-sign"></i></div>
      </div>

      <div class="kpi-card-solid card-2">
          <div class="kpi-solid-header">DT Quy ƒê·ªïi <i data-feather="refresh-cw"></i></div>
          <div class="kpi-solid-value">{formatters.formatNumber((supermarketReport.doanhThuQuyDoi || 0) / 1000000, 1)}</div>
          <div class="kpi-solid-sub">
              <span>% HT: {formatters.formatPercentage(pctDTQD)}</span>
              <span>MT: {formatters.formatNumber(goals?.doanhThuQD || 0)}</span>
          </div>
          <div class="kpi-bg-icon"><i data-feather="refresh-cw"></i></div>
      </div>

      <div class="kpi-card-solid card-3">
          <div class="kpi-solid-header">T·ª∑ l·ªá Quy ƒê·ªïi <i data-feather="trending-up"></i></div>
          <div class="kpi-solid-value">{formatters.formatPercentage(supermarketReport.hieuQuaQuyDoi || 0)}</div>
          <div class="kpi-solid-sub">
              <span>M·ª•c ti√™u: {formatters.formatNumber(goals?.phanTramQD || 0)}%</span>
          </div>
          <div class="kpi-bg-icon"><i data-feather="trending-up"></i></div>
      </div>

      <div class="kpi-card-solid card-4">
          <div class="kpi-solid-header">Tr·∫£ Ch·∫≠m <i data-feather="credit-card"></i></div>
          <div class="kpi-solid-value">{formatters.formatPercentage(supermarketReport.tyLeTraCham || 0)}</div>
          <div class="kpi-solid-sub">
              <span>Doanh s·ªë: {formatters.formatNumber((supermarketReport.doanhThuTraGop || 0) / 1000000, 1)}</span>
          </div>
          <div class="kpi-bg-icon"><i data-feather="credit-card"></i></div>
      </div>
  </div>

  <div class="luyke-tier-1-grid">
      <EfficiencyTable 
          supermarketData={supermarketReport} 
          dynamicItems={combinedEfficiencyItems} 
          items={[]} 
          goals={goals}
          on:delete={handleDeleteMetric}
      />
      <QdcTable items={qdcItems} />
  </div>

  <div>
      <CategoryTable 
          items={categoryItems} 
          unexportedItems={unexportedItems}
          rawSource={rawSourceData}
      />
  </div>

</div>

================================================================================
File: src/components/realtime/summary/UnexportedTable.svelte
================================================================================

<script>
  import { formatters } from '../../../utils/formatters.js';
  import SortableTh from '../../common/SortableTh.svelte';

  export let items = [];

  // State s·∫Øp x·∫øp
  let sortKey = 'doanhThuQuyDoi';
  let sortDirection = 'desc';

  function handleSort(event) {
    const key = event.detail;
    if (sortKey === key) {
      sortDirection = sortDirection === 'desc' ? 'asc' : 'desc';
    } else {
      sortKey = key;
      sortDirection = 'desc';
    }
  }

  $: sortedItems = [...items].sort((a, b) => {
    let valA = a[sortKey] || 0;
    let valB = b[sortKey] || 0;

    if (sortKey === 'nganhHang') {
        valA = a.nganhHang || '';
        valB = b.nganhHang || '';
        return sortDirection === 'asc' ? valA.localeCompare(valB) : valB.localeCompare(valA);
    }

    return sortDirection === 'asc' ? valA - valB : valB - valA;
  });
</script>

<div class="bg-white rounded-xl shadow-md p-4 border border-gray-200 h-full flex flex-col">
  <h3 class="text-lg font-bold text-gray-700 mb-4 uppercase border-b pb-2 bg-red-50 p-2 rounded">Doanh thu ch∆∞a xu·∫•t</h3>

  {#if items.length === 0}
    <div class="flex-grow flex items-center justify-center">
       <p class="text-gray-500 font-bold p-4 text-center">Kh√¥ng c√≥ ƒë∆°n h√†ng n√†o ch∆∞a xu·∫•t trong ng√†y.</p>
    </div>
  {:else}
    <div class="overflow-x-auto flex-grow max-h-[400px]">
      <table class="min-w-full text-sm table-bordered table-striped">
        <thead class="text-xs text-slate-800 uppercase bg-slate-200 font-bold sticky top-0 z-10 shadow-sm">
          <tr>
            <SortableTh key="nganhHang" label="Ng√†nh h√†ng" {sortKey} {sortDirection} on:sort={handleSort} />
            <SortableTh key="soLuong" label="SL" align="right" {sortKey} {sortDirection} on:sort={handleSort} />
            <SortableTh key="doanhThuThuc" label="DT Th·ª±c" align="right" {sortKey} {sortDirection} on:sort={handleSort} />
            <SortableTh key="doanhThuQuyDoi" label="DTQƒê (Tr)" align="right" {sortKey} {sortDirection} on:sort={handleSort} />
          </tr>
        </thead>
        <tbody>
          {#each sortedItems as item (item.nganhHang)}
            <tr class="hover:bg-gray-50">
              <td class="px-4 py-2 font-medium">{item.nganhHang}</td>
              <td class="px-4 py-2 text-right font-bold">{formatters.formatNumber(item.soLuong)}</td>
              <td class="px-4 py-2 text-right font-bold">{formatters.formatRevenue(item.doanhThuThuc)}</td>
              <td class="px-4 py-2 text-right font-bold text-blue-600">{formatters.formatRevenue(item.doanhThuQuyDoi)}</td>
            </tr>
          {/each}
        </tbody>
      </table>
    </div>
  {/if}
</div>

================================================================================
File: src/components/luyke/LuykeCategoryTable.svelte
================================================================================

<script>
  import { onMount, afterUpdate } from 'svelte';
  import { formatters } from '../../utils/formatters.js';
  import { cleanCategoryName } from '../../utils.js';
  import { macroCategoryConfig } from '../../stores.js'; 
  import { adminService } from '../../services/admin.service.js';
  
  import LuykeCategoryCharts from './sub/LuykeCategoryCharts.svelte';
  import LuykeCategoryToolbar from './sub/LuykeCategoryToolbar.svelte';

  export let items = []; 
  export let unexportedItems = []; 
  export let rawSource = []; 
  export let numDays = 1;

  // --- STATE ---
  let showUnexported = false;
  let viewMode = 'grid'; 
  let searchText = '';
  let sortMode = 'revenue_desc';
  
  let isSettingsOpen = false;
  let filterSearch = '';
  let hiddenCategories = new Set(); 

  const STORAGE_KEY = 'luyke_category_direct_v1';

  onMount(async () => {
      // 1. Load Filter State
      const saved = localStorage.getItem(STORAGE_KEY);
      if (saved) {
          try { hiddenCategories = new Set(JSON.parse(saved)); } 
          catch (e) { console.error(e); }
      }

      // 2. Load Config
      if (!$macroCategoryConfig || $macroCategoryConfig.length === 0) {
          try {
              if (typeof adminService.loadMacroCategoryConfig === 'function') {
                  const configs = await adminService.loadMacroCategoryConfig();
                  macroCategoryConfig.set(configs);
              }
          } catch (e) { console.error("L·ªói load config:", e); }
      }
  });

  function saveHiddenState() {
      localStorage.setItem(STORAGE_KEY, JSON.stringify([...hiddenCategories]));
  }

  // --- THEME ---
  $: titleText = showUnexported ? "CHI TI·∫æT CH∆ØA XU·∫§T (Qƒê)" : (viewMode === 'grid' ? "CHI TI·∫æT NG√ÄNH H√ÄNG" : "T·ª∂ TR·ªåNG NG√ÄNH H√ÄNG");
  $: titleIcon = showUnexported ? "alert-circle" : (viewMode === 'grid' ? "grid" : "pie-chart");
  $: titleClass = showUnexported ? "text-orange-700" : "text-gray-700";
  $: iconClass = showUnexported ? "text-orange-600" : "text-blue-600";

  function getCategoryTheme(name) {
      const n = name ? name.toLowerCase() : '';
      if (n.includes('ƒëi·ªán t·ª≠') || n.includes('tivi')) return { icon: 'tv', theme: 'theme-teal' };
      if (n.includes('m√°y gi·∫∑t') || n.includes('s·∫•y')) return { icon: 'disc', theme: 'theme-blue' };
      if (n.includes('m√°y l·∫°nh') || n.includes('ƒëi·ªÅu h√≤a')) return { icon: 'wind', theme: 'theme-blue' };
      if (n.includes('t·ªß l·∫°nh') || n.includes('t·ªß ƒë√¥ng')) return { icon: 'server', theme: 'theme-blue' };
      if (n.includes('l·ªçc n∆∞·ªõc')) return { icon: 'droplet', theme: 'theme-blue' };
      if (n.includes('laptop') || n.includes('pc')) return { icon: 'monitor', theme: 'theme-teal' };
      if (n.includes('ƒëi·ªán tho·∫°i') || n.includes('smartphone')) return { icon: 'smartphone', theme: 'theme-blue' };
      if (n.includes('gia d·ª•ng') || n.includes('b·∫øp')) return { icon: 'home', theme: 'theme-orange' };
      if (n.includes('ph·ª• ki·ªán')) return { icon: 'headphones', theme: 'theme-purple' };
      if (n.includes('ƒë·ªìng h·ªì')) return { icon: 'watch', theme: 'theme-gray' };
      return { icon: 'tag', theme: 'theme-gray' };
  }

  // --- LOGIC M·ªöI: TR·ª∞C TI·∫æP & SONG SONG ---
  $: sourceData = showUnexported ? unexportedItems : items;

  // 1. T·∫°o danh s√°ch Filter (G·ªôp c·∫£ Macro v√† Simple)
  $: allGroups = (() => {
      // Macro Items
      const macroItems = ($macroCategoryConfig || []).map(m => ({
          key: m.name, // Key l√† t√™n nh√≥m l·ªõn
          label: m.name,
          type: 'macro'
      })).sort((a, b) => a.label.localeCompare(b.label));

      // Simple Items
      const simpleItemsMap = new Map();
      sourceData.forEach((i, index) => {
          const name = i.name || i.nganhHang;
          const safeKey = i.id || name || `unknown_${index}`;
          if (name) {
              simpleItemsMap.set(safeKey, { key: safeKey, label: name, type: 'simple' });
          }
      });
      const simpleItems = Array.from(simpleItemsMap.values()).sort((a, b) => a.label.localeCompare(b.label));

      return [...macroItems, ...simpleItems];
  })();

  $: filterList = allGroups.filter(g => 
      g.label.toLowerCase().includes(filterSearch.toLowerCase())
  );

  function toggleCategoryVisibility(event) {
      const key = event.detail;
      if (hiddenCategories.has(key)) hiddenCategories.delete(key);
      else hiddenCategories.add(key);
      hiddenCategories = new Set(hiddenCategories);
      saveHiddenState();
  }

  function toggleAllVisibility(event) {
      const show = event.detail;
      hiddenCategories = show ? new Set() : new Set(allGroups.map(g => g.key));
      saveHiddenState();
  }

  // 2. Logic Aggregation: KH√îNG B√ô TR·ª™. C√≥ g√¨ hi·ªán n·∫•y.
  $: aggregatedItems = (() => {
      const result = [];
      const macroConfigs = $macroCategoryConfig || [];

      // A. T√≠nh to√°n Nh√≥m L·ªõn (Macro) - Lu√¥n t√≠nh to√°n v√† th√™m v√†o n·∫øu kh√¥ng b·ªã ·∫©n
      macroConfigs.forEach(macro => {
          if (!hiddenCategories.has(macro.name)) {
              // T√¨m con kh·ªõp
              const keywords = (macro.items || []).map(k => k.toLowerCase());
              const childItems = sourceData.filter(item => {
                  const iName = (item.name || item.nganhHang || '').toLowerCase();
                  const iId = (item.id || '').toLowerCase();
                  return keywords.some(k => iName.includes(k) || iId === k);
              });

              if (childItems.length > 0) {
                  result.push({
                      id: `MACRO_${macro.name}`, // ID ri√™ng
                      name: macro.name,
                      isMacro: true,
                      revenue: childItems.reduce((sum, i) => sum + (i.revenue || 0), 0),
                      doanhThuQuyDoi: childItems.reduce((sum, i) => sum + (i.doanhThuQuyDoi || 0), 0),
                      quantity: childItems.reduce((sum, i) => sum + (i.quantity || i.soLuong || 0), 0),
                      soLuong: childItems.reduce((sum, i) => sum + (i.soLuong || 0), 0)
                  });
              }
          }
      });

      // B. Th√™m Ng√†nh H√†ng L·∫ª (Simple) - Lu√¥n th√™m v√†o n·∫øu kh√¥ng b·ªã ·∫©n
      sourceData.forEach((item, index) => {
          const name = item.name || item.nganhHang || 'Ch∆∞a ƒë·∫∑t t√™n';
          const safeId = item.id || name || `ITEM_${index}`;
          
          if (!hiddenCategories.has(safeId) && !hiddenCategories.has(name)) {
              result.push({
                  ...item,
                  id: safeId,
                  name: name,
                  isMacro: false
              });
          }
      });

      return result;
  })();

  $: gridDisplayItems = aggregatedItems.filter(item => {
      const name = item.name || '';
      return !searchText || name.toLowerCase().includes(searchText.toLowerCase());
  });

  $: sortedItems = [...gridDisplayItems].sort((a, b) => {
      const getRev = (i) => showUnexported ? (i.doanhThuQuyDoi || 0) : (i.revenue || 0);
      const getQty = (i) => showUnexported ? (i.soLuong || 0) : (i.quantity || 0);
      
      if (sortMode === 'revenue_desc') return getRev(b) - getRev(a);
      if (sortMode === 'quantity_desc') return getQty(b) - getQty(a);
      if (sortMode === 'name_asc') return (a.name || '').localeCompare(b.name || '');
      return 0;
  });

  $: totalRevenue = sourceData.reduce((sum, item) => sum + (showUnexported ? (item.doanhThuQuyDoi || 0) : (item.revenue || 0)), 0);
  $: maxVal = Math.max(...sortedItems.map(i => showUnexported ? (i.doanhThuQuyDoi || 0) : (i.revenue || 0)), 1);

  // --- CHART DATA (S·ª≠a l·∫°i logic Top H√£ng theo Filter) ---
  $: pieData = (() => {
      const sorted = aggregatedItems
          .filter(i => (showUnexported ? i.doanhThuQuyDoi : i.revenue) > 0)
          .sort((a, b) => (showUnexported ? b.doanhThuQuyDoi - a.doanhThuQuyDoi : b.revenue - a.revenue));
      if (sorted.length <= 14) return sorted;
      const top13 = sorted.slice(0, 13);
      const others = sorted.slice(13);
      const otherRevenue = others.reduce((sum, item) => sum + (showUnexported ? item.doanhThuQuyDoi : item.revenue), 0);
      return [...top13, { name: 'Kh√°c', revenue: otherRevenue }];
  })();

  // [FIX CHART] Truy·ªÅn config v√†o ƒë·ªÉ bung nh√≥m l·ªõn ra khi l·ªçc
  $: barData = calculateBrandData(rawSource, aggregatedItems, $macroCategoryConfig); 

  function calculateBrandData(source, visibleItems, configs) {
      if (!source || source.length === 0) return [];
      
      // 1. X√¢y d·ª±ng t·∫≠p h·ª£p c√°c t√™n ng√†nh h√†ng con "ƒë∆∞·ª£c ph√©p hi·ªán"
      const allowedNames = new Set();
      
      visibleItems.forEach(item => {
          if (item.isMacro) {
              // N·∫øu l√† nh√≥m l·ªõn, t√¨m config v√† th√™m t·∫•t c·∫£ c√°c con c·ªßa n√≥ v√†o list cho ph√©p
              const conf = (configs || []).find(c => c.name === item.name);
              if (conf && conf.items) {
                  conf.items.forEach(k => allowedNames.add(cleanCategoryName(k)));
              }
          } else {
              // N·∫øu l√† ng√†nh l·∫ª, th√™m ch√≠nh n√≥
              allowedNames.add(cleanCategoryName(item.name || item.nganhHang));
          }
      });

      // 2. L·ªçc Source v√† t√≠nh Brand
      const brands = {};
      source.forEach(row => {
          const rowCatName = cleanCategoryName(row.nganhHang || '');
          // Ch·ªâ l·∫•y n·∫øu ng√†nh h√†ng c·ªßa row n√†y n·∫±m trong danh s√°ch cho ph√©p
          if (allowedNames.has(rowCatName)) {
              const brandName = row.nhaSanXuat || 'Kh√°c';
              const revenue = parseFloat(String(row.thanhTien || "0").replace(/,/g, '')) || 0;
              if (!brands[brandName]) brands[brandName] = { name: brandName, revenue: 0 };
              brands[brandName].revenue += revenue;
          }
      });
      
      return Object.values(brands).sort((a, b) => b.revenue - a.revenue).slice(0, 15);
  }

  function handleWindowClick(e) {
      if (isSettingsOpen && !e.target.closest('.filter-wrapper')) {
          isSettingsOpen = false;
      }
  }
  
  afterUpdate(() => { if (typeof feather !== 'undefined') feather.replace(); });
</script>

<svelte:window on:click={handleWindowClick} />

<div class="luyke-tier-2-container">
    <LuykeCategoryToolbar
        {titleText} {titleIcon} {titleClass} {iconClass}
        bind:viewMode
        bind:showUnexported
        bind:sortMode
        bind:searchText
        bind:isSettingsOpen
        bind:filterSearch
        {filterList} 
        {hiddenCategories}
        on:toggleCategory={toggleCategoryVisibility}
        on:toggleAll={toggleAllVisibility}
    />

    <style>
        /* TƒÉng max-height v√† th√™m scroll cho body c·ªßa dropdown */
        :global(.filter-dropdown) {
            display: flex;
            flex-direction: column;
            max-height: 400px; /* Gi·ªõi h·∫°n chi·ªÅu cao t·ªïng */
        }
        :global(.filter-body) {
            flex: 1;
            overflow-y: auto; /* Cho ph√©p cu·ªôn n·ªôi dung */
            min-height: 0;
        }
        :global(.filter-actions) {
            flex-shrink: 0; /* N√∫t bottom kh√¥ng b·ªã co l·∫°i */
            border-top: 1px solid #eee;
        }
    </style>

    {#if viewMode === 'grid'}
        {#if sortedItems.length === 0}
            <div class="p-12 text-center bg-white border border-gray-200 border-t-0 rounded-b-xl">
                <p class="text-gray-500">{showUnexported ? 'Kh√¥ng c√≥ ƒë∆°n h√†ng ch∆∞a xu·∫•t.' : 'Kh√¥ng c√≥ d·ªØ li·ªáu hi·ªÉn th·ªã.'}</p>
            </div>
        {:else}
            <div class="luyke-cat-grid p-4 bg-white border border-gray-200 border-t-0 rounded-b-xl">
                {#each sortedItems as item (item.id)}
                    {@const name = item.name}
                    {@const revenue = showUnexported ? item.doanhThuQuyDoi : item.revenue}
                    {@const quantity = showUnexported ? item.soLuong : item.quantity}
                    {@const style = getCategoryTheme(name)}
                    {@const marketSharePercent = totalRevenue > 0 ? (revenue / totalRevenue) * 100 : 0}
                    {@const barPercent = maxVal > 0 ? (revenue / maxVal) * 100 : 0}
                    
                    {@const finalTheme = showUnexported ? 'theme-warning' : (item.isMacro ? 'bg-indigo-50 border-indigo-200 ring-1 ring-indigo-100' : style.theme)}
                    {@const iconName = item.isMacro ? 'layers' : style.icon}
                    {@const textColor = item.isMacro ? 'text-indigo-800' : ''}

                    <div class="cat-card-colorful {finalTheme}">
                        <div class="cat-top-row">
                            <div class="cat-icon-box {item.isMacro ? 'bg-indigo-100 text-indigo-600' : ''}">
                                <i data-feather={iconName} class="w-5 h-5"></i>
                            </div>
                            {#if !showUnexported}
                                <span class="cat-percent-text text-xs {item.isMacro ? 'text-indigo-600' : ''}">
                                    {formatters.formatPercentage(marketSharePercent/100)}
                                </span>
                            {/if}
                        </div>
                        
                        <h4 class="cat-name-text {textColor}" title={name}>
                            {name} 
                            {#if item.isMacro}<span class="text-[10px] bg-white border px-1 rounded text-gray-500 ml-1 font-normal">G·ªòP</span>{/if}
                        </h4>
                        
                        <div class="cat-value-text {textColor}">{formatters.formatRevenue(revenue,0)}</div>
                        
                        <div class="cat-footer-row">
                            <span>SL: <strong>{formatters.formatNumber(quantity)}</strong></span>
                            {#if !showUnexported}
                                <span>TB: <strong>{formatters.formatNumber(quantity/numDays, 0)}</strong>/ng√†y</span>
                            {/if}
                        </div>
                        
                        <div class="cat-bar-bg">
                            <div class="cat-bar-fill {item.isMacro ? 'bg-indigo-500' : ''}" style="width: {barPercent}%"></div>
                        </div>
                    </div>
                {/each}
            </div>
        {/if}
    {:else}
        <LuykeCategoryCharts 
            {pieData} 
            {barData} 
            {showUnexported} 
        />
    {/if}
</div>

================================================================================
File: src/components/luyke/LuykeEfficiencyTable.svelte
================================================================================

<script>
  import { afterUpdate, createEventDispatcher, onMount } from 'svelte';
  import { formatters } from '../../utils/formatters.js';

  export let items = []; 
  export let dynamicItems = [];
  export let supermarketData = {}; 
  
  const dispatch = createEventDispatcher();

  let isSettingsOpen = false;
  let filterSearch = '';
  let hiddenIds = new Set(); 

  const STORAGE_KEY = 'luyke_efficiency_hidden_ids';

  onMount(() => {
      const saved = localStorage.getItem(STORAGE_KEY);
      if (saved) {
          try { hiddenIds = new Set(JSON.parse(saved)); } catch (e) {}
      }
  });

  function saveHiddenState() {
      localStorage.setItem(STORAGE_KEY, JSON.stringify([...hiddenIds]));
  }

  const iconMap = {
      'pctPhuKien': 'headphones', 'pctGiaDung': 'home', 'pctMLN': 'droplet',
      'pctSim': 'cpu', 'pctVAS': 'layers', 'pctBaoHiem': 'shield', 'tyLeTraCham': 'credit-card'
  };

  $: displayItems = [
     
      ...items,
      ...(dynamicItems || []).map(cfg => {
          const metric = supermarketData.dynamicMetrics?.[cfg.id];
          return {
              id: cfg.id,
              label: cfg.label,
              value: metric ? metric.value : 0,
              target: cfg.target, // Target t·ª´ config admin
              isDynamic: true,
              rawConfig: cfg
        
          };
      })
  ];

  $: filterList = displayItems.filter(item => item.label.toLowerCase().includes(filterSearch.toLowerCase()));
  $: visibleItems = displayItems.filter(item => !hiddenIds.has(item.id));

  function toggleVisibility(id) {
      if (hiddenIds.has(id)) hiddenIds.delete(id); else hiddenIds.add(id);
      hiddenIds = new Set(hiddenIds);
      saveHiddenState();
  }

  function toggleAllVisibility(show) {
      hiddenIds = show ? new Set() : new Set(displayItems.map(i => i.id));
      saveHiddenState();
  }

  // [LOGIC M·ªöI] M√†u s·∫Øc d·ª±a tr√™n M·ª•c ti√™u: Xanh d∆∞∆°ng (ƒê·∫°t) - ƒê·ªè (Kh√¥ng ƒë·∫°t)
  function getProgressColor(val, target) {
      const t = (target || 0) / 100;
      if (t <= 0) return '#3b82f6'; // M·∫∑c ƒë·ªãnh xanh d∆∞∆°ng n·∫øu ko c√≥ target
      return val >= t ? '#2563eb' : '#ef4444'; // Blue-600 n·∫øu ƒë·∫°t, Red-500 n·∫øu r·ªõt
  }

  function handleWindowClick(e) {
      if (isSettingsOpen && !e.target.closest('.filter-wrapper')) 
        isSettingsOpen = false;
  }
  
  function handleDelete(id) {
      if(confirm('B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a ch·ªâ s·ªë n√†y?')) dispatch('delete', id);
  }

  afterUpdate(() => { if (typeof feather !== 'undefined') feather.replace(); });
</script>

<svelte:window on:click={handleWindowClick} />
<div class="luyke-widget h-full">
  <div class="luyke-widget-header">
    <div class="luyke-widget-title">
      <div class="p-1.5 bg-blue-100 rounded text-blue-600 mr-2">
          <i data-feather="bar-chart-2" class="w-4 h-4"></i>
      </div>
      <span>Hi·ªáu Qu·∫£ Khai Th√°c</span>
    </div>
    <div class="flex items-center gap-2">
        <button class="text-blue-600 hover:bg-blue-50 p-1.5 rounded text-xs font-bold flex items-center gap-1 border border-blue-200" on:click={() => dispatch('add')} title="Th√™m ch·ªâ s·ªë m·ªõi">
            <i data-feather="plus" class="w-3 h-3"></i> Th√™m
 
        </button>
        <div class="relative filter-wrapper">
            <button class="luyke-icon-btn {isSettingsOpen ? 'active' : ''}" on:click={() => isSettingsOpen = !isSettingsOpen}><i data-feather="filter" class="w-4 h-4"></i></button>
            {#if isSettingsOpen}
                <div class="filter-dropdown">
                    <div class="filter-header"><input type="text" class="filter-search" placeholder="T√¨m ch·ªâ s·ªë..." bind:value={filterSearch} /></div>
                    <div class="filter-body custom-scrollbar" style="max-height: 250px;">
                 
                        {#each filterList as item (item.id)}
                            <div class="filter-item" on:click={() => toggleVisibility(item.id)}>
                                <input type="checkbox" checked={!hiddenIds.has(item.id)} /> <label>{item.label}</label>
                            </div>
                        {/each}
           
                    </div>
                    <div class="filter-actions">
                        <button class="filter-btn-link" on:click={() => toggleAllVisibility(true)}>Hi·ªán t·∫•t c·∫£</button>
                        <button class="filter-btn-link text-red-600" on:click={() => toggleAllVisibility(false)}>·∫®n t·∫•t c·∫£</button>
                    </div>
                </div>
            {/if}
   
        </div>
    </div>
  </div>

  <div class="luyke-widget-body custom-scrollbar">
    {#if visibleItems.length === 0}
       <div class="flex flex-col items-center justify-center h-full text-gray-400"><p class="text-sm">ƒê√£ ·∫©n h·∫øt d·ªØ li·ªáu.</p></div>
    {:else}
      <div class="flex flex-col gap-0">
        {#each visibleItems as item (item.id)}
          {@const targetVal = (item.target || 0) / 100}
          {@const color = getProgressColor(item.value, item.target)}
          {@const percent = Math.min((item.value * 100), 100)}
          
          <div class="eff-item-compact group relative hover:bg-gray-50 transition-colors">
     
            <div class="eff-icon-compact"><i data-feather={iconMap[item.id] || 'activity'} class="w-4 h-4"></i></div>
            <div class="eff-content-compact">
                <div class="eff-row-top">
                    <span class="eff-label-text">{item.label}</span>
                    <div class="flex items-center gap-2">
                        {#if item.target > 0}
                            <span class="text-[10px] text-gray-400 font-medium whitespace-nowrap">- M·ª•c ti√™u : {item.target}%</span>
                        {/if}
                        <span class="eff-value-text" style="color: {color}">{formatters.formatPercentage(item.value)}</span>
                    </div>
                </div>
                <div class="eff-row-bottom">
                    <div class="eff-bar-container">
 
                        <div class="eff-bar-fill" style="width: {percent}%; background-color: {color};"></div>
                    </div>
                    </div>
 
            </div>
            {#if item.isDynamic}
                <div class="absolute right-2 top-2 hidden group-hover:flex gap-1 bg-white shadow-sm border border-gray-200 rounded p-1 z-10">
                    <button on:click|stopPropagation={() => dispatch('edit', item.rawConfig)} class="text-gray-500 hover:text-blue-600 p-1"><i data-feather="edit-2" class="w-3 h-3"></i></button>
                    <button on:click|stopPropagation={() => handleDelete(item.id)} class="text-gray-500 hover:text-red-600 p-1"><i data-feather="trash-2" class="w-3 h-3"></i></button>
                </div>
            {/if}
  
         </div>
        {/each}
      </div>
    {/if}
  </div>
</div>

================================================================================
File: src/components/luyke/LuykeQdcTable.svelte
================================================================================

<script>
  import { onMount, afterUpdate } from 'svelte';
  import { formatters } from '../../utils/formatters.js';
  import { cleanCategoryName } from '../../utils.js';
  import { 
      categoryStructure, 
      macroProductGroupConfig, 
      selectedWarehouse 
  } from '../../stores.js';
  import { datasyncService } from '../../services/datasync.service.js';
  import { adminService } from '../../services/admin.service.js';

  export let items = []; 
  export let numDays = 1;

  let isSettingsOpen = false;
  let filterSearch = '';
  let saveTimer;
  let localConfig = []; 

  // [M·ªöI] B·∫£ng m√†u r·ª±c r·ª° cho thanh ti·∫øn tr√¨nh
  const BAR_COLORS = [
      'bg-red-500',       // ƒê·ªè
      'bg-orange-500',    // Cam
      'bg-amber-500',     // V√†ng h·ªï ph√°ch
      'bg-yellow-400',    // V√†ng chanh
      'bg-lime-500',      // Xanh chanh
      'bg-green-500',     // Xanh l√°
      'bg-emerald-500',   // Xanh ng·ªçc
      'bg-teal-500',      // Xanh c·ªï v·ªãt
      'bg-cyan-500',      // Xanh da tr·ªùi nh·∫°t
      'bg-sky-500',       // Xanh b·∫ßu tr·ªùi
      'bg-blue-500',      // Xanh d∆∞∆°ng
      'bg-indigo-500',    // Ch√†m
      'bg-violet-500',    // T√≠m
      'bg-fuchsia-500',   // H·ªìng t√≠m
      'bg-pink-500',      // H·ªìng
      'bg-rose-500'       // H·ªìng ƒë·ªè
  ];

  // 1. Load config
  onMount(async () => {
      if (!$macroProductGroupConfig || $macroProductGroupConfig.length === 0) {
          try {
              const configs = await adminService.loadMacroProductGroupConfig();
              macroProductGroupConfig.set(configs);
          } catch (e) {
              console.error("L·ªói load Macro Product Groups:", e);
          }
      }
  });

  // 2. T·∫°o danh s√°ch Filter
  $: allGroups = (() => {
      const macroNames = ($macroProductGroupConfig || []).map(m => ({
          name: m.name,
          type: 'macro'
      })).sort((a, b) => a.name.localeCompare(b.name));

      const structureNames = new Set(($categoryStructure || []).map(c => cleanCategoryName(c.nhomHang)).filter(Boolean));
      const presentNames = new Set(items.map(i => i.name).filter(Boolean));
      
      const simpleNames = [...new Set([...structureNames, ...presentNames])]
          .sort()
          .map(name => ({
              name: name,
              type: 'simple'
          }));

      return [...macroNames, ...simpleNames];
  })();

  $: filterList = allGroups.filter(g => 
      g.name.toLowerCase().includes(filterSearch.toLowerCase())
  );

  // 3. Logic Load/Save Config
  $: if ($selectedWarehouse) {
      loadConfigForWarehouse($selectedWarehouse);
  } else {
      localConfig = allGroups.map(g => g.name);
  }

  async function loadConfigForWarehouse(kho) {
      try {
          const savedConfig = await datasyncService.loadQdcConfig(kho);
          if (savedConfig && Array.isArray(savedConfig)) {
              localConfig = savedConfig;
          } else {
              localConfig = allGroups.map(g => g.name);
          }
      } catch (e) {
          localConfig = allGroups.map(g => g.name);
      }
  }

  function toggleQdcSelection(name) {
      if (localConfig.includes(name)) {
          localConfig = localConfig.filter(n => n !== name);
      } else {
          localConfig = [...localConfig, name];
      }
      
      clearTimeout(saveTimer);
      saveTimer = setTimeout(() => {
          if ($selectedWarehouse) {
              datasyncService.saveQdcConfig($selectedWarehouse, localConfig);
          }
      }, 500); 
  }

  function toggleAllVisibility(show) {
      if (show) {
          localConfig = allGroups.map(g => g.name);
      } else {
          localConfig = [];
      }
      if ($selectedWarehouse) {
         datasyncService.saveQdcConfig($selectedWarehouse, localConfig);
      }
  }

  // 4. Aggregation Logic
  $: sortedItems = (() => {
      if (localConfig.length === 0) return [];

      let finalResults = [];
      const macroConfigs = $macroProductGroupConfig || [];
      
      const selectedMacros = localConfig.filter(name => macroConfigs.some(m => m.name === name));
      const selectedSimples = localConfig.filter(name => !macroConfigs.some(m => m.name === name));

      selectedMacros.forEach(macroName => {
          const config = macroConfigs.find(m => m.name === macroName);
          if (!config) return;

          const childIds = new Set(config.items || []);
          const childItems = items.filter(i => childIds.has(i.id));

          if (childItems.length > 0) {
              const aggregatedItem = {
                  id: config.id, 
                  name: config.name,
                  isMacro: true, 
                  dtqd: childItems.reduce((sum, i) => sum + (i.dtqd || 0), 0),
                  dt: childItems.reduce((sum, i) => sum + (i.dt || 0), 0),
                  quantity: childItems.reduce((sum, i) => sum + (i.quantity || i.sl || 0), 0),
                  _children: childItems 
              };
              finalResults.push(aggregatedItem);
          } 
      });

      selectedSimples.forEach(simpleName => {
          const item = items.find(i => i.name === simpleName);
          if (item) {
              finalResults.push({ ...item, isMacro: false });
          }
      });

      return finalResults.sort((a, b) => (b.dtqd || 0) - (a.dtqd || 0));
  })();

  $: maxVal = sortedItems.length > 0 ? (sortedItems[0].dtqd || 1) : 1;

  function handleWindowClick(e) {
      if (isSettingsOpen && !e.target.closest('.filter-wrapper')) {
          isSettingsOpen = false;
      }
  }

  afterUpdate(() => {
    if (typeof feather !== 'undefined') feather.replace();
  });
</script>

<svelte:window on:click={handleWindowClick} />

<div class="luyke-widget h-full flex flex-col">
  <div class="luyke-widget-header">
    <div class="luyke-widget-title">
      <div class="p-1.5 bg-yellow-100 rounded text-yellow-600 mr-2">
          <i data-feather="star" class="w-4 h-4"></i>
      </div>
      <span>TOP NH√ìM H√ÄNG</span>
    </div>

    <div class="relative filter-wrapper">
        <button class="luyke-icon-btn {isSettingsOpen ? 'active' : ''}" on:click={() => isSettingsOpen = !isSettingsOpen} title="Ch·ªçn nh√≥m h√†ng">
             <i data-feather="filter" class="w-4 h-4"></i>
        </button>
        {#if isSettingsOpen}
            <div class="filter-dropdown">
                <div class="filter-header">
                    <input type="text" class="filter-search" placeholder="T√¨m nh√≥m h√†ng..." bind:value={filterSearch} />
                </div>
                <div class="filter-body custom-scrollbar" style="max-height: 250px;">
                    {#if filterList.length === 0}
                         <p class="text-xs text-gray-500 text-center p-2">Kh√¥ng t√¨m th·∫•y.</p>
                    {:else}
                        {#each filterList as group}
                            {@const isChecked = localConfig.includes(group.name)}
                            <div class="filter-item" on:click={() => toggleQdcSelection(group.name)}>
                                 <input type="checkbox" checked={isChecked} />
                                 {#if group.type === 'macro'}
                                    <label class="{isChecked ? 'font-bold text-teal-700' : 'text-teal-600 font-semibold'} flex items-center gap-1">
                                        <i data-feather="layers" class="w-3 h-3"></i>
                                        {group.name}
                                    </label>
                                 {:else}
                                    <label class="{isChecked ? 'font-bold text-blue-700' : ''}">{group.name}</label>
                                 {/if}
                            </div>
                        {/each}
                    {/if}
                 </div>
                <div class="filter-actions">
                    <button class="filter-btn-link" on:click={() => toggleAllVisibility(true)}>Hi·ªán t·∫•t c·∫£</button>
                    <button class="filter-btn-link text-red-600" on:click={() => toggleAllVisibility(false)}>·∫®n t·∫•t c·∫£</button>
                </div>
            </div>
        {/if}
    </div>
  </div>

  <div class="luyke-widget-body custom-scrollbar">
    {#if sortedItems.length === 0}
        <div class="flex flex-col items-center justify-center h-full text-gray-400 py-10">
          <p class="text-sm">Kh√¥ng c√≥ d·ªØ li·ªáu hi·ªÉn th·ªã.</p>
          {#if items.length > 0}
             <p class="text-xs mt-1">H√£y ki·ªÉm tra b·ªô l·ªçc nh√≥m h√†ng.</p>
          {/if}
       </div>
    {:else}
      <div class="flex flex-col gap-0">
        {#each sortedItems as item, index (item.name)}
          {@const percent = maxVal > 0 ? (item.dtqd / maxVal) * 100 : 0}
          
          {@const barColor = BAR_COLORS[index % BAR_COLORS.length]}
          
          <div class="py-2 border-b border-dashed border-gray-100 last:border-0 transition-colors px-1 
                      {item.isMacro ? 'bg-teal-50/30 hover:bg-teal-50/50' : 'hover:bg-gray-50'}">
            
            <div class="flex items-center gap-3">
               <div class="w-6 text-center font-bold text-gray-400 text-xs">#{index + 1}</div>
                <div class="flex-grow min-w-0">
                   <div class="flex justify-between items-center mb-1">
                       <span class="text-sm font-semibold truncate pr-2 flex items-center gap-1 {item.isMacro ? 'text-teal-800' : 'text-gray-700'}" title={item.name}>
                           {#if item.isMacro}
                                <i data-feather="layers" class="w-3 h-3 text-teal-600"></i>
                           {/if}
                           {item.name}
                       </span>
                       <span class="text-sm font-bold whitespace-nowrap text-gray-800">
                           {formatters.formatRevenue(item.dtqd)}
                       </span>
                   </div>
                   
                   <div class="w-full h-2 bg-gray-100 rounded-full overflow-hidden mb-1 shadow-inner">
                        <div class="h-full rounded-full {barColor} shadow-sm transition-all duration-500 ease-out" style="width: {percent}%"></div>
                   </div>
                   
                   <div class="flex justify-between text-[10px] text-gray-500 flex-wrap gap-y-1">
                       <div class="flex gap-2">
                           <span>DT: <strong>{formatters.formatRevenue(item.dt)}</strong></span>
                           <span class="{item.isMacro ? 'text-teal-600' : 'text-blue-600'}">Qƒê: <strong>{formatters.formatRevenue(item.dtqd)}</strong></span>
                       </div>
                       <div class="flex gap-2">
                           <span>SL: {formatters.formatNumber(item.quantity || item.sl)}</span>
                           <span>TB: <strong>{formatters.formatNumber((item.quantity || item.sl) / numDays, 0)}</strong>/ng√†y</span>
                       </div>
                    </div>
               </div>
            </div>
          </div>
        {/each}
      </div>
    {/if}
  </div>
</div>

================================================================================
File: src/components/luyke/LuykeSieuThi.svelte
================================================================================

<script>
  import { onMount, afterUpdate } from 'svelte';
  import { 
    competitionData, 
    selectedWarehouse,
    interfaceSettings,
    macroCategoryConfig,
    macroProductGroupConfig, 
    efficiencyConfig,
    qdcConfigStore,
    modalState,
    categoryNameMapping,
    warehouseCustomMetrics
  } from '../../stores.js';
  import { formatters } from '../../utils/formatters.js';
  import { reportService } from '../../services/reportService.js';
  import { settingsService } from '../../services/settings.service.js';
  import { dataProcessing } from '../../services/dataProcessing.js';
  import { adminService } from '../../services/admin.service.js';
  import { datasyncService } from '../../services/datasync.service.js';
  import * as utils from '../../utils.js';
  
  import LuykeEfficiencyTable from './LuykeEfficiencyTable.svelte';
  import LuykeQdcTable from './LuykeQdcTable.svelte';
  import LuykeCategoryTable from './LuykeCategoryTable.svelte';

  export let supermarketReport = {};
  export let filteredYCXData = []; 
  export let goals = {};
  export let numDays = 1;

  let localSupermarketReport = {};
  let localGoals = {};
  let luykeCardData = {};
  let competitionSummary = { dat: 0, total: 0 };
  let comparisonData = { value: 0, percentage: 'N/A' };
  let luotKhachData = { value: 0, percentage: 'N/A' };
  
  let chuaXuatReport = [];
  let categoryItems = []; 
  let qdcItems = []; 

  let channelStats = {
      dxm: { val: 0, pct: 0 },
      tgdd: { val: 0, pct: 0 }
  };

  let combinedEfficiencyItems = [];

  onMount(async () => {
      const savedEffConfig = await adminService.loadEfficiencyConfig();
      if(savedEffConfig.length > 0) efficiencyConfig.set(savedEffConfig);
      
      const savedQdcConfig = await adminService.loadQdcConfig();
      if(savedQdcConfig.length > 0) qdcConfigStore.set(savedQdcConfig);
  });

  $: if ($selectedWarehouse) {
      loadLocalMetrics($selectedWarehouse);
  }

  async function loadLocalMetrics(kho) {
      const localData = await datasyncService.loadCustomMetrics(kho);
      warehouseCustomMetrics.set(localData);
  }

  $: combinedEfficiencyItems = [
      ...($efficiencyConfig || []).map(i => ({ 
          ...i, 
          isSystem: true,
          target: goals?.[i.id] || i.target 
      })),
      ...($warehouseCustomMetrics || []).map(i => ({ 
          ...i, 
          isSystem: false,
          target: goals?.[i.id] || i.target 
      }))
  ];

  const cleanValue = (str) => {
      if (typeof str === 'number') return str;
      if (!str || typeof str !== 'string') return 0;
      const cleanStr = str.replace(/,|%/g, '').trim();
      const val = parseFloat(cleanStr);
      return isNaN(val) ? 0 : val;
  };

  $: {
    const _triggerMacroCat = $macroCategoryConfig;
    const _triggerMacroProd = $macroProductGroupConfig;
    const _triggerEff = $efficiencyConfig;
    const _triggerMap = $categoryNameMapping;
    const _triggerLocalEff = $warehouseCustomMetrics;

    localSupermarketReport = supermarketReport || {};
    localGoals = goals || {};

    const pastedText = typeof localStorage !== 'undefined' ? localStorage.getItem('daily_paste_luyke') : '';
    const pastedData = dataProcessing.parseLuyKePastedData(pastedText || '');
    const { mainKpis, dtDuKien, dtqdDuKien, dtTraCham, tyLeTraCham } = pastedData;
    
    const hasPasteData = mainKpis && mainKpis['Th·ª±c hi·ªán DT th·ª±c'];

    comparisonData = pastedData.comparisonData || { value: 0, percentage: 'N/A' };
    luotKhachData = pastedData.luotKhachData || { value: 0, percentage: 'N/A' };

    const excelData = {
        dtThuc: localSupermarketReport.doanhThu || 0,
        dtQd: localSupermarketReport.doanhThuQuyDoi || 0,
        dtGop: localSupermarketReport.doanhThuTraGop || 0,
        tyLeGop: localSupermarketReport.tyLeTraCham || 0,
        tyLeQd: localSupermarketReport.hieuQuaQuyDoi || 0,
        chuaXuatQd: localSupermarketReport.doanhThuQuyDoiChuaXuat || 0
    };

    let finalDtThuc, finalDtQd, finalDtGop, finalTyLeGop, finalTyLeQd;

    if (hasPasteData) {
        finalDtThuc = cleanValue(mainKpis['Th·ª±c hi·ªán DT th·ª±c']) * 1000000;
        finalDtQd = cleanValue(mainKpis['Th·ª±c hi·ªán DTQƒê']) * 1000000;
        finalDtGop = dtTraCham * 1000000;
        finalTyLeGop = tyLeTraCham / 100;
        finalTyLeQd = finalDtThuc > 0 ? ((finalDtQd / finalDtThuc) - 1) : 0;
    } else {
        finalDtThuc = excelData.dtThuc;
        finalDtQd = excelData.dtQd;
        finalDtGop = excelData.dtGop;
        finalTyLeGop = excelData.tyLeGop;
        finalTyLeQd = excelData.tyLeQd;
    }

    const targetThuc = parseFloat(localGoals?.doanhThuThuc || 0) * 1000000;
    const targetQD = parseFloat(localGoals?.doanhThuQD || 0) * 1000000;
    
    let phanTramTargetQd = 0;
    if (hasPasteData && mainKpis['% HT Target D·ª± Ki·∫øn (Qƒê)']) {
         phanTramTargetQd = cleanValue(mainKpis['% HT Target D·ª± Ki·∫øn (Qƒê)']) / 100;
    } else {
          phanTramTargetQd = targetQD > 0 ? ((dtqdDuKien * 1000000) / targetQD) : 0;
    }

    const phanTramTargetThuc = targetThuc > 0 ? ((dtDuKien * 1000000) / targetThuc) : 0;
    
    const compData = $competitionData || [];
    competitionSummary.total = compData.length;
    competitionSummary.dat = compData.filter(d => (parseFloat(String(d.hoanThanh).replace('%','')) || 0) >= 100).length;
    const tyLeThiDuaDat = competitionSummary.total > 0 ? competitionSummary.dat / competitionSummary.total : 0;

    luykeCardData = {
      dtThucLK: finalDtThuc,
      dtQdLK: finalDtQd,
      phanTramQd: finalTyLeQd,
      dtGop: finalDtGop,
      phanTramGop: finalTyLeGop,
      dtThucDuKien: dtDuKien * 1000000, 
      dtQdDuKien: dtqdDuKien * 1000000, 
      phanTramTargetQd: phanTramTargetQd, 
      phanTramTargetThuc: phanTramTargetThuc, 
      chuaXuatQuyDoi: excelData.chuaXuatQd,
      tyLeThiDuaDat: tyLeThiDuaDat
    };

    // [FIX] C·∫≠p nh·∫≠t logic t√≠nh T·ª∑ tr·ªçng k√™nh theo ID
    const calcChannelStat = (keywords) => {
        // T√¨m nh√≥m c·∫•u h√¨nh (Macro Group) d·ª±a tr√™n t√™n (VD: ƒêMX, TGDD)
        const groupConfig = ($macroCategoryConfig || []).find(g => {
            if (!g.name) return false;
            const normName = g.name.trim().toLowerCase().normalize("NFC");
            return keywords.some(k => normName.includes(k));
        });

        if (!groupConfig || !groupConfig.items) return 0;

        const details = localSupermarketReport.nganhHangChiTiet || {};
        let totalVal = 0;

        // groupConfig.items b√¢y gi·ªù ch·ª©a ID (v√≠ d·ª• '1491', '42'...)
        groupConfig.items.forEach(itemId => {
            // Tra c·ª©u tr·ª±c ti·∫øp trong details b·∫±ng ID
            // (V√¨ data ƒë√£ ƒë∆∞·ª£c x·ª≠ l√Ω trong salesProcessor.js v·ªõi key l√† ID)
            if (details[itemId]) {
                totalVal += (details[itemId].revenueQuyDoi || 0);
            }
        });
        return totalVal;
    };

    const valDXM = calcChannelStat(['ƒëmx', 'dmx', 'dien may xanh']);
    const valTGDD = calcChannelStat(['tgdd', 'the gioi di dong']);
    const totalChannelRevenue = (valDXM + valTGDD) || 1; 

    channelStats = {
        dxm: { val: valDXM, pct: valDXM / totalChannelRevenue },
        tgdd: { val: valTGDD, pct: valTGDD / totalChannelRevenue }
    };

    chuaXuatReport = reportService.generateLuyKeChuaXuatReport(filteredYCXData);
    
    qdcItems = Object.entries(localSupermarketReport.nhomHangChiTiet || {})
      .map(([id, values]) => ({ 
          id: id,
          name: values.name, // L·∫•y t√™n t·ª´ object value
          dtqd: values.revenueQuyDoi, 
          sl: values.quantity, 
          dt: values.revenue, 
          ...values 
      }));

    categoryItems = Object.entries(localSupermarketReport.nganhHangChiTiet || {})
      .map(([id, values]) => ({ 
          id: id,
          name: values.name, // L·∫•y t√™n t·ª´ object value
          dtqd: values.revenueQuyDoi, 
          ...values 
      }));
  }

  function openAddEffModal() {
      modalState.update(s => ({ ...s, activeModal: 'add-efficiency-modal', payload: null }));
  }

  function handleEditEffConfig(event) {
      modalState.update(s => ({ ...s, activeModal: 'add-efficiency-modal', payload: event.detail }));
  }

  async function handleDeleteEffConfig(event) {
      const id = event.detail;
      const isSystem = $efficiencyConfig.some(i => i.id === id);
      
      if (isSystem) {
          alert("ƒê√¢y l√† ch·ªâ s·ªë h·ªá th·ªëng, b·∫°n kh√¥ng th·ªÉ x√≥a. H√£y d√πng b·ªô l·ªçc ƒë·ªÉ ·∫©n n√≥ ƒëi.");
          return;
      }

      if (confirm("X√≥a ch·ªâ s·ªë c√° nh√¢n n√†y?")) {
          const newLocalMetrics = $warehouseCustomMetrics.filter(i => i.id !== id);
          warehouseCustomMetrics.set(newLocalMetrics);
          if ($selectedWarehouse) {
              await datasyncService.saveCustomMetrics($selectedWarehouse, newLocalMetrics);
          }
      }
  }

  afterUpdate(() => {
    if (typeof feather !== 'undefined') feather.replace();
  });
</script>

<div class="luyke-dashboard-container">
  
  <div>
      <h2 id="luyke-supermarket-title" class="text-2xl font-bold text-gray-800 mb-4 flex items-center gap-2">
        <i data-feather="bar-chart" class="text-blue-600"></i>
        B√°o c√°o L≈©y k·∫ø {$selectedWarehouse ? '- ' + $selectedWarehouse : '(To√†n b·ªô)'}
      </h2>

      <div id="luyke-kpi-cards-container" data-capture-group="kpi" class="kpi-grid-fixed">
      
        <div class="kpi-card-solid card-1">
            <div class="kpi-solid-header">Doanh Thu Th·ª±c <i data-feather="dollar-sign"></i></div>
            <div class="kpi-solid-value">{formatters.formatNumber((luykeCardData.dtThucLK || 0) / 1000000, 0)}</div>
            <div class="kpi-solid-sub">
                <span>DK: {formatters.formatNumber((luykeCardData.dtThucDuKien || 0) / 1000000, 0)}</span>
                <span>MT: {formatters.formatNumber(localGoals?.doanhThuThuc || 0)}</span>
            </div>
            <div class="kpi-bg-icon"><i data-feather="dollar-sign"></i></div>
        </div>

        <div class="kpi-card-solid card-2">
            <div class="kpi-solid-header">DT Quy ƒê·ªïi <i data-feather="refresh-cw"></i></div>
            <div class="kpi-solid-value">{formatters.formatNumber((luykeCardData.dtQdLK || 0) / 1000000, 0)}</div>
            <div class="kpi-solid-sub">
                <span>DK: {formatters.formatNumber((luykeCardData.dtQdDuKien || 0) / 1000000, 0)}</span>
                <span>MT: {formatters.formatNumber(localGoals?.doanhThuQD || 0)}</span>
            </div>
            <div class="kpi-bg-icon"><i data-feather="refresh-cw"></i></div>
        </div>

        <div class="kpi-card-solid card-3">
            <div class="kpi-solid-header">% HT Target (Qƒê) <i data-feather="target"></i></div>
            <div class="kpi-solid-value">{formatters.formatPercentage(luykeCardData.phanTramTargetQd || 0)}</div>
            <div class="kpi-solid-sub">
                <span>% HT DT Th·ª±c: {formatters.formatPercentage(luykeCardData.phanTramTargetThuc || 0)}</span>
            </div>
            <div class="kpi-bg-icon"><i data-feather="target"></i></div>
        </div>

        <div class="kpi-card-solid card-4">
            <div class="kpi-solid-header">Hi·ªáu qu·∫£ Qƒê <i data-feather="trending-up"></i></div>
            <div class="kpi-solid-value">{formatters.formatPercentage(luykeCardData.phanTramQd || 0)}</div>
            <div class="kpi-solid-sub">
                <span>M·ª•c ti√™u: {formatters.formatNumber(localGoals?.phanTramQD || 0)}%</span>
            </div>
            <div class="kpi-bg-icon"><i data-feather="trending-up"></i></div>
        </div>

        <div class="kpi-card-solid card-5">
            <div class="kpi-solid-header">T·ª∑ l·ªá Tr·∫£ ch·∫≠m <i data-feather="credit-card"></i></div>
            <div class="kpi-solid-value">{formatters.formatPercentage(luykeCardData.phanTramGop || 0)}</div>
            <div class="kpi-solid-sub">
                <span>Doanh s·ªë: {formatters.formatNumber((luykeCardData.dtGop || 0) / 1000000, 0)}</span>
            </div>
            <div class="kpi-bg-icon"><i data-feather="credit-card"></i></div>
        </div>

        <div class="kpi-card-solid card-6">
            <div class="kpi-solid-header">Thi ƒëua ƒë·∫°t <i data-feather="award"></i></div>
            <div class="kpi-solid-value">{competitionSummary.dat}/{competitionSummary.total}</div>
            <div class="kpi-solid-sub">
                <span>T·ª∑ l·ªá ƒë·∫°t: {formatters.formatPercentage(luykeCardData.tyLeThiDuaDat)}</span>
            </div>
            <div class="kpi-bg-icon"><i data-feather="award"></i></div>
        </div>

        <div class="kpi-card-solid card-7">
            <div class="kpi-solid-header">TƒÉng tr∆∞·ªüng CK <i data-feather="activity"></i></div>
            <div class="kpi-solid-value">{comparisonData.percentage || 'N/A'}</div>
            <div class="kpi-solid-sub">
                <span>L∆∞·ª£t kh√°ch: {luotKhachData.percentage || 'N/A'}</span>
            </div>
            <div class="kpi-bg-icon"><i data-feather="activity"></i></div>
        </div>

        <div class="kpi-card-solid card-8">
           <div class="kpi-solid-header">T·ª∑ tr·ªçng k√™nh <i data-feather="pie-chart"></i></div>
            <div class="flex flex-col gap-1 mt-1">
                <div class="flex justify-between items-baseline border-b border-white/20 pb-1">
                    <span class="text-sm font-semibold opacity-90">ƒêMX</span>
                    <div class="text-right">
                        <span class="text-lg font-bold">{formatters.formatRevenue(channelStats.dxm.val, 0)}</span>
                        <span class="text-xs opacity-90 ml-1 font-bold">({formatters.formatPercentage(channelStats.dxm.pct)})</span>
                    </div>
                </div>
                <div class="flex justify-between items-baseline pt-1">
                    <span class="text-sm font-semibold opacity-90">TGDD</span>
                    <div class="text-right">
                        <span class="text-lg font-bold">{formatters.formatRevenue(channelStats.tgdd.val, 0)}</span>
                        <span class="text-xs opacity-90 ml-1 font-bold">({formatters.formatPercentage(channelStats.tgdd.pct)})</span>
                    </div>
                </div>
            </div>
            <div class="kpi-bg-icon"><i data-feather="pie-chart"></i></div>
        </div>

      </div>
  </div>

  <div class="luyke-tier-1-grid" data-capture-group="tier1">
      <LuykeEfficiencyTable 
          items={[]} 
          dynamicItems={combinedEfficiencyItems} 
          supermarketData={localSupermarketReport}
          goals={localGoals} 
          on:add={openAddEffModal}
          on:edit={handleEditEffConfig}
          on:delete={handleDeleteEffConfig}
      />
      <LuykeQdcTable 
          items={qdcItems} 
          numDays={numDays} 
      />
  </div>

  <div data-capture-group="tier2">
      <LuykeCategoryTable 
          items={categoryItems} 
          unexportedItems={chuaXuatReport}
          rawSource={filteredYCXData} 
          {numDays} 
      />
  </div>

</div>

================================================================================
File: src/components/luyke/LuykeThiDua.svelte
================================================================================

<script>
  import { afterUpdate } from 'svelte';
  import { competitionData } from '../../stores.js';
  import { formatters } from '../../utils/formatters.js';

  let viewType = 'summary'; // 'summary' | 'completion'
  let sortedData = [];
  
  // Stats calculation
  let summary = {
      total: 0,
      achieved: 0,
      revenueTotal: 0,
      revenueAchieved: 0,
      quantityTotal: 0,
      quantityAchieved: 0,
      overallRate: 0
  };

  $: {
    const data = ($competitionData || []).map(item => { 
      const hoanThanhValue = (parseFloat(String(item.hoanThanh).replace('%','')) || 0); 
      return { ...item, hoanThanhValue: hoanThanhValue }; 
    });

    summary = data.reduce((acc, d) => {
      acc.total++;
      if (d.hoanThanhValue >= 100) acc.achieved++;
      
      if (d.type === 'doanhThu') {
          acc.revenueTotal++;
          if (d.hoanThanhValue >= 100) acc.revenueAchieved++;
      }
      if (d.type === 'soLuong') {
          acc.quantityTotal++;
          if (d.hoanThanhValue >= 100) acc.quantityAchieved++;
      }
      return acc;
    }, { total: 0, achieved: 0, revenueTotal: 0, revenueAchieved: 0, quantityTotal: 0, quantityAchieved: 0 });

    summary.overallRate = summary.total > 0 ? (summary.achieved / summary.total) * 100 : 0;
    sortedData = data; 
  }

  function setViewType(newType) {
    viewType = newType;
  }
  
  function sortData(items) {
    return [...items].sort((a, b) => b.hoanThanhValue - a.hoanThanhValue); 
  };

  function getRateColor(rate) {
      if (rate >= 80) return 'text-green-600'; 
      if (rate >= 50) return 'text-yellow-600'; 
      return 'text-red-600';
  }

  $: rateStyle = getRateColor(summary.overallRate);

  afterUpdate(() => {
    if (typeof feather !== 'undefined') {
      feather.replace();
    }
  });
</script>

{#snippet flatKpiCard(title, value, subText, icon, colorClass, barPercent = 0)}
    <div class="bg-white border border-gray-200 rounded-xl p-4 shadow-sm hover:shadow-md transition-all h-full min-h-[120px] flex items-stretch justify-between relative overflow-hidden group">
        
        <div class="flex flex-col justify-between items-start z-10 mr-4 flex-grow">
            <div class="flex items-center gap-2.5">
                <div class="w-8 h-8 rounded-lg bg-gray-100 flex items-center justify-center text-gray-500 border border-gray-200 group-hover:bg-white group-hover:{colorClass} transition-colors">
                    <i data-feather={icon} class="w-4 h-4"></i>
                </div>
                <span class="text-xs font-extrabold uppercase text-gray-600 tracking-wider leading-tight">{title}</span>
            </div>

            <div class="w-full mt-auto pt-3">
                {#if barPercent > 0}
                    <div class="w-full bg-gray-100 rounded-full h-1.5 mb-2 max-w-[100px]">
                        <div class="h-1.5 rounded-full {colorClass.replace('text-', 'bg-')}" style="width: {Math.min(barPercent, 100)}%"></div>
                    </div>
                {/if}
                <div class="text-[11px] font-semibold text-gray-400 leading-snug">
                    {@html subText}
                </div>
            </div>
        </div>

        <div class="flex items-center justify-end z-10 flex-shrink-0">
            <span class="text-5xl font-black {colorClass} tracking-tighter leading-none drop-shadow-sm">{value}</span>
        </div>
    </div>
{/snippet}

{#snippet competitionCard(item)}
    {@const isProjectedCompleted = item.hoanThanhValue >= 100}
    {@const isActualCompleted = item.luyKe >= item.target}
    {@const colorBase = isProjectedCompleted ? 'green' : (item.hoanThanhValue >= 80 ? 'yellow' : 'red')}
    {@const textColor = `text-${colorBase}-600`}
    {@const barColor = `bg-${colorBase}-500`}
    {@const topBorderColor = `border-${colorBase}-500`}
    {@const targetRemaining = (item.target || 0) - (item.luyKe || 0)}
    {@const daysLeft = Math.max(30 - (new Date().getDate()), 1)}
    {@const dailyTarget = (item.target > 0 && targetRemaining > 0) ? (targetRemaining / daysLeft) : 0}

    <div class="bg-white border border-gray-200 border-t-4 {topBorderColor} rounded-lg p-3 shadow-sm hover:shadow-md hover:-translate-y-0.5 transition-all flex flex-col h-full">
        <div class="flex justify-between items-start gap-3 mb-2">
            <h4 class="font-bold text-gray-800 text-sm leading-snug line-clamp-2 flex-grow" title={item.name}>
                {item.name}
            </h4>
            <span class="text-2xl font-extrabold {textColor} leading-none flex-shrink-0">
                {formatters.formatPercentage(item.hoanThanhValue / 100)}
            </span>
        </div>

        <div class="w-full bg-gray-100 rounded-full h-1.5 mb-3">
            <div class="h-1.5 rounded-full {barColor} transition-all duration-500" style="width: {Math.min(item.hoanThanhValue, 100)}%"></div>
        </div>

        <div class="mt-auto pt-2 border-t border-dashed border-gray-100 grid grid-cols-2 gap-2 text-xs items-end">
            <div>
                <span class="block text-[10px] text-gray-400 uppercase font-semibold">TH / MT</span>
                <div class="text-gray-700 font-bold whitespace-nowrap">
                    <span>{formatters.formatNumberOrDash(item.luyKe)}</span>
                    <span class="text-gray-300 font-normal mx-0.5">/</span>
                    <span>{formatters.formatNumberOrDash(item.target)}</span>
                </div>
            </div>
            <div class="text-right">
                {#if !isActualCompleted}
                    <div class="inline-block bg-red-50 text-red-600 px-2 py-1 rounded text-[10px] font-bold border border-red-100">
                        C·∫ßn: {formatters.formatNumberOrDash(dailyTarget)}/ng√†y
                    </div>
                {:else}
                    <span class="text-green-600 font-bold text-[10px] flex items-center justify-end gap-1">
                        <i data-feather="check-circle" class="w-3 h-3"></i> ƒê√£ ƒë·∫°t
                    </span>
                {/if}
            </div>
        </div>
    </div>
{/snippet}

<div class="luyke-dashboard-container">
    
    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 mb-6" data-capture-group="kpi-thidua">
        
        {@render flatKpiCard(
            'T·ªïng Ch∆∞∆°ng tr√¨nh', 
            summary.total, 
            `DT: <strong class="text-blue-600">${summary.revenueTotal}</strong> ‚Ä¢ SL: <strong class="text-orange-600">${summary.quantityTotal}</strong>`,
            'layers',
            'text-gray-700'
        )}

        {@render flatKpiCard(
            'T·ª∑ l·ªá ƒê·∫°t', 
            formatters.formatPercentage(summary.overallRate / 100), 
            `ƒê√£ ƒë·∫°t: <strong class="${getRateColor(summary.overallRate)}">${summary.achieved}</strong> / ${summary.total}`,
            'target',
            getRateColor(summary.overallRate),
            summary.overallRate
        )}

        {@render flatKpiCard(
            'Thi ƒëua Doanh thu', 
            `${summary.revenueAchieved}/${summary.revenueTotal}`, 
            `T·ª∑ l·ªá ƒë·∫°t: <strong>${summary.revenueTotal > 0 ? formatters.formatPercentage(summary.revenueAchieved / summary.revenueTotal) : '0%'}</strong>`,
            'dollar-sign',
            'text-blue-600',
            summary.revenueTotal > 0 ? (summary.revenueAchieved / summary.revenueTotal) * 100 : 0
        )}

        {@render flatKpiCard(
            'Thi ƒëua S·ªë l∆∞·ª£ng', 
            `${summary.quantityAchieved}/${summary.quantityTotal}`, 
            `T·ª∑ l·ªá ƒë·∫°t: <strong>${summary.quantityTotal > 0 ? formatters.formatPercentage(summary.quantityAchieved / summary.quantityTotal) : '0%'}</strong>`,
            'box',
            'text-orange-600',
            summary.quantityTotal > 0 ? (summary.quantityAchieved / summary.quantityTotal) * 100 : 0
        )}

    </div>

    <div class="luyke-tier-2-container">
        
        <div class="luyke-toolbar">
            <div class="luyke-toolbar-left">
                <h3 class="text-lg font-bold uppercase flex items-center gap-2 text-gray-700">
                    <i data-feather="list" class="text-blue-600"></i>
                    Chi ti·∫øt ({summary.total})
                </h3>
            </div>

            <div class="luyke-toolbar-right flex items-center gap-2">
                <div class="flex bg-gray-100 p-0.5 rounded-lg border border-gray-200">
                    <button 
                        class="view-mode-btn {viewType === 'summary' ? 'active' : ''}" 
                        on:click={() => setViewType('summary')}
                    >
                        <i data-feather="grid" class="w-4 h-4"></i>
                        <span class="hidden sm:inline text-xs ml-1">Theo Lo·∫°i</span>
                    </button>
                    <button 
                        class="view-mode-btn {viewType === 'completion' ? 'active' : ''}" 
                        on:click={() => setViewType('completion')}
                    >
                        <i data-feather="check-circle" class="w-4 h-4"></i>
                        <span class="hidden sm:inline text-xs ml-1">Ti·∫øn ƒë·ªô</span>
                    </button>
                </div>
            </div>
        </div>

        <div class="p-4 bg-white border border-gray-200 border-t-0 rounded-b-xl min-h-[400px]">
            {#if sortedData.length === 0}
                <div class="p-12 text-center bg-gray-50 rounded-lg border-2 border-dashed border-gray-200">
                    <p class="text-gray-500 font-bold mb-2">Ch∆∞a c√≥ d·ªØ li·ªáu hi·ªÉn th·ªã.</p>
                    <p class="text-xs text-gray-400">Vui l√≤ng d√°n "Data l≈©y k·∫ø" ·ªü tab C·∫≠p nh·∫≠t d·ªØ li·ªáu.</p>
                </div>
            {:else}
                
                <div class="flex flex-col gap-8">
                    {#if viewType === 'summary'}
                        {@const dataDoanhThu = sortData(sortedData.filter(d => d.type === 'doanhThu'))}
                        {@const dataSoLuong = sortData(sortedData.filter(d => d.type === 'soLuong'))}

                        {#if dataDoanhThu.length > 0}
                            <div>
                                <h4 class="text-sm font-bold text-blue-800 uppercase flex items-center gap-2 mb-4 pb-2 border-b border-blue-100">
                                    <span class="bg-blue-100 p-1 rounded"><i data-feather="dollar-sign" class="w-4 h-4"></i></span>
                                    Thi ƒêua Doanh Thu ({dataDoanhThu.length})
                                </h4>
                                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                                    {#each dataDoanhThu as item}
                                        {@render competitionCard(item)}
                                    {/each}
                                </div>
                            </div>
                        {/if}

                        {#if dataSoLuong.length > 0}
                            <div>
                                <h4 class="text-sm font-bold text-orange-800 uppercase flex items-center gap-2 mb-4 pb-2 border-b border-orange-100">
                                    <span class="bg-orange-100 p-1 rounded"><i data-feather="box" class="w-4 h-4"></i></span>
                                    Thi ƒêua S·ªë L∆∞·ª£ng ({dataSoLuong.length})
                                </h4>
                                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                                    {#each dataSoLuong as item}
                                        {@render competitionCard(item)}
                                    {/each}
                                </div>
                            </div>
                        {/if}

                    {:else if viewType === 'completion'}
                        {@const completed = sortData(sortedData.filter(d => d.hoanThanhValue >= 100))}
                        {@const pending = sortData(sortedData.filter(d => d.hoanThanhValue < 100))}

                        {#if completed.length > 0}
                            <div>
                                <h4 class="text-sm font-bold text-green-800 uppercase flex items-center gap-2 mb-4 pb-2 border-b border-green-100">
                                    <span class="bg-green-100 p-1 rounded"><i data-feather="check" class="w-4 h-4"></i></span>
                                    ƒê√£ ho√†n th√†nh ({completed.length})
                                </h4>
                                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                                    {#each completed as item}
                                        {@render competitionCard(item)}
                                    {/each}
                                </div>
                            </div>
                        {/if}

                        {#if pending.length > 0}
                            <div>
                                <h4 class="text-sm font-bold text-red-800 uppercase flex items-center gap-2 mb-4 pb-2 border-b border-red-100">
                                    <span class="bg-red-100 p-1 rounded"><i data-feather="clock" class="w-4 h-4"></i></span>
                                    C·∫ßn n·ªó l·ª±c th√™m ({pending.length})
                                </h4>
                                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                                    {#each pending as item}
                                        {@render competitionCard(item)}
                                    {/each}
                                </div>
                            </div>
                        {/if}
                    {/if}
                </div>
            {/if}
        </div>
    </div>
</div>

================================================================================
File: src/components/luyke/LuykeThiDuaVung.svelte
================================================================================

<script>
  /* global XLSX, feather */
  import { onMount } from 'svelte';
  import { get } from 'svelte/store';
  import { 
    thiDuaVungChiTiet, 
    thiDuaVungTong, 
    choices 
  } from '../../stores.js';
  import { dataProcessing } from '../../services/dataProcessing.js';
  import { reportService } from '../../services/reportService.js';
  import TdvInfographic from './TdvInfographic.svelte';

  let fileStatus = "";
  let isLoading = false;
  let supermarketNames = [];
  let selectedSupermarket = "";
  let reportData = null;
  let choicesInstance = null;
  let selectElement = null; 

  async function _handleFileRead(file) {
      return new Promise((resolve, reject) => {
          if (!file) return reject(new Error("No file provided."));
          const reader = new FileReader();
          reader.onload = (event) => {
              try {
                  const data = new Uint8Array(event.target.result);
                  const workbook = XLSX.read(data, { type: 'array', cellDates: true, cellText: true });
                 resolve(workbook);
              } catch (err) { reject(err); }
          };
          reader.onerror = (err) => reject(new Error("Could not read the file: " + err));
          reader.readAsArrayBuffer(file);
      });
  }

  async function handleFileInput(event) {
    const file = event.target.files[0];
    const fileNameEl = document.getElementById('file-name-thidua-vung');
    if (!file) {
      if (fileNameEl) fileNameEl.textContent = "Ch∆∞a th√™m file";
      fileStatus = "";
      return;
    }

    isLoading = true;
    if (fileNameEl) fileNameEl.textContent = file.name;
    fileStatus = "ƒêang x·ª≠ l√Ω file...";

    try {
      const workbook = await _handleFileRead(file);
      const { chiTietData, tongData } = dataProcessing.processThiDuaVungFile(workbook);
      
      if (!tongData || tongData.length === 0) {
        throw new Error('Kh√¥ng t√¨m th·∫•y d·ªØ li·ªáu h·ª£p l·ªá trong file.');
      }

      thiDuaVungChiTiet.set(chiTietData);
      thiDuaVungTong.set(tongData);
 
      const supermarketKey = Object.keys(tongData[0]).find(k => k.trim().toLowerCase().includes('si√™u th·ªã'));
      supermarketNames = [...new Set(tongData.map(row => row[supermarketKey]).filter(Boolean))].sort();

      if (choicesInstance) {
        choicesInstance.clearStore();
        choicesInstance.setChoices(
          supermarketNames.map(name => ({ value: name, label: name })),
          'value',
          'label',
          true
        );
      }
      
      fileStatus = `‚úÖ ƒê√£ x·ª≠ l√Ω ${supermarketNames.length} si√™u th·ªã.`;
    } catch (error) {
      console.error("L·ªói x·ª≠ l√Ω file Thi ƒêua V√πng:", error);
      fileStatus = `‚ùå L·ªói: ${error.message}`;
    } finally {
      isLoading = false;
      event.target.value = null; 
    }
  }

  function handleFilterChange() {
    if (!choicesInstance) return;
    const selectedValue = choicesInstance.getValue(true);
    selectedSupermarket = selectedValue;
 
    if (selectedValue) {
      reportData = reportService.generateThiDuaVungReport(selectedValue);
    } else {
      reportData = null;
    }
  }

  onMount(() => {
    if (typeof Choices !== 'undefined' && selectElement) {
      choicesInstance = new Choices(selectElement, {
        searchEnabled: true,
        removeItemButton: false,
        itemSelectText: 'Ch·ªçn',
        searchPlaceholderValue: 'T√¨m ki·∫øm si√™u th·ªã...'
      });
      choices.update(c => ({ ...c, thiDuaVung_sieuThi: choicesInstance }));
    }
    
    if (typeof feather !== 'undefined') {
      feather.replace();
    }
  });
</script>

<div class="content-card"> 
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 items-end"> 
        <div class="data-input-group input-group--blue"> 
            <div class="flex flex-col sm:flex-row sm:items-center sm:gap-4"> 
                <label class="data-input-group__label !mb-2 sm:!mb-0 flex-shrink-0">File Thi ƒêua V√πng:</label> 
                <div class="flex items-center gap-2"> 
                    <label 
                        for="file-thidua-vung" 
                        class="data-input-group__file-trigger"
                        class:opacity-50={isLoading}
                    >
                        {isLoading ? 'ƒêang x·ª≠ l√Ω...' : 'Th√™m file'}
                    </label> 
                    <span id="file-name-thidua-vung" class="data-input-group__file-name">Ch∆∞a th√™m file</span> 
                </div>
            </div> 
            <input 
                type="file" 
                id="file-thidua-vung" 
                class="hidden" 
                data-name="Thi ƒëua v√πng" 
                accept=".xlsx, .xls, .csv"
                on:change={handleFileInput}
                disabled={isLoading}
            > 
            <div class="data-input-group__status-wrapper mt-2">
                <span 
                    class="data-input-group__status-text"
                    class:text-green-600={fileStatus.startsWith('‚úÖ')}
                    class:text-red-600={fileStatus.startsWith('‚ùå')}
                >
                    {fileStatus}
                </span>
            </div> 
        </div>
        
        <div class="data-input-group input-group--yellow h-full" style="min-height: 104px;"> 
             <label class="data-input-group__label">Ch·ªçn Si√™u th·ªã:</label> 
             <div class="data-input-group__content">
                <select 
                    id="thidua-vung-filter-supermarket" 
                    bind:this={selectElement}
                    on:change={handleFilterChange}
                >
                    <option value="">Vui l√≤ng t·∫£i file...</option>
                </select> 
             </div>
        </div> 
    </div>
</div> 

<div id="thidua-vung-infographic-container" class="mt-6"> 
    {#if reportData}
        <TdvInfographic {reportData} />
    {:else}
        <div class="placeholder-message">Vui l√≤ng t·∫£i file v√† ch·ªçn m·ªôt si√™u th·ªã ƒë·ªÉ xem b√°o c√°o.</div> 
    {/if}
</div>

================================================================================
File: src/components/luyke/LuykeUnexportedTable.svelte
================================================================================

<script>
  import { afterUpdate } from 'svelte';
  import { sortState } from '../../stores.js';
  import { formatters } from '../../utils/formatters.js';
  // FIX: ƒê∆∞·ªùng d·∫´n ƒë√∫ng
  import SortableTh from '../common/SortableTh.svelte';

  export let items = [];

  const tableType = 'luyke_chuaxuat';
  
  let totals = { soLuong: 0, doanhThuThuc: 0, doanhThuQuyDoi: 0 };

  function handleSort(event) {
    const sortKey = event.detail;
    const currentState = $sortState[tableType] || { key: 'doanhThuQuyDoi', direction: 'desc' };
    let newDirection;
    if (currentState.key === sortKey) {
      newDirection = currentState.direction === 'desc' ? 'asc' : 'desc';
    } else {
      newDirection = 'desc';
    }
    sortState.update(current => {
      current[tableType] = { key: sortKey, direction: newDirection };
      return current;
    });
  }

  $: currentSortKey = $sortState[tableType]?.key || 'doanhThuQuyDoi';
  $: currentSortDirection = $sortState[tableType]?.direction || 'desc';

  $: sortedItems = [...items].sort((a, b) => {
    const key = currentSortKey;
    const direction = currentSortDirection;
    let valA, valB;
     if (key === 'nganhHang') {
      valA = a.nganhHang || ''; valB = b.nganhHang || '';
      return direction === 'asc' ? valA.localeCompare(valB) : valB.localeCompare(valA);
    } else {
      valA = a[key] || 0; valB = b[key] || 0;
    }
    return direction === 'asc' ? valA - valB : valB - valA;
  });

  $: totals = items.reduce((acc, item) => {
      acc.soLuong += item.soLuong; 
      acc.doanhThuThuc += item.doanhThuThuc; 
      acc.doanhThuQuyDoi += item.doanhThuQuyDoi; 
      return acc; 
  }, { soLuong: 0, doanhThuThuc: 0, doanhThuQuyDoi: 0 });
</script>

<div data-capture-group="2" class="bg-white rounded-xl shadow-md p-4 sm:p-6 border border-gray-200 h-full flex flex-col">
  <h3 class="text-xl font-bold uppercase mb-4 border-b pb-2">Doanh thu ch∆∞a xu·∫•t</h3>
  
  {#if sortedItems.length === 0}
     <div class="flex-grow flex items-center justify-center">
        <p class="text-gray-500 font-bold p-4 text-center">Kh√¥ng c√≥ ƒë∆°n h√†ng n√†o ch∆∞a xu·∫•t.</p>
     </div>
  {:else}
    <div id="luyke-unexported-revenue-content" class="overflow-x-auto flex-grow">
        <table class="min-w-full text-sm table-bordered table-striped" data-table-type={tableType}>
        <thead class="text-xs text-slate-800 uppercase bg-slate-200 font-bold sticky top-0 z-10 shadow-sm">
            <tr>
            <SortableTh key="nganhHang" label="Ng√†nh h√†ng" sortKey={currentSortKey} sortDirection={currentSortDirection} on:sort={handleSort} />
            <SortableTh key="soLuong" label="S·ªë l∆∞·ª£ng" align="right" sortKey={currentSortKey} sortDirection={currentSortDirection} on:sort={handleSort} />
            <SortableTh key="doanhThuThuc" label="Doanh thu th·ª±c" align="right" sortKey={currentSortKey} sortDirection={currentSortDirection} on:sort={handleSort} />
            <SortableTh key="doanhThuQuyDoi" label="Doanh thu Qƒê" align="right" sortKey={currentSortKey} sortDirection={currentSortDirection} on:sort={handleSort} />
            </tr>
        </thead>
        <tbody>
            {#each sortedItems as item (item.nganhHang)}
            <tr class="hover:bg-gray-50">
                <td class="px-4 py-2 font-semibold">{item.nganhHang}</td>
                <td class="px-4 py-2 text-right font-bold">{formatters.formatNumber(item.soLuong)}</td>
                <td class="px-4 py-2 text-right font-bold">{formatters.formatRevenue(item.doanhThuThuc)}</td> 
                <td class="px-4 py-2 text-right font-bold text-blue-600">{formatters.formatRevenue(item.doanhThuQuyDoi)}</td> 
            </tr>
            {/each}
        </tbody>
        <tfoot class="table-footer font-bold bg-gray-100 border-t-2 border-gray-300 sticky bottom-0">
            <tr>
                <td class="px-4 py-2">T·ªïng</td>
                <td class="px-4 py-2 text-right">{formatters.formatNumber(totals.soLuong)}</td>
                <td class="px-4 py-2 text-right">{formatters.formatRevenue(totals.doanhThuThuc)}</td> 
                <td class="px-4 py-2 text-right">{formatters.formatRevenue(totals.doanhThuQuyDoi)}</td> 
            </tr>
        </tfoot>
        </table>
    </div>
  {/if}
</div>

================================================================================
File: src/components/luyke/TdvInfographic.svelte
================================================================================

<script>
  // Component n√†y nh·∫≠n d·ªØ li·ªáu ƒë√£ ƒë∆∞·ª£c x·ª≠ l√Ω v√† ch·ªâ render ra HTML.
  import { formatters } from '../../utils/formatters.js';

  export let reportData;

  // --- Logic render ƒë∆∞·ª£c di chuy·ªÉn t·ª´ ui-thidua-vung.js ---
  let summary, coGiai, sapCoGiai, tiemNang, canCoGangNhieu;
  let keyMap = {};
  let soonPrizeTitleText = '';
  let tyLeDatClass = '';

  // Helper function (gi·ªØ nguy√™n t·ª´ file g·ªëc)
  const findKey = (item, keyword) => {
      if (!item) return keyword; 
      return Object.keys(item).find(k => k.trim().toLowerCase().includes(keyword.toLowerCase())) || keyword;
  }

  // $: l√† m·ªôt kh·ªëi reactive. N√≥ s·∫Ω t·ª± ƒë·ªông ch·∫°y l·∫°i khi 'reportData' thay ƒë·ªïi.
  $: {
    if (!reportData) {
      // N·∫øu kh√¥ng c√≥ data, reset
      summary = null;
      coGiai = [];
      sapCoGiai = [];
      tiemNang = [];
      canCoGangNhieu = [];
} else {
      // Destructure d·ªØ li·ªáu
      ({ summary, coGiai, sapCoGiai, tiemNang, canCoGangNhieu } = reportData);

      // T√¨m keys (gi·ªëng h·ªát logic c≈©)
      const firstItem = coGiai[0] || sapCoGiai[0] || tiemNang[0] || canCoGangNhieu[0];
      keyMap = {
          sieuThi: findKey(summary, 'si√™u th·ªã'),
          tongThuongTamTinh: findKey(summary, 't·ªïng th∆∞·ªüng t·∫°m t·ªânh'),
          slThiDua: findKey(summary, 'sl nh thi ƒëua'),
          slDat: findKey(summary, 'sl nh >100%'),
          tyLeDat: findKey(summary, 't·ª∑ l·ªá nh ƒë·∫°t >100%'),
          slCoGiai: findKey(summary, 'sl nh d·ª± ki·∫øn ƒë·∫°t gi·∫£i'),
          nganhHang: findKey(firstItem, 'ng√†nh h√†ng'),
          phanTramDuKien: findKey(firstItem, '% d·ª± ki·∫øn'),
          duKienVuot: findKey(firstItem, 'd·ª± ki·∫øn d.thu'),
          hangVuotTroi: findKey(firstItem, 'h·∫°ng v∆∞·ª£t tr·ªôi'),
          hangTarget: findKey(firstItem, 'h·∫°ng % target'),
          tongThuong: findKey(firstItem, 't·ªïng th∆∞·ªüng'),
          hangCoGiaiKenh: 'hangCoGiaiKenh'
      };

      // T√≠nh to√°n text/class (gi·ªëng h·ªát logic c≈©)
      const totalSoonPrize = sapCoGiai.reduce((sum, item) => sum + (item.thuongTiemNang || 0), 0);
      soonPrizeTitleText = totalSoonPrize > 0 ? ` - DK: ${formatters.formatNumber(totalSoonPrize)}ƒë` : '';

      const tyLeDatValue = summary[keyMap.tyLeDat] || 0;
      tyLeDatClass = tyLeDatValue >= 0.6 ? 'tdv-tyledat-high' : 'tdv-tyledat-low';
    }
  }
</script>

{#if reportData}
<div class="tdv-infographic-card" data-capture-group="thidua-vung">
    <div class="tdv-header">
        <h2 class="tdv-supermarket-name">{summary[keyMap.sieuThi]}</h2>
        <div class="tdv-total-prize-container">
            <span class="tdv-total-prize-label">T·ªïng th∆∞·ªüng t·∫°m t√≠nh:</span>
            <span class="tdv-total-prize-value">{formatters.formatNumber(summary[keyMap.tongThuongTamTinh])}ƒë</span>
        </div>
    </div>

    <div class="tdv-summary-grid">
        <div class="tdv-summary-item">
            <span class="tdv-summary-value">{formatters.formatNumber(summary[keyMap.slThiDua])}</span>
            <span class="tdv-summary-label">Ng√†nh thi ƒëua</span>
        </div>
        <div class="tdv-summary-item">
            <span class="tdv-summary-value">{formatters.formatNumber(summary[keyMap.slDat])}</span>
            <span class="tdv-summary-label">Ng√†nh >100%</span>
        </div>
        <div class="tdv-summary-item">
            <span class="tdv-summary-value {tyLeDatClass}">{formatters.formatPercentage(summary[keyMap.tyLeDat] || 0)}</span>
            <span class="tdv-summary-label">T·ª∑ l·ªá ƒë·∫°t</span>
        </div>
         <div class="tdv-summary-item">
            <span class="tdv-summary-value">{formatters.formatNumber(summary[keyMap.slCoGiai])}</span>
            <span class="tdv-summary-label">Ng√†nh d·ª± ki·∫øn c√≥ gi·∫£i</span>
        </div>
        <div class="tdv-summary-item">
            <span class="tdv-summary-value">{formatters.formatNumber(summary[keyMap.hangCoGiaiKenh])}</span>
            <span class="tdv-summary-label">H·∫°ng c√≥ gi·∫£i (K√™nh)</span>
        </div>
    </div>

    <div class="tdv-rows-container">
        <div class="tdv-row">
            <h3 class="tdv-row-title tdv-row-title--prize">Ng√†nh h√†ng c√≥ gi·∫£i ({coGiai.length})</h3>
            <div class="tdv-row-body grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                {#if coGiai.length > 0}
                    {#each coGiai as item (item[keyMap.nganhHang])}
                        <div class="tdv-item-card">
                            <p class="tdv-item-card__title">{item[keyMap.nganhHang]}</p>
                            <div class="tdv-progress-bar-container">
                                <div class="tdv-progress-bar tdv-progress-bar--blue" style="width: {Math.min(item[keyMap.phanTramDuKien] * 100, 100)}%;"></div>
                                <span class="tdv-progress-bar__text">{formatters.formatPercentage(item[keyMap.phanTramDuKien])}</span>
                            </div>
                            <div class="tdv-item-card__details">
                                <span>V∆∞·ª£t: <strong>{formatters.formatNumber(item[keyMap.duKienVuot])}</strong></span>
                                <span>H·∫°ng DT/SL: <strong>{item[keyMap.hangVuotTroi]}</strong></span>
                                <span>H·∫°ng %: <strong>{item[keyMap.hangTarget]}</strong></span>
                                <span class="tdv-item-card__prize">Th∆∞·ªüng: <strong>{formatters.formatNumber(item[keyMap.tongThuong])}</strong></span>
                            </div>
                        </div>
                    {/each}
                {:else}
                    <p class="text-xs text-gray-500 col-span-full">Kh√¥ng c√≥.</p>
                {/if}
            </div>
        </div>

        <div class="tdv-row">
            <h3 class="tdv-row-title tdv-row-title--soon-prize">S·∫Øp c√≥ gi·∫£i ({sapCoGiai.length})<span class="tdv-row-subtitle">{soonPrizeTitleText}</span></h3>
            <div class="tdv-row-body grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                {#if sapCoGiai.length > 0}
                    {#each sapCoGiai as item (item[keyMap.nganhHang])}
                        <div class="tdv-item-card">
                            <p class="tdv-item-card__title">{item[keyMap.nganhHang]}</p>
                            <div class="tdv-progress-bar-container">
                                <div class="tdv-progress-bar tdv-progress-bar--yellow" style="width: {Math.min(item[keyMap.phanTramDuKien] * 100, 100)}%;"></div>
                                <span class="tdv-progress-bar__text">{formatters.formatPercentage(item[keyMap.phanTramDuKien])}</span>
                            </div>
                            <div class="tdv-item-card__details">
                                <span>C√°ch gi·∫£i: <strong>{item.khoangCach} h·∫°ng</strong></span>
                                <span>H·∫°ng DT/SL: <strong>{item[keyMap.hangVuotTroi]}</strong></span>
                                <span>H·∫°ng %: <strong>{item[keyMap.hangTarget]}</strong></span>
                                <span class="tdv-item-card__prize">Th∆∞·ªüng DK: <strong>{formatters.formatNumber(item.thuongTiemNang)}</strong></span>
                            </div>
                        </div>
                    {/each}
                {:else}
                    <p class="text-xs text-gray-500 col-span-full">Kh√¥ng c√≥.</p>
                {/if}
            </div>
        </div>

        <div class="tdv-row">
            <h3 class="tdv-row-title tdv-row-title--effort">Nh√≥m c√≤n l·∫°i ({tiemNang.length + canCoGangNhieu.length})</h3>
            <div class="tdv-row-body tdv-row-body--effort">
                {#if tiemNang.length > 0}
                    <div class="tdv-effort-subgroup">
                        <h4 class="tdv-effort-subgroup__title tdv-effort-subgroup__title--potential">Ti·ªÅm nƒÉng (c√°ch 21-40 h·∫°ng)</h4>
                        <div class="tdv-effort-list">
                            {#each tiemNang as item (item[keyMap.nganhHang])}
                                <div class="tdv-effort-item">{item[keyMap.nganhHang]} (c√°ch {item.khoangCach})</div>
                            {/each}
                        </div>
                    </div>
                {/if}

                {#if canCoGangNhieu.length > 0}
                     <div class="tdv-effort-subgroup">
                        <h4 class="tdv-effort-subgroup__title tdv-effort-subgroup__title--major">C·∫ßn c·ªë g·∫Øng nhi·ªÅu</h4>
                        <div class="tdv-effort-list">
                            {#each canCoGangNhieu as item (item[keyMap.nganhHang])}
                                <div class="tdv-effort-item">{item[keyMap.nganhHang]}</div>
                            {/each}
                        </div>
                    </div>
                {/if}

                {#if tiemNang.length === 0 && canCoGangNhieu.length === 0}
                    <p class="text-xs text-gray-500">Kh√¥ng c√≥.</p>
                {/if}
            </div>
        </div>
    </div>
</div>
{/if}

================================================================================
File: src/components/luyke/sub/LuykeCategoryCharts.svelte
================================================================================

<script>
    import { tick, afterUpdate } from 'svelte';
    import { formatters } from '../../../utils/formatters.js';
    import { getRandomBrightColor } from '../../../utils.js';

    export let pieData = [];
    export let barData = [];
    export let showUnexported = false;

    let chartInstancePie = null;
    let chartInstanceBar = null;

    async function renderCharts() {
        if (typeof Chart === 'undefined') return;
        await tick();

        // 1. Pie Chart
        const ctxPie = document.getElementById('luyke-cat-pie-chart');
        if (ctxPie) {
            if (chartInstancePie) chartInstancePie.destroy();
            const totalPieRevenue = pieData.reduce((sum, item) => sum + item.revenue, 0);

            chartInstancePie = new Chart(ctxPie, {
                type: 'doughnut',
                data: {
                    labels: pieData.map(d => d.name),
                    datasets: [{
                        data: pieData.map(d => d.revenue),
                        backgroundColor: pieData.map(() => getRandomBrightColor()),
                        borderWidth: 1
                    }]
                },
                options: { 
                    responsive: true, 
                    maintainAspectRatio: false, 
                    plugins: { 
                        legend: { 
                            position: 'right', 
                            labels: { 
                                boxWidth: 10,
                                font: { size: 11 },
                                generateLabels: (chart) => {
                                    const data = chart.data;
                                    if (data.labels.length && data.datasets.length) {
                                        return data.labels.map((label, i) => {
                                            const value = data.datasets[0].data[i];
                                            const formattedValue = formatters.formatRevenue(value, 0);
                                            const pct = totalPieRevenue > 0 ? (value / totalPieRevenue * 100).toFixed(1) + "%" : "0%";
                                            return {
                                                text: `${label} (${pct}) - ${formattedValue}`,
                                                fillStyle: data.datasets[0].backgroundColor[i],
                                                hidden: isNaN(data.datasets[0].data[i]),
                                                index: i
                                            };
                                        });
                                    }
                                    return [];
                                }
                            } 
                        },
                        datalabels: {
                            formatter: (value, ctx) => {
                                const percentage = totalPieRevenue > 0 ? (value / totalPieRevenue * 100).toFixed(1) + "%" : "0%";
                                if ((value / totalPieRevenue) < 0.03) return "";
                                return percentage;
                            },
                            color: '#fff',
                            font: { weight: 'bold', size: 10 }
                        }
                    } 
                },
                plugins: [ChartDataLabels]
            });
        }

        // 2. Bar Chart
        const ctxBar = document.getElementById('luyke-brand-bar-chart');
        if (ctxBar) {
            if (chartInstanceBar) chartInstanceBar.destroy();
            chartInstanceBar = new Chart(ctxBar, {
                type: 'bar',
                data: {
                    labels: barData.map(d => d.name),
                    datasets: [{
                        label: 'Doanh thu',
                        data: barData.map(d => d.revenue / 1000000),
                        backgroundColor: barData.map(() => getRandomBrightColor()),
                        borderRadius: 4
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { 
                        legend: { display: false },
                        datalabels: {
                            anchor: 'end',
                            align: 'end',
                            formatter: (value) => formatters.formatNumber(value, 0),
                            color: '#4b5563',
                            font: { weight: 'bold', size: 10 }
                        },
                        tooltip: {
                            callbacks: {
                                label: (ctx) => formatters.formatRevenue(ctx.raw * 1000000)
                            }
                        }
                    },
                    scales: { x: { beginAtZero: true } }
                },
                plugins: [ChartDataLabels]
            });
        }
    }

    // T·ª± ƒë·ªông render khi data thay ƒë·ªïi
    $: if (pieData.length > 0 || barData.length > 0) {
        setTimeout(renderCharts, 0);
    }

    afterUpdate(() => {
        // ƒê·∫£m b·∫£o render l·∫°i khi chuy·ªÉn tab ho·∫∑c resize
        setTimeout(renderCharts, 0);
    });
</script>

<div class="luyke-charts-container p-4 bg-white border border-gray-200 border-t-0 rounded-b-xl">
    <div class="chart-box">
        <h4 class="text-sm font-bold text-gray-700 mb-2 text-center">T·ª∑ tr·ªçng Doanh Thu (ƒêVT: Tri·ªáu)</h4>
        <div class="relative h-full w-full"><canvas id="luyke-cat-pie-chart"></canvas></div>
    </div>
    <div class="chart-box">
        <h4 class="text-sm font-bold text-gray-700 mb-2 text-center">Top 15 H√£ng (ƒêVT: Tri·ªáu)</h4>
        <div class="relative h-full w-full"><canvas id="luyke-brand-bar-chart"></canvas></div>
    </div>
</div>

================================================================================
File: src/components/luyke/sub/LuykeCategoryToolbar.svelte
================================================================================

<script>
    import { createEventDispatcher } from 'svelte';
    export let titleText = '';
    export let titleIcon = '';
    export let titleClass = '';
    export let iconClass = '';
    
    // Binding props
    export let viewMode = 'grid';
    export let showUnexported = false;
    export let sortMode = 'revenue_desc';
    export let searchText = '';
    
    // Filter props
    export let isSettingsOpen = false;
    export let filterSearch = '';
    export let filterList = []; // Array of { key, label, type } [FIX]
    export let hiddenCategories = new Set();
    export let isLoadingConfig = false;

    const dispatch = createEventDispatcher();

    function toggleCategory(key) {
        dispatch('toggleCategory', key);
    }

    function toggleAll(show) {
        dispatch('toggleAll', show);
    }
</script>

<div class="luyke-toolbar" style="flex-wrap: nowrap; gap: 8px;">
    <div class="luyke-toolbar-left" style="flex-grow: 1; min-width: 0;">
        <h3 class="text-base sm:text-lg font-bold uppercase flex items-center gap-2 {titleClass} truncate">
            <i data-feather={titleIcon} class="{iconClass} flex-shrink-0"></i>
            <span class="truncate">{titleText}</span>
        </h3>
    </div>

    <div class="luyke-toolbar-right" style="flex-shrink: 0; display: flex; align-items: center; gap: 8px;">
        
        <div class="flex bg-gray-100 p-0.5 rounded-lg border border-gray-200">
            <button class="view-mode-btn {viewMode === 'grid' ? 'active' : ''}" on:click={() => viewMode = 'grid'} title="Th·∫ª"><i data-feather="grid" class="w-4 h-4"></i></button>
            <button class="view-mode-btn {viewMode === 'chart' ? 'active' : ''}" on:click={() => viewMode = 'chart'} title="Bi·ªÉu ƒë·ªì"><i data-feather="pie-chart" class="w-4 h-4"></i></button>
        </div>

        {#if viewMode === 'grid'}
            <div class="toggle-wrapper {showUnexported ? 'active' : ''}" on:click={() => showUnexported = !showUnexported} style="padding: 4px 8px;">
                <div class="toggle-switch" style="width: 28px; height: 16px;"></div>
                <span class="toggle-label text-xs whitespace-nowrap">Ch∆∞a xu·∫•t</span>
            </div>
        {/if}

        <div class="relative filter-wrapper">
            <button class="luyke-icon-btn {isSettingsOpen ? 'active' : ''}" on:click={() => isSettingsOpen = !isSettingsOpen} title="L·ªçc hi·ªÉn th·ªã">
                {#if isLoadingConfig}<div class="w-4 h-4 border-2 border-blue-600 border-t-transparent rounded-full animate-spin"></div>{:else}<i data-feather="filter" class="w-4 h-4"></i>{/if}
            </button>

            {#if isSettingsOpen}
                <div class="filter-dropdown">
                    <div class="filter-header">
                        <input type="text" class="filter-search" placeholder="T√¨m ki·∫øm..." bind:value={filterSearch} />
                    </div>
                    <div class="filter-body custom-scrollbar">
                        {#if filterList.length === 0}
                            <p class="text-xs text-gray-500 text-center p-2">Kh√¥ng t√¨m th·∫•y.</p>
                        {:else}
                            {#each filterList as group (group.key)}
                                <div class="filter-item" on:click={() => toggleCategory(group.key)}>
                                    <input type="checkbox" checked={!hiddenCategories.has(group.key)} />
                                    {#if group.type === 'macro'}
                                        <label class="text-teal-700 font-bold text-xs flex items-center gap-1 flex-1">
                                            <i data-feather="layers" class="w-3 h-3"></i> {group.label}
                                        </label>
                                    {:else}
                                        <label class="text-gray-700 text-xs flex-1 truncate" title={group.label}>{group.label}</label>
                                    {/if}
                                </div>
                            {/each}
                        {/if}
                    </div>
                    <div class="filter-actions">
                        <button class="filter-btn-link" on:click={() => toggleAll(true)}>Hi·ªán t·∫•t c·∫£</button>
                        <button class="filter-btn-link text-red-600" on:click={() => toggleAll(false)}>·∫®n t·∫•t c·∫£</button>
                    </div>
                </div>
            {/if}
        </div>

        {#if viewMode === 'grid'}
            <div class="hidden sm:block">
                <input type="text" placeholder="T√¨m nhanh..." class="luyke-search-input" style="width: 120px;" bind:value={searchText} />
            </div>
            <select class="p-1.5 border rounded text-xs bg-white outline-none cursor-pointer max-w-[100px]" bind:value={sortMode}>
                <option value="revenue_desc">DT ‚Üì</option>
                <option value="quantity_desc">SL ‚Üì</option>
            </select>
        {/if}
    </div>
</div>
