--- START FILE: ./index.html ---
<!DOCTYPE html>
<html lang="vi" data-contrast="3">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Công cụ phân tích số cho QLST MWG 5.0 (Svelte)</title>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/choices.js/public/assets/styles/choices.min.css"/>
    <script src="https://cdn.jsdelivr.net/npm/choices.js/public/assets/scripts/choices.min.js"></script>

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>

    <script src="https://unpkg.com/feather-icons"></script>
    </head>
  <body class="overflow-x-hidden">
    
    <div id="app"></div>

    <script type="module" src="/src/main.js"></script>
  </body>
</html>
--- END FILE: ./index.html ---

--- START FILE: ./jsconfig.json ---
// Version 1.2 - Tắt checkJs để loại bỏ lỗi type check 2769 do kiểm tra quá nghiêm ngặt
{
  "compilerOptions": {
    "moduleResolution": "bundler",
    "target": "ESNext",
    "module": "ESNext",
    "verbatimModuleSyntax": true,
    "isolatedModules": true,
    "resolveJsonModule": true,
    "sourceMap": true,
    "esModuleInterop": true,
    "types": ["vite/client"],
    "skipLibCheck": true,
    "checkJs": false,
    "plugins": [
      {
        "name": "svelte"
      }
    ]
  },
  "include": [
    "src/**/*.d.ts",
    "src/**/*.js",
    "src/**/*.svelte"
  ]
}
--- END FILE: ./jsconfig.json ---

--- START FILE: ./package.json ---
{
  "name": "dashboard-svelte",
  "private": true,
  "version": "0.0.0",
  "type": "module",
  "scripts": {
    "dev": "vite",
    "build": "vite build",
    "preview": "vite preview",
    "check": "svelte-check",
    "tailwind:init": "node ./node_modules/tailwindcss/bin/tailwindcss.js init -p"
  },
  "devDependencies": {
    "@sveltejs/kit": "^2.5.18",
    "@sveltejs/vite-plugin-svelte": "^6.2.1",
    "autoprefixer": "^10.4.22",
    "postcss": "^8.5.6",
    "svelte": "^5.43.5",
    "svelte-check": "^3.8.4",
    "tailwindcss": "^3.4.18",
    "vite": "^7.2.2"
  },
  "dependencies": {
    "feather-icons": "^4.29.2",
    "firebase": "^12.6.0"
  }
}

--- END FILE: ./package.json ---

--- START FILE: ./src/App.svelte ---
<script>
  import { onMount, afterUpdate } from 'svelte';
  
  import { 
      activeTab, 
      modalState, 
      efficiencyConfig, 
      customRevenueTables, 
      // [NEW] Store cho bảng hiệu quả
      customPerformanceTables,
      isAdmin, 
      warehouseCustomMetrics,
      selectedWarehouse
  } from './stores.js'; 
  import { get } from 'svelte/store';
  import { authService } from './services/auth.service.js';
  import { adminService } from './services/admin.service.js';
  import { datasyncService } from './services/datasync.service.js';

  // --- COMPONENTS CHÍNH ---
  import Sidebar from './components/Sidebar.svelte';
  import HomeSection from './components/HomeSection.svelte';
  import DataSection from './components/DataSection.svelte';
  import HealthSection from './components/HealthSection.svelte';
  import HealthEmployeeSection from './components/HealthEmployeeSection.svelte';
  import RealtimeSection from './components/realtime/RealtimeSection.svelte';
  import DeclarationSection from './components/DeclarationSection.svelte';
  
  // --- COMMON UI ---
  import GlobalNotification from './components/common/GlobalNotification.svelte';

  // --- DRAWERS ---
  import InterfaceDrawer from './components/drawers/InterfaceDrawer.svelte';
  import GoalDrawer from './components/drawers/GoalDrawer.svelte';

  // --- MODALS ---
  import AdminModal from './components/modals/AdminModal.svelte';
  import LoginModal from './components/modals/LoginModal.svelte';
  import UserCompetitionModal from './components/modals/UserCompetitionModal.svelte';
  import UserSpecialProgramModal from './components/modals/UserSpecialProgramModal.svelte';
  import ComposerModal from './components/modals/ComposerModal.svelte';
  import AddEfficiencyColumnModal from './components/modals/AddEfficiencyColumnModal.svelte';
  import AddRevenueTableModal from './components/modals/AddRevenueTableModal.svelte';
  // [NEW] Import Modal mới
  import AddPerformanceTableModal from './components/modals/AddPerformanceTableModal.svelte';

  onMount(async () => {
    try { await authService.ensureAnonymousAuth(); } catch (e) { console.error("Firebase Auth Error:", e); }
    const isLoggedIn = authService.initAuth();
    if (!isLoggedIn) modalState.update(s => ({ ...s, activeModal: 'login-modal' }));
    
    // [NEW] Load bảng hiệu quả khi khởi động (User bảng sẽ load khi chọn kho)
    loadInitialTables();
  });

  async function loadInitialTables() {
     const sysTables = await adminService.loadSystemPerformanceTables();
     customPerformanceTables.set(sysTables);
  }

  afterUpdate(() => {
    if (window.feather) window.feather.replace();
  });

  // [FIX] Tách biệt logic lưu Admin vs User
  function handleSaveEffConfig(event) {
      // Clone object để tránh tham chiếu
      const newItem = { ...event.detail };
      
      // LOGIC ADMIN (Tab Khai Báo)
      if ($activeTab === 'declaration-section') {
          // Admin thì đánh dấu isSystem = true (nếu chưa có)
          newItem.isSystem = true;
          
          efficiencyConfig.update(items => {
              const idx = items.findIndex(i => i.id === newItem.id);
              if (idx >= 0) { items[idx] = newItem; return [...items]; } 
              else { return [...items, newItem]; }
          });
          adminService.saveEfficiencyConfig(get(efficiencyConfig));
      } 
      // LOGIC USER (Tab Lũy kế / Realtime)
      else {
      
          // User thì đánh dấu isSystem = false
          newItem.isSystem = false;

          let currentLocal = get(warehouseCustomMetrics) || [];
          const idx = currentLocal.findIndex(i => i.id === newItem.id);
          
          if (idx >= 0) {
              // Sửa
              currentLocal[idx] = newItem;
          } else {
              // Thêm mới
              currentLocal = [...currentLocal, newItem];
          }
          
          warehouseCustomMetrics.set(currentLocal);
          
          const wh = get(selectedWarehouse);
          if(wh) {
               datasyncService.saveCustomMetrics(wh, currentLocal);
          } else {
              alert("Vui lòng chọn Kho để lưu chỉ số này.");
          }
      }
  }

  // [CẬP NHẬT] Xử lý lưu bảng doanh thu (Phân quyền Admin vs User)
  async function handleSaveCustomTable(event) {
      const newItem = event.detail;
      
      // 1. Cập nhật Store hiển thị tức thì
      customRevenueTables.update(items => {
          const idx = items.findIndex(i => i.id === newItem.id);
          if (idx >= 0) { 
              items[idx] = { ...items[idx], ...newItem }; // Merge để giữ các props khác
              return [...items]; 
          } else { 
              return [...items, newItem]; 
          }
      });
      
      // 2. Phân loại nơi lưu trữ
      if (newItem.isSystem) {
          const currentSystemTables = get(customRevenueTables).filter(t => t.isSystem);
          await adminService.saveSystemRevenueTables(currentSystemTables);
          console.log("Đã lưu bảng hệ thống lên Admin Cloud");
      } else {
          const currentPersonalTables = get(customRevenueTables).filter(t => !t.isSystem);
          localStorage.setItem('customRevenueTables', JSON.stringify(currentPersonalTables));
          
          const wh = get(selectedWarehouse);
          if (wh) {
              await datasyncService.savePersonalRevenueTables(wh, currentPersonalTables);
          }
          console.log("Đã lưu bảng cá nhân");
      }
  }

  // [NEW] Xử lý lưu Bảng Hiệu Quả (Performance Table)
  async function handleSavePerformanceTable(event) {
      const newItem = event.detail;
      
      // 1. Cập nhật Store hiển thị
      customPerformanceTables.update(items => {
          const idx = items.findIndex(i => i.id === newItem.id);
          if (idx >= 0) {
              items[idx] = { ...items[idx], ...newItem };
              return [...items];
          } else {
              return [...items, newItem];
          }
      });

      // 2. Phân luồng lưu trữ
      if (newItem.isSystem) {
          // Admin System Table
          const systemTables = get(customPerformanceTables).filter(t => t.isSystem);
          await adminService.saveSystemPerformanceTables(systemTables);
      } else {
          // User Personal Table
          const personalTables = get(customPerformanceTables).filter(t => !t.isSystem);
          const wh = get(selectedWarehouse);
          if (wh) {
              await datasyncService.savePersonalPerformanceTables(wh, personalTables);
          } else {
              alert("Vui lòng chọn Kho để lưu bảng cá nhân.");
          }
      }
  }
</script>

<GlobalNotification />
<InterfaceDrawer />
<GoalDrawer />

<AdminModal />
<LoginModal />
<UserCompetitionModal />
<UserSpecialProgramModal />
<ComposerModal /> 

<AddRevenueTableModal 
    isOpen={$modalState.activeModal === 'add-revenue-table-modal'} 
    editItem={$modalState.payload}
    on:close={() => modalState.update(s => ({ ...s, activeModal: null, payload: null }))}
    on:save={handleSaveCustomTable}
/>

<AddPerformanceTableModal
    isOpen={$modalState.activeModal === 'add-performance-table-modal'}
    editItem={$modalState.payload}
    isSystem={$modalState.isSystem || false}
    on:close={() => modalState.update(s => ({ ...s, activeModal: null, payload: null }))}
    on:save={handleSavePerformanceTable}
/>

<AddEfficiencyColumnModal 
    isOpen={$modalState.activeModal === 'add-efficiency-modal'} 
    editItem={$modalState.payload}
    isAdmin={$activeTab === 'declaration-section'}
    on:close={() => modalState.update(s => ({ ...s, activeModal: null, payload: null }))}
    on:save={handleSaveEffConfig}
/>

<div class="flex min-h-screen">
  <div id="sidebar-container">
    <Sidebar />
  </div>

  <main id="main-content">
    <div class="flex-1 p-6">
      <div class="max-w-full mx-auto">
        <HomeSection activeTab={$activeTab} />
        <DataSection activeTab={$activeTab} />
        <HealthSection activeTab={$activeTab} />
        <HealthEmployeeSection activeTab={$activeTab} />
        <RealtimeSection activeTab={$activeTab} />
        <DeclarationSection activeTab={$activeTab} />
      </div>
    </div>
  </main>
</div> 

<div id="modal-force-update-container"></div>
<div id="modal-help-container"></div>
<div id="modal-chart-container"></div>
<div id="modal-preview-container"></div>
<div id="modal-selection-container"></div>
<div id="modal-customer-detail-container"></div>
<div id="modal-unexported-detail-container"></div>

<style>
  :global(#main-content) { 
    transition: margin-left 0.3s ease-in-out;
    margin-left: 68px; 
    min-width: 0;
    display: flex;
    flex-direction: column;
    flex: 1 1 0%;
  }

  :global(.page-header) { 
    display: flex; 
    flex-wrap: wrap; 
    justify-content: space-between; 
    align-items: center; 
    gap: 1rem; 
    margin-bottom: 1.5rem;
  }

  :global(.page-header__title) { 
    font-size: 1.75rem; 
    font-weight: 700; 
    color: #1f2937;
  }
</style>
--- END FILE: ./src/App.svelte ---

--- START FILE: ./src/app.css ---
/* src/app.css */
/* Version 2.3 - Add Luyke Dashboard Styles */

/* 1. Nền tảng (Variables, body, scrollbar) */
@import url('./styles/base.css');

/* 2. Bố cục chính (Sidebar, main-content, drawers) */
@import url('./styles/layout.css');

/* 3. Linh kiện UI (Buttons, cards, modals, inputs) */
@import url('./styles/components.css');

/* 4. Bảng biểu (Table styles, sort indicators, header colors) */
@import url('./styles/tables.css');

/* 5. Ghi đè thư viện (Choices.js) */
@import url('./styles/vendor.css');

/* 6. Style chuyên biệt cho từng tab */
@import url('./styles/specific-sknv.css');
@import url('./styles/specific-tdv.css');
@import url('./styles/specific-composer.css');
@import url('./styles/specific-realtime.css');

/* [MỚI] Style cho Dashboard Lũy Kế (Infographic) */
@import url('./styles/dashboard-luyke.css');

/* 7. (QUAN TRỌNG) Tailwind phải được nạp SAU CÙNG 
   để nó có thể ghi đè (utility classes) lên các style ở trên */
@tailwind base;
@tailwind components;
@tailwind utilities;
--- END FILE: ./src/app.css ---

--- START FILE: ./src/components/DataSection.svelte ---
<script>
  /* global feather */
  import { onMount, onDestroy } from 'svelte'; // [FIX] Thêm onDestroy
  
  import FileInput from './common/FileInput.svelte';
  import PasteInput from './common/PasteInput.svelte';

  import { 
      warehouseList,
      selectedWarehouse,
      notificationStore,
      danhSachNhanVien // [FIX] Import thêm store DSNV để lắng nghe
  } from '../stores.js';
  
  import { dataService } from '../services/dataService.js';

  export let activeTab;
  
  let isSyncing = false;
  let dsnvUnsubscribe; // Biến để hủy lắng nghe

  onMount(async () => {
    if (typeof feather !== 'undefined') {
      feather.replace();
    }

    const savedWh = localStorage.getItem('selectedWarehouse');
    if (savedWh) {
        console.log(`[DataSection] Phát hiện kho đã lưu: ${savedWh}. Đang chờ DSNV...`);
        selectedWarehouse.set(savedWh);
        
        // [FIX QUAN TRỌNG] Thay vì gọi sync ngay, ta lắng nghe DSNV
        // Chỉ khi DSNV tải xong (length > 0) thì mới bắt đầu đồng bộ các dữ liệu khác
        // Điều này đảm bảo logic map nhân viên không bị lỗi "0 NV"
        dsnvUnsubscribe = danhSachNhanVien.subscribe(async (data) => {
            if (data && data.length > 0) {
                console.log(`[DataSection] DSNV đã sẵn sàng (${data.length} dòng). Tiến hành đồng bộ kho ${savedWh}.`);
                await triggerSync(savedWh);
                
                // Đồng bộ xong thì hủy lắng nghe để không gọi lại thừa thãi
                if (dsnvUnsubscribe) {
                    dsnvUnsubscribe();
                    dsnvUnsubscribe = null;
                }
            }
        });
    }
  });

  // Hủy lắng nghe khi component bị hủy (để an toàn)
  onDestroy(() => {
      if (dsnvUnsubscribe) dsnvUnsubscribe();
  });

  async function triggerSync(warehouse) {
      if (!warehouse) return;
      isSyncing = true;
      try {
          const result = await dataService.syncDownFromCloud(warehouse);
          
          if (result && result.success) {
               if(result.message && !result.message.includes('Đã kiểm tra')) notificationStore.show(result.message, 'success');
          } else {
               notificationStore.show(result?.message || "Lỗi đồng bộ không xác định", 'error');
          }
      } catch (error) {
          console.error("Lỗi nghiêm trọng khi đồng bộ:", error);
          notificationStore.show(`Lỗi đồng bộ: ${error.message}`, 'error');
      } finally {
          isSyncing = false;
      }
  }

  async function handleWarehouseChange(event) {
      const newWarehouse = event.target.value;
      selectedWarehouse.set(newWarehouse);
      
      if (newWarehouse) {
          localStorage.setItem('selectedWarehouse', newWarehouse);
          notificationStore.show(`Đang đồng bộ dữ liệu cho ${newWarehouse}...`, 'info');
          await triggerSync(newWarehouse);
      } else {
          localStorage.removeItem('selectedWarehouse');
      }
  }

  $: if (activeTab === 'data-section') {
    Promise.resolve().then(() => {
      if (typeof window.feather !== 'undefined') {
        window.feather.replace();
      }
    });
  }
</script>

<section id="data-section" class="page-section {activeTab === 'data-section' ? '' : 'hidden'}"> 
    <div class="page-header">
        <div class="flex flex-wrap items-center gap-4">
            <div class="flex items-center gap-x-3">
                <h2 class="page-header__title">Cập nhật dữ liệu</h2>
                <button class="page-header__help-btn" data-help-id="data" title="Xem hướng dẫn">
                    <i data-feather="help-circle" class="feather"></i>
                </button>
            </div>
            
            <div id="data-warehouse-selector-container" class="flex-shrink-0 flex items-center gap-2">
                 <label for="data-warehouse-selector" class="text-sm font-semibold text-gray-700">Kho:</label>
                <div class="relative">
                    <select 
                      id="data-warehouse-selector" 
                      class="p-2 border rounded-lg text-sm shadow-sm min-w-[200px] 
                             font-semibold text-indigo-800 bg-indigo-50 border-indigo-200 
                           focus:ring-indigo-500 focus:border-indigo-500 disabled:opacity-50" 
                      disabled={$warehouseList.length === 0 || isSyncing}
                      value={$selectedWarehouse}
                      on:change={handleWarehouseChange}
                    >
                        {#if $warehouseList.length === 0}
                            <option>Vui lòng tải file DSNV...</option>
                        {:else}
                            <option value="">-- Chọn Kho --</option>
                            {#each $warehouseList as kho}
                                <option value={kho}>{kho}</option>
                            {/each}
                        {/if}
                    </select>
                    {#if isSyncing}
                        <div class="absolute right-8 top-1/2 -translate-y-1/2">
                            <svg class="animate-spin h-4 w-4 text-indigo-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                             </svg>
                        </div>
                    {/if}
                </div>
             </div>
        </div>
        <div id="version-marquee-container" class="marquee-container flex-grow min-w-[200px]">
             <p class="marquee-text"></p>
          </div>
    </div>
    
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 mb-6"> 
        <div class="content-card data-card--blue flex flex-col gap-4"> 
            <h3 class="content-card__header data-header--blue">
                <i data-feather="zap" class="h-5 w-5 feather"></i>SỬ DỤNG NHANH MỖI NGÀY
            </h3>
            
            <FileInput 
                label="Yêu cầu xuất lũy kế"
                 icon="file-text"
                saveKey="saved_ycx"
            />
            
            <PasteInput
                label="Data lũy kế"
                icon="clipboard"
                link="https://bi.thegioididong.com/sieu-thi-con?id=16612&tab=1"
                saveKeyPaste="daily_paste_luyke"
            />
            
            <PasteInput
                label="Thi đua nhân viên"
                icon="clipboard"
                link="https://bi.thegioididong.com/sieu-thi-con?id=16758&tab=bcdtnv&rt=2&dm=1"
                saveKeyPaste="daily_paste_thiduanv"
                saveKeyRaw="raw_paste_thiduanv"
                saveKeyProcessed="daily_paste_thiduanv"
            />
        </div>
        
         <div class="content-card data-card--green flex flex-col gap-4"> 
            <h3 class="content-card__header data-header--green">
                 <i data-feather="users" class="h-5 w-5 feather"></i>CHI TIẾT NĂNG SUẤT NHÂN VIÊN
            </h3>
            
            <FileInput
                label="Giờ công"
                icon="clock"
                saveKey="saved_giocong"
             />
             
            <FileInput
                label="Thưởng nóng"
                icon="gift"
                saveKey="saved_thuongnong"
            />
             
            <PasteInput
                label="Thưởng ERP"
                icon="clipboard"
                link="https://bi.thegioididong.com/reward?id=-1&tab=1"
                saveKeyPaste="daily_paste_thuongerp"
            />
        </div>
    </div>
    
    <div class="content-card data-card--yellow"> 
         <h3 class="content-card__header data-header--yellow">
            <i data-feather="calendar" class="h-5 w-5 feather"></i>DỮ LIỆU CẬP NHẬT 1 THÁNG 1 LẦN
         </h3>
        <p class="text-sm text-yellow-800 bg-yellow-100 p-3 rounded-lg mb-4">Lưu ý: Dữ liệu trong phần này sẽ được lưu vào trình duyệt của bạn. Dữ liệu sẽ tồn tại cho đến khi bạn cập nhật lại.</p> 
        
        <div class="grid md:grid-cols-3 gap-4"> 
            <div class="space-y-4"> 
                 <FileInput
                    label="Danh sách nhân viên"
                    icon="users"
                    saveKey="saved_danhsachnv"
                />
                <FileInput
                    label="YCX Lũy Kế tháng trước"
                    icon="file-text"
                    saveKey="saved_ycx_thangtruoc"
                />
            </div> 
             <div class="space-y-4"> 
                  <FileInput
                     label="Thưởng nóng tháng trước"
                    icon="gift"
                    saveKey="saved_thuongnong_thangtruoc"
                />
             </div> 
             <div class="space-y-4"> 
                <PasteInput
                    label="Thưởng ERP tháng trước"
                    icon="clipboard"
                    link="https://bi.thegioididong.com/reward?id=-1&tab=1"
                    saveKeyPaste="saved_thuongerp_thangtruoc"
                />
            </div> 
        </div> 
    </div> 
</section>
--- END FILE: ./src/components/DataSection.svelte ---

--- START FILE: ./src/components/DeclarationSection.svelte ---
<script>
    import { onMount } from 'svelte';
    import { fade } from 'svelte/transition';
    import { isAdmin, modalState } from '../stores.js';
    import { authService } from '../services/auth.service.js';

    // Import Admin Components
    import AdminRevenueTables from './admin/AdminRevenueTables.svelte';
    // [NEW] Component quản lý bảng hiệu quả
    import AdminPerformanceTables from './admin/AdminPerformanceTables.svelte';
    
    import AdminEfficiency from './admin/AdminEfficiency.svelte';
    import AdminCategory from './admin/AdminCategory.svelte';
    import AdminGoalSettings from './admin/AdminGoalSettings.svelte';
    import AdminCompetition from './admin/AdminCompetition.svelte';
    import AdminSpecialProgram from './admin/AdminSpecialProgram.svelte';
    import AdminConfig from './admin/AdminConfig.svelte';

    // [FIX] Nhận prop activeTab từ App.svelte để xử lý ẩn/hiện
    export let activeTab;

    // State quản lý menu con bên trái
    let activeMenu = 'config'; // config | data | goals | competition | special

    // Menu items
    const menuItems = [
        { id: 'config', label: 'Cấu hình Bảng & Chỉ số', icon: 'layout' },
        { id: 'data', label: 'Dữ liệu & Tính toán', icon: 'database' },
        { id: 'goals', label: 'Thiết lập Mục tiêu', icon: 'target' },
        { id: 'competition', label: 'Thi đua & Khen thưởng', icon: 'award' },
        { id: 'special', label: 'Chương trình Độc quyền', icon: 'star' }
    ];

    onMount(() => {
        // Kiểm tra quyền admin lại một lần nữa khi mount
        if (!$isAdmin) {
            // Nếu không phải admin, có thể redirect hoặc hiện thông báo (đã xử lý ở AdminModal)
        }
    });

    function handleLogin() {
        modalState.update(s => ({ ...s, activeModal: 'admin-modal' }));
    }

    function switchMenu(id) {
        activeMenu = id;
    }
</script>

<section id="declaration-section" class="page-section {activeTab === 'declaration-section' ? '' : 'hidden'}">
    <div class="content-card !p-0 min-h-[600px] flex flex-col md:flex-row overflow-hidden">
        
        {#if !$isAdmin}
            <div class="flex-1 flex flex-col items-center justify-center p-12 bg-slate-50">
                <div class="bg-white p-8 rounded-2xl shadow-lg border border-slate-100 max-w-md w-full text-center">
                    <div class="w-16 h-16 bg-red-100 text-red-600 rounded-full flex items-center justify-center mx-auto mb-4">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" />
                        </svg>
                    </div>
                    <h2 class="text-xl font-bold text-slate-800 mb-2">Yêu cầu quyền Quản trị</h2>
                    <p class="text-slate-500 mb-6 text-sm">Khu vực này dành riêng cho quản trị viên để thiết lập cấu hình hệ thống.</p>
                    <button 
                        on:click={handleLogin}
                        class="w-full py-2.5 bg-blue-600 hover:bg-blue-700 text-white font-bold rounded-lg shadow-md transition-all transform hover:scale-[1.02]"
                    >
                        Đăng nhập Admin
                    </button>
                </div>
            </div>
        {:else}
            <div class="w-full md:w-64 bg-slate-50 border-r border-slate-200 flex-shrink-0">
                <div class="p-4 border-b border-slate-200">
                    <h2 class="font-bold text-slate-700 uppercase text-xs tracking-wider">Danh mục quản lý</h2>
                </div>
                <nav class="p-2 space-y-1">
                    {#each menuItems as item}
                        <button 
                            class="w-full flex items-center gap-3 px-3 py-2.5 text-sm font-medium rounded-lg transition-all
                            {activeMenu === item.id ? 'bg-white text-blue-700 shadow-sm ring-1 ring-slate-200' : 'text-slate-600 hover:bg-slate-100 hover:text-slate-900'}"
                            on:click={() => switchMenu(item.id)}
                        >
                            <div class="{activeMenu === item.id ? 'text-blue-600' : 'text-slate-400'}">
                                {#if item.icon === 'layout'}
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 5a1 1 0 011-1h14a1 1 0 011 1v2a1 1 0 01-1 1H5a1 1 0 01-1-1V5zM4 13a1 1 0 011-1h6a1 1 0 011 1v6a1 1 0 01-1 1H5a1 1 0 01-1-1v-6zM16 13a1 1 0 011-1h2a1 1 0 011 1v6a1 1 0 01-1 1h-2a1 1 0 01-1-1v-6z" /></svg>
                                {:else if item.icon === 'database'}
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 7v10c0 2.21 3.582 4 8 4s8-1.79 8-4V7M4 7c0 2.21 3.582 4 8 4s8-1.79 8-4M4 7c0-2.21 3.582-4 8-4s8 1.79 8 4m0 5c0 2.21-3.582 4-8 4s-8-1.79-8-4" /></svg>
                                {:else if item.icon === 'target'}
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                                {:else if item.icon === 'award'}
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                                {:else if item.icon === 'star'}
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.784-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z" /></svg>
                                {/if}
                            </div>
                            {item.label}
                        </button>
                    {/each}
                </nav>
                
                <div class="mt-auto p-4 border-t border-slate-200">
                    <button class="w-full py-2 border border-slate-300 rounded text-xs font-bold text-slate-500 hover:bg-slate-100 transition-colors" on:click={() => authService.logout()}>
                        Đăng xuất Admin
                    </button>
                </div>
            </div>

            <div class="flex-1 bg-white p-6 md:p-8 overflow-y-auto h-[800px] custom-scrollbar">
                
                {#if activeMenu === 'config'}
                    <div in:fade={{ duration: 200 }}>
                        <h3 class="text-lg font-bold text-slate-800 mb-6 pb-2 border-b border-slate-200 flex items-center gap-2">
                            <span class="bg-blue-100 text-blue-600 p-1.5 rounded"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 5a1 1 0 011-1h14a1 1 0 011 1v2a1 1 0 01-1 1H5a1 1 0 01-1-1V5zM4 13a1 1 0 011-1h6a1 1 0 011 1v6a1 1 0 01-1 1H5a1 1 0 01-1-1v-6zM16 13a1 1 0 011-1h2a1 1 0 011 1v6a1 1 0 01-1 1h-2a1 1 0 01-1-1v-6z" /></svg></span>
                            Cấu hình Bảng hiển thị & Chỉ số
                        </h3>
                        <div class="space-y-8">
                            <AdminRevenueTables />

                            <AdminPerformanceTables />

                            <AdminEfficiency />

                            <AdminCategory viewMode="config" />
                        </div>
                    </div>
                {/if}

                {#if activeMenu === 'data'}
                    <div in:fade={{ duration: 200 }}>
                        <h3 class="text-lg font-bold text-slate-800 mb-6 pb-2 border-b border-slate-200 flex items-center gap-2">
                            <span class="bg-indigo-100 text-indigo-600 p-1.5 rounded"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 7v10c0 2.21 3.582 4 8 4s8-1.79 8-4V7M4 7c0 2.21 3.582 4 8 4s8-1.79 8-4M4 7c0-2.21 3.582-4 8-4s8 1.79 8 4m0 5c0 2.21-3.582 4-8 4s-8-1.79-8-4" /></svg></span>
                            Khai báo Dữ liệu & Công thức
                        </h3>
                        <AdminConfig />
                    </div>
                {/if}

                {#if activeMenu === 'goals'}
                    <div in:fade={{ duration: 200 }}>
                        <h3 class="text-lg font-bold text-slate-800 mb-6 pb-2 border-b border-slate-200 flex items-center gap-2">
                            <span class="bg-green-100 text-green-600 p-1.5 rounded"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg></span>
                            Thiết lập Mục tiêu & KPI
                        </h3>
                        <AdminGoalSettings />
                    </div>
                {/if}

                {#if activeMenu === 'competition'}
                    <div in:fade={{ duration: 200 }}>
                        <h3 class="text-lg font-bold text-slate-800 mb-6 pb-2 border-b border-slate-200 flex items-center gap-2">
                            <span class="bg-yellow-100 text-yellow-600 p-1.5 rounded"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" /></svg></span>
                            Cấu hình Thi đua & Khen thưởng
                        </h3>
                        <AdminCompetition />
                    </div>
                {/if}

                {#if activeMenu === 'special'}
                    <div in:fade={{ duration: 200 }}>
                        <h3 class="text-lg font-bold text-slate-800 mb-6 pb-2 border-b border-slate-200 flex items-center gap-2">
                            <span class="bg-purple-100 text-purple-600 p-1.5 rounded"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.784-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z" /></svg></span>
                            Chương trình Độc quyền
                        </h3>
                        <AdminSpecialProgram />
                    </div>
                {/if}

            </div>
        {/if}
    </div>
</section>

<style>
    .custom-scrollbar::-webkit-scrollbar { width: 8px; }
    .custom-scrollbar::-webkit-scrollbar-track { background: #f1f5f9; }
    .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
    .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
</style>
--- END FILE: ./src/components/DeclarationSection.svelte ---

--- START FILE: ./src/components/HealthEmployeeSection.svelte ---
<script>
  import { onMount, afterUpdate } from 'svelte';
  import { 
    masterReportData, 
    ycxData, 
    danhSachNhanVien, 
    luykeGoalSettings, 
    selectedWarehouse,
    warehouseList,
    modalState 
  } from '../stores.js';
  
  import { sknvService } from '../services/sknv.service.js';
  import { reportService } from '../services/reportService.js';
  import { actionService } from '../services/action.service.js';
  
  import SummaryView from './health-staff/summary/SummaryView.svelte';
  import DetailView from './health-staff/detail/DetailView.svelte';
  import RevenueTable from './health-staff/RevenueTable.svelte';
  import RevenueDetailView from './health-staff/revenue/RevenueDetailView.svelte';
  import IncomeTable from './health-staff/IncomeTable.svelte';
  // [NEW] Thay thế EfficiencyTable bằng PerformanceView
  import PerformanceView from './health-staff/performance/PerformanceView.svelte';
  import CategoryRevenueView from './health-staff/CategoryRevenueView.svelte';
  import CompetitionTab from './health-staff/CompetitionTab.svelte';

  export let activeTab;

  let activeSubTab = 'sknv';
  let viewingDetailId = null;
  let processedReport = [];

  const tabs = [
      { id: 'sknv', label: 'SKNV', icon: 'users', title: 'SucKhoeNhanVien' },
      { id: 'doanhthu', label: 'Doanh thu LK', icon: 'dollar-sign', title: 'DoanhThuLuyKe' },
      { id: 'thunhap', label: 'Thu nhập', icon: 'briefcase', title: 'ThuNhapNhanVien' },
      { id: 'hieuqua', label: 'Hiệu quả NV LK', icon: 'bar-chart-2', title: 'HieuQuaKhaiThac' },
      { id: 'nganhhang', label: 'DT ngành hàng', icon: 'layers', title: 'DoanhThuNganhHang' },
      { id: 'thidua', label: 'Thi đua NV LK', icon: 'award', title: 'ThiDuaNhanVien' }
  ];

  let lastDataHash = ''; 
  
  // Logic tính toán Master Report khi dữ liệu thay đổi
  $: {
      if ($danhSachNhanVien.length > 0 && $ycxData.length > 0) {
          const currentHash = `${$danhSachNhanVien.length}-${$ycxData.length}-${$selectedWarehouse}`;
          if (currentHash !== lastDataHash) {
              lastDataHash = currentHash;
              const goals = ($luykeGoalSettings && $selectedWarehouse) ? $luykeGoalSettings[$selectedWarehouse] || {} : {};
              const newMasterReport = reportService.generateMasterReportData($ycxData, goals, false);
              masterReportData.update(current => ({ ...current, sknv: newMasterReport }));
          }
      }
  }

  // Logic xử lý Processed Report (thêm đánh giá, trung bình bộ phận)
  $: {
      let rawData = $masterReportData.sknv || [];
      if ($selectedWarehouse) rawData = rawData.filter(nv => nv.maKho === $selectedWarehouse);
      processedReport = sknvService.processReportData(rawData);
  }

  function switchSubTab(tabId) { activeSubTab = tabId; viewingDetailId = null; }
  function handleEmployeeClick(event) { viewingDetailId = event.detail.employeeId; }
  function handleBackToSummary() { viewingDetailId = null; }
  
  function handleWarehouseChange(event) {
      selectedWarehouse.set(event.target.value);
  }

  // === ACTIONS ===
  function handleCompose() { 
      modalState.update(s => ({ ...s, activeModal: 'composer-modal', context: 'sknv' }));
  }
  function handleExport() { 
      actionService.handleExport('sknv'); 
  }
  function handleCapture() { 
      actionService.handleCapture('sknv'); 
  }

  afterUpdate(() => { if (typeof feather !== 'undefined') feather.replace(); });
</script>

<section id="health-employee-section" class="page-section {activeTab === 'health-employee-section' ? '' : 'hidden'}">
    
    <div class="content-card mb-6 !p-0">
        <div class="modern-page-header flex flex-wrap justify-between items-center">
            
            <div class="title-wrapper flex items-center gap-4 flex-wrap">
                <i data-feather="users" class="main-icon hidden sm:block"></i>
                
                <div class="flex items-center gap-2">
                    <h2 class="page-title text-xl sm:text-2xl font-bold text-blue-800">Sức Khỏe Nhân Viên</h2>
                    <button class="page-header__help-btn" data-help-id="sknv" title="Xem hướng dẫn">
                        <i data-feather="help-circle"></i>
                    </button>
                </div>

                <div class="flex items-center gap-2 pl-4 border-l-2 border-blue-100 ml-2">
                    <label for="sknv-warehouse-selector" class="text-sm font-semibold text-gray-600 whitespace-nowrap">Kho:</label>
                    <select 
                        id="sknv-warehouse-selector" 
                        class="p-2 border rounded-lg text-sm shadow-sm min-w-[120px] font-bold text-blue-700 bg-white border-blue-200 focus:ring-2 focus:ring-blue-500 outline-none cursor-pointer hover:bg-blue-50 transition" 
                        value={$selectedWarehouse}
                        on:change={handleWarehouseChange}
                    >
                        <option value="">-- Toàn bộ --</option>
                        {#each $warehouseList as kho}
                            <option value={kho}>{kho}</option>
                        {/each}
                    </select>
                </div>
            </div>

            <div class="flex items-center gap-2 ml-auto mt-2 sm:mt-0">
                <button id="compose-sknv-notification-btn" class="action-btn action-btn--composer" title="Nhận xét" on:click={handleCompose}>
                    <i data-feather="pen-tool" class="w-4 h-4"></i>
                    <span class="hidden lg:inline">Nhận xét</span>
                </button>
                <button id="export-sknv-btn" class="action-btn action-btn--export" title="Xuất Excel" on:click={handleExport}>
                    <i data-feather="download" class="w-4 h-4"></i>
                    <span class="hidden lg:inline">Xuất Excel</span>
                </button>
                <button id="capture-sknv-btn" class="action-btn action-btn--capture" title="Chụp ảnh" on:click={handleCapture}>
                    <i data-feather="camera" class="w-4 h-4"></i>
                    <span class="hidden lg:inline">Chụp</span>
                </button>
            </div>
        </div>
        
        <div class="content-card__body p-4">
            <div class="mb-6 overflow-x-auto pb-2">
                <nav id="employee-subtabs-nav" class="flex space-x-2 border-b border-gray-100 pb-1 w-full min-w-max" aria-label="Tabs">
                    {#each tabs as tab}
                        <button 
                            class="sub-tab-btn {activeSubTab === tab.id ? 'active' : ''}"
                            data-target="subtab-{tab.id}" 
                            data-title={tab.title} 
                            on:click={() => switchSubTab(tab.id)}
                        >
                            <i data-feather={tab.icon}></i>
                            <span>{tab.label}</span>
                        </button>
                    {/each}
                </nav>
            </div>

            <div id="employee-subtabs-content" class="min-h-[500px]">
                {#if activeSubTab === 'sknv'}
                    <div id="subtab-sknv" class="sub-tab-content">
                        {#if !viewingDetailId}
                            <div id="sknv-summary-container">
                                <SummaryView reportData={processedReport} on:click={handleEmployeeClick} />
                            </div>
                        {:else}
                            <div id="sknv-detail-capture-area">
                                <DetailView employeeId={viewingDetailId} on:back={handleBackToSummary} />
                            </div>
                        {/if}
                    </div>

                {:else if activeSubTab === 'doanhthu'}
                    <div id="subtab-doanhthu" class="sub-tab-content">
                        {#if !viewingDetailId}
                            <div id="revenue-report-container-lk">
                                <RevenueTable reportData={processedReport} on:viewDetail={handleEmployeeClick} />
                            </div>
                        {:else}
                            <div id="dtnv-lk-capture-area">
                                <RevenueDetailView employeeId={viewingDetailId} on:back={handleBackToSummary} />
                            </div>
                        {/if}
                    </div>

                {:else if activeSubTab === 'thunhap'}
                    <div id="subtab-thunhap" class="sub-tab-content">
                        <div id="income-report-container">
                            <IncomeTable reportData={processedReport} />
                        </div>
                    </div>

                {:else if activeSubTab === 'hieuqua'}
                    <div id="subtab-hieuqua" class="sub-tab-content" data-capture-preset="landscape-table">
                        <div id="efficiency-report-container">
                            <PerformanceView reportData={processedReport} />
                        </div>
                    </div>

                {:else if activeSubTab === 'nganhhang'}
                    <div id="subtab-nganhhang" class="sub-tab-content" data-capture-preset="mobile-portrait">
                        <div id="category-revenue-report-container">
                            <CategoryRevenueView reportData={processedReport} />
                        </div>
                    </div>
                
                {:else if activeSubTab === 'thidua'}
                    <div id="subtab-thidua" class="sub-tab-content">
                        <div id="competition-report-container-lk">
                            <CompetitionTab />
                        </div>
                        <div id="pasted-competition-report-container" class="hidden"></div>
                    </div>

                {:else}
                    <div class="p-12 text-center bg-white rounded-xl shadow-sm border border-gray-200">
                        <p class="text-gray-500">Nội dung đang cập nhật.</p>
                    </div>
                {/if}
            </div>
        </div>
    </div>
</section>
--- END FILE: ./src/components/HealthEmployeeSection.svelte ---

--- START FILE: ./src/components/HealthSection.svelte ---
<script>
  /* global feather */
  import { onMount, afterUpdate } from 'svelte';
  import {
      danhSachNhanVien,
      ycxData,
      masterReportData,
      selectedWarehouse,
      warehouseList,
      luykeGoalSettings,
      modalState,
      categoryNameMapping,
      macroCategoryConfig
  } from '../stores.js';
  
  import { reportService } from '../services/reportService.js';
  import { actionService } from '../services/action.service.js';
  
  import LuykeSieuThi from './luyke/LuykeSieuThi.svelte';
  import LuykeThiDua from './luyke/LuykeThiDua.svelte';
  import LuykeThiDuaVung from './luyke/LuykeThiDuaVung.svelte';

  export let activeTab;
  let activeSubTabId = 'subtab-luyke-sieu-thi';

  let showPlaceholder = true;
  $: showPlaceholder = ($danhSachNhanVien.length === 0);

  let selectedDept = '';
  let selectedDates = [];
  let goals = {};
  $: goals = ($luykeGoalSettings && $selectedWarehouse) 
      ? $luykeGoalSettings[$selectedWarehouse] || {} 
      : {};

  let filteredYCXData = [];
  $: {
      if (selectedDates && selectedDates.length > 0) {
          const startOfDay = (date) => new Date(date.getFullYear(), date.getMonth(), date.getDate()).getTime();
          const selectedDateSet = new Set(selectedDates.map(d => startOfDay(d)));
          filteredYCXData = $ycxData.filter(row => row.ngayTao instanceof Date && !isNaN(row.ngayTao) && selectedDateSet.has(startOfDay(row.ngayTao)));
      } else {
          filteredYCXData = $ycxData;
      }
  }

  $: {
      const _mappingTrigger = $categoryNameMapping;
      const _macroTrigger = $macroCategoryConfig;

      if (!showPlaceholder) {
          const newMasterReport = reportService.generateMasterReportData(
              filteredYCXData, 
              goals, 
              false 
          );
          masterReportData.update(current => ({ ...current, luyke: newMasterReport }));
      }
  }

  let filteredReport = [];
  $: filteredReport = ($masterReportData.luyke || []).filter(nv => {
      const whMatch = !$selectedWarehouse || nv.maKho == $selectedWarehouse;
      const deptMatch = !selectedDept || nv.boPhan === selectedDept;
      return whMatch && deptMatch;
  });
  let supermarketReport = {};
  $: supermarketReport = reportService.aggregateReport(filteredReport, $selectedWarehouse);

  let numDays = 1;
  $: numDays = selectedDates.length > 0 
      ? selectedDates.length 
      : (new Set($ycxData.map(row => row.ngayTao instanceof Date ? new Date(row.ngayTao).toDateString() : null).filter(Boolean)).size || 1);

  function handleSubTabClick(event) {
      const button = event.currentTarget;
      activeSubTabId = button.dataset.target;
  }

  function handleWarehouseChange(event) {
      selectedWarehouse.set(event.target.value);
  }

  function handleCompose() {
      modalState.update(s => ({ ...s, activeModal: 'composer-modal', context: 'luyke' }));
  }

  function handleExport() {
      actionService.handleExport('luyke');
  }

  function handleCapture() {
      actionService.handleCapture('luyke');
  }

  $: if (activeTab === 'health-section') {
    Promise.resolve().then(() => {
      if (typeof window.feather !== 'undefined') {
        window.feather.replace();
      }
    });
  }
</script>

<section id="health-section" class="page-section {activeTab === 'health-section' ? '' : 'hidden'}">
    <div id="health-section-placeholder" class="placeholder-message" class:hidden={!showPlaceholder}>
        Vui lòng cập nhật danh sách nhân viên để xem kết quả.
    </div> 
    
    <div id="health-section-content" class:hidden={showPlaceholder}> 
        <div class="content-card mb-6 !p-0"> 
            <div class="modern-page-header flex flex-wrap justify-between items-center"> 
                <div class="title-wrapper flex items-center gap-4 flex-wrap">
                    <i data-feather="activity" class="main-icon hidden sm:block"></i>
                    
                    <div class="flex items-center gap-2">
                        <h2 class="page-title text-xl sm:text-2xl font-bold text-blue-800">Sức Khỏe Siêu Thị</h2> 
                        <button class="page-header__help-btn" data-help-id="luyke" title="Xem hướng dẫn"> 
                             <i data-feather="help-circle"></i> 
                        </button>
                    </div>

                    <div class="flex items-center gap-2 pl-4 border-l-2 border-blue-100 ml-2">
                        <label for="luyke-warehouse-selector" class="text-sm font-semibold text-gray-600 whitespace-nowrap">Kho:</label>
                        <select 
                            id="luyke-warehouse-selector" 
                            class="p-2 border rounded-lg text-sm shadow-sm min-w-[120px] font-bold text-blue-700 bg-white border-blue-200 focus:ring-2 focus:ring-blue-500 outline-none cursor-pointer hover:bg-blue-50 transition" 
                            value={$selectedWarehouse}
                            on:change={handleWarehouseChange}
                        >
                            <option value="">-- Toàn bộ --</option>
                             {#each $warehouseList as kho}
                                <option value={kho}>{kho}</option>
                            {/each}
                        </select>
                    </div>
                </div>

                <div class="flex items-center gap-2 ml-auto mt-2 sm:mt-0"> 
                    <button id="compose-luyke-notification-btn" class="action-btn action-btn--composer" title="Nhận xét" on:click={handleCompose}> 
                        <i data-feather="pen-tool" class="w-4 h-4"></i> 
                        <span class="hidden lg:inline">Nhận xét</span> 
                    </button> 
                    <button id="export-luyke-btn" class="action-btn action-btn--export" title="Xuất Excel tab hiện tại" on:click={handleExport}> 
                        <i data-feather="download" class="w-4 h-4"></i> 
                        <span class="hidden lg:inline">Xuất Excel</span> 
                    </button>
                    <button id="capture-luyke-btn" class="action-btn action-btn--capture" title="Chụp ảnh tab hiện tại" on:click={handleCapture}> 
                        <i data-feather="camera" class="w-4 h-4"></i> 
                        <span class="hidden lg:inline">Chụp ảnh</span> 
                    </button> 
                </div>
            </div> 
            
            <div class="content-card__body p-4">
                <div class="mb-6 overflow-x-auto pb-2">
                    <nav id="luyke-subtabs-nav" class="flex space-x-2 border-b border-gray-100 pb-1 w-full min-w-max" aria-label="Tabs">
                        <button 
                            class="sub-tab-btn {activeSubTabId === 'subtab-luyke-sieu-thi' ? 'active' : ''}" 
                            data-target="subtab-luyke-sieu-thi" 
                            data-title="SieuThiLuyKe"
                            on:click={handleSubTabClick}
                        > 
                            <i data-feather="home"></i> 
                             <span>Siêu thị Lũy kế</span> 
                        </button>
                        <button 
                            class="sub-tab-btn {activeSubTabId === 'subtab-luyke-thi-dua' ? 'active' : ''}" 
                            data-target="subtab-luyke-thi-dua" 
                            data-title="ThiDuaLuyKe"
                            on:click={handleSubTabClick}
                        > 
                            <i data-feather="award"></i> 
                            <span>Thi đua ST Lũy kế</span> 
                        </button>
                        <button 
                            class="sub-tab-btn {activeSubTabId === 'subtab-luyke-thidua-vung' ? 'active' : ''}" 
                            data-target="subtab-luyke-thidua-vung" 
                            data-title="ThiDuaVung"
                            on:click={handleSubTabClick}
                        > 
                            <i data-feather="map"></i> 
                            <span>Thi Đua Vùng TNB</span> 
                        </button>
                    </nav>
                </div>

                <div id="luyke-subtabs-content"> 
                    {#if activeSubTabId === 'subtab-luyke-sieu-thi'}
                        <div id="subtab-luyke-sieu-thi" class="sub-tab-content">
                            <LuykeSieuThi 
                                supermarketReport={supermarketReport} 
                                filteredYCXData={filteredYCXData} 
                                goals={goals} 
                                numDays={numDays}
                            />
                        </div>
                    
                    {:else if activeSubTabId === 'subtab-luyke-thi-dua'}
                        <div id="subtab-luyke-thi-dua" class="sub-tab-content">
                            <div id="luyke-competition-content">
                                <LuykeThiDua />
                            </div>
                        </div>
                    
                    {:else if activeSubTabId === 'subtab-luyke-thidua-vung'}
                        <div id="subtab-luyke-thidua-vung" class="sub-tab-content">
                             <LuykeThiDuaVung />
                        </div>
                    {/if}
                </div>
            </div>
         </div>
    </div>
</section>
--- END FILE: ./src/components/HealthSection.svelte ---

--- START FILE: ./src/components/HomeSection.svelte ---
<script>
  // Version 2.4 - Upgrade Changelog UI (Blue title, Version prefix, HTML content)
  import { onMount, afterUpdate, onDestroy } from 'svelte';
  import { homeConfig } from '../stores.js';
  import { adminService } from '../services/admin.service.js';
  import { analyticsService } from '../services/analytics.service.js';
  import { formatters } from '../utils/formatters.js';

  export let activeTab;

  let slideIndex = 0;
  let slideInterval;
  let showQRModal = false;
  
  let stats = {
      totalUsers: 0,
      totalVisits: 0,
      totalActions: 0
  };

  let config = {
      videoUrl: 'https://www.youtube.com/embed/bmImlht_yB4',
      timeline: [],
      sliderImages: [],
      changelogs: []
  };

  $: config = $homeConfig || config;

  onMount(async () => {
      adminService.loadHomeConfig();
      startSlideShow();
      const data = await analyticsService.getSystemStats();
      if (data) stats = data;
  });

  onDestroy(() => {
      stopSlideShow();
  });

  $: if (activeTab === 'home-section') {
    Promise.resolve().then(() => {
      if (typeof window.feather !== 'undefined') window.feather.replace();
    });
  }

  function jumpToTime(timeStr) {
      const parts = timeStr.split(':');
      let seconds = 0;
      if (parts.length === 2) {
         seconds = parseInt(parts[0]) * 60 + parseInt(parts[1]);
      } else {
          seconds = parseInt(timeStr);
      }
      let baseUrl = config.videoUrl.split('?')[0];
      config.videoUrl = `${baseUrl}?start=${seconds}&autoplay=1`;
  }

  function startSlideShow() {
      stopSlideShow();
      slideInterval = setInterval(() => {
          if (config.sliderImages.length > 1) {
              slideIndex = (slideIndex + 1) % config.sliderImages.length;
          }
      }, 5000);
  }

  function stopSlideShow() {
      if (slideInterval) clearInterval(slideInterval);
  }

  function nextSlide() {
      stopSlideShow();
      if (config.sliderImages.length > 0) {
          slideIndex = (slideIndex + 1) % config.sliderImages.length;
      }
      startSlideShow();
  }

  function prevSlide() {
      stopSlideShow();
      if (config.sliderImages.length > 0) {
          slideIndex = (slideIndex - 1 + config.sliderImages.length) % config.sliderImages.length;
      }
      startSlideShow();
  }
</script>

<section id="home-section" class="page-section {activeTab === 'home-section' ? '' : 'hidden'}">
     <div class="page-header">
         <div class="flex items-center gap-4">
             <h2 class="page-header__title">Hướng Dẫn & Góp Ý</h2> 
             
             <button 
                class="flex items-center gap-2 px-3 py-1.5 bg-green-500 text-white rounded-full hover:bg-green-600 transition shadow-sm text-sm font-bold"
                on:click={() => showQRModal = true}
             >
                <i data-feather="message-circle" class="w-4 h-4"></i>
                Nhóm Line hỗ trợ
             </button>
         </div>

         <div id="usage-counter-display" class="text-sm font-medium bg-white px-4 py-2 rounded-lg border border-gray-200 shadow-sm flex gap-4 text-gray-600"> 
            <span>Người dùng: <strong class="text-blue-600">{formatters.formatNumber(stats.totalUsers)}</strong></span>
            <span class="border-l pl-4">Lượt truy cập: <strong class="text-green-600">{formatters.formatNumber(stats.totalVisits)}</strong></span>
            <span class="border-l pl-4">Lượt sử dụng: <strong class="text-purple-600">{formatters.formatNumber(stats.totalActions)}</strong></span>
        </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
        <div class="lg:col-span-2 content-card !p-0 overflow-hidden flex flex-col shadow-lg border-0">
            <div class="relative w-full" style="padding-top: 56.25%;"> 
                <iframe
                    class="absolute top-0 left-0 w-full h-full"
                    src={config.videoUrl}
                    title="Hướng dẫn sử dụng"
                    frameborder="0"
                    allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
                    allowfullscreen
               ></iframe>
            </div>
        </div>

        <div class="content-card flex flex-col h-full !mb-0 bg-white border border-gray-200">
            <h3 class="text-lg font-bold text-gray-800 mb-4 flex items-center gap-2">
                <i data-feather="list" class="text-blue-600"></i> Mục lục Video
            </h3>
            <div class="flex-grow overflow-y-auto pr-2 custom-scrollbar max-h-[300px] lg:max-h-none space-y-2">
                {#if config.timeline && config.timeline.length > 0}
                   {#each config.timeline as item}
                        <button 
                            class="w-full text-left p-3 rounded-lg hover:bg-blue-50 transition flex items-start gap-3 group border border-transparent hover:border-blue-100"
                            on:click={() => jumpToTime(item.time)}
                        >
                            <span class="bg-blue-100 text-blue-700 font-mono text-xs font-bold px-2 py-1 rounded group-hover:bg-blue-600 group-hover:text-white transition-colors">
                                {item.time}
                            </span>
                            <span class="text-sm text-gray-700 font-medium group-hover:text-blue-800 line-clamp-2">
                                {item.label}
                            </span>
                        </button>
                    {/each}
                {:else}
                    <p class="text-sm text-gray-400 italic text-center py-4">Chưa có mục lục.</p>
                {/if}
            </div>
        </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <div class="content-card flex flex-col h-[600px]">
            <h3 class="text-xl font-bold text-gray-800 mb-4 flex items-center gap-2 border-b pb-2">
                <i data-feather="image" class="text-blue-600"></i> Các chức năng dự án
            </h3>
            <div class="flex-grow relative group overflow-hidden rounded-lg bg-gray-900 flex items-center justify-center">
                {#if config.sliderImages && config.sliderImages.length > 0}
                    {#each config.sliderImages as img, i}
                         <div 
                            class="absolute inset-0 transition-opacity duration-700 ease-in-out {i === slideIndex ? 'opacity-100 z-10' : 'opacity-0 z-0'}"
                        >
                            <img 
                                src={img.url} 
                                alt={img.title} 
                                class="w-full h-full object-cover"
                            >
                            <div class="absolute bottom-0 left-0 w-full bg-gradient-to-t from-black/80 to-transparent p-6 pt-12">
                                <h3 class="text-white font-bold text-lg drop-shadow-md">{img.title}</h3>
                             </div>
                        </div>
                    {/each}

                    <button class="absolute left-2 top-1/2 -translate-y-1/2 p-2 bg-black/30 hover:bg-black/50 text-white rounded-full z-20 opacity-0 group-hover:opacity-100 transition" on:click={prevSlide}>
                        <i data-feather="chevron-left"></i>
                    </button>
                     <button class="absolute right-2 top-1/2 -translate-y-1/2 p-2 bg-black/30 hover:bg-black/50 text-white rounded-full z-20 opacity-0 group-hover:opacity-100 transition" on:click={nextSlide}>
                        <i data-feather="chevron-right"></i>
                    </button>
                    
                    <div class="absolute bottom-3 right-4 flex gap-2 z-20">
                        {#each config.sliderImages as _, i}
                             <div class="w-2 h-2 rounded-full transition-colors {i === slideIndex ? 'bg-white' : 'bg-white/40'}"></div>
                        {/each}
                    </div>
                {:else}
                    <div class="text-white/50 flex flex-col items-center">
                        <i data-feather="image" class="w-10 h-10 mb-2"></i>
                        <p>Chưa có ảnh slide.</p>
                     </div>
                {/if}
            </div>
        </div>

        <div class="content-card flex flex-col h-[600px] bg-slate-50">
            <h3 class="text-xl font-bold text-gray-800 mb-4 flex items-center gap-2 border-b pb-2">
                <i data-feather="clock" class="text-green-600"></i> Lịch sử cập nhật
            </h3>
            <div class="flex-grow overflow-y-auto pr-2 custom-scrollbar space-y-4 pb-4">
                {#if config.changelogs && config.changelogs.length > 0}
                   {#each config.changelogs as log}
                        <div class="bg-white p-5 rounded-lg border border-gray-200 shadow-sm hover:shadow-md transition-shadow">
                            <div class="mb-3 border-b border-gray-100 pb-2">
                                <span class="text-lg font-bold text-blue-700">Phiên bản {log.version} <span class="text-gray-500 font-medium text-sm ml-1">({log.date})</span></span>
                            </div>
                            <div class="text-sm text-gray-700 leading-relaxed changelog-content">
                                {@html log.content}
                            </div>
                        </div>
                    {/each}
                {:else}
                    <p class="text-gray-500 italic text-center py-10">Chưa có thông tin cập nhật.</p>
                {/if}
            </div>
        </div>
    </div>
</section>

{#if showQRModal}
    <div 
        class="fixed inset-0 bg-black/60 z-[1300] flex items-center justify-center backdrop-blur-sm p-4"
        on:click={() => showQRModal = false}
        role="button"
        tabindex="0"
    >
        <div class="bg-white rounded-2xl shadow-2xl p-6 max-w-sm w-full text-center relative animate-fade-in" on:click|stopPropagation>
            <button class="absolute top-4 right-4 text-gray-400 hover:text-red-500" on:click={() => showQRModal = false}>
                <i data-feather="x" class="w-6 h-6"></i>
            </button>
            
            <h3 class="text-xl font-bold text-green-600 mb-2">Quét mã tham gia nhóm</h3>
            <p class="text-sm text-gray-500 mb-6">Sử dụng camera hoặc Line để quét</p>
            
            <div class="bg-gray-100 p-4 rounded-xl inline-block mb-4">
                <img 
                    src="/images/qr-line-group.jpg" 
                    alt="Mã QR Nhóm Line" 
                    class="w-48 h-48 object-contain rounded-lg"
                    on:error={(e) => e.target.src = 'https://placehold.co/200x200?text=QR+Code+Here'}
                >
            </div>
            
            <p class="text-xs text-gray-400">Giải đáp thắc mắc hoặc yêu cầu thêm tính năng</p>
        </div>
    </div>
{/if}

<style>
    .custom-scrollbar::-webkit-scrollbar { width: 6px; }
    .custom-scrollbar::-webkit-scrollbar-track { background: #f1f1f1; }
    .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
    .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
    
    .animate-fade-in { animation: fadeIn 0.3s ease-out; }
    @keyframes fadeIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }

    /* Style cho nội dung HTML trong Changelog */
    :global(.changelog-content ul) {
        list-style-type: disc;
        padding-left: 1.5rem;
        margin-top: 0.5rem;
        margin-bottom: 0.5rem;
    }
    :global(.changelog-content li) {
        margin-bottom: 0.25rem;
    }
    :global(.changelog-content strong), :global(.changelog-content b) {
        color: #1f2937; /* gray-800 */
        font-weight: 700;
    }
    :global(.changelog-content p) {
        margin-bottom: 0.5rem;
    }
</style>
--- END FILE: ./src/components/HomeSection.svelte ---

--- START FILE: ./src/components/Sidebar.svelte ---
<script>
  /* global feather */
  import { onMount } from 'svelte';
  // [FIX] Import store isAdmin và modalState để kiểm tra quyền
  import { activeTab, drawerState, isAdmin, modalState } from '../stores.js';

  // Hàm chuyển tab (Cập nhật store global)
  function navigateTo(targetId) {
    // [LOGIC MỚI] Tự động thoát quyền Admin khi rời khỏi tab Khai báo
    if ($activeTab === 'declaration-section' && targetId !== 'declaration-section') {
        isAdmin.set(false);
        console.log("[Security] Đã tự động đăng xuất quyền Admin khi rời trang Khai báo.");
    }

    // Nếu vào Khai báo mà chưa phải Admin -> Bật modal đăng nhập
    if (targetId === 'declaration-section' && !$isAdmin) {
        modalState.update(s => ({ ...s, activeModal: 'admin-modal' }));
        return;
    }
    activeTab.set(targetId);
  }

  // Hàm mở Drawer (Cập nhật store global)
  function openDrawer(drawerId) {
    drawerState.update(state => ({ ...state, activeDrawer: drawerId }));
  }

  // Reactive: Helper để kiểm tra tab nào đang active (để tô màu)
  $: currentTab = $activeTab;

  onMount(() => {
    if (typeof window.feather !== 'undefined') {
      window.feather.replace();
    }
  });
</script>

<nav id="sidebar" class="bg-white/80 backdrop-blur-sm shadow-lg fixed top-0 left-0 h-full z-30 p-3 flex flex-col justify-between">
    <div>
        <button 
           class="nav-link flex items-center p-3 rounded-lg font-semibold mb-4 w-full transition-colors
           {currentTab === 'home-section' ? 'bg-blue-100 text-blue-700' : 'text-gray-700 hover:bg-gray-200'}"
           on:click={() => navigateTo('home-section')}
         >
            <i data-feather="home"></i>
            <span class="menu-text">Hướng Dẫn & Góp Ý</span>
         </button>

        <ul class="space-y-2">
            <li>
                <button 
                  class="nav-link flex items-center p-3 rounded-lg font-semibold w-full transition-colors
                         {currentTab === 'data-section' ? 'bg-blue-100 text-blue-700' : 'text-gray-700 hover:bg-gray-200'}"
                  on:click={() => navigateTo('data-section')}
                >
                    <i data-feather="file-text"></i>
                    <span class="menu-text">Cập nhật dữ liệu</span>
                </button>
            </li>

            <li>
                <button 
                  class="nav-link flex items-center p-3 rounded-lg font-semibold w-full transition-colors
                         {currentTab === 'health-section' ? 'bg-blue-100 text-blue-700' : 'text-gray-700 hover:bg-gray-200'}"
                  on:click={() => navigateTo('health-section')}
                >
                    <i data-feather="activity"></i>
                    <span class="menu-text">Sức khỏe siêu thị</span>
                </button>
            </li>

            <li>
                <button 
                  class="nav-link flex items-center p-3 rounded-lg font-semibold w-full transition-colors
                         {currentTab === 'health-employee-section' ? 'bg-blue-100 text-blue-700' : 'text-gray-700 hover:bg-gray-200'}"
                  on:click={() => navigateTo('health-employee-section')}
                >
                    <i data-feather="users"></i>
                    <span class="menu-text">Sức khỏe nhân viên</span>
                </button>
            </li>

            <li>
                <button 
                  class="nav-link flex items-center p-3 rounded-lg font-semibold w-full transition-colors
                         {currentTab === 'realtime-section' ? 'bg-blue-100 text-blue-700' : 'text-gray-700 hover:bg-gray-200'}"
                  on:click={() => navigateTo('realtime-section')}
                >
                    <i data-feather="trending-up"></i>
                    <span class="menu-text">Doanh thu realtime</span>
                </button>
            </li>
        </ul>
    </div>

    <div>
        <ul class="space-y-2">
            <li>
                 <button 
                   id="interface-settings-btn" 
                   class="w-full flex items-center p-3 text-gray-700 rounded-lg hover:bg-gray-200 font-semibold"
                   on:click={() => openDrawer('interface-drawer')}
                >
                    <i data-feather="settings"></i>
                    <span class="menu-text">Cài đặt giao diện</span>
                </button>
            </li>

            <li>
                 <button 
                  id="goal-settings-btn" 
                  class="w-full flex items-center p-3 text-gray-700 rounded-lg hover:bg-gray-200 font-semibold"
                  on:click={() => openDrawer('goal-drawer')}
                >
                    <i data-feather="target"></i>
                    <span class="menu-text">Thiết lập mục tiêu</span>
                </button>
            </li>

            <li>
                <button 
                  id="admin-access-btn" 
                  class="w-full flex items-center p-3 rounded-lg font-semibold transition-colors
                         {currentTab === 'declaration-section' ? 'bg-blue-100 text-blue-700' : 'text-gray-700 hover:bg-gray-200'}"
                  on:click={() => navigateTo('declaration-section')}
                >
                    <i data-feather="edit"></i>
                    <span class="menu-text">Khai báo</span>
                </button>
            </li>
        </ul>
    </div>
</nav>

<style>
  #sidebar { 
    width: 68px;
    transition: width 0.3s ease-in-out; 
    overflow-x: hidden; 
  }
  #sidebar:hover { 
    width: 256px;
  }
  #sidebar.menu-locked:hover { 
    width: 68px;
  }

  #sidebar .nav-link, #sidebar button {
    white-space: nowrap;
    gap: 1rem;
    justify-content: flex-start;
  }

  .menu-text {
    transition: opacity 0.2s ease-in-out, width 0.3s ease-in-out;
    opacity: 0;
    white-space: nowrap;
    width: 0;
    overflow: hidden;
  }
  #sidebar:hover .menu-text {
    opacity: 1;
    transition-delay: 0.1s;
    width: auto;
  }
  #sidebar.menu-locked:hover .menu-text {
    opacity: 0;
    width: 0;
  }

  #sidebar :global(.feather) {
    width: 1.5rem;
    height: 1.5rem;
    stroke-width: 2;
    flex-shrink: 0;
  }
</style>
--- END FILE: ./src/components/Sidebar.svelte ---

--- START FILE: ./src/components/admin/AdminCalculation.svelte ---
<script>
    import { onMount, afterUpdate } from 'svelte';
    import { declarations } from '../../stores.js';
    import { adminService } from '../../services/admin.service.js';
    import { config } from '../../config.js';

    let ycxValue = '';
    let ycxGopValue = '';
    let heSoValue = '';

    $: if ($declarations) {
        ycxValue = $declarations.hinhThucXuat || config.DEFAULT_DATA.HINH_THUC_XUAT_TINH_DOANH_THU.join('\n');
        ycxGopValue = $declarations.hinhThucXuatGop || config.DEFAULT_DATA.HINH_THUC_XUAT_TRA_GOP.join('\n');
        
        if ($declarations.heSoQuyDoi) {
            heSoValue = $declarations.heSoQuyDoi;
        } else {
            heSoValue = Object.entries(config.DEFAULT_DATA.HE_SO_QUY_DOI)
                .map(([k, v]) => `${k},${v}`)
                .join('\n');
        }
    }

    async function saveDeclarations() {
        const dataToSave = { ycx: ycxValue, ycxGop: ycxGopValue, heSo: heSoValue };
        await adminService.saveDeclarationsToFirestore(dataToSave);
        declarations.set({ 
            hinhThucXuat: ycxValue, 
            hinhThucXuatGop: ycxGopValue, 
            heSoQuyDoi: heSoValue 
        });
    }

    afterUpdate(() => { if (typeof feather !== 'undefined') feather.replace(); });
</script>

<div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden mb-6 transition-all hover:shadow-md">
    <details class="group">
        <summary class="flex justify-between items-center p-5 cursor-pointer bg-white hover:bg-slate-50 transition-colors list-none select-none">
            <div class="flex items-center gap-3">
                <div class="p-2 bg-indigo-50 rounded-lg text-indigo-600">
                    <i data-feather="sliders"></i>
                </div>
                <div>
                    <h3 class="font-bold text-slate-700 text-lg">Dữ liệu tính toán & Logic</h3>
                    <p class="text-xs text-slate-500">Cấu hình Hình thức xuất, Hệ số quy đổi...</p>
                </div>
            </div>
            <span class="transform transition-transform duration-200 group-open:rotate-180 text-slate-400">
                <i data-feather="chevron-down"></i>
            </span>
        </summary>
        
        <div class="p-6 border-t border-slate-100 bg-slate-50/50">
            <div class="grid md:grid-cols-2 gap-6"> 
                <div>
                    <label for="decl-ycx" class="block text-sm font-bold text-slate-700 mb-2 flex items-center gap-2">
                        Hình thức xuất (Tính doanh thu)
                        <span class="text-xs font-normal text-slate-400 bg-white border px-2 py-0.5 rounded-full">Mỗi loại 1 dòng</span>
                    </label> 
                    <textarea id="decl-ycx" rows="8" class="w-full p-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 font-mono text-xs bg-white text-slate-600 leading-relaxed shadow-sm" placeholder="Nhập dữ liệu..." bind:value={ycxValue}></textarea> 
                </div>
                <div> 
                    <label for="decl-ycx-gop" class="block text-sm font-bold text-slate-700 mb-2 flex items-center gap-2">
                        Hình thức xuất (Trả góp)
                         <span class="text-xs font-normal text-slate-400 bg-white border px-2 py-0.5 rounded-full">Mỗi loại 1 dòng</span>
                    </label> 
                    <textarea id="decl-ycx-gop" rows="8" class="w-full p-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 font-mono text-xs bg-white text-slate-600 leading-relaxed shadow-sm" placeholder="Nhập dữ liệu..." bind:value={ycxGopValue}></textarea> 
                </div>
                <div class="md:col-span-2"> 
                    <label for="decl-heso" class="block text-sm font-bold text-slate-700 mb-2 flex items-center gap-2">
                        Hệ số quy đổi
                        <span class="text-xs font-normal text-slate-400 bg-white border px-2 py-0.5 rounded-full">Format: Tên nhóm hàng, Hệ số</span>
                    </label> 
                    <textarea id="decl-heso" rows="8" class="w-full p-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 font-mono text-xs bg-white text-slate-600 leading-relaxed shadow-sm" placeholder="VD: Điện thoại, 1" bind:value={heSoValue}></textarea> 
                </div>
            </div> 
            
            <div class="mt-6 flex justify-end pt-4 border-t border-slate-200">
                <button on:click={saveDeclarations} class="bg-indigo-600 text-white px-5 py-2.5 rounded-lg hover:bg-indigo-700 transition font-semibold shadow-sm flex items-center gap-2">
                    <i data-feather="save" class="w-4 h-4"></i>
                    Lưu Cấu Hình
                </button> 
            </div> 
        </div>
    </details>
</div>
--- END FILE: ./src/components/admin/AdminCalculation.svelte ---

--- START FILE: ./src/components/admin/AdminCategory.svelte ---
<script>
    import { onMount, afterUpdate } from 'svelte';
    import { adminService } from '../../services/admin.service.js';
    
    // Import các component con
    import CategoryUploader from './category/CategoryUploader.svelte';
    import NameMappingEditor from './category/NameMappingEditor.svelte';
    import MacroGroupEditor from './category/MacroGroupEditor.svelte';
    import MacroProductGroupEditor from './category/MacroProductGroupEditor.svelte';

    // [MỚI] Prop điều khiển chế độ hiển thị: 'full' | 'upload' | 'config'
    export let viewMode = 'full';

    onMount(() => {
        // Tải dữ liệu cần thiết khi vào component
        adminService.loadCategoryDataFromFirestore();
    });

    afterUpdate(() => {
        if (typeof feather !== 'undefined') feather.replace();
    });
</script>

<div class="space-y-6">
    {#if viewMode === 'full' || viewMode === 'upload'}
        <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden transition-all hover:shadow-md">
            <details class="group declaration-group">
                <summary class="flex justify-between items-center p-5 cursor-pointer bg-white hover:bg-slate-50 transition-colors list-none select-none">
                    <div class="flex items-center gap-3">
                        <div class="p-2 bg-blue-50 rounded-lg text-blue-600">
                            <i data-feather="upload-cloud"></i>
                        </div>
                        <div>
                            <h3 class="font-bold text-slate-700 text-lg">Nạp dữ liệu Cấu trúc</h3>
                            <p class="text-xs text-slate-500">Tải lên file Excel cấu trúc (Ngành hàng, Nhóm hàng, Hãng)</p>
                        </div>
                    </div>
                    <span class="transform transition-transform duration-200 group-open:rotate-180 text-slate-400">
                        <i data-feather="chevron-down"></i>
                    </span>
                </summary>
                <div class="declaration-content bg-white border-t border-slate-100 p-6">
                    <CategoryUploader />
                </div>
            </details>
        </div>
    {/if}

    {#if viewMode === 'full' || viewMode === 'config'}
        
        <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden transition-all hover:shadow-md">
            <details class="group declaration-group">
                <summary class="flex justify-between items-center p-5 cursor-pointer bg-white hover:bg-slate-50 transition-colors list-none select-none">
                    <div class="flex items-center gap-3">
                        <div class="p-2 bg-purple-50 rounded-lg text-purple-600">
                            <i data-feather="layers"></i>
                        </div>
                        <div>
                            <h3 class="font-bold text-slate-700 text-lg">Khai báo Nhóm Ngành Hàng Lớn</h3>
                            <p class="text-xs text-slate-500">Tạo nhóm gộp (VD: ICT, CE) từ các nhóm hàng con</p>
                        </div>
                    </div>
                    <span class="transform transition-transform duration-200 group-open:rotate-180 text-slate-400">
                        <i data-feather="chevron-down"></i>
                    </span>
                </summary>
                <div class="declaration-content bg-white border-t border-slate-100 p-6">
                    <MacroGroupEditor />
                </div>
            </details>
        </div>

        <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden transition-all hover:shadow-md">
            <details class="group declaration-group">
                <summary class="flex justify-between items-center p-5 cursor-pointer bg-white hover:bg-slate-50 transition-colors list-none select-none">
                    <div class="flex items-center gap-3">
                        <div class="p-2 bg-teal-50 rounded-lg text-teal-600">
                            <i data-feather="package"></i>
                        </div>
                        <div>
                            <h3 class="font-bold text-slate-700 text-lg">Khai báo Nhóm Hàng Lớn</h3>
                            <p class="text-xs text-slate-500">Tạo nhóm gộp (VD: Gia dụng lớn) từ các nhóm hàng nhỏ</p>
                        </div>
                    </div>
                    <span class="transform transition-transform duration-200 group-open:rotate-180 text-slate-400">
                        <i data-feather="chevron-down"></i>
                    </span>
                </summary>
                <div class="declaration-content bg-white border-t border-slate-100 p-6">
                    <MacroProductGroupEditor />
                </div>
            </details>
        </div>

        <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden transition-all hover:shadow-md">
            <details class="group declaration-group">
                <summary class="flex justify-between items-center p-5 cursor-pointer bg-white hover:bg-slate-50 transition-colors list-none select-none">
                    <div class="flex items-center gap-3">
                        <div class="p-2 bg-green-50 rounded-lg text-green-600">
                            <i data-feather="tag"></i>
                        </div>
                        <div>
                            <h3 class="font-bold text-slate-700 text-lg">Khai báo Tên Ngành Hàng</h3>
                            <p class="text-xs text-slate-500">Chỉnh sửa tên hiển thị cho Ngành Hàng</p>
                        </div>
                    </div>
                    <span class="transform transition-transform duration-200 group-open:rotate-180 text-slate-400">
                        <i data-feather="chevron-down"></i>
                    </span>
                </summary>
                <div class="declaration-content bg-white border-t border-slate-100 p-6">
                    <NameMappingEditor type="category" />
                </div>
            </details>
        </div>

        <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden transition-all hover:shadow-md">
            <details class="group declaration-group">
                <summary class="flex justify-between items-center p-5 cursor-pointer bg-white hover:bg-slate-50 transition-colors list-none select-none">
                    <div class="flex items-center gap-3">
                        <div class="p-2 bg-orange-50 rounded-lg text-orange-600">
                            <i data-feather="package"></i>
                        </div>
                        <div>
                            <h3 class="font-bold text-slate-700 text-lg">Khai báo Tên Nhóm Hàng</h3>
                            <p class="text-xs text-slate-500">Chỉnh sửa tên hiển thị cho Nhóm Hàng</p>
                        </div>
                    </div>
                    <span class="transform transition-transform duration-200 group-open:rotate-180 text-slate-400">
                        <i data-feather="chevron-down"></i>
                    </span>
                </summary>
                <div class="declaration-content bg-white border-t border-slate-100 p-6">
                    <NameMappingEditor type="group" />
                </div>
            </details>
        </div>

        <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden transition-all hover:shadow-md">
            <details class="group declaration-group">
                <summary class="flex justify-between items-center p-5 cursor-pointer bg-white hover:bg-slate-50 transition-colors list-none select-none">
                    <div class="flex items-center gap-3">
                        <div class="p-2 bg-red-50 rounded-lg text-red-600">
                            <i data-feather="briefcase"></i>
                        </div>
                        <div>
                            <h3 class="font-bold text-slate-700 text-lg">Khai báo Tên Hãng</h3>
                            <p class="text-xs text-slate-500">Chỉnh sửa tên hiển thị cho Nhà sản xuất</p>
                        </div>
                    </div>
                    <span class="transform transition-transform duration-200 group-open:rotate-180 text-slate-400">
                        <i data-feather="chevron-down"></i>
                    </span>
                </summary>
                <div class="declaration-content bg-white border-t border-slate-100 p-6">
                    <NameMappingEditor type="brand" />
                </div>
            </details>
        </div>
    {/if}
</div>
--- END FILE: ./src/components/admin/AdminCategory.svelte ---

--- START FILE: ./src/components/admin/AdminCompetition.svelte ---
<script>
    import { onMount, afterUpdate } from 'svelte';
    import { globalCompetitionConfigs, brandList, categoryStructure } from '../../stores.js';
    import { adminService } from '../../services/admin.service.js';

    let isFormOpen = false;
    let editingIndex = -1;
    let isLoading = false;

    // Biến tìm kiếm
    let searchBrand = '';
    let searchGroup = '';

    let formData = { id: '', name: '', brands: [], groups: [], type: 'doanhthu', minPrice: '', maxPrice: '', excludeApple: false };

    $: availableBrands = $brandList || [];
    $: availableGroups = [...new Set(($categoryStructure || []).map(c => c.nhomHang).filter(Boolean))].sort();

    // Lọc danh sách dựa trên từ khóa tìm kiếm
    $: filteredBrands = availableBrands.filter(b => b.toLowerCase().includes(searchBrand.toLowerCase()));
    $: filteredGroups = availableGroups.filter(g => g.toLowerCase().includes(searchGroup.toLowerCase()));

    function resetForm() {
        formData = { id: '', name: '', brands: [], groups: [], type: 'doanhthu', minPrice: '', maxPrice: '', excludeApple: false };
        editingIndex = -1;
        searchBrand = '';
        searchGroup = '';
    }
    function openAddForm() { resetForm(); isFormOpen = true; }
    function openEditForm(index) {
        const config = $globalCompetitionConfigs[index];
        editingIndex = index;
        formData = {
            id: config.id, name: config.name, brands: [...(config.brands || [])], groups: [...(config.groups || [])],
            type: config.type || 'doanhthu',
            minPrice: config.minPrice ? config.minPrice / 1000000 : '',
            maxPrice: config.maxPrice ? config.maxPrice / 1000000 : '',
            excludeApple: config.excludeApple || false
        };
        isFormOpen = true;
    }
    function closeForm() { isFormOpen = false; resetForm(); }
    function toggleSelection(list, item) { return list.includes(item) ? list.filter(i => i !== item) : [...list, item]; }

    async function saveCompetition() {
        if (!formData.name) return alert("Vui lòng nhập tên chương trình!");
        if (formData.brands.length === 0) return alert("Vui lòng chọn ít nhất một Hãng!");
        isLoading = true;
        const configToSave = {
            id: formData.id || `comp_${Date.now()}`,
            name: formData.name, brands: formData.brands, groups: formData.groups,
            type: formData.type,
            minPrice: formData.minPrice ? parseFloat(formData.minPrice) * 1000000 : 0,
            maxPrice: formData.maxPrice ? parseFloat(formData.maxPrice) * 1000000 : 0,
            excludeApple: formData.excludeApple
        };

        let newConfigs = [...$globalCompetitionConfigs];
        if (editingIndex >= 0) newConfigs[editingIndex] = configToSave; else newConfigs.push(configToSave);

        // Cập nhật UI ngay lập tức
        globalCompetitionConfigs.set(newConfigs);
        localStorage.setItem('temp_globalCompetitionConfigs', JSON.stringify(newConfigs)); // Backup LocalStorage

        try {
            await adminService.saveGlobalCompetitionConfigs(newConfigs);
        } catch (error) { 
            console.error("Lỗi Cloud:", error);
            alert(`Lưu Cloud thất bại (${error.code}). Dữ liệu đã được lưu vào trình duyệt để bạn test.`);
        } finally { 
            isLoading = false; 
            closeForm();
        }
    }

    async function deleteCompetition(index) {
        if (!confirm("Xóa chương trình này?")) return;
        let newConfigs = [...$globalCompetitionConfigs];
        newConfigs.splice(index, 1);
        
        globalCompetitionConfigs.set(newConfigs);
        localStorage.setItem('temp_globalCompetitionConfigs', JSON.stringify(newConfigs));

        try {
            await adminService.saveGlobalCompetitionConfigs(newConfigs);
        } catch (error) { 
             console.error("Lỗi Cloud:", error);
             // Không alert lỗi xóa để trải nghiệm mượt hơn, vì đã xóa ở local
        }
    }

    onMount(() => {
        if ($globalCompetitionConfigs.length === 0) {
            const backup = localStorage.getItem('temp_globalCompetitionConfigs');
            if (backup) globalCompetitionConfigs.set(JSON.parse(backup));
        }
    });
    afterUpdate(() => { if (typeof feather !== 'undefined') feather.replace(); });
</script>

<div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden mb-6 transition-all hover:shadow-md">
    <div class="p-5 bg-white border-b border-slate-100 flex justify-between items-center">
        <div class="flex items-center gap-4">
            <div class="p-2.5 bg-red-50 rounded-lg text-red-600 shadow-sm">
                <i data-feather="flag" class="w-6 h-6"></i>
            </div>
            <div>
                <div class="flex items-center gap-3">
                    <h3 class="font-bold text-slate-800 text-lg">Quản lý Thi Đua (Global)</h3>
                    <span class="bg-red-100 text-red-700 text-[10px] font-extrabold px-2 py-0.5 rounded-full uppercase tracking-wide border border-red-200">Quan trọng</span>
                </div>
                <p class="text-sm text-slate-500 mt-0.5">Cấu hình các chương trình thi đua áp dụng cho toàn hệ thống</p>
            </div>
        </div>
    </div>
    
    <div class="p-6 bg-slate-50/30"> 
        {#if !isFormOpen}
            <div class="space-y-3">
                {#if $globalCompetitionConfigs.length === 0}
                    <div class="text-center py-10 border-2 border-dashed border-slate-200 rounded-xl bg-slate-50">
                        <p class="text-slate-400 italic mb-4">Chưa có chương trình thi đua nào.</p>
                        <button on:click={openAddForm} class="px-4 py-2 bg-white border border-slate-300 text-slate-600 rounded-lg hover:border-blue-500 hover:text-blue-600 font-medium transition shadow-sm">
                            + Tạo chương trình đầu tiên
                        </button>
                    </div>
                {:else}
                    {#each $globalCompetitionConfigs as config, index}
                        <div class="flex justify-between items-center p-4 bg-white rounded-xl border border-slate-200 shadow-sm hover:border-blue-300 hover:shadow-md transition group/item">
                            <div>
                                <div class="flex items-center gap-3">
                                    <h4 class="font-bold text-slate-800 text-base">{config.name}</h4>
                                    <span class="text-[10px] uppercase px-2 py-0.5 rounded-full font-bold border {config.type === 'doanhthu' ? 'bg-blue-50 text-blue-700 border-blue-100' : 'bg-yellow-50 text-yellow-700 border-yellow-100'}">
                                        {config.type === 'doanhthu' ? 'Doanh thu' : 'Số lượng'}
                                    </span>
                                </div>
                                <div class="text-xs text-slate-500 mt-1.5 flex items-center gap-4">
                                    <span class="flex items-center gap-1 bg-slate-100 px-2 py-0.5 rounded"><i data-feather="briefcase" class="w-3 h-3"></i> {config.brands.join(', ')}</span>
                                    <span class="flex items-center gap-1 bg-slate-100 px-2 py-0.5 rounded"><i data-feather="layers" class="w-3 h-3"></i> {config.groups.length > 0 ? config.groups.join(', ') : 'Tất cả nhóm'}</span>
                                </div>
                            </div>
                            <div class="flex gap-2 opacity-100 sm:opacity-0 sm:group-hover/item:opacity-100 transition-opacity">
                                <button on:click={() => openEditForm(index)} class="p-2 text-slate-400 hover:text-blue-600 hover:bg-blue-50 rounded-lg transition" title="Sửa"><i data-feather="edit-2" class="w-4 h-4"></i></button>
                                <button on:click={() => deleteCompetition(index)} class="p-2 text-slate-400 hover:text-red-600 hover:bg-red-50 rounded-lg transition" title="Xóa"><i data-feather="trash-2" class="w-4 h-4"></i></button>
                            </div>
                        </div>
                    {/each}
                    <button on:click={openAddForm} class="w-full py-3 mt-4 border-2 border-dashed border-slate-300 rounded-xl text-slate-500 hover:border-blue-500 hover:text-blue-600 hover:bg-blue-50/50 font-semibold transition flex justify-center items-center gap-2">
                        <i data-feather="plus-circle" class="w-5 h-5"></i> Thêm chương trình mới
                    </button>
                {/if}
            </div>
        {:else}
            <div class="bg-white p-6 rounded-xl border border-blue-100 shadow-lg animate-fade-in relative">
                <button on:click={closeForm} class="absolute top-4 right-4 text-slate-400 hover:text-slate-600 p-1 rounded-md hover:bg-slate-100 transition">
                    <i data-feather="x" class="w-5 h-5"></i>
                </button>

                <h3 class="font-bold text-lg mb-6 text-slate-800 flex items-center gap-2">
                    <span class="bg-blue-100 text-blue-600 p-1.5 rounded-lg"><i data-feather={editingIndex >= 0 ? "edit" : "plus"} class="w-4 h-4"></i></span>
                    {editingIndex >= 0 ? 'Chỉnh sửa chương trình' : 'Thêm chương trình mới'}
                </h3>
                
                <div class="space-y-5">
                    <div>
                        <label class="block text-sm font-bold text-slate-700 mb-1">Tên chương trình</label>
                        <input type="text" bind:value={formData.name} class="w-full p-2.5 border border-slate-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition" placeholder="VD: Thi đua Tivi Sony T9...">
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label class="block text-sm font-bold text-slate-700 mb-2">Hãng sản xuất (Bắt buộc)</label>
                            <input type="text" bind:value={searchBrand} class="w-full mb-2 p-2 border rounded text-xs" placeholder="🔍 Tìm hãng..." />
                            <div class="h-40 overflow-y-auto p-3 border border-slate-200 rounded-lg bg-slate-50 grid grid-cols-2 gap-2 custom-scrollbar">
                                {#each filteredBrands as brand}
                                    <label class="flex items-center space-x-2 text-sm cursor-pointer hover:bg-white p-1.5 rounded-md transition border border-transparent hover:border-slate-200">
                                        <input type="checkbox" checked={formData.brands.includes(brand)} on:change={() => formData.brands = toggleSelection(formData.brands, brand)} class="rounded text-blue-600 focus:ring-blue-500 border-slate-300">
                                        <span class="text-slate-700 truncate" title={brand}>{brand}</span>
                                    </label>
                                {/each}
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-bold text-slate-700 mb-2">Nhóm hàng</label>
                            <input type="text" bind:value={searchGroup} class="w-full mb-2 p-2 border rounded text-xs" placeholder="🔍 Tìm nhóm hàng..." />
                            <div class="h-40 overflow-y-auto p-3 border border-slate-200 rounded-lg bg-slate-50 grid grid-cols-1 gap-2 custom-scrollbar">
                                {#each filteredGroups as group}
                                    <label class="flex items-center space-x-2 text-sm cursor-pointer hover:bg-white p-1.5 rounded-md transition border border-transparent hover:border-slate-200">
                                        <input type="checkbox" checked={formData.groups.includes(group)} on:change={() => formData.groups = toggleSelection(formData.groups, group)} class="rounded text-blue-600 focus:ring-blue-500 border-slate-300">
                                        <span class="text-slate-700 truncate" title={group}>{group}</span>
                                    </label>
                                {/each}
                            </div>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 bg-slate-50 p-4 rounded-lg border border-slate-200">
                        <div>
                            <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Loại đo lường</label>
                            <select bind:value={formData.type} class="w-full p-2 border border-slate-300 rounded-md text-sm bg-white focus:ring-1 focus:ring-blue-500">
                                <option value="doanhthu">Theo Doanh thu</option>
                                <option value="soluong">Theo Số lượng</option>
                            </select>
                        </div>
                        {#if formData.type === 'soluong'}
                            <div class="animate-fade-in">
                                <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Giá từ (Tr)</label>
                                <input type="number" bind:value={formData.minPrice} class="w-full p-2 border border-slate-300 rounded-md text-sm focus:ring-1 focus:ring-blue-500" placeholder="VD: 3">
                            </div>
                            <div class="animate-fade-in">
                                <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Giá đến (Tr)</label>
                                <input type="number" bind:value={formData.maxPrice} class="w-full p-2 border border-slate-300 rounded-md text-sm focus:ring-1 focus:ring-blue-500" placeholder="VD: 10">
                            </div>
                        {/if}
                    </div>
                    <div class="flex items-center gap-2 pl-1">
                        <input type="checkbox" id="exclude-apple" bind:checked={formData.excludeApple} class="rounded text-blue-600 focus:ring-blue-500 border-slate-300 w-4 h-4">
                        <label for="exclude-apple" class="text-sm text-slate-700 cursor-pointer font-medium select-none">Trừ hãng Apple khỏi dữ liệu</label>
                    </div>
                    <div class="flex justify-end gap-3 mt-8 pt-4 border-t border-slate-100">
                        <button on:click={closeForm} class="px-5 py-2.5 text-slate-600 bg-white border border-slate-300 rounded-lg hover:bg-slate-50 transition font-medium" disabled={isLoading}>Hủy bỏ</button>
                        <button on:click={saveCompetition} class="px-5 py-2.5 bg-blue-600 text-white font-bold rounded-lg hover:bg-blue-700 transition flex items-center gap-2 shadow-md disabled:opacity-70" disabled={isLoading}>
                            {#if isLoading}<span class="animate-spin">↻</span>{/if}
                            {!isLoading ? 'Lưu Chương trình' : 'Đang lưu...'}
                        </button>
                    </div>
                </div>
            </div>
        {/if}
    </div>
</div>
--- END FILE: ./src/components/admin/AdminCompetition.svelte ---

--- START FILE: ./src/components/admin/AdminConfig.svelte ---
<script>
    import { onMount } from 'svelte';
    import { declarations } from '../../stores.js';
    import { adminService } from '../../services/admin.service.js';

    let config = {
        ycx: '',
        ycxGop: '',
        heSo: ''
    };

    onMount(async () => {
        const data = await adminService.loadDeclarationsFromFirestore();
        config.ycx = data.hinhThucXuat || '';
        config.ycxGop = data.hinhThucXuatGop || '';
        config.heSo = data.heSoQuyDoi || '';
    });

    async function handleSave() {
        await adminService.saveDeclarationsToFirestore(config);
    }
</script>

<div class="grid grid-cols-1 md:grid-cols-2 gap-6">
    <div class="bg-white p-5 rounded-lg border border-slate-200 shadow-sm">
        <h4 class="font-bold text-slate-800 mb-2">Hình thức xuất (YCX)</h4>
        <textarea bind:value={config.ycx} class="w-full h-32 p-2 border rounded text-sm" placeholder="Nhập các hình thức xuất, cách nhau dấu phẩy..."></textarea>
    </div>

    <div class="bg-white p-5 rounded-lg border border-slate-200 shadow-sm">
        <h4 class="font-bold text-slate-800 mb-2">Hình thức xuất gộp (YCX Gộp)</h4>
        <textarea bind:value={config.ycxGop} class="w-full h-32 p-2 border rounded text-sm" placeholder="Nhập các hình thức gộp..."></textarea>
    </div>

    <div class="bg-white p-5 rounded-lg border border-slate-200 shadow-sm md:col-span-2">
        <h4 class="font-bold text-slate-800 mb-2">Hệ số quy đổi</h4>
        <textarea bind:value={config.heSo} class="w-full h-32 p-2 border rounded text-sm font-mono" placeholder="JSON hệ số quy đổi..."></textarea>
    </div>

    <div class="md:col-span-2 flex justify-end">
        <button on:click={handleSave} class="px-6 py-2 bg-blue-600 text-white font-bold rounded hover:bg-blue-700">Lưu Cấu Hình</button>
    </div>
</div>
--- END FILE: ./src/components/admin/AdminConfig.svelte ---

--- START FILE: ./src/components/admin/AdminEfficiency.svelte ---
<script>
    import { onMount } from 'svelte';
    import { efficiencyConfig, modalState } from '../../stores.js';
    import { adminService } from '../../services/admin.service.js';
    
    // Load config khi mount
    onMount(async () => {
        const configs = await adminService.loadEfficiencyConfig();
        efficiencyConfig.set(configs);
    });

    function openAddModal() {
        // Mở modal thêm chỉ số (Tận dụng modal đã có)
        modalState.update(s => ({ ...s, activeModal: 'add-efficiency-modal', payload: null }));
    }

    function editItem(item) {
        modalState.update(s => ({ ...s, activeModal: 'add-efficiency-modal', payload: item }));
    }

    async function deleteItem(id) {
        if (!confirm("Bạn có chắc muốn xóa chỉ số hệ thống này? Nó sẽ biến mất khỏi bảng của tất cả người dùng.")) return;
        
        const newConfig = $efficiencyConfig.filter(i => i.id !== id);
        efficiencyConfig.set(newConfig);
        await adminService.saveEfficiencyConfig(newConfig);
    }
</script>

<div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden mb-6 transition-all hover:shadow-md">
    <div class="p-5 bg-white border-b border-slate-100 flex justify-between items-center">
        <div class="flex items-center gap-4">
            <div class="p-2.5 bg-orange-50 rounded-lg text-orange-600 shadow-sm">
               <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" /></svg>
            </div>
            <div>
                <div class="flex items-center gap-3">
                    <h3 class="font-bold text-slate-800 text-lg">Khai báo chỉ số hiệu quả</h3>
                    <span class="bg-orange-100 text-orange-700 text-[10px] font-extrabold px-2 py-0.5 rounded-full uppercase tracking-wide border border-orange-200">Global</span>
                </div>
                <p class="text-sm text-slate-500 mt-0.5">Các chỉ số này sẽ hiển thị mặc định cho toàn bộ nhân viên/siêu thị</p>
            </div>
        </div>
        <button on:click={openAddModal} class="px-4 py-2 bg-orange-600 text-white rounded-lg hover:bg-orange-700 font-bold shadow-sm flex items-center gap-2 text-sm transition-all">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" /></svg>
            Thêm chỉ số
        </button>
    </div>
    
    <div class="p-6 bg-slate-50/50">
        {#if $efficiencyConfig.length === 0}
            <div class="text-center py-8 border-2 border-dashed border-slate-300 rounded-xl">
                <p class="text-slate-500 italic">Chưa có chỉ số hệ thống nào.</p>
            </div>
        {:else}
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                {#each $efficiencyConfig as item}
                    <div class="bg-white p-4 rounded-lg border border-slate-200 shadow-sm flex flex-col hover:border-orange-300 transition-colors group relative">
                        <div class="flex justify-between items-start mb-2">
                            <h4 class="font-bold text-slate-800">{item.label}</h4>
                            <div class="flex gap-1 opacity-0 group-hover:opacity-100 transition-opacity absolute top-2 right-2 bg-white/90 p-1 rounded border border-gray-100 shadow-sm">
                                <button class="p-1.5 text-slate-400 hover:text-blue-600 hover:bg-blue-50 rounded" title="Sửa" on:click={() => editItem(item)}>
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" /></svg>
                                </button>
                                <button class="p-1.5 text-slate-400 hover:text-red-600 hover:bg-red-50 rounded" title="Xóa" on:click={() => deleteItem(item.id)}>
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
                                </button>
                            </div>
                        </div>
                        
                        <div class="text-xs text-slate-500 space-y-1 mt-auto">
                            <p><strong>Loại:</strong> {item.type === 'SL' ? 'Số lượng' : (item.type === 'DTQD' ? 'Doanh thu QĐ' : 'Doanh thu Thực')}</p>
                            <p><strong>Mục tiêu:</strong> {item.target}%</p>
                            <p class="truncate" title={item.groupA.join(', ')}><strong>Tử số:</strong> {item.groupA.length} mục đã chọn</p>
                            <p class="truncate" title={item.groupB.join(', ')}><strong>Mẫu số:</strong> {item.groupB.length} mục đã chọn</p>
                        </div>
                    </div>
                {/each}
            </div>
        {/if}
    </div>
</div>
--- END FILE: ./src/components/admin/AdminEfficiency.svelte ---

--- START FILE: ./src/components/admin/AdminGoalSettings.svelte ---
<script>
    import { onMount } from 'svelte';
    import { warehouseList, luykeGoalSettings } from '../../stores.js';
    import { datasyncService } from '../../services/datasync.service.js';

    let selectedKho = '';
    let currentGoals = {};
    let isLoading = false;

    // Khi chọn kho, load dữ liệu mục tiêu của kho đó
    async function handleWarehouseChange() {
        if (!selectedKho) {
            currentGoals = {};
            return;
        }
        isLoading = true;
        try {
            const settings = await datasyncService.loadGoalSettings(selectedKho);
            currentGoals = settings.luyke || {};
        } catch (error) {
            console.error(error);
        } finally {
            isLoading = false;
        }
    }

    async function saveGoals() {
        if (!selectedKho) return alert("Vui lòng chọn Kho.");
        isLoading = true;
        try {
            await datasyncService.saveGoalSettings(selectedKho, 'luyke', currentGoals);
            alert(`Đã lưu mục tiêu cho kho ${selectedKho} thành công!`);
        } catch (error) {
            alert("Lỗi khi lưu: " + error.message);
        } finally {
            isLoading = false;
        }
    }
</script>

<div class="bg-white p-6 rounded-lg border border-slate-200 shadow-sm">
    <div class="mb-6">
        <label class="block text-sm font-bold text-slate-700 mb-2">Chọn Kho thiết lập:</label>
        <select 
            bind:value={selectedKho} 
            on:change={handleWarehouseChange}
            class="w-full md:w-1/3 p-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none"
        >
            <option value="">-- Chọn kho --</option>
            {#each $warehouseList as kho}
                <option value={kho}>{kho}</option>
            {/each}
        </select>
    </div>

    {#if selectedKho}
        <div class="space-y-4">
            <div class="p-4 bg-yellow-50 text-yellow-800 text-sm rounded border border-yellow-200">
                <i data-feather="info" class="w-4 h-4 inline mr-1"></i>
                Hệ thống đang cập nhật giao diện thiết lập mục tiêu chi tiết. Hiện tại vui lòng sử dụng file Excel hoặc chức năng import.
            </div>
            
            <div class="border-t pt-4">
                <h4 class="font-bold text-gray-700 mb-2">Cấu hình JSON (Nâng cao)</h4>
                <textarea 
                    class="w-full h-64 p-3 border border-gray-300 rounded font-mono text-sm"
                    value={JSON.stringify(currentGoals, null, 2)}
                    on:input={(e) => {
                        try { currentGoals = JSON.parse(e.target.value); } catch(err){}
                    }}
                ></textarea>
            </div>

            <button 
                on:click={saveGoals} 
                disabled={isLoading}
                class="px-6 py-2 bg-green-600 text-white font-bold rounded hover:bg-green-700 transition disabled:opacity-50"
            >
                {isLoading ? 'Đang lưu...' : 'Lưu Cấu Hình'}
            </button>
        </div>
    {/if}
</div>
--- END FILE: ./src/components/admin/AdminGoalSettings.svelte ---

--- START FILE: ./src/components/admin/AdminHelp.svelte ---
<script>
    import { afterUpdate } from 'svelte';
    import { helpContent } from '../../stores.js';
    import { adminService } from '../../services/admin.service.js';

    let localHelpContent = { ...$helpContent };

    $: if ($helpContent) {
        if (!localHelpContent.data && $helpContent.data) localHelpContent = { ...$helpContent };
    }

    async function saveHelp() {
        await adminService.saveHelpContent(localHelpContent);
        helpContent.set({ ...localHelpContent });
    }

    afterUpdate(() => { if (typeof feather !== 'undefined') feather.replace(); });
</script>

<div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden mb-6 transition-all hover:shadow-md">
    <details class="group"> 
        <summary class="flex justify-between items-center p-5 cursor-pointer bg-white hover:bg-slate-50 transition-colors list-none select-none">
            <div class="flex items-center gap-3">
                <div class="p-2 bg-green-50 rounded-lg text-green-600">
                    <i data-feather="book-open"></i>
                </div>
                <div>
                    <h3 class="font-bold text-slate-700 text-lg">Nội dung Hướng dẫn</h3>
                    <p class="text-xs text-slate-500">Chỉnh sửa popup hướng dẫn (?) tại các tab</p>
                </div>
            </div>
            <span class="transform transition-transform duration-200 group-open:rotate-180 text-slate-400">
                <i data-feather="chevron-down"></i>
            </span>
        </summary> 
        
        <div class="p-6 border-t border-slate-100 bg-slate-50/50"> 
            <div class="grid grid-cols-1 gap-6"> 
                {#each [
                    { id: 'data', label: 'Tab Cập nhật dữ liệu' },
                    { id: 'luyke', label: 'Tab Lũy kế' },
                    { id: 'sknv', label: 'Tab Sức khỏe NV' },
                    { id: 'realtime', label: 'Tab Realtime' }
                ] as tab}
                    <div class="bg-white p-4 rounded-lg border border-slate-200 shadow-sm">
                        <label for="help-{tab.id}" class="block text-sm font-bold text-slate-700 mb-2">{tab.label}</label>
                        <textarea 
                            id="help-{tab.id}" 
                            rows="4" 
                            class="w-full p-3 border border-slate-300 rounded-lg text-sm focus:ring-2 focus:ring-green-500 focus:border-green-500 outline-none text-slate-600" 
                            bind:value={localHelpContent[tab.id]}
                            placeholder="Nhập nội dung hướng dẫn (hỗ trợ HTML cơ bản)..."
                        ></textarea>
                    </div>
                {/each}
            </div> 
            <div class="mt-6 flex justify-end pt-4 border-t border-slate-200">
                <button on:click={saveHelp} class="bg-green-600 text-white px-5 py-2.5 rounded-lg hover:bg-green-700 transition font-semibold shadow-sm flex items-center gap-2">
                    <i data-feather="save" class="w-4 h-4"></i>
                    Lưu Hướng Dẫn
                </button> 
            </div> 
        </div>
    </details>
</div>
--- END FILE: ./src/components/admin/AdminHelp.svelte ---

--- START FILE: ./src/components/admin/AdminHomeConfig.svelte ---
<script>
    // Version 2.2 - Larger Textarea and Template Insert for Changelog
    import { onMount, afterUpdate } from 'svelte';
    import { homeConfig } from '../../stores.js';
    import { adminService } from '../../services/admin.service.js';

    let localConfig = {
        videoUrl: '',
        timeline: [],
        sliderImages: [],
        changelogs: []
    };

    $: if ($homeConfig) {
        localConfig = JSON.parse(JSON.stringify($homeConfig));
    }

    let activeTab = 'video'; 
    let isSaving = false;

    // --- LOGIC TIMELINE VIDEO ---
    function addTimelineItem() {
        localConfig.timeline = [...localConfig.timeline, { time: '00:00', label: 'Mốc mới' }];
    }
    function removeTimelineItem(index) {
        localConfig.timeline = localConfig.timeline.filter((_, i) => i !== index);
    }

    // --- LOGIC SLIDER ẢNH ---
    function addSliderItem() {
        localConfig.sliderImages = [...localConfig.sliderImages, { url: '', title: '' }];
    }
    function removeSliderItem(index) {
        localConfig.sliderImages = localConfig.sliderImages.filter((_, i) => i !== index);
    }

    // --- LOGIC CHANGELOG ---
    function addChangelogItem() {
        const today = new Date().toLocaleDateString('vi-VN');
        localConfig.changelogs = [{ version: '', date: today, content: '' }, ...localConfig.changelogs];
    }
    function removeChangelogItem(index) {
        localConfig.changelogs = localConfig.changelogs.filter((_, i) => i !== index);
    }
    
    // [MỚI] Hàm chèn mẫu soạn thảo
    function insertTemplate(index) {
        const template = `<ul>
    <li><strong>Tính năng chính 1:</strong>
        <ul style="list-style-type: circle; margin-left: 20px;">
            <li>Chi tiết A</li>
            <li>Chi tiết B</li>
        </ul>
    </li>
    <li><strong>Sửa lỗi:</strong> Mô tả lỗi đã sửa.</li>
</ul>`;
        localConfig.changelogs[index].content = template;
    }

    // --- HÀM LƯU CHUNG ---
    async function saveAllConfig() {
        console.log("Đang lưu cấu hình...", localConfig);
        isSaving = true;
        try {
            await adminService.saveHomeConfig(localConfig);
        } catch (e) {
            console.error(e);
            alert("Lỗi khi lưu: " + e.message);
        } finally {
            isSaving = false;
        }
    }

    afterUpdate(() => { if (typeof feather !== 'undefined') feather.replace(); });
</script>

<div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden mb-6 transition-all hover:shadow-md">
    <details class="group" open> <summary class="flex justify-between items-center p-5 cursor-pointer bg-white hover:bg-slate-50 transition-colors list-none select-none">
            <div class="flex items-center gap-3">
                <div class="p-2 bg-pink-50 rounded-lg text-pink-600">
                    <i data-feather="layout"></i>
                </div>
                <div>
                    <h3 class="font-bold text-slate-700 text-lg">Quản lý Trang chủ</h3>
                    <p class="text-xs text-slate-500">Cấu hình Video, Slide ảnh & Lịch sử cập nhật</p>
                </div>
            </div>
            <span class="transform transition-transform duration-200 group-open:rotate-180 text-slate-400">
                <i data-feather="chevron-down"></i>
            </span>
        </summary>
        
        <div class="p-6 border-t border-slate-100 bg-slate-50/50">
            
            <div class="flex space-x-2 mb-6 border-b border-gray-200 pb-1">
                <button 
                    class="px-4 py-2 font-medium text-sm rounded-t-lg transition-colors {activeTab === 'video' ? 'bg-white text-pink-600 border-x border-t border-gray-200' : 'text-gray-500 hover:text-gray-700'}"
                    on:click={() => activeTab = 'video'}
                >
                    Video & Timeline
                </button>
                <button 
                    class="px-4 py-2 font-medium text-sm rounded-t-lg transition-colors {activeTab === 'slider' ? 'bg-white text-pink-600 border-x border-t border-gray-200' : 'text-gray-500 hover:text-gray-700'}"
                    on:click={() => activeTab = 'slider'}
                >
                    Slide Ảnh
                </button>
                <button 
                    class="px-4 py-2 font-medium text-sm rounded-t-lg transition-colors {activeTab === 'changelog' ? 'bg-white text-pink-600 border-x border-t border-gray-200' : 'text-gray-500 hover:text-gray-700'}"
                    on:click={() => activeTab = 'changelog'}
                >
                    Lịch sử cập nhật
                </button>
            </div>

            {#if activeTab === 'video'}
                <div class="space-y-4 animate-fade-in">
                    <div>
                        <label class="block text-sm font-bold text-slate-700 mb-1">Youtube Embed URL</label>
                        <input type="text" bind:value={localConfig.videoUrl} class="w-full p-2 border rounded-md text-sm" placeholder="https://www.youtube.com/embed/...">
                        <p class="text-xs text-gray-400 mt-1">Lưu ý: Phải là link "Embed" (Nhúng) của Youtube.</p>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-bold text-slate-700 mb-2">Timeline (Mục lục video)</label>
                        <div class="space-y-2">
                            {#each localConfig.timeline as item, index}
                                <div class="flex items-center gap-2">
                                    <input type="text" bind:value={item.time} class="w-20 p-2 border rounded-md text-sm text-center" placeholder="00:00">
                                    <input type="text" bind:value={item.label} class="flex-grow p-2 border rounded-md text-sm" placeholder="Mô tả...">
                                    <button on:click={() => removeTimelineItem(index)} class="text-red-500 hover:bg-red-50 p-2 rounded"><i data-feather="trash-2" class="w-4 h-4"></i></button>
                                </div>
                            {/each}
                        </div>
                        <button on:click={addTimelineItem} class="mt-2 text-sm text-blue-600 hover:underline flex items-center gap-1">
                            <i data-feather="plus" class="w-3 h-3"></i> Thêm mốc thời gian
                        </button>
                    </div>
                </div>
            {/if}

            {#if activeTab === 'slider'}
                <div class="space-y-4 animate-fade-in">
                    <p class="text-xs text-gray-500 bg-blue-50 p-2 rounded">
                        Mẹo: Sử dụng link trực tiếp của ảnh (đuôi .jpg, .png). Hoặc đường dẫn nội bộ (VD: /slides/anh1.jpg).
                    </p>
                    <div class="space-y-4">
                        {#each localConfig.sliderImages as img, index}
                            <div class="flex flex-col gap-2 p-3 border rounded-lg bg-white shadow-sm">
                                <div class="flex justify-between items-center">
                                    <span class="text-xs font-bold text-gray-400">Slide #{index + 1}</span>
                                    <button on:click={() => removeSliderItem(index)} class="text-red-500 text-xs hover:underline">Xóa</button>
                                </div>
                                <input type="text" bind:value={img.url} class="w-full p-2 border rounded-md text-sm" placeholder="Link ảnh (URL)...">
                                <input type="text" bind:value={img.title} class="w-full p-2 border rounded-md text-sm" placeholder="Tiêu đề ảnh (hiển thị đè lên ảnh)...">
                            </div>
                        {/each}
                    </div>
                    <button on:click={addSliderItem} class="w-full py-2 border-2 border-dashed border-gray-300 rounded-lg text-gray-500 hover:border-pink-500 hover:text-pink-500 transition">
                        + Thêm Slide Mới
                    </button>
                </div>
            {/if}

            {#if activeTab === 'changelog'}
                <div class="space-y-4 animate-fade-in">
                    <button on:click={addChangelogItem} class="w-full py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition shadow-sm">
                        + Thêm bản cập nhật mới
                    </button>
                    <div class="space-y-6 max-h-[600px] overflow-y-auto pr-2">
                        {#each localConfig.changelogs as log, index}
                            <div class="flex flex-col gap-3 p-4 border rounded-xl bg-white shadow-sm relative">
                                <button on:click={() => removeChangelogItem(index)} class="absolute top-4 right-4 text-red-500 hover:bg-red-50 p-1.5 rounded"><i data-feather="trash-2" class="w-4 h-4"></i></button>
                                
                                <div class="flex gap-4 pr-10">
                                    <div class="flex flex-col gap-1 w-1/4">
                                        <label class="text-xs font-bold text-gray-500 uppercase">Phiên bản</label>
                                        <input type="text" bind:value={log.version} class="w-full p-2 border rounded text-sm font-bold text-blue-700" placeholder="4.2">
                                    </div>
                                    <div class="flex flex-col gap-1 w-1/4">
                                        <label class="text-xs font-bold text-gray-500 uppercase">Ngày</label>
                                        <input type="text" bind:value={log.date} class="w-full p-2 border rounded text-sm" placeholder="dd/mm/yyyy">
                                    </div>
                                </div>

                                <div class="flex flex-col gap-1">
                                    <div class="flex justify-between items-end">
                                        <label class="text-xs font-bold text-gray-500 uppercase">Nội dung (Hỗ trợ HTML)</label>
                                        <button 
                                            class="text-xs text-blue-600 hover:underline flex items-center gap-1 bg-blue-50 px-2 py-1 rounded"
                                            on:click={() => insertTemplate(index)}
                                        >
                                            <i data-feather="code" class="w-3 h-3"></i> Chèn mẫu chuẩn
                                        </button>
                                    </div>
                                    <textarea 
                                        bind:value={log.content} 
                                        rows="12" 
                                        class="w-full p-3 border rounded text-sm font-mono leading-relaxed focus:ring-2 focus:ring-blue-500 outline-none" 
                                        placeholder="Nhập nội dung cập nhật..."
                                    ></textarea>
                                </div>
                            </div>
                        {/each}
                    </div>
                </div>
            {/if}

            <div class="mt-6 flex justify-end pt-4 border-t border-slate-200">
                <button 
                    on:click={saveAllConfig} 
                    disabled={isSaving} 
                    class="bg-pink-600 text-white px-5 py-2.5 rounded-lg hover:bg-pink-700 transition font-semibold shadow-sm flex items-center gap-2 disabled:opacity-50"
                >
                    {#if isSaving}
                        <svg class="animate-spin h-4 w-4 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                        Đang lưu...
                    {:else}
                        <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path><polyline points="17 21 17 13 7 13 7 21"></polyline><polyline points="7 3 7 8 15 8"></polyline></svg>
                        Lưu Cấu Hình
                    {/if}
                </button>
            </div>
        </div>
    </details>
</div>

<style>
    .animate-fade-in { animation: fadeIn 0.3s ease-out; }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
</style>
--- END FILE: ./src/components/admin/AdminHomeConfig.svelte ---

--- START FILE: ./src/components/admin/AdminMappings.svelte ---
<script>
    import { afterUpdate } from 'svelte';
    import { competitionNameMappings } from '../../stores.js';
    import { adminService } from '../../services/admin.service.js';

    let mappingSearch = '';
    let isSaving = false;
    let debounceTimer;
    
    // Subscribe store
    $: mappings = $competitionNameMappings || {};

    // Chuyển object mappings thành array để render bảng
    $: mappingList = Object.entries(mappings).map(([original, short], index) => ({
        originalName: original,
        shortName: short || original, // Mặc định hiển thị tên gốc nếu chưa có tên rút gọn
        index: index + 1
    }));

    // Lọc danh sách
    $: filteredList = mappingList.filter(item => {
        const term = mappingSearch.toLowerCase();
        return item.originalName.toLowerCase().includes(term) || 
               item.shortName.toLowerCase().includes(term);
    });

    function handleMappingInput(originalName, event) {
        const newShortName = event.target.value;
        
        // Cập nhật store local ngay lập tức để UI phản hồi nhanh
        competitionNameMappings.update(current => {
            return { ...current, [originalName]: newShortName };
        });
    }

    async function saveAllMappings() {
        isSaving = true;
        try {
            await adminService.saveCompetitionNameMappings($competitionNameMappings);
        } catch (e) {
            console.error(e);
            alert("Lỗi khi lưu mapping.");
        } finally {
            isSaving = false;
        }
    }

    afterUpdate(() => { if (typeof feather !== 'undefined') feather.replace(); });
</script>

<div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden mb-6 transition-all hover:shadow-md">
    <details class="group" open> 
        <summary class="flex justify-between items-center p-5 cursor-pointer bg-white hover:bg-slate-50 transition-colors list-none select-none">
            <div class="flex items-center gap-3">
                <div class="p-2 bg-teal-50 rounded-lg text-teal-600">
                    <i data-feather="git-merge"></i>
                </div>
                <div>
                    <h3 class="font-bold text-slate-700 text-lg">Tên Rút Gọn Thi Đua</h3>
                    <p class="text-xs text-slate-500">Đặt tên ngắn gọn cho các cột thi đua trên bảng báo cáo</p>
                </div>
            </div>
            <span class="transform transition-transform duration-200 group-open:rotate-180 text-slate-400">
                <i data-feather="chevron-down"></i>
            </span>
        </summary> 
        
        <div class="p-6 border-t border-slate-100 bg-slate-50/50"> 
            
            <div class="flex flex-col sm:flex-row justify-between items-center gap-4 mb-4">
                <div class="relative flex-grow w-full sm:w-auto">
                    <span class="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400">
                        <i data-feather="search" class="w-4 h-4"></i>
                    </span>
                    <input 
                        type="text" 
                        class="w-full pl-10 p-2.5 border border-slate-300 rounded-lg text-sm focus:ring-2 focus:ring-teal-500 outline-none bg-white" 
                        placeholder="Tìm kiếm tên thi đua..." 
                        bind:value={mappingSearch}
                    >
                </div>
                <button 
                    class="px-4 py-2 bg-teal-600 text-white rounded-lg hover:bg-teal-700 font-bold text-sm shadow-sm flex items-center gap-2 disabled:opacity-50"
                    on:click={saveAllMappings}
                    disabled={isSaving}
                >
                    {#if isSaving}
                        <span class="animate-spin">↻</span> Đang lưu...
                    {:else}
                        <i data-feather="save" class="w-4 h-4"></i> Lưu Thay Đổi
                    {/if}
                </button>
            </div>

            <div class="border border-slate-200 rounded-lg bg-white shadow-inner overflow-hidden">
                <div class="max-h-[500px] overflow-y-auto custom-scrollbar"> 
                    {#if filteredList.length === 0}
                        <div class="flex flex-col items-center justify-center p-12 text-slate-400">
                            <i data-feather="inbox" class="w-10 h-10 mb-3 opacity-50"></i>
                            <p class="text-sm font-medium">Chưa có dữ liệu thi đua.</p>
                            <p class="text-xs mt-1">Vui lòng dán dữ liệu "Thi đua nhân viên" ở tab Cập nhật dữ liệu để hệ thống tự động trích xuất tên.</p>
                        </div>
                    {:else}
                        <table class="min-w-full text-sm border-collapse">
                            <thead class="text-xs text-slate-600 uppercase bg-slate-100 font-bold sticky top-0 z-10 shadow-sm">
                                <tr>
                                    <th class="px-4 py-3 border-b text-center w-16">STT</th>
                                    <th class="px-4 py-3 border-b text-left w-1/2">Tên Gốc (Từ dữ liệu dán)</th>
                                    <th class="px-4 py-3 border-b text-left w-1/2 text-teal-700">Tên Rút Gọn (Hiển thị)</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-slate-100">
                                {#each filteredList as item}
                                    <tr class="hover:bg-slate-50 transition-colors group">
                                        <td class="px-4 py-3 text-center text-slate-400 text-xs font-mono">{item.index}</td>
                                        <td class="px-4 py-3 text-slate-700 text-xs leading-relaxed font-medium break-words select-all">
                                            {item.originalName}
                                        </td>
                                        <td class="px-4 py-2">
                                            <input 
                                                type="text" 
                                                class="w-full p-2 border border-slate-200 rounded-md text-sm font-semibold text-teal-800 focus:border-teal-500 focus:ring-1 focus:ring-teal-500 outline-none bg-slate-50 focus:bg-white transition-all placeholder-slate-300" 
                                                value={item.shortName} 
                                                on:input={(e) => handleMappingInput(item.originalName, e)}
                                                placeholder={item.originalName}
                                            >
                                        </td>
                                    </tr>
                                {/each}
                            </tbody>
                        </table>
                    {/if}
                </div> 
            </div>
            
            <p class="text-xs text-slate-500 mt-3 italic flex items-center gap-1">
                <i data-feather="info" class="w-3 h-3"></i>
                Mẹo: Tên rút gọn mặc định sẽ giống tên gốc. Bạn hãy sửa lại cho ngắn gọn để bảng hiển thị đẹp hơn.
            </p>
        </div>
    </details>
</div>

<style>
    .custom-scrollbar::-webkit-scrollbar { width: 6px; }
    .custom-scrollbar::-webkit-scrollbar-track { background: #f1f1f1; }
    .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
    .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
</style>
--- END FILE: ./src/components/admin/AdminMappings.svelte ---

--- START FILE: ./src/components/admin/AdminPerformanceTables.svelte ---
<script>
    import { onMount } from 'svelte';
    import { customPerformanceTables, modalState } from '../../stores.js';
    import { adminService } from '../../services/admin.service.js';
    
    // Load bảng hệ thống khi mount
    onMount(async () => {
        const tables = await adminService.loadSystemPerformanceTables();
        // Cập nhật store hiển thị
        customPerformanceTables.update(current => {
            // Giữ lại bảng cá nhân (nếu có), thay thế bảng hệ thống cũ bằng bảng mới tải về
            const userTables = current.filter(t => !t.isSystem);
            // Gán cờ isSystem cho chắc chắn
            const sysTables = tables.map(t => ({ ...t, isSystem: true }));
            return [...sysTables, ...userTables];
        });
    });

    // Chỉ hiển thị bảng hệ thống trong trang Admin
    $: systemTables = $customPerformanceTables.filter(t => t.isSystem);

    function openAddModal() {
        // Mở modal với cờ isSystem = true (Admin tạo)
        modalState.update(s => ({ 
            ...s, 
            activeModal: 'add-performance-table-modal', 
            payload: null,
            isSystem: true 
        }));
    }

    function editTable(table) {
        modalState.update(s => ({ 
            ...s, 
            activeModal: 'add-performance-table-modal', 
            payload: table,
            isSystem: true 
        }));
    }

    async function deleteTable(id) {
        if(!confirm("Bạn có chắc muốn xóa bảng hiệu quả hệ thống này? Hành động này sẽ ảnh hưởng đến toàn bộ người dùng.")) return;
        
        const newTables = $customPerformanceTables.filter(t => t.id !== id);
        // Cập nhật Store local
        customPerformanceTables.set(newTables);
        
        // Lọc lấy danh sách system mới để lưu Cloud
        const systemTablesToSave = newTables.filter(t => t.isSystem);
        await adminService.saveSystemPerformanceTables(systemTablesToSave);
    }
</script>

<div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden mb-6 transition-all hover:shadow-md">
    <div class="p-5 bg-white border-b border-slate-100 flex justify-between items-center">
        <div class="flex items-center gap-4">
            <div class="p-2.5 bg-teal-50 rounded-lg text-teal-600 shadow-sm">
               <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" /></svg>
            </div>
            <div>
                <div class="flex items-center gap-3">
                    <h3 class="font-bold text-slate-800 text-lg">Cấu hình Bảng Hiệu quả (Hệ thống)</h3>
                    <span class="bg-teal-100 text-teal-700 text-[10px] font-extrabold px-2 py-0.5 rounded-full uppercase tracking-wide border border-teal-200">Global</span>
                </div>
                <p class="text-sm text-slate-500 mt-0.5">Tạo bảng mẫu (Tỷ lệ %, Doanh thu, SL) hiển thị ở tab "Hiệu quả NV"</p>
            </div>
        </div>
        <button on:click={openAddModal} class="px-4 py-2 bg-teal-600 text-white rounded-lg hover:bg-teal-700 font-bold shadow-sm flex items-center gap-2 text-sm transition-all">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" /></svg>
            Tạo bảng mới
        </button>
    </div>
    
    <div class="p-6 bg-slate-50/50">
        {#if systemTables.length === 0}
            <div class="text-center py-8 border-2 border-dashed border-slate-300 rounded-xl">
                <p class="text-slate-500 italic">Chưa có bảng hiệu quả hệ thống nào.</p>
            </div>
        {:else}
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                {#each systemTables as table}
                    <div class="bg-white p-4 rounded-lg border border-slate-200 shadow-sm flex flex-col hover:border-teal-300 transition-colors group">
                        <div class="flex justify-between items-start mb-2">
                            <h4 class="font-bold text-slate-800 text-lg">{table.title}</h4>
                            <div class="flex gap-1 opacity-0 group-hover:opacity-100 transition-opacity">
                                <button class="p-1.5 text-slate-400 hover:text-blue-600 hover:bg-blue-50 rounded" title="Sửa" on:click={() => editTable(table)}>
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" /></svg>
                                </button>
                                <button class="p-1.5 text-slate-400 hover:text-red-600 hover:bg-red-50 rounded" title="Xóa" on:click={() => deleteTable(table.id)}>
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
                                </button>
                            </div>
                        </div>
                        
                        <div class="mt-auto">
                            <p class="text-xs text-slate-500 font-semibold uppercase mb-2">Cấu trúc:</p>
                            <div class="flex flex-wrap gap-2">
                                {#each table.columns as col}
                                    <span class="px-2 py-1 bg-slate-100 text-slate-600 rounded text-xs border border-slate-200 flex items-center gap-1">
                                        {col.header} 
                                        {#if col.type === 'PERCENT'}
                                            <span class="text-[9px] bg-red-100 text-red-600 px-1 rounded font-bold">%</span>
                                        {:else if col.type === 'SL'}
                                            <span class="text-[9px] bg-gray-200 text-gray-600 px-1 rounded font-bold">SL</span>
                                        {:else}
                                            <span class="text-[9px] bg-blue-100 text-blue-600 px-1 rounded font-bold">DT</span>
                                        {/if}
                                    </span>
                                {/each}
                            </div>
                        </div>
                    </div>
                {/each}
            </div>
        {/if}
    </div>
</div>
--- END FILE: ./src/components/admin/AdminPerformanceTables.svelte ---

--- START FILE: ./src/components/admin/AdminRevenueTables.svelte ---
<script>
    import { onMount } from 'svelte';
    import { customRevenueTables, modalState } from '../../stores.js';
    import { adminService } from '../../services/admin.service.js';
    
    // Load bảng hệ thống khi mount
    onMount(async () => {
        const tables = await adminService.loadSystemRevenueTables();
        // Merge với local để hiển thị đủ (nhưng ở màn hình Admin này ta ưu tiên hiển thị System Table để quản lý)
        // Tuy nhiên, để nhất quán store, ta update store chính
        customRevenueTables.update(current => {
            // Lọc bỏ system cũ, thêm system mới từ cloud
            const userTables = current.filter(t => !t.isSystem);
            return [...tables, ...userTables];
        });
    });

    $: systemTables = $customRevenueTables.filter(t => t.isSystem);

    function openAddModal() {
        // Mặc định tạo bảng System khi ở trong trang Admin
        modalState.update(s => ({ ...s, activeModal: 'add-revenue-table-modal', payload: { isSystem: true } }));
    }

    function editTable(table) {
        modalState.update(s => ({ ...s, activeModal: 'add-revenue-table-modal', payload: table }));
    }

    async function deleteTable(id) {
        if(!confirm("Bạn có chắc muốn xóa bảng hệ thống này? Hành động này sẽ ảnh hưởng đến toàn bộ người dùng.")) return;
        
        const newTables = $customRevenueTables.filter(t => t.id !== id);
        customRevenueTables.set(newTables);
        
        // Lưu lại danh sách mới lên Cloud
        await adminService.saveSystemRevenueTables(newTables);
    }
</script>

<div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden mb-6 transition-all hover:shadow-md">
    <div class="p-5 bg-white border-b border-slate-100 flex justify-between items-center">
        <div class="flex items-center gap-4">
            <div class="p-2.5 bg-indigo-50 rounded-lg text-indigo-600 shadow-sm">
               <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" /></svg>
            </div>
            <div>
                <div class="flex items-center gap-3">
                    <h3 class="font-bold text-slate-800 text-lg">Cấu hình Bảng Doanh thu (Hệ thống)</h3>
                    <span class="bg-indigo-100 text-indigo-700 text-[10px] font-extrabold px-2 py-0.5 rounded-full uppercase tracking-wide border border-indigo-200">Global</span>
                </div>
                <p class="text-sm text-slate-500 mt-0.5">Tạo các bảng mẫu hiển thị ở tab "SKNV - DT Ngành hàng" và "Realtime"</p>
            </div>
        </div>
        <button on:click={openAddModal} class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 font-bold shadow-sm flex items-center gap-2 text-sm transition-all">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" /></svg>
            Tạo bảng mới
        </button>
    </div>
    
    <div class="p-6 bg-slate-50/50">
        {#if systemTables.length === 0}
            <div class="text-center py-8 border-2 border-dashed border-slate-300 rounded-xl">
                <p class="text-slate-500 italic">Chưa có bảng hệ thống nào.</p>
            </div>
        {:else}
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                {#each systemTables as table}
                    <div class="bg-white p-4 rounded-lg border border-slate-200 shadow-sm flex flex-col hover:border-indigo-300 transition-colors group">
                        <div class="flex justify-between items-start mb-2">
                            <h4 class="font-bold text-slate-800 text-lg">{table.title}</h4>
                            <div class="flex gap-1 opacity-0 group-hover:opacity-100 transition-opacity">
                                <button class="p-1.5 text-slate-400 hover:text-blue-600 hover:bg-blue-50 rounded" title="Sửa" on:click={() => editTable(table)}>
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" /></svg>
                                </button>
                                <button class="p-1.5 text-slate-400 hover:text-red-600 hover:bg-red-50 rounded" title="Xóa" on:click={() => deleteTable(table.id)}>
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
                                </button>
                            </div>
                        </div>
                        
                        <div class="mt-auto">
                            <p class="text-xs text-slate-500 font-semibold uppercase mb-2">Cấu trúc:</p>
                            <div class="flex flex-wrap gap-2">
                                {#each table.subColumns as col}
                                    <span class="px-2 py-1 bg-slate-100 text-slate-600 rounded text-xs border border-slate-200">
                                        {col.header} 
                                        <span class="text-slate-400 text-[10px] ml-1">
                                            ({[col.metrics.sl?'SL':'', col.metrics.dt?'DT':'', col.metrics.dtqd?'QĐ':''].filter(Boolean).join('/')})
                                        </span>
                                    </span>
                                {/each}
                            </div>
                        </div>
                    </div>
                {/each}
            </div>
        {/if}
    </div>
</div>
--- END FILE: ./src/components/admin/AdminRevenueTables.svelte ---

--- START FILE: ./src/components/admin/AdminSpecialProducts.svelte ---
<script>
    import { specialProductList } from '../../stores.js';
    import { adminService } from '../../services/admin.service.js';
    import * as dataService from '../../services/dataService.js';
    import { onMount } from 'svelte';

    let isLoading = false;
    let showList = false;

    // Subscribe to store
    $: products = $specialProductList || [];

    async function handleFileUpload(event) {
        isLoading = true;
        try {
            await dataService.handleSpecialProductFileUpload(event);
            // Auto-save to localStorage for testing persistence
            localStorage.setItem('temp_specialProductList', JSON.stringify($specialProductList));
        } catch (error) {
            alert(error.message);
        } finally {
            isLoading = false;
        }
    }

    async function saveToCloud() {
        if (products.length === 0) return alert("Chưa có dữ liệu để lưu!");
        isLoading = true;
        try {
            await adminService.saveSpecialProductList(products);
            // Backup to localStorage
            localStorage.setItem('temp_specialProductList', JSON.stringify(products));
        } catch (error) {
            console.error(error);
            alert("Lỗi lưu: " + error.message);
        } finally {
            isLoading = false;
        }
    }

    // Load backup on mount if store is empty (Test mode)
    onMount(() => {
        if (products.length === 0) {
            const backup = localStorage.getItem('temp_specialProductList');
            if (backup) specialProductList.set(JSON.parse(backup));
        }
    });
</script>

<div class="bg-white p-6 rounded-xl shadow-sm border border-slate-200 mt-6 transition-all hover:shadow-md">
    <div class="flex justify-between items-center mb-6">
        <h2 class="text-xl font-bold text-slate-800 flex items-center gap-2">
            <div class="p-2 bg-purple-50 rounded-lg text-purple-600">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l2.286 6.857L21 12l-5.714 2.143L13 21l-2.286-6.857L5 12l5.714-2.143L13 3z" />
                </svg>
            </div>
            Sản Phẩm Đặc Quyền
        </h2>
        
        <div class="flex gap-2">
            <button 
                class="px-4 py-2 text-sm font-medium text-slate-600 bg-slate-100 rounded-lg hover:bg-slate-200 transition-colors"
                on:click={() => dataService.handleTemplateDownload()}
            >
                Tải File Mẫu
            </button>
            <button 
                class="px-4 py-2 text-sm font-medium text-white bg-purple-600 rounded-lg hover:bg-purple-700 transition-colors flex items-center gap-2 disabled:opacity-50"
                on:click={saveToCloud}
                disabled={isLoading}
            >
                {#if isLoading}
                    <svg class="animate-spin h-4 w-4 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                {:else}
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path d="M7.707 10.293a1 1 0 10-1.414 1.414l3 3a1 1 0 001.414 0l3-3a1 1 0 00-1.414-1.414L11 11.586V6h5a2 2 0 012 2v7a2 2 0 01-2 2H4a2 2 0 01-2-2V8a2 2 0 012-2h5v5.586l-1.293-1.293zM9 4a1 1 0 012 0v2H9V4z" /></svg>
                {/if}
                Lưu Lên Cloud
            </button>
        </div>
    </div>

    <div class="mb-8 p-6 bg-purple-50/50 rounded-xl border-2 border-dashed border-purple-200 hover:border-purple-400 transition-colors text-center group">
        <input 
            type="file" 
            id="special-product-upload" 
            class="hidden" 
            accept=".xlsx, .xls"
            on:change={handleFileUpload}
        />
        <label for="special-product-upload" class="cursor-pointer flex flex-col items-center gap-3">
            <div class="p-3 bg-white rounded-full shadow-sm group-hover:scale-110 transition-transform">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-purple-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" />
                </svg>
            </div>
            <div>
                <span class="text-purple-600 font-bold hover:underline">Nhấn để tải file Excel</span>
                <span class="text-slate-500 block text-sm mt-1">Yêu cầu cột: Mã SP, Tên SP, Nhóm hàng</span>
            </div>
        </label>
    </div>

    {#if products.length > 0}
        <div class="border border-slate-200 rounded-xl overflow-hidden">
            <div class="bg-slate-50 px-4 py-3 border-b flex justify-between items-center">
                <div class="flex items-center gap-2">
                    <span class="bg-green-100 text-green-700 px-2.5 py-0.5 rounded-full text-xs font-bold flex items-center gap-1">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" /></svg>
                        Đã tải {products.length} sản phẩm
                    </span>
                </div>
                <button 
                    class="text-xs font-medium text-purple-600 hover:text-purple-800 hover:underline"
                    on:click={() => showList = !showList}
                >
                    {showList ? 'Thu gọn danh sách' : 'Xem chi tiết danh sách'}
                </button>
            </div>

            {#if showList}
                <div class="overflow-x-auto max-h-96">
                    <table class="w-full text-sm text-left">
                        <thead class="text-xs text-slate-500 uppercase bg-slate-50 sticky top-0">
                            <tr>
                                <th class="px-4 py-2 w-32">Mã SP</th>
                                <th class="px-4 py-2">Tên Sản Phẩm</th>
                                <th class="px-4 py-2 w-48">Nhóm Hàng</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-slate-100">
                            {#each products as item}
                                <tr class="bg-white hover:bg-purple-50 transition-colors">
                                    <td class="px-4 py-2 font-mono text-xs text-slate-500">{item.maSanPham}</td>
                                    <td class="px-4 py-2 font-medium text-slate-700">{item.tenSanPham}</td>
                                    <td class="px-4 py-2 text-slate-500 text-xs">{item.nhomHang}</td>
                                </tr>
                            {/each}
                        </tbody>
                    </table>
                </div>
            {/if}
        </div>
    {/if}
</div>
--- END FILE: ./src/components/admin/AdminSpecialProducts.svelte ---

--- START FILE: ./src/components/admin/AdminSpecialProgram.svelte ---
<script>
    import { onMount } from 'svelte';
    import { adminService } from '../../services/admin.service.js';
    
    let programs = [];
    
    onMount(async () => {
        programs = await adminService.loadGlobalSpecialPrograms();
    });
</script>

<div class="bg-white p-6 rounded-lg border border-slate-200 text-center">
    <p class="text-slate-500 mb-4">Danh sách chương trình độc quyền (Global).</p>
    <div class="p-4 bg-slate-50 rounded border border-slate-200 inline-block text-left w-full">
        <pre class="text-xs overflow-auto max-h-60">{JSON.stringify(programs, null, 2)}</pre>
    </div>
    <div class="mt-4">
        <button class="px-4 py-2 bg-gray-200 text-gray-700 rounded text-sm font-bold cursor-not-allowed">Chỉnh sửa (Sắp ra mắt)</button>
    </div>
</div>
--- END FILE: ./src/components/admin/AdminSpecialProgram.svelte ---

--- START FILE: ./src/components/admin/AdminUserStats.svelte ---
<script>
    import { onMount, afterUpdate } from 'svelte';
    import { userStats } from '../../stores.js';
    import { analyticsService } from '../../services/analytics.service.js';

    let userList = [];
    let sortKey = 'lastLogin';
    let sortDirection = 'desc';
    let isLoading = false;

    onMount(async () => {
        isLoading = true;
        try {
            userList = await analyticsService.getAllUsers();
            userStats.set(userList);
        } catch (error) { console.error(error); } 
        finally { isLoading = false; }
    });

    function sortUsers(key) {
        if (sortKey === key) { sortDirection = sortDirection === 'desc' ? 'asc' : 'desc'; } 
        else { sortKey = key; sortDirection = 'desc'; }
    }

    $: sortedUsers = [...userList].sort((a, b) => {
        let valA = a[sortKey];
        let valB = b[sortKey];
        if (sortKey === 'lastLogin') {
            valA = valA ? new Date(valA).getTime() : 0;
            valB = valB ? new Date(valB).getTime() : 0;
        } else if (sortKey === 'loginCount' || sortKey === 'actionsTaken') {
            valA = Number(valA) || 0;
            valB = Number(valB) || 0;
        } else {
            valA = String(valA || '').toLowerCase();
            valB = String(valB || '').toLowerCase();
        }
        if (valA < valB) return sortDirection === 'asc' ? -1 : 1;
        if (valA > valB) return sortDirection === 'asc' ? 1 : -1;
        return 0;
    });

    function formatDate(dateVal) {
        if (!dateVal) return '-';
        const date = dateVal.toDate ? dateVal.toDate() : new Date(dateVal);
        return `${date.getHours()}:${String(date.getMinutes()).padStart(2, '0')} ${date.getDate()}/${date.getMonth()+1}`;
    }

    afterUpdate(() => { if (typeof feather !== 'undefined') feather.replace(); });
</script>

<div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden mb-6 transition-all hover:shadow-md">
    <div class="p-5 bg-white border-b border-slate-100 flex justify-between items-center">
        <div class="flex items-center gap-3">
            <div class="p-2 bg-orange-50 rounded-lg text-orange-600">
                <i data-feather="users"></i>
            </div>
            <div>
                <h3 class="font-bold text-slate-700 text-lg">Thống kê Người dùng</h3>
                <p class="text-xs text-slate-500">Theo dõi truy cập và tần suất sử dụng hệ thống</p>
            </div>
        </div>
    </div>
    
    <div class="p-0"> 
        <div class="overflow-x-auto max-h-[500px]"> 
            {#if isLoading}
                <div class="p-10 flex flex-col justify-center items-center text-slate-400 gap-3">
                    <svg class="animate-spin h-8 w-8 text-orange-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                    <span class="text-sm">Đang tải dữ liệu...</span>
                </div>
            {:else if userList.length === 0}
                <div class="p-10 text-center text-slate-400 italic bg-slate-50/50">
                    <i data-feather="user-x" class="w-8 h-8 mx-auto mb-2 opacity-50"></i>
                    Chưa có dữ liệu người dùng.
                </div>
            {:else}
                <table class="min-w-full text-sm border-collapse">
                    <thead class="text-xs text-slate-500 uppercase bg-slate-50 sticky top-0 z-10">
                        <tr>
                            <th class="px-6 py-3 text-left font-semibold cursor-pointer hover:bg-slate-100" on:click={() => sortUsers('email')}>Email</th>
                            <th class="px-6 py-3 text-right font-semibold cursor-pointer hover:bg-slate-100" on:click={() => sortUsers('loginCount')}>Truy cập</th>
                            <th class="px-6 py-3 text-right font-semibold cursor-pointer hover:bg-slate-100" on:click={() => sortUsers('actionsTaken')}>Thao tác</th>
                            <th class="px-6 py-3 text-right font-semibold cursor-pointer hover:bg-slate-100" on:click={() => sortUsers('lastLogin')}>Lần cuối</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-slate-100">
                        {#each sortedUsers as user}
                            <tr class="hover:bg-orange-50/30 transition-colors group/row">
                                <td class="px-6 py-3 font-medium text-slate-700 group-hover/row:text-orange-700">{user.email}</td>
                                <td class="px-6 py-3 text-right font-mono text-slate-600 bg-slate-50/50">{user.loginCount || 0}</td>
                                <td class="px-6 py-3 text-right font-mono text-slate-600">{user.actionsTaken || 0}</td>
                                <td class="px-6 py-3 text-right text-xs text-slate-400">{formatDate(user.lastLogin)}</td>
                            </tr>
                        {/each}
                    </tbody>
                </table>
            {/if}
        </div> 
    </div>
</div>
--- END FILE: ./src/components/admin/AdminUserStats.svelte ---

--- START FILE: ./src/components/admin/category/CategoryUploader.svelte ---
<script>
    import { categoryStructure, brandList } from '../../../stores.js';
    import { dataService } from '../../../services/dataService.js';

    let isLoading = false;
    let showRawData = false;

    // Tính toán số liệu thống kê từ Store
    // Khi F5, adminService load dữ liệu từ Cloud vào Store -> biến này tự cập nhật -> UI hiển thị lại
    $: uniqueCategories = $categoryStructure ? [...new Set($categoryStructure.map(i => i.nganhHang).filter(Boolean))] : [];
    $: uniqueGroups = $categoryStructure ? [...new Set($categoryStructure.map(i => i.nhomHang).filter(Boolean))] : [];
    $: totalBrands = $brandList ? $brandList.length : 0;
    
    // Check xem có dữ liệu không để hiển thị bảng
    $: hasData = $categoryStructure.length > 0;

    async function handleCategoryUpload(event) {
        isLoading = true;
        try {
            await dataService.handleCategoryFile(event);
        } catch (error) {
            alert(error.message);
        } finally {
            isLoading = false;
        }
    }
</script>

<div class="space-y-6">
    <div class="flex justify-between items-center">
        <div class="text-sm text-gray-500 italic">
            Bước 1: Tải lên file Excel cấu trúc (Bắt buộc 3 cột: Ngành hàng, Nhóm hàng, Nhà sản xuất).
        </div>
        <button 
            class="px-3 py-1.5 text-xs font-medium text-slate-600 bg-slate-100 rounded hover:bg-slate-200 transition-colors"
            on:click={() => dataService.handleTemplateDownload()}
        >
            Tải File Mẫu
        </button>
    </div>

    <div class="p-6 bg-slate-50 rounded-xl border-2 border-dashed border-slate-300 hover:border-blue-400 transition-colors text-center">
        <input 
            type="file" 
            id="category-upload-input" 
            class="hidden" 
            accept=".xlsx, .xls"
            on:change={handleCategoryUpload}
            disabled={isLoading}
        />
        <label for="category-upload-input" class="cursor-pointer flex flex-col items-center gap-3">
            <div class="p-3 bg-white rounded-full shadow-sm">
                {#if isLoading}
                    <svg class="animate-spin h-8 w-8 text-blue-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                {:else}
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-blue-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" />
                    </svg>
                {/if}
            </div>
            <div>
                <span class="text-blue-600 font-medium hover:underline">Tải lên file Excel</span>
                <span class="text-slate-500"> cấu trúc ngành hàng</span>
            </div>
        </label>
    </div>

    {#if hasData}
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <div class="p-3 bg-blue-50 rounded-lg border border-blue-100 flex justify-between items-center">
                <span class="text-sm text-blue-700 font-medium">Tổng Ngành Hàng</span>
                <span class="text-xl font-bold text-blue-700">{uniqueCategories.length}</span>
            </div>
            <div class="p-3 bg-green-50 rounded-lg border border-green-100 flex justify-between items-center">
                <span class="text-sm text-green-700 font-medium">Tổng Nhóm Hàng</span>
                <span class="text-xl font-bold text-green-700">{uniqueGroups.length}</span>
            </div>
            <div class="p-3 bg-purple-50 rounded-lg border border-purple-100 flex justify-between items-center">
                <span class="text-sm text-purple-700 font-medium">Tổng Hãng</span>
                <span class="text-xl font-bold text-purple-700">{totalBrands}</span>
            </div>
        </div>

        <div class="border rounded-lg overflow-hidden">
            <div class="bg-slate-100 px-4 py-2 border-b flex justify-between items-center">
                <h3 class="font-bold text-slate-700 text-xs uppercase">Dữ liệu thô (Preview)</h3>
                <button 
                    class="text-xs text-blue-600 hover:underline"
                    on:click={() => showRawData = !showRawData}
                >
                    {showRawData ? 'Ẩn chi tiết' : 'Xem chi tiết'}
                </button>
            </div>
            
            {#if showRawData}
            <div class="overflow-x-auto max-h-60">
                <table class="w-full text-sm text-left">
                    <thead class="text-xs text-slate-500 uppercase bg-slate-50 sticky top-0">
                        <tr>
                            <th class="px-4 py-2">Ngành Hàng</th>
                            <th class="px-4 py-2">Nhóm Hàng</th>
                            <th class="px-4 py-2">Nhà Sản Xuất</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-slate-200">
                        {#each $categoryStructure.slice(0, 100) as item}
                            <tr class="bg-white hover:bg-slate-50">
                                <td class="px-4 py-1 text-slate-600">{item.nganhHang}</td>
                                <td class="px-4 py-1 font-medium text-slate-700">{item.nhomHang}</td>
                                <td class="px-4 py-1 text-slate-500 italic">{item.nhaSanXuat}</td>
                            </tr>
                        {/each}
                    </tbody>
                </table>
            </div>
            {/if}
        </div>
    {/if}
</div>
--- END FILE: ./src/components/admin/category/CategoryUploader.svelte ---

--- START FILE: ./src/components/admin/category/MacroGroupEditor.svelte ---
<script>
    import { onMount } from 'svelte';
    import { categoryStructure, macroCategoryConfig } from '../../../stores.js';
    import { adminService } from '../../../services/admin.service.js';
    import { parseIdentity } from '../../../utils.js';

    let localConfigs = []; 
    let isSaving = false;
    let editingId = null; 
    let itemSearch = '';

    // Lấy danh sách Ngành Hàng (Category) kèm ID
    $: rawCategoriesWithId = (() => {
        const map = new Map();
        ($categoryStructure || []).forEach(c => {
            if(!c.nganhHang) return;
            const parsed = parseIdentity(c.nganhHang);
            if (parsed.id && parsed.id !== 'unknown') {
                map.set(parsed.id, { 
                    id: parsed.id, 
                    display: `${parsed.id} - ${parsed.name}` 
                });
            }
        });
        return Array.from(map.values()).sort((a,b) => a.display.localeCompare(b.display));
    })();
    
    $: if ($macroCategoryConfig) {
        localConfigs = JSON.parse(JSON.stringify($macroCategoryConfig));
    }

    function addGroup() {
        const name = prompt("Nhập tên Nhóm Ngành Hàng lớn (VD: ICT, CE...):");
        if (name && name.trim()) {
            const id = 'macro_' + Date.now();
            localConfigs = [...localConfigs, { id, name: name.trim(), items: [] }];
            editingId = id; 
        }
    }

    function removeGroup(id) {
        if (!confirm("Bạn có chắc muốn xóa nhóm này?")) return;
        localConfigs = localConfigs.filter(g => g.id !== id);
    }

    function toggleItem(groupId, itemId) {
        const groupIndex = localConfigs.findIndex(g => g.id === groupId);
        if (groupIndex === -1) return;

        const currentItems = new Set(localConfigs[groupIndex].items || []);
        if (currentItems.has(itemId)) {
            currentItems.delete(itemId);
        } else {
            currentItems.add(itemId);
        }
        localConfigs[groupIndex].items = [...currentItems];
    }

    // [MỚI] Hàm xóa sạch lựa chọn (fix lỗi dữ liệu ma)
    function clearSelection(groupId) {
        const groupIndex = localConfigs.findIndex(g => g.id === groupId);
        if (groupIndex === -1) return;
        
        if (confirm(`Bạn muốn xóa sạch danh sách chọn của nhóm "${localConfigs[groupIndex].name}" để chọn lại từ đầu?`)) {
            localConfigs[groupIndex].items = [];
        }
    }

    async function handleSave() {
        isSaving = true;
        try {
            await adminService.saveMacroCategoryConfig(localConfigs);
            macroCategoryConfig.set(localConfigs);
        } catch (e) {
            alert(e.message);
        } finally {
            isSaving = false;
        }
    }

    // Filter items cho việc chọn
    $: filteredRawCategories = rawCategoriesWithId.filter(g => g.display.toLowerCase().includes(itemSearch.toLowerCase()));
</script>

<div class="space-y-4">
    <div class="flex justify-between items-center mb-4">
        <p class="text-sm text-gray-500">
            Định nghĩa các nhóm lớn (VD: Gom "Điện thoại", "Laptop" vào nhóm "ICT").
            <br><span class="text-xs text-orange-600 font-semibold">* Lưu ý: Tick chọn theo Mã Định Danh (ID).</span>
        </p>
        <div class="flex gap-2">
            <button 
                class="px-3 py-1.5 text-xs font-bold text-green-700 bg-green-50 border border-green-200 rounded hover:bg-green-100 transition"
                on:click={addGroup}
            >
                + Thêm Nhóm Lớn
            </button>
            <button 
                class="px-4 py-1.5 text-xs font-bold text-white bg-indigo-600 rounded hover:bg-indigo-700 transition shadow-sm disabled:opacity-50"
                on:click={handleSave}
                disabled={isSaving}
            >
                {#if isSaving}Lưu...{:else}Lưu Cấu Hình{/if}
            </button>
        </div>
    </div>

    {#if localConfigs.length === 0}
        <div class="p-8 text-center border-2 border-dashed border-gray-200 rounded-lg bg-gray-50">
            <p class="text-gray-400">Chưa có nhóm nào. Hãy bấm "Thêm Nhóm Lớn".</p>
        </div>
    {:else}
        <div class="grid gap-4">
            {#each localConfigs as group (group.id)}
                <div class="border border-gray-200 rounded-lg bg-white overflow-hidden shadow-sm">
                    <div 
                        class="p-3 bg-gray-50 flex justify-between items-center cursor-pointer hover:bg-gray-100 transition"
                        on:click={() => editingId = (editingId === group.id ? null : group.id)}
                    >
                        <div class="flex items-center gap-2">
                            <span class="transform transition-transform {editingId === group.id ? 'rotate-90' : ''}">▶</span>
                            <h4 class="font-bold text-slate-700">{group.name}</h4>
                            <span class="bg-blue-100 text-blue-800 text-xs font-medium px-2 py-0.5 rounded-full">
                                {group.items?.length || 0} mục
                            </span>
                        </div>
                        <button 
                            class="text-red-500 hover:text-red-700 p-1"
                            on:click|stopPropagation={() => removeGroup(group.id)}
                            title="Xóa nhóm"
                        >
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
                        </button>
                    </div>

                    {#if editingId === group.id}
                        <div class="p-4 border-t border-gray-200 bg-white animate-fade-in">
                            <div class="mb-2 flex gap-2">
                                <input 
                                    type="text" 
                                    class="flex-1 p-2 border rounded text-xs bg-slate-50 focus:bg-white transition outline-none focus:ring-1 focus:ring-blue-500" 
                                    placeholder="🔍 Tìm kiếm ngành hàng..." 
                                    bind:value={itemSearch}
                                />
                                <button 
                                    class="px-3 py-1 bg-red-50 text-red-600 border border-red-200 rounded text-xs font-bold hover:bg-red-100 whitespace-nowrap flex items-center gap-1"
                                    on:click={() => clearSelection(group.id)}
                                    title="Xóa sạch mục đã chọn để chọn lại"
                                >
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
                                    Làm sạch ({group.items?.length || 0})
                                </button>
                            </div>
                            
                            <div class="max-h-60 overflow-y-auto grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-2 custom-scrollbar">
                                {#each filteredRawCategories as item}
                                    {@const isChecked = group.items.includes(item.id)}
                                    <label class="flex items-center gap-2 p-1.5 rounded border {isChecked ? 'bg-blue-50 border-blue-200' : 'border-transparent hover:bg-gray-50'} cursor-pointer transition">
                                        <input 
                                            type="checkbox" 
                                            checked={isChecked} 
                                            on:change={() => toggleItem(group.id, item.id)}
                                            class="rounded text-blue-600 focus:ring-blue-500"
                                        />
                                        <span class="text-xs text-gray-700 truncate" title={item.display}>
                                            {item.display}
                                        </span>
                                    </label>
                                {/each}
                            </div>
                        </div>
                    {/if}
                </div>
            {/each}
        </div>
    {/if}
</div>

<style>
    .animate-fade-in { animation: fadeIn 0.2s ease-out; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(-5px); } to { opacity: 1; transform: translateY(0); } }
</style>
--- END FILE: ./src/components/admin/category/MacroGroupEditor.svelte ---

--- START FILE: ./src/components/admin/category/MacroProductGroupEditor.svelte ---
<script>
    import { onMount } from 'svelte';
    import { categoryStructure, macroProductGroupConfig } from '../../../stores.js';
    import { adminService } from '../../../services/admin.service.js';
    import { parseIdentity } from '../../../utils.js';

    let localConfigs = []; 
    let isSaving = false;
    let editingId = null; 
    let itemSearch = '';

    // Lấy danh sách Nhóm Hàng (Product Group) kèm ID để tick chọn
    $: rawProductGroupsWithId = (() => {
        const map = new Map();
        ($categoryStructure || []).forEach(c => {
            if(!c.nhomHang) return;
            const parsed = parseIdentity(c.nhomHang);
            if (parsed.id && parsed.id !== 'unknown') {
                map.set(parsed.id, { 
                    id: parsed.id, 
                    display: `${parsed.id} - ${parsed.name}` 
                });
            }
        });
        return Array.from(map.values()).sort((a,b) => a.display.localeCompare(b.display));
    })();
    
    $: if ($macroProductGroupConfig) {
        localConfigs = JSON.parse(JSON.stringify($macroProductGroupConfig));
    }

    function addGroup() {
        const name = prompt("Nhập tên Nhóm Hàng Lớn (VD: Điện thoại & Laptop, Gia dụng lớn...):");
        if (name && name.trim()) {
            const id = 'macro_pg_' + Date.now();
            localConfigs = [...localConfigs, { id, name: name.trim(), items: [] }];
            editingId = id; 
        }
    }

    function removeGroup(id) {
        if (!confirm("Bạn có chắc muốn xóa nhóm này?")) return;
        localConfigs = localConfigs.filter(g => g.id !== id);
    }

    function toggleItem(groupId, itemId) {
        const groupIndex = localConfigs.findIndex(g => g.id === groupId);
        if (groupIndex === -1) return;

        const currentItems = new Set(localConfigs[groupIndex].items || []);
        if (currentItems.has(itemId)) {
            currentItems.delete(itemId);
        } else {
            currentItems.add(itemId);
        }
        localConfigs[groupIndex].items = [...currentItems];
    }

    // [MỚI] Hàm xóa sạch lựa chọn
    function clearSelection(groupId) {
        const groupIndex = localConfigs.findIndex(g => g.id === groupId);
        if (groupIndex === -1) return;
        
        if (confirm(`Bạn muốn xóa sạch danh sách chọn của nhóm "${localConfigs[groupIndex].name}" để chọn lại từ đầu?`)) {
            localConfigs[groupIndex].items = [];
        }
    }

    async function handleSave() {
        isSaving = true;
        try {
            await adminService.saveMacroProductGroupConfig(localConfigs);
            macroProductGroupConfig.set(localConfigs);
        } catch (e) {
            alert(e.message);
        } finally {
            isSaving = false;
        }
    }

    // Filter items cho việc chọn
    $: filteredRawGroups = rawProductGroupsWithId.filter(g => g.display.toLowerCase().includes(itemSearch.toLowerCase()));
</script>

<div class="space-y-4">
    <div class="flex justify-between items-center mb-4">
        <p class="text-sm text-gray-500">
            Định nghĩa các nhóm hàng lớn (VD: Gom "Nồi cơm", "Bếp ga" vào nhóm "Gia dụng nhà bếp").
            <br><span class="text-xs text-orange-600 font-semibold">* Lưu ý: Tick chọn theo Mã Định Danh (ID).</span>
        </p>
        <div class="flex gap-2">
            <button 
                class="px-3 py-1.5 text-xs font-bold text-teal-700 bg-teal-50 border border-teal-200 rounded hover:bg-teal-100 transition"
                on:click={addGroup}
            >
                + Thêm Nhóm Hàng Lớn
            </button>
            <button 
                class="px-4 py-1.5 text-xs font-bold text-white bg-indigo-600 rounded hover:bg-indigo-700 transition shadow-sm disabled:opacity-50"
                on:click={handleSave}
                disabled={isSaving}
            >
                {#if isSaving}Lưu...{:else}Lưu Cấu Hình{/if}
            </button>
        </div>
    </div>

    {#if localConfigs.length === 0}
        <div class="p-8 text-center border-2 border-dashed border-gray-200 rounded-lg bg-gray-50">
            <p class="text-gray-400">Chưa có nhóm nào. Hãy bấm "Thêm Nhóm Hàng Lớn".</p>
        </div>
    {:else}
        <div class="grid gap-4">
            {#each localConfigs as group (group.id)}
                <div class="border border-gray-200 rounded-lg bg-white overflow-hidden shadow-sm">
                    <div 
                        class="p-3 bg-gray-50 flex justify-between items-center cursor-pointer hover:bg-gray-100 transition"
                        on:click={() => editingId = (editingId === group.id ? null : group.id)}
                    >
                        <div class="flex items-center gap-2">
                            <span class="transform transition-transform {editingId === group.id ? 'rotate-90' : ''}">▶</span>
                            <h4 class="font-bold text-slate-700">{group.name}</h4>
                            <span class="bg-teal-100 text-teal-800 text-xs font-medium px-2 py-0.5 rounded-full">
                                {group.items?.length || 0} mục
                            </span>
                        </div>
                        <button 
                            class="text-red-500 hover:text-red-700 p-1"
                            on:click|stopPropagation={() => removeGroup(group.id)}
                            title="Xóa nhóm"
                        >
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
                        </button>
                    </div>

                    {#if editingId === group.id}
                        <div class="p-4 border-t border-gray-200 bg-white animate-fade-in">
                            <div class="mb-2 flex gap-2">
                                <input 
                                    type="text" 
                                    class="flex-1 p-2 border rounded text-xs bg-slate-50 focus:bg-white transition outline-none focus:ring-1 focus:ring-teal-500" 
                                    placeholder="🔍 Tìm kiếm nhóm hàng..." 
                                    bind:value={itemSearch}
                                />
                                <button 
                                    class="px-3 py-1 bg-red-50 text-red-600 border border-red-200 rounded text-xs font-bold hover:bg-red-100 whitespace-nowrap flex items-center gap-1"
                                    on:click={() => clearSelection(group.id)}
                                    title="Xóa sạch mục đã chọn để chọn lại"
                                >
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
                                    Làm sạch ({group.items?.length || 0})
                                </button>
                            </div>
                            
                            <div class="max-h-60 overflow-y-auto grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-2 custom-scrollbar">
                                {#each filteredRawGroups as item}
                                    {@const isChecked = group.items.includes(item.id)}
                                    <label class="flex items-center gap-2 p-1.5 rounded border {isChecked ? 'bg-teal-50 border-teal-200' : 'border-transparent hover:bg-gray-50'} cursor-pointer transition">
                                        <input 
                                            type="checkbox" 
                                            checked={isChecked} 
                                            on:change={() => toggleItem(group.id, item.id)}
                                            class="rounded text-teal-600 focus:ring-teal-500"
                                        />
                                        <span class="text-xs text-gray-700 truncate" title={item.display}>
                                            {item.display}
                                        </span>
                                    </label>
                                {/each}
                            </div>
                        </div>
                    {/if}
                </div>
            {/each}
        </div>
    {/if}
</div>

<style>
    .animate-fade-in { animation: fadeIn 0.2s ease-out; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(-5px); } to { opacity: 1; transform: translateY(0); } }
</style>
--- END FILE: ./src/components/admin/category/MacroProductGroupEditor.svelte ---

--- START FILE: ./src/components/admin/category/NameMappingEditor.svelte ---
<script>
    import { onMount } from 'svelte';
    import { categoryStructure, categoryNameMapping, groupNameMapping, brandNameMapping } from '../../../stores.js';
    import { adminService } from '../../../services/admin.service.js';
    // [FIX] Import hàm cleanNameRaw
    import { cleanNameRaw } from '../../../utils.js';

    export let type = 'category'; // 'category' | 'group' | 'brand'

    let searchText = '';
    let isSaving = false;
    let localMapping = {}; 

    $: sourceData = $categoryStructure || [];
    
    let mappingStore, rawKey;
    
    $: if (type === 'category') {
        mappingStore = categoryNameMapping;
        rawKey = 'nganhHang';
    } else if (type === 'group') {
        mappingStore = groupNameMapping;
        rawKey = 'nhomHang';
    } else { // brand
        mappingStore = brandNameMapping;
        rawKey = 'nhaSanXuat';
    }
    
    $: uniqueRawNames = [...new Set(sourceData.map(item => item[rawKey]).filter(Boolean))].sort();

    $: {
        localMapping = { ...$mappingStore };
    }

    $: filteredList = uniqueRawNames.filter(name => 
        name.toLowerCase().includes(searchText.toLowerCase()) || 
        (localMapping[name] || '').toLowerCase().includes(searchText.toLowerCase())
    );

    // Hàm lấy tên gợi ý hiển thị trên giao diện (cột giữa)
    function getSuggestedName(rawName) {
        return cleanNameRaw(rawName);
    }

    async function handleSave() {
        isSaving = true;
        try {
            await adminService.saveNameMapping(type, localMapping);
            mappingStore.set(localMapping);
        } catch (e) {
            console.error(e);
            alert(e.message);
        } finally {
            isSaving = false;
        }
    }

    // [FIX] Hàm điền tự động giờ sẽ dùng logic làm sạch xịn
    function autoFillAll() {
        if (!confirm("Hành động này sẽ điền tên gợi ý (đã làm sạch) vào tất cả các ô trống. Tiếp tục?")) return;
        uniqueRawNames.forEach(raw => {
            if (!localMapping[raw]) {
                localMapping[raw] = cleanNameRaw(raw);
            }
        });
        localMapping = { ...localMapping };
    }
</script>

<div class="space-y-4">
    <div class="flex justify-between items-center bg-white p-2 rounded border border-gray-200">
        <input 
            type="text" 
            placeholder="🔍 Tìm tên gốc hoặc tên hiển thị..." 
            class="flex-grow p-2 text-sm outline-none"
            bind:value={searchText}
        />
        <div class="flex gap-2">
            <button 
                class="px-3 py-1.5 text-xs font-medium text-blue-600 bg-blue-50 rounded hover:bg-blue-100 transition"
                on:click={autoFillAll}
            >
                ✨ Điền tự động
            </button>
            <button 
                class="px-4 py-1.5 text-xs font-bold text-white bg-indigo-600 rounded hover:bg-indigo-700 transition shadow-sm flex items-center gap-1 disabled:opacity-50"
                on:click={handleSave}
                disabled={isSaving}
            >
                {#if isSaving}Lưu...{:else}Lưu Cấu Hình{/if}
            </button>
        </div>
    </div>

    {#if uniqueRawNames.length === 0}
        <div class="p-8 text-center border-2 border-dashed border-gray-200 rounded-lg">
            <p class="text-gray-500">Chưa có dữ liệu gốc. Vui lòng tải file Excel ở mục trên trước.</p>
        </div>
    {:else}
        <div class="border rounded-lg overflow-hidden bg-white shadow-sm max-h-[500px] overflow-y-auto custom-scrollbar">
            <table class="w-full text-sm">
                <thead class="bg-gray-100 text-xs uppercase font-bold text-gray-600 sticky top-0 z-10 shadow-sm">
                    <tr>
                        <th class="px-4 py-3 text-left w-1/3">Tên Gốc (Trong Excel)</th>
                        <th class="px-4 py-3 text-left w-1/3 text-gray-400">Tên Gợi Ý (Auto)</th>
                        <th class="px-4 py-3 text-left w-1/3 text-indigo-700">Tên Hiển Thị (Chỉnh sửa)</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-gray-100">
                    {#each filteredList as rawName}
                        {@const suggested = getSuggestedName(rawName)}
                        <tr class="hover:bg-slate-50 transition-colors group">
                            <td class="px-4 py-2 font-mono text-xs text-gray-600 select-all">{rawName}</td>
                            <td class="px-4 py-2 text-gray-400 italic text-xs select-all">{suggested}</td>
                            <td class="px-4 py-1">
                                <input 
                                    type="text" 
                                    class="w-full p-1.5 border border-gray-200 rounded text-sm font-medium text-indigo-800 focus:ring-1 focus:ring-indigo-500 focus:border-indigo-500 outline-none placeholder-gray-300"
                                    placeholder={suggested}
                                    bind:value={localMapping[rawName]}
                                />
                            </td>
                        </tr>
                    {/each}
                </tbody>
            </table>
        </div>
        <p class="text-xs text-gray-500 mt-2 italic text-right">
            * Các ô để trống sẽ tự động hiển thị theo "Tên Gợi Ý".
        </p>
    {/if}
</div>
--- END FILE: ./src/components/admin/category/NameMappingEditor.svelte ---

--- START FILE: ./src/components/common/FileInput.svelte ---
<script>
  /* global feather */
  import { onMount } from 'svelte';
  // [FIX] Import đúng object dataService
  import { dataService } from '../../services/dataService.js';
  import { 
    danhSachNhanVien, rawGioCongData, ycxData, thuongNongData,
    ycxDataThangTruoc, thuongNongDataThangTruoc,
    fileSyncState 
  } from '../../stores.js';

  export let label = "Chưa có nhãn";
  export let icon = "file";
  export let saveKey = ""; 

  let fileName = "Chưa thêm file";
  let statusHTML = ""; 
  let isLoading = false;
  let statusClass = "text-gray-500";
  let localError = ""; // [FIX] Biến lưu lỗi cục bộ
  
  const storeMap = {
    'saved_danhsachnv': danhSachNhanVien,
    'saved_giocong': rawGioCongData,
    'saved_ycx': ycxData,
    'saved_thuongnong': thuongNongData,
    'saved_ycx_thangtruoc': ycxDataThangTruoc,
    'saved_thuongnong_thangtruoc': thuongNongDataThangTruoc
  };
  let dataStore = storeMap[saveKey];

  $: syncState = $fileSyncState[saveKey];
  $: dataCount = $dataStore ? $dataStore.length : 0;

  // Logic hiển thị trạng thái (Reactive)
  $: {
      if (isLoading) {
          statusHTML = "Đang xử lý...";
          statusClass = "text-blue-600 font-semibold";
      } else if (localError) {
          // [FIX] Ưu tiên hiển thị lỗi nếu có
          statusHTML = localError;
          statusClass = "text-red-600 font-bold";
      } else if (syncState) {
          if (syncState.status === 'update_available') {
              statusClass = "text-orange-600 font-semibold";
              statusHTML = `
                  <span>${syncState.message}</span>
                  <button class="ml-2 px-2 py-0.5 bg-blue-100 text-blue-700 text-xs rounded hover:bg-blue-200 border border-blue-300 font-bold btn-download-cloud pointer-events-auto">
                      Tải & Xử lý
                  </button>
              `;
          } else if (syncState.status === 'downloading') {
              statusClass = "text-blue-600";
              statusHTML = syncState.message;
          } else if (syncState.status === 'error') {
              statusClass = "text-red-600";
              statusHTML = syncState.message;
          } else {
              // Synced hoặc Cached
              statusClass = "text-green-600 font-medium";
              statusHTML = syncState.message;
              if (syncState.metadata?.fileName) fileName = syncState.metadata.fileName;
          }
      } else if (dataCount > 0) {
          // Fallback khi chưa có syncState nhưng có data trong store
          statusClass = "text-green-600";
          statusHTML = `✓ Đã tải ${dataCount} dòng (Local)`;
          
          if (saveKey === 'saved_danhsachnv') {
               const savedName = localStorage.getItem('_localDsnvFilename');
               if(savedName) fileName = savedName;
          }
      } else {
          statusHTML = "";
      }
  }

  async function handleChange(event) {
    const file = event.target.files[0];
    if (!file) return;
    
    isLoading = true;
    localError = ""; // Reset lỗi cũ
    fileName = file.name;

    try {
      // Gọi service
      const result = await dataService.handleFileChange(file, saveKey);
      
      if (!result.success) {
          localError = result.message;
      }
    } catch (err) {
      console.error(err);
      localError = `Lỗi: ${err.message}`;
    } finally {
      isLoading = false;
      event.target.value = null;
    }
  }

  function handleContainerClick(e) {
      if (e.target.closest('.btn-download-cloud')) {
          e.preventDefault(); 
          e.stopPropagation();
          dataService.downloadFileFromCloud(saveKey);
      }
  }
  
  onMount(() => {
     if (typeof feather !== 'undefined') feather.replace();
  });
</script>

<div class="data-input-group input-group--yellow" on:click={handleContainerClick}> 
    <div class="data-input-group__label"> 
       <i data-feather={icon} class="h-5 w-5 feather"></i>
        <span>{label}:</span>
    </div> 
    <div class="data-input-group__content"> 
        <div class="flex items-center gap-2"> 
            <label for="file-{saveKey}" class="data-input-group__file-trigger" class:opacity-50={isLoading}>
                {isLoading ? 'Đang chạy...' : 'Thêm file'}
            </label>
            <span class="data-input-group__file-name" title={fileName}>{fileName}</span> 
        </div> 
        
        {#if saveKey === 'saved_danhsachnv'}
            <button on:click={() => dataService.handleTemplateDownload()} class="data-input-group__link text-left">Tải file mẫu</button> 
        {/if}

        <input type="file" id="file-{saveKey}" class="hidden" accept=".xlsx, .xls, .csv" on:change={handleChange} disabled={isLoading}> 
        
        <div class="data-input-group__status-wrapper"> 
            <span class="data-input-group__status-text {statusClass}">{@html statusHTML}</span> 
        </div> 
        
        {#if isLoading || (syncState && syncState.status === 'downloading')}
            <div class="progress-bar-container">
                <div class="progress-bar" style="width: 100%; background-color: #3b82f6;"></div>
            </div>
        {/if}
    </div> 
</div>
--- END FILE: ./src/components/common/FileInput.svelte ---

--- START FILE: ./src/components/common/GlobalNotification.svelte ---
<script>
  import { notificationStore } from '../../stores.js';
</script>

{#if $notificationStore.visible}
  <div 
    class="fixed bottom-5 right-5 p-4 rounded-lg shadow-md text-white z-[1200] transition-all duration-500 transform translate-y-0
           {$notificationStore.type === 'success' ? 'bg-green-500' : 'bg-red-500'}"
    role="alert"
  >
    {$notificationStore.message}
  </div>
{/if}
--- END FILE: ./src/components/common/GlobalNotification.svelte ---

--- START FILE: ./src/components/common/PasteInput.svelte ---
<script>
  /* global feather */
  import { onMount } from 'svelte';
  import { dataService } from '../../services/dataService.js';
  import { 
    competitionData,
    pastedThiDuaReportData,
    thuongERPData,
    thuongERPDataThangTruoc,
    fileSyncState 
  } from '../../stores.js';

  export let label = "Chưa có nhãn";
  export let icon = "clipboard";
  export let link = "#"; 
  export let saveKeyPaste = ""; 
  export let saveKeyRaw = ""; 
  export let saveKeyProcessed = ""; 

  let textareaEl;
  let pastedText = "";
  let localError = "";

  const storeMap = {
    'daily_paste_luyke': competitionData,
    'daily_paste_thiduanv': pastedThiDuaReportData,
    'daily_paste_thuongerp': thuongERPData,
    'saved_thuongerp_thangtruoc': thuongERPDataThangTruoc
  };
  
  const unitMap = {
    'daily_paste_luyke': 'CT thi đua',
    'daily_paste_thiduanv': 'nhân viên',
    'daily_paste_thuongerp': 'nhân viên',
    'saved_thuongerp_thangtruoc': 'nhân viên'
  };

  const countStore = storeMap[saveKeyProcessed || saveKeyPaste];

  $: syncState = $fileSyncState[saveKeyPaste];
  $: dataCount = countStore ? $countStore?.length || 0 : 0;

  let statusHTML = "";
  let statusClass = "text-gray-500";
  let isLoading = false;

  $: {
      const unit = unitMap[saveKeyPaste] || 'dòng';
      const countDisplay = `(${dataCount} ${unit})`;

      if (isLoading) {
          statusHTML = "Đang xử lý...";
          statusClass = "text-blue-600 font-semibold";
      } else if (localError) {
          statusHTML = localError;
          statusClass = "text-red-600 font-bold";
      } else if (syncState) {
          if (syncState.status === 'update_available') {
              statusClass = "text-orange-600 font-semibold";
              const msg = syncState.message || "Có dữ liệu mới";
              statusHTML = `
                  <span class="mr-2">${msg}</span>
                  <button class="px-2 py-0.5 bg-blue-100 text-blue-700 text-xs rounded hover:bg-blue-200 border border-blue-300 font-bold btn-download-cloud pointer-events-auto shadow-sm">
                      Tải & Xử lý
                  </button>
              `;
          } else if (syncState.status === 'downloading') {
              statusClass = "text-blue-600";
              statusHTML = syncState.message || "Đang tải...";
          } else if (syncState.status === 'error') {
              statusClass = "text-red-600";
              statusHTML = syncState.message;
          } else if (syncState.status === 'synced' || syncState.status === 'cached') {
              // [FIX LOGIC] Chỉ báo lỗi 0 NV nếu ĐÃ CÓ TEXT (pastedText > 0)
              // Nếu pastedText trống, nghĩa là chưa tải nội dung về, thì không coi là lỗi
              if (dataCount === 0 && saveKeyPaste === 'daily_paste_thiduanv' && pastedText.length > 0) {
                  statusClass = "text-red-600 font-bold";
                  statusHTML = `⚠ Đã xử lý 0 NV. Vui lòng kiểm tra DSNV!`;
              } else {
                  statusClass = "text-green-600 font-medium";
                  const prefix = syncState.status === 'synced' ? '✓ Đã đồng bộ' : '✓ Đã tải';
                  let cleanMsg = syncState.message
                      .replace('✓ Đã đồng bộ', '')
                      .replace('✓ Đã tải', '')
                      .replace('(Local)', '')
                      .trim();
                  
                  // Logic hiển thị thông minh: Nếu chưa có text, gợi ý tải
                  if (pastedText.length === 0 && syncState.status === 'synced') {
                      // Đã đồng bộ metadata nhưng chưa có text -> Hiển thị nút tải lại cho chắc
                       statusHTML = `
                          <span class="mr-2 text-gray-500">✓ Đã biết có dữ liệu trên Cloud.</span>
                          <button class="px-2 py-0.5 bg-green-50 text-green-700 text-xs rounded hover:bg-green-100 border border-green-200 font-bold btn-download-cloud pointer-events-auto shadow-sm">
                              Tải về máy
                          </button>
                      `;
                  } else {
                       // Hiển thị bình thường
                       if (cleanMsg.includes('dòng') || cleanMsg.includes('nhân viên') || cleanMsg.includes('CT')) {
                           if(cleanMsg.includes('trước') || cleanMsg.includes('vừa xong')) {
                               statusHTML = `${prefix} ${countDisplay} ${cleanMsg}`;
                           } else {
                               statusHTML = `${prefix} ${countDisplay}`;
                           }
                      } else {
                           statusHTML = `${prefix} ${countDisplay} ${cleanMsg}`;
                      }
                  }
              }
          } else if (syncState.status === 'checking') {
               statusClass = "text-gray-500 italic";
               statusHTML = "Đang kiểm tra đồng bộ...";
          }
      } else if (dataCount > 0) {
          statusClass = "text-green-600";
          statusHTML = `✓ Đã tải ${countDisplay} (Local)`;
      } else {
          statusHTML = "";
      }
  }

  onMount(() => {
    const textLoadKey = saveKeyRaw || saveKeyPaste;
    pastedText = localStorage.getItem(textLoadKey) || "";
    
    window.addEventListener('cloud-paste-loaded', (e) => {
        if (e.detail.key === saveKeyPaste) {
            pastedText = e.detail.text;
        }
    });

    if (typeof feather !== 'undefined') feather.replace();
  });

  let pasteTimer;
  function handleInput(event) {
      const text = event.target.value;
      pastedText = text;
      localError = "";
      clearTimeout(pasteTimer);
      
      if (!text || text.trim().length < 5) return;
      
      isLoading = true;
      pasteTimer = setTimeout(async () => {
          try {
            const result = await dataService.handlePasteChange(
                text, 
                saveKeyPaste, 
                saveKeyRaw, 
                saveKeyProcessed
            );
            if (!result.success) localError = result.message;
          } catch (err) {
            console.error(`Lỗi paste ${label}:`, err);
            localError = `Lỗi: ${err.message}`;
          } finally {
            isLoading = false;
          }
      }, 500);
  }

  function handleContainerClick(e) {
      if (e.target.closest('.btn-download-cloud')) {
          e.preventDefault();
          e.stopPropagation();
          dataService.downloadFileFromCloud(saveKeyPaste);
      }
  }
</script>

<div class="data-input-group input-group--blue h-full" on:click={handleContainerClick}>
    <a href={link} target="_blank" class="data-input-group__label data-input-group__label--link">
        <i data-feather={icon} class="h-5 w-5 feather"></i>
        <span>{label}: <span class="font-normal text-xs text-gray-500 ml-1">(Copy từ BI)</span></span>
    </a>
    <div class="data-input-group__content flex flex-col flex-grow">
        <textarea 
            bind:this={textareaEl}
            rows="5" 
            class="data-textarea flex-grow mb-1" 
            placeholder="Dán dữ liệu đã sao chép vào đây..."
            on:input={handleInput}
            value={pastedText}
            disabled={isLoading}
        ></textarea>
        
        <div class="data-input-group__status-wrapper min-h-[20px]">
            <span class="data-input-group__status-text {statusClass} flex items-center gap-1">
                {@html statusHTML}
            </span>
        </div>
        
        {#if isLoading || (syncState && syncState.status === 'downloading')}
             <div class="progress-bar-container mt-1">
                <div class="progress-bar" style="width: 100%; background-color: #3b82f6;"></div>
            </div>
        {/if}
    </div>
</div>
--- END FILE: ./src/components/common/PasteInput.svelte ---

--- START FILE: ./src/components/common/SortableTh.svelte ---
<script>
  import { createEventDispatcher } from 'svelte';
  
  // Props
  export let key = '';           // Key định danh cột
  export let label = '';         // Tên hiển thị
  export let sortKey = '';       // Cột đang được sort
  export let sortDirection = 'desc'; // Hướng sort
  export let align = 'left';     // Căn lề: left, right, center
  export let className = '';     // Class tùy chỉnh thêm (vd: sticky, width)

  const dispatch = createEventDispatcher();

  function handleClick() {
    dispatch('sort', key);
  }

  $: isActive = sortKey === key;
  
  // Logic căn lề flexbox
  $: alignClass = align === 'right' ? 'justify-end' : 
                  align === 'center' ? 'justify-center' : 
                  'justify-start';

  // Logic căn lề text
  $: textAlignClass = align === 'right' ? 'text-right' : 
                      align === 'center' ? 'text-center' : 
                      'text-left';
</script>

<th 
  class="px-4 py-3 cursor-pointer transition select-none hover:bg-slate-200 {textAlignClass} {className} {isActive ? 'bg-blue-50' : ''}"
  on:click={handleClick}
  role="columnheader"
  aria-sort={isActive ? (sortDirection === 'asc' ? 'ascending' : 'descending') : 'none'}
>
  <div class="flex items-center gap-1 {alignClass}">
    <span class="font-bold uppercase text-xs {isActive ? 'text-blue-800' : 'text-slate-700'}">
      {label}
    </span>
    
    <span class="flex flex-col items-center justify-center w-4 h-4">
      {#if !isActive}
        <svg xmlns="http://www.w3.org/2000/svg" class="w-3 h-3 text-gray-400 opacity-50" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
          <path stroke-linecap="round" stroke-linejoin="round" d="M7 16V4m0 0L3 8m4-4l4 4m6 0v12m0 0l4-4m-4 4l-4-4" />
        </svg>
      {:else if sortDirection === 'asc'}
        <svg xmlns="http://www.w3.org/2000/svg" class="w-3.5 h-3.5 text-blue-700" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="3">
          <path stroke-linecap="round" stroke-linejoin="round" d="M5 15l7-7 7 7" />
        </svg>
      {:else}
        <svg xmlns="http://www.w3.org/2000/svg" class="w-3.5 h-3.5 text-blue-700" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="3">
          <path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7" />
        </svg>
      {/if}
    </span>
  </div>
</th>
--- END FILE: ./src/components/common/SortableTh.svelte ---

--- START FILE: ./src/components/drawers/GoalDrawer.svelte ---
<script>
    import { onMount, afterUpdate } from 'svelte';
    import { 
        drawerState, 
        warehouseList, 
        luykeGoalSettings, 
        realtimeGoalSettings,
        modalState,
        localCompetitionConfigs, 
        selectedWarehouse,
        efficiencyConfig // Cấu hình admin
    } from '../../stores.js';
    import { settingsService } from '../../services/settings.service.js';
    import { datasyncService } from '../../services/datasync.service.js';
    import { adminService } from '../../services/admin.service.js';
    
    let activeTab = 'monthly';
    let localSelectedWarehouse = ''; 
    
    let currentLuykeGoals = {};
    let currentRealtimeGoals = { goals: {}, timing: {} };

    $: isOpen = $drawerState.activeDrawer === 'goal-drawer';

    // Tự động chọn kho
    $: if (isOpen && !localSelectedWarehouse) {
        localSelectedWarehouse = $selectedWarehouse || ($warehouseList.length > 0 ? $warehouseList[0] : '');
    }

    // [MỚI] Khi đổi kho, tải dữ liệu từ Cloud
    $: if (isOpen && localSelectedWarehouse) {
        loadGoals(localSelectedWarehouse);
    }

    async function loadGoals(kho) {
        await settingsService.loadGoalsFromCloud(kho);
        
        // Cập nhật biến local để bind vào input
        currentLuykeGoals = { ...($luykeGoalSettings[kho] || {}) };
        
        const rtSettings = $realtimeGoalSettings[kho] || { goals: {}, timing: {} };
        currentRealtimeGoals = {
            goals: { ...rtSettings.goals },
            timing: { ...rtSettings.timing }
        };
    }
    
    onMount(async () => {
        const configs = await adminService.loadEfficiencyConfig();
        efficiencyConfig.set(configs);
        if (typeof feather !== 'undefined') feather.replace();
    });

    afterUpdate(() => {
        if (typeof feather !== 'undefined') feather.replace();
    });

    function close() {
        drawerState.update(s => ({ ...s, activeDrawer: null }));
    }

    function switchTab(tab) {
        activeTab = tab;
    }

    function saveLuyke() {
        if (!localSelectedWarehouse) return;
        settingsService.saveLuykeGoalForWarehouse(localSelectedWarehouse, currentLuykeGoals);
    }

    function saveRealtime() {
        if (!localSelectedWarehouse) return;
        settingsService.saveRealtimeGoalForWarehouse(localSelectedWarehouse, currentRealtimeGoals);
    }

    // Các hàm quản lý thi đua (giữ nguyên)
    function openCompetitionManager() {
        if (localSelectedWarehouse) selectedWarehouse.set(localSelectedWarehouse);
        modalState.update(s => ({ ...s, activeModal: 'user-competition-modal' }));
    }
    function editCompetition(index) {
        if (localSelectedWarehouse) selectedWarehouse.set(localSelectedWarehouse);
        modalState.update(s => ({ ...s, activeModal: 'user-competition-modal', editingIndex: index }));
    }
    async function deleteCompetition(index) {
        if (!confirm("Bạn có chắc chắn muốn xóa chương trình thi đua này?")) return;
        let newConfigs = [...$localCompetitionConfigs];
        newConfigs.splice(index, 1);
        localCompetitionConfigs.set(newConfigs);
        if (localSelectedWarehouse) {
            try { await datasyncService.saveCompetitionConfigs(localSelectedWarehouse, newConfigs); } catch(e) { console.error(e); }
        }
    }

    const percentageInputs = [
        { id: 'phanTramQD', label: '% Quy đổi' },
        { id: 'phanTramTC', label: '% Trả chậm' }
    ];
</script>

{#if isOpen}
    <div class="fixed inset-0 bg-black/40 z-40 transition-opacity" on:click={close} role="button" tabindex="0"></div>
{/if}

<div class="fixed top-0 left-0 h-full bg-white shadow-2xl z-50 p-6 overflow-y-auto w-[500px] max-w-[95vw] transition-transform duration-300 ease-in-out transform {isOpen ? 'translate-x-0' : '-translate-x-full'}">
    
    <div class="flex justify-between items-center mb-6">
        <h3 class="text-xl font-bold text-gray-800">Thiết lập mục tiêu</h3>
        <button class="text-gray-500 hover:text-gray-800 text-3xl leading-none" on:click={close}>&times;</button>
    </div>

    <div class="border-b border-gray-200 mb-6 flex space-x-6">
        <button class="pb-2 border-b-2 font-medium text-sm transition-colors {activeTab === 'monthly' ? 'border-blue-600 text-blue-600' : 'border-transparent text-gray-500 hover:text-gray-700'}" on:click={() => switchTab('monthly')}>
            Mục tiêu Tháng (Lũy kế)
        </button>
        <button class="pb-2 border-b-2 font-medium text-sm transition-colors {activeTab === 'daily' ? 'border-blue-600 text-blue-600' : 'border-transparent text-gray-500 hover:text-gray-700'}" on:click={() => switchTab('daily')}>
            Mục tiêu Ngày (Realtime)
        </button>
    </div>

    <div class="space-y-8">
        <div>
            <label for="goal-warehouse" class="block text-sm font-bold text-gray-700 mb-1">Thiết lập cho kho</label>
            <select id="goal-warehouse" class="w-full p-2.5 border border-gray-300 rounded-lg text-sm bg-white shadow-sm focus:ring-2 focus:ring-blue-500 outline-none font-semibold text-blue-700" bind:value={localSelectedWarehouse}>
                {#if $warehouseList.length === 0}
                    <option value="">Vui lòng tải file DSNV...</option>
                {:else}
                    {#each $warehouseList as kho}
                        <option value={kho}>{kho}</option>
                    {/each}
                {/if}
            </select>
        </div>

        {#if activeTab === 'monthly'}
            <div class="space-y-5 animate-fade-in">
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label for="luyke-dtt" class="block text-sm font-medium text-gray-700">Target DT Thực</label>
                        <input type="number" id="luyke-dtt" class="luyke-goal-input mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500" bind:value={currentLuykeGoals.doanhThuThuc} on:input={saveLuyke}>
                    </div>
                    <div>
                        <label for="luyke-dtqd" class="block text-sm font-medium text-gray-700">Target DT QĐ</label>
                        <input type="number" id="luyke-dtqd" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500" bind:value={currentLuykeGoals.doanhThuQD} on:input={saveLuyke}>
                    </div>
                </div>

                <details class="group border rounded-lg overflow-hidden" open>
                    <summary class="p-3 text-sm font-bold cursor-pointer bg-gray-50 hover:bg-gray-100 flex justify-between items-center select-none">
                         Mục tiêu khai thác (%)
                        <span class="transform group-open:rotate-180 transition-transform">▼</span>
                    </summary>
                    <div class="p-4 bg-white border-t grid grid-cols-2 gap-4">
                        {#each percentageInputs as input}
                            <div>
                                <label for="luyke-{input.id}" class="block text-sm font-medium text-gray-700">{input.label}</label>
                                <input type="number" id="luyke-{input.id}" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500" bind:value={currentLuykeGoals[input.id]} on:input={saveLuyke}>
                            </div>
                        {/each}
                        
                        {#each $efficiencyConfig as item}
                            <div>
                                <label for="goal-{item.id}" class="block text-sm font-medium text-gray-700 truncate" title={item.label}>
                                    {item.label} (MT: {item.target}%)
                                </label>
                                <input 
                                    type="number" 
                                    id="goal-{item.id}" 
                                    class="mt-1 block w-full p-2 border border-blue-200 bg-blue-50 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500" 
                                    placeholder={item.target} 
                                    bind:value={currentLuykeGoals[item.id]} 
                                    on:input={saveLuyke}
                                >
                            </div>
                        {/each}
                    </div>
                </details>
            </div>
        {/if}

        {#if activeTab === 'daily'}
            <div class="space-y-5 animate-fade-in">
                <div class="grid grid-cols-2 gap-4 items-end">
                    <div>
                        <label for="rt-open" class="block text-sm font-medium text-gray-700 mb-1">Giờ mở cửa</label>
                        <input type="time" id="rt-open" class="p-2 border border-gray-300 rounded-md shadow-sm w-full" bind:value={currentRealtimeGoals.timing['rt-open-hour']} on:input={saveRealtime}>
                    </div>
                    <div>
                        <label for="rt-close" class="block text-sm font-medium text-gray-700 mb-1">Giờ đóng cửa</label>
                        <input type="time" id="rt-close" class="p-2 border border-gray-300 rounded-md shadow-sm w-full" bind:value={currentRealtimeGoals.timing['rt-close-hour']} on:input={saveRealtime}>
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label for="rt-dtt" class="block text-sm font-medium text-gray-700">DT Thực (triệu)</label>
                        <input type="number" id="rt-dtt" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500" bind:value={currentRealtimeGoals.goals.doanhThuThuc} on:input={saveRealtime}>
                    </div>
                    <div>
                        <label for="rt-dtqd" class="block text-sm font-medium text-gray-700">DT QĐ (triệu)</label>
                        <input type="number" id="rt-dtqd" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500" bind:value={currentRealtimeGoals.goals.doanhThuQD} on:input={saveRealtime}>
                    </div>
                </div>
                
                <details class="group border rounded-lg overflow-hidden" open>
                    <summary class="p-3 text-sm font-bold cursor-pointer bg-gray-50 hover:bg-gray-100 flex justify-between items-center select-none">
                         Mục tiêu tỷ lệ Realtime (%)
                        <span class="transform group-open:rotate-180 transition-transform">▼</span>
                    </summary>
                    <div class="p-4 bg-white border-t grid grid-cols-2 gap-4">
                        {#each percentageInputs as input}
                            <div>
                                <label for="rt-{input.id}" class="block text-sm font-medium text-gray-700">{input.label}</label>
                                <input type="number" id="rt-{input.id}" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500" bind:value={currentRealtimeGoals.goals[input.id]} on:input={saveRealtime}>
                            </div>
                        {/each}
                         {#each $efficiencyConfig as item}
                            <div>
                                <label for="rt-goal-{item.id}" class="block text-sm font-medium text-gray-700 truncate" title={item.label}>{item.label}</label>
                                <input type="number" id="rt-goal-{item.id}" class="mt-1 block w-full p-2 border border-blue-200 bg-blue-50 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500" placeholder={item.target} bind:value={currentRealtimeGoals.goals[item.id]} on:input={saveRealtime}>
                            </div>
                        {/each}
                    </div>
                </details>
            </div>
        {/if}

        <div class="border-t pt-6 space-y-4">
            <div class="flex justify-between items-center">
                <h4 class="text-lg font-bold text-gray-800">Quản lý Chương trình Thi đua</h4>
                <button on:click={openCompetitionManager} class="text-sm bg-blue-600 text-white px-3 py-1.5 rounded-lg hover:bg-blue-700 font-medium flex items-center gap-1 shadow-sm"><i data-feather="plus-circle" class="w-4 h-4"></i> Tạo mới</button>
            </div>
            <div class="space-y-3 max-h-[300px] overflow-y-auto pr-1 custom-scrollbar pb-2">
                {#if $localCompetitionConfigs.length === 0}
                    <div class="text-center py-6 bg-gray-50 rounded-lg border border-dashed border-gray-300">
                        <p class="text-gray-500 text-sm italic">Chưa có chương trình nào.</p>
                    </div>
                {:else}
                    {#each $localCompetitionConfigs as config, index}
                        <div class="bg-white border border-gray-200 rounded-xl p-4 shadow-sm relative group hover:border-blue-300 hover:shadow-md transition-all">
                            <h4 class="text-lg font-bold text-gray-800 mb-2 pr-16">{config.name}</h4>
                            <div class="text-sm mb-1"><span class="font-semibold text-gray-600">Hãng:</span> <span class="font-bold text-blue-600 ml-1">{config.brands.join(', ')}</span></div>
                            <div class="absolute top-4 right-4 flex gap-2">
                                <button on:click={() => editCompetition(index)} class="p-1.5 text-gray-400 hover:text-blue-600 hover:bg-blue-50 rounded-md transition-colors"><i data-feather="edit-2" class="w-4 h-4"></i></button>
                                <button on:click={() => deleteCompetition(index)} class="p-1.5 text-gray-400 hover:text-red-600 hover:bg-red-50 rounded-md transition-colors"><i data-feather="trash-2" class="w-4 h-4"></i></button>
                            </div>
                        </div>
                    {/each}
                {/if}
            </div>
        </div>
    </div>
</div>

<style>
    @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
    .animate-fade-in { animation: fadeIn 0.3s ease-out; }
    .custom-scrollbar::-webkit-scrollbar { width: 4px; }
    .custom-scrollbar::-webkit-scrollbar-track { background: #f1f1f1; }
    .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 2px; }
    .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
</style>
--- END FILE: ./src/components/drawers/GoalDrawer.svelte ---

--- START FILE: ./src/components/drawers/InterfaceDrawer.svelte ---
<script>
    import { drawerState, interfaceSettings } from '../../stores.js';
    // [FIX] Cập nhật đường dẫn settings service
    import { settingsService } from '../../services/settings.service.js';
    import { onMount } from 'svelte';

    // ... (Giữ nguyên phần code còn lại)
    $: isOpen = $drawerState.activeDrawer === 'interface-drawer';

    function close() {
        drawerState.update(s => ({ ...s, activeDrawer: null }));
    }

    function onContrastChange(event) {
        const level = event.target.value;
        settingsService.updateContrast(level);
    }

    function onSettingChange() {
        settingsService.updateInterface($interfaceSettings);
    }
    
    onMount(() => {
        settingsService.loadInterfaceSettings();
    });
</script>

{#if isOpen}
    <div 
        class="fixed inset-0 bg-black/40 z-40 transition-opacity"
        on:click={close}
        role="button"
        tabindex="0"
    ></div>
{/if}

<div 
    class="fixed top-0 left-0 h-full bg-white shadow-2xl z-50 p-6 overflow-y-auto w-[400px] max-w-[90vw] transition-transform duration-300 ease-in-out transform {isOpen ? 'translate-x-0' : '-translate-x-full'}"
>
    <div class="flex justify-between items-center mb-6">
        <h3 class="text-xl font-bold text-gray-800">Cài đặt giao diện</h3>
        <button 
            class="text-gray-500 hover:text-gray-800 text-3xl leading-none"
            on:click={close}
        >&times;</button>
    </div>
    <div class="space-y-6">
        <div>
            <label for="contrast-selector" class="block text-sm font-medium text-gray-700 mb-2">Độ tương phản</label>
            <select 
                id="contrast-selector" 
                class="w-full p-2 border rounded-lg text-sm bg-white shadow-sm focus:ring-2 focus:ring-blue-500 outline-none"
                value={$interfaceSettings.contrastLevel || '3'}
                on:change={onContrastChange}
            >
                <option value="1">Rất nhẹ</option>
                <option value="2">Nhẹ</option>
                <option value="3">Bình thường</option>
                <option value="4">Cao</option>
                <option value="5">Rất cao</option>
                <option value="6">Cao nhất</option>
            </select>
        </div>

        <div>
            <label for="global-font-size-slider" class="flex justify-between text-sm font-medium text-gray-700 mb-2">
                <span>Cỡ chữ toàn trang</span>
                <span class="font-bold text-blue-600">{$interfaceSettings.globalFontSize}px</span>
            </label>
            <input 
                type="range" 
                id="global-font-size-slider" 
                min="12" max="25" step="1" 
                class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-blue-600"
                bind:value={$interfaceSettings.globalFontSize}
                on:input={onSettingChange}
            >
        </div>

        <div>
             <label for="kpi-font-size-slider" class="flex justify-between text-sm font-medium text-gray-700 mb-2">
                <span>Cỡ chữ thẻ KPI</span>
                <span class="font-bold text-blue-600">{$interfaceSettings.kpiFontSize}px</span>
            </label>
            <input 
                type="range" 
                id="kpi-font-size-slider" 
                min="24" max="48" step="2" 
                class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-blue-600"
                bind:value={$interfaceSettings.kpiFontSize}
                on:input={onSettingChange}
            >
        </div>

        <div>
            <h4 class="text-sm font-medium text-gray-700 mb-2">Màu sắc thẻ KPI</h4>
            <div class="grid grid-cols-2 gap-4">
                {#each [1, 2, 3, 4, 5, 6, 7, 8] as num}
                    <div class="flex items-center gap-2">
                        <input 
                            type="color" 
                            id="kpi-color-{num}" 
                            class="p-1 h-10 w-14 block bg-white border border-gray-300 cursor-pointer rounded-lg"
                            bind:value={$interfaceSettings[`kpiCard${num}Bg`]}
                            on:input={onSettingChange}
                        >
                        <label for="kpi-color-{num}" class="text-sm">Thẻ {num}</label>
                    </div>
                {/each}
            </div>
        </div>

        <div>
            <h4 class="text-sm font-medium text-gray-700 mb-2">Màu chữ thẻ KPI</h4>
             <div class="space-y-2">
                 <div class="flex items-center gap-2">
                    <input 
                        type="color" 
                        id="kpi-title-color" 
                        class="p-1 h-10 w-14 block bg-white border border-gray-300 cursor-pointer rounded-lg"
                        bind:value={$interfaceSettings.kpiTitleColor}
                        on:input={onSettingChange}
                    >
                    <label for="kpi-title-color" class="text-sm">Tiêu đề thẻ</label>
                </div>
                <div class="flex items-center gap-2">
                    <input 
                        type="color" 
                        id="kpi-main-color" 
                        class="p-1 h-10 w-14 block bg-white border border-gray-300 cursor-pointer rounded-lg"
                        bind:value={$interfaceSettings.kpiMainColor}
                        on:input={onSettingChange}
                    >
                    <label for="kpi-main-color" class="text-sm">Giá trị chính</label>
                </div>
                <div class="flex items-center gap-2">
                    <input 
                        type="color" 
                        id="kpi-sub-color" 
                        class="p-1 h-10 w-14 block bg-white border border-gray-300 cursor-pointer rounded-lg"
                        bind:value={$interfaceSettings.kpiSubColor}
                        on:input={onSettingChange}
                    >
                    <label for="kpi-sub-color" class="text-sm">Giá trị phụ</label>
                </div>
            </div>
        </div>
    </div>
</div>
--- END FILE: ./src/components/drawers/InterfaceDrawer.svelte ---

--- START FILE: ./src/components/health-staff/CategoryRevenueView.svelte ---
<script>
  import { onMount } from 'svelte';
  import { customRevenueTables, modalState, isAdmin, selectedWarehouse } from '../../stores.js';
  import { adminService } from '../../services/admin.service.js';
  import { datasyncService } from '../../services/datasync.service.js';
  import DynamicRevenueTable from './DynamicRevenueTable.svelte';

  export let reportData = [];

  let isLoading = false;
  // Biến tĩnh (module-level) để ghi nhớ kho đã tải lần cuối cùng component này được mount
  let lastLoadedWarehouse = '';

  // [FIX CRASH] Logic tính toán visibleTables an toàn tuyệt đối
  $: visibleTables = ($customRevenueTables || []).reduce((acc, table, index) => {
      // Chỉ lấy bảng chưa bị ẩn
      if (table.isVisible !== false) {
          acc.push({
              ...table,
              // Nếu id null/undefined, tạo id tạm dựa trên index để Svelte không báo duplicate key
              id: table.id ? table.id : `fallback_render_id_${index}` 
          });
      }
      return acc;
  }, []);

  // [LOGIC MỚI] Khi Kho thay đổi -> Tải lại dữ liệu (Có kiểm tra Cache)
  $: if ($selectedWarehouse) {
      handleWarehouseDataLoad($selectedWarehouse);
  }

  async function handleWarehouseDataLoad(kho) {
      // CASE 1: Dữ liệu đã có trong Store và đúng là của kho hiện tại (hoặc chưa chọn kho specific)
      // -> KHÔNG TẢI LẠI (Instant load)
      if ($customRevenueTables.length > 0 && lastLoadedWarehouse === kho) {
          console.log(`[CategoryView] Dùng Cache Store cho kho: ${kho}`);
          return;
      }

      // CASE 2: Chưa có dữ liệu hoặc đổi kho -> Tiến hành tải
      await loadData(kho);
  }

  async function loadData(kho) {
      console.log(`[CategoryView] Loading tables for warehouse: ${kho}`);
      
      // Chỉ hiện loading nếu Store đang rỗng (tránh chớp nháy khi refresh ngầm)
      if ($customRevenueTables.length === 0) {
          isLoading = true;
      }
      
      try {
          // 1. Tải bảng Hệ thống (Global)
          const systemTables = await adminService.loadSystemRevenueTables();
          
          // 2. Tải bảng Cá nhân (Warehouse Cloud)
          const personalTables = await datasyncService.loadPersonalRevenueTables(kho);

          // 3. Tải Preferences ẩn/hiện (Local)
          const hiddenSystemIds = JSON.parse(localStorage.getItem('hiddenSystemTableIds') || '[]');

          // 4. Merge & Sanitize (Làm sạch dữ liệu)
          const finalSystemTables = (systemTables || []).map((t, index) => ({
              ...t,
              id: t.id || `sys_gen_${index}_${Date.now()}`, 
              isSystem: true,
              isVisible: !hiddenSystemIds.includes(t.id)
          }));

          const safePersonalTables = (personalTables || []).map((t, index) => ({
              ...t,
              id: t.id || `per_gen_${index}_${Date.now()}` 
          }));

          // Cập nhật Store
          customRevenueTables.set([...finalSystemTables, ...safePersonalTables]);
          
          // Ghi nhớ kho đã tải thành công
          lastLoadedWarehouse = kho;

      } catch (e) {
          console.error("[CategoryView] Lỗi tải dữ liệu bảng:", e);
      } finally {
          isLoading = false;
      }
  }

  // --- CÁC HÀM XỬ LÝ SỰ KIỆN ---
  async function savePersonalTables() {
      if (!$selectedWarehouse) return;
      const personalTables = $customRevenueTables.filter(t => !t.isSystem);
      await datasyncService.savePersonalRevenueTables($selectedWarehouse, personalTables);
  }

  function saveHiddenPreferences() {
      const hiddenIds = $customRevenueTables
          .filter(t => t.isSystem && t.isVisible === false)
          .map(t => t.id);
      localStorage.setItem('hiddenSystemTableIds', JSON.stringify(hiddenIds));
  }

  function toggleTableVisibility(id) {
      if (!id || String(id).startsWith('fallback_render_id_')) return;
      customRevenueTables.update(items => items.map(t => t.id === id ? { ...t, isVisible: !t.isVisible } : t));
      savePersonalTables();
      saveHiddenPreferences();
  }

  function editTable(table) {
      if (String(table.id).startsWith('fallback_render_id_')) {
          alert("Bảng này đang bị lỗi dữ liệu, không thể sửa.");
          return;
      }
      if (table.isSystem && !$isAdmin) {
          alert("Bạn không có quyền chỉnh sửa Bảng hệ thống.");
          return;
      }
      modalState.update(s => ({ ...s, activeModal: 'add-revenue-table-modal', payload: table }));
  }

  async function deleteTable(id) {
      if (!id || String(id).startsWith('fallback_render_id_')) {
          customRevenueTables.update(items => items.filter(t => t.id)); 
          return;
      }

      const targetTable = $customRevenueTables.find(t => t.id === id);
      if (!targetTable) return;

      if (targetTable.isSystem) {
          if ($isAdmin) {
               if (!confirm("CẢNH BÁO ADMIN: Xóa bảng HỆ THỐNG này vĩnh viễn?")) return;
              const newTables = $customRevenueTables.filter(t => t.id !== id);
              customRevenueTables.set(newTables);
              await adminService.saveSystemRevenueTables(newTables);
          } else {
              if (!confirm("Ẩn bảng này khỏi màn hình của bạn?")) return;
              customRevenueTables.update(items => items.map(t => t.id === id ? { ...t, isVisible: false } : t));
              saveHiddenPreferences();
          }
      } else {
          if (!confirm("Bạn có chắc muốn xóa bảng này? Hành động này sẽ xóa trên Cloud của kho hiện tại.")) return;
          customRevenueTables.update(items => items.filter(t => t.id !== id));
          await savePersonalTables();
      }
  }

  function openAddModal() {
      if (!$selectedWarehouse) {
          alert("Vui lòng chọn Kho trước khi tạo bảng mới.");
          return;
      }
     modalState.update(s => ({ ...s, activeModal: 'add-revenue-table-modal', payload: null }));
  }

  $: hasAnyData = reportData.length > 0;
  const colors = ['blue', 'green', 'orange', 'purple', 'teal', 'indigo', 'rose'];
  const getColor = (index) => colors[index % colors.length];
</script>

{#if isLoading}
    <div class="flex flex-col items-center justify-center p-12 text-blue-500">
        <svg class="animate-spin h-8 w-8 mb-3" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
        </svg>
        <p class="text-sm font-semibold">Đang tải cấu hình bảng...</p>
    </div>
{:else}

    {#if $customRevenueTables.length > 0}
    <div class="mb-6 flex flex-wrap items-center gap-2 bg-white p-3 rounded-xl border border-gray-200 shadow-sm">
        <div class="text-xs font-bold uppercase text-gray-500 mr-2 flex items-center gap-1">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z" /></svg>
            Bảng hiển thị:
        </div>
        {#each $customRevenueTables as table, index}
            <button 
                class="px-3 py-1.5 rounded-full text-xs font-medium border transition-all 
                    duration-200 flex items-center gap-1.5 select-none
                    {table.isVisible !== false ? 'bg-blue-600 text-white border-blue-600 shadow-md transform -translate-y-0.5' : 'bg-gray-100 text-gray-500 border-gray-200 hover:bg-gray-200'}
                    {table.isSystem ? 'border-dashed' : ''}"
                on:click={() => toggleTableVisibility(table.id || `fallback_render_id_${index}`)}
                title={table.isSystem ? "Bảng hệ thống" : "Bảng cá nhân"}
            >
                {#if table.isSystem}<span class="text-[10px] mr-0.5 opacity-70">🌐</span>{/if}
                {table.title || '(Không tên)'}
            </button>
        {/each}
        <button class="px-3 py-1.5 rounded-full text-xs font-bold border 
    border-dashed border-gray-300 text-gray-500 hover:text-blue-600 hover:border-blue-400 hover:bg-blue-50 transition-colors ml-auto flex items-center gap-1" on:click={openAddModal}>
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" /></svg>
            Tạo mới
        </button>
    </div>
    {/if}

    {#if !hasAnyData}
        <div class="p-12 text-center bg-gray-50 rounded-xl border border-gray-200 border-dashed">
            <p class="text-gray-500 font-medium">Chưa có dữ liệu báo cáo nhân viên.</p>
        </div>
    {:else if $customRevenueTables.length === 0}
        <div class="p-12 text-center bg-white rounded-xl border border-blue-100 shadow-sm flex flex-col items-center">
            <div class="w-16 h-16 bg-blue-50 rounded-full flex items-center justify-center mb-4 text-blue-500">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 
    0 01.293.707V19a2 2 0 01-2 2z" /></svg>
            </div>
            <h4 class="text-lg font-bold text-gray-800 mb-2">Chưa có Bảng báo cáo nào</h4>
            <p class="text-gray-500 mb-6 max-w-md">Bạn chưa tạo bảng theo dõi nào.</p>
            <button class="px-6 py-2.5 bg-blue-600 text-white rounded-lg font-bold hover:bg-blue-700 shadow-md flex items-center gap-2" on:click={openAddModal}>
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" /></svg>
                Tạo bảng ngay
            </button>
        </div>
    {:else if visibleTables.length === 0}
        <div class="p-12 text-center bg-gray-50 rounded-xl border border-gray-200">
            <p class="text-gray-500 font-medium">Bạn đã ẩn tất cả các bảng. Vui 
    lòng bật lại trên thanh công cụ.</p>
        </div>
    {:else}
        <div class="grid grid-cols-1 xl:grid-cols-2 gap-6 pb-10">
            {#each visibleTables as table, index (table.id)}
                <div data-capture-group="category-revenue">
                    <DynamicRevenueTable 
                        config={table}
                        {reportData}
                        colorTheme={getColor(index)}
                        on:edit={() => editTable(table)}
                        on:delete={() => deleteTable(table.id)}
                    />
                </div>
            {/each}
        </div>
    {/if}

{/if}
--- END FILE: ./src/components/health-staff/CategoryRevenueView.svelte ---

--- START FILE: ./src/components/health-staff/CompetitionTab.svelte ---
<script>
  import { onMount } from 'svelte';
  import { 
      ycxData, 
      globalCompetitionConfigs, 
      localCompetitionConfigs,
      pastedThiDuaReportData 
  } from '../../stores.js';
  import { services } from '../../services.js';

  import CompetitionModeSelector from './competition/CompetitionModeSelector.svelte';
  import ProgramView from './competition/ProgramView.svelte';
  import EmployeeView from './competition/EmployeeView.svelte';
  // [NEW] Import view chi tiết mới
  import CompetitionDetailView from './competition/CompetitionDetailView.svelte';

  // [YÊU CẦU] Mặc định vào là xem theo nhân viên
  let activeView = 'employee'; 
  let programReportData = [];
  
  // [NEW] State cho view chi tiết
  let isDetailView = false;
  let selectedEmployeeId = null;

  // Logic tính toán cho Program View (Tự động khi YCX hoặc Config thay đổi)
  $: {
      if ($ycxData.length > 0) {
          const allConfigs = [...$globalCompetitionConfigs, ...$localCompetitionConfigs];
          programReportData = services.calculateCompetitionFocusReport($ycxData, allConfigs);
      } else {
          programReportData = [];
      }
  }

  function handleViewChange(event) {
      activeView = event.detail;
      // Reset về list khi đổi tab con
      isDetailView = false;
      selectedEmployeeId = null;
  }

  // [NEW] Xử lý khi click vào nhân viên
  function handleViewDetail(event) {
      selectedEmployeeId = event.detail.employeeId;
      isDetailView = true;
  }

  // [NEW] Xử lý quay lại
  function handleBackToList() {
      isDetailView = false;
      selectedEmployeeId = null;
  }
</script>

<div class="space-y-6">
    <div class="flex flex-wrap items-center justify-between gap-4 bg-white p-4 rounded-xl border border-gray-200 shadow-sm">
        <div class="flex items-center gap-3">
            <div class="p-2 bg-purple-100 rounded-lg text-purple-600">
                <i data-feather="award" class="w-5 h-5"></i>
            </div>
            <div>
                <h3 class="text-lg font-bold text-gray-800 uppercase leading-tight">Thi Đua Lũy Kế</h3>
                <p class="text-xs text-gray-500">Theo dõi tiến độ các chương trình thi đua</p>
            </div>
        </div>
        
        <CompetitionModeSelector {activeView} on:change={handleViewChange} />
    </div>

    <div class="min-h-[400px]">
        {#if activeView === 'program'}
            <ProgramView reportData={programReportData} />
        {:else}
            {#if isDetailView && selectedEmployeeId}
                <CompetitionDetailView 
                    employeeId={selectedEmployeeId}
                    allReportData={$pastedThiDuaReportData}
                    on:back={handleBackToList}
                />
            {:else}
                <EmployeeView 
                    reportData={$pastedThiDuaReportData} 
                    on:viewChange={(e) => activeView = e.detail}
                    on:viewDetail={handleViewDetail} 
                />
            {/if}
        {/if}
    </div>
</div>
--- END FILE: ./src/components/health-staff/CompetitionTab.svelte ---

--- START FILE: ./src/components/health-staff/DynamicRevenueTable.svelte ---
<script>
  import { createEventDispatcher } from 'svelte';
  import { formatters } from '../../utils/formatters.js';
  import { isAdmin } from '../../stores.js';
  import { dynamicTableProcessor } from '../../services/processing/logic/dynamicTable.processor.js';
  
  // Import components con
  import DynamicTableHeader from './revenue/DynamicTableHeader.svelte';
  import DynamicTableRow from './revenue/DynamicTableRow.svelte';
  
  export let config;
  export let reportData = []; 
  export let colorTheme = 'blue'; 

  const dispatch = createEventDispatcher();

  let sortKey = 'mainValue'; 
  let sortDirection = 'desc';

  // [FIX] Fallback an toàn cho metrics
  $: tableMetrics = config.mainColumn?.metrics || config.tableMetrics || {
      sl: false, dt: true, dtqd: false
  };

  // 1. Xử lý dữ liệu
  $: processedResult = dynamicTableProcessor.processTableData(reportData, config);
  $: processedData = processedResult.processedData;
  $: totals = processedResult.totals;

  // 2. Sắp xếp dữ liệu
  $: sortedData = dynamicTableProcessor.sortTableData(processedData, sortKey, sortDirection);

  function handleSort(event) {
      const key = event.detail;
      if (sortKey === key) sortDirection = sortDirection === 'desc' ? 'asc' : 'desc';
      else { sortKey = key; sortDirection = 'desc'; }
  }
  
  function handleManualSort(event) {
      const key = event.detail;
      if (sortKey === key) sortDirection = sortDirection === 'desc' ? 'asc' : 'desc';
      else { sortKey = key; sortDirection = 'asc'; }
  }

  const themeMap = {
      blue: { header: 'bg-blue-50 border-blue-200', title: 'text-blue-800' },
      green: { header: 'bg-green-50 border-green-200', title: 'text-green-800' },
      orange: { header: 'bg-orange-50 border-orange-200', title: 'text-orange-800' },
      purple: { header: 'bg-purple-50 border-purple-200', title: 'text-purple-800' },
      teal: { header: 'bg-teal-50 border-teal-200', title: 'text-teal-800' },
      indigo: { header: 'bg-indigo-50 border-indigo-200', title: 'text-indigo-800' },
      rose: { header: 'bg-rose-50 border-rose-200', title: 'text-rose-800' },
  };
  $: theme = themeMap[colorTheme] || themeMap.blue;
  
  $: totalColSpan = (tableMetrics.sl ? 1 : 0) + (tableMetrics.dt ? 1 : 0) + (tableMetrics.dtqd ? 1 : 0);
</script>

<div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden h-full flex flex-col transition-all hover:shadow-md relative group/card">
    
    {#if $isAdmin || !config.isSystem}
        <div class="absolute top-3 right-3 opacity-0 group-hover/card:opacity-100 transition-opacity flex gap-1 z-10 bg-white/80 backdrop-blur rounded-lg p-1 shadow-sm border border-gray-100">
            {#if !config.isSystem}<button class="p-1.5 text-gray-400 hover:text-blue-600 rounded hover:bg-blue-50" title="Chỉnh sửa" on:click|stopPropagation={() => dispatch('edit')}><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" /></svg></button>{/if}
            <button class="p-1.5 text-gray-400 hover:text-red-600 rounded hover:bg-red-50" title={config.isSystem ? "Xóa bảng hệ thống" : "Xóa bảng"} on:click|stopPropagation={() => dispatch('delete')}><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg></button>
        </div>
    {/if}

    <div class="px-5 py-4 border-b {theme.header} flex justify-between items-center">
        <div class="flex items-center gap-3 w-full">
            <h4 class="text-lg font-bold uppercase {theme.title} truncate" title={config.title}>{config.title}</h4>
        </div>
    </div>
    
    {#if sortedData.length === 0}
        <div class="flex-grow flex items-center justify-center p-8 bg-slate-50/30">
             <p class="text-gray-400 italic text-sm">Chưa có phát sinh dữ liệu.</p>
        </div>
    {:else}
        <div class="overflow-x-auto flex-grow custom-scrollbar relative">
            <table class="min-w-full text-sm border-collapse border-0">
                
                <DynamicTableHeader 
                    {config} {tableMetrics} {totalColSpan} {sortKey} {sortDirection}
                    on:sort={handleSort}
                    on:manualSort={handleManualSort}
                />

                <tbody class="divide-y divide-gray-100">
                    {#each sortedData as item (item.maNV)}
                        <DynamicTableRow {item} {config} {tableMetrics} />
                    {/each}
                </tbody>

                <tfoot class="bg-gray-100 font-bold text-gray-800 border-t border-gray-300 sticky bottom-0 z-20">
                    <tr>
                        <td class="px-5 py-2 sticky left-0 bg-gray-200 z-30 border-r border-gray-300 shadow-[2px_0_5px_-2px_rgba(0,0,0,0.1)]">TỔNG</td>
                        
                        {#if tableMetrics.sl}
                              <td class="px-2 py-2 text-right border-r border-gray-300 bg-gray-200">
                                  {formatters.formatNumber(totals.cells?.mainValue?.value_sl || totals.mainValue_sl)}
                              </td>
                        {/if}
                        {#if tableMetrics.dt}
                             <td class="px-2 py-2 text-right border-r border-gray-300 bg-gray-200 text-blue-800">
                                 {formatters.formatRevenue(totals.cells?.mainValue?.value || totals.mainValue)}
                             </td>
                        {/if}
                        {#if tableMetrics.dtqd}
                            <td class="px-2 py-2 text-right border-r border-gray-300 bg-gray-200 text-purple-800">
                                {formatters.formatRevenue(totals.cells?.mainValue?.value_dtqd || totals.mainValue_dtqd)}
                            </td>
                        {/if}

                        {#each config.subColumns as col}
                            {@const total = totals.cells ? (totals.cells[col.id] || totals.cells[col.header]) : null}
                            {@const metrics = col.metrics || { sl: false, dt: true, dtqd: false }}
                            
                            {#if metrics.sl}
                                <td class="px-2 py-2 text-right border-r border-gray-300">{formatters.formatNumber(total?.value_sl || total?.sl)}</td>
                            {/if}
                            {#if metrics.dt}
                                <td class="px-2 py-2 text-right border-r border-gray-300 text-blue-700">{formatters.formatRevenue(total?.value || total?.dt)}</td>
                            {/if}
                            {#if metrics.dtqd}
                                <td class="px-2 py-2 text-right border-r border-gray-300 text-purple-700">{formatters.formatRevenue(total?.value_dtqd || total?.dtqd)}</td>
                            {/if}
                        {/each}
                    </tr>
                </tfoot>
            </table>
        </div>
    {/if}
</div>

<style>
    .custom-scrollbar::-webkit-scrollbar { width: 6px; height: 6px; }
    .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
    .custom-scrollbar::-webkit-scrollbar-thumb { background: #e5e7eb; border-radius: 3px; }
    .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #d1d5db; }
</style>
--- END FILE: ./src/components/health-staff/DynamicRevenueTable.svelte ---

--- START FILE: ./src/components/health-staff/EfficiencyTable.svelte ---
<script>
    import { createEventDispatcher } from 'svelte';
    import { fly } from 'svelte/transition';
    import { formatters } from '../../utils/formatters.js';
    import { efficiencyConfig } from '../../stores.js';
    
    export let data = [];
    export let isLoading = false;
    
    const dispatch = createEventDispatcher();
    
    // --- STATE ---
    let sortKey = 'doanhThu';
    let sortDirection = 'desc';
    let currentPage = 1;
    let itemsPerPage = 10;
    
    // --- CONFIG COLUMNS ---
    // [FIX] Đã xóa { id: 'pctPhuKien', ... } khỏi danh sách cứng để tránh trùng lặp
    const FIXED_COLUMNS = [
        { id: 'dtICT', label: 'DT ICT', isRate: false, headerClass: 'bg-blue-100 text-blue-900', format: 'revenue' },
        { id: 'dtPhuKien', label: 'DT Phụ kiện', isRate: false, headerClass: 'bg-blue-100 text-blue-900', format: 'revenue' },
        
        { id: 'dtCE', label: 'DT CE', isRate: false, headerClass: 'bg-green-100 text-green-900', format: 'revenue' },
        { id: 'dtGiaDung', label: 'DT Gia dụng', isRate: false, headerClass: 'bg-green-100 text-green-900', format: 'revenue' },
        
        { id: 'pctMLN', label: '% MLN', isRate: true, targetKey: 'phanTramMLN', headerClass: 'bg-green-100 text-green-900', format: 'percent' },
        { id: 'pctSim', label: '% Sim', isRate: true, targetKey: 'phanTramSim', headerClass: 'bg-yellow-100 text-yellow-900', format: 'percent' },
        { id: 'pctVAS', label: '% VAS', isRate: true, targetKey: 'phanTramVAS', headerClass: 'bg-yellow-100 text-yellow-900', format: 'percent' },
        { id: 'pctBaoHiem', label: '% Bảo hiểm', isRate: true, targetKey: 'phanTramBaoHiem', headerClass: 'bg-yellow-100 text-yellow-900', format: 'percent' }
    ];

    // Kết hợp cột cứng và cột động từ cấu hình Admin ($efficiencyConfig)
    $: columns = [
        ...FIXED_COLUMNS,
        ...($efficiencyConfig || []).map(conf => ({
            id: conf.id,
            label: conf.name,
            isRate: conf.type === 'percent',
            targetKey: conf.targetKey, // Key chứa mục tiêu (nếu có) để so sánh màu sắc
            headerClass: 'bg-indigo-50 text-indigo-900',
            format: conf.type === 'percent' ? 'percent' : 'revenue',
            isDynamic: true
        }))
    ];

    // --- SORTING ---
    function handleSort(key) {
        if (sortKey === key) {
            sortDirection = sortDirection === 'desc' ? 'asc' : 'desc';
        } else {
            sortKey = key;
            sortDirection = 'desc';
        }
    }

    $: sortedData = [...data].sort((a, b) => {
        let valA = a[sortKey] || 0;
        let valB = b[sortKey] || 0;
        return sortDirection === 'asc' ? valA - valB : valB - valA;
    });

    // --- PAGINATION ---
    $: totalPages = Math.ceil(sortedData.length / itemsPerPage);
    $: paginatedData = sortedData.slice((currentPage - 1) * itemsPerPage, currentPage * itemsPerPage);

    function goToPage(page) {
        if (page >= 1 && page <= totalPages) {
            currentPage = page;
        }
    }
    
    // --- HELPER: COLOR LOGIC ---
    function getCellColor(value, target, isRate) {
        if (!isRate || target === undefined || target === null) return 'text-gray-700';
        return value >= target ? 'text-green-600 font-bold' : 'text-red-500';
    }

    // --- HELPER: FORMAT ---
    function formatValue(value, type) {
        if (type === 'percent') return formatters.formatPercent(value);
        if (type === 'revenue') return formatters.formatRevenue(value);
        return value;
    }
</script>

<div class="bg-white border border-gray-200 rounded-xl shadow-sm overflow-hidden flex flex-col h-full">
    <div class="p-4 border-b border-gray-200 flex justify-between items-center bg-gray-50">
        <h3 class="font-bold text-gray-800 uppercase text-sm">Bảng Hiệu Quả Chi Tiết</h3>
        <div class="flex gap-2 text-xs">
            <span class="px-2 py-1 bg-green-100 text-green-700 rounded">Đạt chỉ tiêu</span>
            <span class="px-2 py-1 bg-red-100 text-red-700 rounded">Chưa đạt</span>
        </div>
    </div>

    <div class="overflow-x-auto flex-1 custom-scrollbar relative">
        {#if isLoading}
            <div class="absolute inset-0 bg-white/80 z-10 flex items-center justify-center">
                <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"></div>
            </div>
        {/if}

        <table class="min-w-full text-xs text-left border-collapse">
            <thead class="bg-gray-100 text-gray-600 font-bold sticky top-0 z-20 shadow-sm">
                <tr>
                    <th class="p-3 border-b border-r border-gray-200 min-w-[50px] text-center sticky left-0 bg-gray-100 z-30">#</th>
                    <th 
                        class="p-3 border-b border-r border-gray-200 min-w-[180px] cursor-pointer hover:bg-gray-200 sticky left-[50px] bg-gray-100 z-30 transition-colors"
                        on:click={() => handleSort('hoTen')}
                    >
                        <div class="flex items-center justify-between">
                            NHÂN VIÊN
                            {#if sortKey === 'hoTen'}
                                <span>{sortDirection === 'asc' ? '▲' : '▼'}</span>
                            {/if}
                        </div>
                    </th>
                    <th 
                        class="p-3 border-b border-r border-gray-200 min-w-[120px] cursor-pointer hover:bg-gray-200 text-right"
                        on:click={() => handleSort('doanhThu')}
                    >
                         <div class="flex items-center justify-end gap-1">
                            TỔNG DT
                            {#if sortKey === 'doanhThu'}
                                <span>{sortDirection === 'asc' ? '▲' : '▼'}</span>
                            {/if}
                        </div>
                    </th>
                    
                    {#each columns as col}
                        <th 
                            class="p-3 border-b border-r border-gray-200 min-w-[100px] cursor-pointer hover:brightness-95 transition-colors text-right whitespace-nowrap {col.headerClass}"
                            on:click={() => handleSort(col.id)}
                            title={col.label}
                        >
                            <div class="flex items-center justify-end gap-1">
                                {col.label}
                                {#if sortKey === col.id}
                                    <span>{sortDirection === 'asc' ? '▲' : '▼'}</span>
                                {/if}
                            </div>
                        </th>
                    {/each}
                </tr>
            </thead>
            
            <tbody class="divide-y divide-gray-100">
                {#each paginatedData as row, index (row.maNV)}
                    <tr class="hover:bg-blue-50 transition-colors group">
                        <td class="p-3 border-r border-gray-200 text-center text-gray-500 sticky left-0 bg-white group-hover:bg-blue-50 z-10">
                            {(currentPage - 1) * itemsPerPage + index + 1}
                        </td>
                        <td class="p-3 border-r border-gray-200 font-medium text-gray-800 sticky left-[50px] bg-white group-hover:bg-blue-50 z-10 shadow-[2px_0_5px_-2px_rgba(0,0,0,0.05)]">
                            <div class="flex flex-col">
                                <span class="truncate max-w-[160px]" title={row.hoTen}>{row.hoTen}</span>
                                <span class="text-[10px] text-gray-400 font-mono">{row.maNV}</span>
                            </div>
                        </td>
                        <td class="p-3 border-r border-gray-200 text-right font-bold text-gray-800">
                            {formatters.formatRevenue(row.doanhThu)}
                        </td>

                        {#each columns as col}
                            {@const val = row[col.id]}
                            {@const target = col.isRate && col.targetKey ? row.targets?.[col.targetKey] : undefined}
                            <td class="p-3 border-r border-gray-200 text-right {getCellColor(val, target, col.isRate)}">
                                {formatValue(val, col.format)}
                            </td>
                        {/each}
                    </tr>
                {:else}
                    <tr>
                        <td colspan={columns.length + 3} class="p-8 text-center text-gray-400 italic">
                            Không có dữ liệu hiển thị.
                        </td>
                    </tr>
                {/each}
            </tbody>
        </table>
    </div>

    {#if totalPages > 1}
    <div class="p-3 border-t border-gray-200 flex justify-between items-center bg-gray-50">
        <span class="text-xs text-gray-500">
            Hiển thị {(currentPage - 1) * itemsPerPage + 1}-{Math.min(currentPage * itemsPerPage, sortedData.length)} / {sortedData.length}
        </span>
        <div class="flex gap-1">
            <button 
                class="px-3 py-1 border rounded bg-white hover:bg-gray-100 disabled:opacity-50 text-xs font-medium"
                disabled={currentPage === 1}
                on:click={() => goToPage(currentPage - 1)}
            >
                Trước
            </button>
            {#each Array(totalPages) as _, i}
                {#if i + 1 === currentPage || i + 1 === 1 || i + 1 === totalPages || (i + 1 >= currentPage - 1 && i + 1 <= currentPage + 1)}
                    <button 
                        class="px-3 py-1 border rounded text-xs font-medium {currentPage === i + 1 ? 'bg-blue-600 text-white border-blue-600' : 'bg-white hover:bg-gray-100'}"
                        on:click={() => goToPage(i + 1)}
                    >
                        {i + 1}
                    </button>
                {:else if i + 1 === currentPage - 2 || i + 1 === currentPage + 2}
                    <span class="px-2 py-1 text-gray-400">...</span>
                {/if}
            {/each}
            <button 
                class="px-3 py-1 border rounded bg-white hover:bg-gray-100 disabled:opacity-50 text-xs font-medium"
                disabled={currentPage === totalPages}
                on:click={() => goToPage(currentPage + 1)}
            >
                Sau
            </button>
        </div>
    </div>
    {/if}
</div>

<style>
    .custom-scrollbar::-webkit-scrollbar { height: 8px; width: 8px; }
    .custom-scrollbar::-webkit-scrollbar-track { background: #f1f1f1; }
    .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
    .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
</style>
--- END FILE: ./src/components/health-staff/EfficiencyTable.svelte ---

--- START FILE: ./src/components/health-staff/EmployeeDetailModal.svelte ---
<script>
    import { createEventDispatcher } from 'svelte';
    
    // Props nhận vào từ cha
    export let isOpen = false;
    export let employeeCode = '';
    export let employeeName = '';
    export let employeeDept = '';
    export let rawData = []; // Dữ liệu gốc (reportData) để lọc

    const dispatch = createEventDispatcher();

    // Biến nội bộ
    let history = [];
    let summary = {
        totalErrors: 0,
        totalDeducted: 0,
        totalBonus: 0,
        finalScore: 100 // Giả sử điểm gốc là 100, hoặc tính theo logic dự án
    };

    // Reactive: Khi employeeCode hoặc rawData thay đổi, tính toán lại
    $: if (isOpen && employeeCode && rawData.length > 0) {
        analyzeEmployeeData();
    }

    function analyzeEmployeeData() {
        // 1. Lọc dữ liệu của nhân viên này
        const records = rawData.filter(item => item.maNV === employeeCode);

        // 2. Sắp xếp theo ngày mới nhất -> cũ nhất
        history = records.sort((a, b) => {
            const dateA = new Date(a.ngayViPham.split('/').reverse().join('-'));
            const dateB = new Date(b.ngayViPham.split('/').reverse().join('-'));
            return dateB - dateA;
        });

        // 3. Tính toán tổng hợp
        let errors = 0;
        let deducted = 0;
        let bonus = 0;

        history.forEach(item => {
            const point = parseFloat(item.diemTru) || 0;
            if (point < 0) {
                // Điểm âm là điểm trừ (tuỳ quy ước data gốc của bạn, ở đây giả sử < 0 là trừ)
                // Hoặc nếu data gốc lưu số dương cho cột điểm trừ:
                // Cần check logic gốc. Thường là cột 'diemTru' lưu số điểm bị trừ.
                // Ở đây tôi giả định theo logic thông thường:
                
                // Nếu item.loai === 'Điểm cộng' hoặc diemTru > 0 trong ngữ cảnh cộng...
                // Dựa vào file gốc: thường có phân loại hoặc check dấu
            }
            
            // Logic bám sát dự án gốc: 
            // Dự án gốc thường cộng dồn điểm. Giả sử diemTru là số điểm tác động.
            if (item.loaiViPham === 'Điểm cộng' || (item.ghiChu && item.ghiChu.includes('Điểm cộng'))) {
                 bonus += Math.abs(point);
            } else {
                 errors++;
                 deducted += Math.abs(point);
            }
        });

        summary = {
            totalErrors: errors,
            totalDeducted: deducted,
            totalBonus: bonus,
            finalScore: 100 - deducted + bonus // Công thức ví dụ
        };
    }

    function close() {
        dispatch('close');
    }
</script>

{#if isOpen}
    <div class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4" on:click={close}>
        <div class="bg-white rounded-lg shadow-xl w-full max-w-4xl max-h-[90vh] flex flex-col overflow-hidden" on:click|stopPropagation>
            
            <div class="bg-blue-600 text-white p-4 flex justify-between items-center">
                <div>
                    <h3 class="text-xl font-bold uppercase">Chi tiết thi đua: {employeeName}</h3>
                    <p class="text-sm opacity-90">{employeeCode} - {employeeDept}</p>
                </div>
                <button on:click={close} class="text-white hover:text-gray-200">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>

            <div class="p-4 bg-gray-50 border-b flex flex-wrap gap-4 justify-around text-center">
                <div class="bg-white p-3 rounded shadow-sm border border-gray-200 min-w-[150px]">
                    <span class="block text-gray-500 text-xs uppercase">Số lỗi vi phạm</span>
                    <span class="block text-2xl font-bold text-red-500">{summary.totalErrors}</span>
                </div>
                <div class="bg-white p-3 rounded shadow-sm border border-gray-200 min-w-[150px]">
                    <span class="block text-gray-500 text-xs uppercase">Tổng điểm trừ</span>
                    <span class="block text-2xl font-bold text-red-600">-{summary.totalDeducted}</span>
                </div>
                <div class="bg-white p-3 rounded shadow-sm border border-gray-200 min-w-[150px]">
                    <span class="block text-gray-500 text-xs uppercase">Tổng điểm cộng</span>
                    <span class="block text-2xl font-bold text-green-600">+{summary.totalBonus}</span>
                </div>
                 </div>

            <div class="flex-1 overflow-y-auto p-4">
                {#if history.length === 0}
                    <div class="text-center text-gray-500 py-10">Nhân viên này chưa có ghi nhận thi đua nào.</div>
                {:else}
                    <table class="min-w-full text-sm border-collapse border border-gray-200">
                        <thead class="bg-gray-100 sticky top-0 shadow-sm">
                            <tr>
                                <th class="border p-2 text-left">Ngày</th>
                                <th class="border p-2 text-left">Loại/Vi phạm</th>
                                <th class="border p-2 text-left">Nội dung chi tiết</th>
                                <th class="border p-2 text-center text-nowrap">Điểm</th>
                            </tr>
                        </thead>
                        <tbody>
                            {#each history as item}
                                <tr class="hover:bg-gray-50">
                                    <td class="border p-2 whitespace-nowrap">{item.ngayViPham}</td>
                                    <td class="border p-2 font-medium">
                                        {#if item.loaiViPham === 'Điểm cộng'}
                                            <span class="text-green-600">Điểm cộng</span>
                                        {:else}
                                            <span class="text-red-600">{item.loaiViPham || 'Vi phạm'}</span>
                                        {/if}
                                    </td>
                                    <td class="border p-2">{item.noiDung || item.tenLoi}</td>
                                    <td class="border p-2 text-center font-bold" 
                                        class:text-red-600={parseFloat(item.diemTru) < 0 || (item.loaiViPham !== 'Điểm cộng')}
                                        class:text-green-600={item.loaiViPham === 'Điểm cộng'}
                                    >
                                        {item.diemTru}
                                    </td>
                                </tr>
                            {/each}
                        </tbody>
                    </table>
                {/if}
            </div>

            <div class="p-4 border-t bg-gray-50 text-right">
                <button on:click={close} class="px-4 py-2 bg-gray-200 hover:bg-gray-300 rounded text-gray-700 font-medium">
                    Đóng
                </button>
            </div>
        </div>
    </div>
{/if}
--- END FILE: ./src/components/health-staff/EmployeeDetailModal.svelte ---

--- START FILE: ./src/components/health-staff/IncomeTable.svelte ---
<script>
  import { formatters } from '../../utils/formatters.js';
  
  export let reportData = [];

  let sortKey = 'tongThuNhap';
  let sortDirection = 'desc';

  // Cấu hình cột
  const columns = [
      { key: 'hoTen', label: 'Nhân viên', align: 'left' },
      { key: 'gioCong', label: 'Giờ công', align: 'right' },
      { key: 'tongThuNhap', label: 'Tổng Thu Nhập', align: 'right' },
      { key: 'thuNhapDuKien', label: 'Thu nhập DK', align: 'right' },
      { key: 'thuNhapThangTruoc', label: 'Tháng trước', align: 'right' },
      { key: 'chenhLechThuNhap', label: '+/- Tháng trước', align: 'right' }
  ];

  function handleSort(key) {
      if (sortKey === key) {
          sortDirection = sortDirection === 'desc' ? 'asc' : 'desc';
      } else {
          sortKey = key;
          sortDirection = 'desc';
      }
  }

  // Logic sắp xếp
  $: sortedData = [...reportData].sort((a, b) => {
      let valA = a[sortKey];
      let valB = b[sortKey];

      if (sortKey === 'hoTen') {
          return sortDirection === 'asc' ? String(valA).localeCompare(String(valB)) : String(valB).localeCompare(String(valA));
      }
      // Xử lý số
      return sortDirection === 'asc' ? (Number(valA)||0) - (Number(valB)||0) : (Number(valB)||0) - (Number(valA)||0);
  });

  // Tính tổng
  $: totals = reportData.reduce((acc, item) => {
      acc.gioCong += item.gioCong || 0;
      acc.tongThuNhap += item.tongThuNhap || 0;
      acc.thuNhapDuKien += item.thuNhapDuKien || 0;
      acc.thuNhapThangTruoc += item.thuNhapThangTruoc || 0;
      acc.chenhLechThuNhap += item.chenhLechThuNhap || 0;
      return acc;
  }, { gioCong: 0, tongThuNhap: 0, thuNhapDuKien: 0, thuNhapThangTruoc: 0, chenhLechThuNhap: 0 });

  // Tính trung bình Thu nhập dự kiến để so sánh
  $: avgIncome = reportData.length > 0 ? totals.thuNhapDuKien / reportData.length : 0;

  // Hàm style cho ô dữ liệu
  function getCellClass(item, colKey) {
      if (colKey === 'tongThuNhap') return 'font-bold text-blue-700';
      
      if (colKey === 'thuNhapDuKien') {
          // Dưới trung bình thì màu đỏ, trên thì xanh
          return item.thuNhapDuKien < avgIncome 
              ? 'font-bold text-red-600 bg-red-50' 
              : 'font-bold text-green-700 bg-green-50';
      }

      if (colKey === 'chenhLechThuNhap') {
          return item.chenhLechThuNhap >= 0 
              ? 'font-bold text-green-600' 
              : 'font-bold text-red-600';
      }

      return 'text-gray-700';
  }
</script>

<div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden mt-4 animate-fade-in">
    <div class="px-6 py-4 border-b border-gray-200 flex justify-between items-center bg-orange-50">
        <div class="flex items-center gap-2">
            <div class="p-2 bg-orange-100 rounded-lg text-orange-600">
                <i data-feather="briefcase" class="w-5 h-5"></i>
            </div>
            <div>
                <h3 class="font-bold text-gray-800 text-lg uppercase">Bảng Lương & Thu Nhập</h3>
                <p class="text-xs text-gray-500">
                    Thu nhập DK TB: <span class="font-bold text-orange-600">{formatters.formatRevenue(avgIncome)}</span>
                </p>
            </div>
        </div>
        <span class="text-xs font-bold bg-orange-100 text-orange-700 px-3 py-1 rounded-full shadow-sm">Đơn vị: VNĐ</span>
    </div>

    <div class="overflow-x-auto">
        <table class="min-w-full text-sm text-left border-collapse">
            <thead class="bg-gray-100 text-xs uppercase text-gray-500 font-bold sticky top-0 z-10 shadow-sm">
                <tr>
                    {#each columns as col}
                        <th 
                            class="px-4 py-3 cursor-pointer hover:bg-gray-200 transition select-none whitespace-nowrap {col.align === 'right' ? 'text-right' : 'text-left'}"
                            on:click={() => handleSort(col.key)}
                        >
                            <div class="flex items-center gap-1 {col.align === 'right' ? 'justify-end' : ''}">
                                {col.label}
                                {#if sortKey === col.key}
                                    <span class="ml-1 text-orange-600">{sortDirection === 'asc' ? '▲' : '▼'}</span>
                                {/if}
                            </div>
                        </th>
                    {/each}
                </tr>
            </thead>
            <tbody class="divide-y divide-gray-100">
                {#if sortedData.length === 0}
                    <tr><td colspan={columns.length} class="p-12 text-center text-gray-400 italic bg-gray-50">Chưa có dữ liệu. Vui lòng tải file Thưởng/Giờ công.</td></tr>
                {:else}
                    {#each sortedData as item, index (item.maNV)}
                        <tr class="hover:bg-orange-50 transition-colors duration-150 group {index % 2 === 0 ? 'bg-white' : 'bg-slate-50/50'}">
                            <td class="px-4 py-3 font-semibold text-gray-700 whitespace-nowrap border-r border-gray-100 group-hover:text-orange-800">
                                {formatters.getShortEmployeeName(item.hoTen, item.maNV)}
                            </td>
                            <td class="px-4 py-3 text-right border-r border-gray-100 font-medium">
                                {formatters.formatNumberOrDash(item.gioCong)}
                            </td>
                            <td class="px-4 py-3 text-right {getCellClass(item, 'tongThuNhap')}">
                                {formatters.formatRevenue(item.tongThuNhap)}
                            </td>
                            <td class="px-4 py-3 text-right {getCellClass(item, 'thuNhapDuKien')}">
                                {formatters.formatRevenue(item.thuNhapDuKien)}
                            </td>
                            <td class="px-4 py-3 text-right text-gray-600 font-medium">
                                {formatters.formatRevenue(item.thuNhapThangTruoc)}
                            </td>
                            <td class="px-4 py-3 text-right border-l border-gray-100 {getCellClass(item, 'chenhLechThuNhap')}">
                                {formatters.formatRevenue(item.chenhLechThuNhap)}
                            </td>
                        </tr>
                    {/each}
                {/if}
            </tbody>
            <tfoot class="bg-gray-100 font-bold text-gray-900 border-t-2 border-gray-300 text-xs uppercase">
                <tr>
                    <td class="px-4 py-3">TỔNG CỘNG</td>
                    <td class="px-4 py-3 text-right">{formatters.formatNumberOrDash(totals.gioCong)}</td>
                    <td class="px-4 py-3 text-right text-blue-700">{formatters.formatRevenue(totals.tongThuNhap)}</td>
                    <td class="px-4 py-3 text-right text-green-700">{formatters.formatRevenue(totals.thuNhapDuKien)}</td>
                    <td class="px-4 py-3 text-right">{formatters.formatRevenue(totals.thuNhapThangTruoc)}</td>
                    <td class="px-4 py-3 text-right">{formatters.formatRevenue(totals.chenhLechThuNhap)}</td>
                </tr>
            </tfoot>
        </table>
    </div>
</div>

<style>
    .animate-fade-in { animation: fadeIn 0.4s ease-out; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
</style>
--- END FILE: ./src/components/health-staff/IncomeTable.svelte ---

--- START FILE: ./src/components/health-staff/RevenueTable.svelte ---
<script>
  import { createEventDispatcher } from 'svelte';
  import { formatters } from '../../utils/formatters.js';
  
  export let reportData = [];

  const dispatch = createEventDispatcher();
  let sortKey = 'doanhThu';
  let sortDirection = 'desc';

  // [CẤU HÌNH] Giữ nguyên
  const columns = [
      { key: 'hoTen', label: 'Nhân viên', align: 'left', headerClass: 'bg-gray-100 text-gray-700' },
      { key: 'doanhThu', label: 'DT Thực', align: 'right', headerClass: 'bg-blue-100 text-blue-800 border-l border-blue-200' },
      { key: 'doanhThuQuyDoi', label: 'DT Quy Đổi', align: 'right', headerClass: 'bg-blue-100 text-blue-800' },
      { key: 'hieuQuaQuyDoi', label: '% QĐ', align: 'right', headerClass: 'bg-blue-100 text-blue-800' },
      { key: 'doanhThuTraGop', label: 'DT Trả chậm', align: 'right', headerClass: 'bg-green-100 text-green-800 border-l border-green-200' },
      { key: 'tyLeTraCham', label: '% Trả chậm', align: 'right', headerClass: 'bg-green-100 text-green-800' },
      { key: 'doanhThuChuaXuat', label: 'DT Chưa Xuất', align: 'right', headerClass: 'bg-yellow-50 text-yellow-800 border-l border-yellow-200' }
  ];

  function handleSort(key) {
      if (sortKey === key) sortDirection = sortDirection === 'desc' ? 'asc' : 'desc';
      else { sortKey = key; sortDirection = 'desc'; }
  }

  $: sortedData = [...reportData].sort((a, b) => {
      let valA = a[sortKey];
      let valB = b[sortKey];
      if (sortKey === 'hoTen') return sortDirection === 'asc' ? String(valA).localeCompare(String(valB)) : String(valB).localeCompare(String(valA));
      return sortDirection === 'asc' ? (Number(valA)||0) - (Number(valB)||0) : (Number(valB)||0) - (Number(valA)||0);
  });

  $: totals = reportData.reduce((acc, item) => {
      acc.doanhThu += item.doanhThu || 0;
      acc.doanhThuQuyDoi += item.doanhThuQuyDoi || 0;
      acc.doanhThuTraGop += item.doanhThuTraGop || 0;
      acc.doanhThuChuaXuat += item.doanhThuChuaXuat || 0;
      return acc;
  }, { doanhThu: 0, doanhThuQuyDoi: 0, doanhThuTraGop: 0, doanhThuChuaXuat: 0 });

  $: totalPctQD = totals.doanhThu > 0 ? (totals.doanhThuQuyDoi / totals.doanhThu) - 1 : 0;
  $: totalPctTC = totals.doanhThu > 0 ? totals.doanhThuTraGop / totals.doanhThu : 0;

  // [FIX] Logic tô màu
  function getCellClass(item, colKey) {
      if (['doanhThu', 'doanhThuQuyDoi', 'doanhThuTraGop', 'doanhThuChuaXuat'].includes(colKey)) {
          return 'font-bold text-gray-800';
      }

      if (!item.mucTieu) return 'text-gray-600'; // Nếu không có mục tiêu thì không tô màu

      if (colKey === 'hieuQuaQuyDoi') {
          // Target %Quy Đổi (VD: 80%)
          const target = (item.mucTieu.phanTramQD || 0) / 100;
          if (target === 0) return 'text-blue-800 font-bold';
          return item.hieuQuaQuyDoi >= target 
              ? 'text-green-600 font-extrabold bg-green-50' // Đạt
              : 'text-red-600 font-bold bg-red-50';        // Không đạt
      }
      
      if (colKey === 'tyLeTraCham') {
          // Target % Trả chậm
          const target = (item.mucTieu.phanTramTC || 0) / 100;
          if (target === 0) return 'text-green-800 font-bold';
          return item.tyLeTraCham >= target 
              ? 'text-green-600 font-extrabold bg-green-50' 
              : 'text-red-600 font-bold bg-red-50';
      }
      return 'text-gray-600';
  }

  function handleRowClick(employeeId) { dispatch('viewDetail', { employeeId }); }
</script>

<div class="bg-white rounded-xl shadow-md border border-gray-200 overflow-hidden mt-6 animate-fade-in">
    <div class="px-6 py-4 border-b border-gray-200 flex justify-between items-center bg-gray-50">
        <div class="flex items-center gap-2">
            <div class="p-2 bg-blue-100 rounded-lg text-blue-600"><i data-feather="dollar-sign" class="w-5 h-5"></i></div>
            <div>
                <h3 class="font-bold text-gray-800 text-lg uppercase">Chi tiết Doanh Thu Lũy Kế</h3>
                <p class="text-xs text-gray-500">Dữ liệu được cập nhật từ file YCX mới nhất</p>
            </div>
        </div>
        <span class="text-xs font-bold bg-blue-100 text-blue-700 px-3 py-1 rounded-full shadow-sm">Đơn vị: VNĐ</span>
    </div>

    <div class="overflow-x-auto">
        <table class="min-w-full text-sm text-left border-collapse">
            <thead class="uppercase text-xs font-bold sticky top-0 z-10 shadow-sm">
                <tr>
                    {#each columns as col}
                        <th class="px-4 py-3 cursor-pointer transition select-none whitespace-nowrap {col.headerClass} {col.align === 'right' ? 'text-right' : 'text-left'}" on:click={() => handleSort(col.key)}>
                            <div class="flex items-center gap-1 {col.align === 'right' ? 'justify-end' : ''}">
                                {col.label}
                                {#if sortKey === col.key}<span class="ml-1 text-blue-600">{sortDirection === 'asc' ? '▲' : '▼'}</span>{/if}
                            </div>
                        </th>
                    {/each}
                </tr>
            </thead>
            <tbody class="divide-y divide-gray-100">
                {#if sortedData.length === 0}
                    <tr><td colspan={columns.length} class="p-12 text-center text-gray-400 italic bg-gray-50">Chưa có dữ liệu hiển thị.</td></tr>
                {:else}
                    {#each sortedData as item, index (item.maNV)}
                        <tr class="hover:bg-blue-50 transition-colors duration-150 group cursor-pointer {index % 2 === 0 ? 'bg-white' : 'bg-slate-50/50'}" on:click={() => handleRowClick(item.maNV)}>
                            <td class="px-4 py-3 font-semibold text-blue-700 whitespace-nowrap border-r border-gray-100 group-hover:text-blue-800 group-hover:underline">
                                {formatters.getShortEmployeeName(item.hoTen, item.maNV)}
                            </td>
                            <td class="px-4 py-3 text-right border-r border-gray-100 {getCellClass(item, 'doanhThu')}">{formatters.formatRevenue(item.doanhThu)}</td>
                            <td class="px-4 py-3 text-right {getCellClass(item, 'doanhThuQuyDoi')}">{formatters.formatRevenue(item.doanhThuQuyDoi)}</td>
                            <td class="px-4 py-3 text-right {getCellClass(item, 'hieuQuaQuyDoi')}">{formatters.formatPercentage(item.hieuQuaQuyDoi)}</td>
                            <td class="px-4 py-3 text-right border-l border-gray-100 {getCellClass(item, 'doanhThuTraGop')}">{formatters.formatRevenue(item.doanhThuTraGop)}</td>
                            <td class="px-4 py-3 text-right {getCellClass(item, 'tyLeTraCham')}">{formatters.formatPercentage(item.tyLeTraCham)}</td>
                            <td class="px-4 py-3 text-right border-l border-gray-100 text-gray-500 font-medium">{formatters.formatRevenue(item.doanhThuChuaXuat)}</td>
                        </tr>
                    {/each}
                {/if}
            </tbody>
            <tfoot class="bg-gray-100 font-bold text-gray-900 border-t-2 border-gray-300 text-xs uppercase">
                <tr>
                    <td class="px-4 py-3">TỔNG CỘNG</td>
                    <td class="px-4 py-3 text-right text-base">{formatters.formatRevenue(totals.doanhThu)}</td>
                    <td class="px-4 py-3 text-right text-base text-blue-700">{formatters.formatRevenue(totals.doanhThuQuyDoi)}</td>
                    <td class="px-4 py-3 text-right text-base text-blue-700">{formatters.formatPercentage(totalPctQD)}</td>
                    <td class="px-4 py-3 text-right text-base">{formatters.formatRevenue(totals.doanhThuTraGop)}</td>
                    <td class="px-4 py-3 text-right text-base">{formatters.formatPercentage(totalPctTC)}</td>
                    <td class="px-4 py-3 text-right text-base text-gray-600">{formatters.formatRevenue(totals.doanhThuChuaXuat)}</td>
                </tr>
            </tfoot>
        </table>
    </div>
</div>
<style>.animate-fade-in { animation: fadeIn 0.4s ease-out; } @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }</style>
--- END FILE: ./src/components/health-staff/RevenueTable.svelte ---

--- START FILE: ./src/components/health-staff/competition/CompetitionCard.svelte ---
<script>
  import { formatters } from '../../../utils/formatters.js';
  
  export let item; // Dữ liệu của 1 chương trình
  
  // Tính toán logic hiển thị
  $: hoanThanhValue = item.hoanThanhValue || 0;
  $: isCompleted = hoanThanhValue >= 100;
  $: progressColor = isCompleted ? 'bg-blue-600' : 'bg-yellow-400';
  
  // Tính mục tiêu ngày (nếu chưa đạt)
  $: targetRemaining = (item.target || 0) - (item.luyKe || 0);
  $: daysLeft = Math.max(30 - (new Date().getDate()), 1);
  $: dailyTarget = (item.target > 0 && targetRemaining > 0) ? (targetRemaining / daysLeft) : 0;
</script>

<div class="bg-white border border-gray-200 rounded-lg p-3 shadow-sm hover:shadow-md transition-all hover:-translate-y-0.5">
    <p class="font-semibold text-gray-800 mb-2 text-sm line-clamp-2 h-10" title={item.name}>
        {item.name}
    </p>
    
    <div class="w-full bg-gray-200 rounded-full h-3 overflow-hidden mb-2 relative">
        <div 
            class="h-full rounded-full transition-all duration-500 {progressColor}" 
            style="width: {Math.min(hoanThanhValue, 100)}%;"
        ></div>
        <span class="absolute inset-0 flex items-center justify-center text-[10px] font-bold text-gray-700 drop-shadow-md">
            {formatters.formatPercentage(hoanThanhValue / 100)}
        </span>
    </div>

    <div class="flex justify-between items-end text-xs text-gray-600">
        <div>
            <div class="flex flex-col">
                <span>Lũy kế: <strong>{formatters.formatNumberOrDash(item.luyKe)}</strong></span>
                <span>Target: <strong>{formatters.formatNumberOrDash(item.target)}</strong></span>
            </div>
        </div>
        
        {#if isCompleted}
            <span class="font-bold text-green-600 bg-green-50 px-2 py-1 rounded">Đạt</span>
        {:else}
            <div class="text-right">
                <span class="block text-gray-400">Cần/ngày:</span>
                <strong class="text-red-600">{formatters.formatNumberOrDash(dailyTarget)}</strong>
            </div>
        {/if}
    </div>
</div>
--- END FILE: ./src/components/health-staff/competition/CompetitionCard.svelte ---

--- START FILE: ./src/components/health-staff/competition/CompetitionDetailView.svelte ---
<script>
    import { createEventDispatcher, afterUpdate } from 'svelte'; // [QUAN TRỌNG] Thêm afterUpdate
    import { formatters } from '../../../utils/formatters.js';
    import { competitionNameMappings } from '../../../stores.js';
    import { settingsService } from '../../../services/settings.service.js';

    export let employeeId;
    export let allReportData = []; 

    const dispatch = createEventDispatcher();

    // --- LOGIC TÍNH TOÁN ---
    let employee = null;
    let stats = {
        dat: [],
        ganDat: [],
        canCoGang: [],
        summary: { total: 0, dat: 0, rate: 0, ganDat: 0, canCoGang: 0 }
    };

    $: {
        if (employeeId && allReportData.length > 0) {
            employee = allReportData.find(e => e.maNV === employeeId);

            if (employee) {
                // Lấy cấu hình tên cột hiển thị
                let columnSettings = settingsService.loadPastedCompetitionViewSettings();
                if (!columnSettings || columnSettings.length === 0) {
                     columnSettings = settingsService.loadPastedCompetitionViewSettings(); 
                }
                
                const activeColumns = columnSettings
                    .filter(col => col.visible)
                    .map(col => ({
                        ...col,
                        label: $competitionNameMappings[col.tenGoc] || col.label || col.tenGoc
                    }));

                // Tính Trung bình bộ phận
                const deptEmployees = allReportData.filter(e => e.boPhan === employee.boPhan);
                const deptAvgs = {};
                
                activeColumns.forEach(col => {
                    let sum = 0;
                    let count = 0;
                    deptEmployees.forEach(e => {
                        const comp = e.competitions.find(c => c.tenGoc === col.tenGoc);
                        if (comp && comp.giaTri > 0) {
                            sum += comp.giaTri;
                            count++;
                        }
                    });
                    deptAvgs[col.tenGoc] = count > 0 ? sum / count : 0;
                });

                // Phân loại chỉ số
                let datList = [], ganDatList = [], canCoGangList = [];

                activeColumns.forEach(col => {
                    const compData = employee.competitions.find(c => c.tenGoc === col.tenGoc);
                    const val = compData ? compData.giaTri : 0;
                    const avg = deptAvgs[col.tenGoc] || 0;
                    
                    if (avg > 0 || val > 0) {
                        const item = {
                            name: col.label,
                            value: val,
                            avg: avg,
                            diff: val - avg,
                            percentOfAvg: avg > 0 ? (val / avg) * 100 : 0
                        };

                        if (val >= avg) {
                            datList.push(item);
                        } else if (item.percentOfAvg >= 70) {
                            ganDatList.push(item);
                        } else {
                            canCoGangList.push(item);
                        }
                    }
                });

                stats = {
                    dat: datList.sort((a,b) => b.percentOfAvg - a.percentOfAvg),
                    ganDat: ganDatList.sort((a,b) => b.percentOfAvg - a.percentOfAvg),
                    canCoGang: canCoGangList.sort((a,b) => a.percentOfAvg - b.percentOfAvg),
                    summary: {
                        total: datList.length + ganDatList.length + canCoGangList.length,
                        dat: datList.length,
                        ganDat: ganDatList.length,
                        canCoGang: canCoGangList.length,
                        rate: 0
                    }
                };
                stats.summary.rate = stats.summary.total > 0 
                    ? (stats.summary.dat / stats.summary.total) * 100 
                    : 0;
            }
        }
    }

    function goBack() {
        dispatch('back');
    }

    // [QUAN TRỌNG] Kích hoạt icon sau khi render
    afterUpdate(() => {
        if (typeof feather !== 'undefined') feather.replace();
    });
</script>

<div class="animate-fade-in pb-10 bg-gray-50 min-h-screen p-4 sm:p-6">
    <button on:click={goBack} class="mb-4 flex items-center gap-2 text-gray-500 hover:text-blue-600 transition-colors font-semibold">
        <i data-feather="arrow-left" class="w-5 h-5"></i> Quay lại bảng tổng hợp
    </button>

    {#if employee}
        <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-5 mb-6 flex items-center gap-5">
            <div class="w-16 h-16 rounded-full bg-gray-100 flex items-center justify-center text-gray-500 border border-gray-200 shadow-inner">
                <i data-feather="user" class="w-8 h-8"></i>
            </div>
            <div>
                <h2 class="text-2xl font-bold text-gray-800">{employee.hoTen} <span class="text-gray-400 font-medium text-lg">- {employee.maNV}</span></h2>
                <span class="inline-block mt-1 px-3 py-1 rounded-full bg-blue-50 text-blue-700 text-xs font-bold border border-blue-100">
                    {employee.boPhan}
                </span>
            </div>
        </div>

        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 mb-8">
            <div class="bg-white p-4 rounded-xl border border-gray-200 shadow-sm text-center">
                <p class="text-xs font-bold text-gray-500 uppercase mb-1">Ngành hàng Đạt</p>
                <p class="text-3xl font-extrabold text-gray-800">
                    <span class="text-blue-600">{stats.summary.dat}</span>
                    <span class="text-gray-300 text-xl">/ {stats.summary.total}</span>
                </p>
            </div>

            <div class="bg-white p-4 rounded-xl border border-gray-200 shadow-sm text-center">
                <p class="text-xs font-bold text-gray-500 uppercase mb-1">Tỷ lệ đạt (trên nhóm có TB)</p>
                <p class="text-3xl font-extrabold text-red-500">
                    {formatters.formatNumber(stats.summary.rate, 0)}%
                </p>
            </div>

            <div class="bg-white p-4 rounded-xl border border-gray-200 shadow-sm text-center">
                <p class="text-xs font-bold text-gray-500 uppercase mb-1">Gần Đạt (>=70%)</p>
                <p class="text-3xl font-extrabold text-yellow-500">{stats.summary.ganDat}</p>
            </div>

            <div class="bg-white p-4 rounded-xl border border-gray-200 shadow-sm text-center">
                <p class="text-xs font-bold text-gray-500 uppercase mb-1">Cần Cố Gắng</p>
                <p class="text-3xl font-extrabold text-red-600">{stats.summary.canCoGang}</p>
            </div>
        </div>

        <div class="space-y-8">
            
            <div class="bg-blue-50/50 rounded-xl border border-blue-100 overflow-hidden">
                <div class="px-5 py-3 bg-blue-100/50 border-b border-blue-200 flex items-center gap-2">
                    <i data-feather="check-circle" class="w-5 h-5 text-blue-600"></i>
                    <h3 class="font-bold text-blue-800 uppercase text-lg">Nhóm Đạt ({stats.dat.length})</h3>
                </div>
                <div class="p-5 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                    {#each stats.dat as item}
                        <div class="bg-white p-4 rounded-lg border border-blue-100 shadow-sm hover:shadow-md transition-shadow">
                            <h4 class="font-bold text-gray-800 mb-2 truncate" title={item.name}>{item.name}</h4>
                            <div class="w-full bg-gray-100 rounded-full h-2 mb-3">
                                <div class="bg-blue-500 h-2 rounded-full" style="width: 100%"></div>
                            </div>
                            <div class="text-xs space-y-1">
                                <div class="flex justify-between">
                                    <span class="text-gray-500">Thực hiện:</span>
                                    <span class="font-bold text-gray-800">{formatters.formatNumber(item.value)}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-500">TB Bộ phận:</span>
                                    <span class="font-bold text-gray-800">{formatters.formatNumber(item.avg)}</span>
                                </div>
                                <div class="flex justify-between border-t border-dashed border-gray-200 pt-1 mt-1">
                                    <span class="text-gray-500">Chênh lệch:</span>
                                    <span class="font-bold text-green-600">+{formatters.formatNumber(item.diff)}</span>
                                </div>
                            </div>
                        </div>
                    {/each}
                    {#if stats.dat.length === 0}
                        <p class="text-sm text-gray-400 italic col-span-full text-center py-4">Không có ngành hàng nào đạt.</p>
                    {/if}
                </div>
            </div>

            <div class="bg-yellow-50/50 rounded-xl border border-yellow-100 overflow-hidden">
                <div class="px-5 py-3 bg-yellow-100/50 border-b border-yellow-200 flex items-center gap-2">
                    <i data-feather="trending-up" class="w-5 h-5 text-yellow-600"></i>
                    <h3 class="font-bold text-yellow-800 uppercase text-lg">Nhóm Gần Đạt ({stats.ganDat.length})</h3>
                </div>
                <div class="p-5 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                    {#each stats.ganDat as item}
                        <div class="bg-white p-4 rounded-lg border border-yellow-100 shadow-sm hover:shadow-md transition-shadow">
                            <h4 class="font-bold text-gray-800 mb-2 truncate" title={item.name}>{item.name}</h4>
                            <div class="w-full bg-gray-100 rounded-full h-2 mb-3">
                                <div class="bg-yellow-400 h-2 rounded-full" style="width: {item.percentOfAvg}%"></div>
                            </div>
                            <div class="text-xs space-y-1">
                                <div class="flex justify-between">
                                    <span class="text-gray-500">Thực hiện:</span>
                                    <span class="font-bold text-gray-800">{formatters.formatNumber(item.value)}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-500">TB Bộ phận:</span>
                                    <span class="font-bold text-gray-800">{formatters.formatNumber(item.avg)}</span>
                                </div>
                                <div class="flex justify-between border-t border-dashed border-gray-200 pt-1 mt-1">
                                    <span class="text-gray-500">Chênh lệch:</span>
                                    <span class="font-bold text-red-500">{formatters.formatNumber(item.diff)}</span>
                                </div>
                            </div>
                        </div>
                    {/each}
                    {#if stats.ganDat.length === 0}
                        <p class="text-sm text-gray-400 italic col-span-full text-center py-4">Không có ngành hàng nào.</p>
                    {/if}
                </div>
            </div>

            <div class="bg-red-50/50 rounded-xl border border-red-100 overflow-hidden">
                <div class="px-5 py-3 bg-red-100/50 border-b border-red-200 flex items-center gap-2">
                    <i data-feather="alert-circle" class="w-5 h-5 text-red-600"></i>
                    <h3 class="font-bold text-red-800 uppercase text-lg">Nhóm Cần Cố Gắng ({stats.canCoGang.length})</h3>
                </div>
                <div class="p-5 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                    {#each stats.canCoGang as item}
                        <div class="bg-white p-4 rounded-lg border border-red-100 shadow-sm hover:shadow-md transition-shadow">
                            <h4 class="font-bold text-gray-800 mb-2 truncate" title={item.name}>{item.name}</h4>
                            <div class="w-full bg-gray-100 rounded-full h-2 mb-3">
                                <div class="bg-red-400 h-2 rounded-full" style="width: {Math.max(item.percentOfAvg, 5)}%"></div>
                            </div>
                            <div class="text-xs space-y-1">
                                <div class="flex justify-between">
                                    <span class="text-gray-500">Thực hiện:</span>
                                    <span class="font-bold text-gray-800">{formatters.formatNumber(item.value)}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-500">TB Bộ phận:</span>
                                    <span class="font-bold text-gray-800">{formatters.formatNumber(item.avg)}</span>
                                </div>
                                <div class="flex justify-between border-t border-dashed border-gray-200 pt-1 mt-1">
                                    <span class="text-gray-500">Chênh lệch:</span>
                                    <span class="font-bold text-red-600">{formatters.formatNumber(item.diff)}</span>
                                </div>
                            </div>
                        </div>
                    {/each}
                    {#if stats.canCoGang.length === 0}
                        <p class="text-sm text-gray-400 italic col-span-full text-center py-4">Tuyệt vời! Không có ngành hàng yếu kém.</p>
                    {/if}
                </div>
            </div>

        </div>

    {:else}
        <div class="p-10 text-center">
            <p class="text-gray-500">Đang tải dữ liệu chi tiết...</p>
        </div>
    {/if}
</div>

<style>
    .animate-fade-in { animation: fadeIn 0.3s ease-out; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
</style>
--- END FILE: ./src/components/health-staff/competition/CompetitionDetailView.svelte ---

--- START FILE: ./src/components/health-staff/competition/CompetitionModeSelector.svelte ---
<script>
  import { createEventDispatcher } from 'svelte';
  export let activeView = 'employee'; // 'program' | 'employee'

  const dispatch = createEventDispatcher();

  function setView(view) {
      dispatch('change', view);
  }
</script>

<div class="flex justify-start items-center">
    <div class="flex bg-gray-200 p-1 rounded-lg shadow-inner">
        <button 
            class="px-4 py-1.5 rounded-md text-sm font-medium transition-all duration-200 {activeView === 'employee' ? 'bg-white text-blue-600 shadow-sm' : 'text-gray-500 hover:text-gray-700'}"
            on:click={() => setView('employee')}
        >
            Theo Nhân Viên
        </button>
        <button 
            class="px-4 py-1.5 rounded-md text-sm font-medium transition-all duration-200 {activeView === 'program' ? 'bg-white text-blue-600 shadow-sm' : 'text-gray-500 hover:text-gray-700'}"
            on:click={() => setView('program')}
        >
            Theo Chương Trình
        </button>
    </div>
</div>
--- END FILE: ./src/components/health-staff/competition/CompetitionModeSelector.svelte ---

--- START FILE: ./src/components/health-staff/competition/EmployeeView.svelte ---
<script>
  import { createEventDispatcher, afterUpdate } from 'svelte';
  import { pastedThiDuaReportData, competitionNameMappings } from '../../../stores.js'; 
  import { settingsService } from '../../../services/settings.service.js';
  import { formatters } from '../../../utils/formatters.js';
  
  export let reportData = []; 
  const dispatch = createEventDispatcher();

  // --- STATE ---
  let columnSettings = [];
  let sortKey = 'hoTen';
  let sortDirection = 'asc';
  
  // Dữ liệu phẳng
  let allEmployees = [];
  let deptAverages = {}; 

  // Palette màu cho header
  const headerColors = [
      'bg-red-100 text-red-900 border-red-200',
      'bg-orange-100 text-orange-900 border-orange-200',
      'bg-amber-100 text-amber-900 border-amber-200',
      'bg-lime-100 text-lime-900 border-lime-200',
      'bg-teal-100 text-teal-900 border-teal-200',
      'bg-cyan-100 text-cyan-900 border-cyan-200',
      'bg-sky-100 text-sky-900 border-sky-200',
      'bg-indigo-100 text-indigo-900 border-indigo-200',
      'bg-fuchsia-100 text-fuchsia-900 border-fuchsia-200',
      'bg-rose-100 text-rose-900 border-rose-200'
  ];

  function getHeaderColor(index) {
      return headerColors[index % headerColors.length];
  }

  // --- REACTIVE PROCESSING ---
  $: {
      if (reportData && reportData.length > 0) {
          let savedSettings = settingsService.loadPastedCompetitionViewSettings();
          // Nếu chưa có setting lưu, load mặc định (logic loadPastedCompetitionViewSettings đã handle việc tạo default từ dữ liệu)
          if (!savedSettings || savedSettings.length === 0) {
              savedSettings = settingsService.loadPastedCompetitionViewSettings();
          }
          columnSettings = savedSettings;

          // Map tên hiển thị
          columnSettings = columnSettings.map(col => ({
              ...col,
              label: $competitionNameMappings[col.tenGoc] || col.label || col.tenGoc
          }));

          const groups = {};
          reportData.forEach(item => {
              const dept = item.boPhan || 'Chưa phân loại';
              if (!groups[dept]) groups[dept] = [];
              groups[dept].push(item);
          });

          const avgs = {};
          Object.keys(groups).forEach(deptName => {
              const deptData = groups[deptName];
              const deptAvg = {};
              columnSettings.forEach(col => {
                  let total = 0;
                  let count = 0;
                  deptData.forEach(emp => {
                      const compData = emp.competitions.find(c => c.tenGoc === col.tenGoc);
                      const giaTri = compData?.giaTri || 0;
                      if (giaTri > 0) { 
                          total += giaTri;
                          count++;
                      }
                  });
                  deptAvg[col.tenGoc] = count > 0 ? total / count : 0;
              });
              avgs[deptName] = deptAvg;
          });
          deptAverages = avgs;

          allEmployees = [...reportData];
      } else {
          allEmployees = [];
      }
  }

  $: visibleColumns = columnSettings.filter(col => col.visible);

  // --- SORT LOGIC ---
  function handleSort(key) {
      if (sortKey === key) {
          sortDirection = sortDirection === 'desc' ? 'asc' : 'desc';
      } else {
          sortKey = key;
          sortDirection = key.startsWith('comp_') || key === 'totalScore' ? 'desc' : 'asc';
      }
  }

  $: sortedEmployees = [...allEmployees].sort((a, b) => {
      let valA, valB;
      
      if (sortKey.startsWith('comp_')) {
            const sortCol = columnSettings.find(c => c.id === sortKey);
            if (!sortCol) return 0;
            valA = a.competitions.find(c => c.tenGoc === sortCol.tenGoc)?.giaTri || 0;
            valB = b.competitions.find(c => c.tenGoc === sortCol.tenGoc)?.giaTri || 0;
            return sortDirection === 'asc' ? valA - valB : valB - valA;

      } else if (sortKey === 'totalScore') {
            const getScore = (emp) => {
                const deptAvg = deptAverages[emp.boPhan] || {};
                let score = 0;
                emp.competitions.forEach(comp => {
                    if (deptAvg[comp.tenGoc] > 0 && comp.giaTri >= deptAvg[comp.tenGoc]) score++;
                });
                return score;
            };
            valA = getScore(a);
            valB = getScore(b);
            return sortDirection === 'asc' ? valA - valB : valB - valA;

      } else {
            valA = a[sortKey] || '';
            valB = b[sortKey] || '';
            return sortDirection === 'asc' ? valA.localeCompare(valB) : valB.localeCompare(valA);
      }
  });

  // --- TOGGLE LOGIC ---
  function toggleColumn(col) {
      const newSettings = columnSettings.map(c => 
          c.tenGoc === col.tenGoc ? { ...c, visible: !c.visible } : c
      );
      columnSettings = newSettings;
      settingsService.savePastedCompetitionViewSettings(newSettings);
  }

  // --- FOOTER CALCULATION ---
  function calculateTotal(col) {
      return allEmployees.reduce((sum, emp) => {
          const comp = emp.competitions.find(c => c.tenGoc === col.tenGoc);
          return sum + (comp?.giaTri || 0);
      }, 0);
  }

  function calculateTotalScore() {
      return allEmployees.reduce((total, item) => {
          const avgScores = deptAverages[item.boPhan] || {};
          const score = item.competitions.reduce((acc, c) => (avgScores[c.tenGoc] > 0 && c.giaTri >= avgScores[c.tenGoc]) ? acc + 1 : acc, 0);
          return total + score;
      }, 0);
  }

  // --- VIEW SWITCHING ---
  function switchToProgram() {
      dispatch('viewChange', 'program');
  }

  afterUpdate(() => {
    if (typeof feather !== 'undefined') feather.replace();
  });
</script>

<div class="space-y-4 animate-fade-in">
    {#if reportData.length === 0}
        <div class="p-8 text-center bg-gray-50 border-2 border-dashed border-gray-300 rounded-lg">
            <p class="text-gray-500">Vui lòng dán dữ liệu "Thi đua nhân viên" ở tab "Cập nhật dữ liệu".</p>
        </div>
    {:else}
        
        <div class="bg-slate-50 p-3 rounded-lg border border-slate-200">
            <p class="text-xs font-bold text-gray-500 uppercase mb-2">Hiển thị cột:</p>
            <div class="flex flex-wrap gap-2">
                {#each columnSettings as col}
                    <button 
                        type="button"
                        class="px-3 py-1 rounded-full text-xs font-medium border transition-all select-none
                                {col.visible ? 'bg-blue-600 text-white border-blue-600' : 'bg-white text-gray-500 border-gray-300 hover:bg-gray-50'}"
                        on:click={() => toggleColumn(col)}
                        title={col.loaiSoLieu}
                    >
                        {col.label}
                    </button>
                {/each}
            </div>
        </div>

        <div class="bg-white rounded-xl shadow-md border border-gray-200 overflow-hidden" data-capture-group="pasted-competition">
            
            <div class="p-4 bg-white border-b border-gray-200 flex justify-between items-center">
                <div>
                    <h3 class="text-lg font-bold text-purple-800 uppercase flex items-center gap-2">
                        <i data-feather="award" class="w-5 h-5"></i>
                        Thi Đua Lũy Kế
                    </h3>
                    <p class="text-xs text-gray-500 mt-0.5 ml-7">Theo dõi tiến độ các chương trình thi đua</p>
                </div>

                <div class="flex items-center bg-gray-100 rounded-lg p-1 border border-gray-200 shadow-inner">
                    <button 
                        type="button"
                        class="px-4 py-1.5 rounded-md text-xs font-bold transition-all shadow-sm bg-white text-blue-700 cursor-default"
                    >
                        Nhân viên
                    </button>
                    <button 
                        type="button"
                        class="px-4 py-1.5 rounded-md text-xs font-medium text-gray-500 hover:text-gray-900 hover:bg-gray-200 transition-colors cursor-pointer"
                        on:click={switchToProgram}
                    >
                        Chương trình
                    </button>
                </div>
            </div>
            
            <div class="overflow-x-auto sknv-pasted-competition-scroller relative" style="max-height: 700px;">
                <table class="w-full text-sm text-left border-separate border-spacing-0">
                    <thead class="text-xs uppercase font-bold text-gray-700 sticky top-0 z-20 shadow-sm">
                        <tr>
                            <th class="bg-gray-100 border-b border-r border-gray-200 min-w-[150px] w-[150px] sticky left-0 z-30 px-2 py-2 cursor-pointer hover:bg-gray-200 transition select-none align-middle text-sm" on:click={() => handleSort('hoTen')}>
                                Nhân viên
                            </th>
                            
                            <th class="bg-gray-100 border-b border-r border-gray-200 w-[100px] min-w-[100px] sticky left-[150px] z-30 px-1 py-2 text-center cursor-pointer hover:bg-gray-200 transition select-none align-middle" on:click={() => handleSort('totalScore')}>
                                Đạt
                            </th>

                            {#each visibleColumns as col, index}
                                <th 
                                    class="px-1 py-1 w-auto min-w-[60px] max-w-[90px] whitespace-normal break-words border-b border-r border-gray-200 {getHeaderColor(index)} align-middle cursor-pointer hover:opacity-80 transition select-none"
                                    on:click={() => handleSort(col.id)}
                                    title="{col.label} (Bấm để sắp xếp)"
                                >
                                    <div class="text-[10px] font-bold leading-3 text-center whitespace-normal break-words min-h-[32px] flex items-center justify-center">
                                        {col.label}
                                    </div>
                                </th>
                            {/each}
                        </tr>
                    </thead>
                    
                    <tbody class="divide-y divide-gray-100">
                        {#each sortedEmployees as item (item.maNV)}
                            {@const avgScores = deptAverages[item.boPhan] || {}}
                            {@const score = item.competitions.reduce((acc, c) => (avgScores[c.tenGoc] > 0 && c.giaTri >= avgScores[c.tenGoc]) ? acc + 1 : acc, 0)}
                            
                            <tr 
                                class="hover:bg-blue-50 transition-colors group cursor-pointer"
                                on:click={() => dispatch('viewDetail', { employeeId: item.maNV })}
                            >
                                <td class="px-2 py-1.5 font-semibold text-blue-700 bg-white group-hover:bg-blue-50 sticky left-0 z-10 border-r border-gray-200 whitespace-nowrap text-[13px] truncate max-w-[150px]" title="{item.hoTen} - {item.maNV}">
                                    {formatters.getShortEmployeeName(item.hoTen, item.maNV)}
                                </td>
                                
                                <td class="px-1 py-1.5 w-[100px] min-w-[100px] text-center font-bold text-green-600 bg-white group-hover:bg-blue-50 border-r border-gray-200 text-[14px] sticky left-[150px] z-10">
                                    {score}
                                </td>

                                {#each visibleColumns as col}
                                    {@const comp = item.competitions.find(c => c.tenGoc === col.tenGoc)}
                                    {@const val = comp?.giaTri || 0}
                                    {@const avg = avgScores[col.tenGoc] || 0}
                                    {@const isBelow = avg > 0 && val < avg}
                                    {@const isRevenue = col.loaiSoLieu && col.loaiSoLieu.includes('DT')}
                                    {@const textColorClass = isRevenue ? 'text-blue-700' : 'text-gray-900'}
                                    
                                    <td class="px-1 py-1.5 text-right border-r border-gray-100 font-bold text-[13px] {isBelow ? 'bg-red-50' : ''} {textColorClass} whitespace-nowrap overflow-hidden">
                                        {#if val === 0}
                                            <span class="text-gray-300 font-normal">-</span>
                                        {:else}
                                            {formatters.formatNumber(val)}
                                        {/if}
                                    </td>
                                {/each}
                            </tr>
                        {/each}
                    </tbody>
                    
                    <tfoot class="text-xs uppercase sticky bottom-0 z-20 shadow-[0_-1px_2px_rgba(0,0,0,0.1)]">
                        <tr class="bg-yellow-50 text-yellow-800 font-semibold border-t-2 border-gray-300">
                            <td class="px-2 py-2 sticky left-0 bg-yellow-100 border-r border-gray-300 z-30 text-center text-[13px]">
                                TRUNG BÌNH
                            </td>
                            <td class="px-2 py-2 border-r border-gray-300 bg-yellow-100 sticky left-[150px] z-30 text-center text-[13px] font-bold text-green-700">
                                {allEmployees.length > 0 ? formatters.formatNumber(calculateTotalScore() / allEmployees.length, 1) : 0}
                            </td>
                            {#each visibleColumns as col}
                                <td class="px-1 py-2 text-right border-r border-gray-300 text-[13px]">
                                    {allEmployees.length > 0 ? formatters.formatNumber(calculateTotal(col) / allEmployees.length, 0) : 0}
                                </td>
                            {/each}
                        </tr>

                        <tr class="bg-gray-200 text-gray-900 font-bold border-t border-gray-300">
                            <td class="px-2 py-2 sticky left-0 bg-gray-300 border-r border-gray-300 z-30 text-center text-[13px]">
                                TỔNG
                            </td>
                            <td class="px-2 py-2 border-r border-gray-300 bg-gray-300 sticky left-[150px] z-30 text-center text-[13px]">
                                {calculateTotalScore()}
                            </td>
                            {#each visibleColumns as col}
                                <td class="px-1 py-2 text-right border-r border-gray-300 text-[13px]">
                                    {formatters.formatNumber(calculateTotal(col))}
                                </td>
                            {/each}
                        </tr>
                    </tfoot>
                </table>
            </div>
        </div>
    {/if}
</div>

<style>
    .animate-fade-in { animation: fadeIn 0.4s ease-out; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    .sticky { position: sticky; }
    
    .custom-scrollbar::-webkit-scrollbar { width: 4px; height: 4px; }
    .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
    .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 2px; }

    table { border-spacing: 0; }
    /* CSS cho Line Clamp 2 dòng */
    .line-clamp-2 {
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
    }
</style>
--- END FILE: ./src/components/health-staff/competition/EmployeeView.svelte ---

--- START FILE: ./src/components/health-staff/competition/FocusCompetitionTable.svelte ---
<script>
  import { formatters } from '../../../utils/formatters.js';
  
  // Nhận dữ liệu của 1 chương trình đã được tính toán
  export let competitionResult; 
  
  // Destructure dữ liệu
  $: competition = competitionResult.competition;
  $: employeeData = competitionResult.employeeData;
  $: brands = competition.brands || [];
  
  // State sắp xếp
  let sortKey = 'tyLeDT';
  let sortDirection = 'desc';

  function handleSort(key) {
      if (sortKey === key) {
          sortDirection = sortDirection === 'desc' ? 'asc' : 'desc';
      } else {
          sortKey = key;
          sortDirection = 'desc';
      }
  }

  // Logic sắp xếp dữ liệu
  $: sortedData = [...employeeData].sort((a, b) => {
      let valA = 0;
      let valB = 0;

      if (sortKey === 'hoTen') {
          return sortDirection === 'asc' 
              ? a.hoTen.localeCompare(b.hoTen) 
              : b.hoTen.localeCompare(a.hoTen);
      } 
      // Sort động cho các cột hãng (VD: samsung_quantity)
      else if (sortKey.includes('_quantity') || sortKey.includes('_revenue')) {
          const [brandName, type] = sortKey.split('_');
          const perfA = a.performanceByBrand[brandName] || { quantity: 0, revenue: 0 };
          const perfB = b.performanceByBrand[brandName] || { quantity: 0, revenue: 0 };
          valA = perfA[type] || 0;
          valB = perfB[type] || 0;
      } 
      else {
          valA = Number(a[sortKey]) || 0;
          valB = Number(b[sortKey]) || 0;
      }
      return sortDirection === 'asc' ? valA - valB : valB - valA;
  });

  // Tính tổng footer
  $: totals = employeeData.reduce((acc, item) => {
      acc.baseCategoryQuantity += item.baseCategoryQuantity;
      acc.baseCategoryRevenue += item.baseCategoryRevenue;
      brands.forEach(brand => {
          if (!acc.performanceByBrand[brand]) acc.performanceByBrand[brand] = { quantity: 0, revenue: 0 };
          const perf = item.performanceByBrand[brand] || { quantity: 0, revenue: 0 };
          acc.performanceByBrand[brand].quantity += perf.quantity;
          acc.performanceByBrand[brand].revenue += perf.revenue;
      });
      return acc;
  }, { baseCategoryQuantity: 0, baseCategoryRevenue: 0, performanceByBrand: {} });

  $: totalTyLeDT = totals.baseCategoryRevenue > 0 ? 
     Object.values(totals.performanceByBrand).reduce((sum, b) => sum + b.revenue, 0) / totals.baseCategoryRevenue : 0;

  // Helper class
  const headerClass = (key) => `px-2 py-3 cursor-pointer select-none hover:bg-indigo-100 transition ${sortKey === key ? 'bg-indigo-50 text-indigo-700' : ''}`;
</script>

<div class="bg-white rounded-xl shadow-md border border-gray-200 overflow-hidden flex flex-col h-full">
    <div class="p-4 bg-gray-50 border-b-2 border-indigo-200 flex justify-between items-center">
        <div>
            <h3 class="text-lg font-bold text-indigo-800 uppercase">{competition.name}</h3>
            <p class="text-xs text-indigo-600 font-medium mt-1">
                Hãng: <span class="font-bold">{brands.join(', ')}</span>
            </p>
        </div>
        <div class="bg-white px-3 py-1 rounded border border-indigo-100 text-xs font-medium text-gray-500">
            Mục tiêu: {competition.target || 0}%
        </div>
    </div>

    <div class="overflow-x-auto flex-grow">
        <table class="min-w-full text-sm text-left border-collapse">
            <thead class="text-xs text-slate-700 uppercase bg-slate-100 font-bold sticky top-0 z-10">
                <tr>
                    <th rowspan="2" class="{headerClass('hoTen')} bg-gray-200 min-w-[180px]" on:click={() => handleSort('hoTen')}>
                        Nhân viên {sortKey === 'hoTen' ? (sortDirection === 'asc' ? '▲' : '▼') : ''}
                    </th>
                    {#each brands as brand}
                        <th colspan="2" class="px-2 py-1 text-center border-l border-gray-300 bg-purple-100 text-purple-900">{brand}</th>
                    {/each}
                    <th colspan="2" class="px-2 py-1 text-center border-l border-gray-300 bg-blue-100 text-blue-900">Tổng Nhóm</th>
                    <th colspan="2" class="px-2 py-1 text-center border-l border-gray-300 bg-orange-100 text-orange-900">Tỷ lệ</th>
                </tr>
                <tr>
                    {#each brands as brand}
                        <th class="{headerClass(`${brand}_quantity`)} text-right border-l border-gray-200" on:click={() => handleSort(`${brand}_quantity`)}>SL</th>
                        <th class="{headerClass(`${brand}_revenue`)} text-right" on:click={() => handleSort(`${brand}_revenue`)}>DT</th>
                    {/each}
                    
                    <th class="{headerClass('baseCategoryQuantity')} text-right border-l border-gray-200" on:click={() => handleSort('baseCategoryQuantity')}>SL</th>
                    <th class="{headerClass('baseCategoryRevenue')} text-right" on:click={() => handleSort('baseCategoryRevenue')}>DT</th>
                    
                    <th class="{headerClass('tyLeSL')} text-right border-l border-gray-200" on:click={() => handleSort('tyLeSL')}>% SL</th>
                    <th class="{headerClass('tyLeDT')} text-right" on:click={() => handleSort('tyLeDT')}>% DT</th>
                </tr>
            </thead>
            
            <tbody class="divide-y divide-gray-100">
                {#each sortedData as item}
                    <tr class="hover:bg-indigo-50 transition-colors">
                        <td class="px-4 py-2 font-semibold text-indigo-900 whitespace-nowrap sticky left-0 bg-white hover:bg-indigo-50 border-r border-gray-200">
                            {formatters.getShortEmployeeName(item.hoTen, item.maNV)}
                        </td>
                        
                        {#each brands as brand}
                            {@const perf = item.performanceByBrand[brand] || {quantity: 0, revenue: 0}}
                            <td class="px-2 py-2 text-right border-l border-gray-100 text-gray-500">{formatters.formatNumberOrDash(perf.quantity)}</td>
                            <td class="px-2 py-2 text-right font-medium">{formatters.formatRevenue(perf.revenue)}</td>
                        {/each}

                        <td class="px-2 py-2 text-right border-l border-gray-200 font-bold bg-blue-50/30">{formatters.formatNumberOrDash(item.baseCategoryQuantity)}</td>
                        <td class="px-2 py-2 text-right font-bold bg-blue-50/30">{formatters.formatRevenue(item.baseCategoryRevenue)}</td>
                        
                        <td class="px-2 py-2 text-right border-l border-gray-200 text-gray-500">{formatters.formatPercentage(item.tyLeSL)}</td>
                        <td class="px-2 py-2 text-right font-bold {item.tyLeDT >= (competition.target/100) ? 'text-green-600' : 'text-red-500'}">{formatters.formatPercentage(item.tyLeDT)}</td>
                    </tr>
                {/each}
            </tbody>
            
            <tfoot class="bg-gray-100 font-bold text-gray-800 border-t-2 border-gray-300">
                <tr>
                    <td class="px-4 py-2">Tổng</td>
                    {#each brands as brand}
                        {@const perf = totals.performanceByBrand[brand] || {quantity: 0, revenue: 0}}
                        <td class="px-2 py-2 text-right border-l border-gray-200">{formatters.formatNumberOrDash(perf.quantity)}</td>
                        <td class="px-2 py-2 text-right">{formatters.formatRevenue(perf.revenue)}</td>
                    {/each}
                    <td class="px-2 py-2 text-right border-l border-gray-200">{formatters.formatNumberOrDash(totals.baseCategoryQuantity)}</td>
                    <td class="px-2 py-2 text-right">{formatters.formatRevenue(totals.baseCategoryRevenue)}</td>
                    <td class="px-2 py-2 text-right border-l border-gray-200">-</td>
                    <td class="px-2 py-2 text-right text-blue-700">{formatters.formatPercentage(totalTyLeDT)}</td>
                </tr>
            </tfoot>
        </table>
    </div>
</div>
--- END FILE: ./src/components/health-staff/competition/FocusCompetitionTable.svelte ---

--- START FILE: ./src/components/health-staff/competition/ProgramView.svelte ---
<script>
  import FocusCompetitionTable from './FocusCompetitionTable.svelte';

  export let reportData = []; // Mảng kết quả tính toán từ service
</script>

{#if reportData.length === 0}
    <div class="p-12 text-center bg-white border-2 border-dashed border-gray-300 rounded-xl">
        <p class="text-gray-500 font-medium">Không có dữ liệu chương trình thi đua.</p>
        <p class="text-sm text-gray-400 mt-2">
            Vui lòng kiểm tra:
            1. Đã tạo chương trình trong "Thiết lập mục tiêu"?
            2. Đã tải file YCX?
            3. Có phát sinh doanh thu cho các nhóm hàng đã chọn?
        </p>
    </div>
{:else}
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 pb-10">
        {#each reportData as result (result.competition.id)}
            <div class="h-full">
                <FocusCompetitionTable competitionResult={result} />
            </div>
        {/each}
    </div>
{/if}
--- END FILE: ./src/components/health-staff/competition/ProgramView.svelte ---

--- START FILE: ./src/components/health-staff/detail/CardFilter.svelte ---
<script>
    import { createEventDispatcher } from 'svelte';
    
    export let items = []; // Array { id, label, visible }

    const dispatch = createEventDispatcher();
    let isOpen = false;
    let containerRef; 

    function toggleDropdown() {
        isOpen = !isOpen;
    }

    function toggleItem(id) {
        dispatch('change', id);
    }

    // Đóng dropdown khi click ra ngoài container của chính component này
    function close(e) {
        if (isOpen && containerRef && !containerRef.contains(e.target)) {
            isOpen = false;
        }
    }
</script>

<svelte:window on:click={close} />

<div class="relative inline-block text-left" bind:this={containerRef}>
    <button 
        type="button" 
        class="text-white/70 hover:text-white p-1 rounded-full hover:bg-white/20 transition-colors"
        on:click|stopPropagation={toggleDropdown}
        title="Lọc chỉ số hiển thị"
    >
        <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z" />
        </svg>
    </button>

    {#if isOpen}
        <div class="absolute right-0 mt-2 w-64 bg-white rounded-lg shadow-xl border border-gray-200 z-[100] animate-fade-in-fast origin-top-right">
            <div class="p-2 border-b border-gray-100 bg-gray-50 rounded-t-lg">
                <span class="text-xs font-bold text-gray-500 uppercase">Hiển thị chỉ số</span>
            </div>
            <div class="p-1 max-h-60 overflow-y-auto custom-scrollbar">
                {#if items.length === 0}
                    <div class="px-3 py-2 text-xs text-gray-400 text-center">Không có mục nào.</div>
                {:else}
                    {#each items as item (item.id)}
                        <label class="flex items-center px-3 py-2 hover:bg-gray-50 cursor-pointer rounded transition-colors group">
                            <input 
                                type="checkbox" 
                                checked={item.visible !== false} 
                                on:change={() => toggleItem(item.id)}
                                class="mr-3 h-4 w-4 text-blue-600 rounded border-gray-300 focus:ring-blue-500 cursor-pointer"
                            >
                            <span class="text-sm text-gray-700 group-hover:text-blue-700 truncate select-none" title={item.label}>
                                {item.label}
                            </span>
                        </label>
                    {/each}
                {/if}
            </div>
        </div>
    {/if}
</div>

<style>
    .animate-fade-in-fast { animation: fadeIn 0.1s ease-out; }
    @keyframes fadeIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
    
    .custom-scrollbar::-webkit-scrollbar { width: 4px; }
    .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
    .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 2px; }
</style>
--- END FILE: ./src/components/health-staff/detail/CardFilter.svelte ---

--- START FILE: ./src/components/health-staff/detail/DetailHeader.svelte ---
<script>
  // Component hiển thị Header của trang chi tiết
  export let employee;
  export let totalAbove = 0;
  export let totalCriteria = 0;
  // [MỚI] Prop để điều khiển hiển thị dòng đánh giá
  export let showStats = true;
</script>

<div class="flex items-center gap-6 p-4 bg-purple-50 border border-purple-200 border-t-4 border-t-purple-500 rounded-lg shadow-sm mb-6">
    <div class="w-16 h-16 rounded-full bg-purple-200 flex items-center justify-center flex-shrink-0 text-purple-800">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-8 h-8">
            <path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/>
        </svg>
    </div>
    
    <div class="flex-grow">
        <p class="text-2xl font-extrabold text-purple-800 leading-tight">
             {employee.hoTen} <span class="text-lg font-semibold text-purple-600">- {employee.maNV}</span>
        </p>
        <p class="text-gray-700 font-medium text-base">{employee.boPhan}</p>
        
        {#if showStats}
            <p class="mt-1 text-sm font-semibold text-gray-800">
                Chỉ số trên TB: <span class="text-green-600 font-bold text-lg">{totalAbove}</span> 
                <span class="text-gray-400 mx-1">/</span> 
                Tổng: <span class="font-bold text-gray-600">{totalCriteria}</span>
            </p>
        {/if}
    </div>
</div>
--- END FILE: ./src/components/health-staff/detail/DetailHeader.svelte ---

--- START FILE: ./src/components/health-staff/detail/DetailTableCategory.svelte ---
<script>
  import { formatters } from '../../../utils/formatters.js';
  import { cleanCategoryName } from '../../../utils.js';
  import { categoryStructure, macroCategoryConfig } from '../../../stores.js'; 
  import CardFilter from './CardFilter.svelte';

  export let data = []; 
  export let rawEmployee = null; 

  const headerClass = "bg-[#7e22ce]";

  // Hàm chuẩn hóa key để so sánh (viết thường + bỏ khoảng trắng thừa)
  const normalizeKey = (str) => {
      if (!str) return '';
      return String(str).trim().toLowerCase();
  };

  let displayData = [];
  let filterItems = [];
  
  // State hiển thị (Lưu danh sách các KEY đã chuẩn hóa)
  let visibleKeys = new Set();
  let isInitialized = false;

  // Logic xử lý dữ liệu chính
  $: {
      // 1. Thu thập tất cả các tên ngành hàng từ mọi nguồn
      const source1 = ($macroCategoryConfig || []).map(m => m.name);
      const source2 = ($categoryStructure || []).map(c => cleanCategoryName(c.nganhHang)).filter(Boolean);
      const source3 = data.map(i => i.name);
      
      // Danh sách tên gốc để hiển thị
      const allRawNames = [...source1, ...source2, ...source3];

      // 2. Gộp dữ liệu vào Map để khử trùng lặp dựa trên key chuẩn hóa
      const mergedMap = new Map();

      allRawNames.forEach(rawName => {
          const key = normalizeKey(rawName);
          if (!key) return;

          // Nếu chưa có trong Map, tạo mới
          if (!mergedMap.has(key)) {
              // Ưu tiên lấy số liệu từ 'data' (đã tính toán)
              let existingItem = data.find(i => normalizeKey(i.name) === key);
              
              // Nếu không có, lấy từ rawEmployee (tra cứu an toàn)
              if (!existingItem && rawEmployee?.doanhThuTheoNganhHang) {
                  // Cần tìm key gốc trong object rawEmployee khớp với key chuẩn hóa
                  const rawKey = Object.keys(rawEmployee.doanhThuTheoNganhHang).find(k => normalizeKey(k) === key);
                  if (rawKey) {
                      existingItem = rawEmployee.doanhThuTheoNganhHang[rawKey];
                  }
              }

              // Tạo object hiển thị
              mergedMap.set(key, {
                  id: key, // Dùng key chuẩn hóa làm ID duy nhất cho vòng lặp
                  name: rawName, // Tên hiển thị (lấy cái đầu tiên tìm thấy)
                  quantity: existingItem ? existingItem.quantity : 0,
                  revenue: existingItem ? existingItem.revenue : 0,
                  revenueQuyDoi: existingItem ? existingItem.revenueQuyDoi : 0
              });
          }
      });

      // 3. Khởi tạo trạng thái filter (chỉ chạy 1 lần đầu)
      if (!isInitialized && mergedMap.size > 0) {
          // Mặc định hiện những cái có số liệu > 0
          mergedMap.forEach((val, key) => {
              if (val.revenue > 0 || val.quantity > 0) {
                  visibleKeys.add(key);
              }
          });
          // Nếu nhân viên không có dữ liệu gì, hiện tất cả hoặc top 10 (tuỳ chọn), ở đây ta để trống
          visibleKeys = new Set(visibleKeys);
          isInitialized = true;
      }

      // 4. Tạo danh sách hiển thị cuối cùng
      displayData = Array.from(mergedMap.values())
          .filter(item => visibleKeys.has(item.id))
          .sort((a, b) => b.revenue - a.revenue);

      // 5. Tạo danh sách cho bộ lọc
      // Sort bộ lọc theo tên A-Z để dễ tìm
      filterItems = Array.from(mergedMap.values())
          .map(item => ({
              id: item.id,
              label: item.name,
              visible: visibleKeys.has(item.id)
          }))
          .sort((a, b) => a.label.localeCompare(b.label));
  }

  function handleFilterChange(event) {
      const id = event.detail; // id nhận được là key đã chuẩn hóa
      if (visibleKeys.has(id)) {
          visibleKeys.delete(id);
      } else {
          visibleKeys.add(id);
      }
      visibleKeys = new Set(visibleKeys); // Trigger reactivity
  }
</script>

<div class="bg-white rounded-xl shadow-md border border-gray-200 overflow-hidden flex flex-col h-full">
    <div class="{headerClass} flex justify-between items-center p-3 text-white">
        <div class="flex items-center gap-2">
            <i data-feather="list" class="w-5 h-5"></i>
            <h4 class="text-lg font-bold">Doanh thu ngành hàng</h4>
        </div>
        <CardFilter items={filterItems} on:change={handleFilterChange} />
    </div>
    
    <div class="overflow-x-auto max-h-96">
        <table class="w-full text-sm table-bordered table-striped">
            <thead class="bg-gray-50 font-bold text-gray-700 sticky top-0 z-10">
                <tr>
                    <th class="px-3 py-2 text-left">Ngành hàng</th>
                    <th class="px-3 py-2 text-right">SL</th>
                    <th class="px-3 py-2 text-right">Doanh thu</th>
                    <th class="px-3 py-2 text-right">DTQĐ</th>
                </tr>
            </thead>
            <tbody>
                {#if displayData.length === 0}
                    <tr><td colspan="4" class="p-4 text-center text-gray-500">Đã ẩn hết dữ liệu.</td></tr>
                {:else}
                    {#each displayData as item (item.id)}
                        <tr class="border-t hover:bg-slate-50 transition-colors">
                            <td class="px-3 py-2 font-medium capitalize text-gray-800">{item.name}</td>
                            <td class="px-3 py-2 text-right font-bold text-gray-600">{formatters.formatNumber(item.quantity)}</td>
                            <td class="px-3 py-2 text-right font-bold text-gray-800">{formatters.formatRevenue(item.revenue, 0)}</td>
                            <td class="px-3 py-2 text-right font-bold text-purple-600">{formatters.formatRevenue(item.revenueQuyDoi, 0)}</td>
                        </tr>
                    {/each}
                {/if}
            </tbody>
        </table>
    </div>
</div>
--- END FILE: ./src/components/health-staff/detail/DetailTableCategory.svelte ---

--- START FILE: ./src/components/health-staff/detail/DetailTableQDC.svelte ---
<script>
  import { formatters } from '../../../utils/formatters.js';
  import { cleanCategoryName } from '../../../utils.js';
  import { categoryStructure, macroProductGroupConfig } from '../../../stores.js'; 
  import CardFilter from './CardFilter.svelte';

  export let data = []; 
  export let rawEmployee = null; 

  const headerClass = "bg-[#4f46e5]"; 

  const normalizeKey = (str) => {
      if (!str) return '';
      return String(str).trim().toLowerCase();
  };

  let displayData = [];
  let filterItems = [];
  let visibleKeys = new Set();
  let isInitialized = false;

  $: {
      const source1 = ($macroProductGroupConfig || []).map(m => m.name);
      const source2 = ($categoryStructure || []).map(c => cleanCategoryName(c.nhomHang)).filter(Boolean);
      const source3 = data.map(i => i.name);
      const allRawNames = [...source1, ...source2, ...source3];

      const mergedMap = new Map();

      allRawNames.forEach(rawName => {
          const key = normalizeKey(rawName);
          if (!key) return;

          if (!mergedMap.has(key)) {
              let existingItem = data.find(i => normalizeKey(i.name) === key);
              
              if (!existingItem) {
                  // Thử tìm trong nhomHangChiTiet
                  if (rawEmployee?.doanhThuTheoNhomHang) {
                      const rawKey = Object.keys(rawEmployee.doanhThuTheoNhomHang).find(k => normalizeKey(k) === key);
                      if (rawKey) existingItem = rawEmployee.doanhThuTheoNhomHang[rawKey];
                  }
                  // Nếu không thấy, thử tìm trong qdc (vì QĐC cũng là nhóm hàng)
                  if (!existingItem && rawEmployee?.qdc) {
                      const rawKey = Object.keys(rawEmployee.qdc).find(k => normalizeKey(k) === key);
                      if (rawKey) existingItem = rawEmployee.qdc[rawKey];
                  }
              }

              mergedMap.set(key, {
                  id: key,
                  name: rawName,
                  sl: existingItem ? (existingItem.sl || existingItem.quantity || 0) : 0,
                  dtqd: existingItem ? (existingItem.dtqd || existingItem.revenueQuyDoi || 0) : 0
              });
          }
      });

      if (!isInitialized && mergedMap.size > 0) {
          mergedMap.forEach((val, key) => {
              if (val.dtqd > 0 || val.sl > 0) visibleKeys.add(key);
          });
          visibleKeys = new Set(visibleKeys);
          isInitialized = true;
      }

      displayData = Array.from(mergedMap.values())
          .filter(item => visibleKeys.has(item.id))
          .sort((a, b) => b.dtqd - a.dtqd);

      filterItems = Array.from(mergedMap.values())
          .map(item => ({
              id: item.id,
              label: item.name,
              visible: visibleKeys.has(item.id)
          }))
          .sort((a, b) => a.label.localeCompare(b.label));
  }

  function handleFilterChange(event) {
      const id = event.detail;
      if (visibleKeys.has(id)) visibleKeys.delete(id);
      else visibleKeys.add(id);
      visibleKeys = new Set(visibleKeys);
  }
</script>

<div class="bg-white rounded-xl shadow-md border border-gray-200 overflow-hidden flex flex-col h-full">
    <div class="{headerClass} flex justify-between items-center p-3 text-white">
        <div class="flex items-center gap-2">
            <i data-feather="star" class="w-5 h-5"></i>
            <h4 class="text-lg font-bold">Nhóm hàng Quy đổi cao</h4>
        </div>
        <CardFilter items={filterItems} on:change={handleFilterChange} />
    </div>
    
    <div class="overflow-x-auto max-h-96">
        <table class="w-full text-sm table-bordered table-striped">
            <thead class="bg-gray-50 font-bold text-gray-700 sticky top-0 z-10">
                <tr>
                    <th class="px-3 py-2 text-left">Nhóm hàng</th>
                    <th class="px-3 py-2 text-right">SL</th>
                    <th class="px-3 py-2 text-right">DTQĐ (Tr)</th>
                </tr>
            </thead>
            <tbody>
                {#if displayData.length === 0}
                    <tr><td colspan="3" class="p-4 text-center text-gray-500">Đã ẩn hết dữ liệu.</td></tr>
                {:else}
                    {#each displayData as item (item.id)}
                        <tr class="border-t hover:bg-slate-50 transition-colors">
                            <td class="px-3 py-2 font-medium text-gray-800">{item.name}</td>
                            <td class="px-3 py-2 text-right font-bold text-gray-600">{formatters.formatNumber(item.sl)}</td>
                            <td class="px-3 py-2 text-right font-bold text-blue-600">{formatters.formatRevenue(item.dtqd)}</td>
                        </tr>
                    {/each}
                {/if}
            </tbody>
        </table>
    </div>
</div>
--- END FILE: ./src/components/health-staff/detail/DetailTableQDC.svelte ---

--- START FILE: ./src/components/health-staff/detail/DetailView.svelte ---
<script>
  import { afterUpdate, createEventDispatcher, onMount } from 'svelte';
  import { masterReportData, selectedWarehouse, warehouseCustomMetrics } from '../../../stores.js';
  import { sknvService } from '../../../services/sknv.service.js';
  import { datasyncService } from '../../../services/datasync.service.js';
  
  import DetailHeader from './DetailHeader.svelte';
  import MetricGrid from './MetricGrid.svelte';
  import DetailTableQDC from './DetailTableQDC.svelte';
  import DetailTableCategory from './DetailTableCategory.svelte';
  
  import AddEfficiencyColumnModal from '../../modals/AddEfficiencyColumnModal.svelte';
  import AddMetricModal from '../../modals/AddMetricModal.svelte';

  export let employeeId;

  const dispatch = createEventDispatcher();

  let employeeData = null;
  let rawEmployeeData = null;
  let detailStats = {};
  let qdcData = [];
  let nganhHangData = [];
  
  let kpiCounts = {
      'Doanh thu': { above: 0, total: 0 },
      'Hiệu quả khai thác': { above: 0, total: 0 },
      'Năng suất': { above: 0, total: 0 },
      'Đơn giá': { above: 0, total: 0 }
  };
  
  // State quản lý hiển thị Modal
  let isEffModalOpen = false;
  let isMetricModalOpen = false;
  let itemToEdit = null;

  // [KHÔI PHỤC] Hai dòng quan trọng bị thiếu gây lỗi ReferenceError
  $: totalAbove = Object.values(kpiCounts).reduce((sum, item) => sum + item.above, 0);
  $: totalCriteria = Object.values(kpiCounts).reduce((sum, item) => sum + item.total, 0);

  // Logic tải dữ liệu từ Cloud khi Warehouse thay đổi
  $: if ($selectedWarehouse) {
      loadMetricsFromCloud($selectedWarehouse);
  }

  async function loadMetricsFromCloud(kho) {
      const data = await datasyncService.loadCustomMetrics(kho);
      warehouseCustomMetrics.set(data);
  }

  // Reactive: Tính toán lại khi Store metrics thay đổi HOẶC employeeId thay đổi
  $: calculateEmployeeData(employeeId, $masterReportData, $warehouseCustomMetrics);

  function calculateEmployeeData(id, masterData, metrics) {
      if (!id || masterData.sknv.length === 0) return;

      const rawEmployee = masterData.sknv.find(e => String(e.maNV) === String(id));
      
      if (rawEmployee) {
          rawEmployeeData = rawEmployee;
          const deptAvg = sknvService.calculateDepartmentAverages(rawEmployee.boPhan, masterData.sknv);
          
          // Tính toán các chỉ số custom (Lấy từ Store)
          if(metrics && metrics.length > 0) {
              const departmentEmployees = masterData.sknv.filter(e => e.boPhan === rawEmployee.boPhan);
              metrics.forEach(m => {
                  let totalVal = 0;
                  let count = 0;
                  departmentEmployees.forEach(emp => {
                      totalVal += sknvService.calculateDynamicMetricValue(emp, m);
                      count++;
                  });
                  deptAvg[`custom_${m.id}`] = count > 0 ? totalVal / count : 0;
              });
          }

          // Gán dữ liệu
          employeeData = rawEmployee;
          detailStats = sknvService.getDetailStats(rawEmployee, deptAvg, metrics);

          if (rawEmployee.qdc) {
              qdcData = Object.entries(rawEmployee.qdc)
                  .map(([id, val]) => ({ id, ...val }))
                  .filter(item => (item.sl || 0) > 0)
                  .sort((a, b) => b.dtqd - a.dtqd);
          } else { qdcData = []; }

          if (rawEmployee.doanhThuTheoNganhHang) {
              nganhHangData = Object.entries(rawEmployee.doanhThuTheoNganhHang)
                  .map(([name, val]) => ({ name, ...val }))
                  .filter(item => (item.revenue || 0) > 0)
                  .sort((a, b) => b.revenue - a.revenue);
          } else { nganhHangData = []; }
      }
  }

  function handleCountUpdate(event) {
      const { title, above, total } = event.detail;
      let key = title;
      if (title === 'Hiệu quả') key = 'Hiệu quả khai thác'; 
      if (kpiCounts[key]) {
          kpiCounts[key] = { above, total };
          kpiCounts = { ...kpiCounts };
      }
  }

  function handleEditMetric(event) {
      const metricItem = event.detail;
      if (metricItem && metricItem.rawConfig) {
          itemToEdit = metricItem.rawConfig;
          if (metricItem.rawConfig.type === 'UNIT_PRICE') {
              isMetricModalOpen = true;
          } else {
              isEffModalOpen = true;
          }
      }
  }

  async function handleDeleteMetric(event) {
      const idToDelete = event.detail;
      if (confirm("Bạn có chắc chắn muốn xóa chỉ số này không?")) {
          // Xóa khỏi Store và Cloud
          const newMetrics = $warehouseCustomMetrics.filter(m => m.id !== idToDelete);
          warehouseCustomMetrics.set(newMetrics);
          
          if ($selectedWarehouse) {
              await datasyncService.saveCustomMetrics($selectedWarehouse, newMetrics);
          }
      }
  }

  async function handleSaveMetric(event) {
      const savedMetric = event.detail;
      let currentMetrics = [...$warehouseCustomMetrics]; 
      
      const existingIndex = currentMetrics.findIndex(m => m.id === savedMetric.id);
      
      if (existingIndex >= 0) {
          currentMetrics[existingIndex] = savedMetric;
      } else {
          currentMetrics = [...currentMetrics, savedMetric];
      }
      
      // Cập nhật Store và Lưu Cloud
      warehouseCustomMetrics.set(currentMetrics);
      if ($selectedWarehouse) {
          await datasyncService.saveCustomMetrics($selectedWarehouse, currentMetrics);
      }
      
      itemToEdit = null;
  }

  function handleCloseModal() {
      isEffModalOpen = false;
      isMetricModalOpen = false;
      itemToEdit = null;
  }

  function goBack() { dispatch('back'); }

  afterUpdate(() => { if (window.feather) window.feather.replace(); });
</script>

<div class="animate-fade-in pb-10 max-w-7xl mx-auto">
    <div class="mb-4">
        <button on:click={goBack} class="text-blue-600 hover:underline font-semibold flex items-center gap-1">
           <i data-feather="chevron-left" class="w-4 h-4"></i> Quay lại bảng tổng hợp
        </button>
    </div>

    {#if employeeData}
        <DetailHeader employee={employeeData} {totalAbove} {totalCriteria} showStats={true} />

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-6 items-start">
            <div class="space-y-6">
                <MetricGrid 
                    title="Doanh thu" icon="trending-up" colorClass="sknv-header-blue" 
                    data={detailStats.doanhThu || []} 
                    on:updateCount={handleCountUpdate} 
                />
                
                <MetricGrid 
                    title="Hiệu quả khai thác" icon="award" colorClass="sknv-header-orange" 
                    data={detailStats.hieuQua || []} 
                    allowAdd={true}
                    on:add={() => { itemToEdit = null; isEffModalOpen = true; }} 
                    on:edit={handleEditMetric}
                    on:delete={handleDeleteMetric}
                    on:updateCount={handleCountUpdate} 
                />
            </div>
            <div class="space-y-6">
                <MetricGrid 
                    title="Năng suất" icon="dollar-sign" colorClass="sknv-header-green" 
                    data={detailStats.nangSuat || []} 
                    on:updateCount={handleCountUpdate} 
                />
                
                <MetricGrid 
                    title="Đơn giá" icon="tag" colorClass="sknv-header-yellow" 
                    data={detailStats.donGia || []}
                    allowAdd={true}
                    on:add={() => { itemToEdit = null; isMetricModalOpen = true; }} 
                    on:edit={handleEditMetric}
                    on:delete={handleDeleteMetric}
                    on:updateCount={handleCountUpdate} 
                />
            </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-6 items-start">
            <DetailTableQDC data={qdcData} rawEmployee={rawEmployeeData} />
            <DetailTableCategory data={nganhHangData} rawEmployee={rawEmployeeData} />
        </div>

    {:else}
        <div class="p-12 text-center bg-red-50 rounded-lg border border-red-200">
            <p class="text-red-600 font-semibold">Không tìm thấy dữ liệu cho nhân viên này.</p>
        </div>
    {/if}
</div>

<AddEfficiencyColumnModal 
    isOpen={isEffModalOpen} 
    editItem={itemToEdit} 
    on:close={handleCloseModal}
    on:save={handleSaveMetric}
/>

<AddMetricModal
    isOpen={isMetricModalOpen}
    editItem={itemToEdit}
    on:close={handleCloseModal}
    on:save={handleSaveMetric}
/>

<style>
    :global(.sknv-header-blue) { background-color: #2563eb; }
    :global(.sknv-header-green) { background-color: #16a34a; }
    :global(.sknv-header-orange) { background-color: #f97316; }
    :global(.sknv-header-yellow) { background-color: #ca8a04; }
    .animate-fade-in { animation: fadeIn 0.3s ease-out; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
</style>
--- END FILE: ./src/components/health-staff/detail/DetailView.svelte ---

--- START FILE: ./src/components/health-staff/detail/MetricGrid.svelte ---
<script>
  import { afterUpdate, createEventDispatcher } from 'svelte';
  import EvaluationBadge from '../shared/EvaluationBadge.svelte';
  import CardFilter from './CardFilter.svelte';

  export let title = '';
  export let icon = '';
  export let colorClass = 'sknv-header-blue';
  export let data = []; // Array of metrics { id, label, value, average, ... }
  export let allowAdd = false; 

  const dispatch = createEventDispatcher();

  let sortKey = 'label';
  let sortDirection = 'asc';
  
  // Trạng thái hiển thị cục bộ
  let visibilityState = {};

  $: {
      if(data) {
          data.forEach(item => {
              if (visibilityState[item.id] === undefined) {
                  visibilityState[item.id] = true;
              }
          });
          calculateAndEmitCount();
      }
  }

  function handleSort(key) {
    if (sortKey === key) {
      sortDirection = sortDirection === 'desc' ? 'asc' : 'desc';
    } else {
      sortKey = key;
      sortDirection = 'asc';
    }
  }

  function handleFilterChange(event) {
      const id = event.detail;
      visibilityState[id] = !visibilityState[id];
      visibilityState = { ...visibilityState }; 
      calculateAndEmitCount();
  }

  function calculateAndEmitCount() {
      const visibleItems = data.filter(item => visibilityState[item.id] !== false);
      const aboveCount = visibleItems.filter(item => isAboveAverage(item.rawValue, item.rawAverage)).length;
      const totalCount = visibleItems.length;
      dispatch('updateCount', { title, above: aboveCount, total: totalCount });
  }

  function isAboveAverage(val, avg) {
      if (!isFinite(val) || avg === undefined || !isFinite(avg)) return false;
      return val >= avg;
  }

  $: sortedData = [...data]
      .filter(item => visibilityState[item.id] !== false)
      .sort((a, b) => {
          let valA, valB;
          if (sortKey === 'label') {
              valA = a.label || ''; valB = b.label || '';
              return sortDirection === 'asc' ? valA.localeCompare(valB) : valB.localeCompare(valA);
          } else if (sortKey === 'value') {
              valA = a.rawValue || 0; valB = b.rawValue || 0;
          } else {
              valA = a.rawAverage || 0; valB = b.rawAverage || 0;
          }
          return sortDirection === 'asc' ? valA - valB : valB - valA;
      });

  afterUpdate(() => {
      if (typeof feather !== 'undefined') feather.replace();
  });
</script>

<div class="bg-white rounded-xl shadow-md border border-gray-200 overflow-hidden h-full flex flex-col">
    <div class="sknv-detail-card-header {colorClass} flex justify-between items-center p-3 text-white">
        <div class="flex items-center gap-2">
            <i data-feather={icon} class="w-5 h-5"></i>
            <h4 class="text-lg font-bold">{title}</h4>
        </div>
        
        <div class="flex items-center gap-1">
            {#if allowAdd}
                <button 
                    class="text-white/80 hover:text-white hover:bg-white/20 p-1 rounded-full transition-colors"
                    title="Thêm chỉ số mới"
                    on:click={() => dispatch('add')}
                >
                    <i data-feather="plus" class="w-4 h-4"></i>
                </button>
            {/if}
            
            <CardFilter 
                items={data.map(i => ({ id: i.id, label: i.label, visible: visibilityState[i.id] !== false }))} 
                on:change={handleFilterChange} 
            />
        </div>
    </div>
    
    <div class="overflow-x-auto flex-grow">
        <table class="w-full text-sm">
            <thead class="bg-gray-50 border-b border-gray-200">
                <tr>
                    <th class="px-3 py-2 text-left font-semibold text-gray-600 cursor-pointer hover:bg-gray-100 select-none" on:click={() => handleSort('label')}>
                        Chỉ số {sortKey==='label' ? (sortDirection==='asc' ? '▲' : '▼') : ''}
                    </th>
                    <th class="px-3 py-2 text-right font-semibold text-gray-600 cursor-pointer hover:bg-gray-100 select-none" on:click={() => handleSort('value')}>
                        Thực hiện {sortKey==='value' ? (sortDirection==='asc' ? '▲' : '▼') : ''}
                    </th>
                    <th class="px-3 py-2 text-right font-semibold text-gray-600 cursor-pointer hover:bg-gray-100 select-none" on:click={() => handleSort('average')}>
                        Trung bình {sortKey==='average' ? (sortDirection==='asc' ? '▲' : '▼') : ''}
                    </th>
                    <th class="px-3 py-2 text-right font-semibold text-gray-600">Đánh giá</th>
                </tr>
            </thead>
            <tbody class="divide-y divide-gray-100">
                {#if sortedData.length === 0}
                    <tr><td colspan="4" class="p-4 text-center text-gray-400 italic text-xs">Đã ẩn tất cả chỉ số.</td></tr>
                {:else}
                    {#each sortedData as row (row.id)}
                        <tr class="hover:bg-slate-50 transition-colors group/row">
                            <td class="px-3 py-2 font-medium text-gray-700 flex items-center gap-1">
                                {row.label}
                                {#if row.isCustom}
                                    <span class="text-[10px] px-1.5 py-0.5 rounded bg-blue-100 text-blue-700 font-bold whitespace-nowrap">Mới</span>
                                    <div class="flex gap-1 ml-2 opacity-0 group-hover/row:opacity-100 transition-opacity">
                                        <button 
                                            class="p-1 text-gray-400 hover:text-blue-600 rounded hover:bg-blue-50" 
                                            title="Sửa"
                                            on:click|stopPropagation={() => dispatch('edit', row)}
                                        >
                                            <i data-feather="edit-2" class="w-3 h-3"></i>
                                        </button>
                                        <button 
                                            class="p-1 text-gray-400 hover:text-red-600 rounded hover:bg-red-50" 
                                            title="Xóa"
                                            on:click|stopPropagation={() => dispatch('delete', row.id)}
                                        >
                                            <i data-feather="trash-2" class="w-3 h-3"></i>
                                        </button>
                                    </div>
                                {/if}
                            </td>
                            <td class="px-3 py-2 text-right font-bold text-gray-900 {row.valueClass || ''}">{row.value}</td>
                            <td class="px-3 py-2 text-right text-gray-500 italic">{row.average}</td>
                            <td class="px-3 py-2 text-right">
                                <EvaluationBadge isAbove={isAboveAverage(row.rawValue, row.rawAverage)} />
                            </td>
                        </tr>
                    {/each}
                {/if}
            </tbody>
        </table>
    </div>
</div>
--- END FILE: ./src/components/health-staff/detail/MetricGrid.svelte ---

--- START FILE: ./src/components/health-staff/performance/DynamicPerformanceTable.svelte ---
<script>
    import { createEventDispatcher } from 'svelte';
    import { formatters } from '../../../utils/formatters.js';
    import { dynamicTableProcessor } from '../../../services/processing/logic/dynamicTable.processor.js';
    import { isAdmin } from '../../../stores.js';
    
    // Components
    import SortableTh from '../../common/SortableTh.svelte';

    export let config = {};      // Cấu hình bảng (từ Admin/User)
    export let reportData = [];  // Dữ liệu nhân viên (Master Data)
    export let colorTheme = 'blue';

    const dispatch = createEventDispatcher();

    // --- STATE ---
    let sortKey = 'hoTen';
    let sortDirection = 'asc';

    // --- PROCESSING ---
    // 1. Biến đổi dữ liệu thô -> Dữ liệu hiển thị (kèm logic tính %)
    $: processedResult = dynamicTableProcessor.processTableData(reportData, config);
    $: tableData = processedResult.processedData;
    $: totals = processedResult.totals;

    // 2. Sắp xếp
    $: sortedData = dynamicTableProcessor.sortTableData(tableData, sortKey, sortDirection);

    // --- HANDLERS ---
    function handleSort(event) {
        const key = event.detail;
        if (sortKey === key) sortDirection = sortDirection === 'desc' ? 'asc' : 'desc';
        else { sortKey = key; sortDirection = 'desc'; }
    }

    // --- STYLING HELPERS ---
    const themeMap = {
        blue: { header: 'bg-blue-50 border-blue-200', title: 'text-blue-800' },
        green: { header: 'bg-green-50 border-green-200', title: 'text-green-800' },
        orange: { header: 'bg-orange-50 border-orange-200', title: 'text-orange-800' },
        purple: { header: 'bg-purple-50 border-purple-200', title: 'text-purple-800' },
        teal: { header: 'bg-teal-50 border-teal-200', title: 'text-teal-800' },
    };
    $: theme = themeMap[colorTheme] || themeMap.blue;

    // Hàm lấy màu sắc cho giá trị (So sánh với Target nếu là %)
    function getValueColor(cell, targetObj) {
        if (cell.config.type === 'PERCENT') {
            // Lấy target từ config bảng hoặc goal settings (nếu có logic override)
            // Ở đây ta dùng targetId để map vào object mucTieu của nhân viên
            const targetId = cell.config.targetId;
            const targetVal = targetId && targetObj && targetObj[targetId] 
                ? parseFloat(targetObj[targetId]) 
                : 0;

            const currentVal = cell.value * 100; // Đưa về thang 100
            
            if (targetVal > 0) {
                return currentVal >= targetVal ? 'text-blue-600 font-bold' : 'text-red-600 font-bold bg-red-50';
            }
            return 'text-red-600'; // Mặc định % là màu đỏ (hoặc cam)
        }
        if (cell.config.type === 'SL') return 'text-gray-800';
        return 'text-blue-700 font-semibold'; // DT, DTQD
    }
</script>

<div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden h-full flex flex-col transition-all hover:shadow-md relative group/card">
    
    <div class="absolute top-3 right-3 opacity-0 group-hover/card:opacity-100 transition-opacity flex gap-1 z-20 bg-white/90 backdrop-blur rounded-lg p-1 shadow-sm border border-gray-100">
        {#if !config.isSystem || $isAdmin}
            <button class="p-1.5 text-gray-400 hover:text-blue-600 rounded hover:bg-blue-50" title="Sửa" on:click|stopPropagation={() => dispatch('edit', config)}>
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" /></svg>
            </button>
            <button class="p-1.5 text-gray-400 hover:text-red-600 rounded hover:bg-red-50" title="Xóa" on:click|stopPropagation={() => dispatch('delete', config.id)}>
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
            </button>
        {/if}
    </div>

    <div class="px-5 py-3 border-b {theme.header} flex justify-between items-center">
        <h4 class="text-base font-bold uppercase {theme.title} truncate flex items-center gap-2" title={config.title}>
            <i data-feather="bar-chart-2" class="w-4 h-4"></i> {config.title}
        </h4>
    </div>

    {#if sortedData.length === 0}
        <div class="flex-grow flex items-center justify-center p-8 bg-slate-50/30">
             <p class="text-gray-400 italic text-sm">Chưa có phát sinh dữ liệu.</p>
        </div>
    {:else}
        <div class="overflow-x-auto flex-grow custom-scrollbar relative">
            <table class="min-w-full text-sm border-collapse border-0">
                <thead class="bg-gray-50 text-xs uppercase text-gray-600 font-bold sticky top-0 z-20 shadow-sm">
                    <tr>
                        <SortableTh 
                            key="hoTen" 
                            label="Nhân viên" 
                            className="sticky left-0 z-30 bg-gray-100 border-r border-b border-gray-300 min-w-[150px]" 
                            {sortKey} {sortDirection} 
                            on:sort={handleSort} 
                        />
                        
                        {#each config.columns as col (col.id)}
                            {@const bgClass = col.color ? `bg-${col.color}-50` : 'bg-gray-50'}
                            {@const textClass = col.color ? `text-${col.color}-800` : 'text-gray-700'}
                            <SortableTh 
                                key={col.id} 
                                label={col.header} 
                                align="right" 
                                className="{bgClass} {textClass} border-r border-b border-gray-200 min-w-[100px]" 
                                {sortKey} {sortDirection} 
                                on:sort={handleSort} 
                            />
                        {/each}
                    </tr>
                </thead>

                <tbody class="divide-y divide-gray-100">
                    {#each sortedData as row (row.maNV)}
                        <tr class="hover:bg-blue-50/50 transition-colors group">
                            <td class="px-3 py-2 font-semibold text-gray-700 border-r border-b border-gray-300 bg-white group-hover:bg-blue-50/50 sticky left-0 z-10 whitespace-nowrap shadow-[2px_0_5px_-2px_rgba(0,0,0,0.05)]">
                                <span class="text-blue-700 text-sm block truncate" title="{row.hoTen} - {row.maNV}">
                                    {formatters.getShortEmployeeName(row.hoTen, row.maNV)}
                                </span>
                            </td>

                            {#each config.columns as col (col.id)}
                                {@const cell = row.cells[col.id]}
                                <td class="px-2 py-2 text-right border-r border-gray-200 border-b {getValueColor(cell, row.mucTieu)}">
                                    {cell ? cell.display : '-'}
                                </td>
                            {/each}
                        </tr>
                    {/each}
                </tbody>

                <tfoot class="bg-gray-100 font-bold text-gray-800 border-t-2 border-gray-300 sticky bottom-0 z-20">
                    <tr>
                        <td class="px-3 py-2 sticky left-0 bg-gray-200 z-30 border-r border-gray-300">TỔNG</td>
                        {#each config.columns as col (col.id)}
                            <td class="px-2 py-2 text-right border-r border-gray-300 bg-gray-100">
                                {totals.cells[col.id]?.display || '-'}
                            </td>
                        {/each}
                    </tr>
                </tfoot>
            </table>
        </div>
    {/if}
</div>

<style>
    .custom-scrollbar::-webkit-scrollbar { width: 6px; height: 6px; }
    .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
    .custom-scrollbar::-webkit-scrollbar-thumb { background: #e5e7eb; border-radius: 3px; }
    .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #d1d5db; }
</style>
--- END FILE: ./src/components/health-staff/performance/DynamicPerformanceTable.svelte ---

--- START FILE: ./src/components/health-staff/performance/PerformanceView.svelte ---
<script>
    import { onMount } from 'svelte';
    import { customPerformanceTables, isAdmin, modalState, selectedWarehouse } from '../../../stores.js';
    import { adminService } from '../../../services/admin.service.js';
    import { datasyncService } from '../../../services/datasync.service.js';
    
    import DynamicPerformanceTable from './DynamicPerformanceTable.svelte';

    export let reportData = [];

    let isLoading = false;
    let lastLoadedWarehouse = '';

    // --- LOGIC LOAD DỮ LIỆU ---
    $: if ($selectedWarehouse) {
        handleWarehouseDataLoad($selectedWarehouse);
    }

    async function handleWarehouseDataLoad(kho) {
        // CASE 1: Store First - Nếu đã có data đúng kho, không tải lại
        if ($customPerformanceTables.length > 0 && lastLoadedWarehouse === kho) {
             console.log(`[PerformanceView] Dùng Cache Store cho kho: ${kho}`);
             return;
        }
        // CASE 2: Fetch
        await loadData(kho);
    }

    async function loadData(kho) {
        // Chỉ hiện loading nếu store đang rỗng
        if ($customPerformanceTables.length === 0) {
            isLoading = true;
        }

        try {
            // 1. Load System Tables (Admin)
            const sysTables = await adminService.loadSystemPerformanceTables();
            
            // 2. Load Personal Tables (User)
            const perTables = await datasyncService.loadPersonalPerformanceTables(kho);

            // 3. Load trạng thái ẩn/hiện local
            const hiddenIds = JSON.parse(localStorage.getItem('hiddenPerformanceTableIds') || '[]');

            // 4. Merge
            const merged = [
                ...sysTables.map(t => ({ ...t, isSystem: true, isVisible: !hiddenIds.includes(t.id) })),
                ...perTables.map(t => ({ ...t, isSystem: false, isVisible: true }))
            ];
            
            customPerformanceTables.set(merged);
            lastLoadedWarehouse = kho;

        } catch (e) {
            console.error("[PerformanceView] Lỗi tải dữ liệu:", e);
        } finally {
            isLoading = false;
        }
    }

    // --- VISIBILITY LOGIC ---
    function toggleTableVisibility(tableId) {
        customPerformanceTables.update(items => {
            const newItems = items.map(t => t.id === tableId ? { ...t, isVisible: !t.isVisible } : t);
            
            // Save preference for System tables
            const hiddenIds = newItems.filter(t => t.isSystem && !t.isVisible).map(t => t.id);
            localStorage.setItem('hiddenPerformanceTableIds', JSON.stringify(hiddenIds));
            
            return newItems;
        });
    }

    // --- CRUD ACTIONS ---
    function openAddModal() {
        if (!$selectedWarehouse) return alert("Vui lòng chọn Kho trước.");
        // Mở modal tạo mới (User context)
        modalState.update(s => ({ ...s, activeModal: 'add-performance-table-modal', payload: null, isSystem: false }));
    }

    function editTable(table) {
        // Check quyền
        if (table.isSystem && !$isAdmin) return alert("Bạn không có quyền sửa bảng hệ thống.");
        
        modalState.update(s => ({ 
            ...s, 
            activeModal: 'add-performance-table-modal', 
            payload: table,
            isSystem: table.isSystem 
        }));
    }

    async function deleteTable(id) {
        const table = $customPerformanceTables.find(t => t.id === id);
        if (!table) return;

        if (table.isSystem) {
            if (!$isAdmin) return alert("Bạn không có quyền xóa bảng hệ thống.");
            // [FIXED] Nối dòng confirm lại thành một dòng
            if (!confirm("Xóa vĩnh viễn bảng hệ thống này?")) return;
            
            const newTables = $customPerformanceTables.filter(t => t.id !== id && t.isSystem);
            await adminService.saveSystemPerformanceTables(newTables);
        } else {
            if (!confirm("Xóa bảng cá nhân này?")) return;
            const newTables = $customPerformanceTables.filter(t => t.id !== id && !t.isSystem);
            await datasyncService.savePersonalPerformanceTables($selectedWarehouse, newTables);
        }
        // Reload local store
        customPerformanceTables.update(items => items.filter(t => t.id !== id));
    }

    $: visibleTables = $customPerformanceTables.filter(t => t.isVisible);
    const colors = ['blue', 'green', 'orange', 'purple', 'teal'];
</script>

{#if isLoading}
    <div class="flex flex-col items-center justify-center p-12 text-teal-600">
        <svg class="animate-spin h-8 w-8 mb-3" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
        </svg>
        <p class="text-sm font-semibold">Đang tải bảng hiệu quả...</p>
    </div>
{:else}

    <div class="mb-6 flex flex-wrap items-center gap-2 bg-white p-3 rounded-xl border border-gray-200 shadow-sm">
        <div class="text-xs font-bold uppercase text-gray-500 mr-2 flex items-center gap-1">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01" /></svg>
            Bảng hiển thị:
        </div>
        
        {#each $customPerformanceTables as table}
            <button 
                class="px-3 py-1.5 rounded-full text-xs font-medium border transition-all duration-200 flex items-center gap-1.5 select-none
                   {table.isVisible ? 'bg-blue-600 text-white border-blue-600 shadow-md transform -translate-y-0.5' : 'bg-gray-100 text-gray-500 border-gray-200 hover:bg-gray-200'}
                   {table.isSystem ? 'border-dashed' : ''}"
                on:click={() => toggleTableVisibility(table.id)}
                title={table.isSystem ? "Bảng hệ thống" : "Bảng cá nhân"}
            >
                {#if table.isSystem}<span class="text-[10px] opacity-70">🌐</span>{/if}
                {table.title}
            </button>
        {/each}

        <button 
            class="px-3 py-1.5 rounded-full text-xs font-bold border border-dashed border-gray-300 text-gray-500 hover:text-blue-600 hover:border-blue-400 hover:bg-blue-50 transition-colors ml-auto flex items-center gap-1"
            on:click={openAddModal}
        >
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" /></svg>
            Tạo bảng mới
        </button>
    </div>

    {#if visibleTables.length === 0}
        <div class="p-12 text-center bg-gray-50 rounded-xl border border-gray-200 border-dashed">
             <p class="text-gray-500 font-medium">Bạn đã ẩn tất cả các bảng. Vui lòng bật lại trên thanh công cụ.</p>
        </div>
    {:else}
        <div class="grid grid-cols-1 xl:grid-cols-2 gap-6 pb-10">
            {#each visibleTables as table, index (table.id)}
                <div data-capture-group="performance-table">
                    <DynamicPerformanceTable 
                        config={table} 
                        {reportData} 
                        colorTheme={colors[index % colors.length]}
                        on:edit={() => editTable(table)}
                        on:delete={() => deleteTable(table.id)}
                    />
                </div>
            {/each}
        </div>
    {/if}

{/if}
--- END FILE: ./src/components/health-staff/performance/PerformanceView.svelte ---

--- START FILE: ./src/components/health-staff/revenue/DailyPerfChart.svelte ---
<script>
  import { onMount, afterUpdate } from 'svelte';
  import { formatters } from '../../../utils/formatters.js';
  
  export let dailyStats = []; // Dữ liệu: [{ date, revenue, convertedRevenue }]

  let chartInstanceDTQD;
  let chartInstanceTLQD;
  let filterDays = 7; // Mặc định 7 ngày

  // Lọc dữ liệu dựa trên số ngày
  $: filteredData = filterDays === 'all' 
      ? dailyStats 
      : dailyStats.slice(-filterDays);

  $: labels = filteredData.map(d => new Date(d.date).toLocaleDateString('vi-VN', { day: '2-digit', month: '2-digit' }));
  $: dtqdData = filteredData.map(d => d.convertedRevenue / 1000000);
  $: tlqdData = filteredData.map(d => (d.revenue > 0 ? (d.convertedRevenue / d.revenue) - 1 : 0));

  const chartOptions = (title, isPercent = false) => ({
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
          legend: { display: false },
          tooltip: {
              callbacks: {
                  label: (context) => {
                      const val = context.raw;
                      return isPercent ? formatters.formatPercentage(val) : `${formatters.formatRevenue(val * 1000000)} Tr`;
                  }
              }
          },
          datalabels: {
              anchor: 'end', align: 'end',
              formatter: (val) => isPercent ? formatters.formatPercentage(val) : formatters.formatRevenue(val * 1000000),
              color: '#4b5563', font: { weight: 'bold', size: 10 }
          }
      },
      scales: { y: { beginAtZero: true, grace: '10%' } }
  });

  function renderCharts() {
      if (typeof Chart === 'undefined') return;

      // 1. Biểu đồ DTQĐ
      const ctxDTQD = document.getElementById('daily-dtqd-chart');
      if (ctxDTQD) {
          if (chartInstanceDTQD) chartInstanceDTQD.destroy();
          chartInstanceDTQD = new Chart(ctxDTQD, {
              type: 'bar',
              data: {
                  labels: labels,
                  datasets: [{ label: 'DTQĐ', data: dtqdData, backgroundColor: '#3b82f6', borderRadius: 4 }]
              },
              options: chartOptions('Doanh thu QĐ', false),
              plugins: [ChartDataLabels]
          });
      }

      // 2. Biểu đồ Tỷ lệ QĐ
      const ctxTLQD = document.getElementById('daily-tlqd-chart');
      if (ctxTLQD) {
          if (chartInstanceTLQD) chartInstanceTLQD.destroy();
          chartInstanceTLQD = new Chart(ctxTLQD, {
              type: 'bar',
              data: {
                  labels: labels,
                  datasets: [{ label: 'Tỷ lệ', data: tlqdData, backgroundColor: '#16a34a', borderRadius: 4 }]
              },
              options: chartOptions('Tỷ lệ QĐ', true),
              plugins: [ChartDataLabels]
          });
      }
  }

  // Render lại khi dữ liệu thay đổi
  $: if (filteredData.length > 0) {
      // Dùng setTimeout để đợi DOM cập nhật xong canvas
      setTimeout(renderCharts, 0);
  }

  function setFilter(days) {
      filterDays = days;
  }
</script>

<div class="mb-6">
    <div class="flex items-center justify-center flex-wrap gap-2 mb-4">
        <span class="text-sm font-medium text-gray-600">Xem theo:</span>
        {#each [3, 5, 7, 10, 'all'] as days}
            <button 
                class="px-3 py-1 text-xs font-medium rounded-full transition-colors 
                       {filterDays === days ? 'bg-blue-600 text-white' : 'bg-gray-200 text-gray-700 hover:bg-gray-300'}"
                on:click={() => setFilter(days)}
            >
                {days === 'all' ? 'Tất cả' : `${days} ngày`}
            </button>
        {/each}
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <div class="bg-white p-4 rounded-lg shadow-md border h-[300px]">
            <h4 class="text-md font-bold text-gray-700 mb-2 text-center">Doanh thu QĐ theo ngày (Tr)</h4>
            <div class="relative h-[240px] w-full">
                <canvas id="daily-dtqd-chart"></canvas>
            </div>
        </div>
        <div class="bg-white p-4 rounded-lg shadow-md border h-[300px]">
            <h4 class="text-md font-bold text-gray-700 mb-2 text-center">Tỷ lệ QĐ theo ngày</h4>
            <div class="relative h-[240px] w-full">
                <canvas id="daily-tlqd-chart"></canvas>
            </div>
        </div>
    </div>
</div>
--- END FILE: ./src/components/health-staff/revenue/DailyPerfChart.svelte ---

--- START FILE: ./src/components/health-staff/revenue/DynamicTableHeader.svelte ---
<script>
    import { createEventDispatcher } from 'svelte';
    import SortableTh from '../../common/SortableTh.svelte';

    export let config = {};
    export let tableMetrics = {};
    export let totalColSpan = 0;
    export let sortKey = '';
    export let sortDirection = 'desc';

    const dispatch = createEventDispatcher();

    // Helper màu sắc header phụ
    const getSubHeaderColor = (index) => {
        const colors = [
            'bg-indigo-100 text-indigo-900 border-indigo-200', 
            'bg-emerald-100 text-emerald-900 border-emerald-200', 
            'bg-amber-100 text-amber-900 border-amber-200', 
            'bg-rose-100 text-rose-900 border-rose-200', 
            'bg-cyan-100 text-cyan-900 border-cyan-200'
        ];
        return colors[index % colors.length];
    };

    function handleSort(event) {
        dispatch('sort', event.detail);
    }

    function handleManualSort(key) {
        dispatch('manualSort', key);
    }
</script>

<thead class="bg-gray-50 text-xs uppercase text-gray-600 font-bold sticky top-0 z-20 shadow-sm">
    <tr>
        <th 
            class="px-4 py-2 pl-5 min-w-[180px] sticky left-0 z-30 bg-gray-100 border-r border-b border-gray-300 shadow-[2px_0_5px_-2px_rgba(0,0,0,0.1)] cursor-pointer hover:bg-gray-200 transition select-none text-left"
            rowspan="2"
            on:click={() => handleManualSort('hoTen')}
        >
            <div class="flex items-center gap-1 justify-start">
                <span class="font-bold uppercase text-xs {sortKey === 'hoTen' ? 'text-blue-800' : 'text-slate-700'}">Nhân viên</span>
                <span class="flex flex-col items-center justify-center w-4 h-4">
                    {#if sortKey !== 'hoTen'}
                        <svg xmlns="http://www.w3.org/2000/svg" class="w-3 h-3 text-gray-400 opacity-50" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M7 16V4m0 0L3 8m4-4l4 4m6 0v12m0 0l4-4m-4 4l-4-4" /></svg>
                    {:else if sortDirection === 'asc'}
                        <svg xmlns="http://www.w3.org/2000/svg" class="w-3.5 h-3.5 text-blue-700" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="3"><path stroke-linecap="round" stroke-linejoin="round" d="M5 15l7-7 7 7" /></svg>
                    {:else}
                        <svg xmlns="http://www.w3.org/2000/svg" class="w-3.5 h-3.5 text-blue-700" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="3"><path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7" /></svg>
                    {/if}
                </span>
            </div>
        </th>
        
        {#if totalColSpan > 0}
            <th colspan={totalColSpan} class="px-2 py-2 text-center border-b border-r border-gray-300 text-gray-900 bg-gray-200">
                TỔNG HỢP
            </th>
        {/if}

        {#each config.subColumns as col, index}
            {@const metrics = col.metrics || { sl: false, dt: true, dtqd: false }}
            {@const colSpan = (metrics.sl ? 1 : 0) + (metrics.dt ? 1 : 0) + (metrics.dtqd ? 1 : 0)}
            {#if colSpan > 0}
                <th colspan={colSpan} class="px-2 py-2 text-center border-b border-r border-gray-200 {getSubHeaderColor(index)}">
                    {col.header}
                </th>
            {/if}
        {/each}
    </tr>

    <tr>
        {#if tableMetrics.sl}
            <SortableTh key="totalSL" label="SL" align="right" className="min-w-[60px] text-gray-700 bg-gray-100 border-r border-gray-300 border-b" {sortKey} {sortDirection} on:sort={handleSort} />
        {/if}
        {#if tableMetrics.dt}
                <SortableTh key="mainValue" label="DT" align="right" className="min-w-[80px] text-blue-800 bg-gray-100 border-r border-gray-300 border-b" {sortKey} {sortDirection} on:sort={handleSort} />
        {/if}
        {#if tableMetrics.dtqd}
                <SortableTh key="totalDTQD" label="QĐ" align="right" className="min-w-[80px] text-purple-800 bg-gray-100 border-r border-gray-300 border-b" {sortKey} {sortDirection} on:sort={handleSort} />
        {/if}

        {#each config.subColumns as col}
            {@const metrics = col.metrics || { sl: false, dt: true, dtqd: false }}
            {#if metrics.sl}
                <SortableTh key={`${col.header}|sl`} label="SL" align="right" className="min-w-[60px] text-gray-500 bg-white border-r border-gray-200 border-b" {sortKey} {sortDirection} on:sort={handleSort} />
            {/if}
            {#if metrics.dt}
                <SortableTh key={`${col.header}|dt`} label="DT" align="right" className="min-w-[80px] text-blue-600 bg-white border-r border-gray-200 border-b" {sortKey} {sortDirection} on:sort={handleSort} />
            {/if}
            {#if metrics.dtqd}
                <SortableTh key={`${col.header}|dtqd`} label="QĐ" align="right" className="min-w-[80px] text-purple-600 bg-white border-r border-gray-200 border-b" {sortKey} {sortDirection} on:sort={handleSort} />
            {/if}
        {/each}
    </tr>
</thead>
--- END FILE: ./src/components/health-staff/revenue/DynamicTableHeader.svelte ---

--- START FILE: ./src/components/health-staff/revenue/DynamicTableRow.svelte ---
<script>
    import { formatters } from '../../../utils/formatters.js';

    export let item = {}; // Dữ liệu 1 dòng (đã processed)
    export let config = {};
    export let tableMetrics = {}; // { sl, dt, dtqd }

    // Tính toán trước để tránh logic trong template
    $: columns = config.subColumns || [];
</script>

<tr class="hover:bg-blue-50/50 transition-colors group">
    <td class="px-5 py-2 font-semibold text-gray-700 border-r border-b border-gray-300 bg-white group-hover:bg-blue-50/50 sticky left-0 z-10 whitespace-nowrap shadow-[2px_0_5px_-2px_rgba(0,0,0,0.05)]">
        <span class="text-blue-700">{formatters.getShortEmployeeName(item.hoTen, item.maNV)}</span>
    </td>
    
    {#if tableMetrics.sl}
        <td class="px-2 py-2 text-right font-bold text-gray-800 bg-gray-50/50 border-r border-gray-300 border-b">
            {formatters.formatNumber(item.cells?.mainValue?.value_sl || item.mainValue_sl)}
        </td>
    {/if}
    {#if tableMetrics.dt}
        <td class="px-2 py-2 text-right font-bold text-blue-800 bg-gray-50/50 border-r border-gray-300 border-b">
            {formatters.formatRevenue(item.cells?.mainValue?.value || item.mainValue)}
        </td>
    {/if}
    {#if tableMetrics.dtqd}
        <td class="px-2 py-2 text-right font-bold text-purple-800 bg-gray-50/50 border-r border-gray-300 border-b">
            {formatters.formatRevenue(item.cells?.mainValue?.value_dtqd || item.mainValue_dtqd)}
        </td>
    {/if}

    {#each columns as col}
        {@const cell = item.cells ? (item.cells[col.id] || item.cells[col.header]) : null}
        {@const metrics = col.metrics || { sl: false, dt: true, dtqd: false }}
        
        {#if metrics.sl}
            <td class="px-2 py-2 text-right border-r border-gray-200 border-b text-gray-600" title={cell?.tooltip}>
                {formatters.formatNumber(cell?.value_sl || cell?.sl)}
            </td>
        {/if}
        {#if metrics.dt}
            <td class="px-2 py-2 text-right border-r border-gray-200 border-b font-medium text-gray-800" title={cell?.tooltip}>
                {formatters.formatRevenue(cell?.value || cell?.dt)}
            </td>
        {/if}
        {#if metrics.dtqd}
            <td class="px-2 py-2 text-right border-r border-gray-200 border-b font-medium text-purple-600" title={cell?.tooltip}>
                {formatters.formatRevenue(cell?.value_dtqd || cell?.dtqd)}
            </td>
        {/if}
    {/each}
</tr>
--- END FILE: ./src/components/health-staff/revenue/DynamicTableRow.svelte ---

--- START FILE: ./src/components/health-staff/revenue/RevenueDetailView.svelte ---
<script>
  import { createEventDispatcher } from 'svelte';
  import { masterReportData, ycxData, modalState } from '../../../stores.js'; // [FIX] Import modalState
  import { reportService } from '../../../services/reportService.js';
  import { settingsService } from '../../../services/settings.service.js';
  import { formatters } from '../../../utils/formatters.js';
  
  import DetailHeader from '../detail/DetailHeader.svelte';
  import RevenueKpiBoard from './RevenueKpiBoard.svelte';
  import DailyPerfChart from './DailyPerfChart.svelte';
  import RevenueTopGroups from './RevenueTopGroups.svelte';

  export let employeeId;
  const dispatch = createEventDispatcher();

  let detailData = null;
  let employeeData = null;
  let goals = {};

  $: if (employeeId && $ycxData.length > 0) {
      employeeData = $masterReportData.sknv.find(e => String(e.maNV) === String(employeeId));

      if (employeeData) {
          const settings = settingsService.getLuykeGoalSettings(employeeData.maKho);
          goals = settings.goals || {};
          detailData = reportService.generateLuyKeEmployeeDetailReport(employeeId, $ycxData);
      }
  }

  function goBack() { dispatch('back'); }

  // [MỚI] Hàm xử lý mở Modal
  function openUnexportedModal() {
      if (detailData && detailData.unexportedDetails) {
          modalState.update(s => ({ 
              ...s, 
              activeModal: 'unexported-detail-modal',
              payload: { unexportedDetails: detailData.unexportedDetails }
          }));
      }
  }

  function openOrdersModal() {
      if (detailData && detailData.byCustomer) {
          modalState.update(s => ({ 
              ...s, 
              activeModal: 'customer-detail-modal',
              payload: { 
                  customers: detailData.byCustomer,
                  mucTieu: employeeData.mucTieu
              }
          }));
      }
  }
</script>

<div class="animate-fade-in pb-10 max-w-7xl mx-auto">
    <div class="mb-4 flex justify-between items-center">
        <button on:click={goBack} class="text-blue-600 hover:underline font-semibold flex items-center gap-1">
            <i data-feather="chevron-left" class="w-4 h-4"></i> Quay lại bảng tổng hợp
        </button>
    </div>

    {#if employeeData && detailData}
        <DetailHeader employee={employeeData} showStats={false} />
        
        <RevenueKpiBoard 
            summary={detailData.summary} 
            {goals} 
            on:viewUnexported={openUnexportedModal}
            on:viewOrders={openOrdersModal}
        />
        
        <DailyPerfChart dailyStats={detailData.dailyStats} />
        
        <RevenueTopGroups 
            topProductGroups={detailData.topProductGroups} 
            categoryChartData={detailData.categoryChartData} 
        />

    {:else}
        <div class="p-12 text-center bg-red-50 rounded-lg border border-red-200">
            <p class="text-red-600 font-semibold">Không tìm thấy dữ liệu chi tiết cho nhân viên này.</p>
        </div>
    {/if}
</div>

<style>
    .animate-fade-in { animation: fadeIn 0.3s ease-out; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
</style>
--- END FILE: ./src/components/health-staff/revenue/RevenueDetailView.svelte ---

--- START FILE: ./src/components/health-staff/revenue/RevenueKpiBoard.svelte ---
<script>
  import { createEventDispatcher } from 'svelte';
  import { formatters } from '../../../utils/formatters.js';

  export let summary = {};
  export let goals = {};

  const dispatch = createEventDispatcher();

  // Tính toán target
  $: targetQD = (goals?.phanTramQD || 0);
  $: isPositive = (summary.conversionRate * 100) >= targetQD;
</script>

<div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-4 mb-6">
    <div class="bg-white p-4 rounded-lg shadow border border-gray-100 text-center">
        <div class="text-sm text-gray-500 font-medium uppercase">Tổng DT Thực</div>
        <div class="text-xl font-bold text-blue-600 mt-1">{formatters.formatRevenue(summary.totalRealRevenue, 1)}</div>
    </div>

    <div class="bg-white p-4 rounded-lg shadow border border-gray-100 text-center">
        <div class="text-sm text-gray-500 font-medium uppercase">Tổng DTQĐ</div>
        <div class="text-xl font-bold text-purple-600 mt-1">{formatters.formatRevenue(summary.totalConvertedRevenue, 1)}</div>
    </div>

    <div class="bg-white p-4 rounded-lg shadow border border-gray-100 text-center">
        <div class="text-sm text-gray-500 font-medium uppercase">Tỷ lệ QĐ</div>
        <div class="text-xl font-bold mt-1 {isPositive ? 'text-green-600' : 'text-red-600'}">
            {formatters.formatPercentage(summary.conversionRate)}
        </div>
    </div>

    <div 
        class="bg-white p-4 rounded-lg shadow border border-gray-100 text-center cursor-pointer hover:bg-yellow-50 transition-colors hover:shadow-md"
        on:click={() => dispatch('viewUnexported')}
    >
        <div class="text-sm text-gray-500 font-medium uppercase flex items-center justify-center gap-1">
            DT Chưa Xuất <i data-feather="external-link" class="w-3 h-3"></i>
        </div>
        <div class="text-xl font-bold text-yellow-600 mt-1">{formatters.formatRevenue(summary.unexportedRevenue, 1)}</div>
    </div>

    <div 
        class="bg-white p-4 rounded-lg shadow border border-gray-100 text-center cursor-pointer hover:bg-blue-50 transition-colors hover:shadow-md"
        on:click={() => dispatch('viewOrders')}
    >
        <div class="text-sm text-gray-500 font-medium uppercase flex items-center justify-center gap-1">
            Tổng Đơn <i data-feather="external-link" class="w-3 h-3"></i>
        </div>
        <div class="text-xl font-bold text-gray-800 mt-1">{summary.totalOrders}</div>
    </div>

    <div class="bg-white p-4 rounded-lg shadow border border-gray-100 text-center">
        <div class="text-sm text-gray-500 font-medium uppercase">Đơn Bán Kèm</div>
        <div class="text-xl font-bold text-gray-800 mt-1">{summary.bundledOrderCount}</div>
    </div>
</div>
--- END FILE: ./src/components/health-staff/revenue/RevenueKpiBoard.svelte ---

--- START FILE: ./src/components/health-staff/revenue/RevenueTopGroups.svelte ---
<script>
  import { onMount } from 'svelte';
  import { formatters } from '../../../utils/formatters.js';
  import { getRandomBrightColor } from '../../../utils.js';

  export let topProductGroups = [];
  export let categoryChartData = [];

  let chartInstance;

  // 1. Top 5 Nhóm hàng
  $: top5Groups = topProductGroups.slice(0, 5);
  $: maxRevenue = top5Groups.length > 0 ? top5Groups[0].realRevenue : 0;

  // 2. Biểu đồ
  function renderPieChart() {
      const ctx = document.getElementById('revenue-category-chart');
      if (!ctx || !categoryChartData.length) return;

      if (chartInstance) chartInstance.destroy();

      // Sort và lấy top 10 cho biểu đồ
      const sortedChartData = [...categoryChartData].sort((a, b) => b.revenue - a.revenue).slice(0, 10);

      chartInstance = new Chart(ctx, {
          type: 'bar',
          data: {
              labels: sortedChartData.map(d => d.name),
              datasets: [{
                  label: 'Doanh thu',
                  data: sortedChartData.map(d => d.revenue / 1000000),
                  backgroundColor: sortedChartData.map(() => getRandomBrightColor()),
                  borderRadius: 4,
              }]
          },
          options: {
              indexAxis: 'x',
              responsive: true,
              maintainAspectRatio: false,
              plugins: {
                  legend: { display: false },
                  tooltip: {
                      callbacks: { label: ctx => `${ctx.label}: ${formatters.formatRevenue(ctx.raw * 1000000)}` }
                  },
                  datalabels: {
                      anchor: 'end', align: 'end',
                      formatter: (val) => formatters.formatRevenue(val * 1000000),
                      color: '#4b5563', font: { weight: 'bold', size: 10 }
                  }
              },
              scales: { y: { beginAtZero: true, grace: '10%' } }
          },
          plugins: [ChartDataLabels]
      });
  }

  $: if (categoryChartData.length > 0) {
      setTimeout(renderPieChart, 0);
  }
</script>

<div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
    <div class="bg-white p-4 rounded-lg shadow-md border">
        <h4 class="text-md font-bold text-gray-700 border-b pb-2 mb-3">Top 5 Nhóm Hàng Doanh Thu Cao</h4>
        {#if top5Groups.length === 0}
            <p class="text-sm text-gray-500">Không có dữ liệu.</p>
        {:else}
            <div class="space-y-4">
                {#each top5Groups as group}
                    {@const percent = maxRevenue > 0 ? (group.realRevenue / maxRevenue) * 100 : 0}
                    <div>
                        <div class="flex justify-between items-end mb-1">
                            <div>
                                <span class="font-semibold text-sm block">{group.name}</span>
                                <span class="text-xs text-gray-500">SL: {formatters.formatNumber(group.quantity)} | %QĐ: {formatters.formatPercentage(group.conversionRate)}</span>
                            </div>
                            <div class="text-right">
                                <div class="text-sm font-bold text-gray-800">{formatters.formatRevenue(group.realRevenue)}</div>
                                <div class="text-xs text-blue-600 font-medium">{formatters.formatRevenue(group.convertedRevenue)} (QĐ)</div>
                            </div>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-2">
                            <div class="bg-blue-600 h-2 rounded-full transition-all duration-500" style="width: {percent}%"></div>
                        </div>
                    </div>
                {/each}
            </div>
        {/if}
    </div>

    <div class="bg-white p-4 rounded-lg shadow-md border">
        <h4 class="text-md font-bold text-gray-700 mb-2">Tỷ Trọng Doanh Thu Ngành Hàng</h4>
        <div class="relative h-[300px] w-full">
            <canvas id="revenue-category-chart"></canvas>
        </div>
    </div>
</div>
--- END FILE: ./src/components/health-staff/revenue/RevenueTopGroups.svelte ---

--- START FILE: ./src/components/health-staff/shared/EvaluationBadge.svelte ---
<script>
  export let isAbove = false;
</script>

<span class="px-2 py-0.5 rounded text-[10px] font-bold uppercase tracking-wide {isAbove ? 'bg-green-100 text-green-700' : 'bg-yellow-100 text-yellow-700'}">
  {isAbove ? 'Trên TB' : 'Dưới TB'}
</span>
--- END FILE: ./src/components/health-staff/shared/EvaluationBadge.svelte ---

--- START FILE: ./src/components/health-staff/shared/MedalIcon.svelte ---
<script>
  export let rank = 0; // 0: Base (Index + 1)

  // Logic màu sắc cho Top 3
  const isGold = rank === 1;
  const isSilver = rank === 2;
  const isBronze = rank === 3;
  const isStandard = rank > 3;
</script>

<div class="relative w-12 h-12 flex-shrink-0 -ml-2 -mt-2">
  {#if isGold}
    <svg viewBox="0 0 100 100" class="w-full h-full drop-shadow-sm absolute top-0 left-0 z-10">
        <defs><linearGradient id="gold-grad" x1="0%" y1="0%" x2="0%" y2="100%"><stop offset="0%" stop-color="#FFDF00"/><stop offset="100%" stop-color="#FFB800"/></linearGradient></defs>
        <path d="M 20 75 L 35 95 L 35 75 L 50 90 L 65 75 L 65 95 L 80 75 L 50 85 Z" fill="#E53935"/>
        <circle cx="50" cy="45" r="38" fill="#BDBDBD"/><circle cx="50" cy="45" r="35" fill="url(#gold-grad)"/>
        <circle cx="50" cy="45" r="28" fill="#FFC107" stroke="#FFFFFF" stroke-width="2"/>
    </svg>
  {:else if isSilver}
    <svg viewBox="0 0 100 100" class="w-full h-full drop-shadow-sm absolute top-0 left-0 z-10">
        <defs><linearGradient id="silver-grad" x1="0%" y1="0%" x2="0%" y2="100%"><stop offset="0%" stop-color="#F5F5F5"/><stop offset="100%" stop-color="#B0BEC5"/></linearGradient></defs>
        <path d="M 20 75 L 35 95 L 35 75 L 50 90 L 65 75 L 65 95 L 80 75 L 50 85 Z" fill="#E53935"/>
        <circle cx="50" cy="45" r="38" fill="#78909C"/><circle cx="50" cy="45" r="35" fill="url(#silver-grad)"/>
        <circle cx="50" cy="45" r="28" fill="#B0BEC5" stroke="#FFFFFF" stroke-width="2"/>
    </svg>
  {:else if isBronze}
    <svg viewBox="0 0 100 100" class="w-full h-full drop-shadow-sm absolute top-0 left-0 z-10">
        <defs><linearGradient id="bronze-grad" x1="0%" y1="0%" x2="0%" y2="100%"><stop offset="0%" stop-color="#FFCC80"/><stop offset="100%" stop-color="#D84315"/></linearGradient></defs>
        <path d="M 20 75 L 35 95 L 35 75 L 50 90 L 65 75 L 65 95 L 80 75 L 50 85 Z" fill="#E53935"/>
        <circle cx="50" cy="45" r="38" fill="#A1887F"/><circle cx="50" cy="45" r="35" fill="url(#bronze-grad)"/>
        <circle cx="50" cy="45" r="28" fill="#D84315" stroke="#FFFFFF" stroke-width="2"/>
    </svg>
  {:else}
    <div class="sknv-card__avatar--standard">
        <span class="sknv-card__avatar-rank">{rank}</span>
    </div>
  {/if}
  
  {#if !isStandard}
      <div class="absolute top-0 left-0 w-full h-[90%] flex items-center justify-center z-20">
        <span class="sknv-card__avatar-rank text-white text-lg font-bold">{rank}</span>
      </div>
  {/if}
</div>
--- END FILE: ./src/components/health-staff/shared/MedalIcon.svelte ---

--- START FILE: ./src/components/health-staff/shared/UMedalIcon.svelte ---
<script>
  export let rank = 0; // 0: Base (Index + 1)

  // Logic màu sắc cho Top 3
  const isGold = rank === 1;
  const isSilver = rank === 2;
  const isBronze = rank === 3;
</script>

<div class="relative w-12 h-12 flex-shrink-0 -ml-2 -mt-2">
  {#if isGold}
    <svg viewBox="0 0 100 100" class="w-full h-full drop-shadow-sm">
        <defs><linearGradient id="gold-grad" x1="0%" y1="0%" x2="0%" y2="100%"><stop offset="0%" stop-color="#FFDF00"/><stop offset="100%" stop-color="#FFB800"/></linearGradient></defs>
        <path d="M 20 75 L 35 95 L 35 75 L 50 90 L 65 75 L 65 95 L 80 75 L 50 85 Z" fill="#E53935"/>
        <circle cx="50" cy="45" r="38" fill="#BDBDBD"/><circle cx="50" cy="45" r="35" fill="url(#gold-grad)"/>
        <circle cx="50" cy="45" r="28" fill="#FFC107" stroke="#FFFFFF" stroke-width="2"/>
    </svg>
  {:else if isSilver}
    <svg viewBox="0 0 100 100" class="w-full h-full drop-shadow-sm">
        <defs><linearGradient id="silver-grad" x1="0%" y1="0%" x2="0%" y2="100%"><stop offset="0%" stop-color="#F5F5F5"/><stop offset="100%" stop-color="#B0BEC5"/></linearGradient></defs>
        <path d="M 20 75 L 35 95 L 35 75 L 50 90 L 65 75 L 65 95 L 80 75 L 50 85 Z" fill="#E53935"/>
        <circle cx="50" cy="45" r="38" fill="#78909C"/><circle cx="50" cy="45" r="35" fill="url(#silver-grad)"/>
        <circle cx="50" cy="45" r="28" fill="#B0BEC5" stroke="#FFFFFF" stroke-width="2"/>
    </svg>
  {:else if isBronze}
    <svg viewBox="0 0 100 100" class="w-full h-full drop-shadow-sm">
        <defs><linearGradient id="bronze-grad" x1="0%" y1="0%" x2="0%" y2="100%"><stop offset="0%" stop-color="#FFCC80"/><stop offset="100%" stop-color="#D84315"/></linearGradient></defs>
        <path d="M 20 75 L 35 95 L 35 75 L 50 90 L 65 75 L 65 95 L 80 75 L 50 85 Z" fill="#E53935"/>
        <circle cx="50" cy="45" r="38" fill="#A1887F"/><circle cx="50" cy="45" r="35" fill="url(#bronze-grad)"/>
        <circle cx="50" cy="45" r="28" fill="#D84315" stroke="#FFFFFF" stroke-width="2"/>
    </svg>
  {:else}
    <div class="w-12 h-12 rounded-full bg-gray-200 flex items-center justify-center border-4 border-white shadow-sm">
        </div>
  {/if}
  
  <div class="absolute top-0 left-0 w-full h-[90%] flex items-center justify-center z-10">
    <span class="text-lg font-bold {rank <= 3 ? 'text-white' : 'text-gray-600'}">{rank}</span>
  </div>
</div>
--- END FILE: ./src/components/health-staff/shared/UMedalIcon.svelte ---

--- START FILE: ./src/components/health-staff/summary/DepartmentGroup.svelte ---
<script>
  import EmployeeCard from './card/EmployeeCard.svelte';
  
  export let departmentName;
  export let employees = [];
  
  // Priority styling cho "Tư Vấn - ĐM"
  $: isPriority = departmentName.includes('Tư Vấn');
  $: headerClass = isPriority 
    ? 'bg-blue-50 text-blue-800 border-blue-200' 
    : 'bg-gray-50 text-gray-700 border-gray-200';
</script>

<div class="mb-8 last:mb-0">
  <div class="flex items-center gap-3 px-4 py-3 rounded-t-lg border-b-2 {headerClass}">
    <h3 class="text-lg font-bold uppercase tracking-wide">{departmentName}</h3>
    <span class="bg-white/50 px-2 py-0.5 rounded text-xs font-bold">{employees.length} NV</span>
  </div>
  
  <div class="p-4 bg-slate-50/30 border-x border-b border-gray-200 rounded-b-lg">
    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4">
      {#each employees as emp, index (emp.maNV)}
        <EmployeeCard employee={emp} rank={index + 1} on:click />
      {/each}
    </div>
  </div>
</div>
--- END FILE: ./src/components/health-staff/summary/DepartmentGroup.svelte ---

--- START FILE: ./src/components/health-staff/summary/SummaryView.svelte ---
<script>
  import DepartmentGroup from './DepartmentGroup.svelte';
  
  // [FIX LỖI QUAN TRỌNG]
  // Sai: import { utils } from '../../../utils.js';
  // Đúng: Import tất cả hàm (*) và đặt tên là 'utils'
  import * as utils from '../../../utils.js'; 
  
  export let reportData = [];

  // Gom nhóm nhân viên theo bộ phận
  $: groupedData = reportData.reduce((acc, item) => {
      const dept = item.boPhan || 'Khác';
      if (!acc[dept]) acc[dept] = [];
      acc[dept].push(item);
      return acc;
  }, {});

  // Sắp xếp thứ tự bộ phận (Ưu tiên Tư Vấn)
  // Hàm này nằm trong utils.js, giờ gọi qua namespace 'utils' sẽ hoạt động
  $: departmentOrder = utils.getSortedDepartmentList(reportData);
</script>

<div class="animate-fade-in pb-10">
  {#if reportData.length === 0}
    <div class="p-12 text-center bg-gray-50 rounded-lg border border-gray-200">
      <p class="text-gray-500">Không có dữ liệu hiệu suất để hiển thị.</p>
    </div>
  {:else}
    {#each departmentOrder as deptName}
      {#if groupedData[deptName]}
        {@const sortedEmployees = [...groupedData[deptName]].sort((a, b) => b.totalAbove - a.totalAbove)}
        <DepartmentGroup 
          departmentName={deptName} 
          employees={sortedEmployees} 
          on:click 
        />
      {/if}
    {/each}
  {/if}
</div>

<style>
  .animate-fade-in { animation: fadeIn 0.5s ease-out; }
  @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
</style>
--- END FILE: ./src/components/health-staff/summary/SummaryView.svelte ---

--- START FILE: ./src/components/health-staff/summary/card/CardHeader.svelte ---
<script>
  import { formatters } from '../../../../utils/formatters.js';
  export let hoTen;
  export let maNV;
  export let boPhan;
  export let rank = 999; // [MỚI] Nhận rank để check Top 3

  // Logic màu tên: Top 3 màu xanh dương đậm, còn lại màu đen xám
  $: nameColorClass = rank <= 3 ? 'text-blue-700 font-extrabold' : 'text-gray-900 font-bold';
</script>

<div class="flex-grow min-w-0 ml-3">
  <p class="{nameColorClass} text-base truncate leading-tight" title="{hoTen} - {maNV}">
    {formatters.getShortEmployeeName(hoTen, maNV)}
  </p>
  <p class="text-xs text-gray-500 truncate">{boPhan}</p>
</div>
--- END FILE: ./src/components/health-staff/summary/card/CardHeader.svelte ---

--- START FILE: ./src/components/health-staff/summary/card/CardMainKpi.svelte ---
<script>
  export let aboveCount = 0;
  export let totalCount = 0;

  $: percentage = totalCount > 0 ? aboveCount / totalCount : 0;
  $: colorClass = percentage >= 0.7 ? 'text-green-600' : percentage >= 0.4 ? 'text-yellow-500' : 'text-red-500';
  $: borderColorClass = percentage >= 0.7 ? 'border-t-green-500' : percentage >= 0.4 ? 'border-t-yellow-500' : 'border-t-red-500';
</script>

<div class="text-center py-2 border-t-4 {borderColorClass} bg-slate-50/50 mt-2">
  <div class="flex items-baseline justify-center gap-1">
    <span class="text-3xl font-extrabold {colorClass} leading-none">{aboveCount}</span>
    <span class="text-sm font-bold text-gray-400">/ {totalCount}</span>
  </div>
  <span class="text-[10px] uppercase font-bold text-gray-500 tracking-wider">Chỉ số đạt</span>
</div>
--- END FILE: ./src/components/health-staff/summary/card/CardMainKpi.svelte ---

--- START FILE: ./src/components/health-staff/summary/card/CardSubKpiGrid.svelte ---
<script>
  export let summary; 

  // Định nghĩa màu nền cố định cho từng loại thẻ (Style đồng bộ)
  const groups = [
    { key: 'doanhthu', label: 'Doanh Thu', icon: 'trending-up', bgClass: 'bg-blue-50 border-blue-100 text-blue-800' },
    { key: 'nangsuat', label: 'Năng Suất', icon: 'dollar-sign', bgClass: 'bg-green-50 border-green-100 text-green-800' },
    { key: 'hieuqua', label: 'Hiệu Quả', icon: 'award', bgClass: 'bg-orange-50 border-orange-100 text-orange-800' },
    { key: 'dongia', label: 'Đơn Giá', icon: 'tag', bgClass: 'bg-purple-50 border-purple-100 text-purple-800' }
  ];
</script>

<div class="grid grid-cols-2 gap-2 px-3 pb-3 pt-1 border-t border-gray-100">
  {#each groups as g}
    {@const data = summary[g.key]}
    {@const ratio = data.total > 0 ? data.above / data.total : 0}
    
    {@const valueColor = ratio > 0.5 ? 'text-blue-600' : 'text-red-600'}
    
    <div class="flex items-center justify-between p-1.5 rounded border {g.bgClass}">
      <div class="flex items-center gap-1">
        <i data-feather={g.icon} class="w-3 h-3 opacity-70"></i>
        <span class="text-[10px] font-bold uppercase opacity-90">{g.label}</span>
      </div>
      <span class="text-xs font-extrabold {valueColor}">{data.above}/{data.total}</span>
    </div>
  {/each}
</div>
--- END FILE: ./src/components/health-staff/summary/card/CardSubKpiGrid.svelte ---

--- START FILE: ./src/components/health-staff/summary/card/EmployeeCard.svelte ---
<script>
  import MedalIcon from '../../shared/MedalIcon.svelte';
  import CardHeader from './CardHeader.svelte';
  import CardMainKpi from './CardMainKpi.svelte';
  import CardSubKpiGrid from './CardSubKpiGrid.svelte';
  import { createEventDispatcher } from 'svelte';

  export let employee;
  export let rank; // 1, 2, 3...

  const dispatch = createEventDispatcher();
  
  $: summary = employee.summary;
  $: totalAbove = employee.totalAbove;
  $: totalCriteria = employee.totalCriteria;

  function handleClick() {
    dispatch('click', { employeeId: employee.maNV });
  }
</script>

<div 
  class="bg-white rounded-xl border border-gray-200 shadow-sm hover:shadow-md hover:-translate-y-1 transition-all cursor-pointer overflow-hidden relative group"
  on:click={handleClick}
  role="button"
  tabindex="0"
>
  <div class="p-3 flex items-start relative z-10">
    <MedalIcon {rank} />
    <CardHeader hoTen={employee.hoTen} maNV={employee.maNV} boPhan={employee.boPhan} {rank} />
  </div>

  <CardMainKpi aboveCount={totalAbove} totalCount={totalCriteria} />
  <CardSubKpiGrid {summary} />
</div>
--- END FILE: ./src/components/health-staff/summary/card/EmployeeCard.svelte ---

--- START FILE: ./src/components/luyke/LuykeCategoryTable.svelte ---
<script>
  import { onMount, afterUpdate } from 'svelte';
  import { formatters } from '../../utils/formatters.js';
  import { cleanCategoryName } from '../../utils.js';
  import { macroCategoryConfig } from '../../stores.js'; 
  import { adminService } from '../../services/admin.service.js';
  
  import LuykeCategoryCharts from './sub/LuykeCategoryCharts.svelte';
  import LuykeCategoryToolbar from './sub/LuykeCategoryToolbar.svelte';

  export let items = []; 
  export let unexportedItems = []; 
  export let rawSource = []; 
  export let numDays = 1;

  // --- STATE ---
  let showUnexported = false;
  let viewMode = 'grid'; 
  let searchText = '';
  let sortMode = 'revenue_desc';
  
  let isSettingsOpen = false;
  let filterSearch = '';
  let hiddenCategories = new Set(); 

  const STORAGE_KEY = 'luyke_category_direct_v1';

  onMount(async () => {
      // 1. Load Filter State
      const saved = localStorage.getItem(STORAGE_KEY);
      if (saved) {
          try { hiddenCategories = new Set(JSON.parse(saved)); } 
          catch (e) { console.error(e); }
      }

      // 2. Load Config
      if (!$macroCategoryConfig || $macroCategoryConfig.length === 0) {
          try {
              if (typeof adminService.loadMacroCategoryConfig === 'function') {
                  const configs = await adminService.loadMacroCategoryConfig();
                  macroCategoryConfig.set(configs);
              }
          } catch (e) { console.error("Lỗi load config:", e); }
      }
  });

  function saveHiddenState() {
      localStorage.setItem(STORAGE_KEY, JSON.stringify([...hiddenCategories]));
  }

  // --- THEME ---
  $: titleText = showUnexported ? "CHI TIẾT CHƯA XUẤT (QĐ)" : (viewMode === 'grid' ? "CHI TIẾT NGÀNH HÀNG" : "TỶ TRỌNG NGÀNH HÀNG");
  $: titleIcon = showUnexported ? "alert-circle" : (viewMode === 'grid' ? "grid" : "pie-chart");
  $: titleClass = showUnexported ? "text-orange-700" : "text-gray-700";
  $: iconClass = showUnexported ? "text-orange-600" : "text-blue-600";

  function getCategoryTheme(name) {
      const n = name ? name.toLowerCase() : '';
      if (n.includes('điện tử') || n.includes('tivi')) return { icon: 'tv', theme: 'theme-teal' };
      if (n.includes('máy giặt') || n.includes('sấy')) return { icon: 'disc', theme: 'theme-blue' };
      if (n.includes('máy lạnh') || n.includes('điều hòa')) return { icon: 'wind', theme: 'theme-blue' };
      if (n.includes('tủ lạnh') || n.includes('tủ đông')) return { icon: 'server', theme: 'theme-blue' };
      if (n.includes('lọc nước')) return { icon: 'droplet', theme: 'theme-blue' };
      if (n.includes('laptop') || n.includes('pc')) return { icon: 'monitor', theme: 'theme-teal' };
      if (n.includes('điện thoại') || n.includes('smartphone')) return { icon: 'smartphone', theme: 'theme-blue' };
      if (n.includes('gia dụng') || n.includes('bếp')) return { icon: 'home', theme: 'theme-orange' };
      if (n.includes('phụ kiện')) return { icon: 'headphones', theme: 'theme-purple' };
      if (n.includes('đồng hồ')) return { icon: 'watch', theme: 'theme-gray' };
      return { icon: 'tag', theme: 'theme-gray' };
  }

  // --- LOGIC MỚI: TRỰC TIẾP & SONG SONG ---
  $: sourceData = showUnexported ? unexportedItems : items;

  // 1. Tạo danh sách Filter (Gộp cả Macro và Simple)
  $: allGroups = (() => {
      // Macro Items
      const macroItems = ($macroCategoryConfig || []).map(m => ({
          key: m.name, // Key là tên nhóm lớn
          label: m.name,
          type: 'macro'
      })).sort((a, b) => a.label.localeCompare(b.label));

      // Simple Items
      const simpleItemsMap = new Map();
      sourceData.forEach((i, index) => {
          const name = i.name || i.nganhHang;
          const safeKey = i.id || name || `unknown_${index}`;
          if (name) {
              simpleItemsMap.set(safeKey, { key: safeKey, label: name, type: 'simple' });
          }
      });
      const simpleItems = Array.from(simpleItemsMap.values()).sort((a, b) => a.label.localeCompare(b.label));

      return [...macroItems, ...simpleItems];
  })();

  $: filterList = allGroups.filter(g => 
      g.label.toLowerCase().includes(filterSearch.toLowerCase())
  );

  function toggleCategoryVisibility(event) {
      const key = event.detail;
      if (hiddenCategories.has(key)) hiddenCategories.delete(key);
      else hiddenCategories.add(key);
      hiddenCategories = new Set(hiddenCategories);
      saveHiddenState();
  }

  function toggleAllVisibility(event) {
      const show = event.detail;
      hiddenCategories = show ? new Set() : new Set(allGroups.map(g => g.key));
      saveHiddenState();
  }

  // 2. Logic Aggregation: KHÔNG BÙ TRỪ. Có gì hiện nấy.
  $: aggregatedItems = (() => {
      const result = [];
      const macroConfigs = $macroCategoryConfig || [];

      // A. Tính toán Nhóm Lớn (Macro) - Luôn tính toán và thêm vào nếu không bị ẩn
      macroConfigs.forEach(macro => {
          if (!hiddenCategories.has(macro.name)) {
              // Tìm con khớp
              const keywords = (macro.items || []).map(k => k.toLowerCase());
              const childItems = sourceData.filter(item => {
                  const iName = (item.name || item.nganhHang || '').toLowerCase();
                  const iId = (item.id || '').toLowerCase();
                  return keywords.some(k => iName.includes(k) || iId === k);
              });

              if (childItems.length > 0) {
                  result.push({
                      id: `MACRO_${macro.name}`, // ID riêng
                      name: macro.name,
                      isMacro: true,
                      revenue: childItems.reduce((sum, i) => sum + (i.revenue || 0), 0),
                      doanhThuQuyDoi: childItems.reduce((sum, i) => sum + (i.doanhThuQuyDoi || 0), 0),
                      quantity: childItems.reduce((sum, i) => sum + (i.quantity || i.soLuong || 0), 0),
                      soLuong: childItems.reduce((sum, i) => sum + (i.soLuong || 0), 0)
                  });
              }
          }
      });

      // B. Thêm Ngành Hàng Lẻ (Simple) - Luôn thêm vào nếu không bị ẩn
      sourceData.forEach((item, index) => {
          const name = item.name || item.nganhHang || 'Chưa đặt tên';
          const safeId = item.id || name || `ITEM_${index}`;
          
          if (!hiddenCategories.has(safeId) && !hiddenCategories.has(name)) {
              result.push({
                  ...item,
                  id: safeId,
                  name: name,
                  isMacro: false
              });
          }
      });

      return result;
  })();

  $: gridDisplayItems = aggregatedItems.filter(item => {
      const name = item.name || '';
      return !searchText || name.toLowerCase().includes(searchText.toLowerCase());
  });

  $: sortedItems = [...gridDisplayItems].sort((a, b) => {
      const getRev = (i) => showUnexported ? (i.doanhThuQuyDoi || 0) : (i.revenue || 0);
      const getQty = (i) => showUnexported ? (i.soLuong || 0) : (i.quantity || 0);
      
      if (sortMode === 'revenue_desc') return getRev(b) - getRev(a);
      if (sortMode === 'quantity_desc') return getQty(b) - getQty(a);
      if (sortMode === 'name_asc') return (a.name || '').localeCompare(b.name || '');
      return 0;
  });

  $: totalRevenue = sourceData.reduce((sum, item) => sum + (showUnexported ? (item.doanhThuQuyDoi || 0) : (item.revenue || 0)), 0);
  $: maxVal = Math.max(...sortedItems.map(i => showUnexported ? (i.doanhThuQuyDoi || 0) : (i.revenue || 0)), 1);

  // --- CHART DATA (Sửa lại logic Top Hãng theo Filter) ---
  $: pieData = (() => {
      const sorted = aggregatedItems
          .filter(i => (showUnexported ? i.doanhThuQuyDoi : i.revenue) > 0)
          .sort((a, b) => (showUnexported ? b.doanhThuQuyDoi - a.doanhThuQuyDoi : b.revenue - a.revenue));
      if (sorted.length <= 14) return sorted;
      const top13 = sorted.slice(0, 13);
      const others = sorted.slice(13);
      const otherRevenue = others.reduce((sum, item) => sum + (showUnexported ? item.doanhThuQuyDoi : item.revenue), 0);
      return [...top13, { name: 'Khác', revenue: otherRevenue }];
  })();

  // [FIX CHART] Truyền config vào để bung nhóm lớn ra khi lọc
  $: barData = calculateBrandData(rawSource, aggregatedItems, $macroCategoryConfig); 

  function calculateBrandData(source, visibleItems, configs) {
      if (!source || source.length === 0) return [];
      
      // 1. Xây dựng tập hợp các tên ngành hàng con "được phép hiện"
      const allowedNames = new Set();
      
      visibleItems.forEach(item => {
          if (item.isMacro) {
              // Nếu là nhóm lớn, tìm config và thêm tất cả các con của nó vào list cho phép
              const conf = (configs || []).find(c => c.name === item.name);
              if (conf && conf.items) {
                  conf.items.forEach(k => allowedNames.add(cleanCategoryName(k)));
              }
          } else {
              // Nếu là ngành lẻ, thêm chính nó
              allowedNames.add(cleanCategoryName(item.name || item.nganhHang));
          }
      });

      // 2. Lọc Source và tính Brand
      const brands = {};
      source.forEach(row => {
          const rowCatName = cleanCategoryName(row.nganhHang || '');
          // Chỉ lấy nếu ngành hàng của row này nằm trong danh sách cho phép
          if (allowedNames.has(rowCatName)) {
              const brandName = row.nhaSanXuat || 'Khác';
              const revenue = parseFloat(String(row.thanhTien || "0").replace(/,/g, '')) || 0;
              if (!brands[brandName]) brands[brandName] = { name: brandName, revenue: 0 };
              brands[brandName].revenue += revenue;
          }
      });
      
      return Object.values(brands).sort((a, b) => b.revenue - a.revenue).slice(0, 15);
  }

  function handleWindowClick(e) {
      if (isSettingsOpen && !e.target.closest('.filter-wrapper')) {
          isSettingsOpen = false;
      }
  }
  
  afterUpdate(() => { if (typeof feather !== 'undefined') feather.replace(); });
</script>

<svelte:window on:click={handleWindowClick} />

<div class="luyke-tier-2-container">
    <LuykeCategoryToolbar
        {titleText} {titleIcon} {titleClass} {iconClass}
        bind:viewMode
        bind:showUnexported
        bind:sortMode
        bind:searchText
        bind:isSettingsOpen
        bind:filterSearch
        {filterList} 
        {hiddenCategories}
        on:toggleCategory={toggleCategoryVisibility}
        on:toggleAll={toggleAllVisibility}
    />

    <style>
        /* Tăng max-height và thêm scroll cho body của dropdown */
        :global(.filter-dropdown) {
            display: flex;
            flex-direction: column;
            max-height: 400px; /* Giới hạn chiều cao tổng */
        }
        :global(.filter-body) {
            flex: 1;
            overflow-y: auto; /* Cho phép cuộn nội dung */
            min-height: 0;
        }
        :global(.filter-actions) {
            flex-shrink: 0; /* Nút bottom không bị co lại */
            border-top: 1px solid #eee;
        }
    </style>

    {#if viewMode === 'grid'}
        {#if sortedItems.length === 0}
            <div class="p-12 text-center bg-white border border-gray-200 border-t-0 rounded-b-xl">
                <p class="text-gray-500">{showUnexported ? 'Không có đơn hàng chưa xuất.' : 'Không có dữ liệu hiển thị.'}</p>
            </div>
        {:else}
            <div class="luyke-cat-grid p-4 bg-white border border-gray-200 border-t-0 rounded-b-xl">
                {#each sortedItems as item (item.id)}
                    {@const name = item.name}
                    {@const revenue = showUnexported ? item.doanhThuQuyDoi : item.revenue}
                    {@const quantity = showUnexported ? item.soLuong : item.quantity}
                    {@const style = getCategoryTheme(name)}
                    {@const marketSharePercent = totalRevenue > 0 ? (revenue / totalRevenue) * 100 : 0}
                    {@const barPercent = maxVal > 0 ? (revenue / maxVal) * 100 : 0}
                    
                    {@const finalTheme = showUnexported ? 'theme-warning' : (item.isMacro ? 'bg-indigo-50 border-indigo-200 ring-1 ring-indigo-100' : style.theme)}
                    {@const iconName = item.isMacro ? 'layers' : style.icon}
                    {@const textColor = item.isMacro ? 'text-indigo-800' : ''}

                    <div class="cat-card-colorful {finalTheme}">
                        <div class="cat-top-row">
                            <div class="cat-icon-box {item.isMacro ? 'bg-indigo-100 text-indigo-600' : ''}">
                                <i data-feather={iconName} class="w-5 h-5"></i>
                            </div>
                            {#if !showUnexported}
                                <span class="cat-percent-text text-xs {item.isMacro ? 'text-indigo-600' : ''}">
                                    {formatters.formatPercentage(marketSharePercent/100)}
                                </span>
                            {/if}
                        </div>
                        
                        <h4 class="cat-name-text {textColor}" title={name}>
                            {name} 
                            {#if item.isMacro}<span class="text-[10px] bg-white border px-1 rounded text-gray-500 ml-1 font-normal">GỘP</span>{/if}
                        </h4>
                        
                        <div class="cat-value-text {textColor}">{formatters.formatRevenue(revenue,0)}</div>
                        
                        <div class="cat-footer-row">
                            <span>SL: <strong>{formatters.formatNumber(quantity)}</strong></span>
                            {#if !showUnexported}
                                <span>TB: <strong>{formatters.formatNumber(quantity/numDays, 0)}</strong>/ngày</span>
                            {/if}
                        </div>
                        
                        <div class="cat-bar-bg">
                            <div class="cat-bar-fill {item.isMacro ? 'bg-indigo-500' : ''}" style="width: {barPercent}%"></div>
                        </div>
                    </div>
                {/each}
            </div>
        {/if}
    {:else}
        <LuykeCategoryCharts 
            {pieData} 
            {barData} 
            {showUnexported} 
        />
    {/if}
</div>
--- END FILE: ./src/components/luyke/LuykeCategoryTable.svelte ---

--- START FILE: ./src/components/luyke/LuykeEfficiencyTable.svelte ---
<script>
  import { afterUpdate, createEventDispatcher, onMount } from 'svelte';
  import { formatters } from '../../utils/formatters.js';

  export let items = []; 
  export let dynamicItems = [];
  export let supermarketData = {}; 
  
  const dispatch = createEventDispatcher();

  let isSettingsOpen = false;
  let filterSearch = '';
  let hiddenIds = new Set(); 

  const STORAGE_KEY = 'luyke_efficiency_hidden_ids';

  onMount(() => {
      const saved = localStorage.getItem(STORAGE_KEY);
      if (saved) {
          try { hiddenIds = new Set(JSON.parse(saved)); } catch (e) {}
      }
  });

  function saveHiddenState() {
      localStorage.setItem(STORAGE_KEY, JSON.stringify([...hiddenIds]));
  }

  const iconMap = {
      'pctPhuKien': 'headphones', 'pctGiaDung': 'home', 'pctMLN': 'droplet',
      'pctSim': 'cpu', 'pctVAS': 'layers', 'pctBaoHiem': 'shield', 'tyLeTraCham': 'credit-card'
  };

  $: displayItems = [
     
      ...items,
      ...(dynamicItems || []).map(cfg => {
          const metric = supermarketData.dynamicMetrics?.[cfg.id];
          return {
              id: cfg.id,
              label: cfg.label,
              value: metric ? metric.value : 0,
              target: cfg.target, // Target từ config admin
              isDynamic: true,
              rawConfig: cfg
        
          };
      })
  ];

  $: filterList = displayItems.filter(item => item.label.toLowerCase().includes(filterSearch.toLowerCase()));
  $: visibleItems = displayItems.filter(item => !hiddenIds.has(item.id));

  function toggleVisibility(id) {
      if (hiddenIds.has(id)) hiddenIds.delete(id); else hiddenIds.add(id);
      hiddenIds = new Set(hiddenIds);
      saveHiddenState();
  }

  function toggleAllVisibility(show) {
      hiddenIds = show ? new Set() : new Set(displayItems.map(i => i.id));
      saveHiddenState();
  }

  // [LOGIC MỚI] Màu sắc dựa trên Mục tiêu: Xanh dương (Đạt) - Đỏ (Không đạt)
  function getProgressColor(val, target) {
      const t = (target || 0) / 100;
      if (t <= 0) return '#3b82f6'; // Mặc định xanh dương nếu ko có target
      return val >= t ? '#2563eb' : '#ef4444'; // Blue-600 nếu đạt, Red-500 nếu rớt
  }

  function handleWindowClick(e) {
      if (isSettingsOpen && !e.target.closest('.filter-wrapper')) 
        isSettingsOpen = false;
  }
  
  function handleDelete(id) {
      if(confirm('Bạn có chắc muốn xóa chỉ số này?')) dispatch('delete', id);
  }

  afterUpdate(() => { if (typeof feather !== 'undefined') feather.replace(); });
</script>

<svelte:window on:click={handleWindowClick} />
<div class="luyke-widget h-full">
  <div class="luyke-widget-header">
    <div class="luyke-widget-title">
      <div class="p-1.5 bg-blue-100 rounded text-blue-600 mr-2">
          <i data-feather="bar-chart-2" class="w-4 h-4"></i>
      </div>
      <span>Hiệu Quả Khai Thác</span>
    </div>
    <div class="flex items-center gap-2">
        <button class="text-blue-600 hover:bg-blue-50 p-1.5 rounded text-xs font-bold flex items-center gap-1 border border-blue-200" on:click={() => dispatch('add')} title="Thêm chỉ số mới">
            <i data-feather="plus" class="w-3 h-3"></i> Thêm
 
        </button>
        <div class="relative filter-wrapper">
            <button class="luyke-icon-btn {isSettingsOpen ? 'active' : ''}" on:click={() => isSettingsOpen = !isSettingsOpen}><i data-feather="filter" class="w-4 h-4"></i></button>
            {#if isSettingsOpen}
                <div class="filter-dropdown">
                    <div class="filter-header"><input type="text" class="filter-search" placeholder="Tìm chỉ số..." bind:value={filterSearch} /></div>
                    <div class="filter-body custom-scrollbar" style="max-height: 250px;">
                 
                        {#each filterList as item (item.id)}
                            <div class="filter-item" on:click={() => toggleVisibility(item.id)}>
                                <input type="checkbox" checked={!hiddenIds.has(item.id)} /> <label>{item.label}</label>
                            </div>
                        {/each}
           
                    </div>
                    <div class="filter-actions">
                        <button class="filter-btn-link" on:click={() => toggleAllVisibility(true)}>Hiện tất cả</button>
                        <button class="filter-btn-link text-red-600" on:click={() => toggleAllVisibility(false)}>Ẩn tất cả</button>
                    </div>
                </div>
            {/if}
   
        </div>
    </div>
  </div>

  <div class="luyke-widget-body custom-scrollbar">
    {#if visibleItems.length === 0}
       <div class="flex flex-col items-center justify-center h-full text-gray-400"><p class="text-sm">Đã ẩn hết dữ liệu.</p></div>
    {:else}
      <div class="flex flex-col gap-0">
        {#each visibleItems as item (item.id)}
          {@const targetVal = (item.target || 0) / 100}
          {@const color = getProgressColor(item.value, item.target)}
          {@const percent = Math.min((item.value * 100), 100)}
          
          <div class="eff-item-compact group relative hover:bg-gray-50 transition-colors">
     
            <div class="eff-icon-compact"><i data-feather={iconMap[item.id] || 'activity'} class="w-4 h-4"></i></div>
            <div class="eff-content-compact">
                <div class="eff-row-top">
                    <span class="eff-label-text">{item.label}</span>
                    <div class="flex items-center gap-2">
                        {#if item.target > 0}
                            <span class="text-[10px] text-gray-400 font-medium whitespace-nowrap">- Mục tiêu : {item.target}%</span>
                        {/if}
                        <span class="eff-value-text" style="color: {color}">{formatters.formatPercentage(item.value)}</span>
                    </div>
                </div>
                <div class="eff-row-bottom">
                    <div class="eff-bar-container">
 
                        <div class="eff-bar-fill" style="width: {percent}%; background-color: {color};"></div>
                    </div>
                    </div>
 
            </div>
            {#if item.isDynamic}
                <div class="absolute right-2 top-2 hidden group-hover:flex gap-1 bg-white shadow-sm border border-gray-200 rounded p-1 z-10">
                    <button on:click|stopPropagation={() => dispatch('edit', item.rawConfig)} class="text-gray-500 hover:text-blue-600 p-1"><i data-feather="edit-2" class="w-3 h-3"></i></button>
                    <button on:click|stopPropagation={() => handleDelete(item.id)} class="text-gray-500 hover:text-red-600 p-1"><i data-feather="trash-2" class="w-3 h-3"></i></button>
                </div>
            {/if}
  
         </div>
        {/each}
      </div>
    {/if}
  </div>
</div>
--- END FILE: ./src/components/luyke/LuykeEfficiencyTable.svelte ---

--- START FILE: ./src/components/luyke/LuykeQdcTable.svelte ---
<script>
  import { onMount, afterUpdate } from 'svelte';
  import { formatters } from '../../utils/formatters.js';
  import { cleanCategoryName } from '../../utils.js';
  import { 
      categoryStructure, 
      macroProductGroupConfig, 
      selectedWarehouse 
  } from '../../stores.js';
  import { datasyncService } from '../../services/datasync.service.js';
  import { adminService } from '../../services/admin.service.js';

  export let items = []; 
  export let numDays = 1;

  let isSettingsOpen = false;
  let filterSearch = '';
  let saveTimer;
  let localConfig = []; 

  // [MỚI] Bảng màu rực rỡ cho thanh tiến trình
  const BAR_COLORS = [
      'bg-red-500',       // Đỏ
      'bg-orange-500',    // Cam
      'bg-amber-500',     // Vàng hổ phách
      'bg-yellow-400',    // Vàng chanh
      'bg-lime-500',      // Xanh chanh
      'bg-green-500',     // Xanh lá
      'bg-emerald-500',   // Xanh ngọc
      'bg-teal-500',      // Xanh cổ vịt
      'bg-cyan-500',      // Xanh da trời nhạt
      'bg-sky-500',       // Xanh bầu trời
      'bg-blue-500',      // Xanh dương
      'bg-indigo-500',    // Chàm
      'bg-violet-500',    // Tím
      'bg-fuchsia-500',   // Hồng tím
      'bg-pink-500',      // Hồng
      'bg-rose-500'       // Hồng đỏ
  ];

  // 1. Load config
  onMount(async () => {
      if (!$macroProductGroupConfig || $macroProductGroupConfig.length === 0) {
          try {
              const configs = await adminService.loadMacroProductGroupConfig();
              macroProductGroupConfig.set(configs);
          } catch (e) {
              console.error("Lỗi load Macro Product Groups:", e);
          }
      }
  });

  // 2. Tạo danh sách Filter
  $: allGroups = (() => {
      const macroNames = ($macroProductGroupConfig || []).map(m => ({
          name: m.name,
          type: 'macro'
      })).sort((a, b) => a.name.localeCompare(b.name));

      const structureNames = new Set(($categoryStructure || []).map(c => cleanCategoryName(c.nhomHang)).filter(Boolean));
      const presentNames = new Set(items.map(i => i.name).filter(Boolean));
      
      const simpleNames = [...new Set([...structureNames, ...presentNames])]
          .sort()
          .map(name => ({
              name: name,
              type: 'simple'
          }));

      return [...macroNames, ...simpleNames];
  })();

  $: filterList = allGroups.filter(g => 
      g.name.toLowerCase().includes(filterSearch.toLowerCase())
  );

  // 3. Logic Load/Save Config
  $: if ($selectedWarehouse) {
      loadConfigForWarehouse($selectedWarehouse);
  } else {
      localConfig = allGroups.map(g => g.name);
  }

  async function loadConfigForWarehouse(kho) {
      try {
          const savedConfig = await datasyncService.loadQdcConfig(kho);
          if (savedConfig && Array.isArray(savedConfig)) {
              localConfig = savedConfig;
          } else {
              localConfig = allGroups.map(g => g.name);
          }
      } catch (e) {
          localConfig = allGroups.map(g => g.name);
      }
  }

  function toggleQdcSelection(name) {
      if (localConfig.includes(name)) {
          localConfig = localConfig.filter(n => n !== name);
      } else {
          localConfig = [...localConfig, name];
      }
      
      clearTimeout(saveTimer);
      saveTimer = setTimeout(() => {
          if ($selectedWarehouse) {
              datasyncService.saveQdcConfig($selectedWarehouse, localConfig);
          }
      }, 500); 
  }

  function toggleAllVisibility(show) {
      if (show) {
          localConfig = allGroups.map(g => g.name);
      } else {
          localConfig = [];
      }
      if ($selectedWarehouse) {
         datasyncService.saveQdcConfig($selectedWarehouse, localConfig);
      }
  }

  // 4. Aggregation Logic
  $: sortedItems = (() => {
      if (localConfig.length === 0) return [];

      let finalResults = [];
      const macroConfigs = $macroProductGroupConfig || [];
      
      const selectedMacros = localConfig.filter(name => macroConfigs.some(m => m.name === name));
      const selectedSimples = localConfig.filter(name => !macroConfigs.some(m => m.name === name));

      selectedMacros.forEach(macroName => {
          const config = macroConfigs.find(m => m.name === macroName);
          if (!config) return;

          const childIds = new Set(config.items || []);
          const childItems = items.filter(i => childIds.has(i.id));

          if (childItems.length > 0) {
              const aggregatedItem = {
                  id: config.id, 
                  name: config.name,
                  isMacro: true, 
                  dtqd: childItems.reduce((sum, i) => sum + (i.dtqd || 0), 0),
                  dt: childItems.reduce((sum, i) => sum + (i.dt || 0), 0),
                  quantity: childItems.reduce((sum, i) => sum + (i.quantity || i.sl || 0), 0),
                  _children: childItems 
              };
              finalResults.push(aggregatedItem);
          } 
      });

      selectedSimples.forEach(simpleName => {
          const item = items.find(i => i.name === simpleName);
          if (item) {
              finalResults.push({ ...item, isMacro: false });
          }
      });

      return finalResults.sort((a, b) => (b.dtqd || 0) - (a.dtqd || 0));
  })();

  $: maxVal = sortedItems.length > 0 ? (sortedItems[0].dtqd || 1) : 1;

  function handleWindowClick(e) {
      if (isSettingsOpen && !e.target.closest('.filter-wrapper')) {
          isSettingsOpen = false;
      }
  }

  afterUpdate(() => {
    if (typeof feather !== 'undefined') feather.replace();
  });
</script>

<svelte:window on:click={handleWindowClick} />

<div class="luyke-widget h-full flex flex-col">
  <div class="luyke-widget-header">
    <div class="luyke-widget-title">
      <div class="p-1.5 bg-yellow-100 rounded text-yellow-600 mr-2">
          <i data-feather="star" class="w-4 h-4"></i>
      </div>
      <span>TOP NHÓM HÀNG</span>
    </div>

    <div class="relative filter-wrapper">
        <button class="luyke-icon-btn {isSettingsOpen ? 'active' : ''}" on:click={() => isSettingsOpen = !isSettingsOpen} title="Chọn nhóm hàng">
             <i data-feather="filter" class="w-4 h-4"></i>
        </button>
        {#if isSettingsOpen}
            <div class="filter-dropdown">
                <div class="filter-header">
                    <input type="text" class="filter-search" placeholder="Tìm nhóm hàng..." bind:value={filterSearch} />
                </div>
                <div class="filter-body custom-scrollbar" style="max-height: 250px;">
                    {#if filterList.length === 0}
                         <p class="text-xs text-gray-500 text-center p-2">Không tìm thấy.</p>
                    {:else}
                        {#each filterList as group}
                            {@const isChecked = localConfig.includes(group.name)}
                            <div class="filter-item" on:click={() => toggleQdcSelection(group.name)}>
                                 <input type="checkbox" checked={isChecked} />
                                 {#if group.type === 'macro'}
                                    <label class="{isChecked ? 'font-bold text-teal-700' : 'text-teal-600 font-semibold'} flex items-center gap-1">
                                        <i data-feather="layers" class="w-3 h-3"></i>
                                        {group.name}
                                    </label>
                                 {:else}
                                    <label class="{isChecked ? 'font-bold text-blue-700' : ''}">{group.name}</label>
                                 {/if}
                            </div>
                        {/each}
                    {/if}
                 </div>
                <div class="filter-actions">
                    <button class="filter-btn-link" on:click={() => toggleAllVisibility(true)}>Hiện tất cả</button>
                    <button class="filter-btn-link text-red-600" on:click={() => toggleAllVisibility(false)}>Ẩn tất cả</button>
                </div>
            </div>
        {/if}
    </div>
  </div>

  <div class="luyke-widget-body custom-scrollbar">
    {#if sortedItems.length === 0}
        <div class="flex flex-col items-center justify-center h-full text-gray-400 py-10">
          <p class="text-sm">Không có dữ liệu hiển thị.</p>
          {#if items.length > 0}
             <p class="text-xs mt-1">Hãy kiểm tra bộ lọc nhóm hàng.</p>
          {/if}
       </div>
    {:else}
      <div class="flex flex-col gap-0">
        {#each sortedItems as item, index (item.name)}
          {@const percent = maxVal > 0 ? (item.dtqd / maxVal) * 100 : 0}
          
          {@const barColor = BAR_COLORS[index % BAR_COLORS.length]}
          
          <div class="py-2 border-b border-dashed border-gray-100 last:border-0 transition-colors px-1 
                      {item.isMacro ? 'bg-teal-50/30 hover:bg-teal-50/50' : 'hover:bg-gray-50'}">
            
            <div class="flex items-center gap-3">
               <div class="w-6 text-center font-bold text-gray-400 text-xs">#{index + 1}</div>
                <div class="flex-grow min-w-0">
                   <div class="flex justify-between items-center mb-1">
                       <span class="text-sm font-semibold truncate pr-2 flex items-center gap-1 {item.isMacro ? 'text-teal-800' : 'text-gray-700'}" title={item.name}>
                           {#if item.isMacro}
                                <i data-feather="layers" class="w-3 h-3 text-teal-600"></i>
                           {/if}
                           {item.name}
                       </span>
                       <span class="text-sm font-bold whitespace-nowrap text-gray-800">
                           {formatters.formatRevenue(item.dtqd)}
                       </span>
                   </div>
                   
                   <div class="w-full h-2 bg-gray-100 rounded-full overflow-hidden mb-1 shadow-inner">
                        <div class="h-full rounded-full {barColor} shadow-sm transition-all duration-500 ease-out" style="width: {percent}%"></div>
                   </div>
                   
                   <div class="flex justify-between text-[10px] text-gray-500 flex-wrap gap-y-1">
                       <div class="flex gap-2">
                           <span>DT: <strong>{formatters.formatRevenue(item.dt)}</strong></span>
                           <span class="{item.isMacro ? 'text-teal-600' : 'text-blue-600'}">QĐ: <strong>{formatters.formatRevenue(item.dtqd)}</strong></span>
                       </div>
                       <div class="flex gap-2">
                           <span>SL: {formatters.formatNumber(item.quantity || item.sl)}</span>
                           <span>TB: <strong>{formatters.formatNumber((item.quantity || item.sl) / numDays, 0)}</strong>/ngày</span>
                       </div>
                    </div>
               </div>
            </div>
          </div>
        {/each}
      </div>
    {/if}
  </div>
</div>
--- END FILE: ./src/components/luyke/LuykeQdcTable.svelte ---

--- START FILE: ./src/components/luyke/LuykeSieuThi.svelte ---
<script>
  import { onMount, afterUpdate } from 'svelte';
  import { 
    competitionData, 
    selectedWarehouse,
    interfaceSettings,
    macroCategoryConfig,
    macroProductGroupConfig, 
    efficiencyConfig,
    qdcConfigStore,
    modalState,
    categoryNameMapping,
    warehouseCustomMetrics
  } from '../../stores.js';
  import { formatters } from '../../utils/formatters.js';
  import { reportService } from '../../services/reportService.js';
  import { settingsService } from '../../services/settings.service.js';
  import { dataProcessing } from '../../services/dataProcessing.js';
  import { adminService } from '../../services/admin.service.js';
  import { datasyncService } from '../../services/datasync.service.js';
  import * as utils from '../../utils.js';
  
  import LuykeEfficiencyTable from './LuykeEfficiencyTable.svelte';
  import LuykeQdcTable from './LuykeQdcTable.svelte';
  import LuykeCategoryTable from './LuykeCategoryTable.svelte';

  export let supermarketReport = {};
  export let filteredYCXData = []; 
  export let goals = {};
  export let numDays = 1;

  let localSupermarketReport = {};
  let localGoals = {};
  let luykeCardData = {};
  let competitionSummary = { dat: 0, total: 0 };
  let comparisonData = { value: 0, percentage: 'N/A' };
  let luotKhachData = { value: 0, percentage: 'N/A' };
  
  let chuaXuatReport = [];
  let categoryItems = []; 
  let qdcItems = []; 

  let channelStats = {
      dxm: { val: 0, pct: 0 },
      tgdd: { val: 0, pct: 0 }
  };

  let combinedEfficiencyItems = [];

  onMount(async () => {
      const savedEffConfig = await adminService.loadEfficiencyConfig();
      if(savedEffConfig.length > 0) efficiencyConfig.set(savedEffConfig);
      
      const savedQdcConfig = await adminService.loadQdcConfig();
      if(savedQdcConfig.length > 0) qdcConfigStore.set(savedQdcConfig);
  });

  $: if ($selectedWarehouse) {
      loadLocalMetrics($selectedWarehouse);
  }

  async function loadLocalMetrics(kho) {
      const localData = await datasyncService.loadCustomMetrics(kho);
      warehouseCustomMetrics.set(localData);
  }

  $: combinedEfficiencyItems = [
      ...($efficiencyConfig || []).map(i => ({ 
          ...i, 
          isSystem: true,
          target: goals?.[i.id] || i.target 
      })),
      ...($warehouseCustomMetrics || []).map(i => ({ 
          ...i, 
          isSystem: false,
          target: goals?.[i.id] || i.target 
      }))
  ];

  const cleanValue = (str) => {
      if (typeof str === 'number') return str;
      if (!str || typeof str !== 'string') return 0;
      const cleanStr = str.replace(/,|%/g, '').trim();
      const val = parseFloat(cleanStr);
      return isNaN(val) ? 0 : val;
  };

  $: {
    const _triggerMacroCat = $macroCategoryConfig;
    const _triggerMacroProd = $macroProductGroupConfig;
    const _triggerEff = $efficiencyConfig;
    const _triggerMap = $categoryNameMapping;
    const _triggerLocalEff = $warehouseCustomMetrics;

    localSupermarketReport = supermarketReport || {};
    localGoals = goals || {};

    const pastedText = typeof localStorage !== 'undefined' ? localStorage.getItem('daily_paste_luyke') : '';
    const pastedData = dataProcessing.parseLuyKePastedData(pastedText || '');
    const { mainKpis, dtDuKien, dtqdDuKien, dtTraCham, tyLeTraCham } = pastedData;
    
    const hasPasteData = mainKpis && mainKpis['Thực hiện DT thực'];

    comparisonData = pastedData.comparisonData || { value: 0, percentage: 'N/A' };
    luotKhachData = pastedData.luotKhachData || { value: 0, percentage: 'N/A' };

    const excelData = {
        dtThuc: localSupermarketReport.doanhThu || 0,
        dtQd: localSupermarketReport.doanhThuQuyDoi || 0,
        dtGop: localSupermarketReport.doanhThuTraGop || 0,
        tyLeGop: localSupermarketReport.tyLeTraCham || 0,
        tyLeQd: localSupermarketReport.hieuQuaQuyDoi || 0,
        chuaXuatQd: localSupermarketReport.doanhThuQuyDoiChuaXuat || 0
    };

    let finalDtThuc, finalDtQd, finalDtGop, finalTyLeGop, finalTyLeQd;

    if (hasPasteData) {
        finalDtThuc = cleanValue(mainKpis['Thực hiện DT thực']) * 1000000;
        finalDtQd = cleanValue(mainKpis['Thực hiện DTQĐ']) * 1000000;
        finalDtGop = dtTraCham * 1000000;
        finalTyLeGop = tyLeTraCham / 100;
        finalTyLeQd = finalDtThuc > 0 ? ((finalDtQd / finalDtThuc) - 1) : 0;
    } else {
        finalDtThuc = excelData.dtThuc;
        finalDtQd = excelData.dtQd;
        finalDtGop = excelData.dtGop;
        finalTyLeGop = excelData.tyLeGop;
        finalTyLeQd = excelData.tyLeQd;
    }

    const targetThuc = parseFloat(localGoals?.doanhThuThuc || 0) * 1000000;
    const targetQD = parseFloat(localGoals?.doanhThuQD || 0) * 1000000;
    
    let phanTramTargetQd = 0;
    if (hasPasteData && mainKpis['% HT Target Dự Kiến (QĐ)']) {
         phanTramTargetQd = cleanValue(mainKpis['% HT Target Dự Kiến (QĐ)']) / 100;
    } else {
          phanTramTargetQd = targetQD > 0 ? ((dtqdDuKien * 1000000) / targetQD) : 0;
    }

    const phanTramTargetThuc = targetThuc > 0 ? ((dtDuKien * 1000000) / targetThuc) : 0;
    
    const compData = $competitionData || [];
    competitionSummary.total = compData.length;
    competitionSummary.dat = compData.filter(d => (parseFloat(String(d.hoanThanh).replace('%','')) || 0) >= 100).length;
    const tyLeThiDuaDat = competitionSummary.total > 0 ? competitionSummary.dat / competitionSummary.total : 0;

    luykeCardData = {
      dtThucLK: finalDtThuc,
      dtQdLK: finalDtQd,
      phanTramQd: finalTyLeQd,
      dtGop: finalDtGop,
      phanTramGop: finalTyLeGop,
      dtThucDuKien: dtDuKien * 1000000, 
      dtQdDuKien: dtqdDuKien * 1000000, 
      phanTramTargetQd: phanTramTargetQd, 
      phanTramTargetThuc: phanTramTargetThuc, 
      chuaXuatQuyDoi: excelData.chuaXuatQd,
      tyLeThiDuaDat: tyLeThiDuaDat
    };

    // [FIX] Cập nhật logic tính Tỷ trọng kênh theo ID
    const calcChannelStat = (keywords) => {
        // Tìm nhóm cấu hình (Macro Group) dựa trên tên (VD: ĐMX, TGDD)
        const groupConfig = ($macroCategoryConfig || []).find(g => {
            if (!g.name) return false;
            const normName = g.name.trim().toLowerCase().normalize("NFC");
            return keywords.some(k => normName.includes(k));
        });

        if (!groupConfig || !groupConfig.items) return 0;

        const details = localSupermarketReport.nganhHangChiTiet || {};
        let totalVal = 0;

        // groupConfig.items bây giờ chứa ID (ví dụ '1491', '42'...)
        groupConfig.items.forEach(itemId => {
            // Tra cứu trực tiếp trong details bằng ID
            // (Vì data đã được xử lý trong salesProcessor.js với key là ID)
            if (details[itemId]) {
                totalVal += (details[itemId].revenueQuyDoi || 0);
            }
        });
        return totalVal;
    };

    const valDXM = calcChannelStat(['đmx', 'dmx', 'dien may xanh']);
    const valTGDD = calcChannelStat(['tgdd', 'the gioi di dong']);
    const totalChannelRevenue = (valDXM + valTGDD) || 1; 

    channelStats = {
        dxm: { val: valDXM, pct: valDXM / totalChannelRevenue },
        tgdd: { val: valTGDD, pct: valTGDD / totalChannelRevenue }
    };

    chuaXuatReport = reportService.generateLuyKeChuaXuatReport(filteredYCXData);
    
    qdcItems = Object.entries(localSupermarketReport.nhomHangChiTiet || {})
      .map(([id, values]) => ({ 
          id: id,
          name: values.name, // Lấy tên từ object value
          dtqd: values.revenueQuyDoi, 
          sl: values.quantity, 
          dt: values.revenue, 
          ...values 
      }));

    categoryItems = Object.entries(localSupermarketReport.nganhHangChiTiet || {})
      .map(([id, values]) => ({ 
          id: id,
          name: values.name, // Lấy tên từ object value
          dtqd: values.revenueQuyDoi, 
          ...values 
      }));
  }

  function openAddEffModal() {
      modalState.update(s => ({ ...s, activeModal: 'add-efficiency-modal', payload: null }));
  }

  function handleEditEffConfig(event) {
      modalState.update(s => ({ ...s, activeModal: 'add-efficiency-modal', payload: event.detail }));
  }

  async function handleDeleteEffConfig(event) {
      const id = event.detail;
      const isSystem = $efficiencyConfig.some(i => i.id === id);
      
      if (isSystem) {
          alert("Đây là chỉ số hệ thống, bạn không thể xóa. Hãy dùng bộ lọc để ẩn nó đi.");
          return;
      }

      if (confirm("Xóa chỉ số cá nhân này?")) {
          const newLocalMetrics = $warehouseCustomMetrics.filter(i => i.id !== id);
          warehouseCustomMetrics.set(newLocalMetrics);
          if ($selectedWarehouse) {
              await datasyncService.saveCustomMetrics($selectedWarehouse, newLocalMetrics);
          }
      }
  }

  afterUpdate(() => {
    if (typeof feather !== 'undefined') feather.replace();
  });
</script>

<div class="luyke-dashboard-container">
  
  <div>
      <h2 id="luyke-supermarket-title" class="text-2xl font-bold text-gray-800 mb-4 flex items-center gap-2">
        <i data-feather="bar-chart" class="text-blue-600"></i>
        Báo cáo Lũy kế {$selectedWarehouse ? '- ' + $selectedWarehouse : '(Toàn bộ)'}
      </h2>

      <div id="luyke-kpi-cards-container" data-capture-group="kpi" class="kpi-grid-fixed">
      
        <div class="kpi-card-solid card-1">
            <div class="kpi-solid-header">Doanh Thu Thực <i data-feather="dollar-sign"></i></div>
            <div class="kpi-solid-value">{formatters.formatNumber((luykeCardData.dtThucLK || 0) / 1000000, 0)}</div>
            <div class="kpi-solid-sub">
                <span>DK: {formatters.formatNumber((luykeCardData.dtThucDuKien || 0) / 1000000, 0)}</span>
                <span>MT: {formatters.formatNumber(localGoals?.doanhThuThuc || 0)}</span>
            </div>
            <div class="kpi-bg-icon"><i data-feather="dollar-sign"></i></div>
        </div>

        <div class="kpi-card-solid card-2">
            <div class="kpi-solid-header">DT Quy Đổi <i data-feather="refresh-cw"></i></div>
            <div class="kpi-solid-value">{formatters.formatNumber((luykeCardData.dtQdLK || 0) / 1000000, 0)}</div>
            <div class="kpi-solid-sub">
                <span>DK: {formatters.formatNumber((luykeCardData.dtQdDuKien || 0) / 1000000, 0)}</span>
                <span>MT: {formatters.formatNumber(localGoals?.doanhThuQD || 0)}</span>
            </div>
            <div class="kpi-bg-icon"><i data-feather="refresh-cw"></i></div>
        </div>

        <div class="kpi-card-solid card-3">
            <div class="kpi-solid-header">% HT Target (QĐ) <i data-feather="target"></i></div>
            <div class="kpi-solid-value">{formatters.formatPercentage(luykeCardData.phanTramTargetQd || 0)}</div>
            <div class="kpi-solid-sub">
                <span>% HT DT Thực: {formatters.formatPercentage(luykeCardData.phanTramTargetThuc || 0)}</span>
            </div>
            <div class="kpi-bg-icon"><i data-feather="target"></i></div>
        </div>

        <div class="kpi-card-solid card-4">
            <div class="kpi-solid-header">Hiệu quả QĐ <i data-feather="trending-up"></i></div>
            <div class="kpi-solid-value">{formatters.formatPercentage(luykeCardData.phanTramQd || 0)}</div>
            <div class="kpi-solid-sub">
                <span>Mục tiêu: {formatters.formatNumber(localGoals?.phanTramQD || 0)}%</span>
            </div>
            <div class="kpi-bg-icon"><i data-feather="trending-up"></i></div>
        </div>

        <div class="kpi-card-solid card-5">
            <div class="kpi-solid-header">Tỷ lệ Trả chậm <i data-feather="credit-card"></i></div>
            <div class="kpi-solid-value">{formatters.formatPercentage(luykeCardData.phanTramGop || 0)}</div>
            <div class="kpi-solid-sub">
                <span>Doanh số: {formatters.formatNumber((luykeCardData.dtGop || 0) / 1000000, 0)}</span>
            </div>
            <div class="kpi-bg-icon"><i data-feather="credit-card"></i></div>
        </div>

        <div class="kpi-card-solid card-6">
            <div class="kpi-solid-header">Thi đua đạt <i data-feather="award"></i></div>
            <div class="kpi-solid-value">{competitionSummary.dat}/{competitionSummary.total}</div>
            <div class="kpi-solid-sub">
                <span>Tỷ lệ đạt: {formatters.formatPercentage(luykeCardData.tyLeThiDuaDat)}</span>
            </div>
            <div class="kpi-bg-icon"><i data-feather="award"></i></div>
        </div>

        <div class="kpi-card-solid card-7">
            <div class="kpi-solid-header">Tăng trưởng CK <i data-feather="activity"></i></div>
            <div class="kpi-solid-value">{comparisonData.percentage || 'N/A'}</div>
            <div class="kpi-solid-sub">
                <span>Lượt khách: {luotKhachData.percentage || 'N/A'}</span>
            </div>
            <div class="kpi-bg-icon"><i data-feather="activity"></i></div>
        </div>

        <div class="kpi-card-solid card-8">
           <div class="kpi-solid-header">Tỷ trọng kênh <i data-feather="pie-chart"></i></div>
            <div class="flex flex-col gap-1 mt-1">
                <div class="flex justify-between items-baseline border-b border-white/20 pb-1">
                    <span class="text-sm font-semibold opacity-90">ĐMX</span>
                    <div class="text-right">
                        <span class="text-lg font-bold">{formatters.formatRevenue(channelStats.dxm.val, 0)}</span>
                        <span class="text-xs opacity-90 ml-1 font-bold">({formatters.formatPercentage(channelStats.dxm.pct)})</span>
                    </div>
                </div>
                <div class="flex justify-between items-baseline pt-1">
                    <span class="text-sm font-semibold opacity-90">TGDD</span>
                    <div class="text-right">
                        <span class="text-lg font-bold">{formatters.formatRevenue(channelStats.tgdd.val, 0)}</span>
                        <span class="text-xs opacity-90 ml-1 font-bold">({formatters.formatPercentage(channelStats.tgdd.pct)})</span>
                    </div>
                </div>
            </div>
            <div class="kpi-bg-icon"><i data-feather="pie-chart"></i></div>
        </div>

      </div>
  </div>

  <div class="luyke-tier-1-grid" data-capture-group="tier1">
      <LuykeEfficiencyTable 
          items={[]} 
          dynamicItems={combinedEfficiencyItems} 
          supermarketData={localSupermarketReport}
          goals={localGoals} 
          on:add={openAddEffModal}
          on:edit={handleEditEffConfig}
          on:delete={handleDeleteEffConfig}
      />
      <LuykeQdcTable 
          items={qdcItems} 
          numDays={numDays} 
      />
  </div>

  <div data-capture-group="tier2">
      <LuykeCategoryTable 
          items={categoryItems} 
          unexportedItems={chuaXuatReport}
          rawSource={filteredYCXData} 
          {numDays} 
      />
  </div>

</div>
--- END FILE: ./src/components/luyke/LuykeSieuThi.svelte ---

--- START FILE: ./src/components/luyke/LuykeThiDua.svelte ---
<script>
  import { afterUpdate } from 'svelte';
  import { competitionData } from '../../stores.js';
  import { formatters } from '../../utils/formatters.js';

  let viewType = 'summary'; // 'summary' | 'completion'
  let sortedData = [];
  
  // Stats calculation
  let summary = {
      total: 0,
      achieved: 0,
      revenueTotal: 0,
      revenueAchieved: 0,
      quantityTotal: 0,
      quantityAchieved: 0,
      overallRate: 0
  };

  $: {
    const data = ($competitionData || []).map(item => { 
      const hoanThanhValue = (parseFloat(String(item.hoanThanh).replace('%','')) || 0); 
      return { ...item, hoanThanhValue: hoanThanhValue }; 
    });

    summary = data.reduce((acc, d) => {
      acc.total++;
      if (d.hoanThanhValue >= 100) acc.achieved++;
      
      if (d.type === 'doanhThu') {
          acc.revenueTotal++;
          if (d.hoanThanhValue >= 100) acc.revenueAchieved++;
      }
      if (d.type === 'soLuong') {
          acc.quantityTotal++;
          if (d.hoanThanhValue >= 100) acc.quantityAchieved++;
      }
      return acc;
    }, { total: 0, achieved: 0, revenueTotal: 0, revenueAchieved: 0, quantityTotal: 0, quantityAchieved: 0 });

    summary.overallRate = summary.total > 0 ? (summary.achieved / summary.total) * 100 : 0;
    sortedData = data; 
  }

  function setViewType(newType) {
    viewType = newType;
  }
  
  function sortData(items) {
    return [...items].sort((a, b) => b.hoanThanhValue - a.hoanThanhValue); 
  };

  function getRateColor(rate) {
      if (rate >= 80) return 'text-green-600'; 
      if (rate >= 50) return 'text-yellow-600'; 
      return 'text-red-600';
  }

  $: rateStyle = getRateColor(summary.overallRate);

  afterUpdate(() => {
    if (typeof feather !== 'undefined') {
      feather.replace();
    }
  });
</script>

{#snippet flatKpiCard(title, value, subText, icon, colorClass, barPercent = 0)}
    <div class="bg-white border border-gray-200 rounded-xl p-4 shadow-sm hover:shadow-md transition-all h-full min-h-[120px] flex items-stretch justify-between relative overflow-hidden group">
        
        <div class="flex flex-col justify-between items-start z-10 mr-4 flex-grow">
            <div class="flex items-center gap-2.5">
                <div class="w-8 h-8 rounded-lg bg-gray-100 flex items-center justify-center text-gray-500 border border-gray-200 group-hover:bg-white group-hover:{colorClass} transition-colors">
                    <i data-feather={icon} class="w-4 h-4"></i>
                </div>
                <span class="text-xs font-extrabold uppercase text-gray-600 tracking-wider leading-tight">{title}</span>
            </div>

            <div class="w-full mt-auto pt-3">
                {#if barPercent > 0}
                    <div class="w-full bg-gray-100 rounded-full h-1.5 mb-2 max-w-[100px]">
                        <div class="h-1.5 rounded-full {colorClass.replace('text-', 'bg-')}" style="width: {Math.min(barPercent, 100)}%"></div>
                    </div>
                {/if}
                <div class="text-[11px] font-semibold text-gray-400 leading-snug">
                    {@html subText}
                </div>
            </div>
        </div>

        <div class="flex items-center justify-end z-10 flex-shrink-0">
            <span class="text-5xl font-black {colorClass} tracking-tighter leading-none drop-shadow-sm">{value}</span>
        </div>
    </div>
{/snippet}

{#snippet competitionCard(item)}
    {@const isProjectedCompleted = item.hoanThanhValue >= 100}
    {@const isActualCompleted = item.luyKe >= item.target}
    {@const colorBase = isProjectedCompleted ? 'green' : (item.hoanThanhValue >= 80 ? 'yellow' : 'red')}
    {@const textColor = `text-${colorBase}-600`}
    {@const barColor = `bg-${colorBase}-500`}
    {@const topBorderColor = `border-${colorBase}-500`}
    {@const targetRemaining = (item.target || 0) - (item.luyKe || 0)}
    {@const daysLeft = Math.max(30 - (new Date().getDate()), 1)}
    {@const dailyTarget = (item.target > 0 && targetRemaining > 0) ? (targetRemaining / daysLeft) : 0}

    <div class="bg-white border border-gray-200 border-t-4 {topBorderColor} rounded-lg p-3 shadow-sm hover:shadow-md hover:-translate-y-0.5 transition-all flex flex-col h-full">
        <div class="flex justify-between items-start gap-3 mb-2">
            <h4 class="font-bold text-gray-800 text-sm leading-snug line-clamp-2 flex-grow" title={item.name}>
                {item.name}
            </h4>
            <span class="text-2xl font-extrabold {textColor} leading-none flex-shrink-0">
                {formatters.formatPercentage(item.hoanThanhValue / 100)}
            </span>
        </div>

        <div class="w-full bg-gray-100 rounded-full h-1.5 mb-3">
            <div class="h-1.5 rounded-full {barColor} transition-all duration-500" style="width: {Math.min(item.hoanThanhValue, 100)}%"></div>
        </div>

        <div class="mt-auto pt-2 border-t border-dashed border-gray-100 grid grid-cols-2 gap-2 text-xs items-end">
            <div>
                <span class="block text-[10px] text-gray-400 uppercase font-semibold">TH / MT</span>
                <div class="text-gray-700 font-bold whitespace-nowrap">
                    <span>{formatters.formatNumberOrDash(item.luyKe)}</span>
                    <span class="text-gray-300 font-normal mx-0.5">/</span>
                    <span>{formatters.formatNumberOrDash(item.target)}</span>
                </div>
            </div>
            <div class="text-right">
                {#if !isActualCompleted}
                    <div class="inline-block bg-red-50 text-red-600 px-2 py-1 rounded text-[10px] font-bold border border-red-100">
                        Cần: {formatters.formatNumberOrDash(dailyTarget)}/ngày
                    </div>
                {:else}
                    <span class="text-green-600 font-bold text-[10px] flex items-center justify-end gap-1">
                        <i data-feather="check-circle" class="w-3 h-3"></i> Đã đạt
                    </span>
                {/if}
            </div>
        </div>
    </div>
{/snippet}

<div class="luyke-dashboard-container">
    
    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 mb-6" data-capture-group="kpi-thidua">
        
        {@render flatKpiCard(
            'Tổng Chương trình', 
            summary.total, 
            `DT: <strong class="text-blue-600">${summary.revenueTotal}</strong> • SL: <strong class="text-orange-600">${summary.quantityTotal}</strong>`,
            'layers',
            'text-gray-700'
        )}

        {@render flatKpiCard(
            'Tỷ lệ Đạt', 
            formatters.formatPercentage(summary.overallRate / 100), 
            `Đã đạt: <strong class="${getRateColor(summary.overallRate)}">${summary.achieved}</strong> / ${summary.total}`,
            'target',
            getRateColor(summary.overallRate),
            summary.overallRate
        )}

        {@render flatKpiCard(
            'Thi đua Doanh thu', 
            `${summary.revenueAchieved}/${summary.revenueTotal}`, 
            `Tỷ lệ đạt: <strong>${summary.revenueTotal > 0 ? formatters.formatPercentage(summary.revenueAchieved / summary.revenueTotal) : '0%'}</strong>`,
            'dollar-sign',
            'text-blue-600',
            summary.revenueTotal > 0 ? (summary.revenueAchieved / summary.revenueTotal) * 100 : 0
        )}

        {@render flatKpiCard(
            'Thi đua Số lượng', 
            `${summary.quantityAchieved}/${summary.quantityTotal}`, 
            `Tỷ lệ đạt: <strong>${summary.quantityTotal > 0 ? formatters.formatPercentage(summary.quantityAchieved / summary.quantityTotal) : '0%'}</strong>`,
            'box',
            'text-orange-600',
            summary.quantityTotal > 0 ? (summary.quantityAchieved / summary.quantityTotal) * 100 : 0
        )}

    </div>

    <div class="luyke-tier-2-container">
        
        <div class="luyke-toolbar">
            <div class="luyke-toolbar-left">
                <h3 class="text-lg font-bold uppercase flex items-center gap-2 text-gray-700">
                    <i data-feather="list" class="text-blue-600"></i>
                    Chi tiết ({summary.total})
                </h3>
            </div>

            <div class="luyke-toolbar-right flex items-center gap-2">
                <div class="flex bg-gray-100 p-0.5 rounded-lg border border-gray-200">
                    <button 
                        class="view-mode-btn {viewType === 'summary' ? 'active' : ''}" 
                        on:click={() => setViewType('summary')}
                    >
                        <i data-feather="grid" class="w-4 h-4"></i>
                        <span class="hidden sm:inline text-xs ml-1">Theo Loại</span>
                    </button>
                    <button 
                        class="view-mode-btn {viewType === 'completion' ? 'active' : ''}" 
                        on:click={() => setViewType('completion')}
                    >
                        <i data-feather="check-circle" class="w-4 h-4"></i>
                        <span class="hidden sm:inline text-xs ml-1">Tiến độ</span>
                    </button>
                </div>
            </div>
        </div>

        <div class="p-4 bg-white border border-gray-200 border-t-0 rounded-b-xl min-h-[400px]">
            {#if sortedData.length === 0}
                <div class="p-12 text-center bg-gray-50 rounded-lg border-2 border-dashed border-gray-200">
                    <p class="text-gray-500 font-bold mb-2">Chưa có dữ liệu hiển thị.</p>
                    <p class="text-xs text-gray-400">Vui lòng dán "Data lũy kế" ở tab Cập nhật dữ liệu.</p>
                </div>
            {:else}
                
                <div class="flex flex-col gap-8">
                    {#if viewType === 'summary'}
                        {@const dataDoanhThu = sortData(sortedData.filter(d => d.type === 'doanhThu'))}
                        {@const dataSoLuong = sortData(sortedData.filter(d => d.type === 'soLuong'))}

                        {#if dataDoanhThu.length > 0}
                            <div>
                                <h4 class="text-sm font-bold text-blue-800 uppercase flex items-center gap-2 mb-4 pb-2 border-b border-blue-100">
                                    <span class="bg-blue-100 p-1 rounded"><i data-feather="dollar-sign" class="w-4 h-4"></i></span>
                                    Thi Đua Doanh Thu ({dataDoanhThu.length})
                                </h4>
                                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                                    {#each dataDoanhThu as item}
                                        {@render competitionCard(item)}
                                    {/each}
                                </div>
                            </div>
                        {/if}

                        {#if dataSoLuong.length > 0}
                            <div>
                                <h4 class="text-sm font-bold text-orange-800 uppercase flex items-center gap-2 mb-4 pb-2 border-b border-orange-100">
                                    <span class="bg-orange-100 p-1 rounded"><i data-feather="box" class="w-4 h-4"></i></span>
                                    Thi Đua Số Lượng ({dataSoLuong.length})
                                </h4>
                                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                                    {#each dataSoLuong as item}
                                        {@render competitionCard(item)}
                                    {/each}
                                </div>
                            </div>
                        {/if}

                    {:else if viewType === 'completion'}
                        {@const completed = sortData(sortedData.filter(d => d.hoanThanhValue >= 100))}
                        {@const pending = sortData(sortedData.filter(d => d.hoanThanhValue < 100))}

                        {#if completed.length > 0}
                            <div>
                                <h4 class="text-sm font-bold text-green-800 uppercase flex items-center gap-2 mb-4 pb-2 border-b border-green-100">
                                    <span class="bg-green-100 p-1 rounded"><i data-feather="check" class="w-4 h-4"></i></span>
                                    Đã hoàn thành ({completed.length})
                                </h4>
                                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                                    {#each completed as item}
                                        {@render competitionCard(item)}
                                    {/each}
                                </div>
                            </div>
                        {/if}

                        {#if pending.length > 0}
                            <div>
                                <h4 class="text-sm font-bold text-red-800 uppercase flex items-center gap-2 mb-4 pb-2 border-b border-red-100">
                                    <span class="bg-red-100 p-1 rounded"><i data-feather="clock" class="w-4 h-4"></i></span>
                                    Cần nỗ lực thêm ({pending.length})
                                </h4>
                                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                                    {#each pending as item}
                                        {@render competitionCard(item)}
                                    {/each}
                                </div>
                            </div>
                        {/if}
                    {/if}
                </div>
            {/if}
        </div>
    </div>
</div>
--- END FILE: ./src/components/luyke/LuykeThiDua.svelte ---

--- START FILE: ./src/components/luyke/LuykeThiDuaVung.svelte ---
<script>
  /* global XLSX, feather */
  import { onMount } from 'svelte';
  import { get } from 'svelte/store';
  import { 
    thiDuaVungChiTiet, 
    thiDuaVungTong, 
    choices 
  } from '../../stores.js';
  import { dataProcessing } from '../../services/dataProcessing.js';
  import { reportService } from '../../services/reportService.js';
  import TdvInfographic from './TdvInfographic.svelte';

  let fileStatus = "";
  let isLoading = false;
  let supermarketNames = [];
  let selectedSupermarket = "";
  let reportData = null;
  let choicesInstance = null;
  let selectElement = null; 

  async function _handleFileRead(file) {
      return new Promise((resolve, reject) => {
          if (!file) return reject(new Error("No file provided."));
          const reader = new FileReader();
          reader.onload = (event) => {
              try {
                  const data = new Uint8Array(event.target.result);
                  const workbook = XLSX.read(data, { type: 'array', cellDates: true, cellText: true });
                 resolve(workbook);
              } catch (err) { reject(err); }
          };
          reader.onerror = (err) => reject(new Error("Could not read the file: " + err));
          reader.readAsArrayBuffer(file);
      });
  }

  async function handleFileInput(event) {
    const file = event.target.files[0];
    const fileNameEl = document.getElementById('file-name-thidua-vung');
    if (!file) {
      if (fileNameEl) fileNameEl.textContent = "Chưa thêm file";
      fileStatus = "";
      return;
    }

    isLoading = true;
    if (fileNameEl) fileNameEl.textContent = file.name;
    fileStatus = "Đang xử lý file...";

    try {
      const workbook = await _handleFileRead(file);
      const { chiTietData, tongData } = dataProcessing.processThiDuaVungFile(workbook);
      
      if (!tongData || tongData.length === 0) {
        throw new Error('Không tìm thấy dữ liệu hợp lệ trong file.');
      }

      thiDuaVungChiTiet.set(chiTietData);
      thiDuaVungTong.set(tongData);
 
      const supermarketKey = Object.keys(tongData[0]).find(k => k.trim().toLowerCase().includes('siêu thị'));
      supermarketNames = [...new Set(tongData.map(row => row[supermarketKey]).filter(Boolean))].sort();

      if (choicesInstance) {
        choicesInstance.clearStore();
        choicesInstance.setChoices(
          supermarketNames.map(name => ({ value: name, label: name })),
          'value',
          'label',
          true
        );
      }
      
      fileStatus = `✅ Đã xử lý ${supermarketNames.length} siêu thị.`;
    } catch (error) {
      console.error("Lỗi xử lý file Thi Đua Vùng:", error);
      fileStatus = `❌ Lỗi: ${error.message}`;
    } finally {
      isLoading = false;
      event.target.value = null; 
    }
  }

  function handleFilterChange() {
    if (!choicesInstance) return;
    const selectedValue = choicesInstance.getValue(true);
    selectedSupermarket = selectedValue;
 
    if (selectedValue) {
      reportData = reportService.generateThiDuaVungReport(selectedValue);
    } else {
      reportData = null;
    }
  }

  onMount(() => {
    if (typeof Choices !== 'undefined' && selectElement) {
      choicesInstance = new Choices(selectElement, {
        searchEnabled: true,
        removeItemButton: false,
        itemSelectText: 'Chọn',
        searchPlaceholderValue: 'Tìm kiếm siêu thị...'
      });
      choices.update(c => ({ ...c, thiDuaVung_sieuThi: choicesInstance }));
    }
    
    if (typeof feather !== 'undefined') {
      feather.replace();
    }
  });
</script>

<div class="content-card"> 
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 items-end"> 
        <div class="data-input-group input-group--blue"> 
            <div class="flex flex-col sm:flex-row sm:items-center sm:gap-4"> 
                <label class="data-input-group__label !mb-2 sm:!mb-0 flex-shrink-0">File Thi Đua Vùng:</label> 
                <div class="flex items-center gap-2"> 
                    <label 
                        for="file-thidua-vung" 
                        class="data-input-group__file-trigger"
                        class:opacity-50={isLoading}
                    >
                        {isLoading ? 'Đang xử lý...' : 'Thêm file'}
                    </label> 
                    <span id="file-name-thidua-vung" class="data-input-group__file-name">Chưa thêm file</span> 
                </div>
            </div> 
            <input 
                type="file" 
                id="file-thidua-vung" 
                class="hidden" 
                data-name="Thi đua vùng" 
                accept=".xlsx, .xls, .csv"
                on:change={handleFileInput}
                disabled={isLoading}
            > 
            <div class="data-input-group__status-wrapper mt-2">
                <span 
                    class="data-input-group__status-text"
                    class:text-green-600={fileStatus.startsWith('✅')}
                    class:text-red-600={fileStatus.startsWith('❌')}
                >
                    {fileStatus}
                </span>
            </div> 
        </div>
        
        <div class="data-input-group input-group--yellow h-full" style="min-height: 104px;"> 
             <label class="data-input-group__label">Chọn Siêu thị:</label> 
             <div class="data-input-group__content">
                <select 
                    id="thidua-vung-filter-supermarket" 
                    bind:this={selectElement}
                    on:change={handleFilterChange}
                >
                    <option value="">Vui lòng tải file...</option>
                </select> 
             </div>
        </div> 
    </div>
</div> 

<div id="thidua-vung-infographic-container" class="mt-6"> 
    {#if reportData}
        <TdvInfographic {reportData} />
    {:else}
        <div class="placeholder-message">Vui lòng tải file và chọn một siêu thị để xem báo cáo.</div> 
    {/if}
</div>
--- END FILE: ./src/components/luyke/LuykeThiDuaVung.svelte ---

--- START FILE: ./src/components/luyke/LuykeUnexportedTable.svelte ---
<script>
  import { afterUpdate } from 'svelte';
  import { sortState } from '../../stores.js';
  import { formatters } from '../../utils/formatters.js';
  // FIX: Đường dẫn đúng
  import SortableTh from '../common/SortableTh.svelte';

  export let items = [];

  const tableType = 'luyke_chuaxuat';
  
  let totals = { soLuong: 0, doanhThuThuc: 0, doanhThuQuyDoi: 0 };

  function handleSort(event) {
    const sortKey = event.detail;
    const currentState = $sortState[tableType] || { key: 'doanhThuQuyDoi', direction: 'desc' };
    let newDirection;
    if (currentState.key === sortKey) {
      newDirection = currentState.direction === 'desc' ? 'asc' : 'desc';
    } else {
      newDirection = 'desc';
    }
    sortState.update(current => {
      current[tableType] = { key: sortKey, direction: newDirection };
      return current;
    });
  }

  $: currentSortKey = $sortState[tableType]?.key || 'doanhThuQuyDoi';
  $: currentSortDirection = $sortState[tableType]?.direction || 'desc';

  $: sortedItems = [...items].sort((a, b) => {
    const key = currentSortKey;
    const direction = currentSortDirection;
    let valA, valB;
     if (key === 'nganhHang') {
      valA = a.nganhHang || ''; valB = b.nganhHang || '';
      return direction === 'asc' ? valA.localeCompare(valB) : valB.localeCompare(valA);
    } else {
      valA = a[key] || 0; valB = b[key] || 0;
    }
    return direction === 'asc' ? valA - valB : valB - valA;
  });

  $: totals = items.reduce((acc, item) => {
      acc.soLuong += item.soLuong; 
      acc.doanhThuThuc += item.doanhThuThuc; 
      acc.doanhThuQuyDoi += item.doanhThuQuyDoi; 
      return acc; 
  }, { soLuong: 0, doanhThuThuc: 0, doanhThuQuyDoi: 0 });
</script>

<div data-capture-group="2" class="bg-white rounded-xl shadow-md p-4 sm:p-6 border border-gray-200 h-full flex flex-col">
  <h3 class="text-xl font-bold uppercase mb-4 border-b pb-2">Doanh thu chưa xuất</h3>
  
  {#if sortedItems.length === 0}
     <div class="flex-grow flex items-center justify-center">
        <p class="text-gray-500 font-bold p-4 text-center">Không có đơn hàng nào chưa xuất.</p>
     </div>
  {:else}
    <div id="luyke-unexported-revenue-content" class="overflow-x-auto flex-grow">
        <table class="min-w-full text-sm table-bordered table-striped" data-table-type={tableType}>
        <thead class="text-xs text-slate-800 uppercase bg-slate-200 font-bold sticky top-0 z-10 shadow-sm">
            <tr>
            <SortableTh key="nganhHang" label="Ngành hàng" sortKey={currentSortKey} sortDirection={currentSortDirection} on:sort={handleSort} />
            <SortableTh key="soLuong" label="Số lượng" align="right" sortKey={currentSortKey} sortDirection={currentSortDirection} on:sort={handleSort} />
            <SortableTh key="doanhThuThuc" label="Doanh thu thực" align="right" sortKey={currentSortKey} sortDirection={currentSortDirection} on:sort={handleSort} />
            <SortableTh key="doanhThuQuyDoi" label="Doanh thu QĐ" align="right" sortKey={currentSortKey} sortDirection={currentSortDirection} on:sort={handleSort} />
            </tr>
        </thead>
        <tbody>
            {#each sortedItems as item (item.nganhHang)}
            <tr class="hover:bg-gray-50">
                <td class="px-4 py-2 font-semibold">{item.nganhHang}</td>
                <td class="px-4 py-2 text-right font-bold">{formatters.formatNumber(item.soLuong)}</td>
                <td class="px-4 py-2 text-right font-bold">{formatters.formatRevenue(item.doanhThuThuc)}</td> 
                <td class="px-4 py-2 text-right font-bold text-blue-600">{formatters.formatRevenue(item.doanhThuQuyDoi)}</td> 
            </tr>
            {/each}
        </tbody>
        <tfoot class="table-footer font-bold bg-gray-100 border-t-2 border-gray-300 sticky bottom-0">
            <tr>
                <td class="px-4 py-2">Tổng</td>
                <td class="px-4 py-2 text-right">{formatters.formatNumber(totals.soLuong)}</td>
                <td class="px-4 py-2 text-right">{formatters.formatRevenue(totals.doanhThuThuc)}</td> 
                <td class="px-4 py-2 text-right">{formatters.formatRevenue(totals.doanhThuQuyDoi)}</td> 
            </tr>
        </tfoot>
        </table>
    </div>
  {/if}
</div>
--- END FILE: ./src/components/luyke/LuykeUnexportedTable.svelte ---

--- START FILE: ./src/components/luyke/TdvInfographic.svelte ---
<script>
  // Component này nhận dữ liệu đã được xử lý và chỉ render ra HTML.
  import { formatters } from '../../utils/formatters.js';

  export let reportData;

  // --- Logic render được di chuyển từ ui-thidua-vung.js ---
  let summary, coGiai, sapCoGiai, tiemNang, canCoGangNhieu;
  let keyMap = {};
  let soonPrizeTitleText = '';
  let tyLeDatClass = '';

  // Helper function (giữ nguyên từ file gốc)
  const findKey = (item, keyword) => {
      if (!item) return keyword; 
      return Object.keys(item).find(k => k.trim().toLowerCase().includes(keyword.toLowerCase())) || keyword;
  }

  // $: là một khối reactive. Nó sẽ tự động chạy lại khi 'reportData' thay đổi.
  $: {
    if (!reportData) {
      // Nếu không có data, reset
      summary = null;
      coGiai = [];
      sapCoGiai = [];
      tiemNang = [];
      canCoGangNhieu = [];
} else {
      // Destructure dữ liệu
      ({ summary, coGiai, sapCoGiai, tiemNang, canCoGangNhieu } = reportData);

      // Tìm keys (giống hệt logic cũ)
      const firstItem = coGiai[0] || sapCoGiai[0] || tiemNang[0] || canCoGangNhieu[0];
      keyMap = {
          sieuThi: findKey(summary, 'siêu thị'),
          tongThuongTamTinh: findKey(summary, 'tổng thưởng tạm tỉnh'),
          slThiDua: findKey(summary, 'sl nh thi đua'),
          slDat: findKey(summary, 'sl nh >100%'),
          tyLeDat: findKey(summary, 'tỷ lệ nh đạt >100%'),
          slCoGiai: findKey(summary, 'sl nh dự kiến đạt giải'),
          nganhHang: findKey(firstItem, 'ngành hàng'),
          phanTramDuKien: findKey(firstItem, '% dự kiến'),
          duKienVuot: findKey(firstItem, 'dự kiến d.thu'),
          hangVuotTroi: findKey(firstItem, 'hạng vượt trội'),
          hangTarget: findKey(firstItem, 'hạng % target'),
          tongThuong: findKey(firstItem, 'tổng thưởng'),
          hangCoGiaiKenh: 'hangCoGiaiKenh'
      };

      // Tính toán text/class (giống hệt logic cũ)
      const totalSoonPrize = sapCoGiai.reduce((sum, item) => sum + (item.thuongTiemNang || 0), 0);
      soonPrizeTitleText = totalSoonPrize > 0 ? ` - DK: ${formatters.formatNumber(totalSoonPrize)}đ` : '';

      const tyLeDatValue = summary[keyMap.tyLeDat] || 0;
      tyLeDatClass = tyLeDatValue >= 0.6 ? 'tdv-tyledat-high' : 'tdv-tyledat-low';
    }
  }
</script>

{#if reportData}
<div class="tdv-infographic-card" data-capture-group="thidua-vung">
    <div class="tdv-header">
        <h2 class="tdv-supermarket-name">{summary[keyMap.sieuThi]}</h2>
        <div class="tdv-total-prize-container">
            <span class="tdv-total-prize-label">Tổng thưởng tạm tính:</span>
            <span class="tdv-total-prize-value">{formatters.formatNumber(summary[keyMap.tongThuongTamTinh])}đ</span>
        </div>
    </div>

    <div class="tdv-summary-grid">
        <div class="tdv-summary-item">
            <span class="tdv-summary-value">{formatters.formatNumber(summary[keyMap.slThiDua])}</span>
            <span class="tdv-summary-label">Ngành thi đua</span>
        </div>
        <div class="tdv-summary-item">
            <span class="tdv-summary-value">{formatters.formatNumber(summary[keyMap.slDat])}</span>
            <span class="tdv-summary-label">Ngành >100%</span>
        </div>
        <div class="tdv-summary-item">
            <span class="tdv-summary-value {tyLeDatClass}">{formatters.formatPercentage(summary[keyMap.tyLeDat] || 0)}</span>
            <span class="tdv-summary-label">Tỷ lệ đạt</span>
        </div>
         <div class="tdv-summary-item">
            <span class="tdv-summary-value">{formatters.formatNumber(summary[keyMap.slCoGiai])}</span>
            <span class="tdv-summary-label">Ngành dự kiến có giải</span>
        </div>
        <div class="tdv-summary-item">
            <span class="tdv-summary-value">{formatters.formatNumber(summary[keyMap.hangCoGiaiKenh])}</span>
            <span class="tdv-summary-label">Hạng có giải (Kênh)</span>
        </div>
    </div>

    <div class="tdv-rows-container">
        <div class="tdv-row">
            <h3 class="tdv-row-title tdv-row-title--prize">Ngành hàng có giải ({coGiai.length})</h3>
            <div class="tdv-row-body grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                {#if coGiai.length > 0}
                    {#each coGiai as item (item[keyMap.nganhHang])}
                        <div class="tdv-item-card">
                            <p class="tdv-item-card__title">{item[keyMap.nganhHang]}</p>
                            <div class="tdv-progress-bar-container">
                                <div class="tdv-progress-bar tdv-progress-bar--blue" style="width: {Math.min(item[keyMap.phanTramDuKien] * 100, 100)}%;"></div>
                                <span class="tdv-progress-bar__text">{formatters.formatPercentage(item[keyMap.phanTramDuKien])}</span>
                            </div>
                            <div class="tdv-item-card__details">
                                <span>Vượt: <strong>{formatters.formatNumber(item[keyMap.duKienVuot])}</strong></span>
                                <span>Hạng DT/SL: <strong>{item[keyMap.hangVuotTroi]}</strong></span>
                                <span>Hạng %: <strong>{item[keyMap.hangTarget]}</strong></span>
                                <span class="tdv-item-card__prize">Thưởng: <strong>{formatters.formatNumber(item[keyMap.tongThuong])}</strong></span>
                            </div>
                        </div>
                    {/each}
                {:else}
                    <p class="text-xs text-gray-500 col-span-full">Không có.</p>
                {/if}
            </div>
        </div>

        <div class="tdv-row">
            <h3 class="tdv-row-title tdv-row-title--soon-prize">Sắp có giải ({sapCoGiai.length})<span class="tdv-row-subtitle">{soonPrizeTitleText}</span></h3>
            <div class="tdv-row-body grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                {#if sapCoGiai.length > 0}
                    {#each sapCoGiai as item (item[keyMap.nganhHang])}
                        <div class="tdv-item-card">
                            <p class="tdv-item-card__title">{item[keyMap.nganhHang]}</p>
                            <div class="tdv-progress-bar-container">
                                <div class="tdv-progress-bar tdv-progress-bar--yellow" style="width: {Math.min(item[keyMap.phanTramDuKien] * 100, 100)}%;"></div>
                                <span class="tdv-progress-bar__text">{formatters.formatPercentage(item[keyMap.phanTramDuKien])}</span>
                            </div>
                            <div class="tdv-item-card__details">
                                <span>Cách giải: <strong>{item.khoangCach} hạng</strong></span>
                                <span>Hạng DT/SL: <strong>{item[keyMap.hangVuotTroi]}</strong></span>
                                <span>Hạng %: <strong>{item[keyMap.hangTarget]}</strong></span>
                                <span class="tdv-item-card__prize">Thưởng DK: <strong>{formatters.formatNumber(item.thuongTiemNang)}</strong></span>
                            </div>
                        </div>
                    {/each}
                {:else}
                    <p class="text-xs text-gray-500 col-span-full">Không có.</p>
                {/if}
            </div>
        </div>

        <div class="tdv-row">
            <h3 class="tdv-row-title tdv-row-title--effort">Nhóm còn lại ({tiemNang.length + canCoGangNhieu.length})</h3>
            <div class="tdv-row-body tdv-row-body--effort">
                {#if tiemNang.length > 0}
                    <div class="tdv-effort-subgroup">
                        <h4 class="tdv-effort-subgroup__title tdv-effort-subgroup__title--potential">Tiềm năng (cách 21-40 hạng)</h4>
                        <div class="tdv-effort-list">
                            {#each tiemNang as item (item[keyMap.nganhHang])}
                                <div class="tdv-effort-item">{item[keyMap.nganhHang]} (cách {item.khoangCach})</div>
                            {/each}
                        </div>
                    </div>
                {/if}

                {#if canCoGangNhieu.length > 0}
                     <div class="tdv-effort-subgroup">
                        <h4 class="tdv-effort-subgroup__title tdv-effort-subgroup__title--major">Cần cố gắng nhiều</h4>
                        <div class="tdv-effort-list">
                            {#each canCoGangNhieu as item (item[keyMap.nganhHang])}
                                <div class="tdv-effort-item">{item[keyMap.nganhHang]}</div>
                            {/each}
                        </div>
                    </div>
                {/if}

                {#if tiemNang.length === 0 && canCoGangNhieu.length === 0}
                    <p class="text-xs text-gray-500">Không có.</p>
                {/if}
            </div>
        </div>
    </div>
</div>
{/if}
--- END FILE: ./src/components/luyke/TdvInfographic.svelte ---

--- START FILE: ./src/components/luyke/sub/LuykeCategoryCharts.svelte ---
<script>
    import { tick, afterUpdate } from 'svelte';
    import { formatters } from '../../../utils/formatters.js';
    import { getRandomBrightColor } from '../../../utils.js';

    export let pieData = [];
    export let barData = [];
    export let showUnexported = false;

    let chartInstancePie = null;
    let chartInstanceBar = null;

    async function renderCharts() {
        if (typeof Chart === 'undefined') return;
        await tick();

        // 1. Pie Chart
        const ctxPie = document.getElementById('luyke-cat-pie-chart');
        if (ctxPie) {
            if (chartInstancePie) chartInstancePie.destroy();
            const totalPieRevenue = pieData.reduce((sum, item) => sum + item.revenue, 0);

            chartInstancePie = new Chart(ctxPie, {
                type: 'doughnut',
                data: {
                    labels: pieData.map(d => d.name),
                    datasets: [{
                        data: pieData.map(d => d.revenue),
                        backgroundColor: pieData.map(() => getRandomBrightColor()),
                        borderWidth: 1
                    }]
                },
                options: { 
                    responsive: true, 
                    maintainAspectRatio: false, 
                    plugins: { 
                        legend: { 
                            position: 'right', 
                            labels: { 
                                boxWidth: 10,
                                font: { size: 11 },
                                generateLabels: (chart) => {
                                    const data = chart.data;
                                    if (data.labels.length && data.datasets.length) {
                                        return data.labels.map((label, i) => {
                                            const value = data.datasets[0].data[i];
                                            const formattedValue = formatters.formatRevenue(value, 0);
                                            const pct = totalPieRevenue > 0 ? (value / totalPieRevenue * 100).toFixed(1) + "%" : "0%";
                                            return {
                                                text: `${label} (${pct}) - ${formattedValue}`,
                                                fillStyle: data.datasets[0].backgroundColor[i],
                                                hidden: isNaN(data.datasets[0].data[i]),
                                                index: i
                                            };
                                        });
                                    }
                                    return [];
                                }
                            } 
                        },
                        datalabels: {
                            formatter: (value, ctx) => {
                                const percentage = totalPieRevenue > 0 ? (value / totalPieRevenue * 100).toFixed(1) + "%" : "0%";
                                if ((value / totalPieRevenue) < 0.03) return "";
                                return percentage;
                            },
                            color: '#fff',
                            font: { weight: 'bold', size: 10 }
                        }
                    } 
                },
                plugins: [ChartDataLabels]
            });
        }

        // 2. Bar Chart
        const ctxBar = document.getElementById('luyke-brand-bar-chart');
        if (ctxBar) {
            if (chartInstanceBar) chartInstanceBar.destroy();
            chartInstanceBar = new Chart(ctxBar, {
                type: 'bar',
                data: {
                    labels: barData.map(d => d.name),
                    datasets: [{
                        label: 'Doanh thu',
                        data: barData.map(d => d.revenue / 1000000),
                        backgroundColor: barData.map(() => getRandomBrightColor()),
                        borderRadius: 4
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { 
                        legend: { display: false },
                        datalabels: {
                            anchor: 'end',
                            align: 'end',
                            formatter: (value) => formatters.formatNumber(value, 0),
                            color: '#4b5563',
                            font: { weight: 'bold', size: 10 }
                        },
                        tooltip: {
                            callbacks: {
                                label: (ctx) => formatters.formatRevenue(ctx.raw * 1000000)
                            }
                        }
                    },
                    scales: { x: { beginAtZero: true } }
                },
                plugins: [ChartDataLabels]
            });
        }
    }

    // Tự động render khi data thay đổi
    $: if (pieData.length > 0 || barData.length > 0) {
        setTimeout(renderCharts, 0);
    }

    afterUpdate(() => {
        // Đảm bảo render lại khi chuyển tab hoặc resize
        setTimeout(renderCharts, 0);
    });
</script>

<div class="luyke-charts-container p-4 bg-white border border-gray-200 border-t-0 rounded-b-xl">
    <div class="chart-box">
        <h4 class="text-sm font-bold text-gray-700 mb-2 text-center">Tỷ trọng Doanh Thu (ĐVT: Triệu)</h4>
        <div class="relative h-full w-full"><canvas id="luyke-cat-pie-chart"></canvas></div>
    </div>
    <div class="chart-box">
        <h4 class="text-sm font-bold text-gray-700 mb-2 text-center">Top 15 Hãng (ĐVT: Triệu)</h4>
        <div class="relative h-full w-full"><canvas id="luyke-brand-bar-chart"></canvas></div>
    </div>
</div>
--- END FILE: ./src/components/luyke/sub/LuykeCategoryCharts.svelte ---

--- START FILE: ./src/components/luyke/sub/LuykeCategoryToolbar.svelte ---
<script>
    import { createEventDispatcher } from 'svelte';
    export let titleText = '';
    export let titleIcon = '';
    export let titleClass = '';
    export let iconClass = '';
    
    // Binding props
    export let viewMode = 'grid';
    export let showUnexported = false;
    export let sortMode = 'revenue_desc';
    export let searchText = '';
    
    // Filter props
    export let isSettingsOpen = false;
    export let filterSearch = '';
    export let filterList = []; // Array of { key, label, type } [FIX]
    export let hiddenCategories = new Set();
    export let isLoadingConfig = false;

    const dispatch = createEventDispatcher();

    function toggleCategory(key) {
        dispatch('toggleCategory', key);
    }

    function toggleAll(show) {
        dispatch('toggleAll', show);
    }
</script>

<div class="luyke-toolbar" style="flex-wrap: nowrap; gap: 8px;">
    <div class="luyke-toolbar-left" style="flex-grow: 1; min-width: 0;">
        <h3 class="text-base sm:text-lg font-bold uppercase flex items-center gap-2 {titleClass} truncate">
            <i data-feather={titleIcon} class="{iconClass} flex-shrink-0"></i>
            <span class="truncate">{titleText}</span>
        </h3>
    </div>

    <div class="luyke-toolbar-right" style="flex-shrink: 0; display: flex; align-items: center; gap: 8px;">
        
        <div class="flex bg-gray-100 p-0.5 rounded-lg border border-gray-200">
            <button class="view-mode-btn {viewMode === 'grid' ? 'active' : ''}" on:click={() => viewMode = 'grid'} title="Thẻ"><i data-feather="grid" class="w-4 h-4"></i></button>
            <button class="view-mode-btn {viewMode === 'chart' ? 'active' : ''}" on:click={() => viewMode = 'chart'} title="Biểu đồ"><i data-feather="pie-chart" class="w-4 h-4"></i></button>
        </div>

        {#if viewMode === 'grid'}
            <div class="toggle-wrapper {showUnexported ? 'active' : ''}" on:click={() => showUnexported = !showUnexported} style="padding: 4px 8px;">
                <div class="toggle-switch" style="width: 28px; height: 16px;"></div>
                <span class="toggle-label text-xs whitespace-nowrap">Chưa xuất</span>
            </div>
        {/if}

        <div class="relative filter-wrapper">
            <button class="luyke-icon-btn {isSettingsOpen ? 'active' : ''}" on:click={() => isSettingsOpen = !isSettingsOpen} title="Lọc hiển thị">
                {#if isLoadingConfig}<div class="w-4 h-4 border-2 border-blue-600 border-t-transparent rounded-full animate-spin"></div>{:else}<i data-feather="filter" class="w-4 h-4"></i>{/if}
            </button>

            {#if isSettingsOpen}
                <div class="filter-dropdown">
                    <div class="filter-header">
                        <input type="text" class="filter-search" placeholder="Tìm kiếm..." bind:value={filterSearch} />
                    </div>
                    <div class="filter-body custom-scrollbar">
                        {#if filterList.length === 0}
                            <p class="text-xs text-gray-500 text-center p-2">Không tìm thấy.</p>
                        {:else}
                            {#each filterList as group (group.key)}
                                <div class="filter-item" on:click={() => toggleCategory(group.key)}>
                                    <input type="checkbox" checked={!hiddenCategories.has(group.key)} />
                                    {#if group.type === 'macro'}
                                        <label class="text-teal-700 font-bold text-xs flex items-center gap-1 flex-1">
                                            <i data-feather="layers" class="w-3 h-3"></i> {group.label}
                                        </label>
                                    {:else}
                                        <label class="text-gray-700 text-xs flex-1 truncate" title={group.label}>{group.label}</label>
                                    {/if}
                                </div>
                            {/each}
                        {/if}
                    </div>
                    <div class="filter-actions">
                        <button class="filter-btn-link" on:click={() => toggleAll(true)}>Hiện tất cả</button>
                        <button class="filter-btn-link text-red-600" on:click={() => toggleAll(false)}>Ẩn tất cả</button>
                    </div>
                </div>
            {/if}
        </div>

        {#if viewMode === 'grid'}
            <div class="hidden sm:block">
                <input type="text" placeholder="Tìm nhanh..." class="luyke-search-input" style="width: 120px;" bind:value={searchText} />
            </div>
            <select class="p-1.5 border rounded text-xs bg-white outline-none cursor-pointer max-w-[100px]" bind:value={sortMode}>
                <option value="revenue_desc">DT ↓</option>
                <option value="quantity_desc">SL ↓</option>
            </select>
        {/if}
    </div>
</div>
--- END FILE: ./src/components/luyke/sub/LuykeCategoryToolbar.svelte ---

--- START FILE: ./src/components/modals/AddEfficiencyColumnModal.svelte ---
<script>
    import { createEventDispatcher } from 'svelte';
    import { categoryStructure } from '../../stores.js';
    import { parseIdentity } from '../../utils.js';

    export let isOpen = false;
    export let editItem = null; // Nếu null là thêm mới, có data là sửa
    export let isAdmin = false; // Biến cờ xác định Admin/User

    const dispatch = createEventDispatcher();

    // --- FORM DATA ---
    let label = '';
    let groupA = []; // Lưu danh sách ID
    let groupB = []; // Lưu danh sách ID
    let target = 80;
    let type = 'DTTL'; // 'SL', 'DTTL', 'DTQD'
    let searchA = '';
    let searchB = '';
    let modeA = 'group'; // 'group' | 'category'
    let modeB = 'category'; // 'group' | 'category'

    // --- DATA PREPARATION ---
    // 1. Danh sách Ngành hàng (Unique by ID)
    $: uniqueCategories = (() => {
        const map = new Map();
        ($categoryStructure || []).forEach(c => {
            if(!c.nganhHang) return;
            const parsed = parseIdentity(c.nganhHang);
            if (parsed.id && parsed.id !== 'unknown') {
                map.set(parsed.id, { 
                    id: parsed.id, 
                    display: `${parsed.id} - ${parsed.name}` 
                });
            }
        });
        return Array.from(map.values()).sort((a,b) => a.display.localeCompare(b.display));
    })();

    // 2. Danh sách Nhóm hàng (Unique by ID)
    $: uniqueGroups = (() => {
        const map = new Map();
        ($categoryStructure || []).forEach(c => {
            if(!c.nhomHang) return;
            const parsed = parseIdentity(c.nhomHang);
            if (parsed.id && parsed.id !== 'unknown') {
                map.set(parsed.id, { 
                    id: parsed.id, 
                    display: `${parsed.id} - ${parsed.name}` 
                });
            }
        });
        return Array.from(map.values()).sort((a,b) => a.display.localeCompare(b.display));
    })();
    
    // --- LIST SOURCE ---
    $: listSourceA = modeA === 'group' ? uniqueGroups : uniqueCategories;
    $: listSourceB = modeB === 'group' ? uniqueGroups : uniqueCategories;

    // --- SORTING LOGIC: SELECTED FIRST ---
    // Lọc theo search -> Sắp xếp (Đã chọn lên đầu -> Alpha)
    $: visibleListA = listSourceA
        .filter(i => i.display.toLowerCase().includes(searchA.toLowerCase()))
        .sort((a, b) => {
            const aSel = groupA.includes(a.id);
            const bSel = groupA.includes(b.id);
            if (aSel && !bSel) return -1;
            if (!aSel && bSel) return 1;
            return 0; // Giữ nguyên thứ tự alpha nếu cùng trạng thái
        });

    $: visibleListB = listSourceB
        .filter(i => i.display.toLowerCase().includes(searchB.toLowerCase()))
        .sort((a, b) => {
            const aSel = groupB.includes(b.id);
            const bSel = groupB.includes(a.id);
            if (aSel && !bSel) return -1; // Fix logic sort chiều B
            if (!aSel && bSel) return 1;
            
            // Logic chuẩn: Selected A lên đầu
            const isASel = groupB.includes(a.id);
            const isBSel = groupB.includes(b.id);
            if (isASel && !isBSel) return -1;
            if (!isASel && isBSel) return 1;
            return 0;
        });

    // --- INIT ---
    $: if (isOpen) {
        if (editItem) {
            label = editItem.label;
            groupA = [...(editItem.groupA || [])];
            groupB = [...(editItem.groupB || [])];
            target = editItem.target;
            type = editItem.type || 'DTTL';
            modeA = editItem.modeA || 'group';
            modeB = editItem.modeB || 'category';
        } else {
            label = '';
            groupA = [];
            groupB = [];
            target = 80;
            type = 'DTTL';
            modeA = 'group';
            modeB = 'category';
            searchA = '';
            searchB = '';
        }
    }

    // --- HANDLERS ---
    function toggleSelection(isA, id) {
        if (isA) {
            if (groupA.includes(id)) groupA = groupA.filter(i => i !== id);
            else groupA = [...groupA, id];
        } else {
            if (groupB.includes(id)) groupB = groupB.filter(i => i !== id);
            else groupB = [...groupB, id];
        }
    }

    function toggleAll(isA, sourceList) {
        // Chỉ toggle những item đang hiển thị (theo search)
        const visibleIds = sourceList.map(i => i.id);
        if (isA) {
            const allSelected = visibleIds.every(id => groupA.includes(id));
            if (allSelected) {
                // Bỏ chọn tất cả visible
                groupA = groupA.filter(id => !visibleIds.includes(id));
            } else {
                // Chọn tất cả visible (merge unique)
                groupA = [...new Set([...groupA, ...visibleIds])];
            }
        } else {
            const allSelected = visibleIds.every(id => groupB.includes(id));
            if (allSelected) {
                groupB = groupB.filter(id => !visibleIds.includes(id));
            } else {
                groupB = [...new Set([...groupB, ...visibleIds])];
            }
        }
    }

    function handleSave() {
        if (!label.trim()) return alert("Vui lòng nhập Tên cột.");
        if (groupA.length === 0) return alert("Vui lòng chọn ít nhất 1 mục cho Tử số (Nhóm A).");
        if (groupB.length === 0) return alert("Vui lòng chọn ít nhất 1 mục cho Mẫu số (Nhóm B).");

        dispatch('save', {
            id: editItem ? editItem.id : `eff_${Date.now()}`,
            label, 
            groupA, 
            groupB, 
            target: isAdmin ? 0 : target, 
            type, 
            modeA, 
            modeB
        });
        close();
    }

    function close() {
        dispatch('close');
    }
</script>

{#if isOpen}
<div class="fixed inset-0 bg-gray-900 bg-opacity-50 z-[1300] flex items-center justify-center p-4 backdrop-blur-sm" on:click={close} role="button" tabindex="0">
    <div class="bg-white rounded-xl shadow-2xl w-full max-w-5xl max-h-[90vh] flex flex-col overflow-hidden" on:click|stopPropagation>
        
        <div class="p-5 border-b border-gray-200 flex justify-between items-center bg-gray-50">
            <div>
                <h3 class="text-xl font-bold text-gray-800 flex items-center gap-2">
                    {editItem ? 'Chỉnh sửa' : 'Thêm'} Chỉ số Hiệu quả
                    {#if isAdmin}
                        <span class="text-xs bg-orange-100 text-orange-700 px-2 py-0.5 rounded border border-orange-200 uppercase">System Config</span>
                    {/if}
                </h3>
                <p class="text-sm text-gray-500 mt-1">Công thức: (Tổng Nhóm A / Tổng Nhóm B) * 100%</p>
            </div>
            <button on:click={close} class="text-gray-400 hover:text-red-500 transition-colors text-3xl leading-none">&times;</button>
        </div>

        <div class="p-6 overflow-y-auto flex-1 custom-scrollbar bg-white">
            
            <div class="bg-slate-50 p-4 rounded-xl border border-slate-200 mb-6 grid grid-cols-1 md:grid-cols-3 gap-4 shadow-sm">
                <div>
                    <label for="col-label" class="block text-xs font-bold text-gray-500 uppercase mb-1">Tên hiển thị</label>
                    <input id="col-label" type="text" bind:value={label} class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none text-sm font-semibold" placeholder="VD: % Gia dụng...">
                </div>

                <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Loại dữ liệu</label>
                    <div class="flex gap-4 mt-2">
                        <label class="flex items-center text-sm cursor-pointer"><input type="radio" bind:group={type} value="DTTL" class="mr-1.5 accent-blue-600"> DT Thực</label>
                        <label class="flex items-center text-sm cursor-pointer"><input type="radio" bind:group={type} value="DTQD" class="mr-1.5 accent-purple-600"> DT QĐ</label>
                        <label class="flex items-center text-sm cursor-pointer"><input type="radio" bind:group={type} value="SL" class="mr-1.5 accent-green-600"> Số lượng</label>
                    </div>
                </div>

                {#if !isAdmin}
                    <div>
                        <label for="col-target" class="block text-xs font-bold text-gray-500 uppercase mb-1">Mục tiêu (%)</label>
                        <input id="col-target" type="number" bind:value={target} class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none text-sm" placeholder="80">
                    </div>
                {/if}
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 h-[500px]">
                
                <div class="flex flex-col border rounded-xl overflow-hidden border-blue-200 shadow-sm">
                    <div class="p-3 bg-blue-50 border-b border-blue-200 flex justify-between items-center">
                        <div>
                            <h4 class="font-bold text-blue-800 text-sm uppercase">Tử số (Nhóm A)</h4>
                            <span class="text-xs text-blue-600 font-medium">{groupA.length} đã chọn</span>
                        </div>
                        <div class="flex bg-white rounded p-0.5 border border-blue-100">
                            <label class="cursor-pointer px-2 py-0.5 text-xs rounded transition-colors {modeA === 'group' ? 'bg-blue-100 text-blue-700 font-bold' : 'text-gray-500'}">
                                <input type="radio" bind:group={modeA} value="group" class="hidden"> Nhóm
                            </label>
                            <label class="cursor-pointer px-2 py-0.5 text-xs rounded transition-colors {modeA === 'category' ? 'bg-blue-100 text-blue-700 font-bold' : 'text-gray-500'}">
                                <input type="radio" bind:group={modeA} value="category" class="hidden"> Ngành
                            </label>
                        </div>
                    </div>
                    
                    <div class="p-2 border-b border-blue-100 bg-white relative">
                        <input type="text" bind:value={searchA} class="w-full pl-8 p-2 border border-gray-200 rounded text-sm focus:border-blue-500 outline-none" placeholder="Tìm kiếm...">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 absolute left-4 top-3.5 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" /></svg>
                    </div>

                    <div class="flex-grow overflow-y-auto p-2 bg-slate-50 custom-scrollbar">
                        <div class="flex justify-end mb-2 px-1">
                            <button class="text-xs text-blue-600 hover:underline font-bold" on:click={() => toggleAll(true, visibleListA)}>
                                {groupA.length > 0 && visibleListA.every(i => groupA.includes(i.id)) ? 'Bỏ chọn hiển thị' : 'Chọn hiển thị'}
                            </button>
                        </div>
                        <div class="space-y-1">
                            {#each visibleListA as item (item.id)}
                                {@const isChecked = groupA.includes(item.id)}
                                <label 
                                    class="flex items-center p-2 rounded cursor-pointer transition-all select-none border
                                    {isChecked ? 'bg-blue-100 border-blue-300 shadow-sm' : 'bg-white border-transparent hover:bg-white hover:border-gray-200'}"
                                >
                                    <input type="checkbox" checked={isChecked} on:change={() => toggleSelection(true, item.id)} class="mr-3 w-4 h-4 accent-blue-600 rounded border-gray-300">
                                    <span class="text-sm {isChecked ? 'font-bold text-blue-800' : 'text-gray-700'} truncate" title={item.display}>
                                        {item.display}
                                    </span>
                                    {#if isChecked}
                                        <span class="ml-auto text-xs bg-blue-200 text-blue-800 px-1.5 rounded">✔</span>
                                    {/if}
                                </label>
                            {/each}
                            {#if visibleListA.length === 0}
                                <p class="text-center text-gray-400 text-xs py-4">Không tìm thấy dữ liệu.</p>
                            {/if}
                        </div>
                    </div>
                </div>

                <div class="flex flex-col border rounded-xl overflow-hidden border-green-200 shadow-sm">
                    <div class="p-3 bg-green-50 border-b border-green-200 flex justify-between items-center">
                        <div>
                            <h4 class="font-bold text-green-800 text-sm uppercase">Mẫu số (Nhóm B)</h4>
                            <span class="text-xs text-green-600 font-medium">{groupB.length} đã chọn</span>
                        </div>
                        <div class="flex bg-white rounded p-0.5 border border-green-100">
                            <label class="cursor-pointer px-2 py-0.5 text-xs rounded transition-colors {modeB === 'group' ? 'bg-green-100 text-green-700 font-bold' : 'text-gray-500'}">
                                <input type="radio" bind:group={modeB} value="group" class="hidden"> Nhóm
                            </label>
                            <label class="cursor-pointer px-2 py-0.5 text-xs rounded transition-colors {modeB === 'category' ? 'bg-green-100 text-green-700 font-bold' : 'text-gray-500'}">
                                <input type="radio" bind:group={modeB} value="category" class="hidden"> Ngành
                            </label>
                        </div>
                    </div>
                    
                    <div class="p-2 border-b border-green-100 bg-white relative">
                        <input type="text" bind:value={searchB} class="w-full pl-8 p-2 border border-gray-200 rounded text-sm focus:border-green-500 outline-none" placeholder="Tìm kiếm...">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 absolute left-4 top-3.5 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" /></svg>
                    </div>

                    <div class="flex-grow overflow-y-auto p-2 bg-slate-50 custom-scrollbar">
                        <div class="flex justify-end mb-2 px-1">
                            <button class="text-xs text-green-600 hover:underline font-bold" on:click={() => toggleAll(false, visibleListB)}>
                                {groupB.length > 0 && visibleListB.every(i => groupB.includes(i.id)) ? 'Bỏ chọn hiển thị' : 'Chọn hiển thị'}
                            </button>
                        </div>
                        <div class="space-y-1">
                            {#each visibleListB as item (item.id)}
                                {@const isChecked = groupB.includes(item.id)}
                                <label 
                                    class="flex items-center p-2 rounded cursor-pointer transition-all select-none border
                                    {isChecked ? 'bg-green-100 border-green-300 shadow-sm' : 'bg-white border-transparent hover:bg-white hover:border-gray-200'}"
                                >
                                    <input type="checkbox" checked={isChecked} on:change={() => toggleSelection(false, item.id)} class="mr-3 w-4 h-4 accent-green-600 rounded border-gray-300">
                                    <span class="text-sm {isChecked ? 'font-bold text-green-800' : 'text-gray-700'} truncate" title={item.display}>
                                        {item.display}
                                    </span>
                                    {#if isChecked}
                                        <span class="ml-auto text-xs bg-green-200 text-green-800 px-1.5 rounded">✔</span>
                                    {/if}
                                </label>
                            {/each}
                            {#if visibleListB.length === 0}
                                <p class="text-center text-gray-400 text-xs py-4">Không tìm thấy dữ liệu.</p>
                            {/if}
                        </div>
                    </div>
                </div>

            </div>
        </div>

        <div class="p-4 border-t border-gray-200 bg-gray-50 flex justify-end gap-3">
            <button on:click={close} class="px-5 py-2.5 bg-white border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-100 font-medium transition-colors shadow-sm">Hủy</button>
            <button on:click={handleSave} class="px-6 py-2.5 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-bold shadow-md transition-colors flex items-center gap-2">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" />
                </svg>
                Lưu
            </button>
        </div>
    </div>
</div>
{/if}

<style>
    .custom-scrollbar::-webkit-scrollbar { width: 6px; }
    .custom-scrollbar::-webkit-scrollbar-track { background: #f1f1f1; }
    .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
    .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
</style>
--- END FILE: ./src/components/modals/AddEfficiencyColumnModal.svelte ---

--- START FILE: ./src/components/modals/AddMetricModal.svelte ---
<script>
    import { createEventDispatcher } from 'svelte';
    import { categoryStructure, macroCategoryConfig, macroProductGroupConfig } from '../../stores.js';
    import { cleanCategoryName } from '../../utils.js';

    export let isOpen = false;
    export let editItem = null; // [MỚI] Nhận item cần sửa

    const dispatch = createEventDispatcher();

    // Form data
    let label = '';
    let selectedGroups = [];
    let revenueType = 'REAL';
    let search = '';

    // Data Source
    $: allItems = [
        ...($macroCategoryConfig || []).map(m => m.name),
        ...($macroProductGroupConfig || []).map(m => m.name),
        ...[...new Set(($categoryStructure || []).map(c => cleanCategoryName(c.nganhHang)).filter(Boolean))],
        ...[...new Set(($categoryStructure || []).map(c => cleanCategoryName(c.nhomHang)).filter(Boolean))]
    ].sort();

    $: filteredList = allItems.filter(i => i.toLowerCase().includes(search.toLowerCase()));

    // [MỚI] Logic Reset / Load Data khi mở modal
    $: if (isOpen) {
        if (editItem) {
            // Chế độ Sửa: Load dữ liệu từ item cũ
            label = editItem.label;
            // Với đơn giá, groupA và groupB giống nhau, lấy groupA là đủ
            selectedGroups = [...(editItem.groupA || [])];
            // Xác định loại doanh thu: Nếu typeA là DTQD -> CONVERTED, ngược lại REAL
            revenueType = editItem.typeA === 'DTQD' ? 'CONVERTED' : 'REAL';
            search = '';
        } else {
            // Chế độ Thêm mới: Reset trắng
            label = '';
            selectedGroups = [];
            revenueType = 'REAL';
            search = '';
        }
    }

    function toggleItem(item) {
        if (selectedGroups.includes(item)) {
            selectedGroups = selectedGroups.filter(i => i !== item);
        } else {
            selectedGroups = [...selectedGroups, item];
        }
    }

    function handleSelectAll(isSelect) {
        selectedGroups = isSelect ? [...filteredList] : [];
    }

    function handleSave() {
        if (!label.trim()) return alert("Vui lòng nhập Tên Đơn giá.");
        if (selectedGroups.length === 0) return alert("Vui lòng chọn ít nhất 1 nhóm hàng.");

        const payload = {
            id: editItem ? editItem.id : `custom_price_${Date.now()}`, // Giữ ID cũ nếu sửa
            label: label,
            groupA: selectedGroups,
            groupB: selectedGroups,
            type: 'UNIT_PRICE',
            typeA: revenueType === 'REAL' ? 'DTTL' : 'DTQD',
            typeB: 'SL'
        };

        dispatch('save', payload);
        dispatch('close');
    }

    function close() {
        dispatch('close');
    }
</script>

{#if isOpen}
<div class="fixed inset-0 bg-gray-900 bg-opacity-60 z-[1300] flex items-center justify-center p-4 backdrop-blur-sm animate-fade-in" on:click={close} role="button" tabindex="0">
    <div class="bg-white rounded-xl shadow-2xl w-full max-w-lg flex flex-col max-h-[90vh] overflow-hidden" on:click|stopPropagation>
        
        <div class="p-5 border-b border-gray-200 flex justify-between items-center bg-gray-50">
            <div>
                <h3 class="text-lg font-bold text-gray-800 uppercase">
                    {editItem ? 'Chỉnh Sửa Đơn Giá' : 'Thêm Đơn Giá Mới'}
                </h3>
                <p class="text-xs text-gray-500 mt-1">Công thức: Tổng Doanh thu / Tổng Số lượng</p>
            </div>
            <button on:click={close} class="text-gray-400 hover:text-red-500 transition-colors text-2xl leading-none">&times;</button>
        </div>

        <div class="p-6 overflow-y-auto flex-1 bg-white custom-scrollbar">
            <div class="space-y-6">
                <div>
                    <label class="block text-sm font-bold text-gray-700 mb-2">1. Đặt tên Đơn giá <span class="text-red-500">*</span></label>
                    <input type="text" bind:value={label} class="w-full p-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none text-sm font-semibold" placeholder="VD: ĐG Tivi, ĐG Gia dụng..." autoFocus>
                </div>

                <div class="flex flex-col h-[300px] border border-gray-200 rounded-lg p-3 shadow-sm bg-gray-50">
                    <label class="block text-sm font-bold text-gray-700 mb-2">2. Chọn Nhóm hàng tính toán</label>
                    <div class="mb-2 relative">
                        <input type="text" bind:value={search} class="w-full p-2 pl-8 border border-gray-300 rounded text-xs focus:border-blue-500 outline-none bg-white" placeholder="Tìm kiếm nhóm hàng...">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 absolute left-2.5 top-2 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" /></svg>
                    </div>
                    <div class="flex justify-between items-center mb-2 px-1">
                        <span class="text-xs font-bold text-blue-600">Đã chọn: {selectedGroups.length}</span>
                        <div class="space-x-2">
                            <button on:click={() => handleSelectAll(true)} class="text-xs text-gray-500 hover:text-blue-600 underline">Chọn hết</button>
                            <button on:click={() => handleSelectAll(false)} class="text-xs text-gray-500 hover:text-red-600 underline">Bỏ chọn</button>
                        </div>
                    </div>
                    <div class="flex-grow overflow-y-auto custom-scrollbar bg-white border border-gray-200 rounded">
                        {#each filteredList as item}
                            <label class="flex items-center p-2 hover:bg-blue-50 cursor-pointer transition-colors border-b border-gray-100 last:border-0">
                                <input type="checkbox" checked={selectedGroups.includes(item)} on:change={() => toggleItem(item)} class="mr-3 w-4 h-4 accent-blue-600 rounded border-gray-300">
                                <span class="text-sm text-gray-700">{item}</span>
                            </label>
                        {/each}
                    </div>
                </div>

                <div class="bg-blue-50 p-4 rounded-lg border border-blue-100">
                    <label class="block text-sm font-bold text-blue-800 mb-2">3. Chọn loại Doanh thu (Tử số)</label>
                    <div class="flex gap-6">
                        <label class="inline-flex items-center cursor-pointer">
                            <input type="radio" bind:group={revenueType} value="REAL" class="w-4 h-4 text-blue-600 border-gray-300 focus:ring-blue-500">
                            <span class="ml-2 text-sm text-gray-700 font-medium">Doanh thu Thực (DTLK)</span>
                        </label>
                        <label class="inline-flex items-center cursor-pointer">
                            <input type="radio" bind:group={revenueType} value="CONVERTED" class="w-4 h-4 text-purple-600 border-gray-300 focus:ring-purple-500">
                            <span class="ml-2 text-sm text-gray-700 font-medium">Doanh thu Quy đổi (DTQĐ)</span>
                        </label>
                    </div>
                </div>
            </div>
        </div>

        <div class="p-4 border-t border-gray-200 bg-gray-50 flex justify-end gap-3">
            <button on:click={close} class="px-5 py-2.5 bg-white border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-100 font-medium text-sm transition-colors shadow-sm">Huỷ bỏ</button>
            <button on:click={handleSave} class="px-6 py-2.5 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-bold text-sm shadow-md transition-colors flex items-center gap-2">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" /></svg>
                Lưu Đơn Giá
            </button>
        </div>
    </div>
</div>
{/if}

<style>
    .custom-scrollbar::-webkit-scrollbar { width: 6px; }
    .custom-scrollbar::-webkit-scrollbar-track { background: #f1f1f1; }
    .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
    .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
    .animate-fade-in { animation: fadeIn 0.2s ease-out; }
    @keyframes fadeIn { from { opacity: 0; transform: scale(0.98); } to { opacity: 1; transform: scale(1); } }
</style>
--- END FILE: ./src/components/modals/AddMetricModal.svelte ---

--- START FILE: ./src/components/modals/AddPerformanceTableModal.svelte ---
<script>
    import { createEventDispatcher } from 'svelte';
    import { 
        categoryStructure, 
        macroCategoryConfig, 
        macroProductGroupConfig,
        efficiencyConfig,
        warehouseCustomMetrics
    } from '../../stores.js';
    import { parseIdentity } from '../../utils.js';

    export let isOpen = false;
    export let editItem = null; // null = tạo mới, object = sửa
    export let isSystem = false; // true = Admin tạo, false = User tạo

    const dispatch = createEventDispatcher();

    // --- CẤU HÌNH UI ---
    const COLORS = [
        { id: 'blue',   bg: 'bg-blue-500',   class: 'bg-blue-100 text-blue-900 border-blue-200', label: 'Xanh dương' },
        { id: 'green',  bg: 'bg-green-500',  class: 'bg-green-100 text-green-900 border-green-200', label: 'Xanh lá' },
        { id: 'orange', bg: 'bg-orange-500', class: 'bg-orange-100 text-orange-900 border-orange-200', label: 'Cam' },
        { id: 'purple', bg: 'bg-purple-500', class: 'bg-purple-100 text-purple-900 border-purple-200', label: 'Tím' },
        { id: 'teal',   bg: 'bg-teal-500',   class: 'bg-teal-100 text-teal-900 border-teal-200', label: 'Xanh cổ vịt' },
        { id: 'red',    bg: 'bg-red-500',    class: 'bg-red-100 text-red-900 border-red-200', label: 'Đỏ' },
        { id: 'gray',   bg: 'bg-gray-500',   class: 'bg-gray-100 text-gray-900 border-gray-200', label: 'Xám' }
    ];

    const DATA_TYPES = [
        { id: 'DT', label: 'Doanh thu', icon: 'dollar-sign' },
        { id: 'DTQD', label: 'DTQĐ', icon: 'refresh-cw' },
        { id: 'SL', label: 'Số lượng', icon: 'hash' },
        { id: 'PERCENT', label: 'Tỷ lệ %', icon: 'percent' }
    ];

    // --- DATA SOURCES ---
    let sourceList = []; 
    let searchFilter = '';

    // --- STATE ---
    let tableId = '';
    let tableName = '';
    let columns = [];
    let activeColIndex = 0;
    let wasOpen = false;

    $: activeColumn = columns[activeColIndex] || null;

    // --- INITIALIZATION ---
    $: if (isOpen) {
        if (!wasOpen) {
            initDataSource();
            if (editItem) {
                // Clone deep để ngắt tham chiếu với dữ liệu gốc
                tableId = editItem.id;
                tableName = editItem.title;
                columns = JSON.parse(JSON.stringify(editItem.columns || []));
            } else {
                resetForm();
            }
            if (columns.length === 0) addColumn();
            activeColIndex = 0;
            wasOpen = true;
        }
    } else {
        wasOpen = false;
        searchFilter = '';
    }

    function resetForm() {
        tableId = `perf_table_${Date.now()}`;
        tableName = '';
        columns = [];
    }

    function initDataSource() {
        const uniqueMap = new Map();

        // 1. MACRO CONFIG (Nhóm hàng lớn)
        ($macroCategoryConfig || []).forEach(m => {
            const id = (m.id || m.name).trim();
            if (!uniqueMap.has(id)) uniqueMap.set(id, { id, name: m.name, type: 'MACRO_CAT' });
        });

        ($macroProductGroupConfig || []).forEach(m => {
            const id = (m.id || m.name).trim();
            if (!uniqueMap.has(id)) uniqueMap.set(id, { id, name: m.name, type: 'MACRO_GROUP' });
        });
        
        // 2. DATA STRUCTURE (Từ file Excel) - [LOGIC ID]
        // Tách ID ra khỏi chuỗi "ID - Name" (Ví dụ: "304 - Điện tử" -> ID: "304")
        
        const processItem = (rawString, type) => {
            if (!rawString) return;
            // Sử dụng parseIdentity để tách mã và tên
            const { identity, name } = parseIdentity(rawString);
            
            // Logic quan trọng: Dùng ID (identity) làm Key chính
            // Nếu không tách được ID (identity trùng name), dùng nguyên chuỗi
            const key = identity || rawString.trim(); 
            const displayName = rawString.trim(); // Hiển thị vẫn giữ nguyên "304 - Điện tử" cho dễ nhìn

            if (!uniqueMap.has(key)) {
                uniqueMap.set(key, { id: key, name: displayName, type });
            }
        };

        ($categoryStructure || []).forEach(c => {
            if (c.nhomHang) processItem(c.nhomHang, 'GROUP');
            if (c.nganhHang) processItem(c.nganhHang, 'CATEGORY');
        });

        // Chuyển Map thành Array và sort theo tên hiển thị
        sourceList = Array.from(uniqueMap.values()).sort((a, b) => a.name.localeCompare(b.name));
    }

    // --- COLUMN ACTIONS ---
    function addColumn() {
        columns = [...columns, {
            id: `col_${Date.now()}`,
            header: `Cột ${columns.length + 1}`,
            type: 'DT',
            color: 'blue',
            items: [],
            numerator: [],
            denominator: [],
            targetId: null
        }];
        activeColIndex = columns.length - 1;
    }

    function removeColumn(index) {
        if (columns.length <= 1) return alert("Bảng cần ít nhất 1 cột.");
        if (confirm("Xóa cột này?")) {
            columns = columns.filter((_, i) => i !== index);
            if (activeColIndex >= columns.length) activeColIndex = columns.length - 1;
        }
    }

    // --- HANDLE CHANGES ---
    function updateActiveColumn(key, value) {
        if (!activeColumn) return;
        columns[activeColIndex][key] = value;
    }

    // --- SELECTION LOGIC ---
    function toggleSelection(item, targetArrayName) {
        if (!activeColumn) return;
        
        const currentArr = activeColumn[targetArrayName] || [];
        const idx = currentArr.indexOf(item.id); // Lưu ID (VD: "304")
        
        let newArr;
        if (idx >= 0) {
            newArr = currentArr.filter(i => i !== item.id);
        } else {
            newArr = [...currentArr, item.id];
        }
        
        columns[activeColIndex][targetArrayName] = newArr;
        if (activeColumn.type === 'PERCENT') detectExistingIndicator();
    }

    // [MỚI] Nút Xóa tất cả lựa chọn
    function clearAllSelection(targetArrayName) {
        if (!activeColumn) return;
        const currentArr = activeColumn[targetArrayName] || [];
        if (currentArr.length === 0) return;

        if (confirm(`Bạn có chắc muốn xóa tất cả ${currentArr.length} mục đã chọn?`)) {
            columns[activeColIndex][targetArrayName] = [];
            if (activeColumn.type === 'PERCENT') detectExistingIndicator();
        }
    }

    function toggleAll(targetArrayName, select) {
        if (!activeColumn) return;
        const visibleItems = sourceList
            .filter(i => i.name.toLowerCase().includes(searchFilter.toLowerCase()))
            .map(i => i.id);

        let newArr;
        if (select) {
            const currentSet = new Set(activeColumn[targetArrayName] || []);
            visibleItems.forEach(id => currentSet.add(id));
            newArr = [...currentSet];
        } else {
            const visibleSet = new Set(visibleItems);
            newArr = (activeColumn[targetArrayName] || []).filter(id => !visibleSet.has(id));
        }
        columns[activeColIndex][targetArrayName] = newArr;
    }

    function detectExistingIndicator() {
        if (!activeColumn || activeColumn.type !== 'PERCENT') return;

        const num = new Set(activeColumn.numerator || []);
        const den = new Set(activeColumn.denominator || []);

        const allConfigs = [...$efficiencyConfig, ...$warehouseCustomMetrics];
        
        const match = allConfigs.find(cfg => {
            const cfgNum = new Set(cfg.groupA || []);
            const cfgDen = new Set(cfg.groupB || []);
            const eq = (s1, s2) => s1.size === s2.size && [...s1].every(x => s2.has(x));
            return eq(num, cfgNum) && eq(den, cfgDen);
        });

        if (match) {
            columns[activeColIndex].targetId = match.id;
        } else {
            columns[activeColIndex].targetId = null;
        }
    }

    function handleSave() {
        if (!tableName.trim()) return alert("Vui lòng nhập Tên bảng.");
        if (columns.length === 0) return alert("Vui lòng thêm ít nhất 1 cột.");

        for (let i = 0; i < columns.length; i++) {
            const col = columns[i];
            if (!col.header.trim()) return alert(`Cột số ${i+1} chưa có tên.`);
            
            if (col.type === 'PERCENT') {
                if (col.numerator.length === 0) return alert(`Cột "${col.header}": Chưa chọn Tử số.`);
                if (col.denominator.length === 0) return alert(`Cột "${col.header}": Chưa chọn Mẫu số.`);
                
                if (!col.targetId) {
                    col.targetId = `eff_custom_${Date.now()}_${i}`;
                }
            } else {
                if (col.items.length === 0) return alert(`Cột "${col.header}": Chưa chọn nguồn dữ liệu.`);
            }
        }

        dispatch('save', {
            id: tableId,
            title: tableName,
            isSystem: isSystem,
            columns: columns
        });
        close();
    }

    function close() { dispatch('close'); }
</script>

{#if isOpen}
<div class="fixed inset-0 bg-gray-900/60 z-[1300] flex items-center justify-center p-4 backdrop-blur-sm" on:click={close} role="button" tabindex="0">
    <div class="bg-white rounded-xl shadow-2xl w-full max-w-[1200px] h-[90vh] flex flex-col overflow-hidden animate-scale-in" on:click|stopPropagation role="document" tabindex="0">
        
        <div class="p-4 border-b border-gray-200 flex justify-between items-center bg-gray-50">
            <div>
                <h3 class="text-xl font-bold text-gray-800 flex items-center gap-2">
                    <i data-feather="layout" class="w-5 h-5 text-blue-600"></i>
                    {editItem ? 'Chỉnh sửa' : 'Thêm mới'} Bảng Hiệu Quả
                    {#if isSystem}
                        <span class="text-xs bg-purple-100 text-purple-700 px-2 py-0.5 rounded border border-purple-200 uppercase font-bold">System</span>
                    {/if}
                </h3>
                <p class="text-xs text-gray-500 mt-1">Tạo bảng báo cáo tuỳ chỉnh với đa dạng loại dữ liệu (SL, DT, %)</p>
            </div>
            <button on:click={close} class="text-gray-400 hover:text-red-500 text-3xl leading-none transition-colors">&times;</button>
        </div>

        <div class="flex-1 overflow-hidden flex flex-col lg:flex-row">
            
            <div class="w-full lg:w-3/12 border-r border-gray-200 bg-white flex flex-col z-10 shadow-[2px_0_10px_rgba(0,0,0,0.05)]">
                <div class="p-4 border-b border-gray-100 bg-slate-50">
                    <label class="block text-[11px] font-bold text-gray-500 uppercase mb-1">Tên Bảng Hiển Thị</label>
                    <input 
                        type="text" 
                        bind:value={tableName} 
                        class="w-full p-2.5 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none font-bold text-gray-800 shadow-sm"
                        placeholder="VD: Hiệu quả Phụ Kiện..."
                    >
                </div>

                <div class="flex-1 overflow-y-auto p-3 space-y-2 custom-scrollbar bg-gray-50/50">
                    {#each columns as col, index}
                        <div 
                            class="bg-white border rounded-xl p-3 cursor-pointer transition-all relative group
                            {activeColIndex === index ? 'border-blue-500 ring-2 ring-blue-100 shadow-md' : 'border-gray-200 hover:border-blue-300 shadow-sm'}"
                            on:click={() => activeColIndex = index}
                            role="button" tabindex="0"
                        >
                            <div class="flex justify-between items-center mb-1">
                                <span class="text-[10px] font-bold uppercase text-gray-400 bg-gray-100 px-1.5 py-0.5 rounded">
                                    Cột {index + 1}
                                </span>
                                <button 
                                    class="text-gray-300 hover:text-red-500 p-1 rounded-md hover:bg-red-50 transition-colors"
                                    on:click|stopPropagation={() => removeColumn(index)}
                                    title="Xóa cột"
                                >
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
                                </button>
                            </div>
                            <div class="text-sm font-bold text-gray-700 truncate">{col.header}</div>
                            <div class="text-[10px] text-gray-500 mt-1 flex items-center gap-1">
                                <span class="w-2 h-2 rounded-full {COLORS.find(c=>c.id===col.color)?.bg || 'bg-blue-500'}"></span>
                                {DATA_TYPES.find(t=>t.id===col.type)?.label}
                            </div>
                        </div>
                    {/each}

                    <button 
                        class="w-full py-3 border-2 border-dashed border-gray-300 text-gray-500 rounded-xl hover:border-blue-500 hover:text-blue-600 hover:bg-blue-50 transition-all font-bold text-sm flex items-center justify-center gap-2 group"
                        on:click={addColumn}
                    >
                        <span class="bg-gray-200 group-hover:bg-blue-200 rounded-full p-0.5"><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 5a1 1 0 011 1v3h3a1 1 0 110 2h-3v3a1 1 0 11-2 0v-3H6a1 1 0 110-2h3V6a1 1 0 011-1z" clip-rule="evenodd" /></svg></span>
                        Thêm cột mới
                    </button>
                </div>
            </div>

            <div class="w-full lg:w-9/12 flex flex-col bg-slate-50 h-full">
                
                {#if activeColumn}
                    <div class="p-4 border-b border-gray-200 bg-white shadow-sm z-20 space-y-4">
                        <div class="grid grid-cols-1 md:grid-cols-12 gap-4 items-end">
                            <div class="md:col-span-4">
                                <label class="block text-[11px] font-bold text-gray-500 uppercase mb-1">Tiêu đề cột</label>
                                <input 
                                    type="text" 
                                    value={activeColumn.header} 
                                    on:input={(e) => updateActiveColumn('header', e.target.value)}
                                    class="w-full p-2 border border-gray-300 rounded text-sm font-bold text-gray-800 focus:border-blue-500 outline-none"
                                    placeholder="Nhập tên cột..."
                                >
                            </div>

                            <div class="md:col-span-5">
                                <label class="block text-[11px] font-bold text-gray-500 uppercase mb-1">Loại dữ liệu</label>
                                <div class="flex flex-wrap gap-2">
                                    {#each DATA_TYPES as type}
                                        <button 
                                            class="flex items-center gap-1.5 px-3 py-1.5 rounded-full border text-xs font-medium transition-all
                                            {activeColumn.type === type.id ? 'bg-blue-600 text-white border-blue-600 ring-2 ring-blue-100' : 'bg-white text-gray-600 border-gray-200 hover:bg-gray-50'}"
                                            on:click={() => updateActiveColumn('type', type.id)}
                                        >
                                            {#if type.icon === 'percent'}%{:else if type.icon === 'hash'}#{:else}${/if} {type.label}
                                        </button>
                                    {/each}
                                </div>
                            </div>

                            <div class="md:col-span-3">
                                <label class="block text-[11px] font-bold text-gray-500 uppercase mb-1">Màu sắc</label>
                                <div class="flex gap-1.5">
                                    {#each COLORS as color}
                                        <button 
                                            class="w-7 h-7 rounded-full border-2 transition-transform hover:scale-110 {color.bg}
                                            {activeColumn.color === color.id ? 'border-gray-800 scale-110 shadow-sm ring-2 ring-white' : 'border-transparent opacity-70 hover:opacity-100'}"
                                            on:click={() => updateActiveColumn('color', color.id)}
                                            title={color.label}
                                        ></button>
                                    {/each}
                                </div>
                            </div>
                        </div>

                        <div class="relative">
                            <input 
                                type="text" 
                                bind:value={searchFilter}
                                class="w-full pl-9 pr-4 py-2 bg-gray-50 border border-gray-200 rounded-lg focus:ring-1 focus:ring-blue-500 outline-none text-sm focus:bg-white transition-colors"
                                placeholder="🔍 Tìm kiếm nhóm hàng, ngành hàng để chọn..."
                            >
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 absolute left-3 top-3 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" /></svg>
                        </div>
                    </div>

                    <div class="flex-1 overflow-hidden p-4">
                        {#if activeColumn.type === 'PERCENT'}
                            <div class="flex h-full gap-4">
                                <div class="flex-1 flex flex-col border border-blue-200 rounded-xl overflow-hidden shadow-sm bg-white">
                                    <div class="bg-blue-50 p-2 border-b border-blue-200 flex justify-between items-center">
                                        <span class="font-bold text-blue-800 text-xs uppercase flex items-center gap-1">
                                            <span class="bg-blue-600 text-white w-5 h-5 flex items-center justify-center rounded-full text-[10px]">A</span> Tử Số
                                        </span>
                                        <div class="flex gap-2 text-[10px]">
                                            <button class="text-blue-600 font-bold hover:underline" on:click={() => toggleAll('numerator', true)}>Chọn hết</button>
                                            <button class="text-red-500 font-bold hover:underline" on:click={() => clearAllSelection('numerator')}>Xóa tất cả</button>
                                        </div>
                                    </div>
                                    <div class="flex-1 overflow-y-auto p-2 custom-scrollbar">
                                        {@render DataSourceList({ 
                                            items: sourceList, 
                                            selectedIds: activeColumn.numerator, 
                                            filter: searchFilter, 
                                            onToggle: (item) => toggleSelection(item, 'numerator'),
                                            selectedColor: "bg-blue-50 border-blue-300 text-blue-800"
                                        })}
                                    </div>
                                    <div class="bg-gray-50 p-2 text-[10px] text-gray-500 text-center border-t border-gray-100">
                                        Đã chọn: <strong>{activeColumn.numerator.length}</strong>
                                    </div>
                                </div>

                                <div class="flex-1 flex flex-col border border-orange-200 rounded-xl overflow-hidden shadow-sm bg-white">
                                    <div class="bg-orange-50 p-2 border-b border-orange-200 flex justify-between items-center">
                                        <span class="font-bold text-orange-800 text-xs uppercase flex items-center gap-1">
                                            <span class="bg-orange-500 text-white w-5 h-5 flex items-center justify-center rounded-full text-[10px]">B</span> Mẫu Số
                                        </span>
                                        <div class="flex gap-2 text-[10px]">
                                            <button class="text-orange-600 font-bold hover:underline" on:click={() => toggleAll('denominator', true)}>Chọn hết</button>
                                            <button class="text-red-500 font-bold hover:underline" on:click={() => clearAllSelection('denominator')}>Xóa tất cả</button>
                                        </div>
                                    </div>
                                    <div class="flex-1 overflow-y-auto p-2 custom-scrollbar">
                                        {@render DataSourceList({ 
                                            items: sourceList, 
                                            selectedIds: activeColumn.denominator, 
                                            filter: searchFilter, 
                                            onToggle: (item) => toggleSelection(item, 'denominator'),
                                            selectedColor: "bg-orange-50 border-orange-300 text-orange-800"
                                        })}
                                    </div>
                                    <div class="bg-gray-50 p-2 text-[10px] text-gray-500 text-center border-t border-gray-100">
                                        Đã chọn: <strong>{activeColumn.denominator.length}</strong>
                                    </div>
                                </div>
                            </div>
                            {#if activeColumn.targetId}
                                <div class="mt-2 text-center">
                                    <span class="inline-flex items-center gap-1 text-xs text-green-600 bg-green-50 px-2 py-1 rounded-full border border-green-200">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" /></svg>
                                        Đã tự động liên kết với chỉ số mục tiêu hệ thống
                                    </span>
                                </div>
                            {/if}

                        {:else}
                            <div class="h-full flex flex-col border border-gray-200 rounded-xl overflow-hidden shadow-sm bg-white">
                                <div class="bg-gray-50 p-2 border-b border-gray-200 flex justify-between items-center">
                                    <span class="font-bold text-gray-700 text-xs uppercase">Danh sách Nguồn dữ liệu</span>
                                    <div class="flex gap-3 text-xs">
                                        <button class="text-blue-600 font-bold hover:underline" on:click={() => toggleAll('items', true)}>Chọn hiển thị ({sourceList.filter(i => i.name.toLowerCase().includes(searchFilter.toLowerCase())).length})</button>
                                        <button class="text-red-500 font-bold hover:underline" on:click={() => clearAllSelection('items')}>Xóa tất cả</button>
                                    </div>
                                </div>
                                <div class="flex-1 overflow-y-auto p-3 custom-scrollbar">
                                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-2">
                                        {@render DataSourceList({ 
                                            items: sourceList, 
                                            selectedIds: activeColumn.items, 
                                            filter: searchFilter, 
                                            onToggle: (item) => toggleSelection(item, 'items'),
                                            selectedColor: "bg-blue-50 border-blue-300 text-blue-800 ring-1 ring-blue-200",
                                            gridLayout: true
                                        })}
                                    </div>
                                </div>
                                <div class="bg-gray-50 p-2 text-xs text-gray-500 border-t border-gray-200 flex justify-between px-4">
                                    <span>Tổng nguồn: {sourceList.length}</span>
                                    <span>Đã chọn: <strong>{activeColumn.items.length}</strong></span>
                                </div>
                            </div>
                        {/if}
                    </div>

                {:else}
                    <div class="h-full flex items-center justify-center text-gray-400 bg-gray-50">
                        <div class="text-center">
                            <i data-feather="arrow-left" class="w-8 h-8 mx-auto mb-2 opacity-50"></i>
                            <p>Vui lòng chọn hoặc thêm một cột để cấu hình.</p>
                        </div>
                    </div>
                {/if}
            </div>
        </div>

        <div class="p-4 border-t border-gray-200 bg-white flex justify-end gap-3 z-30">
            <button on:click={close} class="px-6 py-2.5 bg-white border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-100 font-medium transition-colors shadow-sm">Hủy</button>
            <button on:click={handleSave} class="px-8 py-2.5 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-bold shadow-md transition-colors flex items-center gap-2">
                <i data-feather="save" class="w-4 h-4"></i> Lưu Bảng
            </button>
        </div>
    </div>
</div>
{/if}

{#snippet DataSourceList({ items, selectedIds, filter, onToggle, selectedColor, gridLayout = false })}
    {#each items.filter(i => i.name.toLowerCase().includes(filter.toLowerCase())) as item (item.id)}
        {@const isSelected = selectedIds.includes(item.id)}
        <div 
            class="flex items-center p-2 rounded cursor-pointer border transition-all select-none
            {isSelected ? selectedColor : 'bg-white border-transparent hover:bg-gray-50 hover:border-gray-200'}"
            on:click={() => onToggle(item)}
            role="button" tabindex="0"
        >
            <div class="mr-2 flex-shrink-0 flex items-center justify-center w-4 h-4 border rounded 
                {isSelected ? 'bg-blue-600 border-transparent' : 'border-gray-300 bg-white'}">
                {#if isSelected}
                    <svg xmlns="http://www.w3.org/2000/svg" class="w-3 h-3 text-white" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" />
                    </svg>
                {/if}
            </div>
            <span class="text-xs truncate flex-1 {isSelected ? 'font-bold' : 'text-gray-600'}">
                {item.name}
            </span>
            {#if item.type.includes('MACRO')}
                <span class="text-[9px] px-1 bg-gray-200 text-gray-500 rounded ml-1 font-bold">GỘP</span>
            {/if}
        </div>
    {/each}
{/snippet}

<style>
    .animate-scale-in { animation: scaleIn 0.2s ease-out; }
    @keyframes scaleIn { from { opacity: 0; transform: scale(0.98); } to { opacity: 1; transform: scale(1); } }
    
    .custom-scrollbar::-webkit-scrollbar { width: 6px; }
    .custom-scrollbar::-webkit-scrollbar-track { background: #f8fafc; }
    .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
    .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
</style>
--- END FILE: ./src/components/modals/AddPerformanceTableModal.svelte ---

--- START FILE: ./src/components/modals/AddRevenueTableModal.svelte ---
<script>
    import { createEventDispatcher } from 'svelte';
    import { categoryStructure } from '../../stores.js';
    import { parseIdentity } from '../../utils.js';

    export let isOpen = false;
    export let editItem = null;

    const dispatch = createEventDispatcher();

    // --- DỮ LIỆU ---
    let tableName = '';
    let tableId = '';
    let isSystem = false; // [FIX] Biến cờ xác định bảng hệ thống
    
    // Cấu hình Cột Tổng (Main Column)
    let mainColumn = {
        header: 'Tổng cộng',
        type: 'group', // 'group' | 'category'
        items: [],     // Danh sách ID đã chọn
        metrics: { sl: false, dt: true, dtqd: false }
    };

    // Danh sách Cột Phụ
    let subColumns = [];
    
    // --- UI STATE ---
    let activeContext = 'main'; // 'main' | 'sub'
    let activeSubIndex = 0;     // Index nếu đang sửa sub column
    let searchText = '';
    let showSelectedOnly = false;

    // --- HELPER: Lấy cột đang Active ---
    $: activeColumn = activeContext === 'main' ? mainColumn : subColumns[activeSubIndex];

    // 1. Chuẩn hóa Ngành hàng (Lấy ID)
    $: uniqueCategories = (() => {
        const map = new Map();
        ($categoryStructure || []).forEach(c => {
            if(!c.nganhHang) return;
            const parsed = parseIdentity(c.nganhHang);
            map.set(parsed.id, { 
                id: parsed.id, 
                name: parsed.name, 
                display: parsed.name.includes(parsed.id) ? parsed.name : `${parsed.id} - ${parsed.name}`
            });
        });
        return Array.from(map.values()).sort((a,b) => a.name.localeCompare(b.name));
    })();

    // 2. Chuẩn hóa Nhóm hàng (Lấy ID)
    $: uniqueGroups = (() => {
        const map = new Map();
        ($categoryStructure || []).forEach(c => {
            if(!c.nhomHang) return;
            const id = c.maNhomHang || parseIdentity(c.nhomHang).id;
            const name = c.nhomHang;
            map.set(id, { 
                id: id, 
                name: name, 
                display: name.includes(id) ? name : `${id} - ${name}`
            });
        });
        return Array.from(map.values()).sort((a,b) => a.name.localeCompare(b.name));
    })();

    // --- INIT ---
    $: if (isOpen) {
        if (editItem) {
            tableId = editItem.id;
            tableName = editItem.title;
            // [FIX] Lấy trạng thái isSystem từ item sửa hoặc payload
            isSystem = !!editItem.isSystem; 
            
            mainColumn = editItem.mainColumn ? JSON.parse(JSON.stringify(editItem.mainColumn)) : { 
                header: 'Tổng cộng', type: 'group', items: [], metrics: { sl: false, dt: true, dtqd: false } 
            };
            subColumns = JSON.parse(JSON.stringify(editItem.subColumns || []));
        } else {
            // [FIX] Reset form và kiểm tra payload (Admin truyền { isSystem: true })
            isSystem = editItem?.isSystem || false;

            tableId = `tbl_${Date.now()}`;
            tableName = '';
            mainColumn = { 
                header: 'Tổng cộng', type: 'group', items: [], metrics: { sl: false, dt: true, dtqd: false } 
            };
            subColumns = [];
            addSubColumn();
        }
        selectMain();
    }

    // --- NAVIGATION ---
    function selectMain() {
        activeContext = 'main';
        resetFilter();
    }

    function selectSub(index) {
        activeContext = 'sub';
        activeSubIndex = index;
        resetFilter();
    }

    function resetFilter() {
        searchText = '';
        showSelectedOnly = false;
    }

    // --- COLUMN ACTIONS ---
    function addSubColumn() {
        subColumns = [
            ...subColumns, 
            { 
                header: `Cột ${subColumns.length + 1}`, 
                type: 'group', 
                items: [], 
                metrics: { sl: false, dt: true, dtqd: false } 
            }
        ];
        selectSub(subColumns.length - 1);
    }

    function removeSubColumn(index) {
        if(subColumns.length <= 1) return alert("Cần ít nhất 1 cột phụ.");
        if(!confirm("Xóa cột này?")) return;
        
        subColumns = subColumns.filter((_, i) => i !== index);
        if (activeSubIndex >= subColumns.length) {
            activeSubIndex = subColumns.length - 1;
        }
    }

    // --- ITEM SELECTION LOGIC ---
    function toggleItem(itemId) {
        const currentItems = new Set(activeColumn.items || []);
        if (currentItems.has(itemId)) currentItems.delete(itemId);
        else currentItems.add(itemId);
        activeColumn.items = [...currentItems];
    }

    function toggleAll(listSource) {
        const allIds = listSource.map(i => i.id);
        const currentLen = activeColumn.items.length;
        
        if (currentLen > 0 && currentLen >= allIds.length) {
            activeColumn.items = [];
        } else {
            activeColumn.items = [...allIds];
        }
    }

    function clearSelection() {
        if(!confirm("Xóa sạch danh sách đã chọn của cột này?")) return;
        activeColumn.items = [];
    }

    function handleTypeChange(newType) {
        activeColumn.type = newType;
    }

    // --- SAVE ---
    function handleSave() {
        if (!tableName.trim()) return alert("Vui lòng nhập Tên bảng.");
        if (!mainColumn.header.trim()) return alert("Vui lòng nhập tên Cột Tổng.");
        
        if (subColumns.length === 0) return alert("Vui lòng thêm ít nhất 1 cột phụ.");
        
        for (let i = 0; i < subColumns.length; i++) {
            const col = subColumns[i];
            if (!col.header.trim()) return alert(`Cột phụ số ${i+1} chưa có tên.`);
            if (!col.items || col.items.length === 0) return alert(`Cột "${col.header}" chưa chọn dữ liệu.`);
        }

        dispatch('save', {
            id: tableId,
            title: tableName,
            isSystem: isSystem, // [FIX] Quan trọng: Gửi cờ hệ thống về App
            mainColumn: mainColumn, 
            subColumns: subColumns
        });
        close();
    }

    function close() { dispatch('close'); }

    // --- FILTER LOGIC ---
    $: currentListSource = (activeColumn.type === 'category') ? uniqueCategories : uniqueGroups;
    
    $: filteredList = currentListSource.filter(item => {
        const matchesSearch = item.display.toLowerCase().includes(searchText.toLowerCase());
        const isSelected = activeColumn.items?.includes(item.id);
        if (showSelectedOnly) return matchesSearch && isSelected;
        return matchesSearch;
    });

</script>

{#if isOpen}
<div class="fixed inset-0 bg-gray-900 bg-opacity-50 z-[1300] flex items-center justify-center p-4 backdrop-blur-sm" on:click={close} role="button" tabindex="0">
    <div class="bg-white rounded-xl shadow-2xl w-full max-w-6xl max-h-[95vh] flex flex-col overflow-hidden" on:click|stopPropagation role="document" tabindex="0">
        
        <div class="p-4 border-b border-gray-200 flex justify-between items-center bg-gray-50">
            <div>
                <h3 class="text-lg font-bold text-gray-800">
                    {editItem ? 'Chỉnh sửa' : 'Thêm mới'} Bảng Doanh Thu 
                    {#if isSystem}
                        <span class="ml-2 text-xs bg-indigo-100 text-indigo-700 px-2 py-1 rounded border border-indigo-200 uppercase">Hệ thống</span>
                    {/if}
                </h3>
                <p class="text-xs text-gray-500">Cấu hình nguồn dữ liệu theo ID cho từng cột.</p>
            </div>
            <button on:click={close} class="text-gray-400 hover:text-red-500 text-2xl leading-none">&times;</button>
        </div>

        <div class="flex-1 overflow-hidden flex flex-col lg:flex-row bg-gray-50">
            
            <div class="w-full lg:w-1/3 border-r border-gray-200 bg-white flex flex-col">
                <div class="p-4 border-b border-gray-100 bg-slate-50">
                    <label class="block text-[10px] font-bold text-gray-500 uppercase mb-1">Tên Bảng</label>
                    <input 
                        type="text" 
                        bind:value={tableName} 
                        class="w-full p-2 border border-gray-300 rounded text-sm focus:ring-1 focus:ring-blue-500 outline-none font-bold text-gray-800"
                        placeholder="VD: Báo cáo Apple..."
                    >
                </div>

                <div class="flex-1 overflow-y-auto p-3 space-y-3 custom-scrollbar">
                    
                    <div 
                        class="border-2 rounded-lg p-3 cursor-pointer transition-all relative
                        {activeContext === 'main' ? 'border-orange-400 bg-orange-50 shadow-md ring-1 ring-orange-300' : 'border-gray-200 bg-white hover:border-orange-200'}"
                        on:click={selectMain}
                        role="button" tabindex="0"
                    >
                        <div class="flex items-center justify-between mb-2">
                            <div class="flex items-center gap-2">
                                <span class="bg-orange-500 text-white text-[10px] font-bold px-2 py-0.5 rounded uppercase">Main</span>
                                <span class="text-xs font-bold text-gray-700 uppercase">Cột Tổng</span>
                            </div>
                            <span class="text-[10px] bg-white border border-gray-200 text-gray-500 px-1.5 py-0.5 rounded">
                                {mainColumn.items.length} mục
                            </span>
                        </div>
                        
                        <div class="space-y-2">
                            <input 
                                type="text" 
                                bind:value={mainColumn.header} 
                                class="w-full bg-transparent border-b border-gray-300 focus:border-orange-500 outline-none text-sm font-bold text-gray-800 pb-1"
                                placeholder="Tên cột tổng..."
                            >
                            <div class="flex gap-2">
                                <label class="flex items-center text-[10px] text-gray-600 cursor-pointer"><input type="checkbox" bind:checked={mainColumn.metrics.sl} class="mr-1 accent-orange-600"> SL</label>
                                <label class="flex items-center text-[10px] text-gray-600 cursor-pointer"><input type="checkbox" bind:checked={mainColumn.metrics.dt} class="mr-1 accent-orange-600"> DT</label>
                                <label class="flex items-center text-[10px] text-gray-600 cursor-pointer"><input type="checkbox" bind:checked={mainColumn.metrics.dtqd} class="mr-1 accent-orange-600"> DTQĐ</label>
                            </div>
                        </div>
                    </div>

                    <div class="flex items-center gap-2 text-[10px] text-gray-400 uppercase font-bold px-1">
                        <div class="flex-1 h-px bg-gray-200"></div>
                        Các cột phụ
                        <div class="flex-1 h-px bg-gray-200"></div>
                    </div>

                    {#each subColumns as col, index}
                        <div 
                            class="border rounded p-3 cursor-pointer transition-all relative group
                            {activeContext === 'sub' && activeSubIndex === index ? 'border-blue-500 bg-blue-50 shadow-sm ring-1 ring-blue-500' : 'border-gray-200 bg-white hover:border-blue-300'}"
                            on:click={() => selectSub(index)}
                            role="button" tabindex="0"
                        >
                            <button 
                                class="absolute top-2 right-2 text-gray-300 hover:text-red-500 opacity-0 group-hover:opacity-100 transition-opacity"
                                on:click|stopPropagation={() => removeSubColumn(index)}
                                title="Xóa cột này"
                            >
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
                            </button>

                            <div class="space-y-2 pr-4">
                                <div class="flex justify-between items-center">
                                    <label class="text-[10px] text-gray-400 font-bold uppercase">Cột {index + 1}</label>
                                    <span class="text-[10px] bg-gray-100 text-gray-500 px-1.5 py-0.5 rounded">
                                        {col.items.length} mục
                                    </span>
                                </div>
                                <input 
                                    type="text" 
                                    bind:value={col.header} 
                                    class="w-full bg-transparent border-b border-gray-300 focus:border-blue-500 outline-none text-sm font-semibold text-gray-700 pb-1"
                                    placeholder="Nhập tên cột..."
                                >
                                <div class="flex gap-2">
                                    <label class="flex items-center text-[10px] text-gray-600 cursor-pointer"><input type="checkbox" bind:checked={col.metrics.sl} class="mr-1 rounded text-blue-600"> SL</label>
                                    <label class="flex items-center text-[10px] text-gray-600 cursor-pointer"><input type="checkbox" bind:checked={col.metrics.dt} class="mr-1 rounded text-blue-600"> DT</label>
                                    <label class="flex items-center text-[10px] text-gray-600 cursor-pointer"><input type="checkbox" bind:checked={col.metrics.dtqd} class="mr-1 rounded text-blue-600"> DTQĐ</label>
                                </div>
                            </div>
                        </div>
                    {/each}
                </div>

                <div class="p-3 border-t border-gray-200">
                    <button 
                        class="w-full py-2 border-2 border-dashed border-gray-300 text-gray-500 rounded hover:border-blue-500 hover:text-blue-500 transition font-bold text-sm flex items-center justify-center gap-2"
                        on:click={addSubColumn}
                    >
                        + Thêm cột phụ
                    </button>
                </div>
            </div>

            <div class="w-full lg:w-2/3 flex flex-col bg-slate-50">
                <div class="p-3 border-b border-gray-200 bg-white shadow-sm z-10 space-y-3">
                    <div class="flex justify-between items-start">
                        <div>
                            <h4 class="font-bold text-slate-800 text-sm">
                                Cấu hình: <span class="{activeContext === 'main' ? 'text-orange-600' : 'text-blue-600'}">"{activeColumn.header}"</span>
                            </h4>
                            <div class="flex gap-4 mt-2 text-xs font-medium text-gray-600">
                                <label class="flex items-center cursor-pointer hover:text-black">
                                    <input 
                                        type="radio" 
                                        name="colType"
                                        checked={activeColumn.type === 'group'} 
                                        on:change={() => handleTypeChange('group')}
                                        class="mr-1.5 w-4 h-4 {activeContext === 'main' ? 'accent-orange-600' : 'accent-blue-600'}"
                                    > 
                                    Nhóm Hàng
                                </label>
                                <label class="flex items-center cursor-pointer hover:text-black">
                                    <input 
                                        type="radio" 
                                        name="colType"
                                        checked={activeColumn.type === 'category'} 
                                        on:change={() => handleTypeChange('category')}
                                        class="mr-1.5 w-4 h-4 {activeContext === 'main' ? 'accent-orange-600' : 'accent-blue-600'}"
                                    > 
                                    Ngành Hàng
                                </label>
                            </div>
                        </div>
                        
                        <div class="flex gap-2">
                            <button 
                                class="px-2 py-1 text-xs font-medium rounded border transition-colors {showSelectedOnly ? (activeContext === 'main' ? 'bg-orange-100 text-orange-700 border-orange-200' : 'bg-blue-100 text-blue-700 border-blue-200') : 'bg-white text-gray-600 border-gray-300 hover:bg-gray-50'}"
                                on:click={() => showSelectedOnly = !showSelectedOnly}
                            >
                                {showSelectedOnly ? 'Hiện tất cả' : `Đã chọn (${activeColumn.items.length})`}
                            </button>
                            
                            <button 
                                class="px-2 py-1 text-xs font-bold text-red-600 bg-red-50 border border-red-200 rounded hover:bg-red-100 transition flex items-center gap-1"
                                on:click={clearSelection}
                                title="Xóa sạch dữ liệu đã chọn"
                            >
                                Xóa chọn 🧹
                            </button>
                        </div>
                    </div>
                    
                    <div class="relative">
                        <input 
                            type="text" 
                            bind:value={searchText}
                            class="w-full pl-9 pr-4 py-2 border border-gray-300 rounded focus:ring-1 {activeContext === 'main' ? 'focus:ring-orange-500' : 'focus:ring-blue-500'} outline-none text-sm"
                            placeholder="Tìm kiếm tên hoặc mã..."
                        >
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 absolute left-3 top-3 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" /></svg>
                    </div>
                </div>

                <div class="flex-1 overflow-y-auto p-4 custom-scrollbar">
                     <div class="mb-3 flex justify-between items-center px-1">
                        <span class="text-xs text-gray-500 italic">Tìm thấy {filteredList.length} mục</span>
                        <button 
                            class="text-xs font-bold hover:underline {activeContext === 'main' ? 'text-orange-600' : 'text-blue-600'}"
                            on:click={() => toggleAll(filteredList)}
                        >
                            {activeColumn.items.length >= filteredList.length && filteredList.length > 0 ? 'Bỏ chọn tất cả' : 'Chọn tất cả'}
                        </button>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-2">
                        {#each filteredList as item (item.id)}
                            {@const isChecked = activeColumn.items.includes(item.id)}
                            <label 
                                class="flex items-start p-2 rounded border cursor-pointer transition-all select-none
                                {isChecked 
                                    ? (activeContext === 'main' ? 'bg-orange-50 border-orange-300 ring-1 ring-orange-300' : 'bg-blue-50 border-blue-300 ring-1 ring-blue-300') 
                                    : 'bg-white border-gray-200 hover:border-gray-300 hover:shadow-sm'}"
                            >
                                <input 
                                    type="checkbox" 
                                    checked={isChecked} 
                                    on:change={() => toggleItem(item.id)}
                                    class="mt-1 mr-3 w-4 h-4 rounded border-gray-300 {activeContext === 'main' ? 'accent-orange-600' : 'accent-blue-600'}"
                                >
                                <div class="flex flex-col overflow-hidden">
                                    <span class="text-sm font-medium text-gray-800 truncate" title={item.display}>{item.display}</span>
                                    <span class="text-[10px] text-gray-500 font-mono mt-0.5">ID: {item.id}</span>
                                </div>
                            </label>
                        {:else}
                            <div class="col-span-full py-10 text-center">
                                <div class="text-gray-300 mb-2 text-4xl">📭</div>
                                <p class="text-gray-500 text-sm">Không tìm thấy dữ liệu.</p>
                            </div>
                        {/each}
                    </div>
                </div>
            </div>
        </div>

        <div class="p-4 border-t border-gray-200 bg-white flex justify-end gap-3 z-20">
            <button on:click={close} class="px-6 py-2 bg-white border border-gray-300 text-gray-700 rounded hover:bg-gray-100 font-medium transition-colors shadow-sm">Hủy</button>
            <button on:click={handleSave} class="px-8 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 font-bold shadow-md transition-colors flex items-center gap-2">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" /></svg>
                Lưu Bảng
            </button>
        </div>
    </div>
</div>
{/if}

<style>
    .custom-scrollbar::-webkit-scrollbar { width: 6px; }
    .custom-scrollbar::-webkit-scrollbar-track { background: #f1f1f1; }
    .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
    .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
</style>
--- END FILE: ./src/components/modals/AddRevenueTableModal.svelte ---

--- START FILE: ./src/components/modals/AdminModal.svelte ---
<script>
    import { modalState, activeTab } from '../../stores.js';
    import { authService } from '../../services/auth.service.js';
    import { tick } from 'svelte';

    let password = '';
    let showError = false;
    let passwordInput;
    let isBackdropMouseDown = false; // [FIX] Biến cờ kiểm tra

    // Reactive: Kiểm tra modal
    $: isOpen = $modalState.activeModal === 'admin-modal';

    // Reactive: Khi mở modal, reset form và focus input
    $: if (isOpen) {
        resetForm();
        focusInput();
    }

    async function focusInput() {
        await tick();
        if (passwordInput) passwordInput.focus();
    }

    function resetForm() {
        password = '';
        showError = false;
    }

    function close() {
        modalState.update(s => ({ ...s, activeModal: null }));
    }

    function submit() {
        const isValid = authService.checkAdminPassword(password);
        if (isValid) {
            activeTab.set('declaration-section');
            close();
        } else {
            showError = true;
            password = '';
            focusInput();
        }
    }

    function handleKeydown(event) {
        if (event.key === 'Enter') submit();
        else if (event.key === 'Escape') close();
    }

    // [FIX] Logic xử lý click backdrop an toàn
    function handleBackdropMouseDown(e) {
        if (e.target === e.currentTarget) {
            isBackdropMouseDown = true;
        }
    }

    function handleBackdropClick(e) {
        if (e.target === e.currentTarget && isBackdropMouseDown) {
            close();
        }
        isBackdropMouseDown = false; // Reset sau mỗi lần click
    }
</script>

{#if isOpen}
    <div 
        class="fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center z-[1050] transition-opacity backdrop-blur-sm"
        on:mousedown={handleBackdropMouseDown}
        on:click={handleBackdropClick}
        role="button"
        tabindex="0"
    >
        <div 
            class="bg-white p-6 rounded-xl shadow-xl w-full max-w-sm mx-4 transform transition-all scale-100"
            on:click|stopPropagation
            on:mousedown|stopPropagation={() => isBackdropMouseDown = false} 
        >
            <div class="mb-4">
                <h3 class="text-lg font-bold text-gray-900">Truy cập khu vực Admin</h3>
            </div>
            
            <p class="text-sm text-gray-600 mb-4">
                 Vui lòng nhập mật khẩu để xem và chỉnh sửa phần Khai báo.
            </p>

            <div class="mb-6">
                <input 
                    bind:this={passwordInput}
                    type="password" 
                    class="w-full p-2.5 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition-colors 
                           {showError ? 'border-red-500 bg-red-50' : 'border-gray-300'}" 
                    placeholder="Nhập mật khẩu..."
                    bind:value={password}
                    on:keydown={handleKeydown}
                >
                {#if showError}
                    <p class="text-red-500 text-sm mt-2 animate-pulse flex items-center">
                         <span class="mr-1">🚫</span> Mật khẩu không đúng. Vui lòng thử lại.
                    </p>
                {/if}
            </div>

            <div class="flex justify-end space-x-3 border-t pt-4">
                <button 
                    class="px-4 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 transition-colors font-medium text-sm"
                    on:click={close}
                >
                    Hủy
                </button>
                <button 
                    class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors font-bold text-sm shadow-sm"
                    on:click={submit}
                >
                    Xác nhận
                </button>
            </div>
        </div>
    </div>
{/if}
--- END FILE: ./src/components/modals/AdminModal.svelte ---

--- START FILE: ./src/components/modals/ComposerModal.svelte ---
<script>
  import { onMount, tick } from 'svelte';
  import { 
    modalState, 
    composerTemplates, 
    danhSachNhanVien, 
    ycxData, 
    realtimeYCXData, 
    luykeGoalSettings, 
    realtimeGoalSettings, 
    selectedWarehouse, 
    masterReportData,
    competitionData,
    globalCompetitionConfigs,
    localCompetitionConfigs,
    notificationStore
  } from '../../stores.js';
  
  import { composerService } from '../../services/composerService.js';
  import { reportService } from '../../services/reportService.js';
  
  // [SỬA LỖI]: Import từ services thay vì modules
  import { settingsService } from '../../services/settings.service.js';
  
  import { cleanCategoryName } from '../../utils.js';

  // --- CẤU HÌNH TAB ---
  const CONFIG = {
      luyke: {
          label: 'Sức khỏe Siêu thị (Lũy kế)',
          subTabs: [
              { id: 'subtab-luyke-sieu-thi', label: 'Siêu thị Lũy kế' },
              { id: 'subtab-luyke-thi-dua', label: 'Thi đua Lũy kế' },
              { id: 'subtab-luyke-thidua-vung', label: 'Thi Đua Vùng TNB' }
          ]
      },
      sknv: {
          label: 'Sức khỏe Nhân viên',
          subTabs: [
              { id: 'subtab-sknv', label: 'SKNV' },
              { id: 'subtab-doanhthu', label: 'Doanh thu LK' },
              { id: 'subtab-thunhap', label: 'Thu nhập' },
              { id: 'subtab-hieuqua', label: 'Hiệu quả NV LK' },
              { id: 'subtab-nganhhang', label: 'DT ngành hàng' },
              { id: 'subtab-thidua', label: 'Thi đua NV LK' }
          ]
      },
      realtime: {
          label: 'Doanh thu Realtime',
          subTabs: [
              { id: 'subtab-realtime-sieu-thi', label: 'Siêu thị Realtime' },
              { id: 'subtab-realtime-nhan-vien', label: 'DT NV Realtime' },
              { id: 'subtab-realtime-hieu-qua-nhan-vien', label: 'Hiệu quả NV Realtime' },
              { id: 'subtab-realtime-nganh-hang', label: 'Ngành hàng Realtime' },
              { id: 'subtab-realtime-hang-ban', label: 'DT Hãng Realtime' },
              { id: 'subtab-realtime-thi-dua', label: 'Thi đua NV Realtime' }
          ]
      }
  };

  // --- STATE ---
  $: isOpen = $modalState.activeModal === 'composer-modal';
  $: context = $modalState.context || 'luyke'; 
  
  let activeSubTabId = '';
  let activeTagTab = 'general'; 
  let editorContent = '';
  let textareaEl;
  
  // Filter Ranking
  let rankingDept = 'ALL';
  $: uniqueDepartments = [...new Set($danhSachNhanVien.map(nv => nv.boPhan).filter(Boolean))].sort();

  // Computed Data cho Tags
  let supermarketReport = {};
  let rankingReportData = [];
  let compData = [];
  let currentGoals = {};

  // --- LOGIC ---

  // 1. Khởi tạo khi mở Modal
  $: if (isOpen && context) {
      initializeData();
  }

  async function initializeData() {
      if (!activeSubTabId && CONFIG[context]) {
          activeSubTabId = CONFIG[context].subTabs[0].id;
      }
      
      if ($composerTemplates[context] && $composerTemplates[context][activeSubTabId]) {
          editorContent = $composerTemplates[context][activeSubTabId];
      } else {
          editorContent = '';
      }

      await calculateReportData();
  }

  // 2. Tính toán dữ liệu nền
  async function calculateReportData() {
      const warehouse = $selectedWarehouse;
      let sourceData = [];
      let isRealtime = false;

      if (context === 'realtime') {
          sourceData = $realtimeYCXData;
          const settings = settingsService.getRealtimeGoalSettings(warehouse);
          currentGoals = settings.goals || {};
          isRealtime = true;
      } else {
          sourceData = $ycxData;
          const settings = settingsService.getLuykeGoalSettings(warehouse);
          currentGoals = settings.goals || {};
      }

      const masterReport = reportService.generateMasterReportData(sourceData, currentGoals, isRealtime);
      
      if (warehouse) {
          rankingReportData = masterReport.filter(nv => nv.maKho == warehouse);
      } else {
          rankingReportData = masterReport;
      }

      supermarketReport = reportService.aggregateReport(rankingReportData, warehouse);
      
      if (context === 'luyke' || context === 'sknv') {
          compData = $competitionData; 
      } else {
           compData = []; 
      }
  }

  // 3. Chuyển đổi Subtab
  function switchSubTab(tabId) {
      if (activeSubTabId) {
          updateTemplateStore(activeSubTabId, editorContent);
      }
      
      activeSubTabId = tabId;
      editorContent = $composerTemplates[context]?.[tabId] || '';
  }

  function updateTemplateStore(tabId, content) {
      composerTemplates.update(s => {
          if (!s[context]) s[context] = {};
          s[context][tabId] = content;
          return s;
      });
      localStorage.setItem('composerTemplates', JSON.stringify($composerTemplates));
  }

  // 4. Chèn Tag
  function insertTag(tag, isTemplate = false) {
      if (!textareaEl) return;
      
      let textToInsert = tag;
      if (isTemplate) {
          textToInsert = tag.replace('{dept}', rankingDept);
      }

      const start = textareaEl.selectionStart;
      const end = textareaEl.selectionEnd;
      const value = textareaEl.value;

      editorContent = value.substring(0, start) + textToInsert + value.substring(end);
      
      tick().then(() => {
          const newCursorPos = start + textToInsert.length;
          textareaEl.selectionStart = newCursorPos;
          textareaEl.selectionEnd = newCursorPos;
          textareaEl.focus();
      });
  }

  // 5. Xử lý Save & Preview
  function handleSave() {
      updateTemplateStore(activeSubTabId, editorContent);
      notificationStore.show('Đã lưu mẫu nhận xét!', 'success');
  }

  function handlePreviewAndCopy() {
      if (!editorContent.trim()) {
          notificationStore.show('Nội dung trống.', 'error');
          return;
      }

      const processedText = composerService.processComposerTemplate(
          editorContent,
          supermarketReport,
          currentGoals,
          rankingReportData,
          compData,
          context
      );

      navigator.clipboard.writeText(processedText).then(() => {
          notificationStore.show('Đã sao chép nội dung (đã xử lý) vào bộ nhớ tạm!', 'success');
      }).catch(err => {
          console.error(err);
          notificationStore.show('Lỗi khi sao chép.', 'error');
      });
  }

  function close() {
      modalState.update(s => ({ ...s, activeModal: null }));
  }
</script>

{#if isOpen}
    <div class="fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center z-[1100] backdrop-blur-sm" on:click={close} role="button" tabindex="0">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-5xl mx-4 flex flex-col h-[90vh]" on:click|stopPropagation>
            
            <div class="p-4 border-b border-gray-200 flex justify-between items-center bg-slate-50 rounded-t-xl">
                <div>
                    <h3 class="text-lg font-bold text-slate-800 flex items-center gap-2">
                        <i data-feather="pen-tool" class="w-5 h-5 text-indigo-600"></i>
                        Trình tạo Nhận xét - {CONFIG[context]?.label}
                    </h3>
                </div>
                <button class="text-gray-400 hover:text-red-500" on:click={close}>
                    <i data-feather="x" class="w-6 h-6"></i>
                </button>
            </div>

            <div class="flex-grow flex flex-col md:flex-row overflow-hidden">
                
                <div class="flex-1 flex flex-col border-r border-gray-200 p-4">
                    <div class="flex space-x-2 overflow-x-auto mb-3 pb-2 border-b border-gray-100">
                        {#each CONFIG[context]?.subTabs || [] as tab}
                            <button 
                                class="px-3 py-1.5 text-xs font-medium rounded-md transition-colors whitespace-nowrap
                                       {activeSubTabId === tab.id ? 'bg-indigo-100 text-indigo-700' : 'bg-gray-100 text-gray-600 hover:bg-gray-200'}"
                                on:click={() => switchSubTab(tab.id)}
                            >
                                {tab.label}
                            </button>
                        {/each}
                    </div>

                    <textarea 
                        bind:this={textareaEl}
                        bind:value={editorContent}
                        class="flex-grow w-full p-4 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 outline-none resize-none font-mono text-sm leading-relaxed"
                        placeholder="Soạn thảo nội dung tại đây... Sử dụng các thẻ bên phải để chèn dữ liệu tự động."
                    ></textarea>

                    <div class="mt-4 flex justify-between items-center">
                        <button on:click={handleSave} class="px-4 py-2 bg-green-600 text-white rounded-lg font-medium hover:bg-green-700 flex items-center gap-2 text-sm">
                            <i data-feather="save" class="w-4 h-4"></i> Lưu mẫu này
                        </button>
                        <button on:click={handlePreviewAndCopy} class="px-6 py-2 bg-blue-600 text-white rounded-lg font-bold hover:bg-blue-700 flex items-center gap-2 shadow-md">
                            <i data-feather="copy" class="w-4 h-4"></i> Xử lý & Sao chép
                        </button>
                    </div>
                </div>

                <div class="w-full md:w-80 bg-slate-50 flex flex-col border-l border-gray-200">
                    <div class="flex border-b border-gray-200 bg-white">
                        {#each ['general', 'kpi', 'ranking', 'details'] as tab}
                            <button 
                                class="flex-1 py-3 text-xs font-bold uppercase tracking-wide text-center hover:bg-slate-50 transition-colors border-b-2 
                                       {activeTagTab === tab ? 'border-indigo-600 text-indigo-600' : 'border-transparent text-gray-500'}"
                                on:click={() => activeTagTab = tab}
                            >
                                {tab}
                            </button>
                        {/each}
                    </div>

                    <div class="flex-grow overflow-y-auto p-4 custom-scrollbar">
                        
                        {#if activeTagTab === 'general'}
                            <div class="space-y-4">
                                <div>
                                    <h5 class="text-xs font-bold text-gray-500 uppercase mb-2">Chung</h5>
                                    <div class="flex flex-wrap gap-2">
                                        <button class="tag-btn" on:click={() => insertTag('[NGAY]')}>Ngày</button>
                                        <button class="tag-btn" on:click={() => insertTag('[GIO]')}>Giờ</button>
                                    </div>
                                </div>
                                <div>
                                    <h5 class="text-xs font-bold text-gray-500 uppercase mb-2">Biểu tượng</h5>
                                    <div class="grid grid-cols-5 gap-2">
                                        {#each ['📊','💰','💥','🎯','📈','📦','⚠️','🔥','✅','🚀'] as icon}
                                            <button class="icon-btn" on:click={() => insertTag(icon)}>{icon}</button>
                                        {/each}
                                    </div>
                                </div>
                            </div>

                        {:else if activeTagTab === 'kpi'}
                            <div class="space-y-4">
                                <h5 class="text-xs font-bold text-gray-500 uppercase mb-2">KPIs Chính</h5>
                                <div class="flex flex-col gap-2">
                                    <button class="tag-btn w-full text-left" on:click={() => insertTag('[DT_THUC]')}>Doanh thu Thực</button>
                                    <button class="tag-btn w-full text-left" on:click={() => insertTag('[DTQD]')}>Doanh thu Quy đổi</button>
                                    <button class="tag-btn w-full text-left" on:click={() => insertTag('[%HT_DTT]')}>% HT DT Thực</button>
                                    <button class="tag-btn w-full text-left" on:click={() => insertTag('[%HT_DTQD]')}>% HT DT QĐ</button>
                                    <button class="tag-btn w-full text-left" on:click={() => insertTag('[TLQD]')}>Tỷ lệ Quy đổi</button>
                                    <button class="tag-btn w-full text-left" on:click={() => insertTag('[DT_CHUAXUAT]')}>DT Chưa xuất</button>
                                    <button class="tag-btn w-full text-left" on:click={() => insertTag('[SS_CUNGKY]')}>So sánh Cùng kỳ</button>
                                </div>
                            </div>

                        {:else if activeTagTab === 'ranking'}
                            <div class="space-y-4">
                                <div>
                                    <label for="composer-dept" class="text-xs font-bold text-gray-500 uppercase mb-1 block">Lọc Bộ phận:</label>
                                    <select id="composer-dept" class="w-full p-2 text-sm border rounded bg-white" bind:value={rankingDept}>
                                        <option value="ALL">Toàn siêu thị</option>
                                        {#each uniqueDepartments as dept}
                                            <option value={dept}>{dept}</option>
                                        {/each}
                                    </select>
                                </div>
                                
                                <div>
                                    <h5 class="text-xs font-bold text-gray-500 uppercase mb-2">Xếp hạng (Top/Bot 3)</h5>
                                    <div class="grid grid-cols-2 gap-2">
                                        <button class="tag-btn" on:click={() => insertTag('[TOP3_DTQD_{dept}@msnv]', true)}>Top 3 DTQĐ</button>
                                        <button class="tag-btn" on:click={() => insertTag('[BOT3_DTQD_{dept}@msnv]', true)}>Bot 3 DTQĐ</button>
                                        <button class="tag-btn" on:click={() => insertTag('[TOP3_THUNHAP_{dept}@msnv]', true)}>Top 3 Thu nhập</button>
                                        <button class="tag-btn" on:click={() => insertTag('[BOT3_THUNHAP_{dept}@msnv]', true)}>Bot 3 Thu nhập</button>
                                        <button class="tag-btn" on:click={() => insertTag('[TOP3_TLQD_{dept}@msnv]', true)}>Top 3 %QĐ</button>
                                        <button class="tag-btn" on:click={() => insertTag('[BOT3_TLQD_{dept}@msnv]', true)}>Bot 3 %QĐ</button>
                                    </div>
                                </div>

                                <div>
                                    <h5 class="text-xs font-bold text-gray-500 uppercase mb-2">Dưới Mục tiêu (List)</h5>
                                    <div class="flex flex-wrap gap-2">
                                        <button class="tag-btn" on:click={() => insertTag('[BOT_TARGET_TLQD_{dept}@msnv]', true)}>% Quy đổi</button>
                                        <button class="tag-btn" on:click={() => insertTag('[BOT_TARGET_TLTC_{dept}@msnv]', true)}>% Trả chậm</button>
                                        <button class="tag-btn" on:click={() => insertTag('[BOT_TARGET_PK_{dept}@msnv]', true)}>% Phụ kiện</button>
                                        <button class="tag-btn" on:click={() => insertTag('[BOT_TARGET_GD_{dept}@msnv]', true)}>% Gia dụng</button>
                                    </div>
                                </div>
                            </div>

                        {:else if activeTagTab === 'details'}
                            <div class="space-y-4">
                                <div>
                                    <h5 class="text-xs font-bold text-gray-500 uppercase mb-2">Thi đua (Lũy kế)</h5>
                                    <div class="grid grid-cols-2 gap-2">
                                        <button class="tag-btn" on:click={() => insertTag('[TD_TONG_CT]')}>Tổng CT</button>
                                        <button class="tag-btn" on:click={() => insertTag('[TD_CT_DAT]')}>Số đạt</button>
                                        <button class="tag-btn" on:click={() => insertTag('[TD_CT_CHUADAT]')}>Số chưa đạt</button>
                                        <button class="tag-btn" on:click={() => insertTag('[TD_TYLE_DAT]')}>% Đạt</button>
                                    </div>
                                </div>

                                <div>
                                    <h5 class="text-xs font-bold text-gray-500 uppercase mb-2">Nhóm QĐC (Có số)</h5>
                                    <button class="tag-btn w-full mb-2 text-indigo-700 bg-indigo-50" on:click={() => insertTag('[TOP_QDC_INFO]')}>
                                        Chèn Top QĐC (SL & TB/Ngày)
                                    </button>
                                    <div class="flex flex-wrap gap-2">
                                        {#if supermarketReport.qdc}
                                            {#each Object.values(supermarketReport.qdc).filter(i=>i.sl>0).sort((a,b)=>b.dtqd-a.dtqd) as item}
                                                <button class="tag-btn text-xs" on:click={() => insertTag(`[QDC_INFO_${item.name}]`)}>{item.name}</button>
                                            {/each}
                                        {/if}
                                    </div>
                                </div>

                                <div>
                                    <h5 class="text-xs font-bold text-gray-500 uppercase mb-2">Ngành hàng (Có số)</h5>
                                    <button class="tag-btn w-full mb-2 text-indigo-700 bg-indigo-50" on:click={() => insertTag('[TOP_NGANHHANG_SL]')}>
                                        Chèn Top SL Ngành hàng
                                    </button>
                                    <div class="flex flex-wrap gap-2">
                                        {#if supermarketReport.nganhHangChiTiet}
                                            {#each Object.values(supermarketReport.nganhHangChiTiet).filter(i=>i.quantity>0).sort((a,b)=>b.revenue-a.revenue).slice(0, 10) as item}
                                                <button class="tag-btn text-xs" on:click={() => insertTag(`[NH_INFO_${cleanCategoryName(item.name)}]`)}>{cleanCategoryName(item.name)}</button>
                                            {/each}
                                        {/if}
                                    </div>
                                </div>
                            </div>
                        {/if}
                    </div>
                </div>
            </div>
        </div>
    </div>
{/if}

<style>
    .tag-btn {
        background-color: #eef2ff;
        color: #4338ca;
        border: 1px solid #c7d2fe;
        padding: 0.25rem 0.5rem;
        border-radius: 0.375rem;
        font-size: 0.75rem;
        font-weight: 500;
        transition: all 0.2s;
    }
    .tag-btn:hover {
        background-color: #e0e7ff;
        border-color: #818cf8;
    }
    .icon-btn {
        background-color: white;
        border: 1px solid #e5e7eb;
        border-radius: 0.375rem;
        padding: 0.5rem;
        font-size: 1.25rem;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s;
    }
    .icon-btn:hover {
        background-color: #f9fafb;
        border-color: #d1d5db;
        transform: scale(1.1);
    }
    .custom-scrollbar::-webkit-scrollbar { width: 4px; }
    .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
    .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 2px; }
</style>
--- END FILE: ./src/components/modals/ComposerModal.svelte ---

--- START FILE: ./src/components/modals/CustomerDetailModal.svelte ---
<script>
    import { modalState } from '../../stores.js';
    import { formatters } from '../../utils/formatters.js';

    // Lấy dữ liệu từ store modalState
    $: isOpen = $modalState.activeModal === 'customer-detail-modal';
    $: customerData = $modalState.payload?.customers || [];
    $: mucTieu = $modalState.payload?.mucTieu || {};

    $: conversionRateTarget = (mucTieu?.phanTramQD || 0) / 100;

    function close() {
        modalState.update(s => ({ ...s, activeModal: null, payload: null }));
    }

    // Sắp xếp local trong modal
    let sortKey = 'totalRealRevenue';
    let sortDirection = 'desc';

    function handleSort(key) {
        if (sortKey === key) {
            sortDirection = sortDirection === 'desc' ? 'asc' : 'desc';
        } else {
            sortKey = key;
            sortDirection = 'desc';
        }
    }

    $: sortedCustomers = [...customerData].sort((a, b) => {
        let valA = a[sortKey];
        let valB = b[sortKey];
        return sortDirection === 'desc' ? valB - valA : valA - valB;
    });
</script>

{#if isOpen}
    <div class="fixed inset-0 bg-gray-900/50 z-[1200] flex items-center justify-center backdrop-blur-sm" on:click={close} role="button" tabindex="0">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-3xl mx-4 flex flex-col max-h-[90vh]" on:click|stopPropagation>
            
            <div class="p-4 border-b flex justify-between items-center bg-blue-50 rounded-t-xl">
                <h3 class="text-lg font-bold text-blue-900">Chi tiết Đơn hàng theo Khách hàng</h3>
                <button class="text-gray-500 hover:text-gray-800 text-2xl leading-none" on:click={close}>&times;</button>
            </div>

            <div class="p-3 bg-gray-50 border-b flex gap-2 items-center">
                <span class="text-xs font-bold text-gray-500 uppercase">Sắp xếp:</span>
                <button 
                    class="px-3 py-1 rounded-full text-xs font-medium border transition-colors {sortKey === 'totalRealRevenue' ? 'bg-blue-600 text-white' : 'bg-white text-gray-600 hover:bg-gray-100'}"
                    on:click={() => handleSort('totalRealRevenue')}
                >
                    Doanh thu {sortKey === 'totalRealRevenue' ? (sortDirection === 'desc' ? '↓' : '↑') : ''}
                </button>
                <button 
                    class="px-3 py-1 rounded-full text-xs font-medium border transition-colors {sortKey === 'conversionRate' ? 'bg-blue-600 text-white' : 'bg-white text-gray-600 hover:bg-gray-100'}"
                    on:click={() => handleSort('conversionRate')}
                >
                    % Quy đổi {sortKey === 'conversionRate' ? (sortDirection === 'desc' ? '↓' : '↑') : ''}
                </button>
            </div>

            <div class="overflow-y-auto p-4 space-y-3 bg-slate-50/30 flex-grow">
                {#if sortedCustomers.length === 0}
                    <p class="text-center text-gray-500 py-8">Không có dữ liệu.</p>
                {:else}
                    {#each sortedCustomers as customer, index}
                        <details class="bg-white rounded-lg shadow-sm border border-gray-200 group">
                            <summary class="flex flex-wrap items-center gap-3 p-3 cursor-pointer list-none select-none hover:bg-gray-50 transition-colors">
                                <div class="flex items-center gap-2 flex-grow min-w-[200px]">
                                    <span class="text-xs font-bold text-gray-400 w-5">{index + 1}.</span>
                                    <span class="text-sm font-semibold text-blue-700">{customer.name}</span>
                                </div>
                                
                                <div class="flex items-center gap-3 text-xs text-gray-600">
                                    <span>SL: <strong>{customer.totalQuantity}</strong></span>
                                    <span>DT: <strong>{formatters.formatRevenue(customer.totalRealRevenue, 1)}</strong></span>
                                    <span>DTQĐ: <strong class="text-blue-600">{formatters.formatRevenue(customer.totalConvertedRevenue, 1)}</strong></span>
                                    <span class="font-bold {customer.conversionRate >= conversionRateTarget ? 'text-green-600' : 'text-red-600'}">
                                        {formatters.formatPercentage(customer.conversionRate)}
                                    </span>
                                </div>
                                <span class="text-gray-400 transform group-open:rotate-180 transition-transform ml-auto">▼</span>
                            </summary>
                            
                            <div class="p-3 border-t border-gray-100 bg-slate-50/50 text-xs">
                                <table class="w-full">
                                    <tbody>
                                        {#each customer.products as p}
                                            <tr class="border-b last:border-0 border-gray-200/50">
                                                <td class="py-1.5 pr-2 text-gray-700">{p.productName}</td>
                                                <td class="py-1.5 px-2 text-right whitespace-nowrap">SL: <strong>{p.quantity}</strong></td>
                                                <td class="py-1.5 px-2 text-right whitespace-nowrap">DT: <strong>{formatters.formatRevenue(p.realRevenue, 1)}</strong></td>
                                                <td class="py-1.5 pl-2 text-right whitespace-nowrap">QĐ: <strong class="text-blue-600">{formatters.formatRevenue(p.convertedRevenue, 1)}</strong></td>
                                            </tr>
                                        {/each}
                                    </tbody>
                                </table>
                            </div>
                        </details>
                    {/each}
                {/if}
            </div>

            <div class="p-4 border-t bg-white rounded-b-xl flex justify-end">
                <button class="px-4 py-2 bg-gray-100 hover:bg-gray-200 text-gray-700 rounded-lg text-sm font-medium" on:click={close}>Đóng</button>
            </div>
        </div>
    </div>
{/if}
--- END FILE: ./src/components/modals/CustomerDetailModal.svelte ---

--- START FILE: ./src/components/modals/LoginModal.svelte ---
<script>
    import { modalState } from '../../stores.js';
    import { authService } from '../../services/auth.service.js';
    // [FIX] Xóa import ui từ ui.js (file đã bị xóa)
    // import { ui } from '../../ui.js'; 
    
    // State nội bộ
    let email = '';
    let errorMsg = '';
    let isSubmitting = false;

    // Reactive: Kiểm tra modal có đang mở không
    $: isOpen = $modalState.activeModal === 'login-modal';

    function close() {
        modalState.update(s => ({ ...s, activeModal: null }));
    }

    async function handleSubmit() {
        errorMsg = '';
        isSubmitting = true;

        try {
            const success = await authService.loginUser(email);
            
            if (success) {
                // [FIX] Dùng alert tạm thời thay vì ui.showNotification
                // Vì modal login chỉ hiện 1 lần đầu, alert là chấp nhận được
                // alert(`Chào mừng ${email}!`); 
                close();
            } else {
                errorMsg = 'Vui lòng nhập một địa chỉ email hợp lệ.';
            }
        } catch (e) {
            console.error(e);
            errorMsg = 'Có lỗi xảy ra. Vui lòng thử lại.';
        } finally {
            isSubmitting = false;
        }
    }

    function handleKeydown(event) {
        if (event.key === 'Enter') {
            handleSubmit();
        }
    }
</script>

{#if isOpen}
    <div 
        class="fixed inset-0 bg-gray-900 bg-opacity-60 z-[1100] flex items-center justify-center cursor-not-allowed backdrop-blur-sm"
    >
        <div 
            class="bg-white p-6 rounded-xl shadow-2xl w-full max-w-[420px] mx-4 transform transition-all scale-100 cursor-default"
            on:click|stopPropagation
        >
            <div class="mb-6 border-b border-gray-100 pb-4">
                <h3 class="text-xl font-bold text-gray-800">Chào mừng đến với Công cụ Phân tích</h3>
            </div>
            
            <div class="space-y-4">
                <p class="text-gray-600 text-sm leading-relaxed">
                    Vui lòng nhập email của bạn để bắt đầu sử dụng. Email này sẽ được dùng để định danh và đồng bộ dữ liệu trong tương lai.
                </p>
                
                <div>
                    <label for="login-email-input" class="block text-sm font-medium text-gray-700 mb-1">Email của bạn</label>
                    <input 
                        type="email" 
                        id="login-email-input" 
                        class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition-colors
                               {errorMsg ? 'border-red-500 bg-red-50' : 'border-gray-300'}"
                        placeholder="your.email@example.com"
                        bind:value={email}
                        on:keydown={handleKeydown}
                        disabled={isSubmitting}
                    >
                    {#if errorMsg}
                        <p class="text-red-500 text-sm mt-2 flex items-center animate-pulse">
                            <span class="mr-1">⚠️</span> {errorMsg}
                        </p>
                    {/if}
                </div>

                <button 
                    id="login-submit-btn" 
                    class="w-full bg-blue-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-blue-700 transition-colors shadow-md disabled:opacity-70 disabled:cursor-not-allowed"
                    on:click={handleSubmit}
                    disabled={isSubmitting}
                >
                    {isSubmitting ? 'Đang xử lý...' : 'Xác nhận & Tiếp tục'}
                </button>
            </div>
        </div>
    </div>
{/if}
--- END FILE: ./src/components/modals/LoginModal.svelte ---

--- START FILE: ./src/components/modals/UnexportedDetailModal.svelte ---
<script>
    import { modalState } from '../../stores.js';
    import { formatters } from '../../utils/formatters.js';

    $: isOpen = $modalState.activeModal === 'unexported-detail-modal';
    $: unexportedDetails = $modalState.payload?.unexportedDetails || [];

    function close() {
        modalState.update(s => ({ ...s, activeModal: null, payload: null }));
    }
</script>

{#if isOpen}
    <div class="fixed inset-0 bg-gray-900/50 z-[1200] flex items-center justify-center backdrop-blur-sm" on:click={close} role="button" tabindex="0">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-2xl mx-4 flex flex-col max-h-[90vh]" on:click|stopPropagation>
            
            <div class="p-4 border-b flex justify-between items-center bg-yellow-50 rounded-t-xl">
                <h3 class="text-lg font-bold text-yellow-800">Chi tiết Doanh thu Chưa xuất</h3>
                <button class="text-gray-500 hover:text-gray-800 text-2xl leading-none" on:click={close}>&times;</button>
            </div>

            <div class="overflow-y-auto p-4 space-y-3 bg-slate-50/30 flex-grow">
                {#if unexportedDetails.length === 0}
                    <p class="text-center text-gray-500 py-8">Không có đơn hàng nào chưa xuất.</p>
                {:else}
                    {#each unexportedDetails as group, index}
                        <details class="bg-white rounded-lg shadow-sm border border-gray-200 group">
                            <summary class="flex justify-between items-center p-3 cursor-pointer list-none select-none hover:bg-gray-50 transition-colors">
                                <div class="flex items-center gap-2">
                                    <span class="font-bold text-gray-500 text-sm">{index + 1}.</span>
                                    <span class="font-semibold text-gray-800 text-sm">{group.name}</span>
                                </div>
                                
                                <div class="flex items-center gap-3 text-xs text-gray-600">
                                    <span>SL: <strong>{group.totalSL}</strong></span>
                                    <span>DTQĐ: <strong class="text-blue-600">{formatters.formatRevenue(group.totalDTQD, 1)}</strong></span>
                                </div>
                                <span class="text-gray-400 transform group-open:rotate-180 transition-transform ml-2">▼</span>
                            </summary>
                            
                            <div class="p-3 border-t border-gray-100 bg-slate-50/50 text-xs">
                                <table class="w-full">
                                    <tbody>
                                        {#each group.products as p}
                                            <tr class="border-b last:border-0 border-gray-200/50">
                                                <td class="py-1.5 pr-2 text-gray-700">{p.name}</td>
                                                <td class="py-1.5 px-2 text-right whitespace-nowrap">SL: <strong>{p.sl}</strong></td>
                                                <td class="py-1.5 pl-2 text-right whitespace-nowrap">DTQĐ: <strong class="text-blue-600">{formatters.formatRevenue(p.dtqd, 1)}</strong></td>
                                            </tr>
                                        {/each}
                                    </tbody>
                                </table>
                            </div>
                        </details>
                    {/each}
                {/if}
            </div>

            <div class="p-4 border-t bg-white rounded-b-xl flex justify-end">
                <button class="px-4 py-2 bg-gray-100 hover:bg-gray-200 text-gray-700 rounded-lg text-sm font-medium" on:click={close}>Đóng</button>
            </div>
        </div>
    </div>
{/if}
--- END FILE: ./src/components/modals/UnexportedDetailModal.svelte ---

--- START FILE: ./src/components/modals/UserCompetitionModal.svelte ---
<script>
    import { 
        modalState, 
        localCompetitionConfigs, // [QUAN TRỌNG] Dùng biến local thay vì global
        categoryStructure,
        brandList,
        selectedWarehouse
    } from '../../stores.js';
    import { datasyncService } from '../../services/datasync.service.js';

    $: isOpen = $modalState.activeModal === 'user-competition-modal';

    // --- STATE VIEW ---
    let currentView = 'menu'; 
    let editingIndex = -1;
    let isLoading = false;
    
    // Form data chuẩn thiết kế cũ
    let formData = { 
        id: '', name: '', groups: [], brands: [], 
        type: 'doanhthu', minPrice: '', maxPrice: '', excludeApple: false 
    };

    // Search
    let searchGroup = '';
    let searchBrand = '';

    // Data Sources
    $: availableGroups = [...new Set(($categoryStructure || []).map(c => c.nhomHang).filter(Boolean))].sort();
    $: filteredGroups = availableGroups.filter(g => g.toLowerCase().includes(searchGroup.toLowerCase()));
    
    $: availableBrands = $brandList || [];
    $: filteredBrands = availableBrands.filter(b => b.toLowerCase().includes(searchBrand.toLowerCase()));

    // Reset khi mở modal
    $: if (isOpen) {
        if ($selectedWarehouse) {
            currentView = 'menu';
        }
    }

    function close() {
        modalState.update(s => ({ ...s, activeModal: null }));
        resetForm();
        currentView = 'menu';
    }

    // --- NAVIGATION ---
    function goToSpecialProgram() {
        modalState.update(s => ({ ...s, activeModal: 'user-special-program-modal' }));
    }

    function goToBrandCompetition() {
        // Nếu chưa có chương trình nào, vào thẳng form tạo mới
        if ($localCompetitionConfigs.length === 0) {
            openAddForm();
        } else {
            currentView = 'list';
        }
    }

    function backToMenu() { currentView = 'menu'; }
    function backToList() { currentView = 'list'; resetForm(); }

    // --- LOGIC FORM ---
    function resetForm() {
        formData = { 
            id: '', name: '', groups: [], brands: [], 
            type: 'doanhthu', minPrice: '', maxPrice: '', excludeApple: false 
        };
        editingIndex = -1;
        searchGroup = ''; searchBrand = '';
    }

    function openAddForm() { 
        resetForm(); 
        currentView = 'form';
    }

    function openEditForm(index) {
        // [FIX] Lấy từ localCompetitionConfigs
        const config = $localCompetitionConfigs[index];
        if (!config) return;
        
        editingIndex = index;
        formData = {
            id: config.id,
            name: config.name,
            groups: [...(config.groups || [])],
            brands: [...(config.brands || [])],
            type: config.type || 'doanhthu',
            minPrice: config.minPrice ? config.minPrice / 1000000 : '', 
            maxPrice: config.maxPrice ? config.maxPrice / 1000000 : '',
            excludeApple: config.excludeApple || false
        };
        currentView = 'form';
    }

    function toggleSelection(list, item) {
        return list.includes(item) ? list.filter(i => i !== item) : [...list, item];
    }

    async function saveProgram() {
        if (!$selectedWarehouse) return alert("Vui lòng chọn Kho trước!");
        if (!formData.name) return alert("Vui lòng nhập tên chương trình!");
        if (formData.brands.length === 0) return alert("Vui lòng chọn ít nhất một Hãng!");
        
        isLoading = true;
        
        const configToSave = {
            id: formData.id || `comp_${Date.now()}`,
            name: formData.name,
            groups: formData.groups,
            brands: formData.brands,
            type: formData.type,
            minPrice: formData.minPrice ? parseFloat(formData.minPrice) * 1000000 : 0,
            maxPrice: formData.maxPrice ? parseFloat(formData.maxPrice) * 1000000 : 0,
            excludeApple: formData.excludeApple,
            target: 0
        };

        // [FIX] Cập nhật vào localCompetitionConfigs
        let newConfigs = [...$localCompetitionConfigs];
        if (editingIndex >= 0) newConfigs[editingIndex] = configToSave;
        else newConfigs.push(configToSave);

        localCompetitionConfigs.set(newConfigs); // Update Store UI ngay lập tức

        try {
            // [FIX] Lưu vào Document của Kho (WarehouseData) thay vì Global Declarations
            await datasyncService.saveCompetitionConfigs($selectedWarehouse, newConfigs);
            if (currentView === 'form') backToList();
        } catch (error) {
            console.error(error);
            alert(`Lỗi lưu: ${error.message}`);
        } finally { 
            isLoading = false;
        }
    }

    async function deleteProgram(index) {
        if (!confirm("Xóa chương trình này?")) return;
        
        // [FIX] Xóa từ localCompetitionConfigs
        let newConfigs = [...$localCompetitionConfigs];
        newConfigs.splice(index, 1);
        localCompetitionConfigs.set(newConfigs);
        
        try {
            await datasyncService.saveCompetitionConfigs($selectedWarehouse, newConfigs);
        } catch(e) { console.error(e); }
    }
</script>

{#if isOpen}
    <div class="fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center z-[1100] backdrop-blur-sm" on:click={close} role="button" tabindex="0">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-2xl mx-4 flex flex-col max-h-[90vh]" on:click|stopPropagation>
            
            <div class="p-5 border-b border-gray-200 flex justify-between items-center bg-blue-50 rounded-t-xl">
                <div>
                    <h3 class="text-lg font-bold text-blue-800 flex items-center gap-2">
                        <i data-feather="award"></i> 
                        {#if currentView === 'menu'}
                            Tạo chương trình thi đua
                        {:else if currentView === 'list'}
                            Danh sách Thi đua (Hãng)
                        {:else}
                            {editingIndex >= 0 ? 'Sửa chương trình' : 'Thêm chương trình mới'}
                        {/if}
                    </h3>
                    {#if $selectedWarehouse}
                        <p class="text-xs text-blue-600 mt-1">Kho đang chọn: <span class="font-bold">{$selectedWarehouse}</span></p>
                    {/if}
                </div>
                <button class="text-gray-500 hover:text-red-500 text-2xl leading-none" on:click={close}>&times;</button>
            </div>
            
            <div class="p-6 overflow-y-auto bg-slate-50/30 flex-grow">
                {#if !$selectedWarehouse}
                    <div class="p-8 text-center bg-yellow-50 border border-yellow-200 rounded-lg">
                        <p class="text-yellow-700 font-semibold">Vui lòng chọn Kho ở tab "Cập nhật dữ liệu" trước.</p>
                    </div>

                {:else if currentView === 'menu'}
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-4">
                        <button 
                            class="flex flex-col items-center justify-center p-8 bg-white border-2 border-blue-100 rounded-xl shadow-sm hover:shadow-md hover:border-blue-500 hover:bg-blue-50 transition group"
                            on:click={goToBrandCompetition}
                        >
                            <div class="p-4 bg-blue-100 rounded-full text-blue-600 mb-4 group-hover:scale-110 transition-transform">
                                <i data-feather="briefcase" class="w-8 h-8"></i>
                            </div>
                            <h4 class="text-lg font-bold text-gray-800 group-hover:text-blue-700">Thi đua theo Hãng</h4>
                            <p class="text-sm text-gray-500 text-center mt-2">Tạo thi đua dựa trên doanh số của các Hãng (Apple, Samsung...).</p>
                        </button>

                        <button 
                            class="flex flex-col items-center justify-center p-8 bg-white border-2 border-purple-100 rounded-xl shadow-sm hover:shadow-md hover:border-purple-500 hover:bg-purple-50 transition group"
                            on:click={goToSpecialProgram}
                        >
                            <div class="p-4 bg-purple-100 rounded-full text-purple-600 mb-4 group-hover:scale-110 transition-transform">
                                <i data-feather="star" class="w-8 h-8"></i>
                            </div>
                            <h4 class="text-lg font-bold text-gray-800 group-hover:text-purple-700">Thi đua Đặc Quyền</h4>
                            <p class="text-sm text-gray-500 text-center mt-2">Theo dõi các sản phẩm trọng tâm (SPĐQ) được chỉ định riêng.</p>
                        </button>
                    </div>

                {:else if currentView === 'list'}
                    <div class="mb-4">
                        <button on:click={backToMenu} class="text-sm text-gray-500 hover:text-blue-600 flex items-center gap-1 mb-4">
                            <i data-feather="arrow-left" class="w-4 h-4"></i> Quay lại chọn loại
                        </button>
                    </div>

                    <div class="space-y-3">
                        {#if $localCompetitionConfigs.length === 0}
                            <div class="text-center py-8 bg-gray-50 rounded-lg border-2 border-dashed border-gray-200">
                                <p class="text-gray-500 mb-2">Chưa có chương trình nào.</p>
                                <button on:click={openAddForm} class="text-blue-600 font-bold hover:underline">+ Tạo mới ngay</button>
                            </div>
                        {:else}
                            {#each $localCompetitionConfigs as config, index}
                                <div class="flex justify-between items-start p-4 bg-white rounded-lg border border-gray-200 shadow-sm hover:shadow-md transition group/item">
                                    <div>
                                        <div class="flex items-center gap-2">
                                            <h4 class="font-bold text-gray-800 text-base">{config.name}</h4>
                                            <span class="text-[10px] uppercase px-2 py-0.5 rounded-full font-bold border {config.type === 'doanhthu' ? 'bg-blue-50 text-blue-700 border-blue-100' : 'bg-yellow-50 text-yellow-700 border-yellow-100'}">
                                                {config.type === 'doanhthu' ? 'Doanh thu' : 'Số lượng'}
                                            </span>
                                        </div>
                                        <div class="text-xs text-gray-500 mt-1.5 flex flex-wrap gap-y-1 gap-x-4">
                                            <span><strong>Hãng:</strong> {config.brands.join(', ')}</span>
                                            {#if config.groups.length > 0}
                                                <span><strong>Nhóm:</strong> {config.groups.join(', ')}</span>
                                            {/if}
                                            {#if config.excludeApple}
                                                <span class="text-red-500 font-medium">No Apple</span>
                                            {/if}
                                        </div>
                                    </div>
                                    <div class="flex gap-2">
                                        <button on:click={() => openEditForm(index)} class="p-2 text-blue-600 hover:bg-blue-50 rounded"><i data-feather="edit-2" class="w-4 h-4"></i></button>
                                        <button on:click={() => deleteProgram(index)} class="p-2 text-red-600 hover:bg-red-50 rounded"><i data-feather="trash-2" class="w-4 h-4"></i></button>
                                    </div>
                                </div>
                            {/each}
                             <button on:click={openAddForm} class="w-full py-3 mt-2 border-2 border-dashed border-blue-200 text-blue-600 rounded-lg font-semibold hover:bg-blue-50 transition flex justify-center items-center gap-2">
                                <i data-feather="plus-circle" class="w-4 h-4"></i> Thêm chương trình mới
                            </button>
                        {/if}
                    </div>

                {:else if currentView === 'form'}
                    <div class="bg-white p-5 rounded-lg border border-blue-100 shadow-sm">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="font-bold text-lg text-slate-700">{editingIndex >= 0 ? 'Chỉnh sửa' : 'Thêm mới'}</h3>
                            <button on:click={backToList} class="text-sm text-gray-500 hover:underline">Hủy bỏ</button>
                        </div>
                        
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-bold text-slate-700 mb-1">Tên chương trình</label>
                                <input type="text" bind:value={formData.name} class="w-full p-2 border rounded-md focus:ring-2 focus:ring-blue-500 outline-none" placeholder="VD: Thi đua Tivi Sony...">
                            </div>

                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-bold text-slate-700 mb-1">Hãng sản xuất <span class="text-red-500">*</span></label>
                                    <input type="text" bind:value={searchBrand} class="w-full mb-2 p-2 border rounded text-xs" placeholder="🔍 Tìm hãng..." />
                                    <div class="h-40 overflow-y-auto p-2 border rounded bg-slate-50 grid grid-cols-1 gap-1 custom-scrollbar">
                                        {#each filteredBrands as brand}
                                            <label class="flex items-center space-x-2 text-xs cursor-pointer hover:bg-white p-1 rounded border border-transparent hover:border-gray-200">
                                                <input type="checkbox" checked={formData.brands.includes(brand)} on:change={() => formData.brands = toggleSelection(formData.brands, brand)} class="rounded text-blue-600 focus:ring-blue-500 border-slate-300">
                                                <span class="text-slate-700 truncate" title={brand}>{brand}</span>
                                            </label>
                                        {/each}
                                    </div>
                                </div>
                                <div>
                                    <label class="block text-sm font-bold text-slate-700 mb-1">Nhóm hàng (Tùy chọn)</label>
                                    <input type="text" bind:value={searchGroup} class="w-full mb-2 p-2 border rounded text-xs" placeholder="🔍 Tìm nhóm hàng..." />
                                    <div class="h-40 overflow-y-auto p-2 border rounded bg-slate-50 grid grid-cols-1 gap-1 custom-scrollbar">
                                        {#each filteredGroups as group}
                                            <label class="flex items-center space-x-2 text-xs cursor-pointer hover:bg-white p-1 rounded border border-transparent hover:border-gray-200">
                                                <input type="checkbox" checked={formData.groups.includes(group)} on:change={() => formData.groups = toggleSelection(formData.groups, group)} class="rounded text-blue-600 focus:ring-blue-500 border-slate-300">
                                                <span class="text-slate-700 truncate" title={group}>{group}</span>
                                            </label>
                                        {/each}
                                    </div>
                                </div>
                            </div>
                            
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-3 bg-slate-50 p-3 rounded border border-slate-200">
                                <div>
                                    <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Loại đo lường</label>
                                    <select bind:value={formData.type} class="w-full p-2 border border-slate-300 rounded-md text-sm bg-white">
                                        <option value="doanhthu">Theo Doanh thu</option>
                                        <option value="soluong">Theo Số lượng</option>
                                    </select>
                                </div>
                                {#if formData.type === 'soluong'}
                                    <div>
                                        <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Giá từ (Tr)</label>
                                        <input type="number" bind:value={formData.minPrice} class="w-full p-2 border border-slate-300 rounded-md text-sm" placeholder="VD: 3">
                                    </div>
                                    <div>
                                        <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Giá đến (Tr)</label>
                                        <input type="number" bind:value={formData.maxPrice} class="w-full p-2 border border-slate-300 rounded-md text-sm" placeholder="VD: 10">
                                    </div>
                                {/if}
                            </div>

                            <div class="flex items-center gap-2 pt-2">
                                <input type="checkbox" id="exclude-apple" bind:checked={formData.excludeApple} class="rounded text-blue-600 focus:ring-blue-500 border-slate-300 w-4 h-4">
                                <label for="exclude-apple" class="text-sm text-slate-700 cursor-pointer select-none">Trừ hãng Apple khỏi dữ liệu so sánh</label>
                            </div>

                            <div class="flex justify-end gap-3 pt-4 border-t mt-4">
                                <button on:click={backToList} class="px-4 py-2 text-gray-600 bg-white border rounded hover:bg-gray-50">Hủy</button>
                                <button on:click={saveProgram} class="px-4 py-2 bg-blue-600 text-white font-bold rounded hover:bg-blue-700 disabled:opacity-50" disabled={isLoading}>{isLoading ? 'Đang lưu...' : 'Lưu'}</button>
                            </div>
                        </div>
                    </div>
                {/if}
            </div>
        </div>
    </div>
{/if}
--- END FILE: ./src/components/modals/UserCompetitionModal.svelte ---

--- START FILE: ./src/components/modals/UserSpecialProgramModal.svelte ---
<script>
    import { 
        modalState, 
        globalSpecialPrograms, 
        categoryStructure,
        selectedWarehouse
    } from '../../stores.js';
    import { datasyncService } from '../../services/datasync.service.js';

    $: isOpen = $modalState.activeModal === 'user-special-program-modal';

    let isFormOpen = false;
    let editingIndex = -1;
    let isLoading = false;
    
    let formData = { id: '', name: '', groups: [] };
    let searchGroup = '';

    // Lấy danh sách nhóm hàng từ cấu trúc ngành hàng
    $: availableGroups = [...new Set(($categoryStructure || []).map(c => c.nhomHang).filter(Boolean))].sort();
    $: filteredGroups = availableGroups.filter(g => g.toLowerCase().includes(searchGroup.toLowerCase()));

    // Khi mở modal, tải dữ liệu của kho hiện tại
    $: if (isOpen && $selectedWarehouse) {
        loadConfigs();
    }

    // Logic tải từ Cloud (Hiện tại đang giả lập dùng biến global, thực tế sẽ tải từ datasyncService)
    async function loadConfigs() {
        // Tạm thời dùng store globalSpecialPrograms đã được load ở main.js
        // Về sau sẽ gọi datasyncService.loadSpecialPrograms($selectedWarehouse)
    }

    function close() {
        modalState.update(s => ({ ...s, activeModal: null }));
        closeForm();
    }

    function resetForm() {
        formData = { id: '', name: '', groups: [] };
        editingIndex = -1;
        searchGroup = '';
    }

    function openAddForm() { resetForm(); isFormOpen = true; }

    function openEditForm(index) {
        const config = $globalSpecialPrograms[index];
        editingIndex = index;
        formData = {
            id: config.id,
            name: config.name,
            groups: [...(config.groups || [])]
        };
        isFormOpen = true;
    }

    function closeForm() { isFormOpen = false; resetForm(); }

    function toggleSelection(list, item) {
        return list.includes(item) ? list.filter(i => i !== item) : [...list, item];
    }

    async function saveProgram() {
        if (!$selectedWarehouse) return alert("Vui lòng chọn Kho ở tab Cập nhật dữ liệu trước!");
        if (!formData.name) return alert("Vui lòng nhập tên chương trình!");
        if (formData.groups.length === 0) return alert("Vui lòng chọn ít nhất một Nhóm hàng!");

        isLoading = true;
        const configToSave = {
            id: formData.id || `sp_${Date.now()}`,
            name: formData.name,
            groups: formData.groups
        };

        let newConfigs = [...$globalSpecialPrograms];
        if (editingIndex >= 0) newConfigs[editingIndex] = configToSave;
        else newConfigs.push(configToSave);

        // Cập nhật Store
        globalSpecialPrograms.set(newConfigs);

        try {
            // Lưu lên Cloud thông qua Service của Kho
            // (Giả định datasyncService đã có hàm này hoặc dùng chung cơ chế lưu)
            // Ở bước trước tôi đã hướng dẫn thêm saveSpecialPrograms vào datasync.service.js
            await datasyncService.saveSpecialPrograms($selectedWarehouse, newConfigs); 
            closeForm();
        } catch (error) {
            console.error(error);
            alert(`Lỗi lưu Cloud: ${error.message}`);
        } finally { isLoading = false; }
    }

    async function deleteProgram(index) {
        if (!confirm("Xóa chương trình này?")) return;
        let newConfigs = [...$globalSpecialPrograms];
        newConfigs.splice(index, 1);
        globalSpecialPrograms.set(newConfigs);
        
        try {
            await datasyncService.saveSpecialPrograms($selectedWarehouse, newConfigs); 
        } catch(e) { console.error(e); }
    }
</script>

{#if isOpen}
    <div class="fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center z-[1100] backdrop-blur-sm" on:click={close} role="button" tabindex="0">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-2xl mx-4 flex flex-col max-h-[90vh]" on:click|stopPropagation>
            <div class="p-5 border-b border-gray-200 flex justify-between items-center bg-purple-50 rounded-t-xl">
                <div>
                    <h3 class="text-lg font-bold text-purple-800 flex items-center gap-2">
                        <i data-feather="star"></i> Quản lý SP Đặc Quyền (User)
                    </h3>
                    <p class="text-xs text-purple-600 mt-1">Dữ liệu đồng bộ cho kho: <span class="font-bold">{$selectedWarehouse || '(Chưa chọn kho)'}</span></p>
                </div>
                <button class="text-gray-500 hover:text-red-500 text-2xl leading-none" on:click={close}>&times;</button>
            </div>
            
            <div class="p-6 overflow-y-auto">
                {#if !$selectedWarehouse}
                    <div class="p-8 text-center bg-yellow-50 border border-yellow-200 rounded-lg">
                        <p class="text-yellow-700 font-semibold">Vui lòng chọn Kho ở tab "Cập nhật dữ liệu" để sử dụng tính năng này.</p>
                    </div>
                {:else if !isFormOpen}
                    <div class="space-y-3">
                        {#if $globalSpecialPrograms.length === 0}
                            <div class="text-center py-8 bg-gray-50 rounded-lg border-2 border-dashed border-gray-200">
                                <p class="text-gray-500 mb-2">Chưa có chương trình SPĐQ nào.</p>
                                <button on:click={openAddForm} class="text-purple-600 font-bold hover:underline">+ Tạo chương trình đầu tiên</button>
                            </div>
                        {:else}
                            {#each $globalSpecialPrograms as config, index}
                                <div class="flex justify-between items-start p-4 bg-white rounded-lg border border-gray-200 shadow-sm hover:shadow-md transition">
                                    <div>
                                        <h4 class="font-bold text-gray-800 text-lg">{config.name}</h4>
                                        <div class="text-sm text-gray-600 mt-1">
                                            <p><strong>Nhóm hàng:</strong> {config.groups.join(', ')}</p>
                                        </div>
                                    </div>
                                    <div class="flex gap-2">
                                        <button on:click={() => openEditForm(index)} class="p-2 text-blue-600 hover:bg-blue-50 rounded"><i data-feather="edit-2" class="w-4 h-4"></i></button>
                                        <button on:click={() => deleteProgram(index)} class="p-2 text-red-600 hover:bg-red-50 rounded"><i data-feather="trash-2" class="w-4 h-4"></i></button>
                                    </div>
                                </div>
                            {/each}
                             <button on:click={openAddForm} class="w-full py-3 mt-2 border-2 border-dashed border-purple-200 text-purple-600 rounded-lg font-semibold hover:bg-purple-50 transition flex justify-center items-center gap-2">
                                <i data-feather="plus-circle" class="w-4 h-4"></i> Thêm chương trình SPĐQ
                            </button>
                        {/if}
                    </div>
                {:else}
                    <div class="bg-slate-50 p-5 rounded-lg border border-slate-200">
                        <h3 class="font-bold text-lg mb-4 text-slate-700">{editingIndex >= 0 ? 'Chỉnh sửa' : 'Thêm mới'}</h3>
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-bold text-slate-700 mb-1">Tên chương trình</label>
                                <input type="text" bind:value={formData.name} class="w-full p-2 border rounded-md focus:ring-2 focus:ring-purple-500 outline-none" placeholder="VD: Tivi Đặc Quyền...">
                            </div>
                            <div>
                                <label class="block text-sm font-bold text-slate-700 mb-2">Chọn Nhóm hàng</label>
                                <input type="text" bind:value={searchGroup} class="w-full mb-2 p-2 border rounded text-xs" placeholder="🔍 Tìm nhóm hàng..." />
                                <div class="h-48 overflow-y-auto p-2 border rounded bg-white grid grid-cols-1 gap-1 custom-scrollbar">
                                    {#each filteredGroups as group}
                                        <label class="flex items-center space-x-2 text-xs cursor-pointer hover:bg-gray-50 p-1 rounded"><input type="checkbox" checked={formData.groups.includes(group)} on:change={() => formData.groups = toggleSelection(formData.groups, group)} class="rounded text-purple-600 focus:ring-purple-500 border-slate-300"><span>{group}</span></label>
                                    {/each}
                                </div>
                            </div>
                            <div class="flex justify-end gap-3 pt-4">
                                <button on:click={closeForm} class="px-4 py-2 text-gray-600 bg-white border rounded hover:bg-gray-50">Hủy</button>
                                <button on:click={saveProgram} class="px-4 py-2 bg-purple-600 text-white font-bold rounded hover:bg-purple-700 disabled:opacity-50" disabled={isLoading}>{isLoading ? 'Đang lưu...' : 'Lưu'}</button>
                            </div>
                        </div>
                    </div>
                {/if}
            </div>
        </div>
    </div>
{/if}
--- END FILE: ./src/components/modals/UserSpecialProgramModal.svelte ---

--- START FILE: ./src/components/realtime/RealtimeSection.svelte ---
<script>
  import { onMount } from 'svelte';
  
  // [FIX] Sửa 'import * as dataService' thành 'import { dataService }'
  import { dataService } from '../../services/dataService.js';
  
  import { warehouseList, modalState, selectedWarehouse } from '../../stores.js';
  import { actionService } from '../../services/action.service.js';

  import SummaryTab from './summary/SummaryTab.svelte';
  import EmployeeTab from './employee/EmployeeTab.svelte';
  import EfficiencyTab from './efficiency/EfficiencyTab.svelte';
  import CategoryTab from './category/CategoryTab.svelte';
  import BrandTab from './brand/BrandTab.svelte';
  import CompetitionTab from './competition/CompetitionTab.svelte';

  export let activeTab;
  let activeSubTabId = 'subtab-realtime-sieu-thi'; 
  
  function handleSubTabClick(event) {
      const button = event.currentTarget;
      activeSubTabId = button.dataset.target;
  }

  function handleWarehouseChange(event) {
      selectedWarehouse.set(event.target.value);
  }

  async function handleFileUpload(event) {
    // Bây giờ hàm này sẽ hoạt động đúng
    await dataService.handleRealtimeFileInput(event);
  }

  // === ACTIONS ===
  function handleCompose() {
    modalState.update(s => ({ ...s, activeModal: 'composer-modal', context: 'realtime' }));
  }
  function handleExport() {
    actionService.handleExport('realtime');
  }
  function handleCapture() {
    actionService.handleCapture('realtime');
  }

  $: if (activeTab === 'realtime-section') {
    Promise.resolve().then(() => {
      if (typeof window.feather !== 'undefined') window.feather.replace();
    });
  }
</script>

<section id="realtime-section" class="page-section {activeTab === 'realtime-section' ? '' : 'hidden'}">
    
    <div class="content-card mb-6 !p-0">
        <div class="modern-page-header flex flex-wrap justify-between items-center">
            
            <div class="title-wrapper flex items-center gap-4 flex-wrap">
                <i data-feather="trending-up" class="main-icon hidden sm:block"></i>
                
                <div class="flex items-center gap-2">
                    <h2 class="page-title text-xl sm:text-2xl font-bold text-blue-800">Doanh Thu Realtime</h2>
                    <button class="page-header__help-btn" data-help-id="realtime" title="Xem hướng dẫn">
                        <i data-feather="help-circle"></i>
                    </button>
                </div>

                <div class="flex items-center gap-2 pl-4 border-l-2 border-blue-100 ml-2">
                    <label for="realtime-filter-warehouse" class="text-sm font-semibold text-gray-600 whitespace-nowrap">Kho:</label>
                     <select 
                       id="realtime-filter-warehouse" 
                       class="p-2 border rounded-lg text-sm shadow-sm bg-white border-blue-200 text-blue-700 font-bold min-w-[120px] focus:ring-2 focus:ring-blue-500 outline-none cursor-pointer hover:bg-blue-50 transition"
                       value={$selectedWarehouse}
                       on:change={handleWarehouseChange}
                     >
                       <option value="">-- Toàn bộ --</option>
                       {#each $warehouseList as kho}
                          <option value={kho}>{kho}</option>
                       {/each}
                    </select>
                </div>
            </div>

            <div class="flex flex-wrap items-center gap-3 ml-auto mt-2 sm:mt-0">
                
                <div class="flex items-center gap-2 pr-4 border-r border-blue-100">
                    <a href="https://report.mwgroup.vn/home/dashboard/077" target="_blank" class="text-blue-600 hover:text-blue-800 hover:underline text-xs font-medium flex items-center gap-1 bg-blue-50 px-2 py-1.5 rounded transition-colors">
                        <i data-feather="external-link" class="w-3 h-3"></i> Lấy file
                    </a>
                    <label for="realtime-file-input" class="cursor-pointer bg-white text-blue-700 px-3 py-1.5 rounded-lg hover:bg-blue-50 transition text-sm font-bold flex items-center gap-2 shadow-sm border border-blue-200">
                         <i data-feather="upload" class="w-4 h-4"></i>
                        <span>Tải file</span>
                    </label>
                    <input 
                        type="file" 
                        id="realtime-file-input" 
                        class="hidden" 
                        accept=".xlsx, .xls, .csv"
                        on:change={handleFileUpload}
                    >
                </div>

                <div class="flex items-center gap-2">
                     <button id="compose-realtime-notification-btn" class="action-btn action-btn--composer" title="Nhận xét" on:click={handleCompose}>
                        <i data-feather="pen-tool" class="w-4 h-4"></i>
                        <span class="hidden lg:inline">Nhận xét</span>
                     </button>
                    <button id="export-realtime-btn" class="action-btn action-btn--export" title="Xuất Excel" on:click={handleExport}>
                         <i data-feather="download" class="w-4 h-4"></i>
                        <span class="hidden lg:inline">Xuất Excel</span>
                    </button>
                    <button id="capture-realtime-btn" class="action-btn action-btn--capture" title="Chụp ảnh" on:click={handleCapture}>
                        <i data-feather="camera" class="w-4 h-4"></i>
                        <span class="hidden lg:inline">Chụp</span>
                     </button>
                </div>
            </div>
        </div>

        <div class="content-card__body p-4">
            <div class="mb-6 overflow-x-auto pb-2">
                <nav id="realtime-subtabs-nav" class="flex space-x-2 border-b border-gray-100 pb-1 w-full min-w-max" aria-label="Tabs">
                    <button 
                        class="sub-tab-btn {activeSubTabId === 'subtab-realtime-sieu-thi' ? 'active' : ''}" 
                        data-target="subtab-realtime-sieu-thi"
                        data-title="SieuThiRealtime"
                        on:click={handleSubTabClick}
                    >
                        <i data-feather="zap"></i>
                        <span>Siêu thị Realtime</span>
                    </button>
                       
                    <button 
                        class="sub-tab-btn {activeSubTabId === 'subtab-realtime-nhan-vien' ? 'active' : ''}" 
                        data-target="subtab-realtime-nhan-vien"
                        data-title="DTNVRealtime"
                        on:click={handleSubTabClick}
                    >
                        <i data-feather="pie-chart"></i>
                        <span>DT NV Realtime</span>
                    </button>

                    <button 
                        class="sub-tab-btn {activeSubTabId === 'subtab-realtime-hieu-qua-nhan-vien' ? 'active' : ''}" 
                        data-target="subtab-realtime-hieu-qua-nhan-vien"
                        data-title="HieuQuaKhaiThacRealtime"
                        on:click={handleSubTabClick}
                    >
                        <i data-feather="bar-chart-2"></i>
                        <span>Hiệu quả NV Realtime</span>
                    </button>

                      <button 
                        class="sub-tab-btn {activeSubTabId === 'subtab-realtime-nganh-hang' ? 'active' : ''}" 
                        data-target="subtab-realtime-nganh-hang"
                        data-title="NganhHangRealtime"
                        on:click={handleSubTabClick}
                    >
                        <i data-feather="layers"></i>
                        <span>Ngành hàng Realtime</span>
                    </button>

                    <button 
                        class="sub-tab-btn {activeSubTabId === 'subtab-realtime-hang-ban' ? 'active' : ''}" 
                        data-target="subtab-realtime-hang-ban"
                        data-title="HangRealtime"
                        on:click={handleSubTabClick}
                    >
                        <i data-feather="tag"></i>
                        <span>DT Hãng Realtime</span>
                    </button>

                    <button 
                        class="sub-tab-btn {activeSubTabId === 'subtab-realtime-thi-dua' ? 'active' : ''}" 
                        data-target="subtab-realtime-thi-dua"
                        data-title="ThiDuaNhanVienRealtime"
                        on:click={handleSubTabClick}
                    >
                        <i data-feather="award"></i>
                        <span>Thi đua NV Realtime</span>
                    </button>
                </nav>
            </div>

            <div id="realtime-subtabs-content">
                {#if activeSubTabId === 'subtab-realtime-sieu-thi'}
                    <div id="subtab-realtime-sieu-thi" class="sub-tab-content">
                        <SummaryTab {selectedWarehouse} />
                    </div>
                
                {:else if activeSubTabId === 'subtab-realtime-nhan-vien'}
                    <div id="subtab-realtime-nhan-vien" class="sub-tab-content" data-capture-preset="large-font-report">
                        <EmployeeTab {selectedWarehouse} />
                    </div>
                    
                {:else if activeSubTabId === 'subtab-realtime-hieu-qua-nhan-vien'}
                    <div id="subtab-realtime-hieu-qua-nhan-vien" class="sub-tab-content" data-capture-preset="landscape-table">
                        <EfficiencyTab {selectedWarehouse} />
                    </div>

                {:else if activeSubTabId === 'subtab-realtime-nganh-hang'}
                    <div id="subtab-realtime-nganh-hang" class="sub-tab-content" data-capture-preset="mobile-portrait">
                        <CategoryTab {selectedWarehouse} />
                    </div>

                {:else if activeSubTabId === 'subtab-realtime-hang-ban'}
                    <div id="subtab-realtime-hang-ban" class="sub-tab-content">
                        <BrandTab {selectedWarehouse} />
                    </div>

                {:else if activeSubTabId === 'subtab-realtime-thi-dua'}
                    <div id="subtab-realtime-thi-dua" class="sub-tab-content">
                        <CompetitionTab {selectedWarehouse} />
                    </div>
                    
                {:else}
                    <div class="p-12 text-center bg-gray-50 rounded-lg border border-dashed border-gray-300">
                        <p class="text-gray-500 font-medium">Chức năng tab <strong>{activeSubTabId}</strong> đang được phát triển.</p>
                    </div>
                {/if}
            </div>
        </div>
    </div>

</section>
--- END FILE: ./src/components/realtime/RealtimeSection.svelte ---

--- START FILE: ./src/components/realtime/brand/BrandTab.svelte ---
<script>
  import { onMount } from 'svelte';
  import { realtimeYCXData } from '../../../stores.js';
  import { reportService } from '../../../services/reportService.js';
  import { cleanCategoryName } from '../../../utils.js';
  import BrandTable from './BrandTable.svelte';

  export let selectedWarehouse = '';

  let viewType = 'brand'; // 'brand' | 'employee'
  let selectedCategory = '';
  let selectedBrand = '';
  
  let categories = [];
  let brands = [];
  let reportData = [];

  // 1. Lấy danh sách Ngành hàng từ dữ liệu (Reactive)
  $: {
      if ($realtimeYCXData.length > 0) {
          categories = [...new Set($realtimeYCXData
              .map(row => cleanCategoryName(row.nganhHang))
              .filter(Boolean))
          ].sort();
      }
  }

  // 2. Lấy danh sách Hãng dựa trên Ngành hàng đã chọn (Reactive)
  $: {
      let filteredData = $realtimeYCXData;
      if (selectedCategory) {
          filteredData = filteredData.filter(row => cleanCategoryName(row.nganhHang) === selectedCategory);
      }
      
      if (filteredData.length > 0) {
          brands = [...new Set(filteredData
              .map(row => row.nhaSanXuat || 'Hãng khác')
              .filter(Boolean))
          ].sort();
      } else {
          brands = [];
      }
      
      // Reset selectedBrand nếu nó không còn trong danh sách mới
      if (selectedBrand && !brands.includes(selectedBrand)) {
          selectedBrand = '';
      }
  }

  // 3. Tính toán dữ liệu báo cáo (Reactive)
  $: {
      // Lọc theo kho trước (Logic đơn giản hóa, sử dụng dữ liệu đã tải về)
      // Lưu ý: Nếu cần lọc chính xác theo kho của user, cần đảm bảo realtimeYCXData đã được lọc hoặc lọc lại ở đây
      // Hiện tại service sẽ xử lý việc tính toán tổng hợp.
      
      const result = reportService.generateRealtimeBrandReport(
          $realtimeYCXData, 
          selectedCategory,
          selectedBrand
      );
      
      if (viewType === 'brand') {
          reportData = result.byBrand;
      } else {
          reportData = result.byEmployee;
      }
  }
</script>

<div class="animate-fade-in pb-10">
    <div class="content-card mb-6">
        <div class="flex flex-wrap items-center justify-between gap-4 mb-4 border-b pb-4">
            <h3 class="text-xl font-bold text-gray-700 uppercase">Thống kê theo Hãng</h3>
            <div class="view-switcher bg-gray-200 p-1 rounded-lg flex">
                <button 
                    class="px-4 py-2 rounded-md text-sm font-medium transition-all {viewType === 'brand' ? 'bg-white text-blue-600 shadow-sm' : 'text-gray-600 hover:bg-gray-300'}"
                    on:click={() => viewType = 'brand'}
                >
                    Theo Hãng
                </button>
                <button 
                    class="px-4 py-2 rounded-md text-sm font-medium transition-all {viewType === 'employee' ? 'bg-white text-blue-600 shadow-sm' : 'text-gray-600 hover:bg-gray-300'}"
                    on:click={() => viewType = 'employee'}
                >
                    Theo Nhân viên
                </button>
            </div>
        </div>
        
        <div class="flex flex-wrap items-center gap-4">
            <div class="flex flex-col">
                <label for="rt-brand-cat-select" class="text-sm font-semibold text-gray-600 mb-1">Ngành hàng:</label>
                <select 
                    id="rt-brand-cat-select"
                    class="p-2 border rounded-lg text-sm shadow-sm bg-white min-w-[200px] focus:ring-2 focus:ring-blue-500 outline-none"
                    bind:value={selectedCategory}
                >
                    <option value="">-- Tất cả ngành hàng --</option>
                    {#each categories as cat}
                        <option value={cat}>{cat}</option>
                    {/each}
                </select>
            </div>

            <div class="flex flex-col">
                <label for="rt-brand-select" class="text-sm font-semibold text-gray-600 mb-1">Hãng:</label>
                <select 
                    id="rt-brand-select"
                    class="p-2 border rounded-lg text-sm shadow-sm bg-white min-w-[200px] focus:ring-2 focus:ring-blue-500 outline-none"
                    bind:value={selectedBrand}
                >
                    <option value="">-- Tất cả các hãng --</option>
                    {#each brands as brand}
                        <option value={brand}>{brand}</option>
                    {/each}
                </select>
            </div>
        </div>
    </div>

    <BrandTable {viewType} {reportData} />
</div>

<style>
  .animate-fade-in { animation: fadeIn 0.3s ease-out; }
  @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
</style>
--- END FILE: ./src/components/realtime/brand/BrandTab.svelte ---

--- START FILE: ./src/components/realtime/brand/BrandTable.svelte ---
<script>
  import { formatters } from '../../../utils/formatters.js';
  // Import component mới
  import SortableTh from '../../common/SortableTh.svelte';

  export let viewType = 'brand'; // 'brand' hoặc 'employee'
  export let reportData = [];

  let sortKey = 'revenue';
  let sortDirection = 'desc';

  // Reset sort khi đổi chế độ xem
  $: if (viewType) {
      sortKey = 'revenue';
      sortDirection = 'desc';
  }

  // Hàm xử lý sự kiện sort từ component con
  function handleSort(event) {
    const key = event.detail; // Nhận key từ dispatch('sort', key)
    if (sortKey === key) {
      sortDirection = sortDirection === 'desc' ? 'asc' : 'desc';
    } else {
      sortKey = key;
      sortDirection = 'desc';
    }
  }

  // Hàm sort dữ liệu
  function sortData(items, key, dir) {
      return [...items].sort((a, b) => {
          // Sort chữ
          if (key === 'name') {
             const valA = a.name || '';
             const valB = b.name || '';
             return dir === 'asc' ? valA.localeCompare(valB) : valB.localeCompare(valA);
          }
          // Sort số
          let valA = Number(a[key]) || 0;
          let valB = Number(b[key]) || 0;
          return dir === 'asc' ? valA - valB : valB - valA;
      });
  }

  // Cấu hình cột cho từng chế độ xem
  $: columns = viewType === 'brand' 
    ? [
        { id: 'name', label: 'Hãng', align: 'left' },
        { id: 'quantity', label: 'Số lượng', align: 'right' },
        { id: 'revenue', label: 'Doanh thu', align: 'right' },
        { id: 'avgPrice', label: 'Đơn giá TB', align: 'right' }
      ]
    : [
        { id: 'name', label: 'Nhân viên', align: 'left' },
        { id: 'quantity', label: 'Số lượng', align: 'right' },
        { id: 'revenue', label: 'Doanh thu', align: 'right' }
    ];
</script>

<div class="bg-white rounded-xl shadow-md border border-gray-200 overflow-hidden">
  <div class="p-4 border-b bg-gray-50 border-gray-200 flex justify-between items-center">
      <h4 class="text-lg font-bold uppercase text-gray-700">
          {viewType === 'brand' ? 'Thống kê theo Hãng' : 'Thống kê theo Nhân viên'}
      </h4>
  </div>

  <div class="overflow-x-auto">
    <table class="min-w-full text-sm text-left text-gray-600 table-bordered">
      <thead class="text-xs text-slate-800 uppercase bg-slate-200 font-bold sticky top-0 z-20 shadow-sm">
        <tr>
          {#each columns as col}
            <SortableTh 
              key={col.id}
              label={col.label}
              align={col.align}
              {sortKey}
              {sortDirection}
              on:sort={handleSort} 
            />
          {/each}
        </tr>
      </thead>
      <tbody class="divide-y divide-gray-200">
        {#if reportData.length === 0}
            <tr><td colspan={columns.length} class="p-4 text-center text-gray-500 italic">Không có dữ liệu.</td></tr>
        {:else}
            {#each sortData(reportData, sortKey, sortDirection) as item}
              <tr class="hover:bg-blue-50 transition">
                <td class="px-4 py-2 font-semibold text-blue-600 {viewType === 'employee' ? 'sticky left-0 bg-white hover:bg-blue-50 z-10 border-r' : ''}">
                  {item.name}
                </td>
                <td class="px-4 py-2 text-right font-bold text-gray-900">{formatters.formatNumber(item.quantity)}</td>
                <td class="px-4 py-2 text-right font-bold text-gray-900">{formatters.formatRevenue(item.revenue)}</td>
                {#if viewType === 'brand'}
                    <td class="px-4 py-2 text-right font-bold text-green-600">{formatters.formatRevenue(item.avgPrice)}</td>
                {/if}
              </tr>
            {/each}
        {/if}
      </tbody>
    </table>
  </div>
</div>
--- END FILE: ./src/components/realtime/brand/BrandTable.svelte ---

--- START FILE: ./src/components/realtime/category/CategoryTab.svelte ---
<script>
  import { realtimeYCXData, selectedWarehouse } from '../../../stores.js';
  import { reportService } from '../../../services/reportService.js';
  import { settingsService } from '../../../services/settings.service.js';
  
  // [THAY ĐỔI QUAN TRỌNG] Import bảng Doanh thu động từ Health Staff
  // Component này tự động đọc store `customRevenueTables` nên sẽ đồng bộ cấu hình bảng
  import CategoryRevenueView from '../../health-staff/CategoryRevenueView.svelte';

  export let selectedWarehouseProp = ''; // Nhận prop từ cha nếu có, hoặc dùng store

  let filteredReport = [];

  $: {
    // 1. Ưu tiên dùng prop, nếu không thì dùng store global
    const currentWarehouse = selectedWarehouseProp || $selectedWarehouse;
    
    // 2. Lấy mục tiêu (để tính % đạt nếu cần)
    const settings = settingsService.getRealtimeGoalSettings(currentWarehouse);
    const goals = settings.goals || {};

    // 3. Tính toán Master Report từ dữ liệu Realtime
    // isRealtime = true để logic tính toán xử lý đúng các trường đặc thù
    const masterReport = reportService.generateMasterReportData($realtimeYCXData, goals, true);
    
    // 4. Lọc theo kho
    if (currentWarehouse) {
      filteredReport = masterReport.filter(nv => nv.maKho == currentWarehouse);
    } else {
      filteredReport = masterReport;
    }
  }
</script>

<div class="animate-fade-in pb-10">
    <CategoryRevenueView reportData={filteredReport} />
</div>

<style>
  .animate-fade-in { animation: fadeIn 0.3s ease-out; }
  @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
</style>
--- END FILE: ./src/components/realtime/category/CategoryTab.svelte ---

--- START FILE: ./src/components/realtime/competition/CompetitionTab.svelte ---
<script>
  import { 
      realtimeYCXData, 
      globalSpecialPrograms, 
      globalCompetitionConfigs, 
      localCompetitionConfigs,
      selectedWarehouse // [FIX] Import store này
  } from '../../../stores.js';
  import { services } from '../../../services.js'; 
  
  import SpecialProgramTable from './SpecialProgramTable.svelte';
  import FocusCompetitionTable from './FocusCompetitionTable.svelte';

  // [FIX] Bỏ export let selectedWarehouse

  let specialReportData = [];
  let competitionReportData = [];
  let hasData = false;

  $: {
      // [FIX] Dùng $selectedWarehouse
      const currentWarehouse = $selectedWarehouse;
      let filteredData = $realtimeYCXData || [];
      
      console.log(`[CompetitionTab] Recalculating... Rows: ${filteredData.length}, Warehouse: ${currentWarehouse}`);

      // 2. Tính toán SP Đặc Quyền
      const spReport = services.calculateSpecialProductReport(
          filteredData, 
          $globalSpecialPrograms || []
      );

      // 3. Tính toán Thi Đua Tùy Chỉnh (Hãng)
      const allConfigs = [ ...($globalCompetitionConfigs || []), ...($localCompetitionConfigs || []) ];
      const compReport = services.calculateCompetitionFocusReport(
          filteredData,
          allConfigs
      );

      // 4. Lọc kết quả theo kho
      if (currentWarehouse) {
          const filterByWarehouse = (reports) => {
              return reports.map(group => ({
                  ...group,
                  employeeData: group.employeeData.filter(emp => String(emp.maKho) === String(currentWarehouse))
              })).filter(group => group.employeeData.length > 0);
          };

          specialReportData = filterByWarehouse(spReport);
          competitionReportData = filterByWarehouse(compReport);
      } else {
          specialReportData = spReport;
          competitionReportData = compReport;
      }

      hasData = specialReportData.length > 0 || competitionReportData.length > 0;
  }
</script>

<div class="animate-fade-in pb-10">
    {#if !hasData}
        <div class="p-12 text-center bg-gray-50 rounded-lg border-2 border-dashed border-gray-300">
            <p class="text-gray-500 font-medium mb-2">Chưa có dữ liệu thi đua hiển thị.</p>
            <p class="text-xs text-gray-400">
                Vui lòng kiểm tra: 
                1. Đã tải file Realtime chưa? 
                2. Đã tạo chương trình thi đua trong "Thiết lập mục tiêu" chưa?
                3. Dữ liệu bán hàng có khớp với nhóm hàng đã chọn không?
            </p>
        </div>
    {:else}
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            {#each specialReportData as programResult (programResult.program.id)}
                <div class="h-full">
                    <SpecialProgramTable {programResult} />
                </div>
            {/each}

            {#each competitionReportData as competitionResult (competitionResult.competition.id)}
                <div class="h-full">
                    <FocusCompetitionTable {competitionResult} />
                </div>
            {/each}
        </div>
    {/if}
</div>

<style>
    @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
    .animate-fade-in { animation: fadeIn 0.5s ease-out; }
</style>
--- END FILE: ./src/components/realtime/competition/CompetitionTab.svelte ---

--- START FILE: ./src/components/realtime/competition/FocusCompetitionTable.svelte ---
<script>
  import { formatters } from '../../../utils/formatters.js';
  // Không cần import SortableTh nữa vì ta sẽ viết trực tiếp để kiểm soát layout tốt hơn

  export let competitionResult;

  const { competition, employeeData } = competitionResult;
  const brands = competition.brands || [];
  
  let targetDisplay = competition.target || 0;
  let sortKey = 'tyLeDT';
  let sortDirection = 'desc';

  function handleSort(key) {
    if (sortKey === key) {
      sortDirection = sortDirection === 'desc' ? 'asc' : 'desc';
    } else {
      sortKey = key;
      sortDirection = 'desc';
    }
  }

  // Helper tạo class cho header
  const getHeaderClass = (key) => {
      const base = "px-2 py-2 text-center text-xs cursor-pointer hover:bg-gray-200 transition select-none";
      const active = sortKey === key ? (sortDirection === 'asc' ? 'sorted-asc bg-gray-200' : 'sorted-desc bg-gray-200') : '';
      return `${base} ${active}`;
  };

  $: sortedData = [...employeeData].sort((a, b) => {
    let valA = 0;
    let valB = 0;

    if (sortKey === 'hoTen') {
        const nameA = a.hoTen || '';
        const nameB = b.hoTen || '';
        return sortDirection === 'asc' ? nameA.localeCompare(nameB) : nameB.localeCompare(nameA);
    } 
    // Logic sort động cho các cột Hãng (VD: samsung_quantity)
    else if (sortKey.includes('_quantity') || sortKey.includes('_revenue')) {
        const [brandName, type] = sortKey.split('_'); // Tách tên hãng và loại (quantity/revenue)
        const perfA = a.performanceByBrand[brandName] || { quantity: 0, revenue: 0 };
        const perfB = b.performanceByBrand[brandName] || { quantity: 0, revenue: 0 };
        valA = perfA[type] || 0;
        valB = perfB[type] || 0;
    }
    // Logic sort cho các cột Tổng
    else {
        valA = Number(a[sortKey]) || 0;
        valB = Number(b[sortKey]) || 0;
    }
    return sortDirection === 'asc' ? valA - valB : valB - valA;
  });

  // Tính tổng
  $: totals = employeeData.reduce((acc, item) => {
      acc.baseCategoryQuantity += item.baseCategoryQuantity;
      acc.baseCategoryRevenue += item.baseCategoryRevenue;
      acc.targetBrandsQuantity += item.targetBrandsQuantity;
      acc.targetBrandsRevenue += item.targetBrandsRevenue;

      for (const brandName of brands) {
          if (!acc.performanceByBrand[brandName]) {
              acc.performanceByBrand[brandName] = { quantity: 0, revenue: 0 };
          }
          const brandPerf = item.performanceByBrand[brandName];
          if (brandPerf) {
              acc.performanceByBrand[brandName].quantity += brandPerf.quantity;
              acc.performanceByBrand[brandName].revenue += brandPerf.revenue;
          }
      }
      return acc;
  }, { 
      baseCategoryQuantity: 0, baseCategoryRevenue: 0,
      targetBrandsQuantity: 0, targetBrandsRevenue: 0,
      performanceByBrand: {}
  });

  $: totalTyLeSL = totals.baseCategoryQuantity > 0 ? (totals.targetBrandsQuantity / totals.baseCategoryQuantity) : 0;
  $: totalTyLeDT = totals.baseCategoryRevenue > 0 ? (totals.targetBrandsRevenue / totals.baseCategoryRevenue) : 0;
</script>

<div class="bg-white rounded-xl shadow-md border border-gray-200 overflow-hidden flex flex-col h-full" data-capture-group="competition-focus">
    <div class="p-4 bg-gray-50 border-b-2 border-indigo-200 flex justify-between items-center">
        <div>
            <h3 class="text-lg font-bold text-indigo-800 uppercase">{competition.name}</h3>
            <p class="text-xs text-indigo-600 font-medium mt-1">Hãng: {brands.join(', ')}</p>
        </div>
        <div class="flex items-center gap-2 bg-white px-2 py-1 rounded border border-indigo-100">
            <label for="target-{competition.id}" class="text-xs font-bold text-gray-500 uppercase">Mục tiêu %:</label>
            <input 
                type="number" 
                id="target-{competition.id}"
                class="w-16 p-1 text-sm border border-gray-300 rounded text-center focus:border-indigo-500 outline-none"
                bind:value={targetDisplay}
                placeholder="0"
            >
        </div>
    </div>

    <div class="overflow-x-auto flex-grow">
        <table class="min-w-full text-sm text-left text-gray-600 table-bordered table-striped">
            <thead class="text-xs text-slate-800 uppercase bg-slate-200 font-bold sticky top-0 z-10">
                <tr>
                    <th rowspan="2" class="px-4 py-2 bg-gray-100 border border-gray-300 cursor-pointer min-w-[150px]" on:click={() => handleSort('hoTen')}>
                        NHÂN VIÊN {sortKey === 'hoTen' ? (sortDirection === 'asc' ? '▲' : '▼') : ''}
                    </th>
                    {#each brands as brand}
                        <th colspan="2" class="px-4 py-2 text-center bg-purple-100 text-purple-900 border border-purple-200">{brand}</th>
                    {/each}
                    <th colspan="2" class="px-4 py-2 text-center bg-blue-100 text-blue-900 border border-blue-200">TỔNG NHÓM</th>
                    <th colspan="2" class="px-4 py-2 text-center bg-orange-100 text-orange-900 border border-orange-200">TỶ LỆ KHAI THÁC</th>
                </tr>
                
                <tr>
                    {#each brands as brand}
                        <th class="{getHeaderClass(`${brand}_quantity`)} bg-purple-50" on:click={() => handleSort(`${brand}_quantity`)}>
                            SL {sortKey === `${brand}_quantity` ? (sortDirection === 'asc' ? '▲' : '▼') : ''}
                        </th>
                        <th class="{getHeaderClass(`${brand}_revenue`)} bg-purple-50" on:click={() => handleSort(`${brand}_revenue`)}>
                            DT {sortKey === `${brand}_revenue` ? (sortDirection === 'asc' ? '▲' : '▼') : ''}
                        </th>
                    {/each}
                    
                    <th class="{getHeaderClass('baseCategoryQuantity')} bg-blue-50" on:click={() => handleSort('baseCategoryQuantity')}>
                        SL {sortKey === 'baseCategoryQuantity' ? (sortDirection === 'asc' ? '▲' : '▼') : ''}
                    </th>
                    <th class="{getHeaderClass('baseCategoryRevenue')} bg-blue-50" on:click={() => handleSort('baseCategoryRevenue')}>
                        DT {sortKey === 'baseCategoryRevenue' ? (sortDirection === 'asc' ? '▲' : '▼') : ''}
                    </th>
                    
                    <th class="{getHeaderClass('tyLeSL')} bg-orange-50" on:click={() => handleSort('tyLeSL')}>
                        % SL {sortKey === 'tyLeSL' ? (sortDirection === 'asc' ? '▲' : '▼') : ''}
                    </th>
                    <th class="{getHeaderClass('tyLeDT')} bg-orange-50" on:click={() => handleSort('tyLeDT')}>
                        % DT {sortKey === 'tyLeDT' ? (sortDirection === 'asc' ? '▲' : '▼') : ''}
                    </th>
                </tr>
            </thead>
            <tbody class="divide-y divide-gray-200">
                {#each sortedData as item (item.maNV)}
                    {@const isBelowSL = targetDisplay > 0 && (item.tyLeSL * 100) < targetDisplay}
                    {@const isBelowDT = targetDisplay > 0 && (item.tyLeDT * 100) < targetDisplay}
                    
                    <tr class="hover:bg-indigo-50 transition">
                        <td class="px-4 py-2 font-semibold text-indigo-900 sticky left-0 bg-white hover:bg-indigo-50 border-r">
                            {formatters.getShortEmployeeName(item.hoTen, item.maNV)}
                        </td>
                        {#each brands as brand}
                            {@const brandPerf = item.performanceByBrand[brand] || { quantity: 0, revenue: 0 }}
                            <td class="px-2 py-2 text-right font-medium">{formatters.formatNumber(brandPerf.quantity)}</td>
                            <td class="px-2 py-2 text-right font-medium">{formatters.formatRevenue(brandPerf.revenue)}</td>
                        {/each}
                        <td class="px-2 py-2 text-right font-bold bg-blue-50/30">{formatters.formatNumber(item.baseCategoryQuantity)}</td>
                        <td class="px-2 py-2 text-right font-bold bg-blue-50/30">{formatters.formatRevenue(item.baseCategoryRevenue)}</td>
                        
                        <td class="px-2 py-2 text-right font-bold bg-orange-50/30 {isBelowSL ? 'text-red-600' : 'text-green-600'}">
                            {formatters.formatPercentage(item.tyLeSL)}
                        </td>
                        <td class="px-2 py-2 text-right font-bold bg-orange-50/30 {isBelowDT ? 'text-red-600' : 'text-green-600'}">
                            {formatters.formatPercentage(item.tyLeDT)}
                        </td>
                    </tr>
                {/each}
            </tbody>
            <tfoot class="table-footer font-bold bg-gray-100 border-t-2 border-gray-300">
                <tr>
                    <td class="px-4 py-2">Tổng</td>
                    {#each brands as brand}
                        {@const brandTotals = totals.performanceByBrand[brand] || { quantity: 0, revenue: 0 }}
                        <td class="px-2 py-2 text-right">{formatters.formatNumber(brandTotals.quantity)}</td>
                        <td class="px-2 py-2 text-right">{formatters.formatRevenue(brandTotals.revenue)}</td>
                    {/each}
                    <td class="px-2 py-2 text-right">{formatters.formatNumber(totals.baseCategoryQuantity)}</td>
                    <td class="px-2 py-2 text-right">{formatters.formatRevenue(totals.baseCategoryRevenue)}</td>
                    <td class="px-2 py-2 text-right">{formatters.formatPercentage(totalTyLeSL)}</td>
                    <td class="px-2 py-2 text-right">{formatters.formatPercentage(totalTyLeDT)}</td>
                </tr>
            </tfoot>
        </table>
    </div>
</div>
--- END FILE: ./src/components/realtime/competition/FocusCompetitionTable.svelte ---

--- START FILE: ./src/components/realtime/competition/SpecialProgramTable.svelte ---
<script>
  import { formatters } from '../../../utils/formatters.js';
  import SortableTh from '../../common/SortableTh.svelte';

  // Nhận vào dữ liệu của MỘT chương trình SPĐQ
  export let programResult;

  const { program, employeeData } = programResult;

  let sortKey = 'tyLeSL';
  let sortDirection = 'desc';

  function handleSort(event) {
    const key = event.detail;
    if (sortKey === key) {
      sortDirection = sortDirection === 'desc' ? 'asc' : 'desc';
    } else {
      sortKey = key;
      sortDirection = 'desc';
    }
  }

  $: sortedData = [...employeeData].sort((a, b) => {
    let valA = Number(a[sortKey]) || 0;
    let valB = Number(b[sortKey]) || 0;

    if (sortKey === 'hoTen') {
        const nameA = a.hoTen || '';
        const nameB = b.hoTen || '';
        return sortDirection === 'asc' ? nameA.localeCompare(nameB) : nameB.localeCompare(nameA);
    }
    return sortDirection === 'asc' ? valA - valB : valB - valA;
  });

  // Tính tổng
  $: totals = employeeData.reduce((acc, item) => {
      acc.slDacQuyen += item.slDacQuyen;
      acc.slNhomHang += item.slNhomHang;
      acc.dtDacQuyen += item.dtDacQuyen;
      acc.dtNhomHang += item.dtNhomHang;
      return acc;
  }, { slDacQuyen: 0, slNhomHang: 0, dtDacQuyen: 0, dtNhomHang: 0 });

  $: totalTyLeSL = totals.slNhomHang > 0 ? (totals.slDacQuyen / totals.slNhomHang) : 0;
  $: totalTyLeDT = totals.dtNhomHang > 0 ? (totals.dtDacQuyen / totals.dtNhomHang) : 0;
</script>

<div class="bg-white rounded-xl shadow-md border border-gray-200 overflow-hidden flex flex-col h-full" data-capture-group="special-program">
    <div class="p-4 bg-purple-50 border-b-2 border-purple-200">
        <h3 class="text-lg font-bold text-purple-800 uppercase">{program.name}</h3>
        <p class="text-xs text-purple-700 font-medium mt-1">Nhóm hàng: {program.groups.join(', ')}</p>
    </div>

    <div class="overflow-x-auto flex-grow">
        <table class="min-w-full text-sm text-left text-gray-600 table-bordered table-striped">
            <thead class="text-xs text-slate-800 uppercase bg-slate-200 font-bold sticky top-0 z-10">
                <tr>
                    <SortableTh key="hoTen" label="Nhân viên" className="min-w-[150px]" {sortKey} {sortDirection} on:sort={handleSort} />
                    <SortableTh key="slDacQuyen" label="SL SPĐQ" align="right" {sortKey} {sortDirection} on:sort={handleSort} />
                    <SortableTh key="slNhomHang" label="SL Nhóm" align="right" {sortKey} {sortDirection} on:sort={handleSort} />
                    <SortableTh key="tyLeSL" label="% SL" align="right" className="bg-yellow-50" {sortKey} {sortDirection} on:sort={handleSort} />
                    <SortableTh key="dtDacQuyen" label="DT SPĐQ" align="right" {sortKey} {sortDirection} on:sort={handleSort} />
                    <SortableTh key="dtNhomHang" label="DT Nhóm" align="right" {sortKey} {sortDirection} on:sort={handleSort} />
                    <SortableTh key="tyLeDT" label="% DT" align="right" className="bg-yellow-50" {sortKey} {sortDirection} on:sort={handleSort} />
                </tr>
            </thead>
            <tbody class="divide-y divide-gray-200">
                {#each sortedData as item (item.maNV)}
                    <tr class="hover:bg-purple-50 transition">
                        <td class="px-4 py-2 font-semibold text-purple-900 sticky left-0 bg-white hover:bg-purple-50 border-r">
                            {formatters.getShortEmployeeName(item.hoTen, item.maNV)}
                        </td>
                        <td class="px-2 py-2 text-right font-bold">{formatters.formatNumber(item.slDacQuyen)}</td>
                        <td class="px-2 py-2 text-right font-bold">{formatters.formatNumber(item.slNhomHang)}</td>
                        <td class="px-2 py-2 text-right font-bold {item.tyLeSL > 0 ? 'text-blue-600' : 'text-gray-400'} bg-yellow-50/30">
                            {formatters.formatPercentage(item.tyLeSL)}
                        </td>
                        <td class="px-2 py-2 text-right font-bold">{formatters.formatRevenue(item.dtDacQuyen)}</td>
                        <td class="px-2 py-2 text-right font-bold">{formatters.formatRevenue(item.dtNhomHang)}</td>
                        <td class="px-2 py-2 text-right font-bold {item.tyLeDT > 0 ? 'text-green-600' : 'text-gray-400'} bg-yellow-50/30">
                            {formatters.formatPercentage(item.tyLeDT)}
                        </td>
                    </tr>
                {/each}
            </tbody>
            <tfoot class="table-footer font-bold bg-gray-100 border-t-2 border-gray-300">
                <tr>
                    <td class="px-4 py-2">Tổng</td>
                    <td class="px-2 py-2 text-right">{formatters.formatNumber(totals.slDacQuyen)}</td>
                    <td class="px-2 py-2 text-right">{formatters.formatNumber(totals.slNhomHang)}</td>
                    <td class="px-2 py-2 text-right">{formatters.formatPercentage(totalTyLeSL)}</td>
                    <td class="px-2 py-2 text-right">{formatters.formatRevenue(totals.dtDacQuyen)}</td>
                    <td class="px-2 py-2 text-right">{formatters.formatRevenue(totals.dtNhomHang)}</td>
                    <td class="px-2 py-2 text-right">{formatters.formatPercentage(totalTyLeDT)}</td>
                </tr>
            </tfoot>
        </table>
    </div>
</div>
--- END FILE: ./src/components/realtime/competition/SpecialProgramTable.svelte ---

--- START FILE: ./src/components/realtime/efficiency/EfficiencyTab.svelte ---
<script>
  import { realtimeYCXData, selectedWarehouse } from '../../../stores.js';
  import { reportService } from '../../../services/reportService.js';
  import { settingsService } from '../../../services/settings.service.js';
  
  // [NEW] Sử dụng View mới thay vì EfficiencyTable cũ
  import PerformanceView from '../../health-staff/performance/PerformanceView.svelte';

  let filteredReport = [];

  $: {
    const currentWarehouse = $selectedWarehouse;
    // Lấy mục tiêu Realtime
    const settings = settingsService.getRealtimeGoalSettings(currentWarehouse);
    const goals = settings.goals || {};

    // Tính toán Master Report (isRealtime = true để xử lý đúng logic realtime)
    const masterReport = reportService.generateMasterReportData($realtimeYCXData, goals, true);
    
    // Lọc theo kho
    if (currentWarehouse) {
       filteredReport = masterReport.filter(nv => nv.maKho == currentWarehouse);
    } else {
       filteredReport = masterReport;
    }
  }
</script>

<div class="animate-fade-in pb-10">
    <PerformanceView reportData={filteredReport} />
</div>

<style>
  .animate-fade-in { animation: fadeIn 0.3s ease-out; }
  @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
</style>
--- END FILE: ./src/components/realtime/efficiency/EfficiencyTab.svelte ---

--- START FILE: ./src/components/realtime/efficiency/EfficiencyTable.svelte ---
<script>
  import { afterUpdate, createEventDispatcher, onMount } from 'svelte';
  import { formatters } from '../../../utils/formatters.js';

  export let items = []; 
  export let dynamicItems = [];
  export let supermarketData = {}; 
  export let goals = {}; // Nhận goals từ component cha
  
  const dispatch = createEventDispatcher();

  // --- PHẦN STATE XỬ LÝ ẨN/HIỆN CỘT (FILTER) ---
  let isSettingsOpen = false;
  let filterSearch = '';
  let hiddenIds = new Set(); 
  const STORAGE_KEY = 'realtime_efficiency_hidden_ids';

  onMount(() => {
      // Load trạng thái ẩn hiện từ localStorage
      const saved = localStorage.getItem(STORAGE_KEY);
      if (saved) { 
          try { hiddenIds = new Set(JSON.parse(saved)); } catch (e) {} 
      }
      if (typeof feather !== 'undefined') feather.replace();
  });

  afterUpdate(() => { 
      if (typeof feather !== 'undefined') feather.replace(); 
  });

  function saveHiddenState() { 
      localStorage.setItem(STORAGE_KEY, JSON.stringify([...hiddenIds])); 
  }

  // Map icon cho các chỉ số cố định
  const iconMap = { 
      'pctPhuKien': 'headphones', 
      'pctGiaDung': 'home', 
      'pctMLN': 'droplet', 
      'pctSim': 'cpu', 
      'pctVAS': 'layers', 
      'pctBaoHiem': 'shield', 
      'tyLeTraCham': 'credit-card' 
  };

  // Map key để lấy mục tiêu tương ứng từ settings
  const targetMap = {
      'pctPhuKien': 'phanTramPhuKien', 
      'pctGiaDung': 'phanTramGiaDung', 
      'pctMLN': 'phanTramMLN',
      'pctSim': 'phanTramSim', 
      'pctVAS': 'phanTramVAS', 
  
     'pctBaoHiem': 'phanTramBaoHiem', 
      'tyLeTraCham': 'phanTramTC'
  };

  // Gộp items cố định và dynamic items lại thành danh sách hiển thị
  $: displayItems = [
      // Các chỉ số cố định (Hardcoded)
      ...items.map(i => ({
          ...i,
          // Lấy target từ goals truyền vào, nếu không có thì bằng 0
          target: goals?.[targetMap[i.id]] || 0 
      })),
      // Các chỉ số động từ Admin Config
      ...(dynamicItems || []).map(cfg => {
          const metric = 
            supermarketData.dynamicMetrics?.[cfg.id];
          return {
              id: cfg.id,
              label: cfg.label,
              value: metric ? metric.value : 0,
              // Ưu tiên target trong Goals (User setting)
              target: goals?.[cfg.id] || cfg.target,
              isDynamic: true,
              rawConfig: cfg
          };
      })
  ];

  // Logic lọc danh sách trong dropdown filter
  $: filterList = displayItems.filter(item => item.label.toLowerCase().includes(filterSearch.toLowerCase()));

  // Danh sách 
  // các item thực sự được hiển thị ra ngoài (đã trừ các item bị ẩn)
  $: visibleItems = displayItems.filter(item => !hiddenIds.has(item.id));

  // Hàm toggle ẩn/hiện 1 item
  function toggleVisibility(id) {
      if (hiddenIds.has(id)) hiddenIds.delete(id); 
      else hiddenIds.add(id);
      hiddenIds = new Set(hiddenIds); // Trigger reactivity
      saveHiddenState();
  }

  // Hàm ẩn/hiện tất cả
  function toggleAllVisibility(show) {
      if (show) {
          hiddenIds = new Set();
      } else {
          hiddenIds = new Set(displayItems.map(i => i.id));
      }
      saveHiddenState();
  }

  // --- LOGIC MÀU SẮC & CẢNH BÁO ---
  // [CẬP NHẬT] Xanh dương cho Đạt, Đỏ cho Rớt
  function getProgressColor(val, target) {
      const t = (target || 0) / 100;
      if (t <= 0) return '#3b82f6'; // Xanh dương mặc định nếu không có target
      return val >= t ? '#2563eb' : '#ef4444'; // Đạt -> Xanh dương, Rớt -> Đỏ
  }
  
  // Đóng dropdown khi click ra ngoài
  function handleWindowClick(e) { 
      if (isSettingsOpen && !e.target.closest('.filter-wrapper')) {
          isSettingsOpen = false;
      }
  }

  function handleDelete(id) { 
      if(confirm('Bạn có chắc muốn xóa chỉ số này?')) {
          dispatch('delete', id);
      }
  }
</script>

<svelte:window on:click={handleWindowClick} />

<div class="luyke-widget h-full bg-white border border-gray-200 rounded-xl shadow-sm">
  <div class="luyke-widget-header">
    <div class="luyke-widget-title">
      <div class="p-1.5 bg-blue-100 rounded text-blue-600 mr-2">
     
           <i data-feather="bar-chart-2" class="w-4 h-4"></i>
      </div>
      <span>HIỆU QUẢ KHAI THÁC</span>
    </div>
    
    <div class="flex items-center gap-2">
        <button class="text-blue-600 hover:bg-blue-50 p-1.5 rounded text-xs font-bold flex items-center gap-1 border border-blue-200" on:click={() => dispatch('add')}>
            <i data-feather="plus" class="w-3 h-3"></i> Thêm
        </button>
        
        <div class="relative filter-wrapper">
            <button class="luyke-icon-btn {isSettingsOpen ? 'active' : ''}" on:click={() => isSettingsOpen = !isSettingsOpen}>
                <i 
 data-feather="filter" class="w-4 h-4"></i>
            </button>
            
            {#if isSettingsOpen}
                <div class="filter-dropdown">
                    <div class="filter-header">
                        <input type="text" class="filter-search" placeholder="Tìm chỉ số..." bind:value={filterSearch} />
                    </div>
              
                     <div class="filter-body custom-scrollbar" style="max-height: 250px;">
                        {#each filterList as item (item.id)}
                            <div class="filter-item" on:click={() => toggleVisibility(item.id)}>
                                <input type="checkbox" checked={!hiddenIds.has(item.id)} /> 
                                <label>{item.label}</label>
    
                            </div>
                        {/each}
                    </div>
                    <div class="filter-actions">
                        <button class="filter-btn-link" on:click={() => toggleAllVisibility(true)}>Hiện tất cả</button>
                       
 <button class="filter-btn-link text-red-600" on:click={() => toggleAllVisibility(false)}>Ẩn tất cả</button>
                    </div>
                </div>
            {/if}
        </div>
    </div>
  </div>

  <div class="luyke-widget-body custom-scrollbar p-0">
    {#if visibleItems.length === 0}
       <div class="flex flex-col items-center justify-center h-full text-gray-400 py-10">
           <p class="text-sm">Đã ẩn hết dữ liệu.</p>
       </div>
    {:else}
      <div class="flex flex-col gap-0">
        {#each visibleItems 
 as item (item.id)}
          {@const targetVal = (item.target || 0) / 100}
          {@const color = getProgressColor(item.value, item.target)}
          {@const percent = Math.min((item.value * 100), 100)}
          
          <div class="eff-item-compact group relative hover:bg-gray-50 transition-colors px-4">
            <div class="eff-icon-compact">
                <i data-feather={iconMap[item.id] || 'activity'} class="w-4 h-4"></i>
            </div>
            
         
            <div class="eff-content-compact">
                <div class="eff-row-top">
                    <span class="eff-label-text">{item.label}</span>
                    <div class="flex items-center gap-2">
                        {#if item.target > 0}
                             <span class="text-[10px] text-gray-400 font-medium whitespace-nowrap">- Mục tiêu : {item.target}%</span>
                        {/if}
                        <span class="eff-value-text" style="color: {color}">
                            {formatters.formatPercentage(item.value)}
                        </span>
                    </div>
                </div>
                
 
                <div class="eff-row-bottom">
                    <div class="eff-bar-container">
                         <div class="eff-bar-fill" style="width: {percent}%; background-color: {color};"></div>
                    </div>
                    
                    </div>
            </div>

            {#if item.isDynamic}
       
                 <div class="absolute right-2 top-2 hidden group-hover:flex gap-1 bg-white shadow-sm border border-gray-200 rounded p-1 z-10">
                     <button on:click|stopPropagation={() => dispatch('edit', item.rawConfig)} class="text-gray-500 hover:text-blue-600 p-1" title="Sửa">
                         <i data-feather="edit-2" class="w-3 h-3"></i>
                     </button>
                    <button on:click|stopPropagation={() => handleDelete(item.id)} class="text-gray-500 hover:text-red-600 p-1" title="Xóa">
               
                         <i data-feather="trash-2" class="w-3 h-3"></i>
                    </button>
                </div>
            {/if}
          </div>
        {/each}
      </div>
    {/if}
  </div>
</div>
--- END FILE: ./src/components/realtime/efficiency/EfficiencyTable.svelte ---

--- START FILE: ./src/components/realtime/employee/EmployeeDetail.svelte ---
<script>
  import { createEventDispatcher } from 'svelte';
  import { realtimeYCXData, employeeMaNVMap } from '../../../stores.js';
  import { reportService } from '../../../services/reportService.js';
  // [FIX] Cập nhật đường dẫn đúng: modules -> services
  import { settingsService } from '../../../services/settings.service.js';
  import { formatters } from '../../../utils/formatters.js';
  
  export let employeeId;

  const dispatch = createEventDispatcher();
  let detailData = null;
  let employeeName = 'N/A';
  let goals = {};

  // Reactive: Tính toán dữ liệu chi tiết khi employeeId thay đổi
  $: {
    if (employeeId && $realtimeYCXData.length > 0) {
      const info = $employeeMaNVMap.get(String(employeeId));
      employeeName = info ? formatters.getShortEmployeeName(info.hoTen, info.maNV) : `NV ${employeeId}`;
      
      const warehouse = info ? info.maKho : '';
      const settings = settingsService.getRealtimeGoalSettings(warehouse);
      goals = settings.goals || {};
      
      detailData = reportService.generateRealtimeEmployeeDetailReport(employeeId, $realtimeYCXData);
    }
  }

  function goBack() {
      dispatch('back');
  }
</script>

<div class="max-w-4xl mx-auto animate-fade-in pb-10">
    <div class="mb-4 flex justify-between items-center">
        <button class="text-blue-600 hover:underline font-semibold flex items-center gap-1" on:click={goBack}>
            ‹ Quay lại bảng tổng hợp
        </button>
    </div>

    {#if detailData}
        {@const summary = detailData.summary}
        {@const conversionRateTarget = (goals?.phanTramQD || 0) / 100}
        {@const isPositive = summary.conversionRate >= conversionRateTarget}

        <div class="bg-white rounded-lg shadow-md p-6 border border-gray-200 mb-6 text-center">
            <h3 class="text-2xl font-extrabold text-gray-800">{employeeName}</h3>
            <p class="text-gray-500 font-medium">Chi tiết doanh thu Realtime</p>
        </div>

        <div class="grid grid-cols-2 md:grid-cols-3 gap-4 mb-6">
             <div class="bg-white p-4 rounded-lg shadow border border-gray-100 text-center">
                 <div class="text-sm text-gray-500 font-medium uppercase">Tổng DT Thực</div>
                 <div class="text-2xl font-bold text-blue-600 mt-1">{formatters.formatRevenue(summary.totalRealRevenue, 1)}</div>
             </div>
             <div class="bg-white p-4 rounded-lg shadow border border-gray-100 text-center">
                 <div class="text-sm text-gray-500 font-medium uppercase">Tổng DTQĐ</div>
                 <div class="text-2xl font-bold text-purple-600 mt-1">{formatters.formatRevenue(summary.totalConvertedRevenue, 1)}</div>
             </div>
             <div class="bg-white p-4 rounded-lg shadow border border-gray-100 text-center">
                 <div class="text-sm text-gray-500 font-medium uppercase">Tỷ lệ QĐ</div>
                 <div class="text-2xl font-bold mt-1 {isPositive ? 'text-green-600' : 'text-red-600'}">
                    {formatters.formatPercentage(summary.conversionRate)}
                 </div>
             </div>
             <div class="bg-white p-4 rounded-lg shadow border border-gray-100 text-center">
                <div class="text-sm text-gray-500 font-medium uppercase">DT Chưa Xuất</div>
                 <div class="text-2xl font-bold text-yellow-600 mt-1">{formatters.formatRevenue(summary.unexportedRevenue, 1)}</div>
            </div>
             <div class="bg-white p-4 rounded-lg shadow border border-gray-100 text-center">
                <div class="text-sm text-gray-500 font-medium uppercase">Tổng Đơn</div>
                <div class="text-2xl font-bold text-gray-800 mt-1">{summary.totalOrders}</div>
            </div>
            <div class="bg-white p-4 rounded-lg shadow border border-gray-100 text-center">
                 <div class="text-sm text-gray-500 font-medium uppercase">Đơn Bán Kèm</div>
                <div class="text-2xl font-bold text-gray-800 mt-1">{summary.bundledOrderCount}</div>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            
            <div class="bg-white rounded-lg shadow-md border border-gray-200 p-5">
                <h4 class="text-lg font-bold text-gray-800 mb-4 border-b pb-2">Tỷ trọng Nhóm hàng</h4>
                <div class="space-y-4">
                    {#each detailData.byProductGroup as group}
                        {@const percent = summary.totalRealRevenue > 0 ? (group.realRevenue / summary.totalRealRevenue) * 100 : 0}
                        <div>
                             <div class="flex justify-between text-sm mb-1">
                                <span class="font-semibold">{group.name}</span>
                                <span class="font-bold text-gray-700">{formatters.formatRevenue(group.realRevenue, 0)}</span>
                             </div>
                            <div class="w-full bg-gray-200 rounded-full h-2.5">
                                <div class="bg-blue-600 h-2.5 rounded-full" style="width: {percent}%"></div>
                            </div>
                        </div>
                    {/each}
                </div>
            </div>

            <div class="bg-white rounded-lg shadow-md border border-gray-200 p-5">
                <h4 class="text-lg font-bold text-gray-800 mb-4 border-b pb-2">Chi tiết Khách hàng ({detailData.byCustomer.length})</h4>
                <div class="space-y-2 max-h-[500px] overflow-y-auto pr-2">
                     {#each detailData.byCustomer as customer, index}
                        <details class="group border border-gray-200 rounded-lg bg-gray-50 open:bg-white open:shadow-sm transition-all">
                            <summary class="flex justify-between items-center p-3 cursor-pointer list-none select-none">
                                <div class="flex items-center gap-2">
                                    <span class="font-bold text-gray-500 text-sm">{index + 1}.</span>
                                    <span class="font-semibold text-gray-800 text-sm">{customer.name}</span>
                                    <span class="text-xs font-bold bg-blue-100 text-blue-800 px-2 py-0.5 rounded-full">{customer.totalQuantity} SP</span>
                                </div>
                                <span class="transform group-open:rotate-180 transition-transform text-gray-400">▼</span>
                            </summary>
                             <div class="p-3 border-t border-gray-100 text-sm">
                                <table class="w-full">
                                    {#each customer.products as p}
                                        <tr class="border-b last:border-0 border-gray-100">
                                            <td class="py-2 text-gray-600">{p.productName}</td>
                                            <td class="py-2 text-right font-bold text-gray-800">{formatters.formatRevenue(p.realRevenue)}</td>
                                        </tr>
                                    {/each}
                                </table>
                             </div>
                        </details>
                    {/each}
                </div>
            </div>
        </div>

    {:else}
        <div class="p-12 text-center bg-gray-50 rounded-lg border border-dashed border-gray-300">
             <p class="text-gray-500">Đang tải hoặc không có dữ liệu chi tiết...</p>
        </div>
    {/if}
</div>

<style>
  .animate-fade-in { animation: fadeIn 0.3s ease-out; }
  @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
</style>
--- END FILE: ./src/components/realtime/employee/EmployeeDetail.svelte ---

--- START FILE: ./src/components/realtime/employee/EmployeeList.svelte ---
<script>
  import { createEventDispatcher } from 'svelte';
  import { formatters } from '../../../utils/formatters.js';
  import { getSortedDepartmentList } from '../../../utils.js';

  export let reportData = [];
  const dispatch = createEventDispatcher();

  let sortKey = 'doanhThu';
  let sortDirection = 'desc';
  let groupedData = {};
  let departmentOrder = [];

  // Reactive statement để nhóm dữ liệu
  $: {
      groupedData = {};
      if (reportData && reportData.length > 0) {
          reportData.forEach(item => {
            const dept = item.boPhan || 'Khác';
            if (!groupedData[dept]) groupedData[dept] = [];
            groupedData[dept].push(item);
          });
          departmentOrder = getSortedDepartmentList(reportData);
      } else {
          departmentOrder = [];
      }
  }

  function handleSort(key) {
    if (sortKey === key) {
      sortDirection = sortDirection === 'desc' ? 'asc' : 'desc';
    } else {
      sortKey = key;
      sortDirection = 'desc';
    }
  }

  // SỬA LỖI: Thêm tham số key và dir vào hàm để Svelte nhận biết sự thay đổi
  function sortEmployees(employees, key, dir) {
    return [...employees].sort((a, b) => {
      if (key === 'hoTen') {
        const nameA = a.hoTen || '';
        const nameB = b.hoTen || '';
        return dir === 'asc' ? nameA.localeCompare(nameB) : nameB.localeCompare(nameA);
      }
      
      // Ép kiểu số an toàn
      let valA = Number(a[key]) || 0;
      let valB = Number(b[key]) || 0;
      
      return dir === 'asc' ? valA - valB : valB - valA;
    });
  }

  function getHeaderDeptClass(deptName) {
    if (deptName.includes('Tư Vấn')) return 'bg-blue-100 text-blue-800 border-blue-200';
    if (deptName.includes('Kho')) return 'bg-green-100 text-green-800 border-green-200';
    if (deptName.includes('Trang Trí')) return 'bg-yellow-100 text-yellow-800 border-yellow-200';
    return 'bg-gray-100 text-gray-800 border-gray-200';
  }
</script>

<div class="space-y-8">
  {#each departmentOrder as deptName}
    {#if groupedData[deptName]}
      <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
        <div class="p-4 border-b {getHeaderDeptClass(deptName)}">
          <h4 class="text-lg font-bold uppercase">{deptName}</h4>
        </div>

        <div class="overflow-x-auto">
          <table class="min-w-full text-sm text-left text-gray-600 table-bordered">
            <thead class="text-xs text-slate-800 uppercase bg-slate-200 font-bold sticky top-0 z-20 shadow-sm">
              <tr>
                <th class="px-4 py-3 cursor-pointer hover:bg-slate-300 transition sticky left-0 bg-slate-200 z-30 min-w-[180px] select-none" on:click={() => handleSort('hoTen')}>
                  <div class="flex items-center gap-1">
                    <span>Nhân viên</span>
                     <svg class="w-3 h-3 {sortKey === 'hoTen' ? 'text-blue-600 opacity-100' : 'text-gray-400 opacity-50'}" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="{sortKey === 'hoTen' && sortDirection === 'asc' ? 'M5 15l7-7 7 7' : 'M19 9l-7 7-7-7'}" />
                    </svg>
                  </div>
                </th>
                
                {#each [
                  { id: 'doanhThu', label: 'DT Thực', group: 'bg-blue-50 text-blue-800' },
                  { id: 'doanhThuQuyDoi', label: 'DT QĐ', group: 'bg-blue-50 text-blue-800' },
                  { id: 'hieuQuaQuyDoi', label: '% QĐ', group: 'bg-blue-50 text-blue-800' },
                  { id: 'doanhThuTraGop', label: 'DT Trả chậm', group: 'bg-green-50 text-green-800' },
                  { id: 'tyLeTraCham', label: '% Trả chậm', group: 'bg-green-50 text-green-800' },
                  { id: 'doanhThuChuaXuat', label: 'DT Chưa xuất', group: 'bg-yellow-50 text-yellow-800' }
                ] as col}
                  <th class="px-4 py-3 cursor-pointer hover:opacity-80 transition select-none {col.group}" on:click={() => handleSort(col.id)}>
                    <div class="flex items-center justify-end gap-1 whitespace-nowrap">
                      <span>{col.label}</span>
                      <svg class="w-3 h-3 {sortKey === col.id ? 'opacity-100' : 'opacity-40'}" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="{sortKey === col.id ? 3 : 2}" d="{sortKey === col.id && sortDirection === 'asc' ? 'M5 15l7-7 7 7' : 'M19 9l-7 7-7-7'}" />
                      </svg>
                    </div>
                  </th>
                {/each}
              </tr>
            </thead>
            <tbody class="divide-y divide-gray-200">
              {#each sortEmployees(groupedData[deptName], sortKey, sortDirection) as item (item.maNV)}
                {@const qdClass = (item.mucTieu && item.hieuQuaQuyDoi < (item.mucTieu.phanTramQD / 100)) ? 'text-red-600 bg-red-50' : 'text-green-600'}
                {@const tcClass = (item.mucTieu && item.tyLeTraCham < (item.mucTieu.phanTramTC / 100)) ? 'text-red-600 bg-red-50' : ''}
                 
                <tr class="hover:bg-blue-50 transition cursor-pointer interactive-row" on:click={() => dispatch('viewDetail', { employeeId: item.maNV })}>
                  <td class="px-4 py-2 font-semibold text-blue-600 sticky left-0 bg-white hover:bg-blue-50 z-10 border-r border-gray-200">
                    {formatters.getShortEmployeeName(item.hoTen, item.maNV)}
                  </td>
                  <td class="px-4 py-2 text-right font-bold text-gray-900">{formatters.formatRevenue(item.doanhThu)}</td>
                  <td class="px-4 py-2 text-right font-bold text-gray-900">{formatters.formatRevenue(item.doanhThuQuyDoi)}</td>
                  <td class="px-4 py-2 text-right font-bold {qdClass}">{formatters.formatPercentage(item.hieuQuaQuyDoi)}</td>
                  <td class="px-4 py-2 text-right font-bold text-gray-900">{formatters.formatRevenue(item.doanhThuTraGop)}</td>
                  <td class="px-4 py-2 text-right font-bold {tcClass}">{formatters.formatPercentage(item.tyLeTraCham)}</td>
                  <td class="px-4 py-2 text-right font-bold text-gray-500">{formatters.formatRevenue(item.doanhThuChuaXuat)}</td>
                </tr>
              {/each}
            </tbody>
          </table>
        </div>
      </div>
    {/if}
  {/each}
</div>
--- END FILE: ./src/components/realtime/employee/EmployeeList.svelte ---

--- START FILE: ./src/components/realtime/employee/EmployeeTab.svelte ---
<script>
  // [FIX] Thêm import selectedWarehouse
  import { realtimeYCXData, selectedWarehouse } from '../../../stores.js';
  import { reportService } from '../../../services/reportService.js';
  import { settingsService } from '../../../services/settings.service.js';
  
  import EmployeeList from './EmployeeList.svelte';
  import EmployeeDetail from './EmployeeDetail.svelte';

  // [FIX] Bỏ export let selectedWarehouse
  
  let selectedEmployeeId = null;
  let filteredReport = [];

  $: {
    // [FIX] Dùng $selectedWarehouse
    const currentWarehouse = $selectedWarehouse;
    const settings = settingsService.getRealtimeGoalSettings(currentWarehouse);
    const goals = settings.goals || {};
    
    const masterReport = reportService.generateMasterReportData($realtimeYCXData, goals, true);
    
    if (currentWarehouse) {
      filteredReport = masterReport.filter(nv => nv.maKho == currentWarehouse);
    } else {
      filteredReport = masterReport;
    }
    
    console.log(`[EmployeeTab] Report generated for ${filteredReport.length} employees (Warehouse: ${currentWarehouse}).`);
  }

  function handleViewDetail(event) {
    selectedEmployeeId = event.detail.employeeId;
  }

  function handleBack() {
    selectedEmployeeId = null;
  }
</script>

<div class="animate-fade-in">
  {#if selectedEmployeeId}
    <EmployeeDetail 
      employeeId={selectedEmployeeId} 
      on:back={handleBack}
    />
  {:else}
    {#if filteredReport.length > 0}
      <EmployeeList 
        reportData={filteredReport} 
        on:viewDetail={handleViewDetail}
      />
    {:else}
      <div class="p-8 text-center bg-gray-50 rounded-lg border border-gray-200">
       <p class="text-gray-500">Không có dữ liệu nhân viên nào phù hợp với bộ lọc.</p>
      </div>
    {/if}
  {/if}
</div>
--- END FILE: ./src/components/realtime/employee/EmployeeTab.svelte ---

--- START FILE: ./src/components/realtime/summary/CategoryTable.svelte ---
<script>
  import { afterUpdate, tick, onMount } from 'svelte';
  import { formatters } from '../../../utils/formatters.js';
  import { cleanCategoryName, getRandomBrightColor } from '../../../utils.js';
  import { datasyncService } from '../../../services/datasync.service.js';
  import { selectedWarehouse, macroCategoryConfig } from '../../../stores.js';
  import { adminService } from '../../../services/admin.service.js';

  export let items = []; 
  export let unexportedItems = []; 
  export let rawSource = []; 

  let showUnexported = false;
  let viewMode = 'grid'; 
  let sortMode = 'revenue_desc';
  let searchText = '';
  
  let isSettingsOpen = false;
  let filterSearch = '';
  let hiddenCategories = new Set(); 
  let isLoadingConfig = false;

  let chartInstancePie = null;
  let chartInstanceBar = null;

  onMount(async () => {
      if (!$macroCategoryConfig || $macroCategoryConfig.length === 0) {
          try {
              if (typeof adminService.loadMacroCategoryConfig === 'function') {
                  const configs = await adminService.loadMacroCategoryConfig();
                  macroCategoryConfig.set(configs);
              }
          } catch (e) { console.error(e); }
      }
  });

  // --- THEME ---
  $: titleText = showUnexported ? "CHI TIẾT CHƯA XUẤT (QĐ)" : "CHI TIẾT NGÀNH HÀNG";
  $: titleIcon = showUnexported ? "alert-circle" : "layers";
  $: titleClass = showUnexported ? "text-red-700" : "text-blue-700";
  $: iconClass = showUnexported ? "text-red-600" : "text-blue-600";

  function getCategoryTheme(name) {
      const n = name ? name.toLowerCase() : '';
      if (n.includes('điện tử') || n.includes('tivi')) return { icon: 'tv', theme: 'theme-teal' };
      if (n.includes('máy giặt') || n.includes('sấy')) return { icon: 'disc', theme: 'theme-blue' };
      if (n.includes('máy lạnh') || n.includes('điều hòa')) return { icon: 'wind', theme: 'theme-blue' };
      if (n.includes('tủ lạnh') || n.includes('tủ đông')) return { icon: 'server', theme: 'theme-blue' };
      if (n.includes('lọc nước')) return { icon: 'droplet', theme: 'theme-blue' };
      if (n.includes('laptop') || n.includes('pc')) return { icon: 'monitor', theme: 'theme-teal' };
      if (n.includes('điện thoại') || n.includes('smartphone')) return { icon: 'smartphone', theme: 'theme-blue' };
      if (n.includes('gia dụng') || n.includes('bếp')) return { icon: 'home', theme: 'theme-orange' };
      if (n.includes('phụ kiện')) return { icon: 'headphones', theme: 'theme-purple' };
      if (n.includes('đồng hồ')) return { icon: 'watch', theme: 'theme-gray' };
      return { icon: 'tag', theme: 'theme-gray' };
  }

  // --- CLOUD SYNC ---
  $: if ($selectedWarehouse) {
      loadCloudConfig($selectedWarehouse);
  }

  async function loadCloudConfig(kho) {
      isLoadingConfig = true;
      const hiddenList = await datasyncService.loadRealtimeHiddenCategories(kho);
      hiddenCategories = new Set(hiddenList);
      isLoadingConfig = false;
  }

  async function saveCloudConfig() {
      if ($selectedWarehouse) {
          await datasyncService.saveRealtimeHiddenCategories($selectedWarehouse, [...hiddenCategories]);
      }
  }

  // --- LOGIC AGGREGATION TRỰC TIẾP ---
  $: sourceData = showUnexported ? unexportedItems : items;

  $: allGroups = (() => {
      const macroItems = ($macroCategoryConfig || []).map(m => ({
          key: m.name, 
          label: m.name,
          type: 'macro'
      })).sort((a, b) => a.label.localeCompare(b.label));

      const simpleItemsMap = new Map();
      sourceData.forEach((i, index) => {
          const name = i.name || i.nganhHang;
          const safeKey = i.id || name || `unknown_${index}`;
          if (name) {
              simpleItemsMap.set(safeKey, { key: safeKey, label: name, type: 'simple' });
          }
      });
      const simpleItems = Array.from(simpleItemsMap.values()).sort((a, b) => a.label.localeCompare(b.label));

      return [...macroItems, ...simpleItems];
  })();
  
  $: filterList = allGroups.filter(g => 
      g.label.toLowerCase().includes(filterSearch.toLowerCase())
  );

  function toggleCategoryVisibility(key) {
      if (hiddenCategories.has(key)) hiddenCategories.delete(key);
      else hiddenCategories.add(key);
      hiddenCategories = new Set(hiddenCategories);
      saveCloudConfig();
  }

  function toggleAllVisibility(show) {
      hiddenCategories = show ? new Set() : new Set(allGroups.map(g => g.key));
      saveCloudConfig();
  }

  $: aggregatedItems = (() => {
      const result = [];
      const macroConfigs = $macroCategoryConfig || [];

      // A. Macro (Luôn hiện nếu không ẩn)
      macroConfigs.forEach(macro => {
          if (!hiddenCategories.has(macro.name)) {
              const keywords = (macro.items || []).map(k => k.toLowerCase());
              const childItems = sourceData.filter(item => {
                  const iName = (item.name || item.nganhHang || '').toLowerCase();
                  const iId = (item.id || '').toLowerCase();
                  return keywords.some(k => iName.includes(k) || iId === k);
              });

              if (childItems.length > 0) {
                  result.push({
                      id: `MACRO_${macro.name}`,
                      name: macro.name,
                      isMacro: true,
                      revenue: childItems.reduce((sum, i) => sum + (i.revenue || 0), 0),
                      doanhThuQuyDoi: childItems.reduce((sum, i) => sum + (i.doanhThuQuyDoi || 0), 0),
                      quantity: childItems.reduce((sum, i) => sum + (i.quantity || i.soLuong || 0), 0),
                      soLuong: childItems.reduce((sum, i) => sum + (i.soLuong || 0), 0)
                  });
              }
          }
      });

      // B. Simple (Luôn hiện nếu không ẩn)
      sourceData.forEach((item, index) => {
          const name = item.name || item.nganhHang || 'Chưa đặt tên';
          const safeId = item.id || name || `ITEM_${index}`;
          
          if (!hiddenCategories.has(safeId) && !hiddenCategories.has(name)) {
              result.push({ 
                  ...item, 
                  id: safeId,
                  name: name,
                  isMacro: false 
              });
          }
      });

      return result;
  })();

  $: filteredItems = aggregatedItems.filter(item => {
      const name = item.name || '';
      return !searchText || name.toLowerCase().includes(searchText.toLowerCase());
  });

  $: sortedItems = [...filteredItems].sort((a, b) => {
      const getRev = (i) => showUnexported ? (i.doanhThuQuyDoi || 0) : (i.revenue || 0);
      const getQty = (i) => showUnexported ? (i.soLuong || 0) : (i.quantity || 0);
      if (sortMode === 'revenue_desc') return getRev(b) - getRev(a);
      if (sortMode === 'quantity_desc') return getQty(b) - getQty(a);
      return 0;
  });

  $: totalRevenue = sourceData.reduce((sum, item) => sum + (showUnexported ? (item.doanhThuQuyDoi || 0) : (item.revenue || 0)), 0);
  $: maxVal = Math.max(...sortedItems.map(i => showUnexported ? (i.doanhThuQuyDoi || 0) : (i.revenue || 0)), 1);

  // --- CHART LOGIC ---
  $: pieData = (() => {
      const sorted = sortedItems.slice(); 
      if (sorted.length <= 14) return sorted;
      const top13 = sorted.slice(0, 13);
      const others = sorted.slice(13);
      const otherRevenue = others.reduce((sum, item) => sum + (showUnexported ? item.doanhThuQuyDoi : item.revenue), 0);
      return [...top13, { name: 'Khác', revenue: otherRevenue, doanhThuQuyDoi: otherRevenue }];
  })();

  // [FIX CHART]
  $: barData = calculateBrandData(rawSource, aggregatedItems, $macroCategoryConfig); 

  function calculateBrandData(source, visibleItems, configs) {
      if (!source || source.length === 0) return [];

      // Bung nén danh sách được phép
      const allowedNames = new Set();
      visibleItems.forEach(item => {
          if (item.isMacro) {
              const conf = (configs || []).find(c => c.name === item.name);
              if (conf && conf.items) conf.items.forEach(k => allowedNames.add(cleanCategoryName(k)));
          } else {
              allowedNames.add(cleanCategoryName(item.name || item.nganhHang));
          }
      });

      const brands = {};
      source.forEach(row => {
          const rowCatName = cleanCategoryName(row.nganhHang || '');
          if (allowedNames.has(rowCatName)) {
              const brandName = row.nhaSanXuat || 'Khác';
              const revenue = parseFloat(String(row.thanhTien || "0").replace(/,/g, '')) || 0;
              if (!brands[brandName]) brands[brandName] = { name: brandName, revenue: 0 };
              brands[brandName].revenue += revenue;
          }
      });
      return Object.values(brands).sort((a, b) => b.revenue - a.revenue).slice(0, 15);
  }

  async function renderCharts() {
      if (typeof Chart === 'undefined') return;
      await tick();

      const ctxPie = document.getElementById('rt-cat-chart');
      if (ctxPie) {
          if (chartInstancePie) chartInstancePie.destroy();
          const totalPieRev = pieData.reduce((sum, d) => sum + (showUnexported ? d.doanhThuQuyDoi : d.revenue), 0);
          chartInstancePie = new Chart(ctxPie, {
              type: 'doughnut',
              data: {
                  labels: pieData.map(d => d.name),
                  datasets: [{
                      data: pieData.map(d => showUnexported ? d.doanhThuQuyDoi : d.revenue),
                      backgroundColor: pieData.map(() => getRandomBrightColor()), borderWidth: 1
                  }]
              },
              options: { 
                  responsive: true, maintainAspectRatio: false,
                  plugins: { 
                      legend: { position: 'right', labels: { boxWidth: 10, font: { size: 11 } } },
                      datalabels: {
                          formatter: (value) => {
                              const pct = totalPieRev > 0 ? (value / totalPieRev * 100) : 0;
                              return pct > 3 ? pct.toFixed(1) + "%" : "";
                          },
                          color: '#fff', font: { weight: 'bold', size: 10 }
                      }
                  } 
              },
              plugins: [ChartDataLabels]
          });
      }
      
      const ctxBar = document.getElementById('rt-brand-chart');
      if (ctxBar) {
          if (chartInstanceBar) chartInstanceBar.destroy();
          chartInstanceBar = new Chart(ctxBar, {
              type: 'bar',
              data: {
                  labels: barData.map(d => d.name),
                  datasets: [{
                      label: 'Doanh thu (Tr)',
                      data: barData.map(d => d.revenue / 1000000),
                      backgroundColor: barData.map(() => getRandomBrightColor()), borderRadius: 4
                  }]
              },
              options: {
                  indexAxis: 'y', responsive: true, maintainAspectRatio: false,
                  plugins: {
                      legend: { display: false },
                      datalabels: { anchor: 'end', align: 'end', formatter: (val) => formatters.formatNumber(val, 0), color: '#4b5563', font: { weight: 'bold', size: 10 } },
                      tooltip: { callbacks: { label: (ctx) => formatters.formatRevenue(ctx.raw * 1000000) } }
                  },
                  scales: { x: { beginAtZero: true } }
              },
              plugins: [ChartDataLabels]
          });
      }
  }

  $: if (viewMode === 'chart') setTimeout(renderCharts, 0);

  function handleWindowClick(e) {
      if (isSettingsOpen && !e.target.closest('.filter-wrapper')) {
          isSettingsOpen = false;
      }
  }

  afterUpdate(() => { if (typeof feather !== 'undefined') feather.replace(); });
</script>

<style>
    :global(.filter-dropdown) {
        display: flex;
        flex-direction: column;
        max-height: 400px; 
    }
    :global(.filter-body) {
        flex: 1;
        overflow-y: auto;
        min-height: 0;
    }
    :global(.filter-actions) {
        flex-shrink: 0;
        border-top: 1px solid #eee;
    }
</style>

<svelte:window on:click={handleWindowClick} />

<div class="luyke-widget h-full">
    <div class="luyke-toolbar">
        <div class="luyke-toolbar-left flex-grow min-w-0">
            <h3 class="text-base sm:text-lg font-bold uppercase flex items-center gap-2 {titleClass} truncate">
                <i data-feather={titleIcon} class="{iconClass} flex-shrink-0"></i>
                <span class="truncate">{titleText}</span>
            </h3>
        </div>

        <div class="luyke-toolbar-right flex items-center gap-2">
            <div class="flex bg-gray-100 p-0.5 rounded-lg border border-gray-200">
                <button class="view-mode-btn {viewMode === 'grid' ? 'active' : ''}" on:click={() => viewMode = 'grid'}><i data-feather="grid" class="w-4 h-4"></i></button>
                <button class="view-mode-btn {viewMode === 'table' ? 'active' : ''}" on:click={() => viewMode = 'table'}><i data-feather="list" class="w-4 h-4"></i></button>
                <button class="view-mode-btn {viewMode === 'chart' ? 'active' : ''}" on:click={() => viewMode = 'chart'}><i data-feather="pie-chart" class="w-4 h-4"></i></button>
            </div>

            <div class="toggle-wrapper {showUnexported ? 'active' : ''}" on:click={() => showUnexported = !showUnexported} style="padding: 4px 8px;">
                <div class="toggle-switch" style="width: 28px; height: 16px;"></div>
                <span class="toggle-label text-xs whitespace-nowrap">Chưa xuất</span>
            </div>

            <div class="relative filter-wrapper">
                <button class="luyke-icon-btn {isSettingsOpen ? 'active' : ''}" on:click={() => isSettingsOpen = !isSettingsOpen}>
                    {#if isLoadingConfig}<div class="w-4 h-4 border-2 border-blue-600 border-t-transparent rounded-full animate-spin"></div>{:else}<i data-feather="filter" class="w-4 h-4"></i>{/if}
                </button>

                {#if isSettingsOpen}
                    <div class="filter-dropdown">
                        <div class="filter-header">
                            <input type="text" class="filter-search" placeholder="Tìm ngành hàng..." bind:value={filterSearch} />
                        </div>
                        <div class="filter-body custom-scrollbar">
                            {#if filterList.length === 0}
                                <p class="text-xs text-gray-500 text-center p-2">Không tìm thấy.</p>
                            {:else}
                                {#each filterList as group (group.key)}
                                    <div class="filter-item" on:click={() => toggleCategoryVisibility(group.key)}>
                                        <input type="checkbox" checked={!hiddenCategories.has(group.key)} />
                                        {#if group.type === 'macro'}
                                            <label class="text-teal-700 font-bold text-xs flex items-center gap-1 flex-1">
                                                <i data-feather="layers" class="w-3 h-3"></i> {group.label}
                                            </label>
                                        {:else}
                                            <label class="text-gray-700 text-xs flex-1 truncate" title={group.label}>{group.label}</label>
                                        {/if}
                                    </div>
                                {/each}
                            {/if}
                        </div>
                        <div class="filter-actions">
                            <button class="filter-btn-link" on:click={() => toggleAllVisibility(true)}>Hiện tất cả</button>
                            <button class="filter-btn-link text-red-600" on:click={() => toggleAllVisibility(false)}>Ẩn tất cả</button>
                        </div>
                    </div>
                {/if}
            </div>
        </div>
    </div>

    <div class="luyke-widget-body bg-white border-t border-gray-100 p-4">
        {#if sortedItems.length === 0}
            <div class="text-center py-10 text-gray-400 italic">Không có dữ liệu hiển thị.</div>
        
        {:else if viewMode === 'grid'}
            <div class="luyke-cat-grid">
                {#each sortedItems as item (item.id)}
                    {@const name = item.name}
                    {@const revenue = showUnexported ? item.doanhThuQuyDoi : item.revenue}
                    {@const quantity = showUnexported ? item.soLuong : item.quantity}
                    {@const style = getCategoryTheme(name)}
                    {@const percent = maxVal > 0 ? (revenue / maxVal) * 100 : 0}
                    
                    {@const finalTheme = showUnexported ? 'theme-warning' : (item.isMacro ? 'bg-indigo-50 border-indigo-200 ring-1 ring-indigo-100' : style.theme)}
                    {@const iconName = item.isMacro ? 'layers' : style.icon}
                    {@const textColor = item.isMacro ? 'text-indigo-800' : ''}

                    <div class="cat-card-colorful {finalTheme}">
                        <div class="cat-top-row">
                            <div class="cat-icon-box {item.isMacro ? 'bg-indigo-100 text-indigo-600' : ''}">
                                <i data-feather={iconName} class="w-5 h-5"></i>
                            </div>
                            {#if !showUnexported && totalRevenue > 0}
                                <span class="cat-percent-text text-xs {item.isMacro ? 'text-indigo-600' : ''}">
                                    {formatters.formatPercentage(revenue/totalRevenue)}
                                </span>
                            {/if}
                        </div>
                        
                        <h4 class="cat-name-text {textColor}" title={name}>
                            {name} 
                            {#if item.isMacro}<span class="text-[10px] bg-white border px-1 rounded text-gray-500 ml-1 font-normal">GỘP</span>{/if}
                        </h4>
                        
                        <div class="cat-value-text {textColor}">{formatters.formatRevenue(revenue, 0)}</div>
                        
                        <div class="cat-footer-row">
                            <span>SL: <strong>{formatters.formatNumber(quantity)}</strong></span>
                        </div>
                        
                        <div class="cat-bar-bg">
                            <div class="cat-bar-fill {item.isMacro ? 'bg-indigo-500' : ''}" style="width: {percent}%"></div>
                        </div>
                    </div>
                {/each}
            </div>

        {:else if viewMode === 'table'}
            <div class="overflow-x-auto">
                <table class="w-full text-sm table-bordered">
                    <thead class="bg-gray-100 font-bold text-gray-700">
                        <tr>
                            <th class="px-3 py-2 text-left">Ngành hàng</th>
                            <th class="px-3 py-2 text-right">SL</th>
                            <th class="px-3 py-2 text-right">Doanh thu</th>
                            {#if showUnexported}<th class="px-3 py-2 text-right">DT Thực</th>{/if}
                        </tr>
                    </thead>
                    <tbody>
                        {#each sortedItems as item (item.id)}
                            <tr class="hover:bg-gray-50 {item.isMacro ? 'bg-indigo-50/50' : ''}">
                                <td class="px-3 py-2 {item.isMacro ? 'font-bold text-indigo-800' : ''}">{item.name}</td>
                                <td class="px-3 py-2 text-right font-bold">{formatters.formatNumber(showUnexported ? item.soLuong : item.quantity)}</td>
                                <td class="px-3 py-2 text-right font-bold text-blue-600">{formatters.formatRevenue(showUnexported ? item.doanhThuQuyDoi : item.revenue)}</td>
                                {#if showUnexported}
                                    <td class="px-3 py-2 text-right text-gray-500">{formatters.formatRevenue(item.doanhThuThuc)}</td>
                                {/if}
                            </tr>
                        {/each}
                    </tbody>
                </table>
            </div>

        {:else}
            <div class="luyke-charts-container p-0 border-0 rounded-none">
                <div class="chart-box">
                    <h4 class="text-sm font-bold text-gray-700 mb-2 text-center">Tỷ trọng Doanh Thu (Triệu)</h4>
                    <div class="relative h-full w-full"><canvas id="rt-cat-chart"></canvas></div>
                </div>
                <div class="chart-box">
                    <h4 class="text-sm font-bold text-gray-700 mb-2 text-center">Top 15 Hãng (Triệu)</h4>
                    <div class="relative h-full w-full"><canvas id="rt-brand-chart"></canvas></div>
                </div>
            </div>
        {/if}
    </div>
</div>
--- END FILE: ./src/components/realtime/summary/CategoryTable.svelte ---

--- START FILE: ./src/components/realtime/summary/EfficiencyTable.svelte ---
<script>
  import { formatters } from '../../../utils/formatters.js';
  import SortableTh from '../../common/SortableTh.svelte';

  export let items = []; 

  let sortKey = 'label';
  let sortDirection = 'asc';

  function handleSort(event) {
    const key = event.detail;
    if (sortKey === key) {
      sortDirection = sortDirection === 'desc' ? 'asc' : 'desc';
    } else {
      sortKey = key;
      sortDirection = 'desc';
    }
  }

  $: sortedItems = [...items].sort((a, b) => {
    let valA, valB;

    if (sortKey === 'label') {
        valA = a.label || '';
        valB = b.label || '';
        return sortDirection === 'asc' ? valA.localeCompare(valB) : valB.localeCompare(valA);
    } 
    
    valA = a[sortKey] || 0;
    valB = b[sortKey] || 0;
    return sortDirection === 'asc' ? valA - valB : valB - valA;
  });
</script>

<div class="bg-white rounded-xl shadow-md p-4 border border-gray-200 h-full">
  <h3 class="text-lg font-bold text-gray-700 mb-4 uppercase border-b pb-2 bg-yellow-50 p-2 rounded">Hiệu quả khai thác</h3>

  {#if items.length === 0}
    <p class="text-gray-500 font-bold p-4 text-center">Vui lòng tải file realtime để xem chi tiết.</p>
  {:else}
    <div class="overflow-x-auto">
      <table class="min-w-full text-sm table-bordered">
        <thead class="text-xs text-slate-800 uppercase bg-slate-200 font-bold">
          <tr>
            <SortableTh key="label" label="Chỉ số" align="left" {sortKey} {sortDirection} on:sort={handleSort} />
            <SortableTh key="value" label="Thực hiện" align="right" {sortKey} {sortDirection} on:sort={handleSort} />
            <SortableTh key="target" label="Mục tiêu" align="right" {sortKey} {sortDirection} on:sort={handleSort} />
          </tr>
        </thead>
        <tbody>
          {#each sortedItems as item (item.id)}
            {@const isBelow = item.value < ((item.target || 0) / 100)}
            <tr class="border-t hover:bg-gray-50">
              <td class="px-4 py-2 font-semibold text-gray-800">{item.label}</td>
              <td class="px-4 py-2 text-right font-bold text-lg {isBelow ? 'bg-red-100 text-red-700' : 'text-blue-600'}">
                {formatters.formatPercentage(item.value)}
              </td>
              <td class="px-4 py-2 text-right text-gray-600">{item.target || 0}%</td>
            </tr>
          {/each}
        </tbody>
      </table>
    </div>
  {/if}
</div>
--- END FILE: ./src/components/realtime/summary/EfficiencyTable.svelte ---

--- START FILE: ./src/components/realtime/summary/KpiCards.svelte ---
<script>
  import { formatters } from '../../../utils/formatters.js';

  export let supermarketReport = {};
  export let goals = {};

  // Reactive variables để hiển thị
  $: doanhThu = supermarketReport.doanhThu || 0;
  $: doanhThuQD = supermarketReport.doanhThuQuyDoi || 0;
  $: doanhThuTraGop = supermarketReport.doanhThuTraGop || 0;
  $: doanhThuChuaXuat = supermarketReport.doanhThuChuaXuat || 0;
  $: doanhThuQDChuaXuat = supermarketReport.doanhThuQuyDoiChuaXuat || 0;
  
  $: hieuQuaQuyDoi = supermarketReport.hieuQuaQuyDoi || 0;
  $: tyLeTraCham = supermarketReport.tyLeTraCham || 0;

  // Mục tiêu
  $: targetDTT = parseFloat(goals?.doanhThuThuc) || 0;
  $: targetDTQD = parseFloat(goals?.doanhThuQD) || 0;
  $: targetTLQD = parseFloat(goals?.phanTramQD) || 0;

  // Tính % Hoàn thành
  $: percentDTT = targetDTT > 0 ? ((doanhThu / 1000000) / targetDTT) : 0;
  $: percentDTQD = targetDTQD > 0 ? ((doanhThuQD / 1000000) / targetDTQD) : 0;

</script>

<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
  <div class="kpi-card p-6 rounded-2xl shadow-lg bg-[#38bdf8]">
    <h4 class="kpi-card-title font-semibold uppercase tracking-wider text-white opacity-90">Doanh thu thực</h4>
    <p class="font-bold mt-2 mb-3 text-white text-4xl">
      {formatters.formatNumber(doanhThu / 1000000, 1)}
    </p>
    <div class="text-sm text-white opacity-90">
      <p>% HT: <span class="font-bold">{formatters.formatPercentage(percentDTT)}</span> / Target: {formatters.formatNumber(targetDTT)}</p>
      <p class="mt-1 text-xs border-t border-white/30 pt-1">DT Chưa xuất: <strong>{formatters.formatNumber(doanhThuChuaXuat / 1000000, 1)}</strong></p>
    </div>
  </div>

  <div class="kpi-card p-6 rounded-2xl shadow-lg bg-[#34d399]">
    <h4 class="kpi-card-title font-semibold uppercase tracking-wider text-white opacity-90">Doanh thu Quy đổi</h4>
    <p class="font-bold mt-2 mb-3 text-white text-4xl">
      {formatters.formatNumber(doanhThuQD / 1000000, 1)}
    </p>
    <div class="text-sm text-white opacity-90">
      <p>% HT: <span class="font-bold">{formatters.formatPercentage(percentDTQD)}</span> / Target: {formatters.formatNumber(targetDTQD)}</p>
      <p class="mt-1 text-xs border-t border-white/30 pt-1">DTQĐ Chưa xuất: <strong>{formatters.formatNumber(doanhThuQDChuaXuat / 1000000, 1)}</strong></p>
    </div>
  </div>

  <div class="kpi-card p-6 rounded-2xl shadow-lg bg-[#fbbf24]">
    <h4 class="kpi-card-title font-semibold uppercase tracking-wider text-white opacity-90">Tỷ lệ quy đổi</h4>
    <p class="font-bold mt-2 mb-3 text-white text-4xl">
      {formatters.formatPercentage(hieuQuaQuyDoi)}
    </p>
    <div class="text-sm text-white opacity-90">
      <p>Mục tiêu: <span class="font-bold">{formatters.formatNumber(targetTLQD)}%</span></p>
      <p class="mt-1 text-xs italic">So với doanh thu thực</p>
    </div>
  </div>

  <div class="kpi-card p-6 rounded-2xl shadow-lg bg-[#2dd4bf]">
    <h4 class="kpi-card-title font-semibold uppercase tracking-wider text-white opacity-90">Doanh thu trả chậm</h4>
    <p class="font-bold mt-2 mb-3 text-white text-4xl">
      {formatters.formatNumber(doanhThuTraGop / 1000000, 1)}
    </p>
    <div class="text-sm text-white opacity-90">
      <p>% thực trả chậm: <span class="font-bold">{formatters.formatPercentage(tyLeTraCham)}</span></p>
      <p class="mt-1 text-xs italic">Trên tổng doanh thu</p>
    </div>
  </div>
</div>

<style>
  .kpi-card {
    transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
  }
  .kpi-card:hover {
    transform: translateY(-4px);
    box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
  }
</style>
--- END FILE: ./src/components/realtime/summary/KpiCards.svelte ---

--- START FILE: ./src/components/realtime/summary/QdcTable.svelte ---
<script>
  import { onMount, afterUpdate } from 'svelte';
  import { formatters } from '../../../utils/formatters.js';
  import { cleanCategoryName } from '../../../utils.js';
  import { 
      categoryStructure, 
      macroProductGroupConfig, 
      selectedWarehouse 
  } from '../../../stores.js';
  import { datasyncService } from '../../../services/datasync.service.js';
  import { adminService } from '../../../services/admin.service.js';

  export let items = []; 
  export let numDays = 1;

  let isSettingsOpen = false;
  let filterSearch = '';
  let saveTimer;
  let localConfig = []; 

  // Bảng màu rực rỡ cho thanh tiến trình
  const BAR_COLORS = [
      'bg-red-500', 'bg-orange-500', 'bg-amber-500', 'bg-yellow-400',
      'bg-lime-500', 'bg-green-500', 'bg-emerald-500', 'bg-teal-500',
      'bg-cyan-500', 'bg-sky-500', 'bg-blue-500', 'bg-indigo-500',
      'bg-violet-500', 'bg-fuchsia-500', 'bg-pink-500', 'bg-rose-500'
  ];

  // 1. Load config Nhóm Hàng Lớn nếu chưa có
  onMount(async () => {
      if (!$macroProductGroupConfig || $macroProductGroupConfig.length === 0) {
          try {
              const configs = await adminService.loadMacroProductGroupConfig();
              macroProductGroupConfig.set(configs);
          } catch (e) {
              console.error("Lỗi load Macro Product Groups:", e);
          }
      }
  });

  // 2. Tạo danh sách Filter (Ưu tiên Nhóm Lớn lên đầu)
  $: allGroups = (() => {
      // A. Nhóm Lớn
      const macroNames = ($macroProductGroupConfig || []).map(m => ({
          name: m.name,
          type: 'macro'
      })).sort((a, b) => a.name.localeCompare(b.name));

      // B. Nhóm Thường
      const structureNames = new Set(($categoryStructure || []).map(c => cleanCategoryName(c.nhomHang)).filter(Boolean));
      const presentNames = new Set(items.map(i => i.name).filter(Boolean));
      
      const simpleNames = [...new Set([...structureNames, ...presentNames])]
          .sort()
          .map(name => ({
              name: name,
              type: 'simple'
          }));

      return [...macroNames, ...simpleNames];
  })();

  $: filterList = allGroups.filter(g => 
      g.name.toLowerCase().includes(filterSearch.toLowerCase())
  );

  // 3. Logic Load/Save Config (Dùng chung config với Lũy kế để đồng bộ trải nghiệm)
  $: if ($selectedWarehouse) {
      loadConfigForWarehouse($selectedWarehouse);
  } else {
      localConfig = allGroups.map(g => g.name);
  }

  async function loadConfigForWarehouse(kho) {
      try {
          const savedConfig = await datasyncService.loadQdcConfig(kho);
          if (savedConfig && Array.isArray(savedConfig)) {
              localConfig = savedConfig;
          } else {
              localConfig = allGroups.map(g => g.name);
          }
      } catch (e) {
          localConfig = allGroups.map(g => g.name);
      }
  }

  function toggleQdcSelection(name) {
      if (localConfig.includes(name)) {
          localConfig = localConfig.filter(n => n !== name);
      } else {
          localConfig = [...localConfig, name];
      }
      
      clearTimeout(saveTimer);
      saveTimer = setTimeout(() => {
          if ($selectedWarehouse) {
              datasyncService.saveQdcConfig($selectedWarehouse, localConfig);
          }
      }, 500); 
  }

  function toggleAllVisibility(show) {
      if (show) {
          localConfig = allGroups.map(g => g.name);
      } else {
          localConfig = [];
      }
      if ($selectedWarehouse) {
         datasyncService.saveQdcConfig($selectedWarehouse, localConfig);
      }
  }

  // 4. Aggregation Logic (Cộng gộp Nhóm Lớn)
  $: sortedItems = (() => {
      if (localConfig.length === 0) return [];

      let finalResults = [];
      const macroConfigs = $macroProductGroupConfig || [];
      
      const selectedMacros = localConfig.filter(name => macroConfigs.some(m => m.name === name));
      const selectedSimples = localConfig.filter(name => !macroConfigs.some(m => m.name === name));

      // A. Xử lý Macro Group
      selectedMacros.forEach(macroName => {
          const config = macroConfigs.find(m => m.name === macroName);
          if (!config) return;

          const childIds = new Set(config.items || []);
          const childItems = items.filter(i => childIds.has(i.id));

          if (childItems.length > 0) {
              // Tính tổng (Hỗ trợ cả field Realtime và Luyke)
              const aggregatedItem = {
                  id: config.id, 
                  name: config.name,
                  isMacro: true, 
                  dtqd: childItems.reduce((sum, i) => sum + (i.dtqd || i.revenueQuyDoi || 0), 0),
                  dt: childItems.reduce((sum, i) => sum + (i.dt || i.revenue || 0), 0),
                  quantity: childItems.reduce((sum, i) => sum + (i.quantity || i.soLuong || i.sl || 0), 0),
                  _children: childItems 
              };
              finalResults.push(aggregatedItem);
          } 
      });

      // B. Xử lý Simple Items
      selectedSimples.forEach(simpleName => {
          const item = items.find(i => i.name === simpleName);
          if (item) {
              // Chuẩn hóa data field nếu cần để hiển thị thống nhất
              finalResults.push({ 
                  ...item, 
                  dtqd: (item.dtqd || item.revenueQuyDoi || 0),
                  dt: (item.dt || item.revenue || 0),
                  quantity: (item.quantity || item.soLuong || item.sl || 0),
                  isMacro: false 
              });
          }
      });

      // Sắp xếp giảm dần theo doanh thu QĐ
      return finalResults.sort((a, b) => (b.dtqd || 0) - (a.dtqd || 0));
  })();

  $: maxVal = sortedItems.length > 0 ? (sortedItems[0].dtqd || 1) : 1;

  function handleWindowClick(e) {
      if (isSettingsOpen && !e.target.closest('.filter-wrapper')) {
          isSettingsOpen = false;
      }
  }

  afterUpdate(() => {
    if (typeof feather !== 'undefined') feather.replace();
  });
</script>

<svelte:window on:click={handleWindowClick} />

<div class="bg-white rounded-xl shadow-md border border-gray-200 overflow-hidden h-full flex flex-col">
  <div class="p-3 border-b border-gray-100 flex justify-between items-center bg-gray-50/50">
    <div class="flex items-center gap-2 font-bold text-slate-700 text-sm uppercase">
      <div class="p-1.5 bg-blue-100 rounded text-blue-600">
          <i data-feather="zap" class="w-4 h-4"></i>
      </div>
      <span>TOP NHÓM HÀNG</span>
    </div>

    <div class="relative filter-wrapper">
        <button class="p-1.5 hover:bg-gray-100 rounded text-gray-500 transition-colors {isSettingsOpen ? 'bg-blue-50 text-blue-600' : ''}" on:click={() => isSettingsOpen = !isSettingsOpen} title="Chọn nhóm hàng">
             <i data-feather="filter" class="w-4 h-4"></i>
        </button>
        {#if isSettingsOpen}
            <div class="absolute right-0 top-full mt-2 w-64 bg-white rounded-lg shadow-xl border border-gray-200 z-50 flex flex-col overflow-hidden">
                <div class="p-2 border-b border-gray-100 bg-gray-50">
                    <input type="text" class="w-full p-1.5 text-xs border border-gray-300 rounded focus:border-blue-500 outline-none" placeholder="Tìm nhóm hàng..." bind:value={filterSearch} />
                </div>
                <div class="overflow-y-auto custom-scrollbar p-1" style="max-height: 250px;">
                    {#if filterList.length === 0}
                         <p class="text-xs text-gray-500 text-center p-2">Không tìm thấy.</p>
                    {:else}
                        {#each filterList as group}
                            {@const isChecked = localConfig.includes(group.name)}
                            <div class="flex items-center gap-2 p-2 hover:bg-gray-50 rounded cursor-pointer" on:click={() => toggleQdcSelection(group.name)}>
                                 <input type="checkbox" checked={isChecked} class="rounded text-blue-600 focus:ring-blue-500" />
                                 {#if group.type === 'macro'}
                                    <label class="{isChecked ? 'font-bold text-teal-700' : 'text-teal-600 font-semibold'} text-xs flex items-center gap-1 cursor-pointer flex-1">
                                        <i data-feather="layers" class="w-3 h-3"></i>
                                        {group.name}
                                    </label>
                                 {:else}
                                    <label class="{isChecked ? 'font-bold text-blue-700' : 'text-gray-700'} text-xs cursor-pointer flex-1">{group.name}</label>
                                 {/if}
                            </div>
                        {/each}
                    {/if}
                 </div>
                <div class="p-2 border-t border-gray-100 bg-gray-50 flex justify-between text-xs">
                    <button class="text-blue-600 font-semibold hover:underline" on:click={() => toggleAllVisibility(true)}>Hiện tất cả</button>
                    <button class="text-red-600 font-semibold hover:underline" on:click={() => toggleAllVisibility(false)}>Ẩn tất cả</button>
                </div>
            </div>
        {/if}
    </div>
  </div>

  <div class="custom-scrollbar flex-1 overflow-y-auto p-2">
    {#if sortedItems.length === 0}
        <div class="flex flex-col items-center justify-center h-full text-gray-400 py-10">
          <p class="text-sm">Không có dữ liệu hiển thị.</p>
          {#if items.length > 0}
             <p class="text-xs mt-1">Hãy kiểm tra bộ lọc nhóm hàng.</p>
          {/if}
       </div>
    {:else}
      <div class="flex flex-col gap-0">
        {#each sortedItems as item, index (item.name)}
          {@const percent = maxVal > 0 ? (item.dtqd / maxVal) * 100 : 0}
          
          {@const barColor = BAR_COLORS[index % BAR_COLORS.length]}
          
          <div class="py-2.5 border-b border-dashed border-gray-100 last:border-0 transition-colors px-1.5 rounded
                      {item.isMacro ? 'bg-teal-50/40 hover:bg-teal-50/60' : 'hover:bg-gray-50'}">
            
            <div class="flex items-center gap-3">
               <div class="w-6 text-center font-bold text-gray-400 text-xs">#{index + 1}</div>
               
               <div class="flex-grow min-w-0">
                   <div class="flex justify-between items-center mb-1.5">
                       <span class="text-sm font-semibold truncate pr-2 flex items-center gap-1.5 {item.isMacro ? 'text-teal-800' : 'text-slate-700'}" title={item.name}>
                           {#if item.isMacro}
                                <i data-feather="layers" class="w-3.5 h-3.5 text-teal-600"></i>
                           {/if}
                           {item.name}
                       </span>
                       <span class="text-sm font-bold whitespace-nowrap text-slate-800">
                           {formatters.formatRevenue(item.dtqd)}
                       </span>
                   </div>
                   
                   <div class="w-full h-2 bg-gray-100 rounded-full overflow-hidden mb-1.5 shadow-inner">
                        <div class="h-full rounded-full {barColor} shadow-sm transition-all duration-500 ease-out" style="width: {percent}%"></div>
                   </div>
                   
                   <div class="flex justify-between text-[10px] text-gray-500 flex-wrap gap-y-1 font-medium">
                       <div class="flex gap-3">
                           <span>DT: <strong class="text-slate-600">{formatters.formatRevenue(item.dt)}</strong></span>
                           <span class="{item.isMacro ? 'text-teal-600' : 'text-blue-600'}">QĐ: <strong>{formatters.formatRevenue(item.dtqd)}</strong></span>
                       </div>
                       <div class="flex gap-3">
                           <span>SL: {formatters.formatNumber(item.quantity)}</span>
                           {#if numDays > 1}
                                <span>TB: <strong>{formatters.formatNumber(item.quantity / numDays, 0)}</strong>/ngày</span>
                           {/if}
                       </div>
                    </div>
               </div>
            </div>
          </div>
        {/each}
      </div>
    {/if}
  </div>
</div>

<style>
    .custom-scrollbar::-webkit-scrollbar { width: 6px; }
    .custom-scrollbar::-webkit-scrollbar-track { background: #f1f1f1; }
    .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
    .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
</style>
--- END FILE: ./src/components/realtime/summary/QdcTable.svelte ---

--- START FILE: ./src/components/realtime/summary/SummaryTab.svelte ---
<script>
  import { 
    realtimeYCXData, 
    selectedWarehouse, 
    efficiencyConfig, 
    warehouseCustomMetrics 
  } from '../../../stores.js';
  import { reportService } from '../../../services/reportService.js';
  import { settingsService } from '../../../services/settings.service.js';
  import { formatters } from '../../../utils/formatters.js';
  import { datasyncService } from '../../../services/datasync.service.js';
  import { adminService } from '../../../services/admin.service.js';
  
  import QdcTable from './QdcTable.svelte';
  import CategoryTable from './CategoryTable.svelte';
  import EfficiencyTable from '../efficiency/EfficiencyTable.svelte';
  import { onMount } from 'svelte';

  let supermarketReport = {};
  let goals = {};
  
  let qdcItems = [];
  let categoryItems = [];
  let unexportedItems = []; 
  let rawSourceData = [];

  let combinedEfficiencyItems = [];

  onMount(async () => {
      const globalConfig = await adminService.loadEfficiencyConfig();
      efficiencyConfig.set(globalConfig);
  });

  $: if ($selectedWarehouse) {
      loadLocalMetrics($selectedWarehouse);
  }

  async function loadLocalMetrics(kho) {
      const localData = await datasyncService.loadCustomMetrics(kho);
      warehouseCustomMetrics.set(localData);
  }

  $: combinedEfficiencyItems = [
      ...($efficiencyConfig || []).map(i => ({ ...i, isSystem: true })),
      ...($warehouseCustomMetrics || []).map(i => ({ ...i, isSystem: false }))
  ];

  async function handleDeleteMetric(event) {
      const id = event.detail;
      const item = combinedEfficiencyItems.find(i => i.id === id);
      
      if (item && item.isSystem) {
          alert("Đây là chỉ số hệ thống, bạn không thể xóa. Hãy dùng bộ lọc để ẩn nó đi.");
          return;
      }

      if (confirm("Xóa chỉ số cá nhân này?")) {
          const newLocalMetrics = $warehouseCustomMetrics.filter(i => i.id !== id);
          warehouseCustomMetrics.set(newLocalMetrics);
          if ($selectedWarehouse) {
              await datasyncService.saveCustomMetrics($selectedWarehouse, newLocalMetrics);
          }
      }
  }

  $: {
    const currentWarehouse = $selectedWarehouse;
    const settings = settingsService.getRealtimeGoalSettings(currentWarehouse);
    goals = settings.goals || {};

    const masterReport = reportService.generateMasterReportData($realtimeYCXData, goals, true);
    
    let filteredReport = masterReport;
    let filteredRawData = $realtimeYCXData;

    if (currentWarehouse) {
      filteredReport = masterReport.filter(nv => nv.maKho == currentWarehouse);
      const visibleEmployees = new Set(filteredReport.map(nv => String(nv.maNV)));
      filteredRawData = $realtimeYCXData.filter(row => {
          const msnvMatch = String(row.nguoiTao || '').match(/(\d+)/);
          return msnvMatch && visibleEmployees.has(msnvMatch[1].trim());
      });
    }
    
    rawSourceData = filteredRawData;

    supermarketReport = reportService.aggregateReport(filteredReport, currentWarehouse);

    qdcItems = supermarketReport.nhomHangChiTiet 
        ? Object.entries(supermarketReport.nhomHangChiTiet)
            .map(([name, values]) => ({
                id: name,
                name,
                dtqd: values.revenueQuyDoi,
                sl: values.quantity,
                dt: values.revenue,
                ...values
            }))
            .filter(i => i.sl > 0 || i.dt > 0) 
        : [];

    categoryItems = supermarketReport.nganhHangChiTiet 
        ? Object.values(supermarketReport.nganhHangChiTiet).filter(i => i.revenue > 0 || i.quantity > 0)
        : [];

    unexportedItems = reportService.generateRealtimeChuaXuatReport(filteredRawData);
  }

  $: pctDTT = (parseFloat(goals?.doanhThuThuc) || 0) > 0 ? (supermarketReport.doanhThu / 1000000) / parseFloat(goals.doanhThuThuc) : 0;
  $: pctDTQD = (parseFloat(goals?.doanhThuQD) || 0) > 0 ? (supermarketReport.doanhThuQuyDoi / 1000000) / parseFloat(goals.doanhThuQD) : 0;
</script>

<div class="luyke-dashboard-container pb-10">
  
  <h2 id="realtime-supermarket-title" class="text-2xl font-bold text-gray-800 flex items-center justify-center gap-2">
    <i data-feather="zap" class="text-yellow-500 fill-current"></i>
    Báo cáo Realtime {$selectedWarehouse ? `- Kho ${$selectedWarehouse}` : '(Toàn bộ)'}
    <span class="text-sm font-normal text-gray-500 ml-2 pt-1">
      (Cập nhật: {new Date().toLocaleTimeString('vi-VN')})
    </span>
  </h2>

  <div id="realtime-kpi-cards-container" class="kpi-grid-fixed">
      <div class="kpi-card-solid card-1">
          <div class="kpi-solid-header">Doanh Thu Thực <i data-feather="dollar-sign"></i></div>
          <div class="kpi-solid-value">{formatters.formatNumber((supermarketReport.doanhThu || 0) / 1000000, 1)}</div>
          <div class="kpi-solid-sub">
              <span>% HT: {formatters.formatPercentage(pctDTT)}</span>
              <span>MT: {formatters.formatNumber(goals?.doanhThuThuc || 0)}</span>
          </div>
          <div class="kpi-bg-icon"><i data-feather="dollar-sign"></i></div>
      </div>

      <div class="kpi-card-solid card-2">
          <div class="kpi-solid-header">DT Quy Đổi <i data-feather="refresh-cw"></i></div>
          <div class="kpi-solid-value">{formatters.formatNumber((supermarketReport.doanhThuQuyDoi || 0) / 1000000, 1)}</div>
          <div class="kpi-solid-sub">
              <span>% HT: {formatters.formatPercentage(pctDTQD)}</span>
              <span>MT: {formatters.formatNumber(goals?.doanhThuQD || 0)}</span>
          </div>
          <div class="kpi-bg-icon"><i data-feather="refresh-cw"></i></div>
      </div>

      <div class="kpi-card-solid card-3">
          <div class="kpi-solid-header">Tỷ lệ Quy Đổi <i data-feather="trending-up"></i></div>
          <div class="kpi-solid-value">{formatters.formatPercentage(supermarketReport.hieuQuaQuyDoi || 0)}</div>
          <div class="kpi-solid-sub">
              <span>Mục tiêu: {formatters.formatNumber(goals?.phanTramQD || 0)}%</span>
          </div>
          <div class="kpi-bg-icon"><i data-feather="trending-up"></i></div>
      </div>

      <div class="kpi-card-solid card-4">
          <div class="kpi-solid-header">Trả Chậm <i data-feather="credit-card"></i></div>
          <div class="kpi-solid-value">{formatters.formatPercentage(supermarketReport.tyLeTraCham || 0)}</div>
          <div class="kpi-solid-sub">
              <span>Doanh số: {formatters.formatNumber((supermarketReport.doanhThuTraGop || 0) / 1000000, 1)}</span>
          </div>
          <div class="kpi-bg-icon"><i data-feather="credit-card"></i></div>
      </div>
  </div>

  <div class="luyke-tier-1-grid">
      <EfficiencyTable 
          supermarketData={supermarketReport} 
          dynamicItems={combinedEfficiencyItems} 
          items={[]} 
          goals={goals}
          on:delete={handleDeleteMetric}
      />
      <QdcTable items={qdcItems} />
  </div>

  <div>
      <CategoryTable 
          items={categoryItems} 
          unexportedItems={unexportedItems}
          rawSource={rawSourceData}
      />
  </div>

</div>
--- END FILE: ./src/components/realtime/summary/SummaryTab.svelte ---

--- START FILE: ./src/components/realtime/summary/UnexportedTable.svelte ---
<script>
  import { formatters } from '../../../utils/formatters.js';
  import SortableTh from '../../common/SortableTh.svelte';

  export let items = [];

  // State sắp xếp
  let sortKey = 'doanhThuQuyDoi';
  let sortDirection = 'desc';

  function handleSort(event) {
    const key = event.detail;
    if (sortKey === key) {
      sortDirection = sortDirection === 'desc' ? 'asc' : 'desc';
    } else {
      sortKey = key;
      sortDirection = 'desc';
    }
  }

  $: sortedItems = [...items].sort((a, b) => {
    let valA = a[sortKey] || 0;
    let valB = b[sortKey] || 0;

    if (sortKey === 'nganhHang') {
        valA = a.nganhHang || '';
        valB = b.nganhHang || '';
        return sortDirection === 'asc' ? valA.localeCompare(valB) : valB.localeCompare(valA);
    }

    return sortDirection === 'asc' ? valA - valB : valB - valA;
  });
</script>

<div class="bg-white rounded-xl shadow-md p-4 border border-gray-200 h-full flex flex-col">
  <h3 class="text-lg font-bold text-gray-700 mb-4 uppercase border-b pb-2 bg-red-50 p-2 rounded">Doanh thu chưa xuất</h3>

  {#if items.length === 0}
    <div class="flex-grow flex items-center justify-center">
       <p class="text-gray-500 font-bold p-4 text-center">Không có đơn hàng nào chưa xuất trong ngày.</p>
    </div>
  {:else}
    <div class="overflow-x-auto flex-grow max-h-[400px]">
      <table class="min-w-full text-sm table-bordered table-striped">
        <thead class="text-xs text-slate-800 uppercase bg-slate-200 font-bold sticky top-0 z-10 shadow-sm">
          <tr>
            <SortableTh key="nganhHang" label="Ngành hàng" {sortKey} {sortDirection} on:sort={handleSort} />
            <SortableTh key="soLuong" label="SL" align="right" {sortKey} {sortDirection} on:sort={handleSort} />
            <SortableTh key="doanhThuThuc" label="DT Thực" align="right" {sortKey} {sortDirection} on:sort={handleSort} />
            <SortableTh key="doanhThuQuyDoi" label="DTQĐ (Tr)" align="right" {sortKey} {sortDirection} on:sort={handleSort} />
          </tr>
        </thead>
        <tbody>
          {#each sortedItems as item (item.nganhHang)}
            <tr class="hover:bg-gray-50">
              <td class="px-4 py-2 font-medium">{item.nganhHang}</td>
              <td class="px-4 py-2 text-right font-bold">{formatters.formatNumber(item.soLuong)}</td>
              <td class="px-4 py-2 text-right font-bold">{formatters.formatRevenue(item.doanhThuThuc)}</td>
              <td class="px-4 py-2 text-right font-bold text-blue-600">{formatters.formatRevenue(item.doanhThuQuyDoi)}</td>
            </tr>
          {/each}
        </tbody>
      </table>
    </div>
  {/if}
</div>
--- END FILE: ./src/components/realtime/summary/UnexportedTable.svelte ---

--- START FILE: ./src/global.d.ts ---
// Version 1.1 - Add XLSX declaration
// File này dùng để khai báo các thư viện toàn cục (từ CDN)
// cho trình biên dịch TypeScript/JavaScript của VSCode.

// Định nghĩa sự tồn tại của 'feather' trên 'window'
interface Window {
  feather: {
    replace: (options?: object) => void;
  };
}

// Định nghĩa sự tồn tại của 'feather' như một biến toàn cục
// (Dùng 'any' để đơn giản hóa, vì chúng ta chỉ dùng .replace())
declare var feather: any;

// <-- THÊM MỚI (V1.1) -->
// Định nghĩa sự tồn tại của 'XLSX' (thư viện SheetJS)
declare var XLSX: any;
--- END FILE: ./src/global.d.ts ---

--- START FILE: ./src/main.js ---
// src/main.js
// Version 5.1 - Fix Crash & Feather Fallback
import './app.css'
import App from './App.svelte'
import { mount } from 'svelte'
import { firebaseService } from './services/firebase.service.js';
import feather from 'feather-icons';
import './services/employeeService.js'; 
import { authService as auth } from './services/auth.service.js'; 
import { dataService } from './services/dataService.js'; 
import { analyticsService } from './services/analytics.service.js';

async function initializeApp() {
  try {
    // 1. Khởi tạo Firebase
    firebaseService.initCore();
    
    // 2. Setup Feather Icons (Global)
    window.feather = feather;

    // 3. Mount App
    mount(App, {
        target: document.getElementById('app'),
    });

    // [FIX] Gọi replace ngay sau khi mount để đảm bảo icon lần đầu
    setTimeout(() => {
        if (window.feather) window.feather.replace();
    }, 100);

    // 4. Bắt đầu luồng dữ liệu
    startDataFlow();

  } catch (e) {
    console.error("Lỗi khởi tạo:", e);
    // [FIX] Fallback nếu crash: Ít nhất cũng hiển thị thông báo lỗi đẹp
    document.getElementById('app').innerHTML = `<div style="padding: 20px; color: red;"><h3>Hệ thống gặp sự cố khởi động.</h3><p>${e.message}</p><button onclick="location.reload()">Tải lại trang</button></div>`;
  }
}

async function startDataFlow() {
    try {
        await auth.ensureAnonymousAuth();
        const isLoggedIn = auth.initAuth();
        
        if (isLoggedIn) {
            console.log("[Main] User logged in. Starting data load sequence...");
            await dataService.loadAllFromCache();
            
            const email = localStorage.getItem('userEmail');
            if(email) analyticsService.upsertUserRecord(email);
        } else {
            console.log("[Main] User not logged in (waiting for LoginModal). Data load deferred.");
        }

    } catch (e) {
        console.error("Lỗi luồng dữ liệu:", e);
    }
}

initializeApp();
--- END FILE: ./src/main.js ---

--- START FILE: ./src/services.js ---
// MODULE: SERVICES FACADE
// File này đóng vai trò điều phối, nhập khẩu các module logic con và export chúng ra ngoài.

// Không import config, appState, ui, utils ở đây để tránh vòng lặp
// Các service con sẽ tự import những thứ chúng cần từ 'stores.js'

import { dataProcessing } from './services/dataProcessing.js'; 
import { reportService } from './services/reportService.js';
import { composerService } from './services/composerService.js';

// Gộp tất cả vào object services
export const services = {
    ...dataProcessing,
    ...reportService,
    ...composerService
};
--- END FILE: ./src/services.js ---

--- START FILE: ./src/services/action.service.js ---
import { get } from 'svelte/store';
import { viewingDetailFor, notificationStore } from '../stores.js';
import { captureService } from './capture.service.js';
import { excelService } from './excel.service.js';

export const actionService = {
    _getActiveTabInfo(sectionId) {
        const navIdMap = {
            'luyke': 'luyke-subtabs-nav',
            'sknv': 'employee-subtabs-nav',
            'realtime': 'realtime-subtabs-nav'
        };
        const contentIdMap = {
            'luyke': 'luyke-subtabs-content',
            'sknv': 'employee-subtabs-content',
            'realtime': 'realtime-subtabs-content'
        };

        const navId = navIdMap[sectionId];
        const contentContainerId = contentIdMap[sectionId];

        if (!navId || !contentContainerId) {
            console.error(`[ActionService] Invalid sectionId: ${sectionId}`);
            return null;
        }

        const navEl = document.getElementById(navId);
        if (!navEl) {
            console.error(`[ActionService] Nav element not found: ${navId}`);
            return null;
        }

        const activeBtn = navEl.querySelector('.sub-tab-btn.active'); 
        
        if (!activeBtn) {
            console.warn(`[ActionService] No active button found in ${navId}`);
            return null;
        }

        return {
            button: activeBtn,
            targetId: activeBtn.dataset.target,
            title: activeBtn.dataset.title || 'BaoCao',
            contentContainerId: contentContainerId
        };
    },

    handleCapture(sectionId) {
        // [FIX] Thêm log để debug
        console.log(`[ActionService] Trigger capture for: ${sectionId}`);
        
        const tabInfo = this._getActiveTabInfo(sectionId);
        if (!tabInfo) {
            alert('Lỗi: Không xác định được tab hiện tại. Vui lòng tải lại trang.');
            return;
        }

        const $viewingDetailFor = get(viewingDetailFor);
        
        // --- LOGIC CHỤP CHI TIẾT (Detail View) ---
        if (sectionId === 'sknv' && $viewingDetailFor) {
            const { employeeId, sourceTab } = $viewingDetailFor;
            const activeTabTarget = tabInfo.targetId;

            let elementToCapture = null;
            let title = '';
            const preset = 'preset-mobile-portrait';

            if (sourceTab === 'sknv' && activeTabTarget === 'subtab-sknv') {
                 elementToCapture = document.getElementById('sknv-detail-capture-area');
                title = `SKNV_ChiTiet_${employeeId}`;
            } else if (sourceTab === 'dtnv-lk' && activeTabTarget === 'subtab-doanhthu-lk') {
                elementToCapture = document.getElementById('dtnv-lk-capture-area');
                title = `DTLK_ChiTiet_${employeeId}`;
            } else if (sourceTab === 'sknv-thidua-pasted' && activeTabTarget === 'subtab-hieu-qua-thi-dua-lk') {
                elementToCapture = document.getElementById('sknv-thidua-detail-capture-area');
                title = `ThiDuaLK_ChiTiet_${employeeId}`;
            } else if (sourceTab === 'dtnv-rt' && activeTabTarget === 'subtab-realtime-nhan-vien') {
                 elementToCapture = document.getElementById('dtnv-rt-capture-area');
                 title = `DTRT_ChiTiet_${employeeId}`;
            }

            if (elementToCapture) {
                if (elementToCapture.children.length === 0) {
                   alert('Không có nội dung chi tiết để chụp.');
                    return;
                }
                captureService.captureAndDownload(elementToCapture, title, preset);
                return;
            }
        }

        // --- LOGIC CHỤP TỔNG QUÁT (Summary View) ---
        let elementToCapture;
        
        // Xử lý đặc biệt cho tab Thi đua vùng (nơi dùng infographic riêng)
        if (sectionId === 'luyke' && tabInfo.targetId === 'subtab-luyke-thidua-vung') {
            elementToCapture = document.getElementById('thidua-vung-infographic-container');
        } 
        // Xử lý đặc biệt cho Thi đua Lũy kế (View Chương trình vs Nhân viên)
        else if (sectionId === 'luyke' && tabInfo.targetId === 'subtab-luyke-thi-dua') {
             elementToCapture = document.getElementById('luyke-competition-content');
        }
        else if (sectionId === 'sknv' && tabInfo.targetId === 'subtab-thidua') {
             const activeViewBtn = document.querySelector('#sknv-thidua-view-selector .view-switcher__btn.active');
             const viewType = activeViewBtn ? activeViewBtn.dataset.view : 'program';
             if (viewType === 'program') {
                 elementToCapture = document.getElementById('competition-report-container-lk');
             } else { 
                 elementToCapture = document.getElementById('pasted-competition-report-container');
             }
        }
        else {
            // Mặc định: Tìm content div đang hiển thị
            elementToCapture = document.querySelector(`#${tabInfo.contentContainerId} .sub-tab-content:not(.hidden)`);
        }

        if (!elementToCapture || elementToCapture.children.length === 0) {
            console.error('Capture target is empty or null', elementToCapture);
            alert('Lỗi: Không tìm thấy nội dung để chụp trong tab này.');
            return;
        }

        captureService.captureDashboardInParts(elementToCapture, tabInfo.title);
    },

    handleExport(sectionId) {
        const tabInfo = this._getActiveTabInfo(sectionId);
        if (!tabInfo) {
            alert('Lỗi: Không tìm thấy tab đang hoạt động.');
            return;
        }

        let activeTabContent;

        if (sectionId === 'sknv' && tabInfo.targetId === 'subtab-thidua') {
            const activeViewBtn = document.querySelector('#sknv-thidua-view-selector .view-switcher__btn.active');
            const viewType = activeViewBtn ? activeViewBtn.dataset.view : 'program';

            if (viewType === 'program') {
                activeTabContent = document.getElementById('competition-report-container-lk');
            } else { 
                activeTabContent = document.getElementById('pasted-competition-report-container');
            }
        } 
        else {
            activeTabContent = document.querySelector(`#${tabInfo.contentContainerId} .sub-tab-content:not(.hidden)`);
        }

        if (activeTabContent) {
            const timestamp = new Date().toLocaleDateString('vi-VN').replace(/\//g, '-');
            excelService.exportTableToExcel(activeTabContent, `${tabInfo.title}_${timestamp}`);
        } else {
             alert('Không tìm thấy nội dung để xuất Excel.');
        }
    }
};
--- END FILE: ./src/services/action.service.js ---

--- START FILE: ./src/services/admin.service.js ---
// src/services/admin.service.js
// Version 3.3 - Add System Performance Tables Support
import { get } from 'svelte/store';
import { doc, setDoc, getDoc, serverTimestamp } from "firebase/firestore";
import { 
    firebaseStore, 
    isAdmin, 
    homeConfig, 
    macroCategoryConfig, 
    macroProductGroupConfig, 
    categoryNameMapping, 
    groupNameMapping,
    brandNameMapping,
    categoryStructure, 
    brandList,
    efficiencyConfig,
    qdcConfigStore,
    competitionNameMappings,
    // [NEW]
    customPerformanceTables
} from '../stores.js';

const getDB = () => {
    const fb = get(firebaseStore);
    if (!fb.db) {
        console.warn("Firestore chưa được khởi tạo.");
        return null;
    }
    return fb.db;
};

const notify = (msg, type='info') => {
    console.log(`[${type.toUpperCase()}] ${msg}`);
    if(type === 'success' || type === 'error') alert(msg);
};

const sanitizeForFirestore = (obj) => {
    return JSON.parse(JSON.stringify(obj, (key, value) => {
        return value === undefined ? null : value;
    }));
};

export const adminService = {
    // --- 1. HELP CONTENT ---
    async saveHelpContent(contents) {
        const db = getDB();
        if (!db) { notify("Lỗi kết nối CSDL!", "error"); return; }
        if (!get(isAdmin)) { notify("Bạn cần quyền Admin để thực hiện thao tác này!", "error"); return; }
        try {
            await Promise.all([
                setDoc(doc(db, "help_content", "data"), { content: contents.data }),
                setDoc(doc(db, "help_content", "luyke"), { content: contents.luyke }),
                setDoc(doc(db, "help_content", "sknv"), { content: contents.sknv }),
                setDoc(doc(db, "help_content", "realtime"), { content: contents.realtime })
            ]);
            notify('Đã cập nhật nội dung hướng dẫn thành công!', 'success');
        } catch (error) { 
            console.error("Error saving help content:", error); 
            notify('Lỗi khi lưu nội dung hướng dẫn.', 'error'); 
        }
    },

    // --- 2. HOME CONFIG ---
    async saveHomeConfig(configData) {
        const db = getDB();
        if (!db) { notify("Lỗi kết nối CSDL!", "error"); return; }
        if (!get(isAdmin)) { notify("Bạn cần quyền Admin!", "error"); return; }
        try {
            const docRef = doc(db, "declarations", "homeConfig");
            await setDoc(docRef, { data: sanitizeForFirestore(configData) });
            homeConfig.set(configData);
            notify('Đã lưu cấu hình Trang chủ thành công!', 'success');
        } catch (error) { 
            console.error("Error saving home config:", error); 
            notify('Lỗi khi lưu cấu hình trang chủ: ' + error.message, 'error'); 
        }
    },

    async loadHomeConfig() {
        const db = getDB();
        if (!db) return;
        try {
            const docRef = doc(db, "declarations", "homeConfig");
            const docSnap = await getDoc(docRef);
            if (docSnap.exists()) {
                const raw = docSnap.data();
                const data = raw.data || raw.config || raw;
                if (data) homeConfig.set(data);
            }
        } catch (error) { console.error("Error loading home config:", error); }
    },

    // --- 3. CATEGORY & BRAND STRUCTURE ---
    async saveCategoryDataToFirestore(data) {
        const db = getDB();
        if (!db) { notify("Lỗi kết nối CSDL!", "error"); return; }
        if (!get(isAdmin)) { notify("Bạn cần quyền Admin!", "error"); return; }
        try {
            const categoryRef = doc(db, "declarations", "categoryStructure");
            await setDoc(categoryRef, { data: sanitizeForFirestore(data.categories || []) });
            const brandRef = doc(db, "declarations", "brandList");
            await setDoc(brandRef, { data: sanitizeForFirestore(data.brands || []) });
            notify('Đồng bộ dữ liệu khai báo thành công!', 'success');
        } catch (error) { 
            console.error("Error saving category data:", error); 
            notify('Lỗi khi đồng bộ dữ liệu lên cloud.', 'error'); 
        }
    },

    async loadCategoryDataFromFirestore() {
        const db = getDB();
        if (!db) return { categories: [], brands: [] };
        await this.loadMappingsGlobal();
        try {
            const catRef = doc(db, "declarations", "categoryStructure");
            const brandRef = doc(db, "declarations", "brandList");
            const [catSnap, brandSnap] = await Promise.all([getDoc(catRef), getDoc(brandRef)]);
            const getArray = (snap) => {
                if (!snap.exists()) return [];
                const d = snap.data();
                return d.data || d.items || d.list || [];
            };
            const categories = getArray(catSnap);
            const brands = getArray(brandSnap);
            categoryStructure.set(categories);
            brandList.set(brands);
            return { categories, brands };
        } catch (error) {
            console.error("Error loading category data:", error);
            return { categories: [], brands: [] };
        }
    },

    // --- 4. SYSTEM REVENUE TABLES (BẢNG DOANH THU) ---
    async loadSystemRevenueTables() {
        const db = getDB();
        if (!db) return [];
        try {
            const docRef = doc(db, "declarations", "systemRevenueTables");
            const docSnap = await getDoc(docRef);
            if (docSnap.exists()) {
                const d = docSnap.data();
                const tables = d.tables || d.data || d.items || [];
                console.log(`[AdminService] Loaded ${tables.length} system revenue tables.`);
                return tables;
            }
            return [];
        } catch (e) {
            console.error("Lỗi tải bảng hệ thống:", e);
            return [];
        }
    },

    async saveSystemRevenueTables(tables) {
        const db = getDB();
        if (!db) { notify("Lỗi kết nối CSDL!", "error"); return; }
        if (!get(isAdmin)) { notify("Bạn cần quyền Admin!", "error"); return; }
        const systemTables = tables.filter(t => t.isSystem).map(t => sanitizeForFirestore(t));
        try {
            const docRef = doc(db, "declarations", "systemRevenueTables");
            await setDoc(docRef, { 
                tables: systemTables,
                updatedAt: serverTimestamp() 
            });
            notify(`Đã lưu ${systemTables.length} bảng doanh thu hệ thống lên Cloud!`, 'success');
        } catch (error) { 
            console.error("Firebase Error Full:", error); 
            notify('Lỗi lưu bảng hệ thống: ' + error.message, 'error'); 
        }
    },

    // --- [NEW] 4.5. SYSTEM PERFORMANCE TABLES (BẢNG HIỆU QUẢ) ---
    async loadSystemPerformanceTables() {
        const db = getDB();
        if (!db) return [];
        try {
            const docRef = doc(db, "declarations", "systemPerformanceTables");
            const docSnap = await getDoc(docRef);
            if (docSnap.exists()) {
                const d = docSnap.data();
                // Ưu tiên 'tables', fallback 'data'
                const tables = d.tables || d.data || [];
                console.log(`[AdminService] Loaded ${tables.length} system performance tables.`);
                return tables;
            }
            return [];
        } catch (e) {
            console.error("Lỗi tải bảng hiệu quả hệ thống:", e);
            return [];
        }
    },

    async saveSystemPerformanceTables(tables) {
        const db = getDB();
        if (!db) { notify("Lỗi kết nối CSDL!", "error"); return; }
        if (!get(isAdmin)) { notify("Bạn cần quyền Admin!", "error"); return; }
        
        // Chỉ lưu bảng có cờ isSystem = true
        const systemTables = tables.filter(t => t.isSystem).map(t => sanitizeForFirestore(t));
        
        try {
            const docRef = doc(db, "declarations", "systemPerformanceTables");
            await setDoc(docRef, { 
                tables: systemTables,
                updatedAt: serverTimestamp() 
            });
            notify(`Đã lưu ${systemTables.length} bảng hiệu quả hệ thống lên Cloud!`, 'success');
        } catch (error) { 
            console.error("Lỗi lưu bảng hiệu quả hệ thống:", error); 
            notify('Lỗi lưu bảng hiệu quả hệ thống: ' + error.message, 'error'); 
        }
    },

    // --- 5. MAPPINGS & CONFIGS GLOBAL ---
    async loadMappingsGlobal() {
        const db = getDB();
        if (!db) return;
        try {
            console.log("[admin.service] Đang tải cấu hình Mapping từ Cloud...");
            const safeGet = (docSnap, defaultVal = []) => {
                if (!docSnap.exists()) return defaultVal;
                const d = docSnap.data();
                return d.data || d.items || d.mappings || d.configs || d.list || defaultVal;
            };

            const docsToLoad = [
                "macroCategoryConfig", 
                "macroProductGroupConfig", 
                "categoryNameMapping", 
                "groupNameMapping", 
                "brandNameMapping",
                "efficiencyConfig", 
                "qdcConfig",
                "competitionNameMappings"
            ];
            const promises = docsToLoad.map(id => getDoc(doc(db, "declarations", id)));
            const results = await Promise.all(promises);
            
            macroCategoryConfig.set(safeGet(results[0]));
            macroProductGroupConfig.set(safeGet(results[1]));
            categoryNameMapping.set(safeGet(results[2], {}));
            groupNameMapping.set(safeGet(results[3], {}));
            brandNameMapping.set(safeGet(results[4], {}));
            efficiencyConfig.set(safeGet(results[5])); 
            qdcConfigStore.set(safeGet(results[6]));
            competitionNameMappings.set(safeGet(results[7], {}));

            console.log("[admin.service] Đã tải xong Mapping & Configs.");
        } catch (error) {
            console.error("Error loading mappings:", error);
        }
    },

    async saveMacroCategoryConfig(data) {
        const db = getDB();
        if (!db) { notify("Lỗi kết nối CSDL!", "error"); return; }
        if (!get(isAdmin)) { notify("Bạn cần quyền Admin!", "error"); return; }
        try {
            const docRef = doc(db, "declarations", "macroCategoryConfig");
            await setDoc(docRef, { data: sanitizeForFirestore(data) });
            notify('Đã lưu Cấu hình Nhóm Ngành Hàng lớn!', 'success');
        } catch (error) { console.error(error); notify('Lỗi lưu cấu hình: ' + error.message, 'error'); }
    },

    async loadMacroCategoryConfig() {
        const db = getDB();
        const defaultData = [
            { id: 'macro_dt', name: 'ĐIỆN TỬ', items: ['dt_tivi', 'dt_loa', 'Tivi', 'Loa', 'Dàn âm thanh', 'Tivi - Loa - Dàn máy'] },
            { id: 'macro_dl', name: 'ĐIỆN LẠNH', items: ['dl_maylanh', 'dl_tulanh', 'dl_maygiat', 'Tủ lạnh', 'Máy lạnh', 'Máy giặt', 'Tủ đông', 'Tủ mát'] },
            { id: 'macro_gd', name: 'GIA DỤNG', items: ['gd_quat', 'gd_noi', 'Gia dụng', 'Quạt', 'Nồi cơm', 'Bếp', 'Máy xay', 'Máy ép'] },
            { id: 'macro_ict', name: 'ICT', items: ['ict_laptop', 'ict_phone', 'Laptop', 'Điện thoại', 'Tablet', 'Phụ kiện', 'Máy tính bảng'] }
        ];

        if (!db) return defaultData;
        try {
            const docRef = doc(db, "declarations", "macroCategoryConfig");
            const docSnap = await getDoc(docRef);
            if (docSnap.exists()) {
                const d = docSnap.data();
                const data = d.data || d.items || d.config || [];
                if (data.length > 0) return data;
            }
            return defaultData;
        } catch (e) {
            console.error("Lỗi tải macroCategoryConfig:", e);
            return defaultData;
        }
    },

    async saveMacroProductGroupConfig(data) {
        const db = getDB();
        if (!db) { notify("Lỗi kết nối CSDL!", "error"); return; }
        if (!get(isAdmin)) { notify("Bạn cần quyền Admin!", "error"); return; }
        try {
            const docRef = doc(db, "declarations", "macroProductGroupConfig");
            await setDoc(docRef, { data: sanitizeForFirestore(data) });
            notify('Đã lưu Cấu hình Nhóm Hàng Lớn!', 'success');
        } catch (error) { console.error(error); notify('Lỗi lưu cấu hình: ' + error.message, 'error'); }
    },

    // [MỚI] Thêm hàm này để fix lỗi thiếu function
    async loadMacroProductGroupConfig() {
        const db = getDB();
        const defaultData = [];

        if (!db) return defaultData;
        try {
            const docRef = doc(db, "declarations", "macroProductGroupConfig");
            const docSnap = await getDoc(docRef);
            if (docSnap.exists()) {
                const d = docSnap.data();
                const data = d.data || d.items || d.config || [];
                if (data.length > 0) return data;
            }
            return defaultData;
        } catch (e) {
            console.error("Lỗi tải macroProductGroupConfig:", e);
            return defaultData;
        }
    },

    async saveNameMapping(type, data) {
        const db = getDB();
        if (!db) { notify("Lỗi kết nối CSDL!", "error"); return; }
        if (!get(isAdmin)) { notify("Bạn cần quyền Admin!", "error"); return; }
        let docId = '';
        if (type === 'category') docId = 'categoryNameMapping';
        else if (type === 'group') docId = 'groupNameMapping';
        else if (type === 'brand') docId = 'brandNameMapping';
        try {
            const docRef = doc(db, "declarations", docId);
            await setDoc(docRef, { data: sanitizeForFirestore(data) });
            notify(`Đã lưu Mapping tên ${type}!`, 'success');
        } catch (error) { console.error(error); notify('Lỗi lưu mapping: ' + error.message, 'error'); }
    },

    async saveCompetitionNameMappings(mappings) {
        const db = getDB();
        if (!db) { notify("Lỗi kết nối CSDL!", "error"); return; }
        if (!get(isAdmin)) { notify("Bạn cần quyền Admin!", "error"); return; }
        try {
            const docRef = doc(db, "declarations", "competitionNameMappings");
            await setDoc(docRef, { mappings: sanitizeForFirestore(mappings) });
            notify('Đã lưu Bảng Ánh Xạ Tên Thi Đua thành công!', 'success');
        } catch (error) {
            console.error("Lỗi khi lưu Bảng Ánh Xạ Tên Thi Đua:", error);
            notify('Lỗi khi lưu tên rút gọn lên cloud.', 'error');
        }
    },

    // --- 6. LOGIC & CALCULATION ---
    async loadDeclarationsFromFirestore() {
        const db = getDB();
        if (!db) return {}; 
        try {
            const declarationIds = ['hinhThucXuat', 'hinhThucXuatGop', 'heSoQuyDoi'];
            const declarations = {};
            await Promise.all(declarationIds.map(async (id) => {
                const docRef = doc(db, "declarations", id);
                const docSnap = await getDoc(docRef);
                declarations[id] = docSnap.exists() ? (docSnap.data().content || '') : '';
            }));
            return declarations;
        } catch (error) { console.error("Error loading declarations:", error); return {}; }
    },

    async saveDeclarationsToFirestore(declarations) {
        const db = getDB();
        if (!db) { notify("Lỗi kết nối CSDL!", "error"); return; }
        if (!get(isAdmin)) { notify("Bạn cần quyền Admin!", "error"); return; }
        try {
            await Promise.all([
                setDoc(doc(db, "declarations", "hinhThucXuat"), { content: declarations.ycx }),
                setDoc(doc(db, "declarations", "hinhThucXuatGop"), { content: declarations.ycxGop }),
                setDoc(doc(db, "declarations", "heSoQuyDoi"), { content: declarations.heSo })
            ]);
            notify('Đồng bộ khai báo tính toán thành công!', 'success');
        } catch (error) { console.error("Error saving declarations:", error); notify('Lỗi khi đồng bộ khai báo tính toán.', 'error'); }
    },

    // --- 7. COMPETITION CONFIGS ---
    async saveGlobalCompetitionConfigs(configs) {
        const db = getDB();
        if (!db) { notify("Lỗi kết nối CSDL!", "error"); return; }
        if (!get(isAdmin)) { notify("Bạn cần quyền Admin!", "error"); return; }
        try {
            const docRef = doc(db, "declarations", "globalCompetitionConfigs");
            await setDoc(docRef, { configs: sanitizeForFirestore(configs) });
        } catch (error) { console.error("Error saving global comps:", error); }
    },

    async loadGlobalCompetitionConfigs() {
        const db = getDB();
        if (!db) return [];
        try {
            const docRef = doc(db, "declarations", "globalCompetitionConfigs");
            const docSnap = await getDoc(docRef);
            if (docSnap.exists()) {
                const d = docSnap.data();
                return d.configs || d.data || [];
            }
            return [];
        } catch (error) { return []; }
    },

    // --- 8. SPECIAL PRODUCTS ---
    async saveSpecialProductList(products) {
        const db = getDB();
        if (!db) { notify("Lỗi kết nối CSDL!", "error"); return; }
        if (!get(isAdmin)) { notify("Bạn cần quyền Admin!", "error"); return; }
        try {
            const docRef = doc(db, "declarations", "specialProductList");
            await setDoc(docRef, { products: sanitizeForFirestore(products) });
            notify('Đã lưu Danh sách SPĐQ thành công!', 'success');
        } catch (error) { console.error("Error saving special product list:", error); notify('Lỗi khi lưu danh sách SPĐQ.', 'error'); }
    },

    async loadSpecialProductList() {
        const db = getDB();
        if (!db) return [];
        try {
            const docRef = doc(db, "declarations", "specialProductList");
            const docSnap = await getDoc(docRef);
            if (docSnap.exists()) {
                const d = docSnap.data();
                return d.products || d.data || [];
            }
            return [];
        } catch (error) { console.error("Error loading SPĐQ:", error); return []; }
    },

    async loadGlobalSpecialPrograms() {
        const db = getDB();
        if (!db) return [];
        try {
            const docRef = doc(db, "declarations", "globalSpecialPrograms");
            const docSnap = await getDoc(docRef);
            if (docSnap.exists()) {
                const d = docSnap.data();
                return d.programs || d.configs || d.data || [];
            }
            return [];
        } catch (error) { return []; }
    },

    // --- 9. EFFICIENCY & QDC CONFIGS ---
    async saveEfficiencyConfig(config) {
        const db = getDB();
        if (!db) { notify("Lỗi kết nối CSDL!", "error"); return; }
        if (!get(isAdmin)) { notify("Bạn cần quyền Admin!", "error"); return; }
        
        try {
            const docRef = doc(db, "declarations", "efficiencyConfig");
            await setDoc(docRef, { 
                data: sanitizeForFirestore(config),
                updatedAt: serverTimestamp() 
            });
            efficiencyConfig.set(config);
            notify('Đã lưu cấu hình Bảng Hiệu quả hệ thống!', 'success');
        } catch (e) { 
            console.error(e); 
            notify('Lỗi lưu config: ' + e.message, 'error'); 
        }
    },

    async loadEfficiencyConfig() {
        const db = getDB();
        if (!db) return [];
        try {
            const docRef = doc(db, "declarations", "efficiencyConfig");
            const docSnap = await getDoc(docRef);
            if (docSnap.exists()) {
                const d = docSnap.data();
                const data = d.data || d.items || d.config || [];
                console.log(`[AdminService] Loaded efficiency config: ${data.length} items`);
                return data;
            }
            return [];
        } catch (e) { 
            console.error("Lỗi tải efficiency config:", e);
            return []; 
        }
    },
    
    async saveQdcConfig(selectedGroups) {
         const db = getDB();
        if (!db || !get(isAdmin)) return;
        try {
            const docRef = doc(db, "declarations", "qdcConfig");
            await setDoc(docRef, { data: sanitizeForFirestore(selectedGroups) });
            qdcConfigStore.set(selectedGroups);
        } catch (e) { console.error(e); }
    },
    
    async loadQdcConfig() {
        const db = getDB();
        if (!db) return [];
        try {
            const docRef = doc(db, "declarations", "qdcConfig");
            const docSnap = await getDoc(docRef);
            if (docSnap.exists()) {
                const d = docSnap.data();
                return d.data || d.config || d.items || [];
            }
            return [];
        } catch (e) { return []; }
    }
};
--- END FILE: ./src/services/admin.service.js ---

--- START FILE: ./src/services/analytics.service.js ---
// src/services/analytics.service.js
// Version 2.2 - Full code implementation (Added getSystemStats & trackAction)
import { get } from 'svelte/store';
import { collection, getDocs, doc, setDoc, serverTimestamp, increment } from "firebase/firestore";
import { firebaseStore, isAdmin, currentUser } from '../stores.js';

const getDB = () => {
    const fb = get(firebaseStore);
    return fb.db;
};

export const analyticsService = {
    // Lấy danh sách toàn bộ user để tính toán thống kê
    async getAllUsers() {
        const db = getDB();
        // Không yêu cầu quyền Admin ở đây để Home có thể hiển thị số liệu chung
        if (!db) return [];

        try {
            const usersCollection = collection(db, "users");
            const querySnapshot = await getDocs(usersCollection);
            const users = [];
            
            querySnapshot.forEach((doc) => {
                const data = doc.data();
                users.push({
                    email: data.email,
                    loginCount: data.loginCount || 0,
                    lastLogin: data.lastLogin ? data.lastLogin.toDate() : null,
                    actionsTaken: data.actionsTaken || 0
                });
            });
            return users;
        } catch (error) {
            console.error("Lỗi khi lấy danh sách user:", error);
            return [];
        }
    },

    // Cập nhật thông tin user khi đăng nhập
    async upsertUserRecord(email) {
        const db = getDB();
        if (!db || !email) return;

        const userRef = doc(db, "users", email);
        try {
            await setDoc(userRef, {
                email: email,
                lastLogin: serverTimestamp(),
                loginCount: increment(1)
            }, { merge: true });
        } catch (error) {
            console.error("Lỗi cập nhật user record:", error);
        }
    },

    // Hàm tăng counter thủ công (Giữ lại để tương thích ngược nếu cần)
    async incrementCounter(fieldName, email = null) {
        const db = getDB();
        if (!db || !fieldName) return;

        if (!email) {
            const user = get(currentUser);
            if (user) email = user.email;
        }

        let docRef;
        const dataToUpdate = { [fieldName]: increment(1) };

        if (fieldName === 'actionsTaken' && email) {
            docRef = doc(db, "users", email);
        } else {
            docRef = doc(db, "analytics", "site_stats");
        }

        try {
            await setDoc(docRef, dataToUpdate, { merge: true });
        } catch (error) {
            console.error(`Lỗi tăng counter ${fieldName}:`, error);
        }
    },

    // [MỚI] Hàm lấy tổng hợp số liệu toàn hệ thống
    async getSystemStats() {
        const users = await this.getAllUsers();
        
        const stats = users.reduce((acc, user) => {
            acc.totalUsers += 1; // Mỗi user là 1 người dùng
            acc.totalVisits += (user.loginCount || 0); // Tổng số lần đăng nhập
            acc.totalActions += (user.actionsTaken || 0); // Tổng số lần upload/paste
            return acc;
        }, { totalUsers: 0, totalVisits: 0, totalActions: 0 });

        return stats;
    },

    // [MỚI] Hàm ghi nhận hành động (dùng cho upload/paste)
    async trackAction() {
        const user = get(currentUser);
        if (!user || !user.email) return; // Chỉ tính khi đã đăng nhập
        
        const db = getDB();
        if (!db) return;

        const userRef = doc(db, "users", user.email);
        try {
            await setDoc(userRef, {
                actionsTaken: increment(1)
            }, { merge: true });
            console.log("[Analytics] Đã ghi nhận 1 lượt sử dụng.");
        } catch (error) {
            console.error("Lỗi trackAction:", error);
        }
    }
};
--- END FILE: ./src/services/analytics.service.js ---

--- START FILE: ./src/services/auth.service.js ---
// Version 2.3 - Add Anonymous Auth to fix 403 error
import { get } from 'svelte/store';
import { currentUser, isAdmin } from '../stores.js';
import { analyticsService } from './analytics.service.js';
import { config } from '../config.js';
import { getAuth, signInAnonymously, onAuthStateChanged } from "firebase/auth";

export const authService = {
    /**
     * Kiểm tra định dạng email
     * @param {string} email 
     * @returns {boolean}
     */
    isValidEmail(email) {
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        return email && emailRegex.test(email);
    },

    /**
     * [QUAN TRỌNG] Đảm bảo người dùng đã đăng nhập vào Firebase (Ẩn danh)
     * Hàm này cần được gọi ngay khi App khởi chạy để lấy token.
     * @returns {Promise<User>} Firebase User object
     */
    async ensureAnonymousAuth() {
        const auth = getAuth();
        return new Promise((resolve, reject) => {
            // Lắng nghe trạng thái xác thực
            const unsubscribe = onAuthStateChanged(auth, (user) => {
                if (user) {
                    console.log("[AuthService] Đã xác thực Firebase (Ẩn danh):", user.uid);
                    unsubscribe(); // Hủy lắng nghe sau khi đã có user
                    resolve(user);
                } else {
                    console.log("[AuthService] Chưa có user, đang đăng nhập ẩn danh...");
                    signInAnonymously(auth)
                        .catch((error) => {
                            console.error("[AuthService] Lỗi đăng nhập ẩn danh:", error);
                            reject(error);
                        });
                }
            });
        });
    },

    /**
     * Xử lý định danh người dùng qua Email (Application Layer)
     * @param {string} email 
     * @returns {Promise<boolean>} true nếu thành công
     */
    async loginUser(email) {
        const cleanEmail = email.trim();
        if (!this.isValidEmail(cleanEmail)) {
            return false;
        }

        // 1. Lưu vào LocalStorage để nhớ cho lần sau
        localStorage.setItem('userEmail', cleanEmail);

        // 2. Cập nhật Store
        currentUser.set({ email: cleanEmail });

        // 3. Gọi Analytics (Upsert user record)
        analyticsService.upsertUserRecord(cleanEmail).catch(err => {
            console.error("[AuthService] Lỗi khi ghi nhận user vào analytics:", err);
        });

        return true;
    },

    /**
     * Kiểm tra mật khẩu Admin
     * @param {string} password 
     * @returns {boolean}
     */
    checkAdminPassword(password) {
        if (!config || !config.ADMIN_PASSWORD) {
            console.error("[AuthService] Chưa cấu hình mật khẩu Admin trong config.js");
            return false;
        }
        
        if (password === config.ADMIN_PASSWORD) {
            isAdmin.set(true);
            return true;
        }
        
        return false;
    },

    /**
     * Khởi tạo: Kiểm tra xem đã có email lưu trong localStorage chưa
     * (Chỉ kiểm tra logic Email, phần Firebase Auth sẽ chạy riêng)
     */
    initAuth() {
        const savedEmail = localStorage.getItem('userEmail');
        if (savedEmail && this.isValidEmail(savedEmail)) {
            console.log(`[AuthService] Tìm thấy email đã lưu: ${savedEmail}`);
            currentUser.set({ email: savedEmail });
            // Ghi nhận phiên truy cập
            analyticsService.upsertUserRecord(savedEmail);
            return true; // Đã có email định danh
        }
        return false; // Chưa có email
    }
};
--- END FILE: ./src/services/auth.service.js ---

--- START FILE: ./src/services/capture.service.js ---
/* global Chart */
import { notificationStore, currentUser } from '../stores.js';
import { analyticsService } from './analytics.service.js';
import { get } from 'svelte/store';
// Import các hàm utils đã được sửa ở trên
import { injectCaptureStyles, swapCanvasToImage } from '../utils/capture.utils.js';

export const captureService = {
    async captureAndDownload(elementToCapture, title, presetClass = '') {
        // 1. Kiểm tra thư viện
        if (typeof window.html2canvas === 'undefined') {
            alert("Lỗi: Thư viện html2canvas chưa tải xong. Vui lòng F5 lại trang.");
            return;
        }

        const date = new Date();
        const dateString = date.toLocaleDateString('vi-VN', { day: '2-digit', month: '2-digit' });
        // Format tiêu đề chuẩn: Title - HH:MM dd/mm
        const timeString = date.toLocaleTimeString('vi-VN', { hour: '2-digit', minute: '2-digit' });
        const finalTitle = `${title.replace(/_/g, ' ')} - ${timeString} ${dateString}`;
    
        // 2. Tạo wrapper tạm thời (dùng class CSS từ utils để ẩn nó đi)
        const captureWrapper = document.createElement('div');
        captureWrapper.className = 'capture-container'; // Class này có left: -9999px
    
        // 3. Thêm tiêu đề vào ảnh
        const titleEl = document.createElement('h2');
        titleEl.className = 'capture-title';
        titleEl.textContent = finalTitle;
        captureWrapper.appendChild(titleEl);
        
        // 4. Clone nội dung
        const contentClone = elementToCapture.cloneNode(true);
        if (presetClass) { contentClone.classList.add(presetClass); }

        captureWrapper.appendChild(contentClone);
        document.body.appendChild(captureWrapper);
    
        // 5. Tắt animation của Chart.js (nếu có) để chụp không bị mờ
        if (typeof Chart !== 'undefined') {
            Chart.defaults.animation = false;
        }
        
        // 6. [QUAN TRỌNG] Chuyển đổi Canvas thành Ảnh tĩnh
        swapCanvasToImage(contentClone);

        // 7. Đợi render (Delay 200ms) - Cần thiết để browser vẽ ảnh xong
        await new Promise(resolve => setTimeout(resolve, 200));

        try {
            // 8. Chụp bằng html2canvas
            const canvas = await window.html2canvas(captureWrapper, {
                scale: 2, // Tăng chất lượng ảnh
                useCORS: true, // Cho phép ảnh từ domain khác
                backgroundColor: '#f3f4f6', // Màu nền xám nhạt
                logging: false,
                windowWidth: captureWrapper.scrollWidth,
                windowHeight: captureWrapper.scrollHeight
            });
    
            // 9. Tải xuống
            const link = document.createElement('a');
            link.download = `${title}_${dateString.replace(/\//g, '-')}.png`;
            link.href = canvas.toDataURL('image/png');
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            notificationStore.update(s => ({ ...s, visible: true, type: 'success', message: 'Đã tải ảnh xuống thành công!' }));
            setTimeout(() => notificationStore.update(s => ({ ...s, visible: false })), 3000);

        } catch (err) {
            console.error('Lỗi captureService:', err);
            alert(`Lỗi khi chụp ảnh: ${err.message}`);
        } finally {
            // 10. Dọn dẹp
            if (document.body.contains(captureWrapper)) {
                document.body.removeChild(captureWrapper);
            }
            if (typeof Chart !== 'undefined') {
                Chart.defaults.animation = {}; // Bật lại animation
            }
        }
    },
    
    async captureDashboardInParts(contentContainer, baseTitle) {
       if (!contentContainer) {
            alert('Lỗi: Không tìm thấy nội dung để chụp.');
            return;
        }

        const user = get(currentUser);
        analyticsService.incrementCounter('actionsTaken', user?.email);
        
        notificationStore.update(s => ({ ...s, visible: true, type: 'info', message: `Đang xử lý ảnh: ${baseTitle}...` }));
    
        // Gom nhóm các phần tử cần chụp (data-capture-group)
        const captureGroups = new Map();
        contentContainer.querySelectorAll('[data-capture-group]').forEach(el => {
            // Chỉ lấy các phần tử đang hiển thị (có offsetParent)
            if (el.offsetParent !== null) {
                const group = el.dataset.captureGroup;
                if (!captureGroups.has(group)) {
                     captureGroups.set(group, []);
                }
                captureGroups.get(group).push(el);
            }
        });
        
        // Inject CSS (QUAN TRỌNG: Để định dạng bảng, mobile preset, v.v.)
        const styleElement = injectCaptureStyles();
        
        if (typeof Chart !== 'undefined') {
            Chart.defaults.animation = false;
        }
        await new Promise(resolve => setTimeout(resolve, 100));
        
        try {
            // Case 1: Không có group nào, chụp nguyên container
            if (captureGroups.size === 0) {
                if (contentContainer.offsetParent !== null) {
                    const preset = contentContainer.dataset.capturePreset;
                    const presetClass = preset ? `preset-${preset}` : '';
                    await this.captureAndDownload(contentContainer, baseTitle, presetClass);
                } else {
                     alert('Không có nội dung hiển thị để chụp.');
                }
                return;
            }

            // Case 2: Chụp từng group
            for (const [group, elements] of captureGroups.entries()) {
                const targetElement = elements[0];
                
                // Tìm tiêu đề con (h3, h4) để đặt tên file cho đẹp
                let foundTitle = '';
                if (targetElement) {
                    foundTitle = targetElement.querySelector('h3, h4')?.textContent?.trim() || '';
                }
                
                const captureTitle = (foundTitle || baseTitle)
                                        .replace(/[^a-zA-Z0-9\sÁ-ỹ]/g, '')
                                        .replace(/\s+/g, '_');
                
                const preset = targetElement.dataset.capturePreset;
                const isKpiGroup = group === 'kpi'; // KPI Group cần xử lý grid đặc biệt
                
                let elementToCapture;
                let presetClass = '';

                if (isKpiGroup) {
                    presetClass = 'prepare-for-kpi-capture';
                } else if (preset) {
                    presetClass = `preset-${preset}`;
                }

                // Nếu group có nhiều element (ví dụ 2 bảng ngang nhau), gom vào container chung
                if (elements.length > 1 && !isKpiGroup) {
                    const tempContainer = document.createElement('div');
                    tempContainer.className = 'capture-layout-container'; // CSS flex column gap 24px
                    elements.forEach(el => tempContainer.appendChild(el.cloneNode(true)));
                    elementToCapture = tempContainer;
                } else {
                    elementToCapture = targetElement;
                }
    
                await this.captureAndDownload(elementToCapture, captureTitle, presetClass);
                
                // Delay nhỏ giữa các lần chụp để không treo trình duyệt
                await new Promise(resolve => setTimeout(resolve, 300));
            }
        } finally {
            styleElement.remove();
            if (typeof Chart !== 'undefined') {
                Chart.defaults.animation = {};
            }
        }

        notificationStore.update(s => ({ ...s, visible: true, type: 'success', message: 'Hoàn tất!' }));
        setTimeout(() => notificationStore.update(s => ({ ...s, visible: false })), 3000);
    },
};
--- END FILE: ./src/services/capture.service.js ---

--- START FILE: ./src/services/composerService.js ---
// File: src/services/composerService.js
// MỤC ĐÍCH: Chỉ chứa logic cho Trình tạo Nhận xét.

import { get } from 'svelte/store';
import { masterReportData } from '../stores.js';
import { dataProcessing } from './dataProcessing.js';
// [FIX LỖI IMPORT] Dùng 'import * as utils' thay vì 'import { utils }'
import * as utils from '../utils.js'; 
import { formatters } from '../utils/formatters.js';

const composerServices = {
    // Logic getEmployeeRanking
    getEmployeeRanking(reportData, key, direction = 'desc', count = 3, department = 'ALL') {
        if (!reportData || reportData.length === 0) return [];
        let filteredData = reportData;
        if (department !== 'ALL') {
            filteredData = reportData.filter(e => e.boPhan === department);
        }

        return [...filteredData]
            .filter(e => e[key] > 0)
            .sort((a, b) => direction === 'desc' ? (b[key] || 0) - (a[key] || 0) : (a[key] || 0) - (b[key] || 0))
            .slice(0, count);
    },

    // Logic getEmployeesBelowTarget
    getEmployeesBelowTarget(reportData, dataKey, goalKey, department = 'ALL') {
        if (!reportData || reportData.length === 0) return [];
        let filteredData = reportData;
        if (department !== 'ALL') {
            filteredData = reportData.filter(e => e.boPhan === department);
        }

        return filteredData.filter(employee => {
            const value = employee[dataKey] || 0;
            const target = (employee.mucTieu?.[goalKey] || 0) / 100;
            return target > 0 && value < target;
        }).sort((a, b) => (b[dataKey] || 0) - (a[dataKey] || 0));
    },

    // Logic formatEmployeeList
    formatEmployeeList(employeeArray, valueKey, valueType = 'number') {
        if (!Array.isArray(employeeArray) || employeeArray.length === 0) {
            return " (không có)";
        }
        return "\n" + employeeArray.map((e, index) => {
            const value = e[valueKey];
            let formattedValue = '';
            if (valueType === 'percent') {
                formattedValue = formatters.formatPercentage(value);
            } else if (valueType === 'currency') {
                formattedValue = formatters.formatRevenue(value) + " tr";
            } else {
                formattedValue = formatters.formatNumberOrDash(value);
            }
            return `${index + 1}. ${formatters.getShortEmployeeName(e.hoTen, e.maNV)}: ${formattedValue} @${e.maNV}`;
        }).join("\n");
    },
    
    // Logic processComposerTemplate
    processComposerTemplate(template, supermarketReport, goals, rankingReportData, competitionData, sectionId) {
        if (!template || !supermarketReport || !goals) {
            return "Lỗi: Dữ liệu không đủ để tạo nhận xét.";
        }

        const tagMapping = {
            'DTQD': { key: 'doanhThuQuyDoi', format: 'currency' },
            'THUNHAP': { key: 'tongThuNhap', format: 'currency' },
            'TLQD': { key: 'hieuQuaQuyDoi', format: 'percent' },
        };

        const botTargetMapping = {
            'TLQD': { dataKey: 'hieuQuaQuyDoi', goalKey: 'phanTramQD', format: 'percent' },
            'TLTC': { dataKey: 'tyLeTraCham', goalKey: 'phanTramTC', format: 'percent' },
            'PK': { dataKey: 'pctPhuKien', goalKey: 'phanTramPhuKien', format: 'percent' },
            'GD': { dataKey: 'pctGiaDung', goalKey: 'phanTramGiaDung', format: 'percent' },
            'MLN': { dataKey: 'pctMLN', goalKey: 'phanTramMLN', format: 'percent' },
            'SIM': { dataKey: 'pctSim', goalKey: 'phanTramSim', format: 'percent' },
            'VAS': { dataKey: 'pctVAS', goalKey: 'phanTramVAS', format: 'percent' },
            'BH': { dataKey: 'pctBaoHiem', goalKey: 'phanTramBaoHiem', format: 'percent' },
        };

        return template.replace(/\[(.*?)\]/g, (match, tag) => {
            const now = new Date();
            const currentDay = now.getDate() || 1;

            let dtThuc = supermarketReport.doanhThu || 0;
            let dtQd = supermarketReport.doanhThuQuyDoi || 0;
            let phanTramHTQD = goals.doanhThuQD > 0 ? (dtQd / 1000000) / goals.doanhThuQD : 0;

            if (sectionId === 'luyke') {
                // Cần đảm bảo element tồn tại trước khi lấy value
                const pasteEl = document.getElementById('paste-luyke');
                const pastedLuyKeData = dataProcessing.parseLuyKePastedData(pasteEl?.value || '');
                
                if (pastedLuyKeData.mainKpis && pastedLuyKeData.mainKpis['Thực hiện DT thực']) {
                    dtThuc = parseFloat(pastedLuyKeData.mainKpis['Thực hiện DT thực'].replace(/,/g, '')) * 1000000;
                }
                if (pastedLuyKeData.mainKpis && pastedLuyKeData.mainKpis['Thực hiện DTQĐ']) {
                    dtQd = parseFloat(pastedLuyKeData.mainKpis['Thực hiện DTQĐ'].replace(/,/g, '')) * 1000000;
                }
                if (pastedLuyKeData.mainKpis && pastedLuyKeData.mainKpis['% HT Target Dự Kiến (QĐ)']) {
                    phanTramHTQD = (parseFloat(pastedLuyKeData.mainKpis['% HT Target Dự Kiến (QĐ)'].replace('%', '')) || 0) / 100;
                }
            }

            if (tag === 'NGAY') return now.toLocaleDateString('vi-VN');
            if (tag === 'GIO') return now.toLocaleTimeString('vi-VN', { hour: '2-digit', minute: '2-digit' });

            if (tag === 'DT_THUC') return formatters.formatNumber(dtThuc / 1000000, 0) + " tr";
            if (tag === 'DTQD') return formatters.formatNumber(dtQd / 1000000, 0) + " tr";
            if (tag === '%HT_DTQD') return formatters.formatPercentage(phanTramHTQD);

            if (tag === 'TLQD') {
                if (sectionId === 'luyke') {
                    const pasteEl = document.getElementById('paste-luyke');
                    const pastedLuyKeData = dataProcessing.parseLuyKePastedData(pasteEl?.value || '');
                    if (pastedLuyKeData.mainKpis && pastedLuyKeData.mainKpis['Thực hiện DT thực'] && pastedLuyKeData.mainKpis['Thực hiện DTQĐ']) {
                        const dtThucPasted = parseFloat(String(pastedLuyKeData.mainKpis['Thực hiện DT thực']).replace(/,/g, ''));
                        const dtQdPasted = parseFloat(String(pastedLuyKeData.mainKpis['Thực hiện DTQĐ']).replace(/,/g, ''));
                        if (dtThucPasted > 0) {
                            return formatters.formatPercentage((dtQdPasted / dtThucPasted) - 1);
                        }
                    }
                }
                return formatters.formatPercentage(supermarketReport.hieuQuaQuyDoi || 0);
            }

            if (tag === '%HT_DTT') {
                const target = parseFloat(goals.doanhThuThuc) || 0;
                const percent = target > 0 ? (dtThuc / 1000000) / target : 0;
                return formatters.formatPercentage(percent);
            }
            if (tag === 'DT_CHUAXUAT') return formatters.formatRevenue(supermarketReport.doanhThuQuyDoiChuaXuat || 0) + " tr";
            if (tag === 'SS_CUNGKY') return supermarketReport.comparisonData?.percentage || 'N/A';

            if (tag.startsWith('TD_')) {
                const total = competitionData?.length || 0;
                const dat = (competitionData || []).filter(d => parseFloat(String(d.hoanThanh).replace('%','')) >= 100).length;
                if (tag === 'TD_TONG_CT') return total;
                if (tag === 'TD_CT_DAT') return dat;
                if (tag === 'TD_CT_CHUADAT') return total - dat;
                if (tag === 'TD_TYLE_DAT') return total > 0 ? formatters.formatPercentage(dat / total) : '0%';
            }

            if (tag === 'TOP_QDC_INFO') {
                if (!supermarketReport.qdc) return " (không có)";
                const qdcArray = Object.values(supermarketReport.qdc).filter(item => item.sl > 0);
                const sortedQDC = qdcArray.sort((a,b) => b.dtqd - a.dtqd);
                return "\n" + sortedQDC.map(item => `  • ${item.name}: SL ${formatters.formatNumber(item.sl)}, TB ${formatters.formatNumber(item.sl / currentDay, 1)}/ngày`).join("\n");
            }
            if (tag === 'TOP_NGANHHANG_SL') {
                if (!supermarketReport.nganhHangChiTiet) return " (không có)";
                const nganhHangArray = Object.values(supermarketReport.nganhHangChiTiet).filter(item => item.quantity > 0);
                const topNganhHang = nganhHangArray.sort((a,b) => b.quantity - a.quantity).slice(0, 10);
                return "\n" + topNganhHang.map(item => `  • ${utils.cleanCategoryName(item.name)}: ${formatters.formatNumber(item.quantity)}`).join("\n");
            }

            const rankingRegex = /^(TOP|BOT)(\d)_(\w+)_([\s\S]+)$/;
            const rankingMatch = tag.match(rankingRegex);
            if (rankingMatch && rankingReportData) {
                const [_, type, count, metric, department] = rankingMatch;
                const cleanDepartment = department.replace(/@msnv$/, '').trim();
                const direction = type === 'TOP' ? 'desc' : 'asc';
                const metricInfo = tagMapping[metric];
                if (metricInfo) {
                    let dataForRanking = rankingReportData;
                    // Nếu là thu nhập, lấy từ masterReportData để có đủ dữ liệu
                    if (metric === 'THUNHAP') {
                         const masterData = get(masterReportData);
                         if (masterData && masterData.sknv.length > 0) {
                            dataForRanking = masterData.sknv;
                         }
                    }
                    const ranking = composerServices.getEmployeeRanking(dataForRanking, metricInfo.key, direction, parseInt(count), cleanDepartment);
                    return composerServices.formatEmployeeList(ranking, metricInfo.key, metricInfo.format);
                }
            }

            const botTargetRegex = /^BOT_TARGET_(\w+)_([\s\S]+)$/;
            const botTargetMatch = tag.match(botTargetRegex);
            if(botTargetMatch && rankingReportData) {
                let [_, metric, department] = botTargetMatch;
                department = department.replace(/@msnv$/, '').trim();
                const metricInfo = botTargetMapping[metric];
                if (metricInfo) {
                    const employeeList = composerServices.getEmployeesBelowTarget(rankingReportData, metricInfo.dataKey, metricInfo.goalKey, department);
                    return composerServices.formatEmployeeList(employeeList, metricInfo.dataKey, metricInfo.format);
                }
            }

            const qdcInfoRegex = /^QDC_INFO_(.+)$/;
            const qdcMatch = tag.match(qdcInfoRegex);
            if(qdcMatch && supermarketReport.qdc){
                const itemName = qdcMatch[1];
                const itemData = Object.values(supermarketReport.qdc).find(i => i.name === itemName);
                return itemData ? `SL ${formatters.formatNumber(itemData.sl)}, TB ${formatters.formatNumber(itemData.sl / currentDay, 1)}/ngày` : '(N/A)';
            }

            const nhInfoRegex = /^NH_INFO_(.+)$/;
            const nhMatch = tag.match(nhInfoRegex);
            if(nhMatch && supermarketReport.nganhHangChiTiet){
                const itemName = nhMatch[1];
                 const itemData = Object.values(supermarketReport.nganhHangChiTiet).find(i => utils.cleanCategoryName(i.name) === itemName);
                return itemData ? `SL ${formatters.formatNumber(itemData.quantity)}, TB ${formatters.formatNumber(itemData.quantity / currentDay, 1)}/ngày` : '(N/A)';
            }

            return match;
        });
    },
};

export const composerService = composerServices;
--- END FILE: ./src/services/composerService.js ---

--- START FILE: ./src/services/data/cacheHandler.js ---
import { get } from 'svelte/store';
import { danhSachNhanVien, competitionData, pastedThiDuaReportData, thuongERPData, thuongERPDataThangTruoc } from '../../stores.js';
import { storage } from '../storage.service.js';
import { dataProcessing } from '../dataProcessing.js';
import { adminService } from '../admin.service.js';
import { FILE_MAPPING, LOCAL_DSNV_FILENAME_KEY } from './constants.js';
import { updateSyncState } from './syncHandler.js';

export const cacheHandler = {
    async loadAllFromCache() {
        try { await storage.openDB(); } catch (err) { console.error("Lỗi DB:", err); }

        adminService.loadMappingsGlobal();

        console.log("[DataService] Bắt đầu tải DSNV từ cache...");
        const dsnvData = await storage.getItem('saved_danhsachnv');
        if (dsnvData && dsnvData.length > 0) {
            danhSachNhanVien.set(dsnvData);
            const fileName = localStorage.getItem(LOCAL_DSNV_FILENAME_KEY) || 'DSNV (Cache)';
            updateSyncState('saved_danhsachnv', 'cached', `✓ Đã tải ${dsnvData.length} dòng (Chỉ lưu máy này)`, { fileName });
        } else {
            updateSyncState('saved_danhsachnv', 'error', 'Chưa có DSNV. Vui lòng tải file.', null);
        }
        
        const otherFiles = ['saved_giocong', 'saved_ycx', 'saved_thuongnong', 'saved_ycx_thangtruoc', 'saved_thuongnong_thangtruoc'];
        await Promise.all(otherFiles.map(async (key) => {
            const data = await storage.getItem(key);
            if (data && data.length > 0) {
                FILE_MAPPING[key].store.set(data);
                updateSyncState(key, 'cached', `✓ Đã tải ${data.length} dòng (Local)`, null);
             }
        }));

        console.log("[DataService] Bắt đầu xử lý dữ liệu Paste...");
        try {
            const luykeText = localStorage.getItem('daily_paste_luyke');
            if (luykeText) {
                dataProcessing.parseLuyKePastedData(luykeText);
                dataProcessing.parseCompetitionDataFromLuyKe(luykeText);
                updateSyncState('daily_paste_luyke', 'cached', `(Local)`, null);
            }
            const erpText = localStorage.getItem('daily_paste_thuongerp');
            if (erpText) {
                const data = dataProcessing.processThuongERP(erpText);
                thuongERPData.set(data);
                updateSyncState('daily_paste_thuongerp', 'cached', `(Local)`, null);
            }
            const rawThiDua = localStorage.getItem('raw_paste_thiduanv');
            if (rawThiDua) {
                const parsedData = dataProcessing.parsePastedThiDuaTableData(rawThiDua);
                if (parsedData.success) {
                    const $competitionData = get(competitionData);
                    const processedData = dataProcessing.processThiDuaNhanVienData(parsedData, $competitionData);
                    pastedThiDuaReportData.set(processedData);
                    updateSyncState('daily_paste_thiduanv', 'cached', `(Local)`, null);
                }
            }
            const erpTTText = localStorage.getItem('saved_thuongerp_thangtruoc');
            if (erpTTText) {
                 const data = dataProcessing.processThuongERP(erpTTText);
                 thuongERPDataThangTruoc.set(data);
                 updateSyncState('saved_thuongerp_thangtruoc', 'cached', `(Local)`, null);
            }
        } catch (err) { console.error("Lỗi tải cache paste:", err); }
    }
};
--- END FILE: ./src/services/data/cacheHandler.js ---

--- START FILE: ./src/services/data/constants.js ---
import { 
    danhSachNhanVien, rawGioCongData, ycxData, thuongNongData,
    ycxDataThangTruoc, thuongNongDataThangTruoc, thuongERPData, 
    thuongERPDataThangTruoc, competitionData, pastedThiDuaReportData
} from '../../stores.js';
import { dataProcessing } from '../dataProcessing.js';

export const LOCAL_DSNV_FILENAME_KEY = '_localDsnvFilename';

export const FILE_MAPPING = {
    'saved_danhsachnv': { store: danhSachNhanVien, normalizeType: 'danhsachnv', name: 'DS Nhân viên', localOnly: true },
    'saved_giocong': { store: rawGioCongData, normalizeType: 'giocong', name: 'Giờ công' },
    'saved_ycx': { store: ycxData, normalizeType: 'ycx', name: 'YCX Lũy kế' },
    'saved_thuongnong': { store: thuongNongData, normalizeType: 'thuongnong', name: 'Thưởng nóng' },
    'saved_ycx_thangtruoc': { store: ycxDataThangTruoc, normalizeType: 'ycx', name: 'YCX Tháng trước' },
    'saved_thuongnong_thangtruoc': { store: thuongNongDataThangTruoc, normalizeType: 'thuongnong', name: 'Thưởng nóng TT' }
};

export const PASTE_MAPPING = {
    'daily_paste_luyke': { 
        processFunc: dataProcessing.parseCompetitionDataFromLuyKe, 
        store: competitionData,
        isThiDuaNV: false,
        name: 'Data Lũy Kế'
    },
    'daily_paste_thuongerp': { 
        processFunc: dataProcessing.processThuongERP, 
        store: thuongERPData,
        isThiDuaNV: false,
        name: 'Thưởng ERP'
    },
    'saved_thuongerp_thangtruoc': { 
        processFunc: dataProcessing.processThuongERP, 
        store: thuongERPDataThangTruoc,
        isThiDuaNV: false,
        name: 'Thưởng ERP (TT)'
    },
    'daily_paste_thiduanv': { 
        processFunc: dataProcessing.processThiDuaNhanVienData, 
        store: pastedThiDuaReportData,
        isThiDuaNV: true,
        name: 'Thi đua NV'
    }
};
--- END FILE: ./src/services/data/constants.js ---

--- START FILE: ./src/services/data/fileHandler.js ---
/* global XLSX */
import { get } from 'svelte/store';
import { 
    selectedWarehouse, 
    currentUser, 
    realtimeYCXData, 
    categoryStructure, 
    brandList, 
    specialProductList 
} from '../../stores.js';
import { dataProcessing } from '../dataProcessing.js';
import { storage, storageService } from '../storage.service.js';
import { datasyncService } from '../datasync.service.js';
import { analyticsService } from '../analytics.service.js';
import { FILE_MAPPING, LOCAL_DSNV_FILENAME_KEY } from './constants.js';
import { updateSyncState } from './syncHandler.js';

// Hàm đọc file Excel thành Workbook
async function _handleFileRead(fileBlob) {
    return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = (event) => {
            try {
                const data = new Uint8Array(event.target.result);
                const workbook = XLSX.read(data, { type: 'array', cellDates: true, cellText: true });
                resolve(workbook);
            } catch (err) { reject(err); }
        };
        reader.onerror = (err) => reject(new Error("Không thể đọc file."));
        reader.readAsArrayBuffer(fileBlob);
    });
}

export const fileHandler = {
    // 1. Xử lý các file dữ liệu chính (DSNV, Giờ công, YCX, Thưởng nóng...)
    async handleFileChange(file, saveKey) {
        const mapping = FILE_MAPPING[saveKey];
        if (!mapping) return { success: false, message: `Lỗi mapping: ${saveKey}` };
        
        updateSyncState(saveKey, 'uploading', 'Đang đọc & chuẩn hóa...');
        
        try {
            const workbook = await _handleFileRead(file);
            const sheetName = workbook.SheetNames[0];
            const rawData = XLSX.utils.sheet_to_json(workbook.Sheets[sheetName], { raw: false, defval: null });
            
            const { normalizedData, success, missingColumns } = dataProcessing.normalizeData(rawData, mapping.normalizeType);
            
            if (!success) {
                updateSyncState(saveKey, 'error', `Thiếu cột: ${missingColumns.join(', ')}`);
                return { success: false, message: `Thiếu cột bắt buộc: ${missingColumns.join(', ')}` };
            }

            // Lưu vào Store
            mapping.store.set(normalizedData);
            
            // Lưu vào IndexedDB (Cache Local)
            await storage.setItem(saveKey, normalizedData); 
            
            // Xử lý riêng cho DSNV (chỉ lưu local)
            if (saveKey === 'saved_danhsachnv') {
                localStorage.setItem(LOCAL_DSNV_FILENAME_KEY, file.name);
                updateSyncState(saveKey, 'cached', `✓ Đã tải ${normalizedData.length} dòng (Local)`, null);
                return { success: true, count: normalizedData.length, message: `Thành công` };
            }

            // Xử lý Upload lên Cloud (nếu đã chọn kho)
            const warehouse = get(selectedWarehouse);
            if (warehouse && !mapping.localOnly) {
                updateSyncState(saveKey, 'uploading', 'Đang tải lên Cloud...');
                try {
                    const path = `warehouse_data/${warehouse}/${saveKey}_${Date.now()}_${file.name}`;
                    const downloadUrl = await storageService.uploadFileToStorage(file, path);
                    
                    const metadata = {
                        downloadURL: downloadUrl,
                        fileName: file.name,
                        fileType: 'excel',
                        rowCount: normalizedData.length,
                        updatedAt: new Date(),
                        updatedBy: get(currentUser)?.email || 'Tôi'
                    };
                    
                    await datasyncService.saveWarehouseMetadata(warehouse, saveKey, metadata);
                    updateSyncState(saveKey, 'synced', `✓ Đã đồng bộ`, metadata);
                } catch (e) {
                    console.error("Lỗi upload cloud:", e);
                    updateSyncState(saveKey, 'error', `Lỗi lưu Cloud: ${e.message}`, null);
                    // Không return false ở đây vì dữ liệu local đã ok
                }
            } else {
                 updateSyncState(saveKey, 'synced', `✓ Đã tải ${normalizedData.length} dòng`, null);
            }
            
            analyticsService.trackAction();
            return { success: true, count: normalizedData.length, message: `Thành công` };

        } catch (err) {
            console.error(err);
            updateSyncState(saveKey, 'error', `Lỗi: ${err.message}`, null);
            return { success: false, message: `Lỗi xử lý file: ${err.message}` };
        }
    },

    // 2. Xử lý file Realtime (Tương tự YCX nhưng lưu vào store riêng)
    async handleRealtimeFileInput(event) {
        const file = event.target.files[0];
        if (!file) return;

        console.log("[FileHandler] Bắt đầu xử lý Realtime:", file.name);
        
        try {
            const workbook = await _handleFileRead(file);
            const sheetName = workbook.SheetNames[0];
            const rawData = XLSX.utils.sheet_to_json(workbook.Sheets[sheetName], { raw: false, defval: null });

            // Tái sử dụng logic chuẩn hóa của 'ycx' vì cấu trúc file giống nhau
            const { normalizedData, success, missingColumns } = dataProcessing.normalizeData(rawData, 'ycx');

            if (!success) {
                alert(`File thiếu cột: ${missingColumns.join(', ')}`);
                return;
            }

            // Cập nhật store
            realtimeYCXData.set(normalizedData);
            
            // Ghi nhận analytics
            analyticsService.trackAction();
            
            console.log(`[FileHandler] Đã nạp ${normalizedData.length} dòng realtime.`);
            // Reset input
            event.target.value = null;

        } catch (error) {
            console.error("Lỗi xử lý Realtime:", error);
            alert("Lỗi đọc file Realtime: " + error.message);
        }
    },

    // 3. Xử lý file Cấu trúc Ngành hàng (Admin)
    async handleCategoryFile(event) {
        const file = event.target.files[0];
        if (!file) return;

        try {
            const workbook = await _handleFileRead(file);
            const sheetName = workbook.SheetNames[0];
            const rawData = XLSX.utils.sheet_to_json(workbook.Sheets[sheetName], { raw: false, defval: null });

            const { success, normalizedData, error } = dataProcessing.normalizeCategoryStructureData(rawData);
            
            if (!success) {
                throw new Error(error);
            }

            // Cập nhật Store
            categoryStructure.set(normalizedData);
            
            // Tách danh sách Hãng (Brand) từ dữ liệu
            const brands = [...new Set(normalizedData.map(i => i.nhaSanXuat).filter(Boolean))].sort();
            brandList.set(brands);

            console.log(`[FileHandler] Đã nạp ${normalizedData.length} dòng cấu trúc & ${brands.length} hãng.`);
            
            // Reset input
            event.target.value = null;
            return { success: true, count: normalizedData.length };

        } catch (err) {
            console.error("Lỗi file cấu trúc:", err);
            throw err;
        }
    },

    // 4. Xử lý file Sản phẩm Đặc quyền (Admin)
    async handleSpecialProductFileUpload(event) {
        const file = event.target.files[0];
        if (!file) return;

        try {
            const workbook = await _handleFileRead(file);
            const sheetName = workbook.SheetNames[0];
            const rawData = XLSX.utils.sheet_to_json(workbook.Sheets[sheetName], { raw: false, defval: null });

            const { success, normalizedData, error } = dataProcessing.normalizeSpecialProductData(rawData);

            if (!success) {
                throw new Error(error);
            }

            specialProductList.set(normalizedData);
            console.log(`[FileHandler] Đã nạp ${normalizedData.length} SPĐQ.`);
            
            event.target.value = null;
            return { success: true, count: normalizedData.length };

        } catch (err) {
            console.error("Lỗi file SPĐQ:", err);
            throw err;
        }
    },

    // 5. Tải file mẫu
    async handleTemplateDownload() {
        try {
            const url = await storageService.getTemplateDownloadURL();
            if (url) {
                const a = document.createElement('a');
                a.href = url;
                a.target = "_blank";
                a.download = "Template_DSNV.xlsx";
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
            } else {
                alert("Không tìm thấy link tải mẫu.");
            }
        } catch (e) {
            console.error("Lỗi tải template:", e);
            alert("Lỗi khi lấy link tải mẫu: " + e.message);
        }
    }
};
--- END FILE: ./src/services/data/fileHandler.js ---

--- START FILE: ./src/services/data/pasteHandler.js ---
import { get } from 'svelte/store';
import { selectedWarehouse, currentUser, competitionData, pastedThiDuaReportData } from '../../stores.js';
import { dataProcessing } from '../dataProcessing.js';
import { storageService } from '../storage.service.js';
import { datasyncService } from '../datasync.service.js';
import { analyticsService } from '../analytics.service.js';
import { PASTE_MAPPING } from './constants.js';
import { updateSyncState } from './syncHandler.js';

export const pasteHandler = {
    async handlePasteChange(pastedText, saveKeyPaste, saveKeyRaw, saveKeyProcessed) {
        const primaryKey = saveKeyProcessed || saveKeyPaste;
        const mapping = PASTE_MAPPING[primaryKey];
        if (!mapping) return { success: false, message: `Lỗi mapping paste` };
        
        updateSyncState(saveKeyPaste, 'uploading', 'Đang xử lý...');
        try {
            let processedData;
            let processedCount = 0;
            if (mapping.isThiDuaNV) {
                const parsedData = dataProcessing.parsePastedThiDuaTableData(pastedText);
                if (!parsedData.success) throw new Error(parsedData.error);
                dataProcessing.updateCompetitionNameMappings(parsedData.mainHeaders);
                const $competitionData = get(competitionData);
                processedData = dataProcessing.processThiDuaNhanVienData(parsedData, $competitionData);
                mapping.store.set(processedData);
                localStorage.setItem(saveKeyRaw, pastedText);
                localStorage.setItem(saveKeyProcessed, JSON.stringify(processedData));
                processedCount = processedData.length;
            } else if (mapping.processFunc) {
                processedData = mapping.processFunc(pastedText);
                mapping.store.set(processedData);
                localStorage.setItem(saveKeyPaste, pastedText);
                processedCount = processedData?.length || 0;
                if (saveKeyPaste === 'daily_paste_luyke') {
                     const comps = dataProcessing.parseCompetitionDataFromLuyKe(pastedText);
                     dataProcessing.parseLuyKePastedData(pastedText);
                     processedCount = comps.length;
                }
            }
            const warehouse = get(selectedWarehouse);
            if (warehouse) {
                try {
                    updateSyncState(saveKeyPaste, 'uploading', 'Đang lưu Cloud...');
                    const blob = new Blob([pastedText], { type: 'text/plain' });
                    const path = `warehouse_data/${warehouse}/${primaryKey}_${Date.now()}.txt`;
                    const downloadUrl = await storageService.uploadFileToStorage(blob, path);
                    const metadata = {
                        downloadURL: downloadUrl,
                        fileName: 'du_lieu_dan.txt',
                        fileType: 'text',
                        rowCount: processedCount, 
                        updatedAt: new Date(),
                        updatedBy: get(currentUser)?.email || 'Tôi'
                    };
                    await datasyncService.saveWarehouseMetadata(warehouse, primaryKey, metadata);
                    updateSyncState(saveKeyPaste, 'synced', `✓ Đã đồng bộ`, metadata);
                } catch (e) {
                    console.error("Cloud paste upload error:", e);
                    updateSyncState(saveKeyPaste, 'error', `Lỗi đồng bộ Cloud: ${e.message}`);
                }
            } else {
                 updateSyncState(saveKeyPaste, 'cached', `✓ Đã xử lý (Local)`, null);
            }
            analyticsService.trackAction();
            return { success: true, message: `Thành công` };
        } catch (err) {
            updateSyncState(saveKeyPaste, 'error', `Lỗi: ${err.message}`);
            return { success: false, message: `Lỗi: ${err.message}` };
        }
    }
};
--- END FILE: ./src/services/data/pasteHandler.js ---

--- START FILE: ./src/services/data/syncHandler.js ---
/* global XLSX */
import { get } from 'svelte/store';
import { fileSyncState, selectedWarehouse, currentUser, competitionData, pastedThiDuaReportData, thuongERPData, thuongERPDataThangTruoc } from '../../stores.js';
import { datasyncService } from '../datasync.service.js';
import { storage } from '../storage.service.js';
import { dataProcessing } from '../dataProcessing.js';
import { FILE_MAPPING, PASTE_MAPPING } from './constants.js';

export function updateSyncState(key, status, message, metadata = null) {
    fileSyncState.update(s => ({
        ...s,
        [key]: { status, message, metadata, timestamp: Date.now() }
    }));
}

export function formatTimeAgo(dateInput) {
    if (!dateInput) return '';
    const date = dateInput.toDate ? dateInput.toDate() : new Date(dateInput);
    const seconds = Math.floor((new Date() - date) / 1000);
    
    let interval = seconds / 3600;
    if (interval > 1) return Math.floor(interval) + " giờ trước";
    interval = seconds / 60;
    if (interval > 1) return Math.floor(interval) + " phút trước";
    return "vừa xong";
}

export const syncHandler = {
    async syncDownFromCloud(warehouse) {
        if (!warehouse) return { success: false, message: "Chưa chọn kho." };
        console.log(`[DataService] Bắt đầu đồng bộ kho ${warehouse}...`);
        
        for (const key of Object.keys(FILE_MAPPING)) {
            if (!FILE_MAPPING[key].localOnly) updateSyncState(key, 'checking', 'Đang kiểm tra...', null);
        }
        for (const key of Object.keys(PASTE_MAPPING)) {
            updateSyncState(key, 'checking', 'Đang kiểm tra...', null);
        }

        try {
            const cloudData = await datasyncService.loadWarehouseData(warehouse);
            if (!cloudData) {
                 return { success: true, message: "Kho chưa có dữ liệu trên Cloud." };
            }
            const userEmail = get(currentUser)?.email;

            // Xử lý File Excel
            for (const [key, mapping] of Object.entries(FILE_MAPPING)) {
                if (mapping.localOnly) continue;
                const cloudMeta = cloudData[key];
                const localMetaStr = localStorage.getItem(`_meta_${warehouse}_${key}`);
                const localMeta = localMetaStr ? JSON.parse(localMetaStr) : {};
                if (!cloudMeta) continue;

                const timeAgo = formatTimeAgo(cloudMeta.updatedAt);
                const isMyUpload = cloudMeta.updatedBy === userEmail;
                const isNewer = (cloudMeta.timestamp || 0) > (localMeta.timestamp || 0);
                const currentStoreData = get(mapping.store);
                const isStoreEmpty = !currentStoreData || currentStoreData.length === 0;

                if (isNewer) {
                     const msg = isMyUpload ? `Có bản mới từ bạn ${timeAgo}` : `Có cập nhật mới từ ${cloudMeta.updatedBy} ${timeAgo}`;
                    updateSyncState(key, 'update_available', msg, cloudMeta);
                } else {
                    if (isStoreEmpty) {
                        console.log(`[Auto-Download] ${key} đã đồng bộ metadata nhưng Store rỗng. Đang tự tải về...`);
                        updateSyncState(key, 'downloading', 'Đang tự động tải về...', cloudMeta);
                        await this.downloadFileFromCloud(key);
                    } else {
                         updateSyncState(key, 'synced', `✓ Đã đồng bộ ${timeAgo} (${cloudMeta.rowCount || 0} dòng)`, cloudMeta);
                    }
                }
            }

            // Xử lý Paste Data
            for (const [key, mapping] of Object.entries(PASTE_MAPPING)) {
                const cloudMeta = cloudData[key]; 
                const localMetaStr = localStorage.getItem(`_meta_${warehouse}_${key}`);
                const localMeta = localMetaStr ? JSON.parse(localMetaStr) : {};
                if (cloudMeta) {
                    const timeAgo = formatTimeAgo(cloudMeta.updatedAt);
                    const isMyUpload = cloudMeta.updatedBy === userEmail;
                    const isNewer = (cloudMeta.timestamp || 0) > (localMeta.timestamp || 0);
                    let uiKey = key;
                    if (isNewer) {
                         const msg = isMyUpload ? `Có bản mới từ bạn ${timeAgo}` : `Có cập nhật mới từ ${cloudMeta.updatedBy} ${timeAgo}`;
                         updateSyncState(uiKey, 'update_available', msg, cloudMeta);
                    } else {
                         const currentStoreData = get(mapping.store);
                         const isStoreEmpty = !currentStoreData || currentStoreData.length === 0;
                         if (isStoreEmpty) {
                              console.log(`[Auto-Download] ${uiKey} (Paste) đã đồng bộ metadata nhưng Store rỗng. Đang tự tải...`);
                              updateSyncState(uiKey, 'downloading', 'Đang tự tải...', cloudMeta);
                              await this.downloadFileFromCloud(uiKey);
                         } else {
                              updateSyncState(uiKey, 'synced', `✓ Đã đồng bộ ${timeAgo}`, cloudMeta);
                         }
                    }
                }
            }
            return { success: true, message: `Đã kiểm tra dữ liệu kho ${warehouse}.` };
        } catch (error) {
            console.error("Sync error:", error);
            return { success: false, message: "Lỗi kết nối Cloud: " + error.message };
        }
    },

    async downloadFileFromCloud(key) {
        const state = get(fileSyncState)[key];
        const warehouse = get(selectedWarehouse);
        if (!state?.metadata?.downloadURL || !warehouse) return;
        
        updateSyncState(key, 'downloading', 'Đang tải xuống...', state.metadata);
        
        try {
            const response = await fetch(state.metadata.downloadURL);
            
            if (FILE_MAPPING[key]) {
                const blob = await response.blob();
                const workbook = await new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                         const data = new Uint8Array(e.target.result);
                         resolve(XLSX.read(data, { type: 'array', cellDates: true, cellText: true }));
                    };
                    reader.onerror = reject;
                    reader.readAsArrayBuffer(blob);
                });
                const rawData = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]], { raw: false, defval: null });
                const mapping = FILE_MAPPING[key];
                const { normalizedData } = dataProcessing.normalizeData(rawData, mapping.normalizeType);
                mapping.store.set(normalizedData);
                await storage.setItem(key, normalizedData);
                const metaToSave = { ...state.metadata, timestamp: state.metadata.timestamp || Date.now() };
                localStorage.setItem(`_meta_${warehouse}_${key}`, JSON.stringify(metaToSave));
                const timeAgo = formatTimeAgo(state.metadata.updatedAt);
                updateSyncState(key, 'synced', `✓ Đã đồng bộ ${timeAgo} (${normalizedData.length} dòng)`, state.metadata);
            
            } else if (PASTE_MAPPING[key]) {
                const textContent = await response.text();
                const mapping = PASTE_MAPPING[key];
                let processedCount = 0;
                
                if (mapping.isThiDuaNV) {
                     localStorage.setItem('raw_paste_thiduanv', textContent);
                    const parsedData = dataProcessing.parsePastedThiDuaTableData(textContent);
                    if (parsedData.success) {
                        dataProcessing.updateCompetitionNameMappings(parsedData.mainHeaders);
                        const $competitionData = get(competitionData);
                        const processedData = dataProcessing.processThiDuaNhanVienData(parsedData, $competitionData);
                        mapping.store.set(processedData);
                        processedCount = processedData.length;
                        localStorage.setItem('daily_paste_thiduanv', JSON.stringify(processedData)); 
                    }
                } else if (mapping.processFunc) {
                     const processedData = mapping.processFunc(textContent);
                    mapping.store.set(processedData);
                    processedCount = processedData?.length || 0;
                    localStorage.setItem(key, textContent);
                    if (key === 'daily_paste_luyke') {
                         const comps = dataProcessing.parseCompetitionDataFromLuyKe(textContent);
                         dataProcessing.parseLuyKePastedData(textContent);
                         processedCount = comps.length;
                    }
                }
                const metaToSave = { 
                    ...state.metadata, 
                    timestamp: state.metadata.timestamp || Date.now(),
                    rowCount: processedCount 
                };
                localStorage.setItem(`_meta_${warehouse}_${key}`, JSON.stringify(metaToSave));
                const timeAgo = formatTimeAgo(state.metadata.updatedAt);
                updateSyncState(key, 'synced', `✓ Đã đồng bộ ${timeAgo}`, metaToSave);
                window.dispatchEvent(new CustomEvent('cloud-paste-loaded', { detail: { key, text: textContent } }));
            }
            return { success: true };
        } catch (e) {
            console.error(e);
            updateSyncState(key, 'error', 'Lỗi tải file: ' + e.message, state.metadata);
            return { success: false, message: e.message };
        }
    }
};
--- END FILE: ./src/services/data/syncHandler.js ---

--- START FILE: ./src/services/dataProcessing.js ---
// src/services/dataProcessing.js
// Version 3.0 - Modular Facade
// File này đóng vai trò tập hợp các hàm từ thư mục processing/
// Giúp giữ nguyên API cũ để không làm hỏng các component đang sử dụng.

import { helpers } from './processing/helpers.js';
import { normalizers } from './processing/normalizers.js';
import { parsers } from './processing/parsers.js';
import { processors } from './processing/processors.js';

export const dataProcessing = {
    // --- Helpers ---
    findColumnName: helpers.findColumnName,
    getHinhThucXuatTinhDoanhThu: helpers.getHinhThucXuatTinhDoanhThu,
    getHinhThucXuatTraGop: helpers.getHinhThucXuatTraGop,
    getHeSoQuyDoi: helpers.getHeSoQuyDoi,
    _cleanCompetitionName: helpers.cleanCompetitionName,
    classifyInsurance: helpers.classifyInsurance,
    _findHeaderAndProcess: helpers.findHeaderAndProcess, // Public alias cho processors dùng

    // --- Normalizers ---
    normalizeData: normalizers.normalizeData,
    normalizeCategoryStructureData: normalizers.normalizeCategoryStructureData,
    normalizeSpecialProductData: normalizers.normalizeSpecialProductData,
    normalizeBrandData: normalizers.normalizeBrandData,

    // --- Parsers ---
    processThuongERP: parsers.processThuongERP,
    parseLuyKePastedData: parsers.parseLuyKePastedData,
    parseCompetitionDataFromLuyKe: parsers.parseCompetitionDataFromLuyKe,
    parsePastedThiDuaTableData: parsers.parsePastedThiDuaTableData,

    // --- Processors ---
    debugCompetitionFiltering: processors.debugCompetitionFiltering,
    updateCompetitionNameMappings: processors.updateCompetitionNameMappings,
    processThiDuaNhanVienData: processors.processThiDuaNhanVienData,
    processGioCongData: processors.processGioCongData,
    processThiDuaVungFile: processors.processThiDuaVungFile
};
--- END FILE: ./src/services/dataProcessing.js ---

--- START FILE: ./src/services/dataService.js ---
// src/services/dataService.js
import { fileHandler } from './data/fileHandler.js';
import { pasteHandler } from './data/pasteHandler.js';
import { syncHandler } from './data/syncHandler.js';
import { cacheHandler } from './data/cacheHandler.js';

export const dataService = {
    appController: null,
    init(controller) { this.appController = controller; },

    // --- File Handlers ---
    // [FIX] Sử dụng arrow function để wrap, tránh lỗi undefined khi khởi tạo module
    handleFileChange: (file, key) => fileHandler.handleFileChange(file, key),
    handleRealtimeFileInput: (event) => fileHandler.handleRealtimeFileInput(event),
    handleCategoryFile: (event) => fileHandler.handleCategoryFile(event),
    handleSpecialProductFileUpload: (event) => fileHandler.handleSpecialProductFileUpload(event),
    handleTemplateDownload: () => fileHandler.handleTemplateDownload(),

    // --- Paste Handlers ---
    handlePasteChange: (text, key1, key2, key3) => pasteHandler.handlePasteChange(text, key1, key2, key3),

    // --- Sync & Cache ---
    syncDownFromCloud: (wh) => syncHandler.syncDownFromCloud(wh),
    downloadFileFromCloud: (key) => syncHandler.downloadFileFromCloud(key),
    loadAllFromCache: () => cacheHandler.loadAllFromCache(),

    _getSavedMetadata(warehouse, dataType) { return null; }
};
--- END FILE: ./src/services/dataService.js ---

--- START FILE: ./src/services/datasync.service.js ---
// src/services/datasync.service.js
import { doc, setDoc, getDoc, serverTimestamp } from "firebase/firestore"; 
import { firebaseStore, currentUser } from '../stores.js'; 
import { get } from 'svelte/store';

const getDB = () => {
    const fb = get(firebaseStore);
    return fb.db;
};

const getCurrentUserEmail = () => {
    const user = get(currentUser);
    return user ? user.email : 'unknown';
};

export const datasyncService = {
    // --- MỤC TIÊU (GOALS) ---
    // Lưu cấu hình mục tiêu (Lũy kế + Realtime) cho kho
    async saveGoalSettings(kho, type, settings) {
        const db = getDB();
        if (!db || !kho) return;

        // type: 'luyke' hoặc 'realtime'
        const fieldName = type === 'luyke' ? 'luykeGoals' : 'realtimeGoals';

        const khoRef = doc(db, "warehouseData", kho);
        try {
            await setDoc(khoRef, {
                [fieldName]: settings,
                [`${fieldName}UpdatedAt`]: serverTimestamp(),
                [`${fieldName}UpdatedBy`]: getCurrentUserEmail()
            }, { merge: true });
            console.log(`[DataSync] Đã lưu mục tiêu ${type} cho kho ${kho}`);
        } catch (error) {
            console.error(`[DataSync] Lỗi lưu mục tiêu ${type}:`, error);
        }
    },

    // Tải cấu hình mục tiêu
    async loadGoalSettings(kho) {
        const db = getDB();
        if (!db || !kho) return { luyke: {}, realtime: {} };

        const khoRef = doc(db, "warehouseData", kho);
        try {
            const docSnap = await getDoc(khoRef);
            if (docSnap.exists()) {
                const data = docSnap.data();
                return {
                    luyke: data.luykeGoals || {},
                    realtime: data.realtimeGoals || {}
                };
            }
            return { luyke: {}, realtime: {} };
        } catch (e) {
            console.error("[DataSync] Lỗi tải mục tiêu:", e);
            return { luyke: {}, realtime: {} };
        }
    },

    // --- CÁC HÀM KHÁC (GIỮ NGUYÊN) ---
    async saveQdcConfig(kho, config) {
        const db = getDB();
        if (!db || !kho) return;
        const khoRef = doc(db, "warehouseData", kho);
        try {
            await setDoc(khoRef, {
                qdcConfig: config,
                qdcConfigUpdatedAt: serverTimestamp(),
                qdcConfigUpdatedBy: getCurrentUserEmail()
            }, { merge: true });
        } catch (error) { console.error(error); }
    },

    async loadQdcConfig(kho) {
        const db = getDB();
        if (!db || !kho) return null;
        const khoRef = doc(db, "warehouseData", kho);
        try {
            const docSnap = await getDoc(khoRef);
            return (docSnap.exists() && docSnap.data().qdcConfig) ? docSnap.data().qdcConfig : null;
        } catch (e) { return null; }
    },

    async saveRealtimeHiddenCategories(kho, hiddenList) {
        const db = getDB();
        if (!db || !kho) return;
        const khoRef = doc(db, "warehouseData", kho);
        try {
            await setDoc(khoRef, {
                realtimeConfig: { hiddenCategories: hiddenList, updatedAt: serverTimestamp(), updatedBy: getCurrentUserEmail() }
            }, { merge: true });
        } catch (error) { console.error(error); }
    },

    async loadRealtimeHiddenCategories(kho) {
        const db = getDB();
        if (!db || !kho) return [];
        const khoRef = doc(db, "warehouseData", kho);
        try {
            const docSnap = await getDoc(khoRef);
            return (docSnap.exists() && docSnap.data().realtimeConfig) ? docSnap.data().realtimeConfig.hiddenCategories || [] : [];
        } catch (e) { return []; }
    },

    async savePersonalRevenueTables(kho, tables) {
        const db = getDB();
        if (!db || !kho) return;
        const personalTables = tables.filter(t => !t.isSystem);
        const khoRef = doc(db, "warehouseData", kho);
        try { await setDoc(khoRef, { personalRevenueTables: personalTables, updatedAt: serverTimestamp() }, { merge: true }); } catch (error) { throw error; }
    },

    async loadPersonalRevenueTables(kho) {
        const db = getDB();
        if (!db || !kho) return [];
        const khoRef = doc(db, "warehouseData", kho);
        try { const docSnap = await getDoc(khoRef); return docSnap.exists() ? (docSnap.data().personalRevenueTables || []) : []; } catch(e) { return []; }
    },

    // --- [NEW] BẢNG HIỆU QUẢ CÁ NHÂN ---
    async savePersonalPerformanceTables(kho, tables) {
        const db = getDB();
        if (!db || !kho) return;
        const personalTables = tables.filter(t => !t.isSystem);
        const khoRef = doc(db, "warehouseData", kho);
        try { 
            await setDoc(khoRef, { 
                personalPerformanceTables: personalTables, 
                updatedAt: serverTimestamp() 
            }, { merge: true }); 
        } catch (error) { throw error; }
    },

    async loadPersonalPerformanceTables(kho) {
        const db = getDB();
        if (!db || !kho) return [];
        const khoRef = doc(db, "warehouseData", kho);
        try { 
            const docSnap = await getDoc(khoRef); 
            return docSnap.exists() ? (docSnap.data().personalPerformanceTables || []) : []; 
        } catch(e) { 
            console.error("Lỗi tải bảng hiệu quả cá nhân:", e);
            return []; 
        }
    },
    // --- END NEW ---

    async saveCustomMetrics(kho, metrics) {
        const db = getDB();
        if (!db || !kho) return;
        const khoRef = doc(db, "warehouseData", kho);
        try { await setDoc(khoRef, { customMetrics: metrics, updatedAt: serverTimestamp() }, { merge: true }); } catch (error) { throw error; }
    },

    async loadCustomMetrics(kho) {
        const db = getDB();
        if (!db || !kho) return [];
        const khoRef = doc(db, "warehouseData", kho);
        try { const docSnap = await getDoc(khoRef); return docSnap.exists() ? (docSnap.data().customMetrics || []) : []; } catch(e) { return []; }
    },

    async saveMetadataToFirestore(kho, dataType, metadata) {
        const db = getDB();
        if (!db || !kho) throw new Error("Invalid parameters.");
        const khoRef = doc(db, "warehouseData", kho);
        const dataToSave = { [dataType]: { ...metadata, updatedAt: serverTimestamp(), updatedBy: getCurrentUserEmail() } };
        try { await setDoc(khoRef, dataToSave, { merge: true }); } catch(e) { throw e; }
    },

    async savePastedDataToFirestore(kho, dataType, content, versionInfo) {
        const db = getDB();
        if (!db || !kho) throw new Error("Invalid parameters.");
        const khoRef = doc(db, "warehouseData", kho);
        const dataToSave = { [dataType]: { content, ...versionInfo, updatedAt: serverTimestamp(), updatedBy: getCurrentUserEmail() } };
        try { await setDoc(khoRef, dataToSave, { merge: true }); } catch(e) { throw e; }
    },

    async saveCompetitionConfigs(kho, configs) {
        const db = getDB();
        if (!db || !kho) return;
        const khoRef = doc(db, "warehouseData", kho);
        try { await setDoc(khoRef, { competitionConfigs: configs, updatedAt: serverTimestamp() }, { merge: true }); } catch (error) { throw error; }
    },

    async loadCompetitionConfigs(kho) {
        const db = getDB();
        if (!db || !kho) return [];
        const khoRef = doc(db, "warehouseData", kho);
        try { const docSnap = await getDoc(khoRef); return docSnap.exists() ? (docSnap.data().competitionConfigs || []) : []; } catch(e) { return []; }
    },

    async saveSpecialPrograms(kho, programs) {
        const db = getDB();
        if (!db || !kho) return;
        const khoRef = doc(db, "warehouseData", kho);
        try { await setDoc(khoRef, { specialPrograms: programs, updatedAt: serverTimestamp() }, { merge: true }); } catch (error) { throw error; }
    },

    async saveWarehouseMetadata(kho, key, metadata) {
        const db = getDB();
        if (!db || !kho) return;
        const khoRef = doc(db, "warehouseData", kho);
        const dataToSave = { [key]: { ...metadata, updatedAt: serverTimestamp(), updatedBy: getCurrentUserEmail() } };
        try { await setDoc(khoRef, dataToSave, { merge: true }); } catch (error) { throw error; }
    },

    async loadWarehouseData(kho) {
        const db = getDB();
        if (!db || !kho) return null;
        const khoRef = doc(db, "warehouseData", kho);
        try { const docSnap = await getDoc(khoRef); return docSnap.exists() ? docSnap.data() : null; } catch (error) { throw error; }
    }
};
--- END FILE: ./src/services/datasync.service.js ---

--- START FILE: ./src/services/employeeService.js ---
// src/services/employeeService.js
// Version 1.1 - Fix Warehouse Selector auto-reset bug on F5
// MỤC ĐÍCH: Chỉ quản lý state của nhân viên và kho.
import { get } from 'svelte/store';
import {
    danhSachNhanVien,
    employeeMaNVMap,
    employeeNameToMaNVMap,
    warehouseList,
    selectedWarehouse
} from '../stores.js';

/**
 * Logic "Tự động lắng nghe".
 * Tự động chạy mỗi khi store 'danhSachNhanVien' bị thay đổi.
 */
danhSachNhanVien.subscribe($danhSachNhanVien => {
    const newMaNVMap = new Map();
    const newNameMap = new Map();
    const newWarehouseList = new Set(); 

    if (!$danhSachNhanVien || $danhSachNhanVien.length === 0) {
        console.warn("[EmployeeService] DSNV rỗng, không thể tạo maps và danh sách kho.");
    } else {
        $danhSachNhanVien.forEach(nv => {
            if (nv.maNV) newMaNVMap.set(String(nv.maNV).trim(), nv);
            if (nv.hoTen) newNameMap.set(nv.hoTen.toLowerCase().replace(/\s+/g, ' '), String(nv.maNV).trim());
            if (nv.maKho) newWarehouseList.add(String(nv.maKho).trim());
        });
  
        console.log(`[EmployeeService] Đã tự động cập nhật Employee Maps: ${newMaNVMap.size} MSNV, ${newNameMap.size} Tên.`);
    }

    // Cập nhật các stores
    employeeMaNVMap.set(newMaNVMap);
    employeeNameToMaNVMap.set(newNameMap);
    
    const sortedWarehouses = [...newWarehouseList].sort();
    warehouseList.set(sortedWarehouses);
    
    // Tự động chọn kho đã lưu
    const savedWarehouse = localStorage.getItem('selectedWarehouse');
    const currentSelected = get(selectedWarehouse);

    if (savedWarehouse && newWarehouseList.has(savedWarehouse)) {
        // Trường hợp 1: Có kho lưu trong LocalStorage và nó hợp lệ trong danh sách mới
        if (currentSelected !== savedWarehouse) {
            selectedWarehouse.set(savedWarehouse);
            console.log(`[EmployeeService] Đã tự động chọn kho đã lưu: ${savedWarehouse}`);
        }
    } else if (currentSelected) {
        // Trường hợp 2: Đang có kho được chọn trong Store
        // [FIX] Chỉ reset nếu danh sách kho MỚI có dữ liệu (đã tải xong) nhưng không chứa kho hiện tại.
        // Nếu danh sách rỗng (đang tải), GIỮ NGUYÊN để tránh reset nhầm khi F5.
        if (newWarehouseList.size > 0 && !newWarehouseList.has(currentSelected)) {
            selectedWarehouse.set(null);
            localStorage.removeItem('selectedWarehouse');
            console.warn(`[EmployeeService] Kho đã chọn (${currentSelected}) không còn tồn tại trong danh sách mới. Đã reset.`);
        } else {
             console.log(`[EmployeeService] Giữ nguyên kho ${currentSelected} (Danh sách kho đang tải hoặc kho hợp lệ).`);
        }
    }
});
--- END FILE: ./src/services/employeeService.js ---

--- START FILE: ./src/services/excel.service.js ---
/* global XLSX */
import { notificationStore } from '../stores.js'; // [FIX] Dùng Store thay vì file lẻ

export const excelService = {
    /**
     * Xuất bảng HTML ra file Excel
     * @param {HTMLElement} tableElement - Element bảng hoặc container chứa bảng
     * @param {string} fileName - Tên file muốn lưu
     */
    exportTableToExcel(tableElement, fileName) {
        if (!tableElement) {
            notificationStore.show('Không tìm thấy nội dung để xuất.', 'error'); // [FIX]
            return;
        }

        // Tìm thẻ table bên trong nếu element truyền vào là container
        let table = tableElement.tagName === 'TABLE' 
            ? tableElement 
            : tableElement.querySelector('table');

        if (!table) {
            table = tableElement.querySelector('.department-block table, #sknv-summary-container table, #luyke-competition-content table');
        }

        if (!table) {
            notificationStore.show('Không tìm thấy bảng dữ liệu trong khu vực này để xuất.', 'error'); // [FIX]
            return;
        }

        try {
            const wb = XLSX.utils.table_to_book(table, { sheet: "Sheet1" });
            XLSX.writeFile(wb, `${fileName}.xlsx`);
            notificationStore.show(`Đã xuất file ${fileName}.xlsx thành công!`, 'success'); // [FIX]
        } catch (e) {
            console.error('[ExcelService] Lỗi xuất Excel:', e);
            notificationStore.show('Có lỗi xảy ra khi xuất file Excel.', 'error'); // [FIX]
        }
    }
};
--- END FILE: ./src/services/excel.service.js ---

--- START FILE: ./src/services/firebase.service.js ---
// src/services/firebase.service.js
// Version 3.0 - Switch to Legacy Firebase Project (qlst-9e6bd)
import { initializeApp } from "firebase/app";
import { getAuth } from "firebase/auth";
import { getFirestore } from "firebase/firestore";
import { getStorage } from "firebase/storage";
import { firebaseStore } from '../stores.js';

// Config từ dự án gốc "qlst-9e6bd"
const firebaseConfig = {
  apiKey: "AIzaSyAQ3TWcpa4AnTN-32igGseYDlXrCf1BVew",
  authDomain: "qlst-9e6bd.firebaseapp.com",
  projectId: "qlst-9e6bd",
  storageBucket: "qlst-9e6bd.firebasestorage.app",
  messagingSenderId: "2316705291",
  appId: "1:2316705291:web:ebec2963816aea7585b10e",
  measurementId: "G-M0SM0XHCEK"
};

export const firebaseService = {
    initCore() {
        try {
            console.log("[FirebaseService] Initializing Legacy Firebase (qlst-9e6bd)...");
            const app = initializeApp(firebaseConfig);
            const auth = getAuth(app);
            const db = getFirestore(app);
            const storage = getStorage(app);

            // Cập nhật store để các service khác sử dụng
            firebaseStore.set({
                app,
                auth,
                db,
                storage
            });

            console.log("[FirebaseService] Firebase initialized successfully!");
            return { app, auth, db, storage };
        } catch (error) {
            console.error("[FirebaseService] Initialization failed:", error);
            return null;
        }
    }
};
--- END FILE: ./src/services/firebase.service.js ---

--- START FILE: ./src/services/modal.service.js ---
// Version 1.0 - Initial Svelte refactor
// MODULE: UI MODAL MANAGER
// Chứa các hàm thuần túy để quản lý trạng thái hiển thị của Modals và Drawers.
// Tái cấu trúc từ file ui-modal-manager.js gốc

export const modalManager = {
    /**
     * Bật hoặc tắt một modal.
     * @param {string} modalId - ID của modal (ví dụ: 'login-modal').
     * @param {boolean} show - True để hiện, false để ẩn.
     */
    toggleModal(modalId, show) {
        const modal = document.getElementById(modalId);
        if (!modal) return;
        modal.classList.toggle('hidden', !show);
    },

    /**
     * Bật hoặc tắt một drawer (thanh cài đặt bên).
     * @param {string} drawerId - ID của drawer (ví dụ: 'interface-drawer').
     * @param {boolean} show - True để hiện, false để ẩn.
     */
    toggleDrawer(drawerId, show) {
        const drawer = document.getElementById(drawerId);
        const sidebar = document.getElementById('sidebar');
        const overlay = document.getElementById('drawer-overlay');

        if (!drawer || !sidebar || !overlay) return;
        if (show) {
            drawer.classList.remove('hidden');
            setTimeout(() => {
                drawer.classList.add('open');
                 sidebar.classList.add('menu-locked');
                 overlay.classList.remove('hidden');
            }, 10);
        } else {
            drawer.classList.remove('open');
            sidebar.classList.remove('menu-locked');
            overlay.classList.add('hidden');
            setTimeout(() => {
                 if (!drawer.classList.contains('open')) {
                     drawer.classList.add('hidden');
                 }
             }, 300);
        }
    },

    /**
     * Đóng tất cả các drawer đang mở.
     */
    closeAllDrawers() {
        // Chúng ta gọi hàm `toggleDrawer` nội bộ
        this.toggleDrawer('interface-drawer', false);
        this.toggleDrawer('goal-drawer', false);
    },
};
--- END FILE: ./src/services/modal.service.js ---

--- START FILE: ./src/services/processing/helpers.js ---
/* global XLSX */
import { get } from 'svelte/store';
import { config } from '../../config.js';
import { declarations } from '../../stores.js';

export const helpers = {
    findColumnName(header, aliases) {
        for (const colName of header) {
            const processedColName = String(colName || '').trim().toLowerCase();
            if (aliases.includes(processedColName)) {
                return colName;
            }
        }
        return null;
    },

    getHinhThucXuatTinhDoanhThu: () => {
        const declarationData = get(declarations).hinhThucXuat;
        if (declarationData) return new Set(declarationData.split('\n').map(l => l.trim()).filter(Boolean));
        return new Set(config.DEFAULT_DATA.HINH_THUC_XUAT_TINH_DOANH_THU);
    },

    getHinhThucXuatTraGop: () => {
        const declarationData = get(declarations).hinhThucXuatGop;
        if (declarationData) return new Set(declarationData.split('\n').map(l => l.trim()).filter(Boolean));
        return new Set(config.DEFAULT_DATA.HINH_THUC_XUAT_TRA_GOP);
    },

    getHeSoQuyDoi: () => {
        const declarationData = get(declarations).heSoQuyDoi;
        const heSoMap = {};
        if (declarationData) {
            declarationData.split('\n').filter(l => l.trim()).forEach(line => {
                const parts = line.split(',');
                if (parts.length >= 2) {
                    const key = parts[0].trim();
                    const value = parseFloat(parts[1].trim());
                    if (key && !isNaN(value)) heSoMap[key] = value;
                }
            });
            return Object.keys(heSoMap).length > 0 ? heSoMap : config.DEFAULT_DATA.HE_SO_QUY_DOI;
        }
        return config.DEFAULT_DATA.HE_SO_QUY_DOI;
    },

    cleanCompetitionName(name) {
        return name.replace(/thi đua doanh thu bán hàng|thi đua doanh thu|thi đua số lượng/gi, "").trim();
    },

    classifyInsurance: (productName) => {
        if (!productName || typeof productName !== 'string') return null;
        const name = productName.trim().toLowerCase();
        if (name.includes('bảo hành mở rộng')) return 'BHMR';
        if (name.includes('1 đổi 1')) return 'BH1d1';
        if (name.includes('khoản vay')) return 'BHKV';
        if (name.includes('rơi vỡ')) return 'BHRV';
        if (name.includes('samsung care+')) return 'BHSC';
        if (name.includes('ô tô') || name.includes('vật chất ô tô')) return 'BHOTO';
        if (name.includes('xe máy') || name.includes('xe moto')) return 'BHXM';
        if (name.includes('xã hội') || name.includes('y tế')) return 'BHYT';
        return null;
    },

    findHeaderAndProcess(sheet, requiredKeywords) {
        if (!sheet) return [];
        const rows = XLSX.utils.sheet_to_json(sheet, { header: 1, defval: null });
        if (rows.length === 0) return [];

        let headerRowIndex = -1;
        let foundHeaders = [];

        for (let i = 0; i < Math.min(rows.length, 10); i++) {
            const row = rows[i];
            const lowerCaseRow = row.map(cell => String(cell || '').trim().toLowerCase());

            const allKeywordsFound = requiredKeywords.every(keyword =>
                lowerCaseRow.some(cell => cell.includes(keyword))
            );

            if (allKeywordsFound) {
                headerRowIndex = i;
                foundHeaders = rows[i].map(cell => String(cell || '').trim());
                break;
            }
        }

        if (headerRowIndex === -1) {
            throw new Error(`Không tìm thấy dòng tiêu đề chứa đủ các từ khóa: ${requiredKeywords.join(', ')}.`);
        }

        const dataRows = rows.slice(headerRowIndex + 1);
        const jsonData = dataRows.map(row => {
            const obj = {};
            foundHeaders.forEach((header, index) => {
                if (header) {
                    const value = row[index];
                    const upperKey = header.toUpperCase();
                    if (upperKey.includes('KÊNH') || upperKey.includes('SIÊU THỊ') || upperKey.includes('NGÀNH HÀNG') || upperKey.includes('TỈNH') || upperKey.includes('BOSS')) {
                        obj[header] = value;
                    } else if (typeof value === 'string' && value.includes('%')) {
                        obj[header] = parseFloat(value.replace(/%|,/g, '')) / 100 || 0;
                    } else if (value !== null && value !== undefined) {
                        obj[header] = parseFloat(String(value).replace(/,/g, '')) || 0;
                    } else {
                        obj[header] = 0;
                    }
                }
            });
            return obj;
        }).filter(obj => {
            const supermarketKey = Object.keys(obj).find(k => k.toLowerCase().includes('siêu thị'));
            return supermarketKey && obj[supermarketKey];
        });

        return jsonData;
    }
};
--- END FILE: ./src/services/processing/helpers.js ---

--- START FILE: ./src/services/processing/logic/competition.processor.js ---
// src/services/processing/logic/competition.processor.js
import { get } from 'svelte/store';
import { 
    danhSachNhanVien, 
    employeeMaNVMap, 
    competitionNameMappings, 
    debugInfo 
} from '../../../stores.js';
import { helpers } from '../helpers.js';
import { normalizers } from '../normalizers.js';

export const competitionProcessor = {
    // 1. Kiểm tra logic lọc (Debug)
    debugCompetitionFiltering(rawTestData) {
        if (!rawTestData || rawTestData.length === 0) return [];

        const { normalizedData } = normalizers.normalizeData(rawTestData, 'ycx');
        if (normalizedData.length === 0) return [];

        const hinhThucXuatTinhDoanhThu = helpers.getHinhThucXuatTinhDoanhThu();
        const debugResults = normalizedData.map(row => {
            const checks = {
                isDoanhThuHTX: hinhThucXuatTinhDoanhThu.has(row.hinhThucXuat),
                isThuTien: (row.trangThaiThuTien || "").trim() === 'Đã thu',
                isChuaHuy: (row.trangThaiHuy || "").trim() === 'Chưa hủy',
                isChuaTra: (row.tinhTrangTra || "").trim() === 'Chưa trả',
                isDaXuat: (row.trangThaiXuat || "").trim() === 'Đã xuất'
            };
            const isOverallValid = checks.isDoanhThuHTX && checks.isThuTien && checks.isChuaHuy && checks.isChuaTra && checks.isDaXuat;
            return { rowData: row, checks: checks, isOverallValid: isOverallValid };
        });
        return debugResults;
    },

    // 2. Cập nhật mapping tên thi đua
    updateCompetitionNameMappings(mainHeaders) {
        if (!mainHeaders || mainHeaders.length === 0) return;
        
        const oldMappings = get(competitionNameMappings) || {};
        const newMappings = { ...oldMappings };
        let hasChanges = false;

        mainHeaders.forEach(originalName => {
            // Chỉ thêm nếu tên này chưa tồn tại trong mapping
            if (!newMappings.hasOwnProperty(originalName)) {
                // [YÊU CẦU] Mặc định điền tên rút gọn = tên gốc
                newMappings[originalName] = originalName; 
                hasChanges = true;
            }
        });

        if (hasChanges) {
            console.log("[Processors] Phát hiện tên thi đua mới, cập nhật store mapping.");
            competitionNameMappings.set(newMappings);
        }
    },

    // 3. Xử lý dữ liệu thi đua nhân viên (Core Logic)
    processThiDuaNhanVienData(parsedData, luykeCompetitionData) {
        const { mainHeaders, subHeaders, dataRows } = parsedData;
        const newDebugInfo = { required: [], found: [], status: 'Đang xử lý...' };
        
        const $danhSachNhanVien = get(danhSachNhanVien);
        if ($danhSachNhanVien.length === 0) {
            newDebugInfo.status = 'Lỗi: Danh sách nhân viên (DSNV) chưa được tải lên.';
            debugInfo.update(current => ({ ...current, 'thiduanv-pasted': newDebugInfo }));
            return [];
        }
        if (mainHeaders.length === 0 || dataRows.length === 0 || subHeaders.length === 0) {
            newDebugInfo.status = 'Lỗi: Dữ liệu dán vào không hợp lệ.';
            debugInfo.update(current => ({ ...current, 'thiduanv-pasted': newDebugInfo }));
            return [];
        }

        // [QUAN TRỌNG] Gọi hàm cập nhật mapping ngay khi xử lý dữ liệu
        this.updateCompetitionNameMappings(mainHeaders);

        const nameMappings = get(competitionNameMappings) || {};
        const competitionTargets = (luykeCompetitionData || []).map(comp => ({
            ...comp,
            cleanedName: helpers.cleanCompetitionName(comp.name)
        }));
        
        const finalReport = [];
        const totalEmployeesInDSNV = $danhSachNhanVien.length;
        const $employeeMaNVMap = get(employeeMaNVMap);

        dataRows.forEach(row => {
            const nameParts = row.name.split(' - ');
            const msnv = nameParts.length > 1 ? nameParts[nameParts.length - 1].trim() : null;

            let employee;
            if (msnv) {
                employee = $employeeMaNVMap.get(msnv);
            }

            if (!employee) {
                employee = { hoTen: row.name, maNV: msnv || 'N/A', boPhan: 'Nhân viên không tìm thấy' };
            }

            const employeeResult = {
                maNV: employee.maNV,
                hoTen: employee.hoTen,
                boPhan: employee.boPhan,
                completedCount: 0,
                totalCompetitions: mainHeaders.length,
                competitions: []
            };

            for (let i = 0; i < mainHeaders.length; i++) {
                const originalName = mainHeaders[i];
                const loaiSoLieu = subHeaders[i];
                
                // [YÊU CẦU] Lấy tên rút gọn từ mapping, fallback về tên gốc
                const shortName = nameMappings[originalName] || originalName;
                
                const cleanedName = helpers.cleanCompetitionName(originalName);
                const matchedTarget = competitionTargets.find(t => t.cleanedName === cleanedName);
                const groupTarget = matchedTarget ? matchedTarget.target : 0;
                const individualTarget = totalEmployeesInDSNV > 0 ? groupTarget / totalEmployeesInDSNV : 0;

                const giaTri = parseFloat(String(row.values[i] || '0').replace(/,/g, '')) || 0;
                const actualSales = giaTri;
                const percentExpected = individualTarget > 0 ? actualSales / individualTarget : (actualSales > 0 ? Infinity : 0);
                
                if (percentExpected >= 1) employeeResult.completedCount++;

                employeeResult.competitions.push({
                    tenNganhHang: shortName, // Dùng tên rút gọn cho hiển thị
                    tenGoc: originalName,    // Giữ tên gốc để đối chiếu
                    loaiSoLieu: loaiSoLieu,
                    giaTri: giaTri,
                    thucHien: actualSales,
                    mucTieu: individualTarget,
                    percentExpected: percentExpected,
                });
            }

            employeeResult.completionRate = employeeResult.totalCompetitions > 0 ? employeeResult.completedCount / employeeResult.totalCompetitions : 0;
            finalReport.push(employeeResult);
        });

        newDebugInfo.status = `Thành công: Đã xử lý báo cáo cho ${finalReport.length} nhân viên.`;
        debugInfo.update(current => ({ ...current, 'thiduanv-pasted': newDebugInfo }));
        return finalReport;
    }
};
--- END FILE: ./src/services/processing/logic/competition.processor.js ---

--- START FILE: ./src/services/processing/logic/dynamicTable.processor.js ---
/* src/services/processing/logic/dynamicTable.processor.js */
import { get } from 'svelte/store';
import { formatters } from '../../../utils/formatters.js';
import { parseIdentity } from '../../../utils.js';
import { macroCategoryConfig, macroProductGroupConfig } from '../../../stores.js';

// Helper: Làm sạch và ép kiểu số an toàn
const getSafeNumber = (value) => {
    if (typeof value === 'number') return value;
    if (!value) return 0;
    if (typeof value === 'string') {
        const cleanStr = value.replace(/[^0-9.-]+/g, ""); 
        return parseFloat(cleanStr) || 0;
    }
    return 0;
};

// [FIX] Helper: Lấy giá trị từ object, trả về ngay khi tìm thấy key tồn tại (kể cả 0)
const getValueFromMultiKeys = (obj, keys) => {
    if (!obj) return 0;
    for (const key of keys) {
        if (obj[key] !== undefined && obj[key] !== null) {
            // Nếu key tồn tại, trả về giá trị ngay lập tức, không bỏ qua số 0
            return getSafeNumber(obj[key]);
        }
    }
    return 0;
};

export const dynamicTableProcessor = {
    // Tìm dữ liệu trong object nhân viên theo ID (O(1))
    findItemData(employee, targetId) {
        if (!employee || !targetId) return null;
        
        // 1. Chuẩn hóa ID
        const parsed = parseIdentity(targetId);
        // Trim khoảng trắng thừa trong ID nếu có. Chuyển về string để so khớp key object.
        const searchKey = (parsed.id !== 'unknown' ? parsed.id : targetId).toString().trim();

        // 2. Ưu tiên tìm trong Nhóm Hàng
        if (employee.doanhThuTheoNhomHang && employee.doanhThuTheoNhomHang[searchKey]) {
            return employee.doanhThuTheoNhomHang[searchKey];
        }
        // 3. Tìm trong Ngành Hàng
        if (employee.doanhThuTheoNganhHang && employee.doanhThuTheoNganhHang[searchKey]) {
            return employee.doanhThuTheoNganhHang[searchKey];
        }
        
        return null;
    },

    /**
     * Tính tổng giá trị từ danh sách ID
     */
    calculateGroupValue(employee, items, type = 'DT') {
        if (!items || items.length === 0) return 0;

        const macroCats = get(macroCategoryConfig) || [];
        const macroGroups = get(macroProductGroupConfig) || [];

        let total = 0;
        const processedIds = new Set();

        const processId = (id) => {
            // Chuẩn hóa ID input
            const safeId = id ? id.toString().trim() : '';
            if (!safeId || processedIds.has(safeId)) return;
            
            // 1. Check Macro Category
            const macroCat = macroCats.find(m => m.id == safeId || m.name === safeId);
            if (macroCat && macroCat.items) {
                processedIds.add(safeId);
                macroCat.items.forEach(childId => processId(childId));
                return;
            }

            // 2. Check Macro Product Group
            const macroGroup = macroGroups.find(m => m.id == safeId || m.name === safeId);
            if (macroGroup && macroGroup.items) {
                processedIds.add(safeId);
                macroGroup.items.forEach(childId => processId(childId));
                return;
            }

            // 3. Raw ID
            const data = this.findItemData(employee, safeId);
            if (data) {
                processedIds.add(safeId);
                
                if (type === 'SL') {
                    // Tìm trong quantity, soLuong, sl
                    total += getValueFromMultiKeys(data, ['quantity', 'soLuong', 'sl', 'count']);
                } else if (type === 'DTQD') {
                    // Tìm trong revenueQuyDoi, doanhThuQuyDoi
                    total += getValueFromMultiKeys(data, ['revenueQuyDoi', 'doanhThuQuyDoi', 'dtqd']);
                } else {
                    // Mặc định là DT (Doanh thu)
                    // [FIX] Ưu tiên 'revenue' vì salesProcessor lưu vào biến này
                    total += getValueFromMultiKeys(data, ['revenue', 'doanhThu', 'thanhTien', 'totalPrice', 'dt']);
                }
            }
        };

        items.forEach(id => processId(id));
        return total;
    },

    // --- REWRITE: Xử lý dữ liệu bảng toàn diện ---
    processTableData(reportData, config) {
        if (!reportData || !config) return { processedData: [], totals: {} };

        // 1. Chuẩn bị danh sách cột cần tính
        const mainColConfig = config.mainColumn ? { ...config.mainColumn, id: 'mainValue', isMain: true } : null;
        const subColsConfig = config.subColumns || [];
        const effectiveSubCols = config.columns || subColsConfig;
        
        const allColumnsToProcess = mainColConfig ? [mainColConfig, ...effectiveSubCols] : [...effectiveSubCols];

        // 2. Khởi tạo dòng tổng
        const totalRow = {
            maNV: 'TOTAL',
            hoTen: 'TỔNG CỘNG',
            isTotal: true,
            cells: {} 
        };

        // 3. Loop qua từng nhân viên
        const processedData = reportData.map(employee => {
            const row = {
                maNV: employee.maNV,
                hoTen: employee.hoTen,
                mucTieu: employee.mucTieu || {},
                cells: {}
            };

            let hasAnyData = false;

            allColumnsToProcess.forEach(col => {
                const colId = col.id || col.header;
                
                // Khởi tạo object cell
                const cellData = {
                    sl: 0,
                    dt: 0,
                    dtqd: 0,
                    value: 0,
                    display: '',
                    config: col
                };

                // --- LOGIC TÍNH TOÁN ---
                if (col.type === 'PERCENT') {
                    // Logic % (Bảng hiệu quả)
                    const numVal = this.calculateGroupValue(employee, col.numerator, col.typeA || 'DT');
                    const denVal = this.calculateGroupValue(employee, col.denominator, col.typeB || 'DT');
                    const val = denVal > 0 ? numVal / denVal : 0;
                    
                    cellData.value = val;
                    cellData.display = formatters.formatPercentage(val);
                    
                    if (numVal > 0 || denVal > 0) hasAnyData = true;

                    if (!totalRow.cells[colId]) totalRow.cells[colId] = { num: 0, den: 0, type: 'PERCENT' };
                    totalRow.cells[colId].num += numVal;
                    totalRow.cells[colId].den += denVal;

                } else {
                    // --- LOGIC DOANH THU: Tính ĐỦ cả 3 chỉ số ---
                    cellData.sl = this.calculateGroupValue(employee, col.items, 'SL');
                    cellData.dt = this.calculateGroupValue(employee, col.items, 'DT');
                    cellData.dtqd = this.calculateGroupValue(employee, col.items, 'DTQD');

                    // Xác định giá trị chính
                    if (col.type === 'SL') {
                        cellData.value = cellData.sl;
                        cellData.display = formatters.formatNumber(cellData.sl);
                    } else if (col.type === 'DTQD') {
                        cellData.value = cellData.dtqd;
                        cellData.display = formatters.formatRevenue(cellData.dtqd);
                    } else {
                        cellData.value = cellData.dt; // Mặc định DT
                        cellData.display = formatters.formatRevenue(cellData.dt);
                    }

                    // Đánh dấu có dữ liệu (Chỉ cần 1 trong 3 chỉ số > 0)
                    if (cellData.value > 0 || cellData.sl > 0 || cellData.dt > 0 || cellData.dtqd > 0) hasAnyData = true;

                    // Cộng dồn cho dòng tổng
                    if (!totalRow.cells[colId]) totalRow.cells[colId] = { sl: 0, dt: 0, dtqd: 0, val: 0, type: col.type || 'DT' };
                    totalRow.cells[colId].sl += cellData.sl;
                    totalRow.cells[colId].dt += cellData.dt;
                    totalRow.cells[colId].dtqd += cellData.dtqd;
                    totalRow.cells[colId].val += cellData.value;
                }

                // Map vào row
                row.cells[colId] = cellData;
                
                // Map phẳng cho Main Column (Sorting support)
                if (col.isMain) {
                    row.mainValue = cellData.value;
                    row.mainValue_sl = cellData.sl;
                    row.mainValue_dtqd = cellData.dtqd;
                }
            });

            return hasAnyData ? row : null;
        }).filter(Boolean);

        // 4. Finalize dòng tổng
        Object.keys(totalRow.cells).forEach(key => {
            const cell = totalRow.cells[key];
            if (cell.type === 'PERCENT') {
                const val = cell.den > 0 ? cell.num / cell.den : 0;
                cell.value = val;
                cell.display = formatters.formatPercentage(val);
            } else {
                if (cell.type === 'SL') cell.display = formatters.formatNumber(cell.val);
                else cell.display = formatters.formatRevenue(cell.val);
                cell.value = cell.val;
                
                if (key === 'mainValue') {
                    totalRow.mainValue = cell.val;
                    totalRow.mainValue_sl = cell.sl;
                    totalRow.mainValue_dtqd = cell.dtqd;
                }
            }
        });

        return { processedData, totals: totalRow };
    },

    // Hàm sắp xếp
    sortTableData(data, key, direction) {
        return [...data].sort((a, b) => {
            if (key === 'hoTen') {
                return direction === 'asc' ? a.hoTen.localeCompare(b.hoTen) : b.hoTen.localeCompare(a.hoTen);
            }
            const valA = a.cells[key]?.value ?? a[key] ?? 0;
            const valB = b.cells[key]?.value ?? b[key] ?? 0;
            return direction === 'asc' ? valA - valB : valB - valA;
        });
    }
};
--- END FILE: ./src/services/processing/logic/dynamicTable.processor.js ---

--- START FILE: ./src/services/processing/logic/regional.processor.js ---
// src/services/processing/logic/regional.processor.js
import { helpers } from '../helpers.js';

export const regionalProcessor = {
    // Xử lý file Excel Thi Đua Vùng
    processThiDuaVungFile(workbook) {
        const sheetNames = workbook.SheetNames;
        
        const chiTietSheetName = sheetNames.find(name => {
            const upperName = name.toUpperCase();
            return upperName.includes('CHITIET') || upperName.includes('CHI TIẾT');
        });
        
        const tongSheetName = sheetNames.find(name => {
            const upperName = name.toUpperCase();
            return upperName.includes('TONG') || upperName.includes('SIEU THI');
        });

        const chiTietSheet = chiTietSheetName ? workbook.Sheets[chiTietSheetName] : null;
        const tongSheet = tongSheetName ? workbook.Sheets[tongSheetName] : null;

        if (!chiTietSheet || !tongSheet) {
            throw new Error('File Excel phải chứa sheet (CHITIET/CHI TIẾT) và (TONG/SIEU THI).');
        }
        
        const chiTietData = helpers.findHeaderAndProcess(chiTietSheet, ['siêu thị', 'ngành hàng', 'kênh']);
        const tongData = helpers.findHeaderAndProcess(tongSheet, ['siêu thị', 'tổng thưởng']);

        return { chiTietData, tongData };
    }
};
--- END FILE: ./src/services/processing/logic/regional.processor.js ---

--- START FILE: ./src/services/processing/logic/timekeeping.processor.js ---
// src/services/processing/logic/timekeeping.processor.js
import { get } from 'svelte/store';
import { rawGioCongData, employeeNameToMaNVMap } from '../../../stores.js';

export const timekeepingProcessor = {
    // Xử lý dữ liệu giờ công
    processGioCongData() {
        const gioCongByMSNV = {};
        let currentMaNV = null;
        if (!get(rawGioCongData) || get(rawGioCongData).length === 0) return gioCongByMSNV;

        for (const row of get(rawGioCongData)) {
            const maNV = String(row.maNV || '').trim();
            const hoTen = String(row.hoTen || '').trim().replace(/\s+/g, ' ');
            
            // Tìm MSNV nếu file giờ công không có cột MSNV (dùng tên để map)
            let foundMaNV = maNV || get(employeeNameToMaNVMap).get(hoTen.toLowerCase()) || null;
            
            if (foundMaNV) currentMaNV = foundMaNV;

            if (currentMaNV && gioCongByMSNV[currentMaNV] === undefined) {
                gioCongByMSNV[currentMaNV] = 0;
            }

            const gioCongValue = parseFloat(String(row.tongGioCong || '0').replace(/,/g, '')) || 0;
            if (currentMaNV && gioCongValue > 0) {
                gioCongByMSNV[currentMaNV] += gioCongValue;
            }
        }
        return gioCongByMSNV;
    }
};
--- END FILE: ./src/services/processing/logic/timekeeping.processor.js ---

--- START FILE: ./src/services/processing/normalizers.js ---
import { config } from '../../config.js';
import { debugInfo, rawGioCongData } from '../../stores.js';
import { helpers } from './helpers.js';

export const normalizers = {
    normalizeCategoryStructureData(rawData) {
        if (!rawData || rawData.length === 0) {
            return { success: false, error: 'File rỗng.', normalizedData: [] };
        }
        const header = Object.keys(rawData[0] || {});
        
        const nganhHangCol = helpers.findColumnName(header, ['ngành hàng', 'nganh hang']);
        const nhomHangCol = helpers.findColumnName(header, ['nhóm hàng', 'nhom hang']);
        const nhaSanXuatCol = helpers.findColumnName(header, ['nhà sản xuất', 'nha san xuat', 'hãng', 'brand']);

        const missingCols = [];
        if (!nganhHangCol) missingCols.push('"Ngành hàng"');
        if (!nhomHangCol) missingCols.push('"Nhóm hàng"');
        if (!nhaSanXuatCol) missingCols.push('"Nhà sản xuất"');

        if (missingCols.length > 0) {
            return { success: false, error: `File thiếu các cột: ${missingCols.join(', ')}`, normalizedData: [] };
        }

        const normalizedData = rawData
            .map(row => ({
                nganhHang: String(row[nganhHangCol] || '').trim(),
                nhomHang: String(row[nhomHangCol] || '').trim(),
                nhaSanXuat: String(row[nhaSanXuatCol] || '').trim(),
            }))
            .filter(item => item.nganhHang && item.nhomHang);
            
        return { success: true, normalizedData };
    },
    
    normalizeSpecialProductData(rawData) {
        if (!rawData || rawData.length === 0) {
            return { success: false, error: 'File rỗng.', normalizedData: [] };
        }
        const header = Object.keys(rawData[0] || {});
        const maSpCol = helpers.findColumnName(header, ['mã sản phẩm', 'masanpham', 'mã sp', 'product code']);
        const nhomHangCol = helpers.findColumnName(header, ['nhóm hàng', 'nhom hang']);
        const tenSpCol = helpers.findColumnName(header, ['tên sản phẩm', 'tensanpham', 'tên sp']);

        const missingColumns = [];
        if (!maSpCol) missingColumns.push('Mã sản phẩm');
        if (!nhomHangCol) missingColumns.push('Nhóm hàng');
        if (!tenSpCol) missingColumns.push('Tên sản phẩm');

        if (missingColumns.length > 0) {
            return { success: false, error: `File thiếu các cột bắt buộc: ${missingColumns.join(', ')}.`, normalizedData: [] };
        }

        const normalizedData = rawData
            .map(row => ({
                maSanPham: String(row[maSpCol] || '').trim(),
                nhomHang: String(row[nhomHangCol] || '').trim(),
                tenSanPham: String(row[tenSpCol] || '').trim(),
            }))
            .filter(item => item.maSanPham && item.nhomHang && item.tenSanPham);

        return { success: true, normalizedData };
    },

    normalizeBrandData(rawData) {
        if (!rawData || rawData.length === 0) {
             return { success: false, error: 'Sheet "Hãng" rỗng.', normalizedData: [] };
        }
        const header = Object.keys(rawData[0] || {});
        const brandCol = helpers.findColumnName(header, ['hãng', 'tên hãng', 'nhà sản xuất']);
        if (!brandCol) {
            return { success: false, error: 'Sheet "Hãng" phải có cột "Hãng" hoặc "Tên Hãng".', normalizedData: [] };
        }

        const normalizedData = rawData
            .map(row => String(row[brandCol] || '').trim())
            .filter(brand => brand);
        return { success: true, normalizedData: [...new Set(normalizedData)].sort() };
    },

    normalizeData(rawData, fileType) {
        const mapping = config.COLUMN_MAPPINGS[fileType];
        if (!mapping) {
            console.error(`No column mapping found for fileType: ${fileType}`);
            return { normalizedData: [], success: false, missingColumns: ['Unknown mapping'] };
        }

        if (!rawData || rawData.length === 0) {
            return { normalizedData: [], success: true, missingColumns: [] };
        }

        const header = Object.keys(rawData[0] || {});
        const foundMapping = {};
        let allRequiredFound = true;
        const missingColumns = [];

        const newDebugInfo = { required: [], found: header, firstFiveMsnv: [] };
        for (const key in mapping) {
            const { required, displayName, aliases } = mapping[key];
            const foundName = helpers.findColumnName(header, aliases);
            foundMapping[key] = foundName;

            if (required) {
                const status = !!foundName;
                newDebugInfo.required.push({ displayName, foundName: foundName || 'Không tìm thấy', status: status });
                if (!status) {
                    allRequiredFound = false;
                    missingColumns.push(displayName);
                }
            }
        }

        if (fileType === 'giocong' || fileType === 'thuongnong') {
            if (!foundMapping.maNV && !foundMapping.hoTen) {
                 allRequiredFound = false;
                const missingMsg = 'Mã NV hoặc Tên NV';
                missingColumns.push(missingMsg);
                if (!newDebugInfo.required.some(r => r.displayName.includes('NV'))) {
                     newDebugInfo.required.push({ displayName: missingMsg, foundName: 'Không tìm thấy', status: false });
                }
            }
        }

        if (!allRequiredFound) {
            debugInfo.update(currentInfo => ({ ...currentInfo, [fileType]: newDebugInfo }));
            return { normalizedData: [], success: false, missingColumns };
        }

        const normalizedData = rawData.map(row => {
            const newRow = {};
            for (const key in foundMapping) {
                if (foundMapping[key]) {
                    if (key === 'maNV' || key === 'hoTen' || key === 'maSanPham') {
                         newRow[key] = String(row[foundMapping[key]] || '').trim();
                    } else if ((key === 'ngayTao' || key === 'ngayHenGiao') && row[foundMapping[key]]) {
                        const dateValue = row[foundMapping[key]];
                        if (dateValue instanceof Date) {
                             newRow[key] = dateValue;
                        } else if (typeof dateValue === 'number') {
                            newRow[key] = new Date(Math.round((dateValue - 25569) * 86400 * 1000));
                        } else if (typeof dateValue === 'string') {
                             const parsedDate = new Date(dateValue.replace(/(\d{2})\/(\d{2})\/(\d{4})/, '$2/$1/$3'));
                            if (!isNaN(parsedDate.getTime())) newRow[key] = parsedDate;
                        }
                    } else {
                         newRow[key] = row[foundMapping[key]];
                    }
                }
            }
            return newRow;
        });

        if (fileType === 'giocong') {
            const giocongRawList = rawData.map(row => {
                const newRow = {};
                for (const key in foundMapping) {
                    if (foundMapping[key]) newRow[key] = row[foundMapping[key]];
                }
                return newRow;
            });
            rawGioCongData.set(giocongRawList);
        }

        newDebugInfo.firstFiveMsnv = normalizedData.slice(0, 5).map(r => r.maNV).filter(Boolean);
        debugInfo.update(currentInfo => ({ ...currentInfo, [fileType]: newDebugInfo }));
        
        return { normalizedData, success: true, missingColumns: [] };
    }
};
--- END FILE: ./src/services/processing/normalizers.js ---

--- START FILE: ./src/services/processing/parsers.js ---
// src/services/processing/parsers.js
import { erpParser } from './parsers/erp.parser.js';
import { luykeParser } from './parsers/luyke.parser.js';
import { thiduaParser } from './parsers/thidua.parser.js';

export const parsers = {
    // --- ERP Logic ---
    processThuongERP: erpParser.processThuongERP,

    // --- Luy Ke Logic ---
    parseLuyKePastedData: luykeParser.parseLuyKePastedData,
    parseCompetitionDataFromLuyKe: luykeParser.parseCompetitionDataFromLuyKe,

    // --- Thi Dua Nhan Vien Logic ---
    parsePastedThiDuaTableData: thiduaParser.parsePastedThiDuaTableData
};
--- END FILE: ./src/services/processing/parsers.js ---

--- START FILE: ./src/services/processing/parsers/erp.parser.js ---
// src/services/processing/parsers/erp.parser.js
export const erpParser = {
    processThuongERP: (pastedText) => {
        if (!pastedText || !pastedText.trim()) return [];
        const lines = pastedText.trim().split('\n');
        const results = [];
        // Regex để bắt dòng: "ĐML_... BP Tư Vấn... Nguyễn Văn A... 1,000,000"
        const regex = /(ĐML_|TGD|ĐMM|ĐMS).*?(BP .*?)(?:Nhân Viên|Trưởng Ca)(.*?)([\d,]+)$/;
        
        lines.forEach(line => {
            const match = line.replace(/\s+/g, ' ').match(regex);
            if (match) {
                results.push({ 
                    name: match[3].trim(), 
                    bonus: match[4].trim() 
                });
            }
        });
        return results;
    }
};
--- END FILE: ./src/services/processing/parsers/erp.parser.js ---

--- START FILE: ./src/services/processing/parsers/luyke.parser.js ---
// src/services/processing/parsers/luyke.parser.js
import { competitionData } from '../../../stores.js';

export const luykeParser = {
    // 1. Phân tích các chỉ số KPI chính (DT, DTQĐ, %HT)
    parseLuyKePastedData: (text) => {
        const defaults = {
            mainKpis: {},
            comparisonData: { value: 0, percentage: 'N/A' },
            luotKhachData: { value: 0, percentage: 'N/A' },
            dtDuKien: 0, dtqdDuKien: 0, dtTraCham: 0, tyLeTraCham: 0 
        };
        if (!text) return defaults;

        const allLines = text.split('\n').map(line => line.trim());
        const textContent = allLines.join(' ');

        const patterns = {
            'Thực hiện DT thực': /DTLK\s+([\d,.]+)/,
            'Thực hiện DTQĐ': /DTQĐ\s+([\d,.]+)/,
            '% HT Target Dự Kiến (QĐ)': /% HT Target Dự Kiến \(QĐ\)\s+([\d.]+%?)/,
        };

        for (const [key, regex] of Object.entries(patterns)) {
            const match = textContent.match(regex);
            if (match && match[1]) {
                defaults.mainKpis[key] = match[1];
            }
        }

        const findValueAfterKeyword = (lines, keyword, isQd = false) => {
            let keywordRegex;
            if (isQd) {
                keywordRegex = new RegExp(keyword.replace('(', '\\(').replace(')', '\\)'));
            } else {
                keywordRegex = new RegExp(`^${keyword}$`);
            }

            const index = lines.findIndex(line => keywordRegex.test(line) && !/lượt khách/i.test(line));
            if (index !== -1 && index + 1 < lines.length) {
                return parseFloat(lines[index + 1].replace(/,/g, '').replace(/%/g, '')) || 0;
            }
            return 0;
        };

        defaults.dtDuKien = findValueAfterKeyword(allLines, "DT Dự Kiến");
        defaults.dtqdDuKien = findValueAfterKeyword(allLines, "DT Dự Kiến (QĐ)", true);
        defaults.dtTraCham = findValueAfterKeyword(allLines, "DT Siêu thị");
        defaults.tyLeTraCham = findValueAfterKeyword(allLines, "Tỷ Trọng Trả Góp");

        // Tìm tăng trưởng cùng kỳ
        const dtckIndex = allLines.findIndex(line => line.includes('DTCK Tháng'));
        if (dtckIndex !== -1 && dtckIndex + 1 < allLines.length) {
            const valueLine = allLines[dtckIndex + 1];
            const values = valueLine.split(/\s+/);
            if (values.length >= 2) {
                defaults.comparisonData = {
                    value: parseFloat(values[0].replace(/,/g, '')) || 0,
                    percentage: values[1] || 'N/A'
                };
            }
        }

        // Tìm lượt khách
        const luotKhachIndex = allLines.findIndex(line => line.includes('Lượt Khách CK Tháng'));
        if (luotKhachIndex !== -1 && luotKhachIndex + 1 < allLines.length) {
            const valueLine = allLines[luotKhachIndex + 1];
            const values = valueLine.split(/\s+/);
            if (values.length >= 2) {
                defaults.luotKhachData = {
                    value: parseFloat(values[0].replace(/,/g, '')) || 0,
                    percentage: values[1] || 'N/A'
                };
            }
        }

        return defaults;
    },

    // 2. Phân tích danh sách các chương trình thi đua (Tổng hợp)
    parseCompetitionDataFromLuyKe: (text) => {
        if (!text || !text.trim()) return [];
        const lines = text.split('\n').map(l => l.trim());
        const results = [];
        let currentCompetition = null;

        for (let i = 0; i < lines.length; i++) {
            const line = lines[i];
            if (line.toLowerCase().startsWith('thi đua')) {
                if (currentCompetition) results.push(currentCompetition);
                currentCompetition = {
                    name: line.replace("Thi đua doanh thu", "DT").replace("Thi đua số lượng", "SL"),
                    type: line.toLowerCase().includes('doanh thu') ? 'doanhThu' : 'soLuong',
                    luyKe: 0, target: 0, hoanThanh: '0%'
                };
            } else if (currentCompetition) {
                if (line.startsWith('DTLK') || line.startsWith('SLLK') || line.startsWith('DTQĐ')) {
                     if (i + 1 < lines.length) {
                         currentCompetition.luyKe = parseFloat(lines[i + 1].replace(/,/g, '')) || 0;
                    }
                } else if (line.startsWith('Target')) {
                    if (i + 1 < lines.length) {
                        currentCompetition.target = parseFloat(lines[i + 1].replace(/,/g, '')) || 0;
                    }
                } else if (line.startsWith('% HT Dự Kiến')) {
                    if (i + 1 < lines.length) {
                         currentCompetition.hoanThanh = lines[i + 1] || '0%';
                    }
                }
            }
        }
        if (currentCompetition) results.push(currentCompetition);

        competitionData.set(results);
        return results;
    }
};
--- END FILE: ./src/services/processing/parsers/luyke.parser.js ---

--- START FILE: ./src/services/processing/parsers/thidua.parser.js ---
// src/services/processing/parsers/thidua.parser.js
import { debugInfo } from '../../../stores.js';

export const thiduaParser = {
    parsePastedThiDuaTableData(rawText) {
        const newDebugInfo = { required: [], found: [], status: 'Bắt đầu phân tích...' };

        if (!rawText || !rawText.trim()) {
            newDebugInfo.status = 'Lỗi: Dữ liệu dán vào rỗng.';
            debugInfo.update(current => ({ ...current, 'thiduanv-pasted': newDebugInfo }));
            return { success: false, error: newDebugInfo.status, mainHeaders: [], subHeaders: [], dataRows: [] };
        }

        const lines = rawText.split('\n').map(line => line.trim()).filter(line => line.length > 0);
        const splitRegex = /\s{2,}|\t/; 
        const numberCheckRegex = /^-?[\d,.]+$/;

        const mainHeaderStartIndex = lines.findIndex(line => line.includes('Phòng ban'));
        const subHeaderStartIndex = lines.findIndex(line => line.startsWith('DTLK') || line.startsWith('SLLK') || line.startsWith('DTQĐ'));
        
        let dataEndIndex = lines.findIndex(line => line.includes('Hỗ trợ BI'));
        if (dataEndIndex === -1) {
            dataEndIndex = lines.length;
        }

        const dataRowsStartIndex = lines.findIndex((line, index) => {
            if (index <= subHeaderStartIndex) return false;
            const parts = line.split(splitRegex).map(p => p.trim());
            const firstPart = parts[0] || "";

            if (firstPart.startsWith('Tổng') || firstPart.startsWith('BP ') || firstPart.startsWith('DTLK') || firstPart.startsWith('SLLK') || firstPart.startsWith('DTQĐ')) {
               return false;
            }
            return parts.length > 1 && numberCheckRegex.test(parts[1]);
        });

        if (mainHeaderStartIndex === -1 || subHeaderStartIndex === -1 || dataRowsStartIndex === -1) {
            let error = "Dữ liệu không hợp lệ thi đua ngành hàng theo nhân viên, vui lòng kiểm tra lại";
            newDebugInfo.status = error;
            debugInfo.update(current => ({ ...current, 'thiduanv-pasted': newDebugInfo }));
            return { success: false, error: error, mainHeaders: [], subHeaders: [], dataRows: [] };
        }
        
        const mainHeaderLines = lines.slice(mainHeaderStartIndex + 1, subHeaderStartIndex);
        const mainHeaderString = mainHeaderLines.join('\t');
        const mainHeaders = mainHeaderString.split(splitRegex).filter(Boolean);
        newDebugInfo.found.push({ name: 'Tiêu đề chính (Ngành hàng)', value: `${mainHeaders.length} mục`, status: mainHeaders.length > 0 });

        const subHeaderLines = lines.slice(subHeaderStartIndex, dataRowsStartIndex);
        const subHeaderString = subHeaderLines.join('\t');
        const subHeaders = subHeaderString.split(/\s+/).filter(Boolean);
        newDebugInfo.found.push({ name: 'Tiêu đề phụ (SLLK/DTQĐ)', value: `${subHeaders.length} mục`, status: subHeaders.length > 0 });

        const potentialDataLines = lines.slice(dataRowsStartIndex, dataEndIndex);
        const dataRows = [];
        
        for (const line of potentialDataLines) {
            const parts = line.split(splitRegex).map(p => p.trim());
            const firstPart = parts[0] || "";

            if (firstPart.startsWith('Tổng') || firstPart.startsWith('BP ')) {
                continue;
            }

            if (parts.length > 1 && numberCheckRegex.test(parts[1])) {
                dataRows.push({
                    name: firstPart,
                    values: parts.slice(1)
                });
            }
        }
        newDebugInfo.found.push({ name: 'Dòng dữ liệu nhân viên', value: `${dataRows.length} dòng`, status: dataRows.length > 0 });

        if (mainHeaders.length === 0 || subHeaders.length === 0 || dataRows.length === 0) {
            newDebugInfo.status = 'Lỗi: Không thể phân tích dữ liệu. Thiếu Tiêu đề chính, Tiêu đề phụ, hoặc Dòng dữ liệu (sau khi lọc).';
            debugInfo.update(current => ({ ...current, 'thiduanv-pasted': newDebugInfo }));
            return { success: false, error: newDebugInfo.status, mainHeaders, subHeaders, dataRows };
        }
        
        const expectedDataCols = subHeaders.length;
        if (dataRows.length > 0 && dataRows[0].values.length !== expectedDataCols) {
             newDebugInfo.status = `Cảnh báo: Số cột không khớp! Tiêu đề phụ (${expectedDataCols}) vs Dữ liệu (${dataRows[0].values.length}).`;
        } else {
           newDebugInfo.status = `Phân tích thành công.`;
        }
        
        debugInfo.update(current => ({ ...current, 'thiduanv-pasted': newDebugInfo }));
        return { success: true, mainHeaders, subHeaders, dataRows };
    }
};
--- END FILE: ./src/services/processing/parsers/thidua.parser.js ---

--- START FILE: ./src/services/processing/processors.js ---
// src/services/processing/processors.js
import { competitionProcessor } from './logic/competition.processor.js';
import { timekeepingProcessor } from './logic/timekeeping.processor.js';
import { regionalProcessor } from './logic/regional.processor.js';

export const processors = {
    // --- COMPETITION LOGIC ---
    debugCompetitionFiltering: competitionProcessor.debugCompetitionFiltering,
    updateCompetitionNameMappings: competitionProcessor.updateCompetitionNameMappings,
    processThiDuaNhanVienData: competitionProcessor.processThiDuaNhanVienData,

    // --- TIMEKEEPING LOGIC ---
    processGioCongData: timekeepingProcessor.processGioCongData,

    // --- REGIONAL LOGIC ---
    processThiDuaVungFile: regionalProcessor.processThiDuaVungFile
};
--- END FILE: ./src/services/processing/processors.js ---

--- START FILE: ./src/services/reportService.js ---
// src/services/reportService.js
// Version 3.0 - Modular Facade
// File này chỉ đóng vai trò điều phối, logic đã được tách ra thư mục reports/

import { masterReportLogic } from './reports/master.report.js';
import { competitionReportLogic } from './reports/competition.report.js';
import { detailReportLogic } from './reports/detail.report.js';
import { generalReportLogic } from './reports/general.report.js';

export const reportService = {
    ...masterReportLogic,
    ...competitionReportLogic,
    ...detailReportLogic,
    ...generalReportLogic
};
--- END FILE: ./src/services/reportService.js ---

--- START FILE: ./src/services/reports/competition.report.js ---
// src/services/reports/competition.report.js
// Version 1.0 - Competition logic
import { get } from 'svelte/store';
import * as utils from '../../utils.js';
import { dataProcessing } from '../dataProcessing.js';
import {
    danhSachNhanVien,
    specialProductList,
    thiDuaVungChiTiet,
    thiDuaVungTong
} from '../../stores.js';

export const competitionReportLogic = {
    calculateSpecialProductReport(sourceYcxData, specialProgramConfigs) {
        const $specialProductList = get(specialProductList);
        if (!sourceYcxData || sourceYcxData.length === 0 ||
            !specialProgramConfigs || specialProgramConfigs.length === 0 ||
            !$specialProductList || $specialProductList.length === 0) {
            return [];
        }

        const hinhThucXuatTinhDoanhThu = dataProcessing.getHinhThucXuatTinhDoanhThu();
        const validSalesData = sourceYcxData.filter(row => {
            const isDoanhThuHTX = hinhThucXuatTinhDoanhThu.has(row.hinhThucXuat);
            const isBaseValid = (row.trangThaiThuTien || "").trim() === 'Đã thu' &&
                                (row.trangThaiHuy || "").trim() === 'Chưa hủy' &&
                                (row.tinhTrangTra || "").trim() === 'Chưa trả' &&
                                (row.trangThaiXuat || "").trim() === 'Đã xuất';
            return isBaseValid && isDoanhThuHTX;
        });
        if (validSalesData.length === 0) return [];

        const $danhSachNhanVien = get(danhSachNhanVien);
        const report = specialProgramConfigs.map(program => {
            const programGroups = new Set((program.groups || []).map(g => String(g).trim()));
            if (programGroups.size === 0) return null;

            const specialProductSet = new Set(
                $specialProductList
                    .filter(sp => programGroups.has(String(sp.nhomHang).trim()))
                    .map(sp => String(sp.maSanPham).trim())
            );

            const totalGroupSales = validSalesData.filter(row => 
                programGroups.has(String(row.nhomHang).trim())
            );
    
            if (totalGroupSales.length === 0) return null;

            const employeeResults = $danhSachNhanVien.map(employee => {
                const stats = { slDacQuyen: 0, slNhomHang: 0, dtDacQuyen: 0, dtNhomHang: 0 };
                const employeeSales = totalGroupSales.filter(row => {
                    const msnvMatch = String(row.nguoiTao || '').match(/(\d+)/);
                    return msnvMatch && msnvMatch[1].trim() === employee.maNV;
                });
                if (employeeSales.length === 0) {
                    return { ...employee, ...stats, tyLeSL: 0, tyLeDT: 0 };
                }

                employeeSales.forEach(row => {
                    const maSanPham = String(row.maSanPham || '').trim();
                    const thanhTien = parseFloat(String(row.thanhTien || "0").replace(/,/g, '')) || 0;
                    const soLuong = parseInt(String(row.soLuong || "0"), 10) || 0;

                    stats.slNhomHang += soLuong;
                    stats.dtNhomHang += thanhTien;

                    if (specialProductSet.has(maSanPham)) {
                        stats.slDacQuyen += soLuong;
                        stats.dtDacQuyen += thanhTien;
                    }
                });
                const tyLeSL = stats.slNhomHang > 0 ? (stats.slDacQuyen / stats.slNhomHang) : 0;
                const tyLeDT = stats.dtNhomHang > 0 ? (stats.dtDacQuyen / stats.dtNhomHang) : 0;

                return {
                    maNV: employee.maNV,
                    hoTen: employee.hoTen,
                    boPhan: employee.boPhan,
                    ...stats,
                    tyLeSL,
                    tyLeDT
                };
            }).filter(e => e.slNhomHang > 0); 

            return {
                program: program,
                employeeData: employeeResults,
            };
        }).filter(Boolean); 

        return report;
    },

    calculateCompetitionFocusReport(sourceYcxData, competitionConfigs) {
        if (!sourceYcxData || sourceYcxData.length === 0 || !competitionConfigs || competitionConfigs.length === 0) {
            return [];
        }

        const hinhThucXuatTinhDoanhThu = dataProcessing.getHinhThucXuatTinhDoanhThu();
        const validSalesData = sourceYcxData.filter(row => {
            const isDoanhThuHTX = hinhThucXuatTinhDoanhThu.has(row.hinhThucXuat);
            const isBaseValid = (row.trangThaiThuTien || "").trim() === 'Đã thu' &&
                                 (row.trangThaiHuy || "").trim() === 'Chưa hủy' &&
                                 (row.tinhTrangTra || "").trim() === 'Chưa trả' &&
                                (row.trangThaiXuat || "").trim() === 'Đã xuất';
            return isBaseValid && isDoanhThuHTX;
        });
        const $danhSachNhanVien = get(danhSachNhanVien);

        const report = competitionConfigs.map(config => {
            const cleanedConfigGroups = new Set((config.groups || []).map(g => utils.cleanCategoryName(g)));

            let baseSalesData = validSalesData.filter(row => {
                const cleanNhomHangFromYCX = utils.cleanCategoryName(row.nhomHang);
                const isInGroup = cleanedConfigGroups.has(cleanNhomHangFromYCX);
                
                if (!isInGroup) return false;

                if (config.type === 'soluong' && (config.minPrice > 0 || config.maxPrice > 0)) {
                    const price = (parseFloat(String(row.thanhTien || "0").replace(/,/g, '')) || 0) / (parseInt(String(row.soLuong || "1"), 10) || 1);
                    const minPrice = config.minPrice || 0;
                    const maxPrice = config.maxPrice || Infinity;
                    if (price < minPrice || price > maxPrice) return false;
                }
                return true;
            });

            if (config.excludeApple) {
                baseSalesData = baseSalesData.filter(row => row.nhaSanXuat !== 'Apple');
            }

            const employeeResults = $danhSachNhanVien.map(employee => {
                let performanceByBrand = {};
                let totalTargetRevenue = 0;
                let totalTargetQuantity = 0;
                let baseCategoryRevenue = 0;
                let baseCategoryQuantity = 0;

                baseSalesData.forEach(row => {
                    const msnvMatch = String(row.nguoiTao || '').match(/(\d+)/);
                     if (msnvMatch && msnvMatch[1].trim() === employee.maNV) {
                        const revenueValue = (parseFloat(String(row.thanhTien || "0").replace(/,/g, '')) || 0);
                        const quantityValue = (parseInt(String(row.soLuong || "0"), 10) || 0);

                        baseCategoryRevenue += revenueValue;
                        baseCategoryQuantity += quantityValue;

                        const brand = row.nhaSanXuat;
                        if ((config.brands || []).includes(brand)) {
                            if (!performanceByBrand[brand]) {
                                performanceByBrand[brand] = { revenue: 0, quantity: 0 };
                            }
                            performanceByBrand[brand].revenue += revenueValue;
                            performanceByBrand[brand].quantity += quantityValue;

                            totalTargetRevenue += revenueValue;
                            totalTargetQuantity += quantityValue;
                        }
                    }
                });
                return {
                    maNV: employee.maNV,
                    hoTen: employee.hoTen,
                    boPhan: employee.boPhan,
                    performanceByBrand,
                    targetBrandsRevenue: totalTargetRevenue,
                    targetBrandsQuantity: totalTargetQuantity,
                    baseCategoryRevenue,
                    baseCategoryQuantity,
                    tyLeDT: baseCategoryRevenue > 0 ? (totalTargetRevenue / baseCategoryRevenue) : 0,
                    tyLeSL: baseCategoryQuantity > 0 ? (totalTargetQuantity / baseCategoryQuantity) : 0,
                };
            }).filter(e => e.baseCategoryRevenue > 0 || e.baseCategoryQuantity > 0);

            return {
                competition: config,
                employeeData: employeeResults,
            };
        }).filter(r => r.employeeData.length > 0);

        return report;
    },

    generateThiDuaVungReport(selectedSupermarket) {
        const $thiDuaVungChiTiet = get(thiDuaVungChiTiet);
        const $thiDuaVungTong = get(thiDuaVungTong);

        if (!selectedSupermarket || !$thiDuaVungChiTiet || $thiDuaVungChiTiet.length === 0 || !$thiDuaVungTong || $thiDuaVungTong.length === 0) {
            return null;
        }

        const findKey = (data, keyword) => {
            if (!data || data.length === 0) return null;
            return Object.keys(data[0]).find(k => k.trim().toLowerCase().includes(keyword.toLowerCase())) || keyword;
        };
        const supermarketKeyTong = findKey($thiDuaVungTong, 'siêu thị');
        const supermarketKeyChiTiet = findKey($thiDuaVungChiTiet, 'siêu thị');
        const tongThuongKey = findKey($thiDuaVungChiTiet, 'tổng thưởng');
        const hangVuotTroiKey = findKey($thiDuaVungChiTiet, 'hạng vượt trội');
        const hangTargetKey = findKey($thiDuaVungChiTiet, 'hạng % target');
        const layTopKey = findKey($thiDuaVungChiTiet, 'lấy top');
        const kenhKey = findKey($thiDuaVungChiTiet, 'kênh');
        const nganhHangKey = findKey($thiDuaVungChiTiet, 'ngành hàng');

        if (!supermarketKeyTong || !supermarketKeyChiTiet) {
            console.error("Không thể tìm thấy cột 'siêu thị' trong dữ liệu.");
            return null;
        }

        const summary = $thiDuaVungTong.find(row => row[supermarketKeyTong] === selectedSupermarket);
        if (!summary) return null;

        const chiTiet = $thiDuaVungChiTiet.filter(row => row[supermarketKeyChiTiet] === selectedSupermarket);

        if (chiTiet.length > 0 && layTopKey) {
            summary.hangCoGiaiKenh = chiTiet[0][layTopKey];
        } else {
            summary.hangCoGiaiKenh = 'N/A';
        }

        const report = { summary, coGiai: [], sapCoGiai: [], tiemNang: [], canCoGangNhieu: [] };

        const getPotentialPrize = (kenh, nganhHang) => {
            const winningSupermarkets = $thiDuaVungChiTiet.filter(sm =>
                sm[kenhKey] === kenh && sm[nganhHangKey] === nganhHang && sm[tongThuongKey] > 0
            );
            if (winningSupermarkets.length === 0) return 0;
            return Math.min(...winningSupermarkets.map(s => s[tongThuongKey]));
        };

        chiTiet.forEach(nganhHang => {
            if (nganhHang[tongThuongKey] > 0) {
                report.coGiai.push(nganhHang);
            } else {
                const hangVuotTroi = nganhHang[hangVuotTroiKey] || Infinity;
                const hangTarget = nganhHang[hangTargetKey] || Infinity;
                const hangCoGiai = nganhHang[layTopKey] || 0;

                const khoangCach = Math.min(
                    (hangVuotTroi > 0 && hangVuotTroi > hangCoGiai) ? hangVuotTroi - hangCoGiai : Infinity,
                    (hangTarget > 0 && hangTarget > hangCoGiai) ? hangTarget - hangCoGiai : Infinity
                );
                nganhHang.khoangCach = khoangCach;

                if (hangCoGiai > 0 && khoangCach <= 20) {
                    nganhHang.thuongTiemNang = getPotentialPrize(nganhHang[kenhKey], nganhHang[nganhHangKey]);
                    report.sapCoGiai.push(nganhHang);
                } else if (hangCoGiai > 0 && khoangCach > 20 && khoangCach <= 40) {
                    report.tiemNang.push(nganhHang);
                } else {
                    report.canCoGangNhieu.push(nganhHang);
                }
            }
        });

        report.coGiai.sort((a, b) => b[tongThuongKey] - a[tongThuongKey]);
        report.sapCoGiai.sort((a, b) => a.khoangCach - b.khoangCach);
        report.tiemNang.sort((a, b) => a.khoangCach - b.khoangCach);

        return report;
    }
};
--- END FILE: ./src/services/reports/competition.report.js ---

--- START FILE: ./src/services/reports/detail.report.js ---
// src/services/reports/detail.report.js
// Version 1.0 - Detail views logic
import { get } from 'svelte/store';
import * as utils from '../../utils.js';
import { formatters } from '../../utils/formatters.js';
import { dataProcessing } from '../dataProcessing.js';
import { masterReportData } from '../../stores.js';

export const detailReportLogic = {
    generateRealtimeEmployeeDetailReport(employeeMaNV, realtimeYCXData) {
        if (!employeeMaNV || !realtimeYCXData || realtimeYCXData.length === 0) return null;

        const employeeData = realtimeYCXData.filter(row => {
            const msnvMatch = String(row.nguoiTao || '').match(/(\d+)/);
            return msnvMatch && msnvMatch[1].trim() === String(employeeMaNV);
        });

        if (employeeData.length === 0) return null;

        const hinhThucXuatTinhDoanhThu = dataProcessing.getHinhThucXuatTinhDoanhThu();
        const heSoQuyDoi = dataProcessing.getHeSoQuyDoi();

        const summary = {
            totalRealRevenue: 0,
            totalConvertedRevenue: 0,
            unexportedRevenue: 0
        };
        const byProductGroup = {};
        const byCustomer = {};

        employeeData.forEach(row => {
            const isDoanhThuHTX = hinhThucXuatTinhDoanhThu.has(row.hinhThucXuat);
            const isBaseValid = (row.trangThaiThuTien || "").trim() === 'Đã thu' && (row.trangThaiHuy || "").trim() === 'Chưa hủy' && (row.tinhTrangTra || "").trim() === 'Chưa trả';

            if (isDoanhThuHTX && isBaseValid) {
                const realRevenue = parseFloat(String(row.thanhTien || "0").replace(/,/g, '')) || 0;
                const quantity = parseInt(String(row.soLuong || "0"), 10) || 0;
                const heSo = heSoQuyDoi[row.nhomHang] || 1;
                const convertedRevenue = realRevenue * heSo;
                const groupName = utils.cleanCategoryName(row.nhomHang || 'Khác');
                const customerName = row.tenKhachHang || 'Khách lẻ';

                if ((row.trangThaiXuat || "").trim() === 'Đã xuất') {
                    summary.totalRealRevenue += realRevenue;
                    summary.totalConvertedRevenue += convertedRevenue;

                    if (!byProductGroup[groupName]) {
                        byProductGroup[groupName] = { name: groupName, quantity: 0, realRevenue: 0, convertedRevenue: 0 };
                    }
                    byProductGroup[groupName].quantity += quantity;
                    byProductGroup[groupName].realRevenue += realRevenue;
                    byProductGroup[groupName].convertedRevenue += convertedRevenue;

                    if (!byCustomer[customerName]) {
                        byCustomer[customerName] = { name: customerName, products: [], totalQuantity: 0 };
                    }
                    byCustomer[customerName].products.push({
                        productName: row.tenSanPham,
                        quantity: quantity,
                        realRevenue: realRevenue,
                        convertedRevenue: convertedRevenue,
                    });
                    byCustomer[customerName].totalQuantity += quantity;
                } else if ((row.trangThaiXuat || "").trim() === 'Chưa xuất') {
                    summary.unexportedRevenue += convertedRevenue;
                }
            }
        });

        summary.totalOrders = Object.keys(byCustomer).length;
        summary.bundledOrderCount = Object.values(byCustomer).filter(c => c.totalQuantity > 1).length;
        summary.conversionRate = summary.totalRealRevenue > 0 ? (summary.totalConvertedRevenue / summary.totalRealRevenue) - 1 : 0;

        return {
            summary,
            byProductGroup: Object.values(byProductGroup).sort((a, b) => b.realRevenue - a.realRevenue),
            byCustomer: Object.values(byCustomer)
        };
    },

    generateLuyKeEmployeeDetailReport(employeeMaNV, luykeYCXData) {
        if (!employeeMaNV || !luykeYCXData || luykeYCXData.length === 0) {
            return null;
        }

        const employeeData = luykeYCXData.filter(row => {
            const msnvMatch = String(row.nguoiTao || '').match(/(\d+)/);
            return msnvMatch && msnvMatch[1].trim() === String(employeeMaNV);
        });

        if (employeeData.length === 0) {
             return null;
        }

        const hinhThucXuatTinhDoanhThu = dataProcessing.getHinhThucXuatTinhDoanhThu();
        const heSoQuyDoi = dataProcessing.getHeSoQuyDoi();

        const summary = {
            totalRealRevenue: 0,
            totalConvertedRevenue: 0,
            unexportedRevenue: 0, 
        };
        const byProductGroup = {};
        const byCustomer = {};
        const categoryChartDataMap = {};
        const dailyStats = {}; 
        const unexportedDetails = {};
        
        const $masterReportData = get(masterReportData);
        const employeeMasterData = $masterReportData.sknv.find(e => String(e.maNV) === String(employeeMaNV));
        if (employeeMasterData) {
            summary.unexportedRevenue = employeeMasterData.doanhThuChuaXuat || 0;
        }

        employeeData.forEach(row => {
            const isDoanhThuHTX = hinhThucXuatTinhDoanhThu.has(row.hinhThucXuat);
            const isBaseValid = (row.trangThaiThuTien || "").trim() === 'Đã thu' &&
                                (row.trangThaiHuy || "").trim() === 'Chưa hủy' &&
                                (row.tinhTrangTra || "").trim() === 'Chưa trả';

            if (isDoanhThuHTX && isBaseValid) {
                const realRevenue = parseFloat(String(row.thanhTien || "0").replace(/,/g, '')) || 0;
                const quantity = parseInt(String(row.soLuong || "0"), 10) || 0;
                if(isNaN(realRevenue) || isNaN(quantity)) return;

                const heSo = heSoQuyDoi[row.nhomHang] || 1;
                const convertedRevenue = realRevenue * heSo;
                const groupName = utils.cleanCategoryName(row.nhomHang || 'Khác');
                const customerName = row.tenKhachHang || 'Khách Lẻ';
                const categoryName = utils.cleanCategoryName(row.nganhHang || 'Khác');
                const productName = row.tenSanPham || 'Không rõ';
                
                if ((row.trangThaiXuat || "").trim() === 'Đã xuất') {
                    summary.totalRealRevenue += realRevenue;
                    summary.totalConvertedRevenue += convertedRevenue;

                    if (!byProductGroup[groupName]) {
                        byProductGroup[groupName] = { name: groupName, quantity: 0, realRevenue: 0, convertedRevenue: 0 };
                    }
                    byProductGroup[groupName].quantity += quantity;
                    byProductGroup[groupName].realRevenue += realRevenue;
                    byProductGroup[groupName].convertedRevenue += convertedRevenue;

                    if (!categoryChartDataMap[categoryName]) {
                        categoryChartDataMap[categoryName] = { name: categoryName, revenue: 0 };
                    }
                    categoryChartDataMap[categoryName].revenue += realRevenue;
                    if (!byCustomer[customerName]) {
                        byCustomer[customerName] = { name: customerName, products: [], totalQuantity: 0, totalRealRevenue: 0, totalConvertedRevenue: 0 };
                    }
                    byCustomer[customerName].products.push({
                        productName: row.tenSanPham,
                        quantity: quantity,
                        realRevenue: realRevenue,
                        convertedRevenue: convertedRevenue,
                    });
                    byCustomer[customerName].totalQuantity += quantity;
                    byCustomer[customerName].totalRealRevenue += realRevenue;
                    byCustomer[customerName].totalConvertedRevenue += convertedRevenue;
                    
                    const ngayTao = row.ngayTao;
                    if (ngayTao instanceof Date) {
                        const dateString = ngayTao.toISOString().split('T')[0];
                        if (!dailyStats[dateString]) {
                            dailyStats[dateString] = { date: ngayTao, revenue: 0, convertedRevenue: 0 };
                        }
                        dailyStats[dateString].revenue += realRevenue;
                        dailyStats[dateString].convertedRevenue += convertedRevenue;
                    }

                } else if ((row.trangThaiXuat || "").trim() === 'Chưa xuất') {
                    if (!unexportedDetails[groupName]) {
                        unexportedDetails[groupName] = { name: groupName, totalSL: 0, totalDTQD: 0, products: {} };
                    }
                    if (!unexportedDetails[groupName].products[productName]) {
                        unexportedDetails[groupName].products[productName] = { name: productName, sl: 0, dtqd: 0 };
                    }
                    unexportedDetails[groupName].products[productName].sl += quantity;
                    unexportedDetails[groupName].products[productName].dtqd += convertedRevenue;
                    unexportedDetails[groupName].totalSL += quantity;
                    unexportedDetails[groupName].totalDTQD += convertedRevenue;
                }
            }
        });

        summary.totalOrders = Object.keys(byCustomer).length;
        summary.bundledOrderCount = Object.values(byCustomer).filter(c => c.products.length > 1).length;
        summary.conversionRate = summary.totalRealRevenue > 0 ? (summary.totalConvertedRevenue / summary.totalRealRevenue) - 1 : 0;

        for (const customerName in byCustomer) {
            const customer = byCustomer[customerName];
            customer.conversionRate = customer.totalRealRevenue > 0 ? (customer.totalConvertedRevenue / customer.totalRealRevenue) - 1 : 0;
        }
        for (const groupName in byProductGroup) {
            const group = byProductGroup[groupName];
            group.conversionRate = group.realRevenue > 0 ? (group.convertedRevenue / group.realRevenue) - 1 : 0;
        }

        const finalDailyStats = Object.values(dailyStats).sort((a, b) => a.date - b.date);
        const finalUnexportedDetails = Object.values(unexportedDetails)
            .map(group => ({
                ...group,
                products: Object.values(group.products).sort((a, b) => b.dtqd - a.dtqd)
            }))
            .sort((a, b) => b.totalDTQD - a.totalDTQD);

        return {
            summary,
            topProductGroups: Object.values(byProductGroup)
                .sort((a, b) => b.realRevenue - a.realRevenue)
                .slice(0, 8),
            categoryChartData: Object.values(categoryChartDataMap),
            byCustomer: Object.values(byCustomer)
                .sort((a,b) => b.totalRealRevenue - a.totalRealRevenue),
            dailyStats: finalDailyStats, 
            unexportedDetails: finalUnexportedDetails 
        };
    }
};
--- END FILE: ./src/services/reports/detail.report.js ---

--- START FILE: ./src/services/reports/general.report.js ---
// src/services/reports/general.report.js
// Version 1.0 - General reports (Brand, Unexported)
import { get } from 'svelte/store';
import * as utils from '../../utils.js';
import { dataProcessing } from '../dataProcessing.js';
import { employeeMaNVMap } from '../../stores.js';

export const generalReportLogic = {
    generateRealtimeBrandReport(realtimeYCXData, selectedCategory, selectedBrand) {
        if (!realtimeYCXData || realtimeYCXData.length === 0) return { byBrand: [], byEmployee: [] };
        
        const $employeeMaNVMap = get(employeeMaNVMap);

        const filteredData = realtimeYCXData.filter(row => {
            const categoryMatch = !selectedCategory || utils.cleanCategoryName(row.nganhHang) === selectedCategory;
            const brandMatch = !selectedBrand || (row.nhaSanXuat || 'Hãng khác') === selectedBrand;
            const isDoanhThuHTX = dataProcessing.getHinhThucXuatTinhDoanhThu().has(row.hinhThucXuat);
            const isBaseValid = (row.trangThaiThuTien || "").trim() === 'Đã thu' && (row.trangThaiHuy || "").trim() === 'Chưa hủy' && (row.tinhTrangTra || "").trim() === 'Chưa trả' && (row.trangThaiXuat || "").trim() === 'Đã xuất';

            return categoryMatch && brandMatch && isDoanhThuHTX && isBaseValid;
        });

        const byBrand = {};
        const byEmployee = {};

        filteredData.forEach(row => {
            const brand = row.nhaSanXuat || 'Hãng khác';
            const msnvMatch = String(row.nguoiTao || '').match(/(\d+)/);
            const employeeId = msnvMatch ? msnvMatch[1].trim() : 'Unknown';
            const realRevenue = parseFloat(String(row.thanhTien || "0").replace(/,/g, '')) || 0;
            const quantity = parseInt(String(row.soLuong || "0"), 10) || 0;

            if (!byBrand[brand]) {
                byBrand[brand] = { name: brand, quantity: 0, revenue: 0 };
            }
            byBrand[brand].quantity += quantity;
            byBrand[brand].revenue += realRevenue;

            if (!byEmployee[employeeId]) {
                const employeeInfo = $employeeMaNVMap.get(employeeId);
                byEmployee[employeeId] = { id: employeeId, name: employeeInfo ? employeeInfo.hoTen : `NV ${employeeId}`, quantity: 0, revenue: 0 };
            }
            byEmployee[employeeId].quantity += quantity;
            byEmployee[employeeId].revenue += realRevenue;
        });

        const brandArray = Object.values(byBrand).map(b => ({...b, avgPrice: b.quantity > 0 ? b.revenue / b.quantity : 0})).sort((a,b) => b.revenue - a.revenue);
        const employeeArray = Object.values(byEmployee).sort((a,b) => b.revenue - a.revenue);

        return { byBrand: brandArray, byEmployee: employeeArray };
    },

    generateLuyKeChuaXuatReport(sourceYcxData) {
        if (!sourceYcxData || sourceYcxData.length === 0) return [];

        const hinhThucXuatTinhDoanhThu = dataProcessing.getHinhThucXuatTinhDoanhThu();
        const heSoQuyDoi = dataProcessing.getHeSoQuyDoi();
        const report = {};

        sourceYcxData.forEach(row => {
            const isDoanhThuHTX = hinhThucXuatTinhDoanhThu.has(row.hinhThucXuat);
            const isBaseValid = (row.trangThaiThuTien || "").trim() === 'Đã thu' &&
                                (row.trangThaiHuy || "").trim() === 'Chưa hủy' &&
                                (row.tinhTrangTra || "").trim() === 'Chưa trả' &&
                                (row.trangThaiXuat || "").trim() === 'Chưa xuất';

            if (isBaseValid && isDoanhThuHTX) {
                const thanhTien = parseFloat(String(row.thanhTien || "0").replace(/,/g, '')) || 0;
                const soLuong = parseInt(String(row.soLuong || "0"), 10) || 0;
                if (isNaN(thanhTien) || isNaN(soLuong)) return;

                const nganhHangName = utils.cleanCategoryName(row.nganhHang);
                const heSo = heSoQuyDoi[row.nhomHang] || 1;

                if (!report[nganhHangName]) {
                    report[nganhHangName] = {
                        nganhHang: nganhHangName,
                        soLuong: 0,
                        doanhThuThuc: 0,
                        doanhThuQuyDoi: 0
                    };
                }

                report[nganhHangName].soLuong += soLuong;
                report[nganhHangName].doanhThuThuc += thanhTien;
                report[nganhHangName].doanhThuQuyDoi += thanhTien * heSo;
            }
        });

        return Object.values(report);
    },

    generateRealtimeChuaXuatReport(sourceRealtimeYcxData) {
        if (!sourceRealtimeYcxData || sourceRealtimeYcxData.length === 0) return [];

        const hinhThucXuatTinhDoanhThu = dataProcessing.getHinhThucXuatTinhDoanhThu();
        const heSoQuyDoi = dataProcessing.getHeSoQuyDoi();
        const report = {};

        sourceRealtimeYcxData.forEach(row => {
            const isDoanhThuHTX = hinhThucXuatTinhDoanhThu.has(row.hinhThucXuat);
            const isBaseValid = (row.trangThaiThuTien || "").trim() === 'Đã thu' &&
                                (row.trangThaiHuy || "").trim() === 'Chưa hủy' &&
                                (row.tinhTrangTra || "").trim() === 'Chưa trả' &&
                                (row.trangThaiXuat || "").trim() === 'Chưa xuất';

            if (isBaseValid && isDoanhThuHTX) {
                const thanhTien = parseFloat(String(row.thanhTien || "0").replace(/,/g, '')) || 0;
                const soLuong = parseInt(String(row.soLuong || "0"), 10) || 0;
                if (isNaN(thanhTien) || isNaN(soLuong)) return;

                const nganhHangName = utils.cleanCategoryName(row.nganhHang);
                const heSo = heSoQuyDoi[row.nhomHang] || 1;

                if (!report[nganhHangName]) {
                    report[nganhHangName] = {
                        nganhHang: nganhHangName,
                        soLuong: 0,
                        doanhThuThuc: 0,
                        doanhThuQuyDoi: 0
                    };
                }

                report[nganhHangName].soLuong += soLuong;
                report[nganhHangName].doanhThuThuc += thanhTien;
                report[nganhHangName].doanhThuQuyDoi += thanhTien * heSo;
            }
        });

        return Object.values(report);
    }
};
--- END FILE: ./src/services/reports/general.report.js ---

--- START FILE: ./src/services/reports/master.report.js ---
// src/services/reports/master.report.js
// Version 6.0 - Modularized Architecture
import { get } from 'svelte/store';
import { danhSachNhanVien } from '../../stores.js';

// Import sub-modules
import { configLoader } from './master/configLoader.js';
import { salaryProcessor } from './master/salaryProcessor.js';
import { salesProcessor } from './master/salesProcessor.js';
import { metricsProcessor } from './master/metricsProcessor.js';
import { aggregator } from './master/aggregator.js';

export const masterReportLogic = {
    generateMasterReportData: (sourceData, goalSettings, isRealtime = false) => {
        const $danhSachNhanVien = get(danhSachNhanVien);
        if (!$danhSachNhanVien || $danhSachNhanVien.length === 0) return [];

        // 1. Load Configurations & Keywords
        const uiKeywords = configLoader.loadUiKeywords();

        // 2. Prepare Salary Data
        const salaryData = salaryProcessor.prepareSalaryData();

        // 3. Main Loop: Process each employee
        return $danhSachNhanVien.map((employee) => {
            // A. Calculate Sales (Core Logic)
            const salesData = salesProcessor.processEmployeeSales(employee, sourceData, uiKeywords);
            
            // B. Calculate Dynamic Metrics (Admin + User)
            salesData.dynamicMetrics = metricsProcessor.calculateDynamicMetrics(salesData, goalSettings);
            
            // C. Calculate Static Ratios
            const staticRatios = salesProcessor.calculateStaticRatios(salesData);

            // D. Calculate Salary
            const salaryInfo = salaryProcessor.calculateEmployeeSalary(employee, salaryData);

            // E. Calculate Average Price
            const totalQuantity = Object.values(salesData.doanhThuTheoNganhHang).reduce((sum, c) => sum + c.quantity, 0);
            const donGiaTrungBinh = totalQuantity > 0 ? salesData.doanhThu / totalQuantity : 0;

            // F. Combine Everything
            return { 
                ...employee, 
                ...salesData, 
                ...staticRatios,
                ...salaryInfo,
                donGiaTrungBinh,
                mucTieu: goalSettings 
            };
        });
    },

    aggregateReport: (reportData, selectedWarehouse = null) => {
        return aggregator.aggregateReport(reportData);
    }
};
--- END FILE: ./src/services/reports/master.report.js ---

--- START FILE: ./src/services/reports/master/aggregator.js ---
// src/services/reports/master/aggregator.js
import { get } from 'svelte/store';
import { efficiencyConfig, warehouseCustomMetrics } from '../../../stores.js';
import { normalize } from './utils.js';

export const aggregator = {
    aggregateReport(reportData) {
        if (!reportData || reportData.length === 0) return {};

        // Tính tổng hợp cho toàn siêu thị
        const supermarketReport = reportData.reduce((acc, curr) => {
            // Cộng dồn tất cả các trường số
            for (const key in curr) {
                if (typeof curr[key] === 'number') {
                    acc[key] = (acc[key] || 0) + curr[key];
                }
            }
            
            // Merge chi tiết Ngành hàng / Nhóm hàng
            ['doanhThuTheoNganhHang', 'doanhThuTheoNhomHang'].forEach(dictKey => {
                if(curr[dictKey]) {
                    if(!acc[dictKey]) acc[dictKey] = {};
                    Object.entries(curr[dictKey]).forEach(([k, v]) => {
                        if(!acc[dictKey][k]) acc[dictKey][k] = { ...v };
                        else {
                            acc[dictKey][k].revenue += v.revenue;
                            acc[dictKey][k].quantity += v.quantity;
                            acc[dictKey][k].revenueQuyDoi += v.revenueQuyDoi;
                        }
                    });
                }
            });

            return acc;
        }, { doanhThu: 0, dynamicMetrics: {} });

        supermarketReport.nganhHangChiTiet = supermarketReport.doanhThuTheoNganhHang;
        supermarketReport.nhomHangChiTiet = supermarketReport.doanhThuTheoNhomHang;

        // Tính lại % Tổng hợp Siêu thị
        const totalRevenue = supermarketReport.doanhThu || 1;
        supermarketReport.pctPhuKien = (supermarketReport.dtPhuKien || 0) / totalRevenue;
        supermarketReport.pctGiaDung = (supermarketReport.dtGiaDung || 0) / totalRevenue;
        supermarketReport.pctMLN = (supermarketReport.dtMLN || 0) / totalRevenue;
        supermarketReport.pctSim = (supermarketReport.dtSim || 0) / totalRevenue;
        supermarketReport.pctVAS = (supermarketReport.dtVAS || 0) / totalRevenue;
        supermarketReport.pctBaoHiem = (supermarketReport.dtBaoHiem || 0) / totalRevenue;
        supermarketReport.hieuQuaQuyDoi = (supermarketReport.doanhThuQuyDoi || 0) / totalRevenue - 1;
        supermarketReport.tyLeTraCham = (supermarketReport.doanhThuTraGop || 0) / totalRevenue;
        supermarketReport.comparisonData = { value: 0, percentage: 'N/A' }; 

        if (supermarketReport.qdc) {
            for (const key in supermarketReport.qdc) {
                const group = supermarketReport.qdc[key];
                group.donGia = group.sl > 0 ? group.dt / group.sl : 0;
            }
        }

        // --- Tính lại Dynamic Metrics cho cấp Siêu thị ---
        const $efficiencyConfig = get(efficiencyConfig) || [];
        const $warehouseCustomMetrics = get(warehouseCustomMetrics) || [];
        const allMetricsConfig = [...$efficiencyConfig, ...$warehouseCustomMetrics];

        supermarketReport.dynamicMetrics = {};
        
        if (allMetricsConfig.length > 0) {
            allMetricsConfig.forEach(cfg => {
                try {
                    if (!cfg.id || !cfg.groupA || !cfg.groupB) return;

                    const numType = cfg.typeA || 'DTTL';
                    const denType = cfg.typeB || 'DTTL'; 

                    const calcGroupValue = (groupList, valueType) => {
                        let total = 0;
                        if (!Array.isArray(groupList) || groupList.length === 0) return 0;
                        
                        groupList.forEach(rawName => {
                            if(!rawName) return;
                            const cleanCfgName = normalize(rawName);
                             const scanBucket = (bucket) => {
                                for (const [k, v] of Object.entries(bucket)) {
                                    if (normalize(k).includes(cleanCfgName)) {
                                        if(valueType==='SL') total+=v.quantity;
                                        else if(valueType==='DTQD') total+=v.revenueQuyDoi;
                                        else total+=v.revenue;
                                    }
                                }
                            };
                            scanBucket(supermarketReport.doanhThuTheoNganhHang);
                            scanBucket(supermarketReport.doanhThuTheoNhomHang);
                        });
                        return total;
                    };

                    const numVal = calcGroupValue(cfg.groupA, numType);
                    const denVal = calcGroupValue(cfg.groupB, denType);
                    
                    supermarketReport.dynamicMetrics[cfg.id] = {
                        value: denVal > 0 ? numVal / denVal : 0,
                        target: cfg.target, 
                        label: cfg.label
                    };
                } catch(e) {}
            });
        }

        return supermarketReport;
    }
};
--- END FILE: ./src/services/reports/master/aggregator.js ---

--- START FILE: ./src/services/reports/master/configLoader.js ---
import { get } from 'svelte/store';
import { 
    macroCategoryConfig, 
    macroProductGroupConfig 
} from '../../../stores.js';
import { normalize } from './utils.js';
import { parseIdentity } from '../../../utils.js';

export const configLoader = {
    loadUiKeywords() {
        // Lấy config từ Store Svelte
        const $macroProductGroupConfig = get(macroProductGroupConfig) || [];
        const $macroCategoryConfig = get(macroCategoryConfig) || [];

        // Khởi tạo bộ chứa keywords cho các nhóm UI cố định
        const uiKeywords = {
            dtICT: [], dtCE: [], dtPhuKien: [], dtGiaDung: [],
            dtMLN: [], dtSim: [], dtVAS: [], dtBaoHiem: []
        };

        // Mapping định danh: Nhóm UI nào ứng với từ khóa cấu hình nào
        // Ví dụ: Nếu admin đặt tên nhóm là "Nhóm Phụ Kiện Đặc Biệt", nó sẽ match vào 'dtPhuKien'
        const uiIdentity = {
            dtICT: ['ict', 'điện thoại', 'laptop', 'tablet', 'mobile'],
            dtCE: ['ce', 'điện tử', 'tivi', 'loa', 'âm thanh', 'tv'],
            dtPhuKien: ['phụ kiện', 'pk', 'accessories'],
            dtGiaDung: ['gia dụng', 'gd', 'household'],
            dtMLN: ['máy lọc nước', 'mln', 'lọc nước'],
            dtSim: ['sim', 'thẻ cào', 'card'],
            dtVAS: ['vas', 'dịch vụ'],
            dtBaoHiem: ['bảo hiểm', 'rơi vỡ', 'insurance']
        };

        const loadKeywords = (configs) => {
            if (!Array.isArray(configs)) return;
            
            configs.forEach(group => {
                const groupName = normalize(group.name);
                
                // Duyệt qua các nhóm UI định sẵn
                for (const [uiKey, identityTags] of Object.entries(uiIdentity)) {
                    // Nếu tên nhóm trong config (VD: "Phụ kiện 2024") chứa identity (VD: "phụ kiện")
                    if (identityTags.some(tag => groupName.includes(tag))) {
                         
                         // Thì lấy tất cả items bên trong nhóm đó đưa vào keywords của UI Key tương ứng
                         if (group.items && Array.isArray(group.items)) {
                             group.items.forEach(i => {
                                 // 1. Push tên gốc đã chuẩn hóa
                                 uiKeywords[uiKey].push(normalize(i)); 
                                 
                                 // 2. Push ID nếu có (Quan trọng: Xử lý chuỗi "1394 - Cáp sạc")
                                 const parsed = parseIdentity(i);
                                 if (parsed.id && parsed.id !== 'unknown') {
                                     uiKeywords[uiKey].push(normalize(parsed.id));
                                 }
                             });
                         }
                    }
                }
            });
        };

        // Load từ cả 2 nguồn config
        loadKeywords($macroProductGroupConfig);
        loadKeywords($macroCategoryConfig);

        return uiKeywords;
    }
};
--- END FILE: ./src/services/reports/master/configLoader.js ---

--- START FILE: ./src/services/reports/master/metricsProcessor.js ---
// src/services/reports/master/metricsProcessor.js
import { get } from 'svelte/store';
import { efficiencyConfig, warehouseCustomMetrics } from '../../../stores.js';
import { normalize } from './utils.js';

export const metricsProcessor = {
    calculateDynamicMetrics(data, goalSettings) {
        const $efficiencyConfig = get(efficiencyConfig) || [];
        const $warehouseCustomMetrics = get(warehouseCustomMetrics) || [];
        
        // Gộp cấu hình Admin và User
        const allMetricsConfig = [...$efficiencyConfig, ...$warehouseCustomMetrics];
        
        const dynamicMetrics = {};

        if (allMetricsConfig && Array.isArray(allMetricsConfig)) {
            allMetricsConfig.forEach(cfg => {
                try {
                    if (!cfg.id || !cfg.groupA || !cfg.groupB) return;

                    const numType = cfg.typeA || cfg.type || 'DTTL';
                    const denType = cfg.typeB || (numType === 'SL' ? 'SL' : 'DTTL');

                    const calcValue = (groupList, type) => {
                        let total = 0;
                        groupList.forEach(shortName => {
                            const normShort = normalize(shortName);
                            // Hàm quét đệ quy
                            const scanBucket = (bucket) => {
                                for (const [key, val] of Object.entries(bucket)) {
                                    if (normalize(key).includes(normShort)) {
                                        if (type === 'SL') total += val.quantity;
                                        else if (type === 'DTQD') total += val.revenueQuyDoi;
                                        else total += val.revenue;
                                    }
                                }
                            };
                            scanBucket(data.doanhThuTheoNganhHang);
                            scanBucket(data.doanhThuTheoNhomHang);
                        });
                        return total;
                    };

                    const num = calcValue(cfg.groupA, numType);
                    const den = calcValue(cfg.groupB, denType);

                    dynamicMetrics[cfg.id] = {
                        value: den > 0 ? num / den : 0,
                        // Lấy target từ Goal Settings nếu có, nếu không lấy default
                        target: goalSettings && goalSettings[cfg.id] ? parseFloat(goalSettings[cfg.id]) : (cfg.target || 0),
                        label: cfg.label
                    };
                } catch (e) {
                    // Silent fail
                }
            });
        }
        return dynamicMetrics;
    }
};
--- END FILE: ./src/services/reports/master/metricsProcessor.js ---

--- START FILE: ./src/services/reports/master/salaryProcessor.js ---
// src/services/reports/master/salaryProcessor.js
import { get } from 'svelte/store';
import {
    thuongNongData,
    thuongERPData,
    thuongNongDataThangTruoc,
    thuongERPDataThangTruoc,
    employeeNameToMaNVMap
} from '../../../stores.js';
import { dataProcessing } from '../../dataProcessing.js';

export const salaryProcessor = {
    prepareSalaryData() {
        const $thuongNongData = get(thuongNongData) || [];
        const $employeeNameToMaNVMap = get(employeeNameToMaNVMap);
        const $thuongERPData = get(thuongERPData) || [];
        const $thuongNongDataThangTruoc = get(thuongNongDataThangTruoc) || [];
        const $thuongERPDataThangTruoc = get(thuongERPDataThangTruoc) || [];

        const thuongNongByMSNV = {};
        $thuongNongData.forEach(row => {
            const msnv = String(row.maNV || '').trim() || $employeeNameToMaNVMap.get(String(row.hoTen).toLowerCase());
            if(msnv) thuongNongByMSNV[msnv] = (thuongNongByMSNV[msnv]||0) + (parseFloat(String(row.diemThuong||0).replace(/,/g,''))||0);
        });

        const thuongNongThangTruocByMSNV = {};
        $thuongNongDataThangTruoc.forEach(row => {
            const msnv = String(row.maNV || '').trim() || $employeeNameToMaNVMap.get(String(row.hoTen).toLowerCase());
            if(msnv) thuongNongThangTruocByMSNV[msnv] = (thuongNongThangTruocByMSNV[msnv]||0) + (parseFloat(String(row.diemThuong||0).replace(/,/g,''))||0);
        });

        const gioCongByMSNV = dataProcessing.processGioCongData();

        return {
            thuongNongByMSNV,
            thuongNongThangTruocByMSNV,
            gioCongByMSNV,
            $thuongERPData,
            $thuongERPDataThangTruoc
        };
    },

    calculateEmployeeSalary(employee, salaryData) {
        const { 
            thuongNongByMSNV, thuongNongThangTruocByMSNV, gioCongByMSNV, 
            $thuongERPData, $thuongERPDataThangTruoc 
        } = salaryData;

        const gioCong = gioCongByMSNV[employee.maNV] || 0;
        const thuongNong = thuongNongByMSNV[employee.maNV] || 0;
        
        const erpEntry = $thuongERPData.find(e => e.name.includes(employee.hoTen));
        const thuongERP = erpEntry ? parseFloat(erpEntry.bonus.replace(/,/g, '')) : 0;
        const tongThuNhap = thuongNong + thuongERP;

        const today = new Date();
        const daysInMonth = new Date(today.getFullYear(), today.getMonth() + 1, 0).getDate();
        let thuNhapDuKien = 0;
        if (today.getDate() > 1) {
            thuNhapDuKien = (tongThuNhap / (today.getDate() - 1)) * daysInMonth;
        } else {
            thuNhapDuKien = tongThuNhap * daysInMonth;
        }

        const thuongNongThangTruoc = thuongNongThangTruocByMSNV[employee.maNV] || 0;
        const erpEntryThangTruoc = $thuongERPDataThangTruoc.find(e => e.name.includes(employee.hoTen));
        const thuongERPThangTruoc = erpEntryThangTruoc ? parseFloat(erpEntryThangTruoc.bonus.replace(/,/g, '')) : 0;
        const thuNhapThangTruoc = (thuongNongThangTruoc || 0) + thuongERPThangTruoc;
        const chenhLechThuNhap = thuNhapDuKien - thuNhapThangTruoc;

        return {
            gioCong, thuongNong, thuongERP, tongThuNhap, 
            thuNhapDuKien, thuNhapThangTruoc, chenhLechThuNhap
        };
    }
};
--- END FILE: ./src/services/reports/master/salaryProcessor.js ---

--- START FILE: ./src/services/reports/master/salesProcessor.js ---
import { config } from '../../../config.js';
import * as utils from '../../../utils.js';
import { normalize } from './utils.js';
import { dataProcessing } from '../../dataProcessing.js';
import { parseIdentity } from '../../../utils.js';

// [FIX] Hàm xử lý số an toàn cho định dạng tiền tệ VN (loại bỏ dấu chấm/phẩy phân cách)
const parseSafeNumber = (value) => {
    if (typeof value === 'number') return value;
    if (!value) return 0;
    // Chuyển về chuỗi, loại bỏ mọi ký tự không phải số hoặc dấu trừ (cho số âm)
    const cleanStr = String(value).replace(/[^0-9-]/g, '');
    return parseFloat(cleanStr) || 0;
};

export const salesProcessor = {
    // --- KHỞI TẠO DỮ LIỆU RỖNG ---
    createEmptySalesData() {
        const PG = config.PRODUCT_GROUPS;
        let data = {
            // Tổng hợp chung
            doanhThu: 0, 
            doanhThuQuyDoi: 0, 
            doanhThuTraGop: 0,
            doanhThuChuaXuat: 0, 
            doanhThuQuyDoiChuaXuat: 0,
            doanhThuGiaoXa: 0, 
            doanhThuQuyDoiGiaoXa: 0,
            
            // Map chi tiết để tra cứu nhanh (O(1))
            doanhThuTheoNganhHang: {}, 
            doanhThuTheoNhomHang: {}, 
            
            // Quy đổi chuẩn (QDC)
            qdc: {},

            // [HARDCODED METRICS] - Các chỉ số cơ bản luôn phải có
            dtICT: 0, dtCE: 0, dtPhuKien: 0, dtGiaDung: 0, 
            dtSim: 0, dtVAS: 0, dtBaoHiem: 0, dtMLN: 0,
            
            // Chi tiết sản phẩm
            dtTivi: 0, slTivi: 0, 
            dtTuLanh: 0, slTuLanh: 0,
            dtMayGiat: 0, slMayGiat: 0, 
            dtMayLanh: 0, slMayLanh: 0,
            dtDienThoai: 0, slDienThoai: 0, 
            dtLaptop: 0, slLaptop: 0
        };

        // Init QDC Groups
        for (const key in PG.QDC_GROUPS) {
            data.qdc[key] = { sl: 0, dt: 0, dtqd: 0, name: PG.QDC_GROUPS[key].name };
        }
        return data;
    },

    // --- XỬ LÝ DOANH THU NHÂN VIÊN ---
    processEmployeeSales(employee, sourceData, uiKeywords) {
        const data = this.createEmptySalesData();
        const PG = config.PRODUCT_GROUPS;
        
        // Lấy config hệ thống
        const hinhThucXuatTinhDoanhThu = dataProcessing.getHinhThucXuatTinhDoanhThu();
        const hinhThucXuatTraGop = dataProcessing.getHinhThucXuatTraGop();
        const heSoQuyDoi = dataProcessing.getHeSoQuyDoi();

        if (sourceData && Array.isArray(sourceData)) {
            sourceData.forEach(row => {
                // Kiểm tra User ID
                const msnvMatch = String(row.nguoiTao || '').match(/(\d+)/);
                if (msnvMatch && msnvMatch[1].trim() === employee.maNV) {
                    
                    const hinhThucXuat = row.hinhThucXuat;
                    const trangThaiXuat = row.trangThaiXuat;
                    
                    // Logic điều kiện hợp lệ
                    const isDoanhThuHTX = !hinhThucXuat || hinhThucXuatTinhDoanhThu.has(hinhThucXuat);
                    const isDaXuat = !trangThaiXuat || trangThaiXuat.trim() === 'Đã xuất' || trangThaiXuat.trim() === 'Đã giao';

                    if (isDoanhThuHTX && isDaXuat) {
                        // [FIX] Sử dụng parseSafeNumber thay vì parseFloat trực tiếp
                        const thanhTien = parseSafeNumber(row.thanhTien);
                        const soLuong = parseInt(String(row.soLuong || "0"), 10) || 0;
                        const heSo = heSoQuyDoi[row.nhomHang] || 1;
                        
                        // Parse ID Nhóm/Ngành
                        const nhomIdObj = row.maNhomHang 
                            ? { id: row.maNhomHang, name: parseIdentity(row.nhomHang).name } 
                            : parseIdentity(row.nhomHang);
                        const nganhIdObj = row.maNganhHang 
                            ? { id: row.maNganhHang, name: parseIdentity(row.nganhHang).name } 
                            : parseIdentity(row.nganhHang);

                        // A. CỘNG DỒN VÀO MAP CHI TIẾT (Để dùng cho Dynamic Table / Modal)
                        const trackMetric = (container, idObj, rawString) => {
                            if (!idObj.id || idObj.id === 'unknown') return;
                            // Đảm bảo ID luôn là chuỗi để đồng nhất key
                            const key = String(idObj.id).trim();
                            if (!container[key]) {
                                container[key] = { 
                                    id: key, 
                                    name: idObj.name || rawString, 
                                    revenue: 0, quantity: 0, revenueQuyDoi: 0 
                                };
                            }
                            container[key].revenue += thanhTien;
                            container[key].quantity += soLuong;
                            container[key].revenueQuyDoi += thanhTien * heSo;
                        }

                        trackMetric(data.doanhThuTheoNganhHang, nganhIdObj, row.nganhHang);
                        trackMetric(data.doanhThuTheoNhomHang, nhomIdObj, row.nhomHang);

                        // B. CỘNG TỔNG DOANH THU CHUNG
                        data.doanhThu += thanhTien;
                        data.doanhThuQuyDoi += thanhTien * heSo;

                        if (hinhThucXuat && hinhThucXuatTraGop.has(hinhThucXuat)) {
                            data.doanhThuTraGop += thanhTien;
                        }

                        // C. PHÂN LOẠI NHÓM
                        const nhomHangCode = String(nhomIdObj.id).trim();
                        
                        // --- 1. Hardcode ID Logic (Mặc định MWG) ---
                        // Nhóm ICT
                        if (PG.DIEN_THOAI.includes(nhomHangCode) || PG.LAPTOP.includes(nhomHangCode) || (PG.TABLET && PG.TABLET.includes(nhomHangCode))) { 
                            data.dtICT += thanhTien; 
                        }
                        
                        // Nhóm CE
                        if (PG.TIVI.includes(nhomHangCode) || PG.TU_LANH.includes(nhomHangCode) || PG.MAY_GIAT.includes(nhomHangCode) || PG.MAY_LANH.includes(nhomHangCode) || (PG.DONG_HO && PG.DONG_HO.includes(nhomHangCode))) { 
                            data.dtCE += thanhTien; 
                        }
                        
                        // Nhóm Phụ Kiện
                        if (PG.PHU_KIEN && PG.PHU_KIEN.includes(nhomHangCode)) { 
                            data.dtPhuKien += thanhTien; 
                        }
                        
                        // Nhóm Gia Dụng
                        if (PG.GIA_DUNG && PG.GIA_DUNG.includes(nhomHangCode)) { 
                            data.dtGiaDung += thanhTien; 
                        }
                        
                        // Các nhóm khác
                        if (PG.MAY_LOC_NUOC && PG.MAY_LOC_NUOC.includes(nhomHangCode)) { data.dtMLN += thanhTien; }
                        if (PG.SIM && PG.SIM.includes(nhomHangCode)) { data.dtSim += thanhTien; }
                        if (PG.VAS && PG.VAS.includes(nhomHangCode)) { data.dtVAS += thanhTien; }
                        if (PG.BAO_HIEM_VAS && PG.BAO_HIEM_VAS.includes(nhomHangCode)) { data.dtBaoHiem += thanhTien; }

                        // --- 2. Dynamic Keyword Logic ---
                        const rawNhomHang = normalize(row.nhomHang);
                        const rawNganhHang = normalize(row.nganhHang);
                        const cleanNhomId = normalize(nhomHangCode);
                        const cleanNganhId = normalize(nganhIdObj.id);

                        const checkDynamic = (uiKey, hardcodeList = []) => {
                            const keywords = uiKeywords[uiKey];
                            if (!keywords || keywords.length === 0) return;

                            const isMatch = keywords.some(k => 
                                rawNhomHang.includes(k) || rawNganhHang.includes(k) || 
                                cleanNhomId === k || cleanNganhId === k
                            );

                            if (isMatch) {
                                const alreadyCounted = hardcodeList.includes(nhomHangCode);
                                if (!alreadyCounted) {
                                    data[uiKey] += thanhTien;
                                }
                            }
                        };
                        
                        checkDynamic('dtICT', [...PG.DIEN_THOAI, ...PG.LAPTOP, ...(PG.TABLET || [])]); 
                        checkDynamic('dtCE', [...PG.TIVI, ...PG.TU_LANH, ...PG.MAY_GIAT, ...PG.MAY_LANH, ...(PG.DONG_HO || [])]); 
                        checkDynamic('dtPhuKien', PG.PHU_KIEN || []);
                        checkDynamic('dtGiaDung', PG.GIA_DUNG || []);
                        checkDynamic('dtMLN', PG.MAY_LOC_NUOC || []); 
                        checkDynamic('dtSim', PG.SIM || []);
                        checkDynamic('dtVAS', PG.VAS || []); 
                        checkDynamic('dtBaoHiem', PG.BAO_HIEM_VAS || []);

                        // --- 3. Detailed Stats ---
                        if (PG.DIEN_THOAI.includes(nhomHangCode)) { data.dtDienThoai += thanhTien; data.slDienThoai += soLuong; }
                        if (PG.LAPTOP.includes(nhomHangCode)) { data.dtLaptop += thanhTien; data.slLaptop += soLuong; }
                        if (PG.TIVI.includes(nhomHangCode)) { data.dtTivi += thanhTien; data.slTivi += soLuong; }
                        if (PG.TU_LANH.includes(nhomHangCode)) { data.dtTuLanh += thanhTien; data.slTuLanh += soLuong; }
                        if (PG.MAY_GIAT.includes(nhomHangCode)) { data.dtMayGiat += thanhTien; data.slMayGiat += soLuong; }
                        if (PG.MAY_LANH.includes(nhomHangCode)) { data.dtMayLanh += thanhTien; data.slMayLanh += soLuong; }

                        // QDC Groups
                        for (const key in PG.QDC_GROUPS) {
                            if (PG.QDC_GROUPS[key].codes.includes(nhomHangCode)) {
                                data.qdc[key].sl += soLuong; 
                                data.qdc[key].dt += thanhTien; 
                                data.qdc[key].dtqd += thanhTien * heSo;
                            }
                        }
                    } 
                    // Logic chưa xuất
                    else if (trangThaiXuat === 'Chưa xuất') {
                        const thanhTien = parseSafeNumber(row.thanhTien);
                        const heSo = heSoQuyDoi[row.nhomHang] || 1;
                        data.doanhThuChuaXuat += thanhTien;
                        data.doanhThuQuyDoiChuaXuat += thanhTien * heSo;
                    }
                }
            });
        }
        return data;
    },

    // --- TÍNH TỶ LỆ PHẦN TRĂM ---
    calculateStaticRatios(data) {
        const totalRevenue = data.doanhThu > 0 ? data.doanhThu : 1;
        return {
            pctPhuKien: data.dtPhuKien / totalRevenue,
            pctGiaDung: data.dtGiaDung / totalRevenue,
            pctMLN: data.dtMLN / totalRevenue,
            pctSim: data.dtSim / totalRevenue,
            pctVAS: data.dtVAS / totalRevenue,
            pctBaoHiem: data.dtBaoHiem / totalRevenue,
            hieuQuaQuyDoi: data.doanhThu > 0 ? (data.doanhThuQuyDoi / data.doanhThu) - 1 : 0,
            tyLeTraCham: data.doanhThu > 0 ? data.doanhThuTraGop / data.doanhThu : 0
        };
    }
};
--- END FILE: ./src/services/reports/master/salesProcessor.js ---

--- START FILE: ./src/services/reports/master/utils.js ---
// src/services/reports/master/utils.js
export const normalize = (str) => {
    if (!str) return '';
    return str.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "").trim();
};
--- END FILE: ./src/services/reports/master/utils.js ---

--- START FILE: ./src/services/settings.service.js ---
// src/services/settings.service.js
import { get } from 'svelte/store';
import { 
    luykeGoalSettings, 
    realtimeGoalSettings, 
    interfaceSettings,
    pastedThiDuaReportData
} from '../stores.js';
import { datasyncService } from './datasync.service.js'; // [MỚI] Import

// ... (Giữ nguyên các hằng số ALL_EFFICIENCY_ITEMS, PASTED_COMPETITION_SETTINGS_KEY) ...
const ALL_EFFICIENCY_ITEMS = [
    { id: 'dtICT', label: 'DT ICT' },
    { id: 'dtPhuKien', label: 'DT Phụ kiện' },
    { id: 'pctPhuKien', label: '% Phụ kiện' },
    { id: 'dtCE', label: 'DT CE' },
    { id: 'dtGiaDung', label: 'DT Gia dụng' },
    { id: 'pctGiaDung', label: '% Gia dụng' },
    { id: 'pctMLN',    label: '% Máy lọc nước' }, 
    { id: 'pctSim',    label: '% Sim' },
    { id: 'pctVAS',    label: '% VAS' },
    { id: 'pctBaoHiem', label: '% Bảo hiểm' }
];
const PASTED_COMPETITION_SETTINGS_KEY = 'pastedCompetitionViewSettings';

export const settingsService = {
    // --- INTERFACE SETTINGS ---
    loadInterfaceSettings() {
        try {
            const saved = localStorage.getItem('interfaceSettings');
            if (saved) {
                const parsed = JSON.parse(saved);
                interfaceSettings.set({ ...get(interfaceSettings), ...parsed });
            }
            this.applyInterfaceStyles(get(interfaceSettings));
            const contrast = localStorage.getItem('contrastLevel') || '3';
            this.updateContrast(contrast);
        } catch (e) { console.error(e); }
    },

    updateInterface(newSettings) {
        interfaceSettings.set(newSettings);
        localStorage.setItem('interfaceSettings', JSON.stringify(newSettings));
        this.applyInterfaceStyles(newSettings);
    },

    updateContrast(level) {
        document.documentElement.dataset.contrast = level;
        localStorage.setItem('contrastLevel', level);
        interfaceSettings.update(s => ({ ...s, contrastLevel: level }));
    },

    applyInterfaceStyles(settings) {
        const root = document.documentElement;
        if (!settings) return;
        if (settings.globalFontSize) root.style.fontSize = `${settings.globalFontSize}px`;
        for (let i = 1; i <= 8; i++) {
            const key = `kpiCard${i}Bg`;
            if (settings[key]) root.style.setProperty(`--kpi-card-${i}-bg`, settings[key]);
        }
        if (settings.kpiTitleColor) root.style.setProperty('--kpi-title-color', settings.kpiTitleColor);
        if (settings.kpiMainColor) root.style.setProperty('--kpi-main-color', settings.kpiMainColor);
        if (settings.kpiSubColor) root.style.setProperty('--kpi-sub-color', settings.kpiSubColor);
        if (settings.kpiFontSize) root.style.setProperty('--kpi-main-font-size', `${settings.kpiFontSize}px`);
    },

    // --- GOAL SETTINGS (MỤC TIÊU) - CẬP NHẬT ĐỂ SYNC CLOUD ---
    
    // [MỚI] Tải mục tiêu từ Cloud
    async loadGoalsFromCloud(warehouse) {
        if (!warehouse) return;
        const data = await datasyncService.loadGoalSettings(warehouse);
        
        // Cập nhật store Lũy kế
        luykeGoalSettings.update(current => ({
            ...current,
            [warehouse]: data.luyke || {}
        }));

        // Cập nhật store Realtime
        realtimeGoalSettings.update(current => ({
            ...current,
            [warehouse]: data.realtime || { goals: {}, timing: {} }
        }));
    },

    saveLuykeGoalForWarehouse(warehouse, goals) {
        luykeGoalSettings.update(current => {
            const updated = { ...current, [warehouse]: goals };
            // Vẫn lưu local để backup
            localStorage.setItem('luykeGoalSettings', JSON.stringify(updated)); 
            return updated;
        });
        // [MỚI] Lưu lên Cloud
        datasyncService.saveGoalSettings(warehouse, 'luyke', goals);
    },

    getLuykeGoalSettings(selectedWarehouse = null) {
        const $luykeGoalSettings = get(luykeGoalSettings);
        const settings = { goals: {} };
        const goalKeys = ['doanhThuThuc', 'doanhThuQD', 'phanTramQD', 'phanTramTC', 'phanTramGiaDung', 'phanTramMLN', 'phanTramPhuKien', 'phanTramBaoHiem', 'phanTramSim', 'phanTramVAS'];

        if (selectedWarehouse && $luykeGoalSettings[selectedWarehouse]) {
             const source = $luykeGoalSettings[selectedWarehouse];
             // [FIX] Copy động tất cả các key (để hỗ trợ Dynamic Metrics từ Admin)
             Object.assign(settings.goals, source);
        } else if (!selectedWarehouse) {
             // Logic trung bình (giữ nguyên nếu cần, hoặc đơn giản hóa)
             return settings;
        }
        return settings;
    },

    saveRealtimeGoalForWarehouse(warehouse, settings) {
        realtimeGoalSettings.update(current => {
            const updated = { ...current, [warehouse]: settings };
            localStorage.setItem('realtimeGoalSettings', JSON.stringify(updated));
            return updated;
        });
        // [MỚI] Lưu lên Cloud
        datasyncService.saveGoalSettings(warehouse, 'realtime', settings);
    },

    getRealtimeGoalSettings(selectedWarehouse = null) {
        const $realtimeGoalSettings = get(realtimeGoalSettings);
        if (selectedWarehouse && $realtimeGoalSettings && $realtimeGoalSettings[selectedWarehouse]) {
            return $realtimeGoalSettings[selectedWarehouse];
        }
        return { goals: {}, timing: {} };
    },

    // --- VIEW SETTINGS (GIỮ NGUYÊN) ---
    saveEfficiencyViewSettings(settings) {
        if (!Array.isArray(settings)) return;
        try { localStorage.setItem('efficiencyViewSettings', JSON.stringify(settings)); } catch (e) {}
    },
    loadEfficiencyViewSettings() {
        try {
            const savedSettingsJSON = localStorage.getItem('efficiencyViewSettings');
            if (savedSettingsJSON) {
                const savedItems = JSON.parse(savedSettingsJSON);
                if (Array.isArray(savedItems) && savedItems.length > 0) {
                    const savedIds = new Set(savedItems.map(s => s.id));
                    const newItems = ALL_EFFICIENCY_ITEMS
                        .filter(item => !savedIds.has(item.id))
                        .map(item => ({ ...item, visible: true }));
                    
                    const currentItems = savedItems
                        .filter(item => ALL_EFFICIENCY_ITEMS.some(config => config.id === item.id))
                        .map(item => {
                            const defaultItem = ALL_EFFICIENCY_ITEMS.find(d => d.id === item.id);
                             return defaultItem ? { ...item, label: defaultItem.label } : item;
                        });
                    return [...currentItems, ...newItems];
                }
            }
        } catch (e) {}
        return ALL_EFFICIENCY_ITEMS.map(item => ({ ...item, visible: true }));
    },
    saveQdcViewSettings(settings) {
        if (!Array.isArray(settings)) return;
        try { localStorage.setItem('qdcViewSettings', JSON.stringify(settings)); } catch (e) {}
    },
    saveCategoryViewSettings(settings) {
        if (!Array.isArray(settings)) return;
        try { localStorage.setItem('categoryViewSettings', JSON.stringify(settings)); } catch (e) {}
    },
    loadQdcViewSettings(allItems) {
        try {
            const saved = localStorage.getItem('qdcViewSettings');
            if (saved) return JSON.parse(saved);
        } catch (e) {}
        return allItems;
    },
    loadCategoryViewSettings(allItems) {
        try {
            const saved = localStorage.getItem('categoryViewSettings');
            if (saved) return JSON.parse(saved);
        } catch (e) {}
        return allItems;
    },
    savePastedCompetitionViewSettings(settings) {
        try { localStorage.setItem(PASTED_COMPETITION_SETTINGS_KEY, JSON.stringify(settings)); } catch (e) {}
    },
    loadPastedCompetitionViewSettings() {
        const pastedDataStoreValue = get(pastedThiDuaReportData);
        if (!pastedDataStoreValue || pastedDataStoreValue.length === 0) return [];
        
        const masterColumns = pastedDataStoreValue[0].competitions.map((comp, index) => ({
            id: `comp_${index}`,
            label: comp.tenNganhHang,
            tenGoc: comp.tenGoc,
            loaiSoLieu: comp.loaiSoLieu,
            visible: true
        }));
        const masterMap = new Map(masterColumns.map(item => [item.tenGoc, item]));

        let savedItems = [];
        try {
            savedItems = JSON.parse(localStorage.getItem(PASTED_COMPETITION_SETTINGS_KEY) || '[]');
        } catch (e) { savedItems = []; }

        const savedMap = new Map(savedItems.map(item => [item.tenGoc, item]));
        const finalSettings = [];
        
        savedItems.forEach(savedItem => {
            if (masterMap.has(savedItem.tenGoc)) {
                const masterItem = masterMap.get(savedItem.tenGoc);
                finalSettings.push({ ...savedItem, id: masterItem.id, label: masterItem.label });
            }
        });
        masterColumns.forEach(masterItem => {
            if (!savedMap.has(masterItem.tenGoc)) finalSettings.push(masterItem);
        });
        return finalSettings;
    }
};
--- END FILE: ./src/services/settings.service.js ---

--- START FILE: ./src/services/sknv.service.js ---
import { formatters } from '../utils/formatters.js';
import { cleanCategoryName } from '../utils.js';

export const sknvService = {
    calculateDepartmentAverages(departmentName, reportData) {
        const departmentEmployees = reportData.filter(e => e.boPhan === departmentName);
        if (departmentEmployees.length === 0) return {};

        const totals = departmentEmployees.reduce((acc, curr) => {
            Object.keys(curr).forEach(key => {
                if (typeof curr[key] === 'number') acc[key] = (acc[key] || 0) + curr[key];
            });
            if (curr.qdc) {
                if (!acc.qdc) acc.qdc = {};
                for (const k in curr.qdc) {
                    if (!acc.qdc[k]) acc.qdc[k] = { sl: 0, dt: 0, dtqd: 0 };
                    acc.qdc[k].sl += curr.qdc[k].sl;
                    acc.qdc[k].dt += curr.qdc[k].dt;
                    acc.qdc[k].dtqd += curr.qdc[k].dtqd;
                }
            }
            return acc;
        }, {});

        const averages = {};
        for (const key in totals) {
            if (key !== 'qdc') averages[key] = totals[key] / departmentEmployees.length;
            else {
                averages.qdc = {};
                for (const qdcKey in totals.qdc) averages.qdc[qdcKey] = {
                    sl: totals.qdc[qdcKey].sl / departmentEmployees.length,
                    dt: totals.qdc[qdcKey].dt / departmentEmployees.length,
                    dtqd: totals.qdc[qdcKey].dtqd / departmentEmployees.length
                };
            }
        }
        return averages;
    },

    evaluateEmployee(employee, departmentAverages) {
        const counts = {
            doanhthu: { above: 0, total: 7 },
            nangsuat: { above: 0, total: 7 },
            hieuqua: { above: 0, total: 6 },
            dongia: { above: 0, total: 7 }
        };

        const check = (group, value, avg, higherIsBetter = true) => {
            if (!isFinite(value) || avg === undefined || !isFinite(avg)) return;
            if (higherIsBetter ? (value >= avg) : (value <= avg)) 
                counts[group].above++;
        };

        check('doanhthu', employee.doanhThu, departmentAverages.doanhThu);
        check('doanhthu', employee.doanhThuQuyDoi, departmentAverages.doanhThuQuyDoi);
        check('doanhthu', employee.hieuQuaQuyDoi, departmentAverages.hieuQuaQuyDoi);
        check('doanhthu', employee.dtCE, departmentAverages.dtCE);
        check('doanhthu', employee.dtICT, departmentAverages.dtICT);
        check('doanhthu', employee.doanhThuTraGop, departmentAverages.doanhThuTraGop);
        check('doanhthu', employee.tyLeTraCham, departmentAverages.tyLeTraCham);
        
        check('nangsuat', employee.tongThuNhap, departmentAverages.tongThuNhap);
        check('nangsuat', employee.thuNhapDuKien, departmentAverages.thuNhapDuKien);
        check('nangsuat', employee.gioCong, departmentAverages.gioCong);
        const tnTrenGc = employee.gioCong > 0 ? employee.tongThuNhap / employee.gioCong : 0;
        const avgTnTrenGc = departmentAverages.gioCong > 0 ? departmentAverages.tongThuNhap / departmentAverages.gioCong : 0;
        check('nangsuat', tnTrenGc, avgTnTrenGc);
        const dtqdTrenGc = employee.gioCong > 0 ? employee.doanhThuQuyDoi / employee.gioCong : 0;
        const avgDtqdTrenGc = departmentAverages.gioCong > 0 ? departmentAverages.doanhThuQuyDoi / departmentAverages.gioCong : 0;
        check('nangsuat', dtqdTrenGc, avgDtqdTrenGc);
        check('nangsuat', employee.thuongNong, departmentAverages.thuongNong);
        check('nangsuat', employee.thuongERP, departmentAverages.thuongERP);

        check('hieuqua', employee.pctPhuKien, departmentAverages.pctPhuKien);
        check('hieuqua', employee.pctGiaDung, departmentAverages.pctGiaDung);
        check('hieuqua', employee.pctMLN, departmentAverages.pctMLN);
        check('hieuqua', employee.pctSim, departmentAverages.pctSim);
        check('hieuqua', employee.pctVAS, departmentAverages.pctVAS);
        check('hieuqua', employee.pctBaoHiem, departmentAverages.pctBaoHiem);

        check('dongia', employee.donGiaTrungBinh, departmentAverages.donGiaTrungBinh);
        check('dongia', employee.donGiaTivi, departmentAverages.donGiaTivi);
        check('dongia', employee.donGiaTuLanh, departmentAverages.donGiaTuLanh);
        check('dongia', employee.donGiaMayGiat, departmentAverages.donGiaMayGiat);
        check('dongia', employee.donGiaMayLanh, departmentAverages.donGiaMayLanh);
        check('dongia', employee.donGiaDienThoai, departmentAverages.donGiaDienThoai);
        check('dongia', employee.donGiaLaptop, departmentAverages.donGiaLaptop);

        const totalAbove = Object.values(counts).reduce((sum, grp) => sum + grp.above, 0);
        const totalCriteria = Object.values(counts).reduce((sum, grp) => sum + grp.total, 0);

        return { ...employee, summary: counts, totalAbove, totalCriteria };
    },

    processReportData(rawReportData) {
        if (!rawReportData || rawReportData.length === 0) return [];
        return rawReportData.map(emp => {
            const deptAvg = this.calculateDepartmentAverages(emp.boPhan, rawReportData);
            return this.evaluateEmployee(emp, deptAvg);
        });
    },

    getDetailStats(employeeData, departmentAverages, customMetrics = []) {
        if (!employeeData || !departmentAverages) return {};

        const { mucTieu } = employeeData;
        const fmtRev = (val) => formatters.formatRevenue(val);
        const fmtNum = (val) => formatters.formatNumberOrDash(val);
        const fmtPct = (val) => formatters.formatPercentage(val);

        const doanhThu = [
            { id: 'dtThuc', label: 'Doanh thu thực', value: fmtRev(employeeData.doanhThu), average: fmtRev(departmentAverages.doanhThu), rawValue: employeeData.doanhThu, rawAverage: departmentAverages.doanhThu },
            { id: 'dtQD', label: 'Doanh thu QĐ', value: fmtRev(employeeData.doanhThuQuyDoi), average: fmtRev(departmentAverages.doanhThuQuyDoi), rawValue: employeeData.doanhThuQuyDoi, rawAverage: departmentAverages.doanhThuQuyDoi },
            { id: 'pctQD', label: '% Quy đổi', value: fmtPct(employeeData.hieuQuaQuyDoi), valueClass: (mucTieu && employeeData.hieuQuaQuyDoi < (mucTieu.phanTramQD / 100)) ? 'text-red-600 bg-red-50' : '', average: fmtPct(departmentAverages.hieuQuaQuyDoi), rawValue: employeeData.hieuQuaQuyDoi, rawAverage: departmentAverages.hieuQuaQuyDoi },
            { id: 'dtCE', label: 'DT CE', value: fmtRev(employeeData.dtCE), average: fmtRev(departmentAverages.dtCE), rawValue: employeeData.dtCE, rawAverage: departmentAverages.dtCE },
            { id: 'dtICT', label: 'DT ICT', value: fmtRev(employeeData.dtICT), average: fmtRev(departmentAverages.dtICT), rawValue: employeeData.dtICT, rawAverage: departmentAverages.dtICT },
            { id: 'dtTraCham', label: 'DT Trả chậm', value: fmtRev(employeeData.doanhThuTraGop), average: fmtRev(departmentAverages.doanhThuTraGop), rawValue: employeeData.doanhThuTraGop, rawAverage: departmentAverages.doanhThuTraGop },
            { id: 'pctTraCham', label: '% Trả chậm', value: fmtPct(employeeData.tyLeTraCham), valueClass: (mucTieu && employeeData.tyLeTraCham < (mucTieu.phanTramTC / 100)) ? 'text-red-600 bg-red-50' : '', average: fmtPct(departmentAverages.tyLeTraCham), rawValue: employeeData.tyLeTraCham, rawAverage: departmentAverages.tyLeTraCham }
        ];

        const nangSuat = [
            { id: 'thuongNong', label: 'Thưởng nóng', value: fmtRev(employeeData.thuongNong), average: fmtRev(departmentAverages.thuongNong), rawValue: employeeData.thuongNong, rawAverage: departmentAverages.thuongNong },
            { id: 'thuongERP', label: 'Thưởng ERP', value: fmtRev(employeeData.thuongERP), average: fmtRev(departmentAverages.thuongERP), rawValue: employeeData.thuongERP, rawAverage: departmentAverages.thuongERP },
            { id: 'thuNhapLK', label: 'Thu nhập LK', value: fmtRev(employeeData.tongThuNhap), average: fmtRev(departmentAverages.tongThuNhap), rawValue: employeeData.tongThuNhap, rawAverage: departmentAverages.tongThuNhap },
            { id: 'thuNhapDK', label: 'Thu nhập DK', value: fmtRev(employeeData.thuNhapDuKien), average: fmtRev(departmentAverages.thuNhapDuKien), rawValue: employeeData.thuNhapDuKien, rawAverage: departmentAverages.thuNhapDuKien },
            { id: 'gioCong', label: 'Giờ công', value: fmtNum(employeeData.gioCong), average: fmtNum(departmentAverages.gioCong), rawValue: employeeData.gioCong, rawAverage: departmentAverages.gioCong },
            { id: 'tnTrenGc', label: 'TN/Giờ công', value: fmtNum(employeeData.gioCong > 0 ? employeeData.tongThuNhap / employeeData.gioCong : 0), average: fmtNum((departmentAverages.gioCong || 0) > 0 ? (departmentAverages.tongThuNhap || 0) / departmentAverages.gioCong : 0), rawValue: employeeData.gioCong > 0 ? employeeData.tongThuNhap / employeeData.gioCong : 0, rawAverage: (departmentAverages.gioCong || 0) > 0 ? (departmentAverages.tongThuNhap || 0) / departmentAverages.gioCong : 0 },
            { id: 'dtqdTrenGc', label: 'DTQĐ/Giờ công', value: fmtRev(employeeData.gioCong > 0 ? employeeData.doanhThuQuyDoi / employeeData.gioCong : 0), average: fmtRev((departmentAverages.gioCong || 0) > 0 ? (departmentAverages.doanhThuQuyDoi || 0) / departmentAverages.gioCong : 0), rawValue: employeeData.gioCong > 0 ? employeeData.doanhThuQuyDoi / employeeData.gioCong : 0, rawAverage: (departmentAverages.gioCong || 0) > 0 ? (departmentAverages.doanhThuQuyDoi || 0) / departmentAverages.gioCong : 0 }
        ];

        const hieuQua = [
            { id: 'pctPhuKien', label: '% PK', value: fmtPct(employeeData.pctPhuKien), valueClass: (mucTieu && employeeData.pctPhuKien < (mucTieu.phanTramPhuKien / 100)) ? 'text-red-600 bg-red-50' : '', average: fmtPct(departmentAverages.pctPhuKien), rawValue: employeeData.pctPhuKien, rawAverage: departmentAverages.pctPhuKien },
            { id: 'pctGiaDung', label: '% Gia dụng', value: fmtPct(employeeData.pctGiaDung), valueClass: (mucTieu && employeeData.pctGiaDung < (mucTieu.phanTramGiaDung / 100)) ? 'text-red-600 bg-red-50' : '', average: fmtPct(departmentAverages.pctGiaDung), rawValue: employeeData.pctGiaDung, rawAverage: departmentAverages.pctGiaDung },
            { id: 'pctMLN', label: '% MLN', value: fmtPct(employeeData.pctMLN), valueClass: (mucTieu && employeeData.pctMLN < (mucTieu.phanTramMLN / 100)) ? 'text-red-600 bg-red-50' : '', average: fmtPct(departmentAverages.pctMLN), rawValue: employeeData.pctMLN, rawAverage: departmentAverages.pctMLN },
            { id: 'pctSim', label: '% Sim', value: fmtPct(employeeData.pctSim), valueClass: (mucTieu && employeeData.pctSim < (mucTieu.phanTramSim / 100)) ? 'text-red-600 bg-red-50' : '', average: fmtPct(departmentAverages.pctSim), rawValue: employeeData.pctSim, rawAverage: departmentAverages.pctSim },
            { id: 'pctVAS', label: '% VAS', value: fmtPct(employeeData.pctVAS), valueClass: (mucTieu && employeeData.pctVAS < (mucTieu.phanTramVAS / 100)) ? 'text-red-600 bg-red-50' : '', average: fmtPct(departmentAverages.pctVAS), rawValue: employeeData.pctVAS, rawAverage: departmentAverages.pctVAS },
            { id: 'pctBaoHiem', label: '% Bảo hiểm', value: fmtPct(employeeData.pctBaoHiem), valueClass: (mucTieu && employeeData.pctBaoHiem < (mucTieu.phanTramBaoHiem / 100)) ? 'text-red-600 bg-red-50' : '', average: fmtPct(departmentAverages.pctBaoHiem), rawValue: employeeData.pctBaoHiem, rawAverage: departmentAverages.pctBaoHiem },
        ];

        const donGia = [
            { id: 'dgTB', label: 'Đơn giá TB', value: fmtRev(employeeData.donGiaTrungBinh), average: fmtRev(departmentAverages.donGiaTrungBinh), rawValue: employeeData.donGiaTrungBinh, rawAverage: departmentAverages.donGiaTrungBinh },
            { id: 'dgTivi', label: 'Đơn giá Tivi', value: fmtRev(employeeData.donGiaTivi), average: fmtRev(departmentAverages.donGiaTivi), rawValue: employeeData.donGiaTivi, rawAverage: departmentAverages.donGiaTivi },
            { id: 'dgTuLanh', label: 'Đơn giá Tủ lạnh', value: fmtRev(employeeData.donGiaTuLanh), average: fmtRev(departmentAverages.donGiaTuLanh), rawValue: employeeData.donGiaTuLanh, rawAverage: departmentAverages.donGiaTuLanh },
            { id: 'dgMayGiat', label: 'Đơn giá Máy giặt', value: fmtRev(employeeData.donGiaMayGiat), average: fmtRev(departmentAverages.donGiaMayGiat), rawValue: employeeData.donGiaMayGiat, rawAverage: departmentAverages.donGiaMayGiat },
            { id: 'dgMayLanh', label: 'Đơn giá Máy lạnh', value: fmtRev(employeeData.donGiaMayLanh), average: fmtRev(departmentAverages.donGiaMayLanh), rawValue: employeeData.donGiaMayLanh, rawAverage: departmentAverages.donGiaMayLanh },
            { id: 'dgDienThoai', label: 'Đơn giá Điện thoại', value: fmtRev(employeeData.donGiaDienThoai), average: fmtRev(departmentAverages.donGiaDienThoai), rawValue: employeeData.donGiaDienThoai, rawAverage: departmentAverages.donGiaDienThoai },
            { id: 'dgLaptop', label: 'Đơn giá Laptop', value: fmtRev(employeeData.donGiaLaptop), average: fmtRev(departmentAverages.donGiaLaptop), rawValue: employeeData.donGiaLaptop, rawAverage: departmentAverages.donGiaLaptop },
        ];

        if (customMetrics && customMetrics.length > 0) {
            customMetrics.forEach(metric => {
                const empVal = this.calculateDynamicMetricValue(employeeData, metric);
                const avgVal = departmentAverages[`custom_${metric.id}`] || 0; 

                const newItem = {
                    id: metric.id,
                    label: metric.label,
                    rawValue: empVal,
                    rawAverage: avgVal,
                    isCustom: true,
                    rawConfig: metric // [MỚI] Lưu config gốc để có thể sửa/xóa
                };

                if (metric.type === 'UNIT_PRICE') {
                    newItem.value = fmtRev(empVal);
                    newItem.average = fmtRev(avgVal);
                    donGia.push(newItem);
                } else {
                    newItem.value = fmtPct(empVal);
                    newItem.average = fmtPct(avgVal);
                    newItem.valueClass = (metric.target && empVal < (metric.target / 100)) ? 'text-red-600 bg-red-50' : '';
                    hieuQua.push(newItem);
                }
            });
        }

        return { doanhThu, nangSuat, hieuQua, donGia };
    },

    calculateDynamicMetricValue(data, metricConfig) {
        const sumValues = (listNames, metricType) => {
            let total = 0;
            if(!listNames || listNames.length === 0) return 0;

            listNames.forEach(name => {
                const cleanName = cleanCategoryName(name);
                let item = data.doanhThuTheoNganhHang?.[cleanName];
                if (!item && data.doanhThuTheoNhomHang) {
                    item = data.doanhThuTheoNhomHang[cleanName];
                }

                if (item) {
                    if (metricType === 'SL') total += item.quantity;
                    else if (metricType === 'DTQD') total += item.revenueQuyDoi;
                    else total += item.revenue; 
                }
            });
            return total;
        };

        const numVal = sumValues(metricConfig.groupA, metricConfig.typeA);
        const denVal = sumValues(metricConfig.groupB, metricConfig.typeB);

        return denVal > 0 ? numVal / denVal : 0;
    }
};
--- END FILE: ./src/services/sknv.service.js ---

--- START FILE: ./src/services/storage.service.js ---
// src/services/storage.service.js
// Version 3.1 - Fixed: Export both 'storage' (IndexedDB) and 'storageService' (Firebase)
// MODULE: STORAGE SERVICE
import { getStorage, ref, uploadBytesResumable, getDownloadURL } from "firebase/storage";
import { get } from 'svelte/store';
import { firebaseStore, notificationStore } from '../stores.js';

// --- PHẦN 1: FIREBASE STORAGE (Mới) ---

const getStorageInstance = () => {
    const fb = get(firebaseStore);
    if (!fb || !fb.storage) {
        try { return getStorage(); } catch (e) { return null; }
    }
    return fb.storage;
};

const showNotification = (message, type = 'info') => {
    notificationStore.set({ message, type, visible: true });
    setTimeout(() => notificationStore.update(s => ({ ...s, visible: false })), 3000);
};

export const storageService = {
    async getTemplateDownloadURL() {
        const storage = getStorageInstance();
        if (!storage) throw new Error("Firebase Storage chưa được khởi tạo.");
        const filePath = 'templates/danh_sach_nhan_vien_mau.xlsx';
        const storageRef = ref(storage, filePath);
        return await getDownloadURL(storageRef);
    },

    async getBookmarkDownloadURL() {
        const storage = getStorageInstance();
        if (!storage) throw new Error("Firebase Storage chưa được khởi tạo.");
        const filePath = 'templates/Share_QLST.zip';
        const storageRef = ref(storage, filePath);
        return await getDownloadURL(storageRef);
    },

    async getQrCodeDownloadURL() {
        const storage = getStorageInstance();
        if (!storage) throw new Error("Firebase Storage chưa được khởi tạo.");
        const filePath = 'qrcodes/main-qr.jpg';
        const storageRef = ref(storage, filePath);
        return await getDownloadURL(storageRef);
    },

    async uploadFileToStorage(file, storagePath, onProgress) {
        const storage = getStorageInstance();
        if (!storage) throw new Error("Firebase Storage chưa khởi tạo.");
        
        const storageRef = ref(storage, storagePath);
        const uploadTask = uploadBytesResumable(storageRef, file);

        return new Promise((resolve, reject) => {
            uploadTask.on('state_changed',
                (snapshot) => {
                    const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                    console.log(`Upload ${storagePath}: ${Math.round(progress)}%`);
                    if (onProgress) onProgress(progress);
                },
                (error) => {
                    console.error(`Upload lỗi:`, error);
                    showNotification(`Lỗi upload: ${error.code}`, 'error');
                    reject(error);
                },
                async () => {
                    try {
                        const downloadURL = await getDownloadURL(uploadTask.snapshot.ref);
                        console.log('File available at', downloadURL);
                        resolve(downloadURL);
                    } catch (err) {
                        reject(err);
                    }
                }
            );
        });
    },
};

// --- PHẦN 2: INDEXEDDB (Cũ - Khôi phục lại) ---

export const storage = {
    db: null,
    dbName: 'AppStorageDB',
    storeName: 'fileStore',

    openDB() {
        // console.log("[IndexedDB] Opening...");
        return new Promise((resolve, reject) => {
            if (this.db) return resolve(this.db);
            const request = indexedDB.open(this.dbName, 1);
            request.onupgradeneeded = (event) => {
                const db = event.target.result;
                if (!db.objectStoreNames.contains(this.storeName)) {
                    db.createObjectStore(this.storeName, { keyPath: 'id' });
                }
            };
            request.onsuccess = (event) => {
                this.db = event.target.result;
                resolve(this.db);
            };
            request.onerror = (event) => reject(event.target.error);
        });
    },

    async setItem(id, value) {
        try {
            const db = await this.openDB();
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([this.storeName], 'readwrite');
                const store = transaction.objectStore(this.storeName);
                const request = store.put({ id, value });
                request.onsuccess = () => resolve();
                request.onerror = (e) => reject(e.target.error);
            });
        } catch (error) {
            console.error(`[IndexedDB] Error saving ${id}:`, error);
            throw error;
        }
    },

    async getItem(id) {
        try {
            const db = await this.openDB();
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([this.storeName], 'readonly');
                const store = transaction.objectStore(this.storeName);
                const request = store.get(id);
                request.onsuccess = (e) => resolve(e.target.result ? e.target.result.value : null);
                request.onerror = (e) => reject(e.target.error);
            });
        } catch (error) {
            console.error(`[IndexedDB] Error getting ${id}:`, error);
            throw error;
        }
    }
};
--- END FILE: ./src/services/storage.service.js ---

--- START FILE: ./src/stores.js ---
// src/stores.js
import { writable } from 'svelte/store';

/**
 * Biến state chính, theo dõi tab nào đang được hiển thị.
 */
export const activeTab = writable('data-section');

/**
 * Trạng thái xác thực
 */
export const isAdmin = writable(false); 
export const currentUser = writable(null);

// === DỮ LIỆU TƯƠNG TÁC & NỘI DUNG ĐỘNG ===
export const feedbackList = writable([]);
export const userStats = writable([]); 
export const helpContent = writable({
    data: 'Đang tải hướng dẫn...',
    luyke: 'Đang tải hướng dẫn...',
    sknv: 'Đang tải hướng dẫn...',
    realtime: 'Đang tải hướng dẫn...'
});
export const composerTemplates = writable({
    luyke: '',
    sknv: '',
    realtime: ''
});
export const competitionNameMappings = writable({}); 

// Store cho cấu hình trang chủ
export const homeConfig = writable({
    videoUrl: 'https://www.youtube.com/embed/bmImlht_yB4',
    timeline: [],
    sliderImages: [],
    changelogs: []
});

/**
 * Dữ liệu thô (Raw Data)
 */
export const danhSachNhanVien = writable([]);
export const ycxData = writable([]);
export const rawGioCongData = writable([]);
export const thuongNongData = writable([]);
export const thuongERPData = writable([]);
export const pastedThiDuaReportData = writable([]);
export const realtimeYCXData = writable([]);
export const thiDuaVungChiTiet = writable([]);
export const thiDuaVungTong = writable([]);
// Dữ liệu tháng trước
export const ycxDataThangTruoc = writable([]);
export const thuongNongDataThangTruoc = writable([]);
export const thuongERPDataThangTruoc = writable([]);

/**
 * Dữ liệu đã xử lý (Processed Data)
 */
export const masterReportData = writable({
    luyke: [],
    sknv: [],
    realtime: []
});

/**
 * Dữ liệu thi đua
 */
export const competitionData = writable([]);

/**
 * Cấu hình & Khai báo
 */
export const declarations = writable({
    hinhThucXuat: '',
    hinhThucXuatGop: '',
    heSoQuyDoi: ''
});
export const categoryStructure = writable([]); 
export const brandList = writable([]); 
export const specialProductList = writable([]);

// [Mapping Stores]
export const macroCategoryConfig = writable([]); 
export const macroProductGroupConfig = writable([]); 
export const categoryNameMapping = writable({}); 
export const groupNameMapping = writable({});
export const brandNameMapping = writable({}); 

export const localCompetitionConfigs = writable([]); 
export const globalCompetitionConfigs = writable([]); 
export const globalSpecialPrograms = writable([]); 

// [MỚI] Cấu hình động cho bảng Hiệu quả & QĐC
export const efficiencyConfig = writable([]); 
export const qdcConfigStore = writable([]);
export const warehouseCustomMetrics = writable([]);

// [CẬP NHẬT] Reset về mảng rỗng để không hiện bảng mẫu khi khởi tạo
export const customRevenueTables = writable([]);

// [MỚI - PERFORMANCE TABLE] Store lưu trữ cấu hình bảng hiệu quả (Cả Admin & User)
export const customPerformanceTables = writable([]);

/**
 * Cài đặt & Trạng thái UI
 */
export const luykeGoalSettings = writable({});
export const realtimeGoalSettings = writable({});
export const highlightSettings = writable({
    luyke: {},
    sknv: {},
    realtime: {}
});
export const debugInfo = writable({});
export const employeeMaNVMap = writable(new Map());
export const employeeNameToMaNVMap = writable(new Map());
export const charts = writable({});
export const choices = writable({
    luyke_employee: null, luyke_date_picker: null, luyke_highlight_nhanhang: null, luyke_highlight_nhomhang: null, luyke_highlight_employee: null,
    sknv_employee: null, sknv_date_picker: null, sknv_highlight_nhanhang: null, sknv_highlight_nhomhang: null, sknv_highlight_employee: null,
    realtime_employee: null, realtime_highlight_nhanhang: null, realtime_highlight_nhomhang: null, realtime_highlight_employee: null,
    thiDuaVung_sieuThi: null,
    competition_group: null,
    competition_brand: null,
    special_program_group: null, 
    thidua_employee_detail: null,
    realtime_brand_category_filter: null,
    realtime_brand_filter: null,
});
export const viewingDetailFor = writable(null);
export const sortState = writable({});

/**
 * Trạng thái kho
 */
export const warehouseList = writable([]);
export const selectedWarehouse = writable(null);

// === STATE GIAO DIỆN ===
export const drawerState = writable({ activeDrawer: null });
export const modalState = writable({ activeModal: null });

export const notificationStore = writable({
    message: '',
    type: 'info', 
    visible: false
});

/**
 * Cài đặt giao diện
 */
export const interfaceSettings = writable({
    contrastLevel: '3',
    globalFontSize: '18',
    kpiFontSize: '36',
    kpiCard1Bg: '#38bdf8', kpiCard2Bg: '#34d399', kpiCard3Bg: '#fbbf24',
    kpiCard4Bg: '#2dd4bf', kpiCard5Bg: '#a78bfa', kpiCard6Bg: '#f472b6',
    kpiCard7Bg: '#818cf8', kpiCard8Bg: '#f87171',
    kpiTitleColor: '#ffffff',
    kpiMainColor: '#ffffff',
    kpiSubColor: '#ffffff'
});

// === FIREBASE STORE ===
export const firebaseStore = writable({
    app: null,
    auth: null,
    db: null,
    storage: null
});

export const fileSyncState = writable({});
--- END FILE: ./src/stores.js ---

--- START FILE: ./src/styles/base.css ---
/* Version 1.0 - Base styles (Refactored from v6.19) */
/* Chứa các thiết lập nền tảng: fonts, :root variables, body, scrollbar */

@import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');

:root {
    --global-font-size: 18px;
    --kpi-main-font-size: 36px;
    --bg-lightness-1: 98%; --header-lightness-1: 96%; --header-text-lightness-1: 25%; --special-header-lightness-1: 92%; --below-target-lightness-1: 96%;
    --bg-lightness-2: 96%; --header-lightness-2: 94%; --header-text-lightness-2: 22%; --special-header-lightness-2: 88%; --below-target-lightness-2: 94%;
    --bg-lightness-3: 94%; --header-lightness-3: 92%; --header-text-lightness-3: 18%; --special-header-lightness-3: 85%; --below-target-lightness-3: 92%; /* Normal */
    --bg-lightness-4: 92%; --header-lightness-4: 88%; --header-text-lightness-4: 15%; --special-header-lightness-4: 80%; --below-target-lightness-4: 88%;
    --bg-lightness-5: 90%; --header-lightness-5: 84%; --header-text-lightness-5: 12%; --special-header-lightness-5: 75%; --below-target-lightness-5: 84%;
    --bg-lightness-6: 88%; --header-lightness-6: 80%; --header-text-lightness-6: 10%; --special-header-lightness-6: 70%; --below-target-lightness-6: 80%;
    --kpi-card-1-bg: #38bdf8;
    --kpi-card-2-bg: #34d399; --kpi-card-3-bg: #fbbf24;
    --kpi-card-4-bg: #2dd4bf;
    --kpi-card-5-bg: #a78bfa; --kpi-card-6-bg: #f472b6;
    --kpi-card-7-bg: #818cf8;
    --kpi-card-8-bg: #f87171;
    --kpi-title-color: #ffffff;
    --kpi-main-color: #ffffff;
    --kpi-sub-color: #ffffff;
}

body {
    font-family: 'Inter', sans-serif;
    background-color: #f3f4f6;
    font-size: var(--global-font-size);
}

html[data-contrast="1"] { --bg-lightness: var(--bg-lightness-1); --header-lightness: var(--header-lightness-1); --header-text-lightness: var(--header-text-lightness-1); --special-header-lightness: var(--special-header-lightness-1); --below-target-lightness: var(--below-target-lightness-1); }
html[data-contrast="2"] { --bg-lightness: var(--bg-lightness-2); --header-lightness: var(--header-lightness-2); --header-text-lightness: var(--header-text-lightness-2); --special-header-lightness: var(--special-header-lightness-2); --below-target-lightness: var(--below-target-lightness-2); }
html[data-contrast="3"] { --bg-lightness: var(--bg-lightness-3); --header-lightness: var(--header-lightness-3); --header-text-lightness: var(--header-text-lightness-3);
--below-target-lightness: var(--below-target-lightness-3); }
html[data-contrast="4"] { --bg-lightness: var(--bg-lightness-4); --header-lightness: var(--header-lightness-4); --header-text-lightness: var(--header-text-lightness-4); --special-header-lightness: var(--special-header-lightness-4); --below-target-lightness: var(--below-target-lightness-4); }
html[data-contrast="5"] { --bg-lightness: var(--bg-lightness-5); --header-lightness: var(--header-lightness-5); --header-text-lightness: var(--header-text-lightness-5); --special-header-lightness: var(--special-header-lightness-5); --below-target-lightness: var(--below-target-lightness-5); }
html[data-contrast="6"] { --bg-lightness: var(--bg-lightness-6); --header-lightness: var(--header-lightness-6); --header-text-lightness: var(--header-text-lightness-6); --special-header-lightness: var(--special-header-lightness-6); --below-target-lightness: var(--below-target-lightness-6); }


::-webkit-scrollbar { width: 8px; }
::-webkit-scrollbar-track { background: #f1f1f1; }
::-webkit-scrollbar-thumb { background: #888; border-radius: 10px; }
::-webkit-scrollbar-thumb:hover { background: #555; }

.feather {
    width: 1.1rem;
    height: 1.1rem;
    stroke-width: 1.5;
    flex-shrink: 0;
}
--- END FILE: ./src/styles/base.css ---

--- START FILE: ./src/styles/components.css ---
/* Version 3.1 - FIX LAYOUT REGRESSION & RESIZE SUB-TABS */
/* Chứa toàn bộ style cho components: Header mới, Tabs mới, và các thành phần cũ được khôi phục */

/* =========================================
   1. MODERN HEADER & TABS (NEW)
   ========================================= */

/* Header hiện đại cho 3 tab chính */
.modern-page-header {
    background: linear-gradient(to right, #f0f9ff, #ffffff);
    padding: 1rem 1.5rem; /* Giảm padding dọc một chút cho gọn */
    border-bottom: 1px solid #e5e7eb;
    border-radius: 0.75rem 0.75rem 0 0;
    
    display: flex;
    flex-wrap: wrap;
    align-items: center;
    justify-content: space-between;
    gap: 1rem;
    margin-bottom: 0;
}

.modern-page-header .title-wrapper {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    flex-wrap: wrap;
}

.modern-page-header .main-icon {
    width: 2.25rem; /* Thu nhỏ icon chính một chút cho cân đối */
    height: 2.25rem;
    color: #2563eb;
    stroke-width: 1.5;
    padding: 5px;
    background-color: white;
    border-radius: 8px;
    box-shadow: 0 1px 2px rgba(0,0,0,0.05);
    border: 1px solid #dbeafe;
    flex-shrink: 0;
}

.modern-page-header .page-title {
    font-size: 1.25rem; /* Giảm size tiêu đề cho cân đối hơn (20px) */
    font-weight: 800;
    color: #1e40af;
    letter-spacing: -0.01em;
    margin: 0;
    line-height: 1.2;
    text-transform: uppercase; /* Thêm uppercase cho mạnh mẽ */
}

/* === [FIX] SUB-TAB BUTTON: THU NHỎ KÍCH THƯỚC === */
.sub-tab-btn {
    border-bottom: 2px solid transparent;
    padding: 0.5rem 0.75rem; /* Giảm padding để nút gọn hơn */
    transition: all 0.2s ease-in-out;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 0.4rem; /* Giảm khoảng cách giữa icon và chữ */
    color: #6b7280;
    font-weight: 600; /* Tăng độ đậm một chút để dễ đọc ở size nhỏ */
    font-size: 0.8125rem; /* ~13px: Nhỏ hơn tiêu đề, cân đối */
    background: transparent;
    border: none;
    cursor: pointer;
    white-space: nowrap;
}

.sub-tab-btn:hover {
    color: #111827;
    background-color: #f3f4f6;
    border-radius: 4px 4px 0 0;
}

.sub-tab-btn .feather {
    width: 1rem; /* Icon nhỏ lại (16px) */
    height: 1rem;
    stroke-width: 1.5;
    transition: color 0.2s;
}

/* Active State */
.sub-tab-btn.active {
    border-bottom: 2px solid #2563eb;
    color: #2563eb;
    background-color: #eff6ff;
}

.sub-tab-btn.active .feather {
    color: #2563eb;
    stroke-width: 2;
}

/* =========================================
   2. GENERAL COMPONENTS & TRANSITIONS
   ========================================= */

.nav-link,
.action-btn,
.kpi-card,
.content-card,
.tdv-item-card,
.data-input-group,
.toggle-filters-btn,
.page-header__help-btn,
.column-toggle-btn,
.rt-infographic-summary-card {
    transition: all 0.2s ease-in-out;
}

.nav-link:hover,
.action-btn:hover,
.kpi-card:hover,
.content-card:hover,
.data-input-group:hover,
.toggle-filters-btn:hover,
.rt-infographic-summary-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
}

.tdv-item-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
}

.page-header__help-btn {
    background-color: #fee2e2;
    color: #991b1b;
    border-radius: 9999px;
    width: 2rem;
    height: 2rem;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    border: none;
    cursor: pointer;
}

.page-header__help-btn:hover {
    transform: scale(1.1) translateY(-1px);
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
}

input[type="range"] {
    -webkit-appearance: none;
    appearance: none;
    width: 100%;
    height: 8px;
    background: #e5e7eb;
    border-radius: 5px;
    outline: none;
    transition: background 0.2s;
}

input[type="range"]::-webkit-slider-thumb {
    -webkit-appearance: none;
    appearance: none;
    width: 20px;
    height: 20px;
    background: #3b82f6;
    border-radius: 50%;
    cursor: pointer;
    border: 2px solid white;
    box-shadow: 0 0 5px rgba(0,0,0,0.2);
}

input[type="range"]::-moz-range-thumb {
    width: 20px;
    height: 20px;
    background: #3b82f6;
    border-radius: 50%;
    cursor: pointer;
    border: 2px solid white;
    box-shadow: 0 0 5px rgba(0,0,0,0.2);
}

/* =========================================
   3. CARDS & LAYOUT (KHẮC PHỤC LỖI DATA SECTION)
   ========================================= */

.content-card {
    background-color: white;
    border-radius: 0.75rem;
    box-shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1), 0 1px 2px -1px rgb(0 0 0 / 0.1);
    
    /* [FIX QUAN TRỌNG] Khôi phục padding mặc định để Tab Data không bị dính lề */
    padding: 1.5rem; 
    
    margin-bottom: 2rem;
    border: 1px solid #e5e7eb;
    overflow: hidden;
}

/* Class hỗ trợ cho các card sử dụng Modern Header (để header tràn viền) */
/* Lưu ý: Các file .svelte của 3 tab kia đã có class "!p-0", class đó sẽ ghi đè padding trên */
.content-card__body {
    padding: 1.5rem;
}

/* Header cũ (dùng cho DataSection - Khôi phục hiển thị đúng) */
.content-card__header { 
    display: flex; 
    align-items: center; 
    justify-content: flex-start;
    gap: 0.5rem;
    font-size: 1.125rem; 
    font-weight: 700; /* Tăng độ đậm */
    color: #374151; 
    margin-bottom: 1rem;
    margin-top: -0.5rem; /* Kéo lên một chút để cân đối với padding card */ 
    padding-bottom: 0.75rem; 
    border-bottom: 1px solid #e5e7eb; 
}

/* Notifications */
#notification { position: fixed; bottom: 20px; right: 20px; padding: 1rem 1.5rem; border-radius: 0.5rem; color: white; z-index: 1200; opacity: 0; transition: opacity 0.5s, transform 0.5s; transform: translateY(100px); }
#notification.show { opacity: 1; transform: translateY(0); }
.notification-success { background-color: #28a745; }
.notification-error { background-color: #dc3545; }

.placeholder-message { 
    border: 2px dashed #f59e0b; 
    background-color: #fffbeb; 
    color: #b45309; 
    padding: 2rem;
    border-radius: 0.75rem; 
    text-align: center; 
    font-weight: 600; 
}

[id$='-subtabs-nav'] { flex-wrap: wrap; }

/* =========================================
   4. DATA INPUT GROUPS (THEMES)
   ========================================= */

.data-input-group {
    border: 1px solid #e5e7eb;
    border-radius: 0.5rem;
    padding: 1rem; /* Tăng padding nhẹ cho input group */
    background-color: #ffffff; /* Đổi nền thành trắng cho sạch */
    display: flex;
    flex-direction: column;
    border-top: 4px solid #9ca3af;
    box-shadow: 0 1px 2px rgba(0,0,0,0.05);
}

.data-card--blue { background-color: #f0f9ff; border-color: #bae6fd; }
.data-card--green { background-color: #f0fdf4; border-color: #bbf7d0; }
.data-card--yellow { background-color: #fefce8; border-color: #fef08a; }

/* Fix màu header trong Data Section */
.data-header--blue { color: #0369a1; border-bottom-color: #7dd3fc; }
.data-header--green { color: #15803d; border-bottom-color: #86efac; }
.data-header--yellow { color: #854d0e; border-bottom-color: #fde047; }

.input-group--blue { border-top-color: #3b82f6; border-color: #dbeafe; }
.input-group--green { border-top-color: #22c55e; border-color: #dcfce7; }
.input-group--yellow { border-top-color: #f59e0b; border-color: #fef3c7; }

.input-group--blue .data-input-group__label { color: #1d4ed8; }
.input-group--green .data-input-group__label { color: #166534; }
.input-group--yellow .data-input-group__label { color: #92400e; }

.data-input-group__label { 
    font-weight: 700; 
    margin-bottom: 0.75rem; 
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-size: 1rem;
}
.data-input-group__label .feather {
    width: 1.25rem;
    height: 1.25rem;
    flex-shrink: 0;
}
.data-input-group__label--link { text-decoration: none; display: inline-flex; }
.data-input-group__label--link:hover { text-decoration: underline; }
.data-input-group__label--link > .font-normal { font-weight: 400; }

.data-input-group__content { display: flex; flex-direction: column; gap: 0.5rem; flex-grow: 1; }
.data-input-group__file-trigger { cursor: pointer; background-color: #e5e7eb; color: #374151; padding: 0.5rem 1rem; border-radius: 0.375rem; font-size: 0.875em; font-weight: 600; white-space: nowrap; }
.data-input-group__file-trigger:hover { background-color: #d1d5db; }
.data-input-group__file-name { font-size: 0.875em; color: #6b7280; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; font-style: italic; }
.data-input-group__link { color: #2563eb; text-decoration: none; font-size: 0.875em; display: inline-flex; }
.data-input-group__link:hover { text-decoration: underline; }
.data-input-group__status-wrapper { min-height: 1rem; margin-top: 0.25rem; }
.data-input-group__status-text { font-size: 0.8rem; font-weight: 600; }
.data-input-group__status-text--default { color: #6b7280; }
.data-input-group__status-text--success { color: #16a34a; }
.data-input-group__status-text--error { color: #dc2626; }

.data-textarea { width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 0.375rem; font-size: 0.875em; font-family: 'Inter', sans-serif; line-height: 1.5; }
.data-textarea:focus { outline: 2px solid transparent; outline-offset: 2px; border-color: #3b82f6; box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.2); }

.progress-bar-container { overflow: hidden; height: 4px; border-radius: 2px; background-color: #e5e7eb; margin-top: 4px; }
.progress-bar { background-image: linear-gradient(45deg, rgba(255, 255, 255, .15) 25%, transparent 25%, transparent 50%, rgba(255, 255, 255, .15) 50%, rgba(255, 255, 255, .15) 75%, transparent 75%, transparent); background-size: 1rem 1rem; animation: progress-bar-stripes 1s linear infinite; background-color: #3b82f6; height: 100%; transition: width 0.3s; }
@keyframes progress-bar-stripes { from { background-position: 1rem 0; } to { background-position: 0 0; } }

/* =========================================
   5. INTERACTIVE TABLES
   ========================================= */

.interactive-row {
    transition: transform 0.2s ease-out, box-shadow 0.2s ease-out;
    cursor: pointer;
}
.interactive-row:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
    background-color: #eff6ff;
}
.interactive-row .employee-name-cell {
    cursor: pointer;
    color: #2563eb;
    transition: color 0.2s ease-out;
}
.interactive-row:hover .employee-name-cell {
    text-decoration: underline;
    color: #1d4ed8;
}

.income-positive { color: #16a34a; }
.income-negative { color: #dc2626; }
.line-clamp-2 { display: -webkit-box; -webkit-line-clamp: 2; line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }

/* =========================================
   6. KPI CARDS
   ========================================= */

.kpi-card { background-color: white; border-radius: 0.75rem; padding: 1rem; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
.kpi-card-title { color: var(--kpi-title-color); opacity: 0.9; font-size: 0.9em; font-weight: 600; text-transform: uppercase; }
.kpi-card p[id$="-main"] { color: var(--kpi-main-color); font-size: var(--kpi-main-font-size); transition: font-size 0.2s ease-in-out; }
.kpi-card p[id$="-sub"], .kpi-card p[id$="-sub1"], .kpi-card p[id$="-sub2"] { color: var(--kpi-sub-color); font-size: 0.95em; }

.kpi-percentage, .kpi-percentage-value { font-weight: 700; }
.kpi-sub-value { opacity: 0.9; }

/* KPI Card Colors */
#luyke-kpi-cards-container .kpi-card:nth-child(1), #realtime-kpi-cards-container .kpi-card:nth-child(1) { background-color: var(--kpi-card-1-bg); }
#luyke-kpi-cards-container .kpi-card:nth-child(2), #realtime-kpi-cards-container .kpi-card:nth-child(2) { background-color: var(--kpi-card-2-bg); }
#luyke-kpi-cards-container .kpi-card:nth-child(3), #realtime-kpi-cards-container .kpi-card:nth-child(3) { background-color: var(--kpi-card-3-bg); }
#luyke-kpi-cards-container .kpi-card:nth-child(4), #realtime-kpi-cards-container .kpi-card:nth-child(4) { background-color: var(--kpi-card-4-bg); }
#luyke-kpi-cards-container .kpi-card:nth-child(5) { background-color: var(--kpi-card-5-bg); }
#luyke-kpi-cards-container .kpi-card:nth-child(6) { background-color: var(--kpi-card-6-bg); }
#luyke-kpi-cards-container .kpi-card:nth-child(7) { background-color: var(--kpi-card-7-bg); }
#luyke-kpi-cards-container .kpi-card:nth-child(8) { background-color: var(--kpi-card-8-bg); }

/* =========================================
   7. BUTTONS & ACTIONS
   ========================================= */

.toggle-filters-btn { display: inline-flex; align-items: center; gap: 0.5rem; padding: 0.5rem 1rem; border-radius: 0.5rem; background-color: #f3f4f6; color: #4b5563; font-weight: 500; font-size: 0.875em; cursor: pointer; margin-bottom: 1rem; border: 1px solid #e5e7eb; }
.toggle-filters-btn .icon { width: 1rem; height: 1rem; transition: transform 0.3s ease-in-out; }
.toggle-filters-btn.active .icon { transform: rotate(180deg); }

.highlight-trigger { background: none; border: none; cursor: pointer; color: #6b7280; }
.highlight-trigger:hover { color: #1d4ed8; }
.highlighted-row td { animation: pulse-bg 2s infinite; }
@keyframes pulse-bg { 0% { background-color: var(--highlight-color, #ffff99); } 50% { background-color: var(--highlight-color-light, #ffffcc); } 100% { background-color: var(--highlight-color, #ffff99); } }

.action-btn {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
    padding: 0.5rem 1rem;
    border-radius: 0.5rem;
    font-weight: 600;
    font-size: 0.8125rem; /* Đồng bộ size với Sub-tab */
    cursor: pointer;
    border: 1px solid transparent;
    transition: all 0.2s;
    box-shadow: 0 1px 2px rgba(0,0,0,0.05);
}
.action-btn--composer { background-color: #ede9fe; color: #5b21b6; border-color: #c4b5fd; }
.action-btn--composer:hover { background-color: #d8b4fe; }
.action-btn--export { background-color: #dcfce7; color: #166534; border-color: #86efac; }
.action-btn--export:hover { background-color: #bbf7d0; }
.action-btn--capture { background-color: #dbeafe; color: #1e40af; border-color: #93c5fd; }
.action-btn--capture:hover { background-color: #bfdbfe; }
.action-btn--save { background-color: #16a34a; color: white; }
.action-btn--save:hover { background-color: #15803d; }
.action-btn--copy { background-color: #2563eb; color: white; }
.action-btn--copy:hover { background-color: #1d4ed8; }

/* =========================================
   8. MODALS
   ========================================= */

.modal { position: fixed; inset: 0; z-index: 1000; display: flex; align-items: center; justify-content: center; }
.modal.hidden { display: none; }
.modal__overlay { position: absolute; inset: 0; background-color: rgba(17, 24, 39, 0.6); backdrop-filter: blur(4px); cursor: pointer; }
.modal__container { position: relative; z-index: 1001; background-color: white; border-radius: 0.75rem; box-shadow: 0 20px 25px -5px rgb(0 0 0 / 0.1), 0 8px 10px -6px rgb(0 0 0 / 0.1); width: 90%; max-width: 600px; max-height: 90vh; display: flex; flex-direction: column; }

#force-update-modal .modal__overlay { cursor: not-allowed; }

.modal__container--large { max-width: 900px; }
.modal__header { padding: 1rem 1.5rem; border-bottom: 1px solid #e5e7eb; display: flex; justify-content: space-between; align-items: center; flex-shrink: 0; }
.modal__title { font-size: 1.25rem; font-weight: 600; color: #1f2937; }
.modal__close-btn { font-size: 1.75rem; line-height: 1; color: #6b7280; background: none; border: none; cursor: pointer; }
.modal__close-btn:hover { color: #111827; }
.modal__content { padding: 1.5rem; overflow-y: auto; flex-grow: 1; }
.modal__content h4 { font-size: 1.125rem; font-weight: 600; color: #1e3a8a; margin-bottom: 0.75rem; }
.modal__content p { margin-bottom: 0.75rem; color: #374151; line-height: 1.6; }
.modal__content ul { list-style-type: disc; list-style-position: inside; margin-left: 0.5rem; }
.modal__content ul > * + * { margin-top: 0.5rem; }
.modal__footer { padding: 1rem 1.5rem; border-top: 1px solid #e5e7eb; background-color: #f9fafb; display: flex; justify-content: flex-end; gap: 0.75rem; flex-shrink: 0; }

#login-modal .modal__overlay { cursor: not-allowed; }
#login-modal .modal__container { box-shadow: 0 25px 50px -12px rgb(0 0 0 / 0.25); }
#login-modal input[type="email"]:focus { border-color: #3b82f6; box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.4); outline: none; }

/* =========================================
   9. INFOGRAPHIC & REALTIME STYLES
   ========================================= */

.view-switcher { display: flex; align-items: center; padding: 0.25rem; background-color: #e5e7eb; border-radius: 0.5rem; }
.view-switcher__btn { padding: 0.5rem 1rem; border: none; background-color: transparent; border-radius: 0.375rem; font-weight: 500; color: #4b5563; cursor: pointer; }
.view-switcher__btn.active { background-color: white; color: #3b82f6; box-shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1); }

.infographic-card { border: 1px solid #e5e7eb; border-radius: 0.5rem; overflow: hidden; }
.infographic-card__header { padding: 0.75rem 1rem; font-weight: 700; }
.infographic-card__header--completed { background-color: #dcfce7; color: #166534; }
.infographic-card__header--pending { background-color: #fee2e2; color: #991b1b; }
.infographic-card__body { padding: 1rem; background-color: #f9fafb; }
.infographic-card__item { border-bottom: 1px dashed #d1d5db; padding: 0.75rem 0; }
.infographic-card__item:last-child { border-bottom: none; }
.infographic-card__title { font-weight: 600; color: #1f2937; margin-bottom: 0.5rem; }
.infographic-card__metrics { display: grid; grid-template-columns: repeat(2, minmax(0, 1fr)); gap: 0.5rem 1rem; font-size: 0.875em; }
.metric-label { color: #6b7280; }
.metric-value { font-weight: 600; color: #111827; text-align: right; }
.metric-value.is-negative { color: #ef4444; }
.metric-value.is-positive { color: #22c55e; }

/* RT Infographic */
.rt-infographic-container { background-color: #f9fafb; border-radius: 0.75rem; border: 1px solid #e5e7eb; padding: 1.5rem; }
.rt-infographic-header .employee-name { font-size: 1.5rem; font-weight: 800; color: #111827; }
.rt-infographic-header .employee-title { font-size: 1rem; font-weight: 500; color: #6b7280; }
.rt-infographic-summary { display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 1rem; margin-top: 1.5rem; }
.rt-infographic-summary-card { background-color: white; border-radius: 0.5rem; padding: 1rem; text-align: center; border: 1px solid #e5e7eb; }
.rt-infographic-summary-card .label { font-size: 0.875em; color: #4b5563; font-weight: 500; display: flex; align-items: center; justify-content: center; gap: 0.25rem; }
.rt-infographic-summary-card .label .feather { width: 1em; height: 1em; }
.rt-infographic-summary-card .value { font-size: 1.75rem; font-weight: 700; color: #3b82f6; margin-top: 0.25rem; }
.rt-infographic-summary-card .value.is-positive { color: #2563eb; }
.rt-infographic-summary-card .value.is-negative { color: #dc2626; }
.rt-infographic-summary-card .value.is-dat { color: #16a34a !important; }
.rt-infographic-summary-card .value.is-gan-dat { color: #f59e0b !important; }
.rt-infographic-summary-card .value.is-can-co-gang { color: #dc2626 !important; }

.rt-infographic-grid { display: grid; grid-template-columns: repeat(1, minmax(0, 1fr)); gap: 1.5rem; margin-top: 1.5rem; }
@media (min-width: 1024px) { .rt-infographic-grid { grid-template-columns: repeat(2, minmax(0, 1fr)); } }
.rt-infographic-section h4 { font-size: 1.125rem; font-weight: 700; color: #1f2937; margin-bottom: 1rem; }
.rt-progress-bar-item { margin-bottom: 0.75rem; }
.rt-progress-bar-label { display: flex; justify-content: space-between; font-size: 0.875em; font-weight: 500; margin-bottom: 0.25rem; }
.rt-progress-bar-container { background-color: #e5e7eb; border-radius: 9999px; height: 0.75rem; overflow: hidden; }
.rt-progress-bar { background-color: #22c55e; height: 100%; border-radius: 9999px; transition: width 0.5s ease-in-out; }

/* RT Customer Accordion */
.rt-customer-accordion { max-height: 400px; overflow-y: auto; border: 1px solid #e5e7eb; border-radius: 0.5rem; }
.rt-customer-header { background-color: white; padding: 0.75rem 1rem; border-bottom: 1px solid #e5e7eb; cursor: pointer; display: flex; justify-content: space-between; align-items: center; font-weight: 600; list-style: none; }
.rt-customer-header::-webkit-details-marker { display: none; }
.rt-customer-header:hover { background-color: #f9fafb; }
.rt-customer-header .arrow { transition: transform 0.3s; }
.rt-customer-header .product-count { color: #dc2626; font-weight: bold; }
details[open] > summary .arrow { transform: rotate(180deg); }
.rt-customer-details { background-color: #f9fafb; padding: 1rem; }
.rt-customer-details table { font-size: 0.8rem; }

/* =========================================
   10. MISCELLANEOUS COMPONENTS
   ========================================= */

.preview-content { background-color: #f3f4f6; padding: 1rem; border-radius: 0.5rem; white-space: pre-wrap; word-wrap: break-word; font-size: 0.875em; line-height: 1.6; color: #1f2937; font-family: 'Inter', sans-serif; }

.header-qr-container { display: flex; flex-direction: column; align-items: center; gap: 4px; border: 2px solid #ef4444; padding: 4px; border-radius: 8px; background-color: white; }
.header-qr-container span { font-size: 0.75rem; font-weight: 600; color: #b91c1c; }
.header-qr-image { width: 50px; height: 50px; background-color: #f3f4f6; border-radius: 4px; }

.selection-item { display: flex; align-items: center; padding: 0.5rem; border-radius: 0.375rem; cursor: pointer; transition: background-color 0.2s ease-in-out; }
.selection-item:hover { background-color: #f3f4f6; }
.selection-item input[type="checkbox"] { width: 1rem; height: 1rem; margin-right: 0.75rem; }
.selection-item label { flex-grow: 1; cursor: pointer; }

.settings-trigger-btn { background: none; border: none; cursor: pointer; color: #9ca3af; transition: color 0.2s ease-in-out, transform 0.2s ease-in-out; padding: 2px; }
.settings-trigger-btn:hover { color: #3b82f6; transform: rotate(45deg); }
.settings-trigger-btn svg { width: 18px; height: 18px; display: block; }

#version-marquee-container { flex-grow: 1; margin: 0 1.5rem; overflow: hidden; position: relative; background-color: #eef2ff; border: 1px solid #c7d2fe; border-radius: 9999px; cursor: pointer; height: 38px; }
#version-marquee-container:hover .marquee-text { animation-play-state: paused; color: #312e81; }
.marquee-text { position: absolute; white-space: nowrap; will-change: transform; animation: marquee-scroll 25s linear infinite; font-weight: 600; color: #4338ca; line-height: 36px; }
@keyframes marquee-scroll { from { transform: translateX(100%); } to { transform: translateX(-100%); } }

.competition-summary-counter strong { font-size: 1.15rem !important; font-weight: 800 !important; white-space: nowrap; }
.competition-summary-counter .text-blue-600 { color: #2563eb !important; }
.competition-summary-counter .text-red-600 { color: #dc2626 !important; }

/* Column Toggle Button */
.column-toggle-btn { padding: 4px 12px; font-size: 12px; font-weight: 500; border: 1px solid; border-radius: 9999px; cursor: pointer; transition: all 0.2s ease-in-out; user-select: none; }
.column-toggle-btn.active { background-color: #3b82f6; color: white; border-color: #3b82f6; }
.column-toggle-btn:not(.active) { background-color: #e5e7eb; color: #374151; border-color: #d1d5db; }
.column-toggle-btn:not(.active):hover { background-color: #d1d5db; }
.column-toggle-btn.draggable-tag { cursor: grab; }
.column-toggle-btn.draggable-tag:active { cursor: grabbing; }
.column-toggle-btn.draggable-tag:hover { transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
.drag-handle-icon { color: #6b7280; transition: color 0.2s ease-in-out; cursor: grab; }
.drag-handle-icon:active { cursor: grabbing; }
.column-toggle-btn.draggable-tag:hover .drag-handle-icon { color: #1f2937; }

/* Draggable & Sortable */
.draggable-header { cursor: move; cursor: grab; }
.draggable-header:active { cursor: grabbing; }
.sortable-ghost { opacity: 0.4; background-color: #c7d2fe; }
.sortable-drag { opacity: 0.95; transform: rotate(-2deg); box-shadow: 0 8px 16px rgba(0,0,0,0.2); }

#sidebar .feather { width: 1.5rem; height: 1.5rem; stroke-width: 2; }
.page-header__help-btn .feather { width: 1.25rem; height: 1.25rem; }

/* LUY KE DETAIL */
.luyke-detail-header h3 { font-size: 1.75rem; font-weight: 800; color: #111827; text-align: center; }
.luyke-detail-progress-item { display: flex; flex-direction: column; gap: 4px; }
.luyke-detail-progress-label { display: flex; justify-content: space-between; align-items: baseline; font-size: 0.875rem; }
.luyke-detail-progress-values { display: flex; justify-content: space-between; font-size: 0.75rem; color: #4b5563; }
.luyke-detail-chart-container { position: relative; height: 350px; width: 100%; }

/* CUSTOMER ACCORDION (LUYKE) */
.customer-accordion-luyke summary { display: flex; flex-wrap: wrap; align-items: center; gap: 1rem; padding: 0.5rem 1rem; cursor: pointer; list-style: none; font-weight: 400; color: #4b5563; }
.customer-accordion-luyke summary:hover { background-color: #f9fafb; }
.customer-accordion-luyke .customer-name-small { font-weight: 500; font-size: 0.9rem; color: #2563eb; flex-grow: 1; min-width: 120px; }
.customer-accordion-luyke .order-metrics { display: flex; align-items: center; gap: 1rem; flex-shrink: 0; font-size: 0.75rem; }
.customer-accordion-luyke .order-metrics span { white-space: nowrap; }
.customer-accordion-luyke .order-metrics strong { font-weight: 500; color: #1f2937; }
.customer-accordion-luyke .order-metrics .text-gray-900 { color: #1f2937 !important; }
.customer-accordion-luyke .order-metrics .text-blue-600 { color: #2563eb !important; }
.customer-accordion-luyke .accordion-arrow { margin-left: auto; color: #9ca3af; transition: transform 0.2s ease-in-out; }
.customer-accordion-luyke details[open] > summary .accordion-arrow { transform: rotate(180deg); }
.customer-accordion-luyke .product-list-scrollable { display: block; max-height: 200px; overflow-y: auto; }
.customer-accordion-luyke .product-list-table { width: 100%; }
.customer-accordion-luyke .qd-below-target { color: #b91c1c; }
.customer-accordion-luyke .qd-above-target { color: #1d4ed8; }

/* CAPTURE PRESETS */
.capture-container.preset-mobile-portrait .preset-mobile-capture-area { box-sizing: border-box; }
.capture-container.preset-mobile-portrait #customer-detail-list-container,
.capture-container.preset-mobile-portrait #unexported-detail-list-container { width: 100% !important; max-width: 100% !important; box-sizing: border-box; }
--- END FILE: ./src/styles/components.css ---

--- START FILE: ./src/styles/dashboard-luyke.css ---
/* src/styles/dashboard-luyke.css */
/* Version 3.3 - Add CSS Variables support for KPI Cards */

/* =========================================
   1. LAYOUT & SCROLLING
   ========================================= */
.luyke-dashboard-container {
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
}

.luyke-tier-1-grid {
    display: grid;
    grid-template-columns: 1fr;
    gap: 1.5rem;
    height: auto;
}

@media (min-width: 1024px) {
    .luyke-tier-1-grid {
        grid-template-columns: repeat(2, 1fr);
        height: 480px;
    }
}

.luyke-widget {
    background-color: #ffffff;
    border: 1px solid #e5e7eb;
    border-radius: 0.75rem;
    box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.05);
    display: flex;
    flex-direction: column;
    height: 100%;
    overflow: hidden;
}

.luyke-widget-body {
    padding: 0.75rem;
    flex-grow: 1;
    overflow-y: auto;
    min-height: 0;
}

.luyke-widget-header {
    padding: 0.75rem 1rem;
    border-bottom: 1px solid #f3f4f6;
    display: flex;
    justify-content: space-between;
    align-items: center;
    background-color: #ffffff;
    flex-shrink: 0;
}

.luyke-widget-title {
    font-size: 0.95rem;
    font-weight: 700;
    color: #374151;
    text-transform: uppercase;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

/* =========================================
   2. KPI CARDS (SOLID STYLE - CSS VARIABLES)
   ========================================= */
.kpi-grid-fixed {
    display: grid;
    grid-template-columns: repeat(1, 1fr);
    gap: 1rem;
}
@media (min-width: 768px) { .kpi-grid-fixed { grid-template-columns: repeat(2, 1fr); } }
@media (min-width: 1280px) { .kpi-grid-fixed { grid-template-columns: repeat(4, 1fr); } }

.kpi-card-solid {
    border-radius: 1rem;
    padding: 1.25rem;
    color: white;
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
    display: flex;
    flex-direction: column;
    justify-content: space-between;
    transition: transform 0.2s, box-shadow 0.2s, background-color 0.3s; /* Thêm transition bg */
    min-height: 140px;
    position: relative;
    overflow: hidden;
}

/* [MỚI] Mapping biến CSS cho các thẻ KPI */
.kpi-card-solid.card-1 { background-color: var(--kpi-card-1-bg, #38bdf8); }
.kpi-card-solid.card-2 { background-color: var(--kpi-card-2-bg, #34d399); }
.kpi-card-solid.card-3 { background-color: var(--kpi-card-3-bg, #fbbf24); }
.kpi-card-solid.card-4 { background-color: var(--kpi-card-4-bg, #2dd4bf); }
.kpi-card-solid.card-5 { background-color: var(--kpi-card-5-bg, #a78bfa); }
.kpi-card-solid.card-6 { background-color: var(--kpi-card-6-bg, #f472b6); }
.kpi-card-solid.card-7 { background-color: var(--kpi-card-7-bg, #818cf8); }
.kpi-card-solid.card-8 { background-color: var(--kpi-card-8-bg, #f87171); }

.kpi-card-solid:hover {
    transform: translateY(-2px);
    box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.2);
}

.kpi-bg-icon {
    position: absolute;
    right: -10px;
    bottom: -10px;
    opacity: 0.15;
    transform: rotate(-15deg);
    pointer-events: none;
}
.kpi-bg-icon svg { width: 5rem; height: 5rem; }

.kpi-solid-header {
    font-size: 0.75rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    opacity: 0.9;
    margin-bottom: 0.5rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
    color: var(--kpi-title-color, #ffffff); /* Dùng biến */
}

.kpi-solid-value {
    font-size: var(--kpi-main-font-size, 2rem); /* Dùng biến */
    font-weight: 800;
    line-height: 1;
    margin-bottom: 0.75rem;
    text-shadow: 0 1px 2px rgba(0,0,0,0.1);
    color: var(--kpi-main-color, #ffffff); /* Dùng biến */
}

.kpi-solid-sub {
    font-size: 0.8rem;
    font-weight: 500;
    border-top: 1px solid rgba(255,255,255,0.3);
    padding-top: 0.5rem;
    display: flex;
    justify-content: space-between;
    color: var(--kpi-sub-color, #ffffff); /* Dùng biến */
}

/* ... (Phần còn lại của file giữ nguyên: EFFICIENCY LIST, CATEGORY CARDS, TOOLBAR, FILTER DROPDOWN) ... */
.eff-item-compact {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    padding: 0.75rem 0;
    border-bottom: 1px dashed #f3f4f6;
    width: 100%;
}
.eff-item-compact:last-child { border-bottom: none; }
.eff-icon-compact {
    width: 2.5rem;
    height: 2.5rem;
    border-radius: 0.5rem;
    background-color: #f3f4f6;
    color: #6b7280;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
}
.eff-content-compact {
    flex-grow: 1;
    min-width: 0;
    display: flex;
    flex-direction: column;
    justify-content: center;
}
.eff-row-top {
    display: flex;
    justify-content: space-between;
    align-items: baseline;
    margin-bottom: 4px;
    width: 100%;
}
.eff-label-text { font-size: 0.9rem; font-weight: 600; color: #374151; }
.eff-value-text { font-size: 1rem; font-weight: 800; }
.eff-row-bottom { display: flex; align-items: center; gap: 0.75rem; width: 100%; }
.eff-bar-container { flex-grow: 1; height: 8px; background-color: #e5e7eb; border-radius: 4px; overflow: hidden; }
.eff-bar-fill { height: 100%; border-radius: 4px; transition: width 0.6s ease-out; }
.eff-target-text { font-size: 0.75rem; color: #6b7280; font-weight: 500; white-space: nowrap; min-width: 65px; text-align: right; }
.luyke-cat-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 0.75rem; }
.cat-card-colorful { border-radius: 0.75rem; padding: 0.75rem; transition: all 0.2s; border: 1px solid transparent; display: flex; flex-direction: column; justify-content: space-between; min-height: 110px; }
.cat-card-colorful:hover { transform: translateY(-3px); box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }
.theme-blue { background-color: #eff6ff; border-color: #bfdbfe; }
.theme-blue .cat-icon-box { background-color: #dbeafe; color: #2563eb; }
.theme-blue .cat-value-text { color: #1e40af; }
.theme-green { background-color: #ecfdf5; border-color: #a7f3d0; }
.theme-green .cat-icon-box { background-color: #d1fae5; color: #059669; }
.theme-green .cat-value-text { color: #065f46; }
.theme-orange { background-color: #fff7ed; border-color: #fed7aa; }
.theme-orange .cat-icon-box { background-color: #ffedd5; color: #ea580c; }
.theme-orange .cat-value-text { color: #9a3412; }
.theme-purple { background-color: #f5f3ff; border-color: #ddd6fe; }
.theme-purple .cat-icon-box { background-color: #ede9fe; color: #7c3aed; }
.theme-purple .cat-value-text { color: #5b21b6; }
.theme-teal { background-color: #f0fdfa; border-color: #99f6e4; }
.theme-teal .cat-icon-box { background-color: #ccfbf1; color: #0f766e; }
.theme-teal .cat-value-text { color: #115e59; }
.theme-gray { background-color: #f9fafb; border-color: #e5e7eb; }
.theme-gray .cat-icon-box { background-color: #f3f4f6; color: #4b5563; }
.theme-gray .cat-value-text { color: #1f2937; }
.theme-warning { background-color: #fffbeb; border-color: #fde047; background-image: repeating-linear-gradient(45deg, #fffbeb, #fffbeb 10px, #fef3c7 10px, #fef3c7 20px); }
.theme-warning .cat-icon-box { background-color: #fff7ed; color: #d97706; }
.theme-warning .cat-value-text { color: #b45309; }
.cat-top-row { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 0.5rem; }
.cat-icon-box { width: 2rem; height: 2rem; border-radius: 0.5rem; display: flex; align-items: center; justify-content: center; }
.cat-name-text { font-size: 0.85rem; font-weight: 700; color: #374151; margin-bottom: 0.25rem; line-height: 1.2; min-height: 2.4em; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
.cat-value-text { font-size: 1.25rem; font-weight: 800; line-height: 1; margin-bottom: 0.5rem; }
.cat-footer-row { display: flex; justify-content: space-between; align-items: center; font-size: 0.7rem; color: #6b7280; padding-top: 0.5rem; border-top: 1px solid rgba(0,0,0,0.05); }
.cat-percent-text { font-weight: 600; opacity: 0.8; }
.luyke-toolbar { background-color: #ffffff; padding: 0.5rem 1rem; border-bottom: 1px solid #e5e7eb; border-radius: 0.75rem 0.75rem 0 0; display: flex; flex-wrap: wrap; justify-content: space-between; align-items: center; gap: 1rem; }
.luyke-toolbar + .luyke-cat-grid, .luyke-toolbar + .luyke-charts-container { background-color: white; padding: 1rem; border: 1px solid #e5e7eb; border-top: none; border-radius: 0 0 0.75rem 0.75rem; }
.toggle-wrapper { display: inline-flex; align-items: center; gap: 8px; cursor: pointer; user-select: none; padding: 6px 12px; border-radius: 999px; background-color: #f3f4f6; border: 1px solid #e5e7eb; transition: all 0.2s; }
.toggle-wrapper:hover { background-color: #e5e7eb; }
.toggle-wrapper.active { background-color: #fff7ed; border-color: #fdba74; }
.toggle-switch { position: relative; width: 36px; height: 20px; background-color: #d1d5db; border-radius: 9999px; transition: background-color 0.3s; flex-shrink: 0; }
.toggle-switch::after { content: ''; position: absolute; top: 2px; left: 2px; width: 16px; height: 16px; background-color: white; border-radius: 50%; transition: transform 0.3s; box-shadow: 0 1px 2px rgba(0,0,0,0.2); }
.toggle-wrapper.active .toggle-switch { background-color: #f97316; }
.toggle-wrapper.active .toggle-switch::after { transform: translateX(16px); }
.toggle-label { font-size: 0.8rem; font-weight: 600; color: #4b5563; }
.toggle-wrapper.active .toggle-label { color: #c2410c; }
.view-mode-btn { display: inline-flex; align-items: center; gap: 4px; padding: 6px 12px; border-radius: 6px; font-size: 0.8rem; font-weight: 600; color: #6b7280; background-color: transparent; border: 1px solid transparent; transition: all 0.2s; }
.view-mode-btn:hover { background-color: #f3f4f6; }
.view-mode-btn.active { background-color: #eff6ff; color: #2563eb; border-color: #bfdbfe; }
.luyke-charts-container { display: grid; grid-template-columns: 1fr; gap: 1.5rem; }
@media (min-width: 1024px) { .luyke-charts-container { grid-template-columns: 4fr 6fr; } }
.chart-box { display: flex; flex-direction: column; height: 350px; position: relative; }
.filter-dropdown { position: absolute; top: 100%; right: 0; margin-top: 0.5rem; width: 280px; background-color: white; border: 1px solid #e5e7eb; border-radius: 0.5rem; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); z-index: 50; display: flex; flex-direction: column; max-height: 400px; }
.filter-header { padding: 0.75rem; border-bottom: 1px solid #f3f4f6; background-color: #f9fafb; border-radius: 0.5rem 0.5rem 0 0; }
.filter-search { width: 100%; padding: 0.5rem; font-size: 0.85rem; border: 1px solid #d1d5db; border-radius: 0.375rem; outline: none; }
.filter-search:focus { border-color: #3b82f6; }
.filter-body { overflow-y: auto; padding: 0.5rem; }
.filter-item { display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem; cursor: pointer; border-radius: 0.25rem; transition: background-color 0.1s; }
.filter-item:hover { background-color: #f3f4f6; }
.filter-item input[type="checkbox"] { width: 1rem; height: 1rem; border-radius: 0.25rem; cursor: pointer; accent-color: #3b82f6; }
.filter-item label { flex-grow: 1; font-size: 0.85rem; color: #374151; cursor: pointer; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.filter-actions { padding: 0.5rem; border-top: 1px solid #f3f4f6; display: flex; justify-content: space-between; background-color: #f9fafb; border-radius: 0 0 0.5rem 0.5rem; }
.filter-btn-link { font-size: 0.75rem; color: #2563eb; background: none; border: none; cursor: pointer; font-weight: 600; }
.filter-btn-link:hover { text-decoration: underline; }
.luyke-icon-btn { padding: 0.4rem; border-radius: 0.375rem; color: #6b7280; background-color: white; border: 1px solid #d1d5db; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; justify-content: center; }
.luyke-icon-btn:hover { color: #3b82f6; border-color: #3b82f6; background-color: #eff6ff; }
.luyke-icon-btn.active { background-color: #dbeafe; color: #1e40af; border-color: #93c5fd; }
.luyke-search-input { padding: 0.4rem 0.75rem; border: 1px solid #d1d5db; border-radius: 0.375rem; font-size: 0.875rem; outline: none; transition: border-color 0.2s; width: 200px; }
.luyke-search-input:focus { border-color: #3b82f6; box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.1); }
--- END FILE: ./src/styles/dashboard-luyke.css ---

--- START FILE: ./src/styles/layout.css ---
/* Version 1.0 - Layout styles (Refactored from v6.19) */
/* Chứa các ID và class định hình bố cục chính: sidebar, main-content, drawers, page-header */

#sidebar { 
    width: 68px; 
    transition: width 0.3s ease-in-out; 
    overflow-x: hidden; 
}
#sidebar:hover { 
    width: 256px; 
}
#sidebar.menu-locked:hover { 
    width: 68px; 
}

#sidebar .nav-link, #sidebar button {
    white-space: nowrap;
    gap: 1rem;
    justify-content: flex-start; /* FIX: Canh lề trái cho icon và text */
}

.menu-text {
    transition: opacity 0.2s ease-in-out, width 0.3s ease-in-out;
    opacity: 0;
    white-space: nowrap;
    width: 0;
    overflow: hidden;
}
#sidebar:hover .menu-text {
    opacity: 1;
    transition-delay: 0.1s;
    width: auto;
}
#sidebar.menu-locked:hover .menu-text {
    opacity: 0;
    width: 0;
}

/* === START: SỬA LỖI (v6.14) === */
#main-content { 
    transition: margin-left 0.3s ease-in-out; 
    margin-left: 68px; 
    min-width: 0; /* Ngăn flex item co giãn theo nội dung con (cái bảng rộng) */
}
/* === END: SỬA LỖI (v6.14) === */

.settings-drawer { 
    width: 400px; 
    max-width: 90vw; 
    transform: translateX(-100%); 
    transition: transform 0.3s ease-in-out; 
}
.settings-drawer.open { 
    transform: translateX(0); 
}
.close-drawer-btn { 
    font-size: 2rem; 
    line-height: 1; 
}

.page-header { 
    display: flex; 
    flex-wrap: wrap; 
    justify-content: space-between; 
    align-items: center; 
    gap: 1rem; 
    margin-bottom: 1.5rem; 
}
.page-header__title { 
    font-size: 1.75rem; 
    font-weight: 700; 
    color: #1f2937; 
}
--- END FILE: ./src/styles/layout.css ---

--- START FILE: ./src/styles/specific-composer.css ---
/* Version 1.0 - Specific: Composer (Refactored from v6.19) */
/* Chứa các style CHỈ dành riêng cho modal Trình tạo Nhận xét & Xem trước */

.composer { 
    display: flex; 
    flex-direction: column; 
    gap: 1.5rem; 
}
.composer__editor { 
    flex-grow: 1; 
}
.composer__tags { 
    width: 100%; 
}
.composer__label { 
    display: block; 
    font-weight: 500; 
    color: #374151; 
    margin-bottom: 0.5rem; 
}
.composer__textarea { 
    width: 100%; 
    border: 1px solid #d1d5db; 
    border-radius: 0.5rem; 
    padding: 0.75rem; 
    font-size: 0.875em; 
    resize: vertical; 
}
.composer__textarea:focus { 
    border-color: #3b82f6; 
    box-shadow: 0 0 0 1px #3b82f6; 
    outline: none; 
}
.composer__nav { 
    display: flex; 
    border-bottom: 1px solid #e5e7eb; 
    margin-bottom: 1rem; 
}
.composer__tab-btn { 
    padding: 0.5rem 1rem; 
    border: none; 
    background-color: transparent; 
    cursor: pointer; 
    font-weight: 500; 
    color: #6b7280; 
    border-bottom: 2px solid transparent; 
    margin-bottom: -1px; 
    font-size: 0.875em; 
}
.composer__tab-btn.active { 
    color: #3b82f6; 
    border-bottom-color: #3b82f6; 
}
.composer__tab-pane {
    display: none; 
}
.composer__tab-pane.active { 
    display: block; 
}
.composer__tag-group { 
    margin-bottom: 1rem; 
}
.composer__tag-group:last-child { 
    margin-bottom: 0; 
}
.composer__tag-group-title { 
    font-weight: 600; 
    font-size: 0.875em; 
    color: #4b5563; 
    margin-bottom: 0.75rem; 
    border-bottom: 1px solid #e5e7eb; 
    padding-bottom: 0.5rem; 
}
.composer__tag-btn { 
    background-color: #e0e7ff; 
    color: #3730a3; 
    border: 1px solid #c7d2fe; 
    border-radius: 9999px; 
    padding: 0.25rem 0.75rem; 
    font-size: 0.8rem; 
    font-weight: 500; 
    cursor: pointer; 
    margin: 0.25rem; 
}
.composer__icon-btn { 
    background-color: #f3f4f6; 
    color: #1f2937; 
    border: 1px solid #d1d5db; 
    border-radius: 9999px; 
    padding: 0.25rem 0.75rem; 
    font-size: 1.1rem; 
    font-weight: 500; 
    cursor: pointer; 
    margin: 0.25rem; 
    line-height: 1; 
}
.composer__filter-group { 
    margin-bottom: 1rem;
    padding-bottom: 1rem; 
    border-bottom: 1px solid #e5e7eb; 
}
.composer__select { 
    width: 100%; 
    padding: 0.5rem; 
    border: 1px solid #d1d5db; 
    border-radius: 0.375rem; 
    background-color: white; 
}
@media (min-width: 768px) { 
    .composer { 
        flex-direction: row; 
    } 
    .composer__tags { 
        width: 350px; 
        flex-shrink: 0; 
        border-left: 1px solid #e5e7eb; 
        padding-left: 1.5rem; 
    } 
}

.preview-content { 
    background-color: #f3f4f6; 
    padding: 1rem; 
    border-radius: 0.5rem; 
    white-space: pre-wrap; 
    word-wrap: break-word; 
    font-size: 0.875em; 
    line-height: 1.6; 
    color: #1f2937; 
    font-family: 'Inter', sans-serif; 
}
--- END FILE: ./src/styles/specific-composer.css ---

--- START FILE: ./src/styles/specific-realtime.css ---
/* Version 1.0 - Specific: Realtime (Refactored from v6.19) */
/* Chứa các style CHỈ dành riêng cho tab Realtime */

#video-container iframe {
    aspect-ratio: 16 / 9;
    width: 100%;
    height: auto;
    border-radius: 0.5rem;
}

.rt-customer-details table { 
    font-size: 0.8rem; 
}
--- END FILE: ./src/styles/specific-realtime.css ---

--- START FILE: ./src/styles/specific-sknv.css ---
/* Version 1.8 - No changes for this refactor
/* Version 1.7 - (YC 1) Change competition detail employee name color to dark green
/* Version 1.6 - Adjust detail view layout, colors, and KPI styling
/* Version 1.5 - Add standard 'line-clamp' property for compatibility
/* Version 1.4 - Implement "Multi-lane" layout & fix text wrap for competition detail
/* Version 1.3 - Add 3-column infographic styles and fix capture scroll
/* Version 1.2 - Fix drag-drop cursor for pasted competition toggles
/* Version 1.1 - Add sticky column styles for pasted competition table */
/* Chứa các style CHỈ dành riêng cho tab Sức Khỏe Nhân Viên (SKNV) */

#sknv-details-container .sknv-subtable-header th { 
    font-size: 0.875em; 
    font-weight: 600; 
    background-color: #f3f4f6; 
}

/* === START: SKNV INFOGRAPHIC CARD STYLES (V6.0) === */
.sknv-summary-grid {
    display: grid;
    grid-template-columns: 1fr; /* Default to 1 column for mobile */
    gap: 1.5rem;
}

@media (min-width: 768px) { /* 2 columns for tablets */
    .sknv-summary-grid {
        grid-template-columns: repeat(2, 1fr);
    }
}

@media (min-width: 1280px) { /* 4 columns for large desktops */
    .sknv-summary-grid {
        grid-template-columns: repeat(4, 1fr);
    }
}

.sknv-card {
    background-color: #ffffff;
    border: 1px solid #e5e7eb;
    border-radius: 0.75rem;
    padding: 1rem; /* UPDATED: Compact padding */
    box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05); /* UPDATED: Softer shadow */
    display: flex;
    flex-direction: column;
    gap: 0.75rem; /* UPDATED: Reduced gap */
    transition: transform 0.2s ease-out, box-shadow 0.2s ease-out;
    cursor: pointer;
    position: relative; /* Added for medal positioning */
}
.sknv-card:hover {
    transform: translateY(-4px);
    box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.08), 0 4px 6px -2px rgba(0, 0, 0, 0.04);
}

.sknv-card__header {
    display: flex;
    align-items: center;
    gap: 1rem;
}

.sknv-card__avatar {
    width: 48px;
    height: 48px;
    border-radius: 9999px;
    background-color: #eef2ff;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
    /* (v6.18) Thêm position relative để canh số Top 3 */
    position: relative;
}

.sknv-card__avatar svg {
    width: 24px;
    height: 24px;
    color: #4338ca;
}

.sknv-card__info {
    flex-grow: 1;
    min-width: 0;
}
.sknv-card__info .name {
    font-weight: 700;
    color: #111827;
    line-height: 1.25;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    display: flex;
    align-items: center;
}

.sknv-card__info .id {
    font-size: 0.875rem;
    color: #6b7280;
}

.sknv-card__main-kpi {
    text-align: center;
    margin: 0.25rem 0; /* UPDATED: Reduced margin */
}

.sknv-card__main-kpi .value {
    font-size: 2.5rem; /* UPDATED: Reduced font size */
    font-weight: 800;
    line-height: 1;
    color: #4b5563;
}

.sknv-card__main-kpi .total {
    font-size: 1.25rem; /* UPDATED */
    font-weight: 600;
    color: #9ca3af;
}

.sknv-card__main-kpi .label {
    display: block;
    font-size: 0.875rem;
    color: #6b7280;
    margin-top: 0.25rem;
    font-weight: 500;
}

.sknv-card-kpi-strong { border-top: 4px solid #16a34a; } /* UPDATED: Added top border */
.sknv-card-kpi-medium { border-top: 4px solid #f59e0b; } /* UPDATED: Added top border */
.sknv-card-kpi-weak { border-top: 4px solid #ef4444; } /* UPDATED: Added top border */
.sknv-card-kpi-strong .value { color: #16a34a; }
.sknv-card-kpi-medium .value { color: #f59e0b; }
.sknv-card-kpi-weak .value { color: #ef4444; }

.sknv-card__sub-kpi-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 0.5rem; /* UPDATED: Reduced gap */
    border-top: 1px solid #f3f4f6;
    padding-top: 0.75rem; /* UPDATED: Reduced padding */
}

.sknv-card__sub-kpi-item {
    background-color: #f9fafb;
    border-radius: 0.5rem;
    padding: 0.5rem; /* UPDATED: Reduced padding */
    text-align: center;
    transition: background-color 0.2s ease-in-out;
}

/* === START: NEW SUB-KPI LAYOUT === */
.sknv-card__sub-kpi-header {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.25rem;
}
.sknv-card__sub-kpi-header .feather {
    width: 1rem;
    height: 1rem;
    stroke-width: 2;
    color: #6b7280;
}
.sknv-card__sub-kpi-header .label {
    font-size: 0.7rem;
    font-weight: 600;
    color: #4b5563;
}
.sknv-card__sub-kpi-item .value {
    font-size: 0.875rem;
    font-weight: 700;
    margin-top: 2px;
    display: block; /* Ensures it's on a new line */
}
/* === END: NEW SUB-KPI LAYOUT === */

.sknv-card__sub-kpi-item.strong { border-bottom: 3px solid #22c55e; }
.sknv-card__sub-kpi-item.medium { border-bottom: 3px solid #f59e0b; }
.sknv-card__sub-kpi-item.weak { border-bottom: 3px solid #ef4444; }
/* === END: SKNV INFOGRAPHIC CARD STYLES === */

/* === START: SKNV Department Grouping Styles (V6.1) === */
.sknv-department-group {
    margin-bottom: 2.5rem; /* Space between department groups */
}

.sknv-department-group:last-child {
    margin-bottom: 1rem; /* Less space for the last group */
}

.sknv-department-header {
    font-size: 1.6rem;
    font-weight: 700;
    color: #1f2937; /* Dark gray for general headers */
    padding-bottom: 0.75rem;
    margin-bottom: 1.5rem;
    border-bottom: 3px solid #d1d5db; /* Light gray border */
    position: relative;
    padding-left: 0.5rem;
    /* (v6.18) Thêm flex để icon canh giữa */
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

/* (v6.18) Định dạng cho icon (nếu có) */
.sknv-department-header .header-icon {
    width: 1.4rem;
    height: 1.4rem;
}

.sknv-department-header--priority {
    color: #2563eb; /* Blue for priority department */
    border-bottom-color: #3b82f6; /* Matching blue border */
    background-color: #e0f2fe; /* Light blue background */
    padding: 0.75rem 1rem;
    border-radius: 0.5rem 0.5rem 0 0;
    margin-bottom: 0; /* Remove bottom margin to connect with cards */
    display: flex;
    align-items: center;
    gap: 0.75rem;
}

/* (v6.18) Bỏ icon FontAwesome cũ */
.sknv-department-header--priority::before {
    content: none;
}

/* Adjust grid gap and padding for priority department to integrate better */
.sknv-department-header--priority + .sknv-summary-grid {
    border-top-left-radius: 0;
    border-top-right-radius: 0;
    margin-top: 0; /* Remove top margin */
    padding-top: 1.5rem; /* Add padding inside grid */
    border: 1px solid #c7d2fe;
    background-color: #f3f4f6; /* Slightly different background */
    padding-left: 1rem;
    padding-right: 1rem;
    padding-bottom: 1rem;
    border-top: none;
}
/* === END: SKNV Department Grouping Styles === */

/* === START: SKNV DETAIL VIEW & MEDALS (V6.4) === */
/* NEW: Wrapper for compact detail view */
#sknv-detail-capture-area {
    max-width: 1100px;
    margin: 0 auto;
}
.sknv-detail-header-card {
    display: flex;
    align-items: center;
    gap: 1.5rem;
    padding: 1rem; /* UPDATED: Compact padding */
    background-color: #eff6ff; /* blue-50 */
    border: 1px solid #dbeafe; /* blue-200 */
    border-top: 4px solid #3b82f6; /* blue-500 */
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03);
}
.sknv-detail-avatar {
    width: 64px;
    height: 64px;
    border-radius: 9999px;
    background-color: #dbeafe; /* blue-200 */
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
}
.sknv-detail-avatar svg {
    width: 32px;
    height: 32px;
    color: #1e40af; /* blue-800 */
}
.sknv-detail-info .name {
    color: #1e40af; /* UPDATED: Dark blue color */
}
.sknv-detail-info .department,
.sknv-detail-info .kpi-summary {
    color: #1f2937; /* dark text */
}
.sknv-detail-info .kpi-summary .font-bold {
    color: #1d4ed8; /* darker blue */
}
.sknv-detail-info .name {
    font-size: 1.5rem;
    font-weight: 800;
    line-height: 1.2;
}
.sknv-detail-info .department {
    font-size: 1rem;
    font-weight: 500;
}
.sknv-detail-info .kpi-summary {
    margin-top: 0.5rem;
    font-weight: 600;
}

.sknv-detail-card-header {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    padding: 0.75rem 1rem; /* UPDATED: Compact padding */
    color: #ffffff;
}
.sknv-detail-card-header .header-icon {
    width: 20px;
    height: 20px;
}
.sknv-header-blue { background-color: #2563eb; }
.sknv-header-green { background-color: #16a34a; }
.sknv-header-orange { background-color: #f97316; }
.sknv-header-yellow { background-color: #ca8a04; }
.sknv-header-indigo { background-color: #4f46e5; }
.sknv-header-purple { background-color: #7e22ce; }

.sknv-detail-grid-body {
    padding: 0.75rem 1rem; /* UPDATED: Compact padding */
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); /* UPDATED */
    gap: 0.75rem; /* UPDATED */
}
.sknv-detail-metric-card {
    display: flex;
    flex-direction: column;
    align-items: center;
    text-align: center;
    padding: 0.5rem; /* UPDATED: Compact padding */
    background-color: #f9fafb;
    border-radius: 0.5rem;
    border: 1px solid #f3f4f6;
    transition: all 0.2s ease-in-out;
}
.sknv-detail-metric-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
}
.sknv-detail-metric-card .label {
    font-weight: 600;
    font-size: 0.8rem; /* UPDATED */
    color: #374151;
}
.sknv-detail-metric-card .value {
    font-weight: 700; /* UPDATED */
    font-size: 1.375rem; /* UPDATED: Reduced font size */
    line-height: 1.2;
    color: #111827;
    margin: 0.25rem 0;
}
.sknv-detail-metric-card .average {
    font-size: 0.7rem; /* UPDATED */
    color: #6b7280;
    font-style: italic;
}
.sknv-detail-metric-card .evaluation-badge {
    margin-top: 0.5rem;
    font-weight: 700;
    padding: 2px 8px;
    border-radius: 9999px;
    font-size: 0.7rem; /* UPDATED */
}
.evaluation-badge.text-green-600 { background-color: #dcfce7; }
.evaluation-badge.text-yellow-600 { background-color: #fef9c3; }

.medal-container {
    position: absolute; /* Changed for positioning */
    /* (v6.19) YC: Tăng size + điều chỉnh vị trí */
    top: -10px;
    left: 10px;
    width: 48px;
    height: 48px;
    flex-shrink: 0;
}
.medal-container svg {
    width: 100%;
    height: 100%;
    display: block;
    filter: drop-shadow(0 2px 2px rgba(0,0,0,0.3)); /* Add a nice shadow */
}

/* NEW: Compact tables in detail view */
#sknv-details-container .sknv-subtable-header {
    font-size: 0.8rem;
}
#sknv-details-container .table-bordered td,
#sknv-details-container .table-bordered th {
    padding: 0.5rem;
}
/* === END: SKNV DETAIL VIEW & MEDALS === */

/* === START: SKNV Rank Number Styles (v6.21 - Soft Blue 3D) === */

/* 1. Số thứ tự cho Top 3 (Đè lên huy chương) - Giữ nguyên */
.sknv-card__avatar-rank {
    font-size: 1.75rem; 
    font-weight: 700; 
    line-height: 1;
    display: flex;
    align-items: center;
    justify-content: center;
    width: 100%;
    height: 100%;
    position: absolute;
    top: 0;
    left: 0;
    z-index: 12; 
    color: #ffffff; 
    text-shadow: 0 1px 2px rgba(0,0,0,0.3);
}

/* 2. Ẩn nền avatar mặc định khi có huy chương - Giữ nguyên */
.sknv-card:has(.medal-container) .sknv-card__avatar {
    background-color: transparent;
}

/* 3. [DESIGN MỚI] Định dạng cho Vòng tròn hạng 4+ (Soft Blue) */
.sknv-card__avatar--standard {
    /* Nền Gradient: Từ xanh nhạt sang xanh đậm hơn xíu để tạo khối cầu */
    background: linear-gradient(145deg, #eff6ff, #dbeafe); 
    
    /* Viền: Màu xanh dương rõ nét */
    border: 2px solid #93c5fd; 
    
    /* Đổ bóng: 
       - Bóng dưới: Màu xanh đậm mờ để tạo độ nổi.
       - Bóng trên: Màu trắng để tạo độ bóng sáng (highlight).
    */
    box-shadow: 
        3px 3px 6px rgba(37, 99, 235, 0.15), 
        -3px -3px 6px rgba(255, 255, 255, 0.8);
    
    width: 44px; /* Fix size */
    height: 44px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    margin-top: 2px;
    margin-left: 2px;
}

/* 4. [DESIGN MỚI] Định dạng cho SỐ hạng 4+ */
.sknv-card__avatar--standard .sknv-card__avatar-rank {
    color: #1e40af; /* Màu chữ: Xanh dương đậm (Blue 800) thay vì màu đen/xám */
    position: static; 
    font-size: 1.25rem;
    font-weight: 800; 
    text-shadow: none; /* Bỏ bóng chữ của Top 3 */
    font-family: 'Inter', sans-serif;
}

/* 5. Bỏ SVG cũ */
.sknv-card__avatar-medal {
    display: none;
}
/* === END: SKNV Rank Number Styles === */

/* === START: Declaration Accordion Styles (v6.11) === */
.declaration-group {
    border-bottom: 1px solid #e5e7eb; /* gray-200 */
}
.declaration-group:last-child {
    border-bottom: none;
}
.declaration-group summary {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 1rem 0.5rem;
    cursor: pointer;
    font-size: 1.125rem; /* text-lg */
    font-weight: 700; /* font-bold */
    color: #374151; /* gray-700 */
    list-style: none; /* Hide default marker */
}
.declaration-group summary::-webkit-details-marker {
    display: none; /* Hide default marker for Chrome */
}
.declaration-group summary:hover {
    background-color: #f9fafb; /* gray-50 */
}
.declaration-group summary::after {
    content: '+';
    font-size: 1.5rem;
    font-weight: 500;
    color: #6b7280; /* gray-500 */
    transition: transform 0.2s ease-in-out;
}
.declaration-group[open] > summary::after {
    transform: rotate(45deg);
    content: '×';
}
.declaration-content {
    padding: 1rem 0.5rem 1.5rem 0.5rem;
}
/* === END: Declaration Accordion Styles === */

/* === START: Pasted Competition Column Toggles & Header Wrap (v6.15) === */

/* Container for the toggle buttons */
#pasted-competition-column-toggles {
    padding: 0.75rem;
    border-bottom: 1px solid #e5e7eb;
    display: flex;
    flex-wrap: wrap;
    align-items: center;
    gap: 0.5rem 0.25rem;
    background-color: #f9fafb; /* gray-50 */
}

/* Label for the toggles */
#pasted-competition-column-toggles .non-draggable {
    font-size: 0.875rem; /* text-sm */
    font-weight: 600; /* font-semibold */
    margin-right: 0.5rem; /* mr-2 */
    color: #374151; /* gray-700 */
}

/* Styles for the table headers to allow wrapping */
#pasted-competition-report-container table th {
    white-space: normal; /* Allow text wrapping */
    vertical-align: middle;
    line-height: 1.3;
    max-width: 150px; /* Set a max-width */
    width: 120px; /* Set a base width */
}

/* Keep employee name header slightly wider and no-wrap */
#pasted-competition-report-container table th[data-sort="hoTen"] {
    white-space: nowrap;
    width: 150px;
    min-width: 150px;
}
/* === END: Pasted Competition Styles === */

/* === START: LOGIN MODAL STYLES (V6.7) === */
#login-modal .modal__overlay {
    cursor: not-allowed;
}

#login-modal .modal__container {
    box-shadow: 0 25px 50px -12px rgb(0 0 0 / 0.25);
}

#login-modal input[type="email"]:focus {
    border-color: #3b82f6;
    box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.4);
    outline: none;
}
/* === END: LOGIN MODAL STYLES === */

/* === START: Sticky Columns for Pasted Competition Table (v1.1) === */

/* 1. Container: Phải bật 'overflow-x-auto' (đã có) và 'position: relative' (quan trọng) */
.sknv-pasted-competition-scroller {
    position: relative; /* Bắt buộc để z-index của sticky hoạt động */
}

/* 2. Các ô tiêu đề (th) cần "đóng băng" */
#pasted-competition-report-container table th.sticky-col {
    position: -webkit-sticky; /* cho Safari */
    position: sticky;
    z-index: 2; /* Phải cao hơn z-index của các ô (td) */
    background-color: #e5e7eb; /* gray-200 (màu nền thead) - Rất quan trọng */
}

/* 3. Các ô dữ liệu (td) cần "đóng băng" */
#pasted-competition-report-container table td.sticky-col {
    position: -webkit-sticky; /* cho Safari */
    position: sticky;
    z-index: 1; /* Phải cao hơn các ô td khác, nhưng thấp hơn th */
    background-color: #ffffff; /* Màu nền của dòng (trắng) */
}

/* 4. Đảm bảo dòng chẵn/lẻ cũng được ghi đè màu nền */
#pasted-competition-report-container table tr:nth-child(even) td.sticky-col {
    background-color: #f9fafb; /* gray-50 (màu dòng chẵn) */
}

/* 5. Định vị cho từng cột */
.sticky-col.sticky-col-1 {
    left: 0; /* Cột đầu tiên */
}

.sticky-col.sticky-col-2 {
    left: 150px; /* Cột thứ 2 - Phải bằng độ rộng của cột 1 (min-width: 150px từ CSS cũ) */
}

/* 6. (An toàn) Đảm bảo footer cũng được "đóng băng" */
#pasted-competition-report-container table tfoot td.sticky-col {
    background-color: hsl(210, 20%, var(--header-lightness)); /* Màu footer */
    z-index: 3; /* Nằm trên cả tiêu đề và nội dung */
}
/* === END: Sticky Columns (v1.1) === */

/* === START: YÊU CẦU 2 (v1.2) - Sửa lỗi con trỏ kéo thả === */
.column-toggle-btn {
    /* Mặc định là pointer để người dùng biết có thể click bật/tắt */
    cursor: pointer;
}

.column-toggle-btn .drag-handle-icon {
    /* Chỉ riêng icon kéo mới có cursor grab */
    cursor: grab;
}

.column-toggle-btn .drag-handle-icon:active {
    /* Khi đang kéo icon */
    cursor: grabbing;
}
/* === END: YÊU CẦU 2 (v1.2) === */

/* === START: UPDATED STYLES (v1.4) - "Multi-lane" Layout & Text Wrap === */

/* Container cho mỗi "làn đường" (Đạt, Gần Đạt, Cần Cố Gắng) */
.sknv-thidua-lane {
    display: flex;
    flex-direction: column;
}

/* Container chứa các thẻ card, cho phép xếp hàng ngang và xuống dòng */
.sknv-thidua-horizontal-content {
    padding: 0.75rem; /* p-3 */
    display: flex;
    flex-direction: row; /* Xếp hàng ngang */
    flex-wrap: wrap;     /* Tự động xuống dòng */
    gap: 0.75rem;        /* Khoảng cách giữa các thẻ */
}

/* Thông báo khi làn đường trống */
.sknv-thidua-horizontal-content .empty-col-msg {
    font-size: 0.875rem; /* text-sm */
    color: #6b7280; /* gray-500 */
    text-align: center;
    padding: 1rem 0;
    font-style: italic;
    width: 100%; /* Chiếm toàn bộ chiều rộng của làn đường */
}

/* Thẻ chi tiết từng ngành hàng (Yêu cầu 3 - Layout) */
.sknv-thidua-item-card {
    background-color: #ffffff; /* bg-white */
    border-radius: 0.5rem; /* rounded-lg */
    border: 1px solid #e5e7eb; /* border */
    padding: 0.75rem; /* p-3 */
    box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05); /* shadow-sm */
    transition: all 0.2s ease-in-out;
    
    /* Logic xếp hàng ngang: */
    /* === START: YÊU CẦU 3 (v1.6) === */
    flex: 1 1 180px; /* Thẻ có thể co giãn, cơ sở là 180px (thay vì 220px) */
    min-width: 180px; /* Chiều rộng tối thiểu 180px (thay vì 220px) */
    /* === END: YÊU CẦU 3 (v1.6) === */
} 
.sknv-thidua-item-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1); /* shadow-md */
}

/* Tiêu đề ngành hàng (Yêu cầu 1 - Text Wrap) */
.item-card-title {
    font-weight: 600; /* font-semibold */
    color: #1f2937; /* gray-800 */
    margin-bottom: 0.5rem; /* mb-2 */
    
    /* Bắt đầu sửa lỗi wrap text */
    white-space: normal; /* Cho phép xuống dòng */
    display: -webkit-box;
    -webkit-line-clamp: 2; /* Giới hạn 2 dòng */
    line-clamp: 2; /* === THÊM MỚI (v1.5) - Sửa lỗi tương thích === */
    -webkit-box-orient: vertical;
    overflow: hidden;
    text-overflow: ellipsis;
    min-height: 2.5em; /* Đảm bảo đủ chiều cao cho 2 dòng (line-height 1.25) */
    line-height: 1.25;
    /* Kết thúc sửa lỗi wrap text */
}

/* Các style còn lại của thẻ được giữ nguyên */
.item-card-progress-bar-container {
    width: 100%;
    background-color: #e5e7eb; /* gray-200 */
    border-radius: 9999px; /* rounded-full */
    height: 0.75rem; /* h-3 */
    overflow: hidden;
    margin-bottom: 0.5rem; /* mb-2 */
}
.item-card-progress-bar {
    height: 100%;
    border-radius: 9999px;
    transition: width 0.5s ease-in-out;
}
.item-card-metrics {
    font-size: 0.75rem; /* text-xs */
    color: #4b5563; /* gray-600 */
    display: flex;
    justify-content: space-between;
    flex-wrap: wrap;
    gap: 0.25rem 0.5rem; /* gap-x-2 gap-y-1 */
}
.item-card-metrics strong {
    font-weight: 600;
    color: #111827; /* gray-900 */
}
.item-card-metrics .text-green-600 { color: #16a34a; }
.item-card-metrics .text-red-600 { color: #dc2626; }

/* === END: UPDATED STYLES (v1.4) === */


/* === START: SỬA LỖI (v1.3) - Căn chỉnh icon cho thẻ KPI === */
.rt-infographic-summary-card .label {
    font-size: 0.875em;
    color: #4b5563;
    font-weight: 500;
    /* Thêm các thuộc tính flex để căn chỉnh icon */
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.25rem; /* 4px */
}
.rt-infographic-summary-card .label .feather {
    width: 1em;
    height: 1em;
}
/* === END: SỬA LỖI (v1.3) === */

/* === START: YÊU CẦU 5 (v1.6) - Làm dịu màu header === */
.sknv-thidua-column-header {
    display: flex;
    align-items: center;
    gap: 0.5rem; /* gap-2 */
    padding: 0.75rem 1rem; /* p-3 */
    border-bottom: 1px solid; /* Cập nhật border color bên dưới */
} 
.sknv-thidua-column-header .feather {
    width: 1.25rem; /* h-5 w-5 */
    height: 1.25rem;
    stroke-width: 2.5;
}
.sknv-thidua-column-header h4 {
    font-size: 1.125rem; /* text-lg */
    font-weight: 700; /* font-bold */
}
.sknv-thidua-column-header.header-blue {
    background-color: #dbeafe; /* blue-100 */
    color: #1e40af; /* blue-800 */
    border-color: #bfdbfe; /* blue-200 */
} 
.sknv-thidua-column-header.header-yellow {
    background-color: #fef9c3; /* yellow-100 */
    color: #854d0e; /* yellow-800 */
    border-color: #fde68a; /* yellow-200 */
} 
.sknv-thidua-column-header.header-red {
    background-color: #fee2e2; /* red-100 */
    color: #991b1b; /* red-800 */
    border-color: #fecaca; /* red-200 */
} 
/* === END: YÊU CẦU 5 (v1.6) === */


/* === START: (v1.6) Yêu cầu tùy chỉnh cho chi tiết thi đua (Yêu cầu 1 & 4) === */

/* Yêu cầu 1: Ghi đè header nhân viên (loại bỏ màu tím) */
#sknv-thidua-detail-capture-area .sknv-detail-header-card {
    background-color: #ffffff !important;
    border-color: #e5e7eb !important;
    border-top-width: 4px !important;
    border-top-color: #6b7280 !important; /* gray-500 */
} 
/* === START: THAY ĐỔI (v1.7) === */
#sknv-thidua-detail-capture-area .sknv-detail-header-card .name {
    color: #166534 !important; /* YC 1 (v1.7): Đổi sang xanh lá cây đậm (green-800) */
} 
/* === END: THAY ĐỔI (v1.7) === */
#sknv-thidua-detail-capture-area .sknv-detail-header-card .department {
    color: #374151 !important; /* gray-700 */
} 
#sknv-thidua-detail-capture-area .sknv-detail-header-card .sknv-card__avatar {
    background-color: #e5e7eb !important; /* gray-200 */
} 
#sknv-thidua-detail-capture-area .sknv-detail-header-card .sknv-card__avatar svg {
    color: #374151 !important; /* gray-700 */
} 

/* Yêu cầu 4: Thêm màu cho các thẻ KPI */
.rt-infographic-summary-card .value.is-dat {
    color: #16a34a !important; /* green-600 */
} 
.rt-infographic-summary-card .value.is-positive {
    color: #2563eb !important; /* blue-600 */
} 
.rt-infographic-summary-card .value.is-gan-dat {
    color: #f59e0b !important; /* amber-500 */
} 
.rt-infographic-summary-card .value.is-can-co-gang,
.rt-infographic-summary-card .value.is-negative {
    color: #dc2626 !important; /* red-600 */
} 
/* === START: SKNV Rank Number Styles (Design Soft Blue) === */

/* Top 3 Rank Style */
.sknv-card__avatar-rank {
    /* Style mặc định cho số của Top 3 (được override bởi inline class trong MedalIcon cho màu trắng) */
    text-shadow: 0 1px 2px rgba(0,0,0,0.3);
}

/* Rank 4+ Circle Style */
.sknv-card__avatar--standard {
    /* Nền Gradient Xanh dương phấn */
    background: linear-gradient(145deg, #eff6ff, #dbeafe) !important;
    
    /* Viền Xanh dương sáng */
    border: 2px solid #93c5fd !important;
    
    /* Đổ bóng nổi khối 3D */
    box-shadow: 
        3px 3px 6px rgba(37, 99, 235, 0.15), 
        -3px -3px 6px rgba(255, 255, 255, 0.8) !important;
    
    /* Kích thước */
    width: 44px;
    height: 44px;
    border-radius: 50%;
    
    /* Căn giữa số */
    display: flex;
    align-items: center;
    justify-content: center;
    
    /* Căn vị trí so với Card */
    margin-top: 2px;
    margin-left: 2px;
}

/* Rank 4+ Text Style */
.sknv-card__avatar--standard .sknv-card__avatar-rank {
    color: #1e40af !important; /* Xanh dương đậm */
    font-size: 1.25rem;
    font-weight: 800;
    text-shadow: none; /* Bỏ bóng của Top 3 */
    font-family: 'Inter', sans-serif;
}
/* === END: SKNV Rank Number Styles === */

--- END FILE: ./src/styles/specific-sknv.css ---

--- START FILE: ./src/styles/specific-tdv.css ---
/* Version 1.0 - Specific: TDV (Refactored from v6.19) */
/* Chứa các style CHỈ dành riêng cho tab Thi Đua Vùng (TDV) */

/* === BẮT ĐẦU: BỐ CỤC CHO THI ĐUA VÙNG & THI ĐUA LŨY KẾ (V5.9) === */
.tdv-rows-container { 
    display: flex; 
    flex-direction: column; 
    gap: 1.5rem; 
}
#subtab-luyke-thi-dua .tdv-row-body {
    display: grid;
    grid-template-columns: 1fr; /* Mặc định 1 cột cho mobile */
    gap: 1rem;
}
@media (min-width: 768px) { /* 2 cột cho tablet trở lên */
    #subtab-luyke-thi-dua .tdv-row-body {
        grid-template-columns: repeat(2, 1fr);
    }
}
/* === END: BỐ CỤC MỚI === */

.tdv-infographic-card {
    background-color: transparent;
    border: none;
    box-shadow: none;
    padding: 0;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
}
.tdv-header { 
    text-align: center; 
    margin-bottom: 2rem; 
}
.tdv-supermarket-name { 
    font-size: 2em; 
    font-weight: bold; 
    color: #005f73; 
}
.tdv-total-prize-container { 
    margin-top: 0.5rem; 
    font-size: 1.5em; 
    font-weight: bold; 
}
.tdv-total-prize-label { 
    color: #6b7280; 
    font-weight: normal; 
}
.tdv-total-prize-value { 
    color: #d90429; 
    margin-left: 0.5rem; 
}

.tdv-summary-grid { 
    display: grid; 
    grid-template-columns: repeat(2, 1fr); 
    gap: 1rem; 
    margin-top: 1.5rem; 
    margin-bottom: 2rem; 
}
@media (min-width: 768px) { 
    .tdv-summary-grid { 
        grid-template-columns: repeat(5, 1fr); 
    } 
}
.tdv-summary-item { 
    background-color: #ffffff; 
    border-radius: 8px;
    padding: 1rem; 
    text-align: center; 
    box-shadow: 0 2px 4px rgba(0,0,0,0.05); 
    border: 1px solid #e5e7eb;
}
/* === START: Sửa màu và font-weight cho .tdv-summary-value === */
.tdv-summary-value {
    display: block;
    font-size: 1.75em;
    font-weight: 800; /* Tăng độ đậm */
    color: #005f73; /* Đổi màu xanh đậm hơn */
}
/* === END: Sửa màu === */
.tdv-summary-label { 
    display: block; 
    font-size: 0.9em; 
    color: #4a5568; 
    margin-top: 0.25rem; 
}
/* === START: Thêm class màu cho tỷ lệ đạt === */
.tdv-tyledat-high { 
    color: #2563eb !important; /* blue-600 */
} 
.tdv-tyledat-low { 
    color: #dc2626 !important; /* red-600 */
} 
/* === END: Thêm class màu === */

.tdv-row { 
    background-color: #fdfdfd; 
    border-radius: 8px; 
    padding: 1rem; 
    border: 1px solid #dee2e6; 
}
.tdv-row-title { 
    font-size: 1.2em; 
    font-weight: bold;
    padding-bottom: 0.75rem; 
    margin-bottom: 1rem; 
    border-bottom: 2px solid; 
    line-height: 1.3; 
}
.tdv-row-title--prize { 
    border-color: #0d6efd; 
    color: #0d6efd; 
}
.tdv-row-title--soon-prize { 
    border-color: #e9c46a; 
    color: #e9c46a; 
}
.tdv-row-title--effort { 
    border-color: #6c757d; 
    color: #6c757d; 
}
.tdv-row-subtitle { 
    font-size: 0.8em; 
    font-weight: normal; 
    color: #d90429; 
}

/* === START: Sửa layout 4 cột cho Thi đua vùng (SỬA LẠI SELECTOR) === */
/* *** FIX: Corrected CSS selector to use #subtab-luyke-thidua-vung *** */
#subtab-luyke-thidua-vung .tdv-row-body {
    display: grid;
    grid-template-columns: repeat(1, 1fr); /* 1 cột cho mobile */
    gap: 1rem;
}
@media (min-width: 768px) { /* 2 cột cho tablet */
    #subtab-luyke-thidua-vung .tdv-row-body {
        grid-template-columns: repeat(2, 1fr);
    }
}
@media (min-width: 1280px) { /* 4 cột cho desktop lớn */
    #subtab-luyke-thidua-vung .tdv-row-body {
        grid-template-columns: repeat(4, 1fr);
    }
}
/* === END: Sửa layout === */
.tdv-row-body--effort { 
    display: block; 
}

.tdv-item-card { 
    background: #fff; 
    border: 1px solid #e0e0e0; 
    border-radius: 6px;
    padding: 12px; 
    box-shadow: 0 1px 3px rgba(0,0,0,0.05); 
    overflow: hidden; 
}
.tdv-item-card__title { 
    font-weight: bold;
    margin: 0 0 10px 0; 
    color: #333; 
}
.tdv-progress-bar-container {
    width: 100%;
    background-color: #e9ecef;
    border-radius: 20px;
    height: 28px;
    position: relative;
    font-size: 0.85em;
    font-weight: bold;
    overflow: hidden;
    display: flex;
    align-items: center;
    justify-content: center;
}
.tdv-progress-bar { 
    height: 100%; 
    transition: width 0.5s ease; 
    position: absolute; 
    top: 0; 
    left: 0; 
}
.tdv-progress-bar--blue { 
    background-color: #0d6efd; 
}
.tdv-progress-bar--yellow { 
    background-color: #e9c46a; 
}
.tdv-progress-bar__text {
    position: relative;
    z-index: 1;
    text-shadow: 1px 1px 2px rgba(0,0,0,0.4);
    color: white;
}
.tdv-item-card__details { 
    font-size: 0.85em; 
    color: #555; 
    margin-top: 8px; 
    display: grid; 
    grid-template-columns: repeat(3, 1fr); 
    gap: 5px; 
}
.tdv-item-card__details span { 
    display: block; 
}
.tdv-item-card__details strong { 
    color: #000; 
}
.tdv-item-card__prize { 
    grid-column: 1 / -1; 
    font-weight: bold !important; 
    color: #d90429; 
    margin-top: 4px; 
}

.tdv-effort-subgroup { 
    margin-bottom: 1rem; 
}
.tdv-effort-subgroup:last-child { 
    margin-bottom: 0; 
}
.tdv-effort-subgroup__title { 
    font-weight: bold; 
    margin: 0 0 10px 0; 
    padding-bottom: 5px; 
    border-bottom: 1px solid #dee2e6; 
}
.tdv-effort-subgroup__title--potential { 
    color: #fd7e14; 
}
.tdv-effort-subgroup__title--major { 
    color: #6c757d; 
}
.tdv-effort-list { 
    display: flex; 
    flex-wrap: wrap; 
    gap: 8px; 
}
.tdv-effort-item { 
    background-color: #f1f3f5; 
    color: #495057; 
    padding: 5px 10px; 
    border-radius: 15px; 
    font-size: 0.9em; 
}
--- END FILE: ./src/styles/specific-tdv.css ---

--- START FILE: ./src/styles/tables.css ---
/* Version 1.0 - Tables styles (Refactored from v6.19) */
/* Chứa các class chung cho bảng biểu: borders, striping, header colors, sort indicators */

.table-bordered { 
    border-collapse: collapse; 
}
.table-bordered th, .table-bordered td { 
    border: 1px solid #e5e7eb; 
}
.table-striped tbody tr:nth-child(even) { 
    background-color: #f9fafb; 
}
.table-footer { 
    background-color: hsl(210, 20%, var(--header-lightness));
    border-top: 2px solid #9ca3af; 
}
.cell-performance.is-below { 
    background-color: hsl(0, 80%, var(--below-target-lightness)) !important; 
}

/* === Sort Indicators === */
.sortable { 
    cursor: pointer; 
    position: relative; 
    user-select: none; 
}
.sort-indicator { 
    display: inline-flex; 
    flex-direction: column; 
    align-items: center; 
    justify-content: center; 
    width: 1em; 
    height: 1em; 
    margin-left: 4px; 
    vertical-align: middle; 
    color: #9ca3af; 
    transition: color 0.2s ease-in-out; 
}
.sortable .sort-indicator::before { 
    content: '▲'; 
    font-size: 0.8em; 
    line-height: 0.5; 
    opacity: 0.4; 
}
.sortable .sort-indicator::after { 
    content: '▼'; 
    font-size: 0.8em; 
    line-height: 0.5; 
    opacity: 0.4; 
}
.sortable:hover .sort-indicator { 
    color: #374151; 
}
.sortable.sorted-asc .sort-indicator::before { 
    opacity: 1; 
    color: #3b82f6; 
}
.sortable.sorted-asc .sort-indicator::after { 
    opacity: 0.4; 
}
.sortable.sorted-desc .sort-indicator::after { 
    opacity: 1; 
    color: #3b82f6; 
}
.sortable.sorted-desc .sort-indicator::before { 
    opacity: 0.4;
}

/* === Draggable Headers === */
.draggable-header {
    cursor: move;
    cursor: grab;
}
.draggable-header:active {
    cursor: grabbing;
}
.sortable-ghost {
    opacity: 0.4;
    background-color: #c7d2fe; /* indigo-200 */
}
.sortable-drag {
    opacity: 0.95;
    transform: rotate(-2deg);
    box-shadow: 0 8px 16px rgba(0,0,0,0.2);
}


/* === Table Header Colors === */
.header-bg-blue { background-color: hsl(217, 95%, var(--special-header-lightness)) !important; color: hsl(217, 80%, var(--header-text-lightness)) !important; }
.header-bg-green { background-color: hsl(145, 80%, var(--special-header-lightness)) !important; color: hsl(145, 70%, var(--header-text-lightness)) !important; }
.header-bg-yellow { background-color: hsl(45, 95%, var(--special-header-lightness)) !important; color: hsl(45, 80%, var(--header-text-lightness)) !important; }

.header-group-1 { background-color: hsl(30, 90%, var(--header-lightness)); }
.header-group-2 { background-color: hsl(90, 90%, var(--header-lightness)); }
.header-group-3 { background-color: hsl(180, 90%, var(--header-lightness)); }
.header-group-4 { background-color: hsl(240, 90%, var(--header-lightness)); }
.header-group-5 { background-color: hsl(300, 90%, var(--header-lightness)); }
.header-group-6 { background-color: hsl(0, 90%, var(--header-lightness)); }
.header-group-7 { background-color: hsl(160, 80%, var(--header-lightness)) !important; }
.header-group-8 { background-color: hsl(280, 80%, var(--header-lightness)) !important; }
.header-group-9 { background-color: hsl(70, 80%, var(--header-lightness)) !important; }
.header-group-10 { background-color: hsl(190, 80%, var(--header-lightness)) !important; }
.header-group-11 { background-color: hsl(340, 80%, var(--header-lightness)) !important; }
.header-group-12 { background-color: hsl(20, 80%, var(--header-lightness)) !important; }

.department-header-tv { background-color: #e0e7ff; color: #3730a3; }
.department-header-kho { background-color: #d1fae5; color: #065f46; }
.department-header-tt { background-color: #fef3c7; color: #92400e; }
.category-header-ict { background-color: #dbeafe; color: #1e40af; }
.category-header-phukien { background-color: #fee2e2; color: #991b1b; }
.category-header-giadung { background-color: #fef9c3; color: #854d0e; }
.category-header-ce { background-color: #e0f2fe; color: #0c4a6e; }
.category-header-baohiem { background-color: #f3e8ff; color: #6b21a8; }
.header-bg-indigo { background-color: #e0e7ff; color: #3730a3; }
.header-bg-purple { background-color: #f3e8ff; color: #6b21a8; }

.qdc-group-title { font-weight: 600; }
.qdc-group-ict { background-color: hsl(190, 80%, var(--special-header-lightness)); }
.qdc-group-vas { background-color: hsl(140, 80%, var(--special-header-lightness)); }
.qdc-group-giadung { background-color: hsl(0, 80%, var(--special-header-lightness)); }
.qdc-group-sim { background-color: hsl(40, 80%, var(--special-header-lightness)); }

.competition-header-doanhthu { border-color: #a78bfa; background-color: hsl(260, 90%, var(--bg-lightness)); }
.competition-header-soluong { border-color: #facc15; background-color: hsl(50, 90%, var(--bg-lightness)); }
.header-highlight-special { background-color: hsl(25, 90%, var(--header-lightness)) !important; }
.competition-row-below-100 td { background-color: #fee2e2; color: #991b1b; }

.header-highlight { background-color: hsl(50, 95%, var(--special-header-lightness)) !important; }
--- END FILE: ./src/styles/tables.css ---

--- START FILE: ./src/styles/vendor.css ---
/* Version 1.0 - Vendor overrides (Refactored from v6.19) */
/* Chứa các style ghi đè lên thư viện bên thứ ba, ví dụ: Choices.js */

#dtnv-realtime-employee-selector-container .choices__inner { 
    min-width: 300px; 
}
#dtnv-realtime-employee-selector-container .choices__list--single { 
    min-width: 300px; 
}

.choices__inner { 
    min-height: 42px; 
}
.choices__list--multiple .choices__item { 
    background-color: #3b82f6; 
    border-color: #2563eb; 
}

#goal-drawer .choices__inner {
    min-width: 250px;
}

#goal-drawer .choices__list--dropdown,
#goal-drawer .choices__list[aria-expanded] {
    min-width: 100%;
    width: auto;
    word-break: normal;
}

#goal-drawer .choices__list--multiple .choices__item {
    display: inline-flex;
    align-items: center;
    background-color: #3b82f6;
    border: 1px solid #2563eb;
    color: white;
    border-radius: 9999px;
    padding: 2px 8px;
    font-size: 0.8em;
    font-weight: 500;
    margin: 2px 4px 2px 0;
}
#goal-drawer .choices__inner {
    height: auto !important;
    min-height: 42px !important;
    display: flex !important;
    flex-wrap: wrap !important;
}
--- END FILE: ./src/styles/vendor.css ---

--- START FILE: ./src/utils.js ---
// src/utils.js
// Version 2.5 - Added parseIdentity to fix configLoader error
import { get } from 'svelte/store';
import { categoryNameMapping, groupNameMapping, brandNameMapping } from './stores.js';

export function getRandomBrightColor() {
    const colors = [
        '#ef4444', '#f97316', '#eab308', '#84cc16', '#22c55e', '#10b981',
        '#14b8a6', '#06b6d4', '#3b82f6', '#8b5cf6', '#d946ef', '#ec4899',
    ];
    return colors[Math.floor(Math.random() * colors.length)];
}

/**
 * Hàm làm sạch cơ bản (Aggressive Mode).
 * Dùng để gợi ý tên hiển thị sạch sẽ.
 */
export function cleanNameRaw(name) {
    if (!name || typeof name !== 'string') return '';
    
    let cleaned = name;

    // 1. Loại bỏ cụm "Mã - " ở đầu (VD: "13 - ")
    cleaned = cleaned.replace(/^\d+\s*[-–]\s*/, ''); 

    // 2. Loại bỏ toàn bộ các ký tự số còn lại (nếu muốn tên chỉ có chữ)
    cleaned = cleaned.replace(/[0-9]/g, '');
    
    // 3. Loại bỏ ký tự đặc biệt, chỉ giữ lại chữ cái (Unicode) và khoảng trắng
    cleaned = cleaned.replace(/[^\p{L}\s]/gu, ' ');

    return cleaned
        .trim()
        .replace(/\s+/g, ' ') // Gộp khoảng trắng thừa
        .toLowerCase()
        .split(' ')
        .map(word => word.charAt(0).toUpperCase() + word.slice(1)) // Viết hoa chữ cái đầu
        .join(' ');
}

export function cleanCategoryName(name) {
    if (!name) return '';
    const rawName = String(name).trim();
    const mappings = get(categoryNameMapping);
    if (mappings && mappings[rawName]) {
        return mappings[rawName];
    }
    return cleanNameRaw(rawName);
}

export function cleanGroupName(name) {
    if (!name) return '';
    const rawName = String(name).trim();
    const mappings = get(groupNameMapping);
    if (mappings && mappings[rawName]) {
        return mappings[rawName];
    }
    return cleanNameRaw(rawName);
}

export function cleanBrandName(name) {
    if (!name) return '';
    const rawName = String(name).trim();
    const mappings = get(brandNameMapping);
    if (mappings && mappings[rawName]) {
        return mappings[rawName];
    }
    return cleanNameRaw(rawName);
}

export function getSortedDepartmentList(reportData) {
    const allDepts = [...new Set(reportData.map(item => item.boPhan).filter(Boolean))];
    allDepts.sort((a, b) => {
        const aIsPriority = a.includes('Tư Vấn - ĐM');
        const bIsPriority = b.includes('Tư Vấn - ĐM');
        if (aIsPriority && !bIsPriority) return -1;
        if (!aIsPriority && bIsPriority) return 1;
        return a.localeCompare(b);
    });
    return allDepts;
}

/**
 * [MỚI] Phân tích chuỗi định danh dạng "ID - Name" hoặc "ID-Name"
 * Trả về object { id, name }. Nếu không tìm thấy ID, id sẽ là 'unknown'
 */
export function parseIdentity(value) {
    if (!value || typeof value !== 'string') {
        return { id: 'unknown', name: '' };
    }
    
    // Regex bắt chuỗi dạng: "Số - Chữ" (VD: "1491 - Smartphone")
    // Hỗ trợ dấu gạch ngang (-) và gạch dài (–)
    const match = value.match(/^(\d+)\s*[-–]\s*(.+)$/);
    
    if (match) {
        return { 
            id: match[1].trim(), 
            name: match[2].trim() 
        };
    }
    
    // Trường hợp không có ID ở đầu
    return { id: 'unknown', name: value.trim() };
}
--- END FILE: ./src/utils.js ---

--- START FILE: ./src/utils/capture.utils.js ---
// Version 2.0 - Restore Logic from Legacy Project (Fix Blank Image)
import { get } from 'svelte/store';
import { charts } from '../stores.js'; // Store chứa instance biểu đồ

/**
 * Chèn CSS styles động để định dạng ảnh chụp (Giống hệt file gốc)
 */
export const injectCaptureStyles = () => {
    const styleId = 'dynamic-capture-styles';
    document.getElementById(styleId)?.remove();

    const styles = `
        .capture-container { 
            padding: 24px; 
            background-color: #f3f4f6; 
            box-sizing: border-box; 
            width: fit-content; 
            position: absolute;
            /* QUAN TRỌNG: Dùng left -9999px thay vì opacity/display none để đảm bảo render */
            left: -9999px;
            top: 0;
            z-index: -1;
        }
        .capture-layout-container { 
            display: flex; 
            flex-direction: column; 
            gap: 24px; 
        }
        .capture-title { 
            font-size: 28px; 
            font-weight: 700; 
            text-align: center; 
            color: #1f2937; 
            margin-bottom: 24px; 
            padding: 12px; 
            background-color: #ffffff; 
            border-radius: 0.75rem; 
            box-shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1), 0 1px 2px -1px rgb(0 0 0 / 0.1); 
        }
        /* --- VIRTUAL STAGES / PRESETS --- */
        .prepare-for-kpi-capture {
            display: grid !important;
            grid-template-columns: repeat(2, 1fr) !important;
            gap: 24px !important;
            width: 900px !important;
        }
        .preset-mobile-portrait {
            width: 550px !important; 
        }
        .preset-landscape-table {
            width: fit-content !important;
        }
        .preset-landscape-table table {
            table-layout: fixed !important;
        }
        .preset-landscape-table th, 
        .preset-landscape-table td {
            width: 95px !important;
            word-wrap: break-word;
        }
        .preset-landscape-table th:first-child,
        .preset-landscape-table td:first-child {
            width: 180px !important;
        }
        .preset-large-font-report {
            width: 800px !important;
        }
        .preset-large-font-report table th {
            white-space: normal !important;
            vertical-align: middle;
        }
        .preset-large-font-report table td {
            font-size: 22px !important;
            vertical-align: middle;
        }
        .preset-infographic-wide {
            width: 1100px !important;
        }
    `;

    const styleElement = document.createElement('style');
    styleElement.id = styleId;
    styleElement.innerHTML = styles;
    document.head.appendChild(styleElement);
    return styleElement;
};

/**
 * Tìm và thay thế tất cả <canvas> của Chart.js bằng <img> tĩnh.
 * Logic này khắc phục lỗi ảnh trắng ở biểu đồ.
 * @param {HTMLElement} element - Vùng DOM (clone) sắp được chụp.
 */
export const swapCanvasToImage = (element) => {
    console.log("[CaptureUtils] Bắt đầu chuyển đổi Canvas sang Ảnh...");
    const canvasElements = element.querySelectorAll('canvas');
    let replacedCount = 0;
    
    // Lấy danh sách chart instance từ store Svelte
    const $charts = get(charts);

    canvasElements.forEach(canvas => {
        const chartId = canvas.id;
        
        // Cách 1: Thử lấy từ Store (nếu Chart Component đã đăng ký)
        if (chartId && $charts[chartId]) {
            try {
                const chart = $charts[chartId];
                const base64Image = chart.toBase64Image(); // Lấy ảnh tĩnh từ Chart.js
                
                if (base64Image) {
                    replaceCanvasWithImg(canvas, base64Image);
                    replacedCount++;
                    return;
                }
            } catch (e) {
                console.error(`[CaptureUtils] Lỗi khi lấy ảnh từ chart '${chartId}':`, e);
            }
        }

        // Cách 2: Fallback - Thử lấy trực tiếp từ canvas element (nếu không có trong store)
        // Cách này hoạt động nếu canvas gốc đã được render xong
        try {
            // Tìm canvas gốc trong DOM thật (không phải bản clone)
            const originalCanvas = document.getElementById(chartId);
            if (originalCanvas) {
                const base64Image = originalCanvas.toDataURL('image/png');
                if (base64Image && base64Image !== 'data:,') {
                    replaceCanvasWithImg(canvas, base64Image);
                    replacedCount++;
                }
            }
        } catch (e) {
            console.warn(`[CaptureUtils] Không thể fallback toDataURL cho ${chartId}`);
        }
    });
    console.log(`[CaptureUtils] Đã hoán đổi thành công ${replacedCount} biểu đồ.`);
};

// Helper thay thế node
function replaceCanvasWithImg(canvasNode, src) {
    const img = document.createElement('img');
    img.src = src;
    // Giữ nguyên kích thước để tránh vỡ layout
    img.style.width = canvasNode.style.width || `${canvasNode.width}px`;
    img.style.height = canvasNode.style.height || `${canvasNode.height}px`;
    img.style.display = 'block';
    
    // Copy các class cũ sang
    img.className = canvasNode.className;
    
    // Thay thế canvas bằng img
    if (canvasNode.parentNode) {
        canvasNode.parentNode.replaceChild(img, canvasNode);
    }
}
--- END FILE: ./src/utils/capture.utils.js ---

--- START FILE: ./src/utils/formatters.js ---
// src/utils/formatters.js
// Version 4.0 - Format 0 as "-"
export const formatters = {
    /**
     * Định dạng số lượng. 0 -> "-"
     */
    formatNumber: (value, decimals = 0) => {
        if (!isFinite(value) || value === null || value === 0) return '-';
        return new Intl.NumberFormat('vi-VN', { minimumFractionDigits: decimals, maximumFractionDigits: decimals }).format(value);
    },

    /**
     * Định dạng doanh thu (chia cho 1 triệu). 0 -> "-"
     */
    formatRevenue(value, decimals = 1) {
         if (!isFinite(value) || value === null) return '-';
         
         // Nếu giá trị quá nhỏ (gần bằng 0) -> trả về "-"
         if (Math.abs(value) < 1000) return '-'; 

         const millions = value / 1000000;
         return new Intl.NumberFormat('vi-VN', {
             minimumFractionDigits: 0,
             maximumFractionDigits: decimals
         }).format(millions);
     },

     /**
      * Định dạng số thường (giữ nguyên logic cũ cho các trường hợp khác)
      */
     formatNumberOrDash: (value, decimals = 1) => {
          if (!isFinite(value) || value === null || Math.abs(value) < 0.01) return '-';
          return new Intl.NumberFormat('vi-VN', {
              minimumFractionDigits: 0,
              maximumFractionDigits: decimals
          }).format(value);
      },

      /**
       * Định dạng phần trăm. 0 -> "-"
       */
     formatPercentage: (value, decimals = 0) => {
          if (!isFinite(value) || value === null) return '-';
          
          // Kiểm tra số 0 tuyệt đối hoặc rất nhỏ
          if (Math.abs(value) < 0.0001) return '-';

          const percentageValue = value * 100;
          return new Intl.NumberFormat('vi-VN', {
             minimumFractionDigits: decimals,
             maximumFractionDigits: decimals
          }).format(percentageValue) + '%';
      },

    getShortEmployeeName(hoTen, maNV) {
        if (!hoTen) return maNV || '';
        const nameParts = hoTen.split(' ').filter(p => p);
        let displayName = hoTen;
        if (nameParts.length > 2) {
            displayName = nameParts.slice(-2).join(' ');
        }
        return `${displayName} - ${maNV}`;
    },
};
--- END FILE: ./src/utils/formatters.js ---

