--- START FILE: ./create_snapshot.cjs ---
// Version 3.0 - Chi·∫øn l∆∞·ª£c "Clean & Lean"
// 1. Whitelist: Ch·ªâ l·∫•y file code (.svelte, .js, .css...), b·ªè qua m·ªçi th·ª© kh√°c.
// 2. Blacklist: Ch·∫∑n c·ª©ng .DS_Store, node_modules, th∆∞ m·ª•c ·∫©n.
// 3. Size Limit: T·ª± ƒë·ªông b·ªè qua file text qu√° l·ªõn (> 500KB) nh∆∞ file log ho·∫∑c file tham kh·∫£o.

const fs = require('fs');
const path = require('path');

// --- C·∫§U H√åNH ---
const config = {
    rootDirectory: '.', 
    outputFile: 'project_snapshot_svelte.txt',
    
    // 1. Ch·ªâ ch·∫•p nh·∫≠n nh·ªØng ƒëu√¥i file n√†y (Quan tr·ªçng ƒë·ªÉ l·ªçc r√°c binary)
    allowedExtensions: [
        '.svelte', 
        '.js', '.ts', '.cjs', '.mjs', 
        '.css', '.scss', '.postcss',
        '.html', 
        '.json', 
        '.md',
        '.txt' // C·∫©n th·∫≠n v·ªõi file n√†y, s·∫Ω l·ªçc b·∫±ng size limit b√™n d∆∞·ªõi
    ],

    // 2. Th∆∞ m·ª•c B·∫ÆT BU·ªòC b·ªè qua
    ignoredDirectories: [
        'node_modules',
        '.git',
        '.vscode',
        '.svelte-kit', // Build output
        'dist',
        'build',
        'public', // Th∆∞·ªùng ch·ª©a ·∫£nh, kh√¥ng ch·ª©a logic code
        'assets'
    ],

    // 3. File B·∫ÆT BU·ªòC b·ªè qua (t√™n c·ª• th·ªÉ)
    ignoredFiles: [
        'package-lock.json', // Qu√° d√†i v√† kh√¥ng c·∫ßn thi·∫øt ƒë·ªÉ AI ƒë·ªçc logic
        'bun.lockb',
        'yarn.lock',
        '.DS_Store', // R√°c macOS
        'project_snapshot_svelte.txt' // Tr√°nh ƒë·ªá quy (ƒë·ªçc ch√≠nh file output)
    ],

    // 4. Gi·ªõi h·∫°n dung l∆∞·ª£ng: 500KB (File code hi·∫øm khi n·∫∑ng h∆°n m·ª©c n√†y)
    // Gi√∫p lo·∫°i b·ªè c√°c file "D·ª± √°n g·ªëc..." n·∫∑ng h√†ng MB.
    maxFileSize: 500 * 1024 
};

// --- LOGIC X·ª¨ L√ù ---

function shouldScanDirectory(dirName) {
    // B·ªè qua th∆∞ m·ª•c b·∫Øt ƒë·∫ßu b·∫±ng d·∫•u ch·∫•m (·∫©n) tr·ª´ khi c·∫ßn thi·∫øt (·ªü ƒë√¢y ch·∫∑n h·∫øt cho an to√†n)
    if (dirName.startsWith('.') && dirName !== '.') return false;
    return !config.ignoredDirectories.includes(dirName);
}

function shouldIncludeFile(filename, size) {
    // 1. Ki·ªÉm tra danh s√°ch ƒëen t√™n file
    if (config.ignoredFiles.includes(filename)) return false;
    if (filename.startsWith('.DS_Store')) return false; // Ch·∫∑n bi·∫øn th·ªÉ

    // 2. Ki·ªÉm tra dung l∆∞·ª£ng
    if (size > config.maxFileSize) {
        console.warn(`‚ö†Ô∏è  B·ªè qua file l·ªõn (>500KB): ${filename}`);
        return false;
    }

    // 3. Ki·ªÉm tra ƒëu√¥i file (Whitelist)
    const ext = path.extname(filename).toLowerCase();
    return config.allowedExtensions.includes(ext);
}

function scanDirectory(directory, fileList = []) {
    const items = fs.readdirSync(directory);

    items.forEach(item => {
        const itemPath = path.join(directory, item);
        const stats = fs.statSync(itemPath);

        if (stats.isDirectory()) {
            if (shouldScanDirectory(item)) {
                scanDirectory(itemPath, fileList);
            }
        } else {
            if (shouldIncludeFile(item, stats.size)) {
                fileList.push(itemPath);
            }
        }
    });

    return fileList;
}

function createSnapshot() {
    console.log("üöÄ ƒêang b·∫Øt ƒë·∫ßu qu√©t d·ª± √°n...");

    // X√≥a file c≈© n·∫øu t·ªìn t·∫°i
    if (fs.existsSync(config.outputFile)) {
        fs.unlinkSync(config.outputFile);
    }

    const allFiles = scanDirectory(config.rootDirectory);
    
    // S·∫Øp x·∫øp file ƒë·ªÉ d·ªÖ ƒë·ªçc (∆∞u ti√™n file c·∫•u h√¨nh ·ªü root tr∆∞·ªõc, sau ƒë√≥ t·ªõi src)
    allFiles.sort((a, b) => {
        const aDepth = a.split(path.sep).length;
        const bDepth = b.split(path.sep).length;
        if (aDepth !== bDepth) return aDepth - bDepth;
        return a.localeCompare(b);
    });

    let fileCount = 0;
    let totalSize = 0;

    allFiles.forEach(filepath => {
        try {
            const content = fs.readFileSync(filepath, 'utf8');
            
            // Chu·∫©n h√≥a ƒë∆∞·ªùng d·∫´n
            const normalizedPath = filepath.replace(/\\/g, '/');
            
            // N·∫øu root l√† '.' th√¨ b·ªè './' ·ªü ƒë·∫ßu cho ƒë·∫πp (t√πy ch·ªçn)
            const displayPath = normalizedPath.startsWith('./') ? normalizedPath : `./${normalizedPath}`;

            const fileHeader = `--- START FILE: ${displayPath} ---\n`;
            const fileFooter = `\n--- END FILE: ${displayPath} ---\n\n`;

            fs.appendFileSync(config.outputFile, fileHeader);
            fs.appendFileSync(config.outputFile, content);
            fs.appendFileSync(config.outputFile, fileFooter);

            fileCount++;
            totalSize += content.length;
            console.log(`+ ƒê√£ th√™m: ${displayPath}`);
        } catch (err) {
            console.error(`‚ùå L·ªói ƒë·ªçc file ${filepath}: ${err.message}`);
        }
    });

    console.log(`\n‚úÖ HO√ÄN T·∫§T!`);
    console.log(`üìÑ T·ªïng s·ªë file: ${fileCount}`);
    console.log(`üíæ Dung l∆∞·ª£ng snapshot: ${(totalSize / 1024).toFixed(2)} KB`);
    console.log(`üìÇ Output: ${config.outputFile}`);
}

createSnapshot();
--- END FILE: ./create_snapshot.cjs ---

--- START FILE: ./index.html ---
<!DOCTYPE html>
<html lang="vi" data-contrast="3">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>C√¥ng c·ª• ph√¢n t√≠ch s·ªë cho QLST MWG 5.0 (Svelte)</title>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/choices.js/public/assets/styles/choices.min.css"/>
    <script src="https://cdn.jsdelivr.net/npm/choices.js/public/assets/scripts/choices.min.js"></script>

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>

    <script src="https://unpkg.com/feather-icons"></script>
    </head>
  <body class="overflow-x-hidden">
    
    <div id="app"></div>

    <script type="module" src="/src/main.js"></script>
  </body>
</html>
--- END FILE: ./index.html ---

--- START FILE: ./jsconfig.json ---
// Version 1.2 - T·∫Øt checkJs ƒë·ªÉ lo·∫°i b·ªè l·ªói type check 2769 do ki·ªÉm tra qu√° nghi√™m ng·∫∑t
{
  "compilerOptions": {
    "moduleResolution": "bundler",
    "target": "ESNext",
    "module": "ESNext",
    "verbatimModuleSyntax": true,
    "isolatedModules": true,
    "resolveJsonModule": true,
    "sourceMap": true,
    "esModuleInterop": true,
    "types": ["vite/client"],
    "skipLibCheck": true,
    "checkJs": false,
    "plugins": [
      {
        "name": "svelte"
      }
    ]
  },
  "include": [
    "src/**/*.d.ts",
    "src/**/*.js",
    "src/**/*.svelte"
  ]
}
--- END FILE: ./jsconfig.json ---

--- START FILE: ./package.json ---
{
  "name": "dashboard-svelte",
  "private": true,
  "version": "0.0.0",
  "type": "module",
  "scripts": {
    "dev": "vite",
    "build": "vite build",
    "preview": "vite preview",
    "check": "svelte-check",
    "tailwind:init": "node ./node_modules/tailwindcss/bin/tailwindcss.js init -p"
  },
  "devDependencies": {
    "@sveltejs/kit": "^2.5.18",
    "@sveltejs/vite-plugin-svelte": "^6.2.1",
    "autoprefixer": "^10.4.22",
    "postcss": "^8.5.6",
    "svelte": "^5.43.5",
    "svelte-check": "^3.8.4",
    "tailwindcss": "^3.4.18",
    "vite": "^7.2.2"
  },
  "dependencies": {
    "feather-icons": "^4.29.2",
    "firebase": "^12.6.0"
  }
}

--- END FILE: ./package.json ---

--- START FILE: ./postcss.config.js ---
// File: postcss.config.js
export default {
  plugins: {
    tailwindcss: {},
    autoprefixer: {},
  },
}
--- END FILE: ./postcss.config.js ---

--- START FILE: ./README.md ---
# Svelte + Vite

This template should help get you started developing with Svelte in Vite.

## Recommended IDE Setup

[VS Code](https://code.visualstudio.com/) + [Svelte](https://marketplace.visualstudio.com/items?itemName=svelte.svelte-vscode).

## Need an official Svelte framework?

Check out [SvelteKit](https://github.com/sveltejs/kit#readme), which is also powered by Vite. Deploy anywhere with its serverless-first approach and adapt to various platforms, with out of the box support for TypeScript, SCSS, and Less, and easily-added support for mdsvex, GraphQL, PostCSS, Tailwind CSS, and more.

## Technical considerations

**Why use this over SvelteKit?**

- It brings its own routing solution which might not be preferable for some users.
- It is first and foremost a framework that just happens to use Vite under the hood, not a Vite app.

This template contains as little as possible to get started with Vite + Svelte, while taking into account the developer experience with regards to HMR and intellisense. It demonstrates capabilities on par with the other `create-vite` templates and is a good starting point for beginners dipping their toes into a Vite + Svelte project.

Should you later need the extended capabilities and extensibility provided by SvelteKit, the template has been structured similarly to SvelteKit so that it is easy to migrate.

**Why include `.vscode/extensions.json`?**

Other templates indirectly recommend extensions via the README, but this file allows VS Code to prompt the user to install the recommended extension upon opening the project.

**Why enable `checkJs` in the JS template?**

It is likely that most cases of changing variable types in runtime are likely to be accidental, rather than deliberate. This provides advanced typechecking out of the box. Should you like to take advantage of the dynamically-typed nature of JavaScript, it is trivial to change the configuration.

**Why is HMR not preserving my local component state?**

HMR state preservation comes with a number of gotchas! It has been disabled by default in both `svelte-hmr` and `@sveltejs/vite-plugin-svelte` due to its often surprising behavior. You can read the details [here](https://github.com/sveltejs/svelte-hmr/tree/master/packages/svelte-hmr#preservation-of-local-state).

If you have state that's important to retain within a component, consider creating an external store which would not be replaced by HMR.

```js
// store.js
// An extremely simple external store
import { writable } from 'svelte/store'
export default writable(0)
```

--- END FILE: ./README.md ---

--- START FILE: ./svelte.config.js ---
// Version 1.2 - Th√™m c·∫•u h√¨nh onwarn ƒë·ªÉ t·∫Øt c·∫£nh b√°o CSS
import { fileURLToPath } from 'url';

/** @type {import('@sveltejs/kit').Config} */
const config = {
    // D√πng onwarn ƒë·ªÉ t√πy ch·ªânh c√°ch x·ª≠ l√Ω c·∫£nh b√°o
    onwarn: (warning, handler) => {
        // Ch·ªâ b·ªè qua c·∫£nh b√°o CSS ch∆∞a s·ª≠ d·ª•ng
        if (warning.code === 'css_unused_selector') {
            return;
        }

        // V·ªõi c√°c c·∫£nh b√°o kh√°c, h√£y d√πng b·ªô x·ª≠ l√Ω m·∫∑c ƒë·ªãnh
        handler(warning);
    }
};

export default config;
--- END FILE: ./svelte.config.js ---

--- START FILE: ./tailwind.config.js ---
/** @type {import('tailwindcss').Config} */
export default {
  content: [
    "./index.html",
    "./src/**/*.{svelte,js,ts}", // B·∫£o n√≥ qu√©t c√°c file svelte
  ],
  theme: {
    extend: {},
  },
  plugins: [],
}
--- END FILE: ./tailwind.config.js ---

--- START FILE: ./vite.config.js ---
// File: vite.config.js
import { defineConfig } from 'vite'
import { svelte } from '@sveltejs/vite-plugin-svelte'

// Svelte 5 + vite-plugin-svelte s·∫Ω T·ª∞ ƒê·ªòNG t√¨m postcss.config.js
export default defineConfig({
  plugins: [svelte()],
})
--- END FILE: ./vite.config.js ---

--- START FILE: ./src/app.css ---
/* src/app.css */
/* Version 2.3 - Add Luyke Dashboard Styles */

/* 1. N·ªÅn t·∫£ng (Variables, body, scrollbar) */
@import url('./styles/base.css');

/* 2. B·ªë c·ª•c ch√≠nh (Sidebar, main-content, drawers) */
@import url('./styles/layout.css');

/* 3. Linh ki·ªán UI (Buttons, cards, modals, inputs) */
@import url('./styles/components.css');

/* 4. B·∫£ng bi·ªÉu (Table styles, sort indicators, header colors) */
@import url('./styles/tables.css');

/* 5. Ghi ƒë√® th∆∞ vi·ªán (Choices.js) */
@import url('./styles/vendor.css');

/* 6. Style chuy√™n bi·ªát cho t·ª´ng tab */
@import url('./styles/specific-sknv.css');
@import url('./styles/specific-tdv.css');
@import url('./styles/specific-composer.css');
@import url('./styles/specific-realtime.css');

/* [M·ªöI] Style cho Dashboard L≈©y K·∫ø (Infographic) */
@import url('./styles/dashboard-luyke.css');

/* 7. (QUAN TR·ªåNG) Tailwind ph·∫£i ƒë∆∞·ª£c n·∫°p SAU C√ôNG 
   ƒë·ªÉ n√≥ c√≥ th·ªÉ ghi ƒë√® (utility classes) l√™n c√°c style ·ªü tr√™n */
@tailwind base;
@tailwind components;
@tailwind utilities;
--- END FILE: ./src/app.css ---

--- START FILE: ./src/App.svelte ---
<script>
  import { onMount, afterUpdate } from 'svelte';
  
  import { 
      activeTab, 
      modalState, 
      efficiencyConfig, 
      customRevenueTables, 
      isAdmin, 
      warehouseCustomMetrics,
      selectedWarehouse
  } from './stores.js'; 
  import { get } from 'svelte/store';
  import { authService } from './services/auth.service.js';
  import { adminService } from './services/admin.service.js';
  import { datasyncService } from './services/datasync.service.js';

  // --- COMPONENTS CH√çNH ---
  import Sidebar from './components/Sidebar.svelte';
  import HomeSection from './components/HomeSection.svelte';
  import DataSection from './components/DataSection.svelte';
  import HealthSection from './components/HealthSection.svelte';
  import HealthEmployeeSection from './components/HealthEmployeeSection.svelte';
  import RealtimeSection from './components/realtime/RealtimeSection.svelte';
  import DeclarationSection from './components/DeclarationSection.svelte';
  
  // --- COMMON UI ---
  import GlobalNotification from './components/common/GlobalNotification.svelte';

  // --- DRAWERS ---
  import InterfaceDrawer from './components/drawers/InterfaceDrawer.svelte';
  import GoalDrawer from './components/drawers/GoalDrawer.svelte';

  // --- MODALS ---
  import AdminModal from './components/modals/AdminModal.svelte';
  import LoginModal from './components/modals/LoginModal.svelte';
  import UserCompetitionModal from './components/modals/UserCompetitionModal.svelte';
  import UserSpecialProgramModal from './components/modals/UserSpecialProgramModal.svelte';
  import ComposerModal from './components/modals/ComposerModal.svelte';
  import AddEfficiencyColumnModal from './components/modals/AddEfficiencyColumnModal.svelte';
  import AddRevenueTableModal from './components/modals/AddRevenueTableModal.svelte';

  onMount(async () => {
    try { await authService.ensureAnonymousAuth(); } catch (e) { console.error("Firebase Auth Error:", e); }
    const isLoggedIn = authService.initAuth();
    if (!isLoggedIn) modalState.update(s => ({ ...s, activeModal: 'login-modal' }));
  });

  afterUpdate(() => {
    if (window.feather) window.feather.replace();
  });

  // [FIX] T√°ch bi·ªát logic l∆∞u Admin vs User
  function handleSaveEffConfig(event) {
      // Clone object ƒë·ªÉ tr√°nh tham chi·∫øu
      const newItem = { ...event.detail };
      
      // LOGIC ADMIN (Tab Khai B√°o)
      if ($activeTab === 'declaration-section') {
          // Admin th√¨ ƒë√°nh d·∫•u isSystem = true (n·∫øu ch∆∞a c√≥)
          newItem.isSystem = true;
          
          efficiencyConfig.update(items => {
              const idx = items.findIndex(i => i.id === newItem.id);
              if (idx >= 0) { items[idx] = newItem; return [...items]; } 
              else { return [...items, newItem]; }
          });
          adminService.saveEfficiencyConfig(get(efficiencyConfig));
      } 
      // LOGIC USER (Tab L≈©y k·∫ø / Realtime)
      else {
          // User th√¨ ƒë√°nh d·∫•u isSystem = false
          newItem.isSystem = false;

          let currentLocal = get(warehouseCustomMetrics) || [];
          const idx = currentLocal.findIndex(i => i.id === newItem.id);
          
          if (idx >= 0) {
              // S·ª≠a
              currentLocal[idx] = newItem;
          } else {
              // Th√™m m·ªõi
              currentLocal = [...currentLocal, newItem];
          }
          
          warehouseCustomMetrics.set(currentLocal);
          
          const wh = get(selectedWarehouse);
          if(wh) {
              datasyncService.saveCustomMetrics(wh, currentLocal);
          } else {
              alert("Vui l√≤ng ch·ªçn Kho ƒë·ªÉ l∆∞u ch·ªâ s·ªë n√†y.");
          }
      }
  }

  // [C·∫¨P NH·∫¨T] X·ª≠ l√Ω l∆∞u b·∫£ng doanh thu (Local + Cloud)
  async function handleSaveCustomTable(event) {
      const newItem = event.detail;
      let currentTables = [];
      
      customRevenueTables.update(items => {
          const idx = items.findIndex(i => i.id === newItem.id);
          if (idx >= 0) { items[idx] = newItem; return [...items]; } 
          else { return [...items, newItem]; }
      });
      
      // L·∫•y gi√° tr·ªã m·ªõi nh·∫•t ƒë·ªÉ l∆∞u
      customRevenueTables.subscribe(val => currentTables = val)();

      // L∆∞u LocalStorage (cho User)
      localStorage.setItem('customRevenueTables', JSON.stringify(currentTables));

      // [QUAN TR·ªåNG] N·∫øu l√† b·∫£ng h·ªá th·ªëng (isSystem) v√† c√≥ quy·ªÅn Admin -> L∆∞u l√™n Cloud
      if (newItem.isSystem) {
          await adminService.saveSystemRevenueTables(currentTables);
      }
  }
</script>

<GlobalNotification />
<InterfaceDrawer />
<GoalDrawer />

<AdminModal />
<LoginModal />
<UserCompetitionModal />
<UserSpecialProgramModal />
<ComposerModal /> 

<AddRevenueTableModal 
    isOpen={$modalState.activeModal === 'add-revenue-table-modal'} 
    editItem={$modalState.payload}
    on:close={() => modalState.update(s => ({ ...s, activeModal: null, payload: null }))}
    on:save={handleSaveCustomTable}
/>

<AddEfficiencyColumnModal 
    isOpen={$modalState.activeModal === 'add-efficiency-modal'} 
    editItem={$modalState.payload}
    isAdmin={$activeTab === 'declaration-section'}
    on:close={() => modalState.update(s => ({ ...s, activeModal: null, payload: null }))}
    on:save={handleSaveEffConfig}
/>

<div class="flex min-h-screen">
  <div id="sidebar-container">
    <Sidebar />
  </div>

  <main id="main-content">
    <div class="flex-1 p-6">
      <div class="max-w-full mx-auto">
        <HomeSection activeTab={$activeTab} />
        <DataSection activeTab={$activeTab} />
        <HealthSection activeTab={$activeTab} />
        <HealthEmployeeSection activeTab={$activeTab} />
        <RealtimeSection activeTab={$activeTab} />
        <DeclarationSection activeTab={$activeTab} />
      </div>
    </div>
  </main>
</div> 

<div id="modal-force-update-container"></div>
<div id="modal-help-container"></div>
<div id="modal-chart-container"></div>
<div id="modal-preview-container"></div>
<div id="modal-selection-container"></div>
<div id="modal-customer-detail-container"></div>
<div id="modal-unexported-detail-container"></div>

<style>
  :global(#main-content) { 
    transition: margin-left 0.3s ease-in-out;
    margin-left: 68px; 
    min-width: 0;
    display: flex;
    flex-direction: column;
    flex: 1 1 0%;
  }

  :global(.page-header) { 
    display: flex; 
    flex-wrap: wrap; 
    justify-content: space-between; 
    align-items: center; 
    gap: 1rem; 
    margin-bottom: 1.5rem;
  }

  :global(.page-header__title) { 
    font-size: 1.75rem; 
    font-weight: 700; 
    color: #1f2937;
  }
</style>
--- END FILE: ./src/App.svelte ---

--- START FILE: ./src/config.js ---
// src/config.js
// Version 2.3 - Update Admin Password
// Ch·ª©a t·∫•t c·∫£ c√°c c·∫•u h√¨nh tƒ©nh c·ªßa ·ª©ng d·ª•ng.

export const config = {
    ADMIN_PASSWORD: "Linh3010", // [UPDATED] M·∫≠t kh·∫©u m·ªõi
    COLUMN_MAPPINGS: {
        danhsachnv: {
            maKho: { required: true, displayName: 'M√£ Kho', aliases: ['m√£ kho', 'makho', 'kho'] },
            maNV: { required: true, displayName: 'M√£ Nh√¢n Vi√™n', aliases: ['m√£ nv', 'msnv', 'm√£ nh√¢n vi√™n', 'manv', 'm√£ s·ªë nh√¢n vi√™n'] },
            hoTen: { required: true, displayName: 'H·ªç v√† T√™n', aliases: ['h·ªç v√† t√™n', 't√™n nh√¢n vi√™n', 't√™n nv', 'h·ªç t√™n'] },
            boPhan: { required: true, displayName: 'B·ªô ph·∫≠n', aliases: ['b·ªô ph·∫≠n'] }
        },
        ycx: {
            ngayTao: { required: true, displayName: 'Ng√†y t·∫°o', aliases: ['ng√†y t·∫°o'] },
            ngayHenGiao: { required: false, displayName: 'Ng√†y h·∫πn giao', aliases: ['ng√†y h·∫πn giao'] },
            nguoiTao: { required: true, displayName: 'Ng∆∞·ªùi t·∫°o', aliases: ['ng∆∞·ªùi t·∫°o'] },
            thanhTien: { required: true, displayName: 'Gi√° b√°n', aliases: ['gi√° b√°n_1', 'gi√° b√°n'] },
            soLuong: { required: true, displayName: 'S·ªë l∆∞·ª£ng', aliases: ['sl b√°n', 's·ªë l∆∞·ª£ng'] },
            nhomHang: { required: true, displayName: 'Nh√≥m h√†ng', aliases: ['nh√≥m h√†ng'] },
            tenSanPham: { required: true, displayName: 'T√™n s·∫£n ph·∫©m', aliases: ['t√™n s·∫£n ph·∫©m'] },
            maSanPham: { required: true, displayName: 'M√£ s·∫£n ph·∫©m', aliases: ['m√£ s·∫£n ph·∫©m', 'masanpham', 'm√£ sp', 'product code'] },
            tenKhachHang: { required: true, displayName: 'T√™n kh√°ch h√†ng', aliases: ['t√™n kh√°ch h√†ng', 'tenkhachhang'] },
            nhaSanXuat: { required: true, displayName: 'Nh√† s·∫£n xu·∫•t', aliases: ['nh√† s·∫£n xu·∫•t', 'nhasanxuat'] },
            nganhHang: { required: true, displayName: 'Ng√†nh h√†ng', aliases: ['ng√†nh h√†ng'] },
            hinhThucXuat: { required: true, displayName: 'H√¨nh th·ª©c xu·∫•t', aliases: ['h√¨nh th·ª©c xu·∫•t'] },
            trangThaiThuTien: { required: true, displayName: 'Tr·∫°ng th√°i thu ti·ªÅn', aliases: ['tr·∫°ng th√°i thu ti·ªÅn'] },
            trangThaiHuy: { required: true, displayName: 'Tr·∫°ng th√°i h·ªßy', aliases: ['tr·∫°ng th√°i h·ªßy'] },
            tinhTrangTra: { required: true, displayName: 'T√¨nh tr·∫°ng tr·∫£', aliases: ['t√¨nh tr·∫°ng nh·∫≠p tr·∫£ c·ªßa s·∫£n ph·∫©m ƒë·ªïi v·ªõi s·∫£n ph·∫©m ch√≠nh', 't√¨nh tr·∫°ng tr·∫£'] },
            trangThaiXuat: { required: true, displayName: 'Tr·∫°ng th√°i xu·∫•t', aliases: ['tr·∫°ng th√°i xu·∫•t'] }
        },
        giocong: {
            maNV: { required: false, displayName: 'M√£ NV', aliases: ['m√£ nv', 'msnv'] },
            hoTen: { required: false, displayName: 'T√™n NV', aliases: ['t√™n nv', 'tennv'] },
            tongGioCong: { required: true, displayName: 'T·ªïng gi·ªù c√¥ng', aliases: ['t·ªïng gi·ªù c√¥ng (x.nh·∫≠n) total', 't·ªïng gi·ªù c√¥ng'] }
        },
        thuongnong: {
            maNV: { required: false, displayName: 'M√£ NV', aliases: ['manv', 'm√£ nv'] },
            hoTen: { required: false, displayName: 'T√™n NV', aliases: ['tennv', 't√™n nv'] },
            diemThuong: { required: true, displayName: 'ƒêi·ªÉm th∆∞·ªüng', aliases: ['diemthuong', 'ƒëi·ªÉm th∆∞·ªüng'] }
        }
    },
    PRODUCT_GROUPS: {
        ICT: ['1491', '931', '42'],
        CE: ['1097', '1098', '1099', '1094', '894'],
        PHU_KIEN: ['16', '1394', '184', '764'],
        GIA_DUNG: ['484', '1214'],
        MAY_LOC_NUOC: ['4171', '4172'],
        PIN_SDP: '12',
        CAMERA_TRONG_NHA: '6479',
        CAMERA_NGOAI_TROi: '4219',
        TAI_NGHE_BLT: '4540',
        NOI_CHIEN: '4099',
        ROBOT_HB: '4439',
        TIVI: '1094',
        TU_LANH: '1097',
        MAY_GIAT: '1099',
        MAY_LANH: '1098',
        DIEN_THOAI: ['13', '1491', '18'],
        LAPTOP: '42',
        SIM: ['1891', '664'],
        VAS: ['164', '571'],
        BAO_HIEM_VAS: ['4479', '4499'],
        SMARTPHONE: ['1491', '18', '13'],
        BAO_HIEM_DENOMINATOR: ['1491', '1097', '894', '1099', '1098', '42', '1094', '3859', '911', '893', '3659'],
        QDC_GROUPS: {
            PIN_SDP: { codes: ['12'], name: 'Pin SDP' },
            TAI_NGHE_BLT: { codes: ['3346', '4540'], name: 'Tai nghe BLT' },
            DONG_HO: { codes: ['4059', '4060', '4061', '4062', '4063', '4064', '4070'], name: 'ƒê·ªìng h·ªì' },
            CAMERA: { codes: ['4219', '6479'], name: 'Camera' },
            LOA: { codes: ['1031', '1351', '4779'], name: 'Loa' },
            UDDD: { codes: ['571', '611'], name: 'UDDƒê' },
            BAO_HIEM: { codes: ['4479', '4499'], name: 'B·∫£o hi·ªÉm' },
            NOI_COM: { codes: ['4157', '4158'], name: 'N·ªìi c∆°m ƒëi·ªán t·ª≠ + cao t·∫ßn' },
            NOI_CHIEN: { codes: ['4099'], name: 'N·ªìi chi√™n' },
            MAY_LOC_NUOC: { codes: ['4171', '4172'], name: 'M√°y l·ªçc n∆∞·ªõc' },
            ROBOT_HB: { codes: ['4439'], name: 'Robot h√∫t b·ª•i' },
            SIM_ONLINE: { codes: ['1891'], name: 'SIM' }
        }
    },
    DEPARTMENT_GROUPS: [
        'BP T∆∞ V·∫•n - ƒêM',
        'BP Trang Tr√≠ ki√™m Thu ng√¢n - Sim S·ªë - ƒêM',
        'BP Kho Ki√™m H·ªó Tr·ª£ K·ªπ Thu·∫≠t Xe ƒê·∫°p - ƒêM'
    ],
    DEFAULT_DATA: {
        HINH_THUC_XUAT_TINH_DOANH_THU: [
            'Xu·∫•t b√°n h√†ng t·∫°i si√™u th·ªã', 'Xu·∫•t cung ·ª©ng d·ªãch v·ª•',
            'Xu·∫•t b√°n pre-order t·∫°i si√™u th·ªã', 'Xu·∫•t SIM tr·∫Øng k√®m theo SIM',
            'Xu·∫•t b√°n h√†ng ∆∞u ƒë√£i cho nh√¢n vi√™n', 'Xu·∫•t b√°n h√†ng t·∫°i si√™u th·ªã (TCƒêM)',
            'Xu·∫•t d·ªãch v·ª• b·∫£o h√†nh tr·ªçn ƒë·ªùi', 'Xu·∫•t d·ªãch v·ª• b·∫£o d∆∞·ª°ng tr·ªçn ƒë·ªùi',
            'Xu·∫•t b√°n h√†ng tr·∫£ g√≥p t·∫°i si√™u th·ªã', 'Xu·∫•t b√°n tr·∫£ g√≥p ∆∞u ƒë√£i cho nh√¢n vi√™n',
            'Xu·∫•t b√°n tr·∫£ g√≥p cho NV ph·ª•c v·ª• c√¥ng vi·ªác', 'Xu·∫•t b√°n pre-order tr·∫£ g√≥p t·∫°i si√™u th·ªã',
            'Xu·∫•t b√°n pre-order tr·∫£ g√≥p t·∫°i si√™u th·ªã (TCƒêM)',
            'Xu·∫•t d·ªãch v·ª• thu h·ªô b·∫£o hi·ªÉm'
        ],
        HINH_THUC_XUAT_TRA_GOP: ['Xu·∫•t b√°n h√†ng tr·∫£ g√≥p t·∫°i si√™u th·ªã', 'Xu·∫•t b√°n tr·∫£ g√≥p ∆∞u ƒë√£i cho nh√¢n vi√™n', 'Xu·∫•t b√°n tr·∫£ g√≥p cho NV ph·ª•c v·ª• c√¥ng vi·ªác', 'Xu·∫•t b√°n pre-order tr·∫£ g√≥p t·∫°i si√™u th·ªã', 'Xu·∫•t b√°n pre-order tr·∫£ g√≥p t·∫°i si√™u th·ªã (TCƒêM)'],
        HE_SO_QUY_DOI: { '1098 - M√°y l·∫°nh (IMEI)': 1, '2011 - Khuy·∫øn m√£i - SP ·∫¢o': 1, '2511 - N·∫°p ti·ªÅn AirTime M_Service': 1, '2151 - Phi·∫øu mua h√†ng/Pre Order': 1, '971 - Th·∫ª c√†o ƒëi·ªán t·ª≠': 1, '431 - ·ªêp L∆∞ng - Flip Cover': 3.37, '2571 - Thu h·ªô c∆∞·ªõc Viettel': 1, '4519 - Thu H·ªô Ti·ªÅn Tr·∫£ G√≥p': 1, '2513 - Thu h·ªô Payoo': 1, '4302 - N√≥n b·∫£o hi·ªÉm c√°c lo·∫°i': 1.92, '2291 - Sim tr·∫Øng (Seri)': 1, '18 - ƒêi·ªán Tho·∫°i Di ƒê·ªông': 1, '4599 - Thu H·ªô Ti·ªÅn M·∫∑t': 1, '12 - Pin s·∫°c d·ª± ph√≤ng': 3.37, '571 - UDDƒê': 1, '58 - Mi·∫øng d√°n m·∫∑t sau': 3.37, '1231 - Mi·∫øng d√°n m·∫∑t tr∆∞·ªõc': 3.37, '1491 - Smartphone': 1, '1891 - Sim Online': 5.45, '4479 - D·ªãch V·ª• B·∫£o Hi·ªÉm': 4.18, '3359 - Ph·ª• ki·ªán ƒë·ªìng h·ªì': 3, '2391 - Smartwatch': 3, '911 - M√°y n∆∞·ªõc n√≥ng': 1, '4499 - Thu H·ªô Ph√≠ B·∫£o Hi·ªÉm': 4.18, '4142 - B√¨nh ƒëun si√™u t·ªëc': 1.85, '4153 - Xay Sinh t·ªë': 1.85, '15 - Tai nghe d√¢y': 3.37, '1412 - D·ªãch v·ª• b·∫£o tr√¨': 1, '3345 - C√°p': 3.37, '2312 - M√£ n·∫°p th·∫ª game': 1, '4900 - B√†n ph√≠m': 3.37, '4141 - B√†n ·ªßi kh√¥': 1.85, '4156 - N·ªìi c∆°m n·∫Øp g√†i/n·∫Øp r·ªùi': 1.85, '14 - S·∫°c/ Adapter': 3.37, '42 - Laptop': 1.2, '751 - Khuy·∫øn m√£i ba l√¥, t√∫i x√°ch': 1, '1031 - Loa di ƒë·ªông': 3.37, '4199 - Mi·∫øng D√°n K√≠nh': 3.37, '3346 - Tai Nghe Bluetooth': 3.37, '931 - M√°y t√≠nh b·∫£ng': 1.2, '19 - Khuy·∫øn m√£i ƒêTDƒê': 1, '10 - Chu·ªôt': 3.37, '4060 - ƒê·ªìng h·ªì Nam D√¢y da': 3, '880 - Loa Karaoke': 1.29, '851 - Khuy·∫øn m√£i ƒêi·ªán T·ª≠': 1, '4169 - L√µi l·ªçc': 1.85, '4540 - Tai Nghe Bluetooth - imei': 3.37, '4062 - ƒê·ªìng h·ªì N·ªØ D√¢y kim lo·∫°i': 3, '2831 - Ph·ª• ki·ªán Apple': 3.37, '2691 - B·ªô S·∫°c/C√°p/Adaptor (Gi√° R·∫ª)': 3.37, '1351 - Loa vi t√≠nh (imei)': 3.37, '1094 - Tivi LED (IMEI)': 1, '4324 - Khung treo, gi√° ƒë·ª°': 3.37, '1099 - M√°y gi·∫∑t (IMEI)': 1, '1097 - T·ªß l·∫°nh (IMEI)': 1, '4099 - N·ªìi chi√™n': 1.85, '4070 - ƒê·ªìng h·ªì Tr·∫ª em': 3, '967 - S·∫•y t√≥c': 1.85, '957 - L√≤ n∆∞·ªõng': 1.85, '958 - L√≤ vi s√≥ng': 1.85, '4158 - N·ªìi c∆°m ƒëi·ªán t·ª≠': 1.85, '3241 - Dao/K√©o/Th·ªõt': 1.92, '3240 - H·ªôp/H≈©': 1.92, '3265 - N·ªìi': 1.92, '4139 - ƒê√®n b√†n/ƒê√®n S·∫°c/ƒê√®n b·∫Øt mu·ªói': 1.85, '73 - Ph·ª• ki·ªán ƒëi·ªán m√°y': 3.37, '4171 - L·ªçc n∆∞·ªõc d·∫°ng t·ªß ƒë·ª©ng': 1.85, '3384 - ƒê·ªì ngh·ªÅ s·ª≠ d·ª•ng ƒëi·ªán': 1, '4147 - B·∫øp ƒëi·ªán ƒë∆°n': 1.85, '4063 - ƒê·ªìng h·ªì N·ªØ D√¢y da': 3, '3263 - Ch·∫£o': 1.92, '3185 - V·ªá sinh nh√† c·ª≠a': 1.92, '4143 - B√†n ·ªßi h∆°i n∆∞·ªõc ƒë·ª©ng': 1.85, '4146 - B·∫øp gas ƒë√¥i': 1.85, '1052 - Khuy·∫øn m√£i ƒêi·ªán L·∫°nh': 1, '3799 - Qu·∫°t ƒëi·ªÅu h√≤a': 1.85, '1951 - Software (s·ªë L∆∞·ª£ng)': 1, '6000 - M√°y √©p tr√°i c√¢y': 1.85, '4059 - ƒê·ªìng h·ªì Nam D√¢y kim lo·∫°i': 3, '4160 - Qu·∫°t b√†n/h·ªôp/s·∫°c': 1.85, '4162 - B√¨nh/Ca ƒë·ª±ng n∆∞·ªõc': 1.92, '4660 - Qu·∫°t l·ª≠ng': 1.85, '17 - Ph·ª• ki·ªán IT kh√°c': 3.37, '4145 - B·∫øp gas ƒë∆°n': 1.85, '875 - D√†n m√°y': 1, '1071 - Ph·ª• ki·ªán ƒëi·ªán t·ª≠': 3.37, '891 - Micro': 1, '4152 - ·ªî c·∫Øm ƒëi·ªán/v·ª£t mu·ªói': 1.85, '4154 - Xay √©p/Kh√°c': 1.85, '5975 - Balo T√∫i Ch·ªëng S·ªëc': 3.37, '893 - T·ªß ƒë√¥ng': 1, '2531 - Thu h·ªô Mservice': 1, '4019 - Sim tr·∫Øng ƒëi·ªán t·ª≠': 1, '4320 - ƒê·ªìng h·ªì - Khuy·∫øn m√£i mua': 1, '3187 - B√¨nh/Ly/Ca gi·ªØ nhi·ªát': 1.92, '4159 - Qu·∫°t ƒë·ª©ng': 1.85, '4157 - N·ªìi c∆°m cao t·∫ßn': 1.85, '16 - Th·∫ª Nh·ªõ': 3.37, '4140 - B√†n ·ªßi h∆°i n∆∞·ªõc': 1.85, '4150 - M√°y n∆∞·ªõc n√≥ng l·∫°nh': 1.85, '591 - Thay sim': 1, '2999 - D·ª•ng c·ª• nh√† b·∫øp kh√°c': 1.92, '4779 - Loa di ƒë·ªông - imei': 3.37, '4440 - G√≥i C∆∞·ªõc V√† D·ªãch V·ª• GTGT': 1, '4121 - M√°y B∆°m N∆∞·ªõc': 1, '4161 - Qu·∫°t treo': 1.85, '4961 - Qu·∫ßn b√≥ & legging n·ªØ Th·ªÉ Thao': 1, '4151 - √Åp su·∫•t/l·∫©u/chi√™n/n∆∞·ªõng': 1.85, '4144 - B·∫øp gas √¢m': 1.85, '871 - USB': 3.37, '6479 - Camera IP Trong nh√†': 3.37, '4219 - Camera IP Ngo√†i tr·ªùi': 3.37, '4659 - Ph·ª• ki·ªán ti·ªán √≠ch Apple': 3.37, '531 - Pin, 4095 - C√°p (Gi√° R·∫ª)': 3.37, '2791 - Kinh doanh m√πa v·ª•': 3.37, '2771 - Gi√° treo m√†n h√¨nh m√°y t√≠nh': 3.37, '80 - Khuy·∫øn m√£i Kh√°c': 1, '1131 - M√°y in, Fax': 2, '4125 - Smartband': 3, '743 - Qu·∫°t s∆∞·ªüi': 1.85, '4659 - Ph·ª• ki·ªán Apple - Imei': 3.37, '4064 - ƒê·ªìng h·ªì N·ªØ D√¢y kh√°c': 3, '956 - H√∫t b·ª•i': 1.85, '4172 - L·ªçc n∆∞·ªõc √¢m t·ªß/tr√™n b√†n': 1.85, '3779 - B·∫øp ƒëi·ªán √¢m': 1.85, '4061 - ƒê·ªìng h·ªì Nam D√¢y kh√°c': 3, '4067 - ƒê·ªìng h·ªì Unisex D√¢y kh√°c': 3, '1411 - D·ªãch v·ª• l·∫Øp ƒë·∫∑t': 1, '4149 - B√¨nh th·ªßy ƒëi·ªán': 1.85, '4148 - B·∫øp ƒëi·ªán ƒë√¥i': 1.85, '955 - H√∫t m√πi/ h√∫t kh√≥i': 1.85, '4699 - Gia d·ª•ng kh√¥ng ƒëi·ªán kh√°c': 1.92, '4859 - Xe ƒë·∫°p ƒë∆∞·ªùng ph·ªë c·ªï ƒëi·ªÉn': 1, '4759 - Ph·ª• Ki·ªán Xe ƒê·∫°p': 1, '2471 - Thu h·ªô c∆∞·ªõc VinaPhone': 1, '3719 - Qu·∫ßn d√†i n·ªØ Th·ªÉ Thao': 1, '1051 - Khuy·∫øn m√£i ƒêi·ªán gia d·ª•ng': 1, '3721 - Qu·∫ßn ng·∫Øn & v√°y n·ªØ Th·ªÉ Thao': 1, '410 - Ph·ª• ki·ªán TT kh√°c': 3.37, '4155 - H√∫t b·ª•i c√¢y': 1.85, '3563 - M√°y t√≠nh nguy√™n b·ªô': 1, '894 - T·ªß m√°t': 1, '3639 - M√°y l·ªçc kh√¥ng kh√≠': 1.85, '611 - ·ª®ng d·ª•ng PC & Laptop': 1, '4089 - ƒê·ªìng h·ªì Unisex D√¢y kim lo·∫°i': 3, '4439 - H√∫t B·ª•i Robot': 1.85, '3740 - √Åo T-shirt nam Th·ªÉ Thao': 1, '4339 - ·ªîn √Åp': 1, '4459 - Qu·∫°t Tr·∫ßn': 1.85, '2351 - Router - Imei': 3.37, '3159 - DV Internet v√† Truy·ªÅn h√¨nh thu ti·ªÅn': 1, '3659 - M√°y s·∫•y l·ªìng ngang': 1, '3519 - √Åo Bra Th·ªÉ Thao': 1, '3479 - Thi·∫øt b·ªã m·∫°ng kh√°c': 3.37, '3859 - M√°y r·ª≠a ch√©n': 1 }
    }
};
--- END FILE: ./src/config.js ---

--- START FILE: ./src/global.d.ts ---
// Version 1.1 - Add XLSX declaration
// File n√†y d√πng ƒë·ªÉ khai b√°o c√°c th∆∞ vi·ªán to√†n c·ª•c (t·ª´ CDN)
// cho tr√¨nh bi√™n d·ªãch TypeScript/JavaScript c·ªßa VSCode.

// ƒê·ªãnh nghƒ©a s·ª± t·ªìn t·∫°i c·ªßa 'feather' tr√™n 'window'
interface Window {
  feather: {
    replace: (options?: object) => void;
  };
}

// ƒê·ªãnh nghƒ©a s·ª± t·ªìn t·∫°i c·ªßa 'feather' nh∆∞ m·ªôt bi·∫øn to√†n c·ª•c
// (D√πng 'any' ƒë·ªÉ ƒë∆°n gi·∫£n h√≥a, v√¨ ch√∫ng ta ch·ªâ d√πng .replace())
declare var feather: any;

// <-- TH√äM M·ªöI (V1.1) -->
// ƒê·ªãnh nghƒ©a s·ª± t·ªìn t·∫°i c·ªßa 'XLSX' (th∆∞ vi·ªán SheetJS)
declare var XLSX: any;
--- END FILE: ./src/global.d.ts ---

--- START FILE: ./src/main.js ---
// src/main.js
// Version 5.1 - Fix Crash & Feather Fallback
import './app.css'
import App from './App.svelte'
import { mount } from 'svelte'
import { firebaseService } from './services/firebase.service.js';
import feather from 'feather-icons';
import './services/employeeService.js'; 
import { authService as auth } from './services/auth.service.js'; 
import { dataService } from './services/dataService.js'; 
import { analyticsService } from './services/analytics.service.js';

async function initializeApp() {
  try {
    // 1. Kh·ªüi t·∫°o Firebase
    firebaseService.initCore();
    
    // 2. Setup Feather Icons (Global)
    window.feather = feather;

    // 3. Mount App
    mount(App, {
        target: document.getElementById('app'),
    });

    // [FIX] G·ªçi replace ngay sau khi mount ƒë·ªÉ ƒë·∫£m b·∫£o icon l·∫ßn ƒë·∫ßu
    setTimeout(() => {
        if (window.feather) window.feather.replace();
    }, 100);

    // 4. B·∫Øt ƒë·∫ßu lu·ªìng d·ªØ li·ªáu
    startDataFlow();

  } catch (e) {
    console.error("L·ªói kh·ªüi t·∫°o:", e);
    // [FIX] Fallback n·∫øu crash: √çt nh·∫•t c≈©ng hi·ªÉn th·ªã th√¥ng b√°o l·ªói ƒë·∫πp
    document.getElementById('app').innerHTML = `<div style="padding: 20px; color: red;"><h3>H·ªá th·ªëng g·∫∑p s·ª± c·ªë kh·ªüi ƒë·ªông.</h3><p>${e.message}</p><button onclick="location.reload()">T·∫£i l·∫°i trang</button></div>`;
  }
}

async function startDataFlow() {
    try {
        await auth.ensureAnonymousAuth();
        const isLoggedIn = auth.initAuth();
        
        if (isLoggedIn) {
            console.log("[Main] User logged in. Starting data load sequence...");
            await dataService.loadAllFromCache();
            
            const email = localStorage.getItem('userEmail');
            if(email) analyticsService.upsertUserRecord(email);
        } else {
            console.log("[Main] User not logged in (waiting for LoginModal). Data load deferred.");
        }

    } catch (e) {
        console.error("L·ªói lu·ªìng d·ªØ li·ªáu:", e);
    }
}

initializeApp();
--- END FILE: ./src/main.js ---

--- START FILE: ./src/services.js ---
// MODULE: SERVICES FACADE
// File n√†y ƒë√≥ng vai tr√≤ ƒëi·ªÅu ph·ªëi, nh·∫≠p kh·∫©u c√°c module logic con v√† export ch√∫ng ra ngo√†i.

// Kh√¥ng import config, appState, ui, utils ·ªü ƒë√¢y ƒë·ªÉ tr√°nh v√≤ng l·∫∑p
// C√°c service con s·∫Ω t·ª± import nh·ªØng th·ª© ch√∫ng c·∫ßn t·ª´ 'stores.js'

import { dataProcessing } from './services/dataProcessing.js'; 
import { reportService } from './services/reportService.js';
import { composerService } from './services/composerService.js';

// G·ªôp t·∫•t c·∫£ v√†o object services
export const services = {
    ...dataProcessing,
    ...reportService,
    ...composerService
};
--- END FILE: ./src/services.js ---

--- START FILE: ./src/stores.js ---
// src/stores.js
import { writable } from 'svelte/store';

/**
 * Bi·∫øn state ch√≠nh, theo d√µi tab n√†o ƒëang ƒë∆∞·ª£c hi·ªÉn th·ªã.
 */
export const activeTab = writable('data-section');

/**
 * Tr·∫°ng th√°i x√°c th·ª±c
 */
export const isAdmin = writable(false); 
export const currentUser = writable(null);

// === D·ªÆ LI·ªÜU T∆Ø∆†NG T√ÅC & N·ªòI DUNG ƒê·ªòNG ===
export const feedbackList = writable([]);
export const userStats = writable([]); 
export const helpContent = writable({
    data: 'ƒêang t·∫£i h∆∞·ªõng d·∫´n...',
    luyke: 'ƒêang t·∫£i h∆∞·ªõng d·∫´n...',
    sknv: 'ƒêang t·∫£i h∆∞·ªõng d·∫´n...',
    realtime: 'ƒêang t·∫£i h∆∞·ªõng d·∫´n...'
});
export const composerTemplates = writable({
    luyke: '',
    sknv: '',
    realtime: ''
});
export const competitionNameMappings = writable({}); 

// Store cho c·∫•u h√¨nh trang ch·ªß
export const homeConfig = writable({
    videoUrl: 'https://www.youtube.com/embed/bmImlht_yB4',
    timeline: [],
    sliderImages: [],
    changelogs: []
});

/**
 * D·ªØ li·ªáu th√¥ (Raw Data)
 */
export const danhSachNhanVien = writable([]);
export const ycxData = writable([]);
export const rawGioCongData = writable([]);
export const thuongNongData = writable([]);
export const thuongERPData = writable([]);
export const pastedThiDuaReportData = writable([]);
export const realtimeYCXData = writable([]);
export const thiDuaVungChiTiet = writable([]);
export const thiDuaVungTong = writable([]);
// D·ªØ li·ªáu th√°ng tr∆∞·ªõc
export const ycxDataThangTruoc = writable([]);
export const thuongNongDataThangTruoc = writable([]);
export const thuongERPDataThangTruoc = writable([]);

/**
 * D·ªØ li·ªáu ƒë√£ x·ª≠ l√Ω (Processed Data)
 */
export const masterReportData = writable({
    luyke: [],
    sknv: [],
    realtime: []
});

/**
 * D·ªØ li·ªáu thi ƒëua
 */
export const competitionData = writable([]);

/**
 * C·∫•u h√¨nh & Khai b√°o
 */
export const declarations = writable({
    hinhThucXuat: '',
    hinhThucXuatGop: '',
    heSoQuyDoi: ''
});
export const categoryStructure = writable([]); 
export const brandList = writable([]); 
export const specialProductList = writable([]);

// [Mapping Stores]
export const macroCategoryConfig = writable([]); 
export const macroProductGroupConfig = writable([]); 
export const categoryNameMapping = writable({}); 
export const groupNameMapping = writable({});
export const brandNameMapping = writable({}); 

export const localCompetitionConfigs = writable([]); 
export const globalCompetitionConfigs = writable([]); 
export const globalSpecialPrograms = writable([]); 

// [M·ªöI] C·∫•u h√¨nh ƒë·ªông cho b·∫£ng Hi·ªáu qu·∫£ & QƒêC
export const efficiencyConfig = writable([]); 
export const qdcConfigStore = writable([]);
export const warehouseCustomMetrics = writable([]);

// [C·∫¨P NH·∫¨T] Reset v·ªÅ m·∫£ng r·ªóng ƒë·ªÉ kh√¥ng hi·ªán b·∫£ng m·∫´u khi kh·ªüi t·∫°o
export const customRevenueTables = writable([]);

/**
 * C√†i ƒë·∫∑t & Tr·∫°ng th√°i UI
 */
export const luykeGoalSettings = writable({});
export const realtimeGoalSettings = writable({});
export const highlightSettings = writable({
    luyke: {},
    sknv: {},
    realtime: {}
});
export const debugInfo = writable({});
export const employeeMaNVMap = writable(new Map());
export const employeeNameToMaNVMap = writable(new Map());
export const charts = writable({});
export const choices = writable({
    luyke_employee: null, luyke_date_picker: null, luyke_highlight_nhanhang: null, luyke_highlight_nhomhang: null, luyke_highlight_employee: null,
    sknv_employee: null, sknv_date_picker: null, sknv_highlight_nhanhang: null, sknv_highlight_nhomhang: null, sknv_highlight_employee: null,
    realtime_employee: null, realtime_highlight_nhanhang: null, realtime_highlight_nhomhang: null, realtime_highlight_employee: null,
    thiDuaVung_sieuThi: null,
    competition_group: null,
    competition_brand: null,
    special_program_group: null, 
    thidua_employee_detail: null,
    realtime_brand_category_filter: null,
    realtime_brand_filter: null,
});
export const viewingDetailFor = writable(null);
export const sortState = writable({});

/**
 * Tr·∫°ng th√°i kho
 */
export const warehouseList = writable([]);
export const selectedWarehouse = writable(null);

// === STATE GIAO DI·ªÜN ===
export const drawerState = writable({ activeDrawer: null });
export const modalState = writable({ activeModal: null });

export const notificationStore = writable({
    message: '',
    type: 'info', 
    visible: false
});

/**
 * C√†i ƒë·∫∑t giao di·ªán
 */
export const interfaceSettings = writable({
    contrastLevel: '3',
    globalFontSize: '18',
    kpiFontSize: '36',
    kpiCard1Bg: '#38bdf8', kpiCard2Bg: '#34d399', kpiCard3Bg: '#fbbf24',
    kpiCard4Bg: '#2dd4bf', kpiCard5Bg: '#a78bfa', kpiCard6Bg: '#f472b6',
    kpiCard7Bg: '#818cf8', kpiCard8Bg: '#f87171',
    kpiTitleColor: '#ffffff',
    kpiMainColor: '#ffffff',
    kpiSubColor: '#ffffff'
});

// === FIREBASE STORE ===
export const firebaseStore = writable({
    app: null,
    auth: null,
    db: null,
    storage: null
});

export const fileSyncState = writable({});
--- END FILE: ./src/stores.js ---

--- START FILE: ./src/utils.js ---
// src/utils.js
// Version 2.4 - Export cleanNameRaw for UI usage
import { get } from 'svelte/store';
import { categoryNameMapping, groupNameMapping, brandNameMapping } from './stores.js';

export function getRandomBrightColor() {
    const colors = [
        '#ef4444', '#f97316', '#eab308', '#84cc16', '#22c55e', '#10b981',
        '#14b8a6', '#06b6d4', '#3b82f6', '#8b5cf6', '#d946ef', '#ec4899',
    ];
    return colors[Math.floor(Math.random() * colors.length)];
}

/**
 * [ƒê√É EXPORT] H√†m l√†m s·∫°ch c∆° b·∫£n (Aggressive Mode).
 * D√πng ƒë·ªÉ g·ª£i √Ω t√™n hi·ªÉn th·ªã s·∫°ch s·∫Ω.
 */
export function cleanNameRaw(name) {
    if (!name || typeof name !== 'string') return '';
    
    let cleaned = name;

    // 1. Lo·∫°i b·ªè c·ª•m "M√£ - " ·ªü ƒë·∫ßu (VD: "13 - ")
    cleaned = cleaned.replace(/^\d+\s*[-‚Äì]\s*/, ''); 

    // 2. Lo·∫°i b·ªè to√†n b·ªô c√°c k√Ω t·ª± s·ªë c√≤n l·∫°i (n·∫øu mu·ªën t√™n ch·ªâ c√≥ ch·ªØ)
    cleaned = cleaned.replace(/[0-9]/g, '');
    
    // 3. Lo·∫°i b·ªè k√Ω t·ª± ƒë·∫∑c bi·ªát, ch·ªâ gi·ªØ l·∫°i ch·ªØ c√°i (Unicode) v√† kho·∫£ng tr·∫Øng
    cleaned = cleaned.replace(/[^\p{L}\s]/gu, ' ');

    return cleaned
        .trim()
        .replace(/\s+/g, ' ') // G·ªôp kho·∫£ng tr·∫Øng th·ª´a
        .toLowerCase()
        .split(' ')
        .map(word => word.charAt(0).toUpperCase() + word.slice(1)) // Vi·∫øt hoa ch·ªØ c√°i ƒë·∫ßu
        .join(' ');
}

export function cleanCategoryName(name) {
    if (!name) return '';
    const rawName = String(name).trim();
    const mappings = get(categoryNameMapping);
    if (mappings && mappings[rawName]) {
        return mappings[rawName];
    }
    return cleanNameRaw(rawName);
}

export function cleanGroupName(name) {
    if (!name) return '';
    const rawName = String(name).trim();
    const mappings = get(groupNameMapping);
    if (mappings && mappings[rawName]) {
        return mappings[rawName];
    }
    return cleanNameRaw(rawName);
}

export function cleanBrandName(name) {
    if (!name) return '';
    const rawName = String(name).trim();
    const mappings = get(brandNameMapping);
    if (mappings && mappings[rawName]) {
        return mappings[rawName];
    }
    return cleanNameRaw(rawName);
}

export function getSortedDepartmentList(reportData) {
    const allDepts = [...new Set(reportData.map(item => item.boPhan).filter(Boolean))];
    allDepts.sort((a, b) => {
        const aIsPriority = a.includes('T∆∞ V·∫•n - ƒêM');
        const bIsPriority = b.includes('T∆∞ V·∫•n - ƒêM');
        if (aIsPriority && !bIsPriority) return -1;
        if (!aIsPriority && bIsPriority) return 1;
        return a.localeCompare(b);
    });
    return allDepts;
}
--- END FILE: ./src/utils.js ---

--- START FILE: ./src/components/DataSection.svelte ---
<script>
  /* global feather */
  import { onMount, onDestroy } from 'svelte'; // [FIX] Th√™m onDestroy
  
  import FileInput from './common/FileInput.svelte';
  import PasteInput from './common/PasteInput.svelte';

  import { 
      warehouseList,
      selectedWarehouse,
      notificationStore,
      danhSachNhanVien // [FIX] Import th√™m store DSNV ƒë·ªÉ l·∫Øng nghe
  } from '../stores.js';
  
  import { dataService } from '../services/dataService.js';

  export let activeTab;
  
  let isSyncing = false;
  let dsnvUnsubscribe; // Bi·∫øn ƒë·ªÉ h·ªßy l·∫Øng nghe

  onMount(async () => {
    if (typeof feather !== 'undefined') {
      feather.replace();
    }

    const savedWh = localStorage.getItem('selectedWarehouse');
    if (savedWh) {
        console.log(`[DataSection] Ph√°t hi·ªán kho ƒë√£ l∆∞u: ${savedWh}. ƒêang ch·ªù DSNV...`);
        selectedWarehouse.set(savedWh);
        
        // [FIX QUAN TR·ªåNG] Thay v√¨ g·ªçi sync ngay, ta l·∫Øng nghe DSNV
        // Ch·ªâ khi DSNV t·∫£i xong (length > 0) th√¨ m·ªõi b·∫Øt ƒë·∫ßu ƒë·ªìng b·ªô c√°c d·ªØ li·ªáu kh√°c
        // ƒêi·ªÅu n√†y ƒë·∫£m b·∫£o logic map nh√¢n vi√™n kh√¥ng b·ªã l·ªói "0 NV"
        dsnvUnsubscribe = danhSachNhanVien.subscribe(async (data) => {
            if (data && data.length > 0) {
                console.log(`[DataSection] DSNV ƒë√£ s·∫µn s√†ng (${data.length} d√≤ng). Ti·∫øn h√†nh ƒë·ªìng b·ªô kho ${savedWh}.`);
                await triggerSync(savedWh);
                
                // ƒê·ªìng b·ªô xong th√¨ h·ªßy l·∫Øng nghe ƒë·ªÉ kh√¥ng g·ªçi l·∫°i th·ª´a th√£i
                if (dsnvUnsubscribe) {
                    dsnvUnsubscribe();
                    dsnvUnsubscribe = null;
                }
            }
        });
    }
  });

  // H·ªßy l·∫Øng nghe khi component b·ªã h·ªßy (ƒë·ªÉ an to√†n)
  onDestroy(() => {
      if (dsnvUnsubscribe) dsnvUnsubscribe();
  });

  async function triggerSync(warehouse) {
      if (!warehouse) return;
      isSyncing = true;
      try {
          const result = await dataService.syncDownFromCloud(warehouse);
          
          if (result && result.success) {
               if(result.message && !result.message.includes('ƒê√£ ki·ªÉm tra')) notificationStore.show(result.message, 'success');
          } else {
               notificationStore.show(result?.message || "L·ªói ƒë·ªìng b·ªô kh√¥ng x√°c ƒë·ªãnh", 'error');
          }
      } catch (error) {
          console.error("L·ªói nghi√™m tr·ªçng khi ƒë·ªìng b·ªô:", error);
          notificationStore.show(`L·ªói ƒë·ªìng b·ªô: ${error.message}`, 'error');
      } finally {
          isSyncing = false;
      }
  }

  async function handleWarehouseChange(event) {
      const newWarehouse = event.target.value;
      selectedWarehouse.set(newWarehouse);
      
      if (newWarehouse) {
          localStorage.setItem('selectedWarehouse', newWarehouse);
          notificationStore.show(`ƒêang ƒë·ªìng b·ªô d·ªØ li·ªáu cho ${newWarehouse}...`, 'info');
          await triggerSync(newWarehouse);
      } else {
          localStorage.removeItem('selectedWarehouse');
      }
  }

  $: if (activeTab === 'data-section') {
    Promise.resolve().then(() => {
      if (typeof window.feather !== 'undefined') {
        window.feather.replace();
      }
    });
  }
</script>

<section id="data-section" class="page-section {activeTab === 'data-section' ? '' : 'hidden'}"> 
    <div class="page-header">
        <div class="flex flex-wrap items-center gap-4">
            <div class="flex items-center gap-x-3">
                <h2 class="page-header__title">C·∫≠p nh·∫≠t d·ªØ li·ªáu</h2>
                <button class="page-header__help-btn" data-help-id="data" title="Xem h∆∞·ªõng d·∫´n">
                    <i data-feather="help-circle" class="feather"></i>
                </button>
            </div>
            
            <div id="data-warehouse-selector-container" class="flex-shrink-0 flex items-center gap-2">
                 <label for="data-warehouse-selector" class="text-sm font-semibold text-gray-700">Kho:</label>
                <div class="relative">
                    <select 
                      id="data-warehouse-selector" 
                      class="p-2 border rounded-lg text-sm shadow-sm min-w-[200px] 
                             font-semibold text-indigo-800 bg-indigo-50 border-indigo-200 
                           focus:ring-indigo-500 focus:border-indigo-500 disabled:opacity-50" 
                      disabled={$warehouseList.length === 0 || isSyncing}
                      value={$selectedWarehouse}
                      on:change={handleWarehouseChange}
                    >
                        {#if $warehouseList.length === 0}
                            <option>Vui l√≤ng t·∫£i file DSNV...</option>
                        {:else}
                            <option value="">-- Ch·ªçn Kho --</option>
                            {#each $warehouseList as kho}
                                <option value={kho}>{kho}</option>
                            {/each}
                        {/if}
                    </select>
                    {#if isSyncing}
                        <div class="absolute right-8 top-1/2 -translate-y-1/2">
                            <svg class="animate-spin h-4 w-4 text-indigo-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                             </svg>
                        </div>
                    {/if}
                </div>
             </div>
        </div>
        <div id="version-marquee-container" class="marquee-container flex-grow min-w-[200px]">
             <p class="marquee-text"></p>
          </div>
    </div>
    
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 mb-6"> 
        <div class="content-card data-card--blue flex flex-col gap-4"> 
            <h3 class="content-card__header data-header--blue">
                <i data-feather="zap" class="h-5 w-5 feather"></i>S·ª¨ D·ª§NG NHANH M·ªñI NG√ÄY
            </h3>
            
            <FileInput 
                label="Y√™u c·∫ßu xu·∫•t l≈©y k·∫ø"
                 icon="file-text"
                saveKey="saved_ycx"
            />
            
            <PasteInput
                label="Data l≈©y k·∫ø"
                icon="clipboard"
                link="https://bi.thegioididong.com/sieu-thi-con?id=16612&tab=1"
                saveKeyPaste="daily_paste_luyke"
            />
            
            <PasteInput
                label="Thi ƒëua nh√¢n vi√™n"
                icon="clipboard"
                link="https://bi.thegioididong.com/sieu-thi-con?id=16758&tab=bcdtnv&rt=2&dm=1"
                saveKeyPaste="daily_paste_thiduanv"
                saveKeyRaw="raw_paste_thiduanv"
                saveKeyProcessed="daily_paste_thiduanv"
            />
        </div>
        
         <div class="content-card data-card--green flex flex-col gap-4"> 
            <h3 class="content-card__header data-header--green">
                 <i data-feather="users" class="h-5 w-5 feather"></i>CHI TI·∫æT NƒÇNG SU·∫§T NH√ÇN VI√äN
            </h3>
            
            <FileInput
                label="Gi·ªù c√¥ng"
                icon="clock"
                saveKey="saved_giocong"
             />
             
            <FileInput
                label="Th∆∞·ªüng n√≥ng"
                icon="gift"
                saveKey="saved_thuongnong"
            />
             
            <PasteInput
                label="Th∆∞·ªüng ERP"
                icon="clipboard"
                link="https://bi.thegioididong.com/reward?id=-1&tab=1"
                saveKeyPaste="daily_paste_thuongerp"
            />
        </div>
    </div>
    
    <div class="content-card data-card--yellow"> 
         <h3 class="content-card__header data-header--yellow">
            <i data-feather="calendar" class="h-5 w-5 feather"></i>D·ªÆ LI·ªÜU C·∫¨P NH·∫¨T 1 TH√ÅNG 1 L·∫¶N
         </h3>
        <p class="text-sm text-yellow-800 bg-yellow-100 p-3 rounded-lg mb-4">L∆∞u √Ω: D·ªØ li·ªáu trong ph·∫ßn n√†y s·∫Ω ƒë∆∞·ª£c l∆∞u v√†o tr√¨nh duy·ªát c·ªßa b·∫°n. D·ªØ li·ªáu s·∫Ω t·ªìn t·∫°i cho ƒë·∫øn khi b·∫°n c·∫≠p nh·∫≠t l·∫°i.</p> 
        
        <div class="grid md:grid-cols-3 gap-4"> 
            <div class="space-y-4"> 
                 <FileInput
                    label="Danh s√°ch nh√¢n vi√™n"
                    icon="users"
                    saveKey="saved_danhsachnv"
                />
                <FileInput
                    label="YCX L≈©y K·∫ø th√°ng tr∆∞·ªõc"
                    icon="file-text"
                    saveKey="saved_ycx_thangtruoc"
                />
            </div> 
             <div class="space-y-4"> 
                  <FileInput
                     label="Th∆∞·ªüng n√≥ng th√°ng tr∆∞·ªõc"
                    icon="gift"
                    saveKey="saved_thuongnong_thangtruoc"
                />
             </div> 
             <div class="space-y-4"> 
                <PasteInput
                    label="Th∆∞·ªüng ERP th√°ng tr∆∞·ªõc"
                    icon="clipboard"
                    link="https://bi.thegioididong.com/reward?id=-1&tab=1"
                    saveKeyPaste="saved_thuongerp_thangtruoc"
                />
            </div> 
        </div> 
    </div> 
</section>
--- END FILE: ./src/components/DataSection.svelte ---

--- START FILE: ./src/components/DeclarationSection.svelte ---
<script>
  import { afterUpdate } from 'svelte';
  
  // Import c√°c component con hi·ªán c√≥
  import AdminCategory from './admin/AdminCategory.svelte';
  import AdminSpecialProducts from './admin/AdminSpecialProducts.svelte';
  import AdminCalculation from './admin/AdminCalculation.svelte';
  import AdminMappings from './admin/AdminMappings.svelte';
  import AdminHelp from './admin/AdminHelp.svelte';
  import AdminUserStats from './admin/AdminUserStats.svelte';
  import AdminCompetition from './admin/AdminCompetition.svelte';
  import AdminHomeConfig from './admin/AdminHomeConfig.svelte';
  import AdminRevenueTables from './admin/AdminRevenueTables.svelte';
  import AdminEfficiency from './admin/AdminEfficiency.svelte'; // [M·ªöI]

  export let activeTab;

  $: if (activeTab === 'declaration-section') {
    Promise.resolve().then(() => {
      if (typeof feather !== 'undefined') {
        feather.replace();
      }
    });
  }
</script>

<section id="declaration-section" class="page-section {activeTab === 'declaration-section' ? '' : 'hidden'}"> 
    <div class="max-w-5xl mx-auto pb-10">
        <h2 class="text-2xl sm:text-3xl font-bold text-gray-800 mb-6 flex items-center gap-3">
            <i data-feather="settings" class="text-blue-600"></i>
            Khai b√°o d·ªØ li·ªáu h·ªá th·ªëng
        </h2>
        
        <div class="mb-8">
             <p class="text-sm text-yellow-700 bg-yellow-50 border border-yellow-200 p-4 rounded-lg flex gap-3">
                <i data-feather="alert-triangle" class="flex-shrink-0 w-5 h-5 text-yellow-600"></i>
                <span>
                    <strong class="block mb-1 font-bold">Khu v·ª±c d√†nh cho Qu·∫£n tr·ªã vi√™n:</strong> 
                    M·ªçi thay ƒë·ªïi t·∫°i ƒë√¢y s·∫Ω ƒë∆∞·ª£c ƒë·ªìng b·ªô l√™n Cloud (Firestore) v√† ·∫£nh h∆∞·ªüng tr·ª±c ti·∫øp ƒë·∫øn to√†n h·ªá th·ªëng.
                </span>
           </p> 
        </div>

        <div class="space-y-6 mb-8">
            <AdminHomeConfig />
        </div>

        <div class="space-y-6 mb-8">
            <AdminRevenueTables />
            <AdminEfficiency /> <AdminCompetition />
        </div>

        <div class="space-y-6">
            <AdminCategory />
            <AdminSpecialProducts />
        </div>

        <div class="space-y-0 mt-8">
            <h3 class="text-lg font-bold text-gray-700 mb-4 ml-1">Thi·∫øt l·∫≠p Logic & T√≠nh to√°n</h3>
            <AdminCalculation />
            <AdminMappings />
        </div>

        <div class="space-y-0 mt-8">
            <h3 class="text-lg font-bold text-gray-700 mb-4 ml-1">H·ªá th·ªëng & N·ªôi dung</h3>
            <AdminHelp />
            <AdminUserStats />
        </div>
    </div>
</section>
--- END FILE: ./src/components/DeclarationSection.svelte ---

--- START FILE: ./src/components/HealthEmployeeSection.svelte ---
<script>
  import { onMount, afterUpdate } from 'svelte';
  import { 
    masterReportData, 
    ycxData, 
    danhSachNhanVien, 
    luykeGoalSettings, 
    selectedWarehouse,
    warehouseList,
    modalState 
  } from '../stores.js';
  
  import { sknvService } from '../services/sknv.service.js';
  import { reportService } from '../services/reportService.js';
  import { actionService } from '../services/action.service.js';
  
  import SummaryView from './health-staff/summary/SummaryView.svelte';
  import DetailView from './health-staff/detail/DetailView.svelte';
  import RevenueTable from './health-staff/RevenueTable.svelte';
  
  // [M·ªöI] Import th√™m RevenueDetailView
  import RevenueDetailView from './health-staff/revenue/RevenueDetailView.svelte';

  import IncomeTable from './health-staff/IncomeTable.svelte';
  import EfficiencyTable from './health-staff/EfficiencyTable.svelte';
  import CategoryRevenueView from './health-staff/CategoryRevenueView.svelte';
  import CompetitionTab from './health-staff/CompetitionTab.svelte';

  export let activeTab;

  let activeSubTab = 'sknv';
  let viewingDetailId = null;
  let processedReport = [];

  const tabs = [
      { id: 'sknv', label: 'SKNV', icon: 'users', title: 'SucKhoeNhanVien' },
      { id: 'doanhthu', label: 'Doanh thu LK', icon: 'dollar-sign', title: 'DoanhThuLuyKe' },
      { id: 'thunhap', label: 'Thu nh·∫≠p', icon: 'briefcase', title: 'ThuNhapNhanVien' },
      { id: 'hieuqua', label: 'Hi·ªáu qu·∫£ NV LK', icon: 'bar-chart-2', title: 'HieuQuaKhaiThac' },
      { id: 'nganhhang', label: 'DT ng√†nh h√†ng', icon: 'layers', title: 'DoanhThuNganhHang' },
      { id: 'thidua', label: 'Thi ƒëua NV LK', icon: 'award', title: 'ThiDuaNhanVien' }
  ];

  let lastDataHash = ''; 
  $: {
      if ($danhSachNhanVien.length > 0 && $ycxData.length > 0) {
          const currentHash = `${$danhSachNhanVien.length}-${$ycxData.length}-${$selectedWarehouse}`;
          if (currentHash !== lastDataHash) {
              lastDataHash = currentHash;
              const goals = ($luykeGoalSettings && $selectedWarehouse) ? $luykeGoalSettings[$selectedWarehouse] || {} : {};
              const newMasterReport = reportService.generateMasterReportData($ycxData, goals, false);
              masterReportData.update(current => ({ ...current, sknv: newMasterReport }));
          }
      }
  }

  $: {
      let rawData = $masterReportData.sknv || [];
      if ($selectedWarehouse) rawData = rawData.filter(nv => nv.maKho === $selectedWarehouse);
      processedReport = sknvService.processReportData(rawData);
  }

  function switchSubTab(tabId) { activeSubTab = tabId; viewingDetailId = null; }
  function handleEmployeeClick(event) { viewingDetailId = event.detail.employeeId; }
  function handleBackToSummary() { viewingDetailId = null; }
  
  function handleWarehouseChange(event) {
      selectedWarehouse.set(event.target.value);
  }

  // === ACTIONS ===
  function handleCompose() { 
      modalState.update(s => ({ ...s, activeModal: 'composer-modal', context: 'sknv' }));
  }
  function handleExport() { 
      actionService.handleExport('sknv'); 
  }
  function handleCapture() { 
      actionService.handleCapture('sknv'); 
  }

  afterUpdate(() => { if (typeof feather !== 'undefined') feather.replace(); });
</script>

<section id="health-employee-section" class="page-section {activeTab === 'health-employee-section' ? '' : 'hidden'}">
    
    <div class="content-card mb-6 !p-0">
        <div class="modern-page-header flex flex-wrap justify-between items-center">
            
            <div class="title-wrapper flex items-center gap-4 flex-wrap">
                <i data-feather="users" class="main-icon hidden sm:block"></i>
                
                <div class="flex items-center gap-2">
                    <h2 class="page-title text-xl sm:text-2xl font-bold text-blue-800">S·ª©c Kh·ªèe Nh√¢n Vi√™n</h2>
                    <button class="page-header__help-btn" data-help-id="sknv" title="Xem h∆∞·ªõng d·∫´n">
                        <i data-feather="help-circle"></i>
                    </button>
                </div>

                <div class="flex items-center gap-2 pl-4 border-l-2 border-blue-100 ml-2">
                    <label for="sknv-warehouse-selector" class="text-sm font-semibold text-gray-600 whitespace-nowrap">Kho:</label>
                    <select 
                        id="sknv-warehouse-selector" 
                        class="p-2 border rounded-lg text-sm shadow-sm min-w-[120px] font-bold text-blue-700 bg-white border-blue-200 focus:ring-2 focus:ring-blue-500 outline-none cursor-pointer hover:bg-blue-50 transition" 
                        value={$selectedWarehouse}
                        on:change={handleWarehouseChange}
                    >
                        <option value="">-- To√†n b·ªô --</option>
                        {#each $warehouseList as kho}
                            <option value={kho}>{kho}</option>
                        {/each}
                    </select>
                </div>
            </div>

            <div class="flex items-center gap-2 ml-auto mt-2 sm:mt-0">
                <button id="compose-sknv-notification-btn" class="action-btn action-btn--composer" title="Nh·∫≠n x√©t" on:click={handleCompose}>
                    <i data-feather="pen-tool" class="w-4 h-4"></i>
                    <span class="hidden lg:inline">Nh·∫≠n x√©t</span>
                </button>
                <button id="export-sknv-btn" class="action-btn action-btn--export" title="Xu·∫•t Excel" on:click={handleExport}>
                    <i data-feather="download" class="w-4 h-4"></i>
                    <span class="hidden lg:inline">Xu·∫•t Excel</span>
                </button>
                <button id="capture-sknv-btn" class="action-btn action-btn--capture" title="Ch·ª•p ·∫£nh" on:click={handleCapture}>
                    <i data-feather="camera" class="w-4 h-4"></i>
                    <span class="hidden lg:inline">Ch·ª•p</span>
                </button>
            </div>
        </div>
        
        <div class="content-card__body p-4">
            <div class="mb-6 overflow-x-auto pb-2">
                <nav id="employee-subtabs-nav" class="flex space-x-2 border-b border-gray-100 pb-1 w-full min-w-max" aria-label="Tabs">
                    {#each tabs as tab}
                        <button 
                            class="sub-tab-btn {activeSubTab === tab.id ? 'active' : ''}"
                            data-target="subtab-{tab.id}" 
                            data-title={tab.title} 
                            on:click={() => switchSubTab(tab.id)}
                        >
                            <i data-feather={tab.icon}></i>
                            <span>{tab.label}</span>
                        </button>
                    {/each}
                </nav>
            </div>

            <div id="employee-subtabs-content" class="min-h-[500px]">
                {#if activeSubTab === 'sknv'}
                    <div id="subtab-sknv" class="sub-tab-content">
                        {#if !viewingDetailId}
                            <div id="sknv-summary-container">
                                <SummaryView reportData={processedReport} on:click={handleEmployeeClick} />
                            </div>
                        {:else}
                            <div id="sknv-detail-capture-area">
                                <DetailView employeeId={viewingDetailId} on:back={handleBackToSummary} />
                            </div>
                        {/if}
                    </div>

                {:else if activeSubTab === 'doanhthu'}
                    <div id="subtab-doanhthu" class="sub-tab-content">
                        {#if !viewingDetailId}
                            <div id="revenue-report-container-lk">
                                <RevenueTable reportData={processedReport} on:viewDetail={handleEmployeeClick} />
                            </div>
                        {:else}
                            <div id="dtnv-lk-capture-area">
                                <RevenueDetailView employeeId={viewingDetailId} on:back={handleBackToSummary} />
                            </div>
                        {/if}
                    </div>

                {:else if activeSubTab === 'thunhap'}
                    <div id="subtab-thunhap" class="sub-tab-content">
                        <div id="income-report-container">
                            <IncomeTable reportData={processedReport} />
                        </div>
                    </div>

                {:else if activeSubTab === 'hieuqua'}
                    <div id="subtab-hieuqua" class="sub-tab-content" data-capture-preset="landscape-table">
                        <div id="efficiency-report-container">
                            <EfficiencyTable reportData={processedReport} />
                        </div>
                    </div>

                {:else if activeSubTab === 'nganhhang'}
                    <div id="subtab-nganhhang" class="sub-tab-content" data-capture-preset="mobile-portrait">
                        <div id="category-revenue-report-container">
                            <CategoryRevenueView reportData={processedReport} />
                        </div>
                    </div>
                
                {:else if activeSubTab === 'thidua'}
                    <div id="subtab-thidua" class="sub-tab-content">
                        <div id="competition-report-container-lk">
                            <CompetitionTab />
                        </div>
                        <div id="pasted-competition-report-container" class="hidden"></div>
                    </div>

                {:else}
                    <div class="p-12 text-center bg-white rounded-xl shadow-sm border border-gray-200">
                        <p class="text-gray-500">N·ªôi dung ƒëang c·∫≠p nh·∫≠t.</p>
                    </div>
                {/if}
            </div>
        </div>
    </div>
</section>
--- END FILE: ./src/components/HealthEmployeeSection.svelte ---

--- START FILE: ./src/components/HealthSection.svelte ---
<script>
  /* global feather */
  import { onMount, afterUpdate } from 'svelte';
  import {
      danhSachNhanVien,
      ycxData,
      masterReportData,
      selectedWarehouse,
      warehouseList,
      luykeGoalSettings,
      modalState,
      categoryNameMapping,
      macroCategoryConfig
  } from '../stores.js';
  
  import { reportService } from '../services/reportService.js';
  import { actionService } from '../services/action.service.js';
  
  import LuykeSieuThi from './luyke/LuykeSieuThi.svelte';
  import LuykeThiDua from './luyke/LuykeThiDua.svelte';
  import LuykeThiDuaVung from './luyke/LuykeThiDuaVung.svelte';

  export let activeTab;
  let activeSubTabId = 'subtab-luyke-sieu-thi';

  let showPlaceholder = true;
  $: showPlaceholder = ($danhSachNhanVien.length === 0);

  let selectedDept = '';
  let selectedDates = [];
  let goals = {};
  $: goals = ($luykeGoalSettings && $selectedWarehouse) 
      ? $luykeGoalSettings[$selectedWarehouse] || {} 
      : {};

  let filteredYCXData = [];
  $: {
      if (selectedDates && selectedDates.length > 0) {
          const startOfDay = (date) => new Date(date.getFullYear(), date.getMonth(), date.getDate()).getTime();
          const selectedDateSet = new Set(selectedDates.map(d => startOfDay(d)));
          filteredYCXData = $ycxData.filter(row => row.ngayTao instanceof Date && !isNaN(row.ngayTao) && selectedDateSet.has(startOfDay(row.ngayTao)));
      } else {
          filteredYCXData = $ycxData;
      }
  }

  $: {
      const _mappingTrigger = $categoryNameMapping;
      const _macroTrigger = $macroCategoryConfig;

      if (!showPlaceholder) {
          const newMasterReport = reportService.generateMasterReportData(
              filteredYCXData, 
              goals, 
              false 
          );
          masterReportData.update(current => ({ ...current, luyke: newMasterReport }));
      }
  }

  let filteredReport = [];
  $: filteredReport = ($masterReportData.luyke || []).filter(nv => {
      const whMatch = !$selectedWarehouse || nv.maKho == $selectedWarehouse;
      const deptMatch = !selectedDept || nv.boPhan === selectedDept;
      return whMatch && deptMatch;
  });
  let supermarketReport = {};
  $: supermarketReport = reportService.aggregateReport(filteredReport, $selectedWarehouse);

  let numDays = 1;
  $: numDays = selectedDates.length > 0 
      ? selectedDates.length 
      : (new Set($ycxData.map(row => row.ngayTao instanceof Date ? new Date(row.ngayTao).toDateString() : null).filter(Boolean)).size || 1);

  function handleSubTabClick(event) {
      const button = event.currentTarget;
      activeSubTabId = button.dataset.target;
  }

  function handleWarehouseChange(event) {
      selectedWarehouse.set(event.target.value);
  }

  function handleCompose() {
      modalState.update(s => ({ ...s, activeModal: 'composer-modal', context: 'luyke' }));
  }

  function handleExport() {
      actionService.handleExport('luyke');
  }

  function handleCapture() {
      actionService.handleCapture('luyke');
  }

  $: if (activeTab === 'health-section') {
    Promise.resolve().then(() => {
      if (typeof window.feather !== 'undefined') {
        window.feather.replace();
      }
    });
  }
</script>

<section id="health-section" class="page-section {activeTab === 'health-section' ? '' : 'hidden'}">
    <div id="health-section-placeholder" class="placeholder-message" class:hidden={!showPlaceholder}>
        Vui l√≤ng c·∫≠p nh·∫≠t danh s√°ch nh√¢n vi√™n ƒë·ªÉ xem k·∫øt qu·∫£.
    </div> 
    
    <div id="health-section-content" class:hidden={showPlaceholder}> 
        <div class="content-card mb-6 !p-0"> 
            <div class="modern-page-header flex flex-wrap justify-between items-center"> 
                <div class="title-wrapper flex items-center gap-4 flex-wrap">
                    <i data-feather="activity" class="main-icon hidden sm:block"></i>
                    
                    <div class="flex items-center gap-2">
                        <h2 class="page-title text-xl sm:text-2xl font-bold text-blue-800">S·ª©c Kh·ªèe Si√™u Th·ªã</h2> 
                        <button class="page-header__help-btn" data-help-id="luyke" title="Xem h∆∞·ªõng d·∫´n"> 
                             <i data-feather="help-circle"></i> 
                        </button>
                    </div>

                    <div class="flex items-center gap-2 pl-4 border-l-2 border-blue-100 ml-2">
                        <label for="luyke-warehouse-selector" class="text-sm font-semibold text-gray-600 whitespace-nowrap">Kho:</label>
                        <select 
                            id="luyke-warehouse-selector" 
                            class="p-2 border rounded-lg text-sm shadow-sm min-w-[120px] font-bold text-blue-700 bg-white border-blue-200 focus:ring-2 focus:ring-blue-500 outline-none cursor-pointer hover:bg-blue-50 transition" 
                            value={$selectedWarehouse}
                            on:change={handleWarehouseChange}
                        >
                            <option value="">-- To√†n b·ªô --</option>
                             {#each $warehouseList as kho}
                                <option value={kho}>{kho}</option>
                            {/each}
                        </select>
                    </div>
                </div>

                <div class="flex items-center gap-2 ml-auto mt-2 sm:mt-0"> 
                    <button id="compose-luyke-notification-btn" class="action-btn action-btn--composer" title="Nh·∫≠n x√©t" on:click={handleCompose}> 
                        <i data-feather="pen-tool" class="w-4 h-4"></i> 
                        <span class="hidden lg:inline">Nh·∫≠n x√©t</span> 
                    </button> 
                    <button id="export-luyke-btn" class="action-btn action-btn--export" title="Xu·∫•t Excel tab hi·ªán t·∫°i" on:click={handleExport}> 
                        <i data-feather="download" class="w-4 h-4"></i> 
                        <span class="hidden lg:inline">Xu·∫•t Excel</span> 
                    </button>
                    <button id="capture-luyke-btn" class="action-btn action-btn--capture" title="Ch·ª•p ·∫£nh tab hi·ªán t·∫°i" on:click={handleCapture}> 
                        <i data-feather="camera" class="w-4 h-4"></i> 
                        <span class="hidden lg:inline">Ch·ª•p ·∫£nh</span> 
                    </button> 
                </div>
            </div> 
            
            <div class="content-card__body p-4">
                <div class="mb-6 overflow-x-auto pb-2">
                    <nav id="luyke-subtabs-nav" class="flex space-x-2 border-b border-gray-100 pb-1 w-full min-w-max" aria-label="Tabs">
                        <button 
                            class="sub-tab-btn {activeSubTabId === 'subtab-luyke-sieu-thi' ? 'active' : ''}" 
                            data-target="subtab-luyke-sieu-thi" 
                            data-title="SieuThiLuyKe"
                            on:click={handleSubTabClick}
                        > 
                            <i data-feather="home"></i> 
                             <span>Si√™u th·ªã L≈©y k·∫ø</span> 
                        </button>
                        <button 
                            class="sub-tab-btn {activeSubTabId === 'subtab-luyke-thi-dua' ? 'active' : ''}" 
                            data-target="subtab-luyke-thi-dua" 
                            data-title="ThiDuaLuyKe"
                            on:click={handleSubTabClick}
                        > 
                            <i data-feather="award"></i> 
                            <span>Thi ƒëua ST L≈©y k·∫ø</span> 
                        </button>
                        <button 
                            class="sub-tab-btn {activeSubTabId === 'subtab-luyke-thidua-vung' ? 'active' : ''}" 
                            data-target="subtab-luyke-thidua-vung" 
                            data-title="ThiDuaVung"
                            on:click={handleSubTabClick}
                        > 
                            <i data-feather="map"></i> 
                            <span>Thi ƒêua V√πng TNB</span> 
                        </button>
                    </nav>
                </div>

                <div id="luyke-subtabs-content"> 
                    {#if activeSubTabId === 'subtab-luyke-sieu-thi'}
                        <div id="subtab-luyke-sieu-thi" class="sub-tab-content">
                            <LuykeSieuThi 
                                supermarketReport={supermarketReport} 
                                filteredYCXData={filteredYCXData} 
                                goals={goals} 
                                numDays={numDays}
                            />
                        </div>
                    
                    {:else if activeSubTabId === 'subtab-luyke-thi-dua'}
                        <div id="subtab-luyke-thi-dua" class="sub-tab-content">
                            <div id="luyke-competition-content">
                                <LuykeThiDua />
                            </div>
                        </div>
                    
                    {:else if activeSubTabId === 'subtab-luyke-thidua-vung'}
                        <div id="subtab-luyke-thidua-vung" class="sub-tab-content">
                             <LuykeThiDuaVung />
                        </div>
                    {/if}
                </div>
            </div>
         </div>
    </div>
</section>
--- END FILE: ./src/components/HealthSection.svelte ---

--- START FILE: ./src/components/HomeSection.svelte ---
<script>
  // Version 2.4 - Upgrade Changelog UI (Blue title, Version prefix, HTML content)
  import { onMount, afterUpdate, onDestroy } from 'svelte';
  import { homeConfig } from '../stores.js';
  import { adminService } from '../services/admin.service.js';
  import { analyticsService } from '../services/analytics.service.js';
  import { formatters } from '../utils/formatters.js';

  export let activeTab;

  let slideIndex = 0;
  let slideInterval;
  let showQRModal = false;
  
  let stats = {
      totalUsers: 0,
      totalVisits: 0,
      totalActions: 0
  };

  let config = {
      videoUrl: 'https://www.youtube.com/embed/bmImlht_yB4',
      timeline: [],
      sliderImages: [],
      changelogs: []
  };

  $: config = $homeConfig || config;

  onMount(async () => {
      adminService.loadHomeConfig();
      startSlideShow();
      const data = await analyticsService.getSystemStats();
      if (data) stats = data;
  });

  onDestroy(() => {
      stopSlideShow();
  });

  $: if (activeTab === 'home-section') {
    Promise.resolve().then(() => {
      if (typeof window.feather !== 'undefined') window.feather.replace();
    });
  }

  function jumpToTime(timeStr) {
      const parts = timeStr.split(':');
      let seconds = 0;
      if (parts.length === 2) {
         seconds = parseInt(parts[0]) * 60 + parseInt(parts[1]);
      } else {
          seconds = parseInt(timeStr);
      }
      let baseUrl = config.videoUrl.split('?')[0];
      config.videoUrl = `${baseUrl}?start=${seconds}&autoplay=1`;
  }

  function startSlideShow() {
      stopSlideShow();
      slideInterval = setInterval(() => {
          if (config.sliderImages.length > 1) {
              slideIndex = (slideIndex + 1) % config.sliderImages.length;
          }
      }, 5000);
  }

  function stopSlideShow() {
      if (slideInterval) clearInterval(slideInterval);
  }

  function nextSlide() {
      stopSlideShow();
      if (config.sliderImages.length > 0) {
          slideIndex = (slideIndex + 1) % config.sliderImages.length;
      }
      startSlideShow();
  }

  function prevSlide() {
      stopSlideShow();
      if (config.sliderImages.length > 0) {
          slideIndex = (slideIndex - 1 + config.sliderImages.length) % config.sliderImages.length;
      }
      startSlideShow();
  }
</script>

<section id="home-section" class="page-section {activeTab === 'home-section' ? '' : 'hidden'}">
     <div class="page-header">
         <div class="flex items-center gap-4">
             <h2 class="page-header__title">H∆∞·ªõng D·∫´n & G√≥p √ù</h2> 
             
             <button 
                class="flex items-center gap-2 px-3 py-1.5 bg-green-500 text-white rounded-full hover:bg-green-600 transition shadow-sm text-sm font-bold"
                on:click={() => showQRModal = true}
             >
                <i data-feather="message-circle" class="w-4 h-4"></i>
                Nh√≥m Line h·ªó tr·ª£
             </button>
         </div>

         <div id="usage-counter-display" class="text-sm font-medium bg-white px-4 py-2 rounded-lg border border-gray-200 shadow-sm flex gap-4 text-gray-600"> 
            <span>Ng∆∞·ªùi d√πng: <strong class="text-blue-600">{formatters.formatNumber(stats.totalUsers)}</strong></span>
            <span class="border-l pl-4">L∆∞·ª£t truy c·∫≠p: <strong class="text-green-600">{formatters.formatNumber(stats.totalVisits)}</strong></span>
            <span class="border-l pl-4">L∆∞·ª£t s·ª≠ d·ª•ng: <strong class="text-purple-600">{formatters.formatNumber(stats.totalActions)}</strong></span>
        </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
        <div class="lg:col-span-2 content-card !p-0 overflow-hidden flex flex-col shadow-lg border-0">
            <div class="relative w-full" style="padding-top: 56.25%;"> 
                <iframe
                    class="absolute top-0 left-0 w-full h-full"
                    src={config.videoUrl}
                    title="H∆∞·ªõng d·∫´n s·ª≠ d·ª•ng"
                    frameborder="0"
                    allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
                    allowfullscreen
               ></iframe>
            </div>
        </div>

        <div class="content-card flex flex-col h-full !mb-0 bg-white border border-gray-200">
            <h3 class="text-lg font-bold text-gray-800 mb-4 flex items-center gap-2">
                <i data-feather="list" class="text-blue-600"></i> M·ª•c l·ª•c Video
            </h3>
            <div class="flex-grow overflow-y-auto pr-2 custom-scrollbar max-h-[300px] lg:max-h-none space-y-2">
                {#if config.timeline && config.timeline.length > 0}
                   {#each config.timeline as item}
                        <button 
                            class="w-full text-left p-3 rounded-lg hover:bg-blue-50 transition flex items-start gap-3 group border border-transparent hover:border-blue-100"
                            on:click={() => jumpToTime(item.time)}
                        >
                            <span class="bg-blue-100 text-blue-700 font-mono text-xs font-bold px-2 py-1 rounded group-hover:bg-blue-600 group-hover:text-white transition-colors">
                                {item.time}
                            </span>
                            <span class="text-sm text-gray-700 font-medium group-hover:text-blue-800 line-clamp-2">
                                {item.label}
                            </span>
                        </button>
                    {/each}
                {:else}
                    <p class="text-sm text-gray-400 italic text-center py-4">Ch∆∞a c√≥ m·ª•c l·ª•c.</p>
                {/if}
            </div>
        </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <div class="content-card flex flex-col h-[600px]">
            <h3 class="text-xl font-bold text-gray-800 mb-4 flex items-center gap-2 border-b pb-2">
                <i data-feather="image" class="text-blue-600"></i> C√°c ch·ª©c nƒÉng d·ª± √°n
            </h3>
            <div class="flex-grow relative group overflow-hidden rounded-lg bg-gray-900 flex items-center justify-center">
                {#if config.sliderImages && config.sliderImages.length > 0}
                    {#each config.sliderImages as img, i}
                         <div 
                            class="absolute inset-0 transition-opacity duration-700 ease-in-out {i === slideIndex ? 'opacity-100 z-10' : 'opacity-0 z-0'}"
                        >
                            <img 
                                src={img.url} 
                                alt={img.title} 
                                class="w-full h-full object-cover"
                            >
                            <div class="absolute bottom-0 left-0 w-full bg-gradient-to-t from-black/80 to-transparent p-6 pt-12">
                                <h3 class="text-white font-bold text-lg drop-shadow-md">{img.title}</h3>
                             </div>
                        </div>
                    {/each}

                    <button class="absolute left-2 top-1/2 -translate-y-1/2 p-2 bg-black/30 hover:bg-black/50 text-white rounded-full z-20 opacity-0 group-hover:opacity-100 transition" on:click={prevSlide}>
                        <i data-feather="chevron-left"></i>
                    </button>
                     <button class="absolute right-2 top-1/2 -translate-y-1/2 p-2 bg-black/30 hover:bg-black/50 text-white rounded-full z-20 opacity-0 group-hover:opacity-100 transition" on:click={nextSlide}>
                        <i data-feather="chevron-right"></i>
                    </button>
                    
                    <div class="absolute bottom-3 right-4 flex gap-2 z-20">
                        {#each config.sliderImages as _, i}
                             <div class="w-2 h-2 rounded-full transition-colors {i === slideIndex ? 'bg-white' : 'bg-white/40'}"></div>
                        {/each}
                    </div>
                {:else}
                    <div class="text-white/50 flex flex-col items-center">
                        <i data-feather="image" class="w-10 h-10 mb-2"></i>
                        <p>Ch∆∞a c√≥ ·∫£nh slide.</p>
                     </div>
                {/if}
            </div>
        </div>

        <div class="content-card flex flex-col h-[600px] bg-slate-50">
            <h3 class="text-xl font-bold text-gray-800 mb-4 flex items-center gap-2 border-b pb-2">
                <i data-feather="clock" class="text-green-600"></i> L·ªãch s·ª≠ c·∫≠p nh·∫≠t
            </h3>
            <div class="flex-grow overflow-y-auto pr-2 custom-scrollbar space-y-4 pb-4">
                {#if config.changelogs && config.changelogs.length > 0}
                   {#each config.changelogs as log}
                        <div class="bg-white p-5 rounded-lg border border-gray-200 shadow-sm hover:shadow-md transition-shadow">
                            <div class="mb-3 border-b border-gray-100 pb-2">
                                <span class="text-lg font-bold text-blue-700">Phi√™n b·∫£n {log.version} <span class="text-gray-500 font-medium text-sm ml-1">({log.date})</span></span>
                            </div>
                            <div class="text-sm text-gray-700 leading-relaxed changelog-content">
                                {@html log.content}
                            </div>
                        </div>
                    {/each}
                {:else}
                    <p class="text-gray-500 italic text-center py-10">Ch∆∞a c√≥ th√¥ng tin c·∫≠p nh·∫≠t.</p>
                {/if}
            </div>
        </div>
    </div>
</section>

{#if showQRModal}
    <div 
        class="fixed inset-0 bg-black/60 z-[1300] flex items-center justify-center backdrop-blur-sm p-4"
        on:click={() => showQRModal = false}
        role="button"
        tabindex="0"
    >
        <div class="bg-white rounded-2xl shadow-2xl p-6 max-w-sm w-full text-center relative animate-fade-in" on:click|stopPropagation>
            <button class="absolute top-4 right-4 text-gray-400 hover:text-red-500" on:click={() => showQRModal = false}>
                <i data-feather="x" class="w-6 h-6"></i>
            </button>
            
            <h3 class="text-xl font-bold text-green-600 mb-2">Qu√©t m√£ tham gia nh√≥m</h3>
            <p class="text-sm text-gray-500 mb-6">S·ª≠ d·ª•ng camera ho·∫∑c Line ƒë·ªÉ qu√©t</p>
            
            <div class="bg-gray-100 p-4 rounded-xl inline-block mb-4">
                <img 
                    src="/images/qr-line-group.jpg" 
                    alt="M√£ QR Nh√≥m Line" 
                    class="w-48 h-48 object-contain rounded-lg"
                    on:error={(e) => e.target.src = 'https://placehold.co/200x200?text=QR+Code+Here'}
                >
            </div>
            
            <p class="text-xs text-gray-400">Gi·∫£i ƒë√°p th·∫Øc m·∫Øc ho·∫∑c y√™u c·∫ßu th√™m t√≠nh nƒÉng</p>
        </div>
    </div>
{/if}

<style>
    .custom-scrollbar::-webkit-scrollbar { width: 6px; }
    .custom-scrollbar::-webkit-scrollbar-track { background: #f1f1f1; }
    .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
    .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
    
    .animate-fade-in { animation: fadeIn 0.3s ease-out; }
    @keyframes fadeIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }

    /* Style cho n·ªôi dung HTML trong Changelog */
    :global(.changelog-content ul) {
        list-style-type: disc;
        padding-left: 1.5rem;
        margin-top: 0.5rem;
        margin-bottom: 0.5rem;
    }
    :global(.changelog-content li) {
        margin-bottom: 0.25rem;
    }
    :global(.changelog-content strong), :global(.changelog-content b) {
        color: #1f2937; /* gray-800 */
        font-weight: 700;
    }
    :global(.changelog-content p) {
        margin-bottom: 0.5rem;
    }
</style>
--- END FILE: ./src/components/HomeSection.svelte ---

--- START FILE: ./src/components/Sidebar.svelte ---
<script>
  /* global feather */
  import { onMount } from 'svelte';
  // [FIX] Import store isAdmin v√† modalState ƒë·ªÉ ki·ªÉm tra quy·ªÅn
  import { activeTab, drawerState, isAdmin, modalState } from '../stores.js';

  // H√†m chuy·ªÉn tab (C·∫≠p nh·∫≠t store global)
  function navigateTo(targetId) {
    // [LOGIC M·ªöI] T·ª± ƒë·ªông tho√°t quy·ªÅn Admin khi r·ªùi kh·ªèi tab Khai b√°o
    if ($activeTab === 'declaration-section' && targetId !== 'declaration-section') {
        isAdmin.set(false);
        console.log("[Security] ƒê√£ t·ª± ƒë·ªông ƒëƒÉng xu·∫•t quy·ªÅn Admin khi r·ªùi trang Khai b√°o.");
    }

    // N·∫øu v√†o Khai b√°o m√† ch∆∞a ph·∫£i Admin -> B·∫≠t modal ƒëƒÉng nh·∫≠p
    if (targetId === 'declaration-section' && !$isAdmin) {
        modalState.update(s => ({ ...s, activeModal: 'admin-modal' }));
        return;
    }
    activeTab.set(targetId);
  }

  // H√†m m·ªü Drawer (C·∫≠p nh·∫≠t store global)
  function openDrawer(drawerId) {
    drawerState.update(state => ({ ...state, activeDrawer: drawerId }));
  }

  // Reactive: Helper ƒë·ªÉ ki·ªÉm tra tab n√†o ƒëang active (ƒë·ªÉ t√¥ m√†u)
  $: currentTab = $activeTab;

  onMount(() => {
    if (typeof window.feather !== 'undefined') {
      window.feather.replace();
    }
  });
</script>

<nav id="sidebar" class="bg-white/80 backdrop-blur-sm shadow-lg fixed top-0 left-0 h-full z-30 p-3 flex flex-col justify-between">
    <div>
        <button 
           class="nav-link flex items-center p-3 rounded-lg font-semibold mb-4 w-full transition-colors
           {currentTab === 'home-section' ? 'bg-blue-100 text-blue-700' : 'text-gray-700 hover:bg-gray-200'}"
           on:click={() => navigateTo('home-section')}
         >
            <i data-feather="home"></i>
            <span class="menu-text">H∆∞·ªõng D·∫´n & G√≥p √ù</span>
         </button>

        <ul class="space-y-2">
            <li>
                <button 
                  class="nav-link flex items-center p-3 rounded-lg font-semibold w-full transition-colors
                         {currentTab === 'data-section' ? 'bg-blue-100 text-blue-700' : 'text-gray-700 hover:bg-gray-200'}"
                  on:click={() => navigateTo('data-section')}
                >
                    <i data-feather="file-text"></i>
                    <span class="menu-text">C·∫≠p nh·∫≠t d·ªØ li·ªáu</span>
                </button>
            </li>

            <li>
                <button 
                  class="nav-link flex items-center p-3 rounded-lg font-semibold w-full transition-colors
                         {currentTab === 'health-section' ? 'bg-blue-100 text-blue-700' : 'text-gray-700 hover:bg-gray-200'}"
                  on:click={() => navigateTo('health-section')}
                >
                    <i data-feather="activity"></i>
                    <span class="menu-text">S·ª©c kh·ªèe si√™u th·ªã</span>
                </button>
            </li>

            <li>
                <button 
                  class="nav-link flex items-center p-3 rounded-lg font-semibold w-full transition-colors
                         {currentTab === 'health-employee-section' ? 'bg-blue-100 text-blue-700' : 'text-gray-700 hover:bg-gray-200'}"
                  on:click={() => navigateTo('health-employee-section')}
                >
                    <i data-feather="users"></i>
                    <span class="menu-text">S·ª©c kh·ªèe nh√¢n vi√™n</span>
                </button>
            </li>

            <li>
                <button 
                  class="nav-link flex items-center p-3 rounded-lg font-semibold w-full transition-colors
                         {currentTab === 'realtime-section' ? 'bg-blue-100 text-blue-700' : 'text-gray-700 hover:bg-gray-200'}"
                  on:click={() => navigateTo('realtime-section')}
                >
                    <i data-feather="trending-up"></i>
                    <span class="menu-text">Doanh thu realtime</span>
                </button>
            </li>
        </ul>
    </div>

    <div>
        <ul class="space-y-2">
            <li>
                 <button 
                   id="interface-settings-btn" 
                   class="w-full flex items-center p-3 text-gray-700 rounded-lg hover:bg-gray-200 font-semibold"
                   on:click={() => openDrawer('interface-drawer')}
                >
                    <i data-feather="settings"></i>
                    <span class="menu-text">C√†i ƒë·∫∑t giao di·ªán</span>
                </button>
            </li>

            <li>
                 <button 
                  id="goal-settings-btn" 
                  class="w-full flex items-center p-3 text-gray-700 rounded-lg hover:bg-gray-200 font-semibold"
                  on:click={() => openDrawer('goal-drawer')}
                >
                    <i data-feather="target"></i>
                    <span class="menu-text">Thi·∫øt l·∫≠p m·ª•c ti√™u</span>
                </button>
            </li>

            <li>
                <button 
                  id="admin-access-btn" 
                  class="w-full flex items-center p-3 rounded-lg font-semibold transition-colors
                         {currentTab === 'declaration-section' ? 'bg-blue-100 text-blue-700' : 'text-gray-700 hover:bg-gray-200'}"
                  on:click={() => navigateTo('declaration-section')}
                >
                    <i data-feather="edit"></i>
                    <span class="menu-text">Khai b√°o</span>
                </button>
            </li>
        </ul>
    </div>
</nav>

<style>
  #sidebar { 
    width: 68px;
    transition: width 0.3s ease-in-out; 
    overflow-x: hidden; 
  }
  #sidebar:hover { 
    width: 256px;
  }
  #sidebar.menu-locked:hover { 
    width: 68px;
  }

  #sidebar .nav-link, #sidebar button {
    white-space: nowrap;
    gap: 1rem;
    justify-content: flex-start;
  }

  .menu-text {
    transition: opacity 0.2s ease-in-out, width 0.3s ease-in-out;
    opacity: 0;
    white-space: nowrap;
    width: 0;
    overflow: hidden;
  }
  #sidebar:hover .menu-text {
    opacity: 1;
    transition-delay: 0.1s;
    width: auto;
  }
  #sidebar.menu-locked:hover .menu-text {
    opacity: 0;
    width: 0;
  }

  #sidebar :global(.feather) {
    width: 1.5rem;
    height: 1.5rem;
    stroke-width: 2;
    flex-shrink: 0;
  }
</style>
--- END FILE: ./src/components/Sidebar.svelte ---

--- START FILE: ./src/services/action.service.js ---
import { get } from 'svelte/store';
import { viewingDetailFor, notificationStore } from '../stores.js';
import { captureService } from './capture.service.js';
import { excelService } from './excel.service.js';

export const actionService = {
    _getActiveTabInfo(sectionId) {
        const navIdMap = {
            'luyke': 'luyke-subtabs-nav',
            'sknv': 'employee-subtabs-nav',
            'realtime': 'realtime-subtabs-nav'
        };
        const contentIdMap = {
            'luyke': 'luyke-subtabs-content',
            'sknv': 'employee-subtabs-content',
            'realtime': 'realtime-subtabs-content'
        };

        const navId = navIdMap[sectionId];
        const contentContainerId = contentIdMap[sectionId];

        if (!navId || !contentContainerId) {
            console.error(`[ActionService] Invalid sectionId: ${sectionId}`);
            return null;
        }

        const navEl = document.getElementById(navId);
        if (!navEl) {
            console.error(`[ActionService] Nav element not found: ${navId}`);
            return null;
        }

        const activeBtn = navEl.querySelector('.sub-tab-btn.active'); 
        
        if (!activeBtn) {
            console.warn(`[ActionService] No active button found in ${navId}`);
            return null;
        }

        return {
            button: activeBtn,
            targetId: activeBtn.dataset.target,
            title: activeBtn.dataset.title || 'BaoCao',
            contentContainerId: contentContainerId
        };
    },

    handleCapture(sectionId) {
        // [FIX] Th√™m log ƒë·ªÉ debug
        console.log(`[ActionService] Trigger capture for: ${sectionId}`);
        
        const tabInfo = this._getActiveTabInfo(sectionId);
        if (!tabInfo) {
            alert('L·ªói: Kh√¥ng x√°c ƒë·ªãnh ƒë∆∞·ª£c tab hi·ªán t·∫°i. Vui l√≤ng t·∫£i l·∫°i trang.');
            return;
        }

        const $viewingDetailFor = get(viewingDetailFor);
        
        // --- LOGIC CH·ª§P CHI TI·∫æT (Detail View) ---
        if (sectionId === 'sknv' && $viewingDetailFor) {
            const { employeeId, sourceTab } = $viewingDetailFor;
            const activeTabTarget = tabInfo.targetId;

            let elementToCapture = null;
            let title = '';
            const preset = 'preset-mobile-portrait';

            if (sourceTab === 'sknv' && activeTabTarget === 'subtab-sknv') {
                 elementToCapture = document.getElementById('sknv-detail-capture-area');
                title = `SKNV_ChiTiet_${employeeId}`;
            } else if (sourceTab === 'dtnv-lk' && activeTabTarget === 'subtab-doanhthu-lk') {
                elementToCapture = document.getElementById('dtnv-lk-capture-area');
                title = `DTLK_ChiTiet_${employeeId}`;
            } else if (sourceTab === 'sknv-thidua-pasted' && activeTabTarget === 'subtab-hieu-qua-thi-dua-lk') {
                elementToCapture = document.getElementById('sknv-thidua-detail-capture-area');
                title = `ThiDuaLK_ChiTiet_${employeeId}`;
            } else if (sourceTab === 'dtnv-rt' && activeTabTarget === 'subtab-realtime-nhan-vien') {
                 elementToCapture = document.getElementById('dtnv-rt-capture-area');
                 title = `DTRT_ChiTiet_${employeeId}`;
            }

            if (elementToCapture) {
                if (elementToCapture.children.length === 0) {
                   alert('Kh√¥ng c√≥ n·ªôi dung chi ti·∫øt ƒë·ªÉ ch·ª•p.');
                    return;
                }
                captureService.captureAndDownload(elementToCapture, title, preset);
                return;
            }
        }

        // --- LOGIC CH·ª§P T·ªîNG QU√ÅT (Summary View) ---
        let elementToCapture;
        
        // X·ª≠ l√Ω ƒë·∫∑c bi·ªát cho tab Thi ƒëua v√πng (n∆°i d√πng infographic ri√™ng)
        if (sectionId === 'luyke' && tabInfo.targetId === 'subtab-luyke-thidua-vung') {
            elementToCapture = document.getElementById('thidua-vung-infographic-container');
        } 
        // X·ª≠ l√Ω ƒë·∫∑c bi·ªát cho Thi ƒëua L≈©y k·∫ø (View Ch∆∞∆°ng tr√¨nh vs Nh√¢n vi√™n)
        else if (sectionId === 'luyke' && tabInfo.targetId === 'subtab-luyke-thi-dua') {
             elementToCapture = document.getElementById('luyke-competition-content');
        }
        else if (sectionId === 'sknv' && tabInfo.targetId === 'subtab-thidua') {
             const activeViewBtn = document.querySelector('#sknv-thidua-view-selector .view-switcher__btn.active');
             const viewType = activeViewBtn ? activeViewBtn.dataset.view : 'program';
             if (viewType === 'program') {
                 elementToCapture = document.getElementById('competition-report-container-lk');
             } else { 
                 elementToCapture = document.getElementById('pasted-competition-report-container');
             }
        }
        else {
            // M·∫∑c ƒë·ªãnh: T√¨m content div ƒëang hi·ªÉn th·ªã
            elementToCapture = document.querySelector(`#${tabInfo.contentContainerId} .sub-tab-content:not(.hidden)`);
        }

        if (!elementToCapture || elementToCapture.children.length === 0) {
            console.error('Capture target is empty or null', elementToCapture);
            alert('L·ªói: Kh√¥ng t√¨m th·∫•y n·ªôi dung ƒë·ªÉ ch·ª•p trong tab n√†y.');
            return;
        }

        captureService.captureDashboardInParts(elementToCapture, tabInfo.title);
    },

    handleExport(sectionId) {
        const tabInfo = this._getActiveTabInfo(sectionId);
        if (!tabInfo) {
            alert('L·ªói: Kh√¥ng t√¨m th·∫•y tab ƒëang ho·∫°t ƒë·ªông.');
            return;
        }

        let activeTabContent;

        if (sectionId === 'sknv' && tabInfo.targetId === 'subtab-thidua') {
            const activeViewBtn = document.querySelector('#sknv-thidua-view-selector .view-switcher__btn.active');
            const viewType = activeViewBtn ? activeViewBtn.dataset.view : 'program';

            if (viewType === 'program') {
                activeTabContent = document.getElementById('competition-report-container-lk');
            } else { 
                activeTabContent = document.getElementById('pasted-competition-report-container');
            }
        } 
        else {
            activeTabContent = document.querySelector(`#${tabInfo.contentContainerId} .sub-tab-content:not(.hidden)`);
        }

        if (activeTabContent) {
            const timestamp = new Date().toLocaleDateString('vi-VN').replace(/\//g, '-');
            excelService.exportTableToExcel(activeTabContent, `${tabInfo.title}_${timestamp}`);
        } else {
             alert('Kh√¥ng t√¨m th·∫•y n·ªôi dung ƒë·ªÉ xu·∫•t Excel.');
        }
    }
};
--- END FILE: ./src/services/action.service.js ---

--- START FILE: ./src/services/admin.service.js ---
// src/services/admin.service.js
// Version 3.1 - Fix Data Compatibility (Restore Old Data)
import { get } from 'svelte/store';
import { doc, setDoc, getDoc, serverTimestamp } from "firebase/firestore";
import { 
    firebaseStore, 
    isAdmin, 
    homeConfig, 
    macroCategoryConfig, 
    macroProductGroupConfig, 
    categoryNameMapping, 
    groupNameMapping,
    brandNameMapping,
    categoryStructure, 
    brandList,
    efficiencyConfig,
    qdcConfigStore,
    competitionNameMappings
} from '../stores.js';

const getDB = () => {
    const fb = get(firebaseStore);
    if (!fb.db) {
        console.warn("Firestore ch∆∞a ƒë∆∞·ª£c kh·ªüi t·∫°o.");
        return null;
    }
    return fb.db;
};

const notify = (msg, type='info') => {
    console.log(`[${type.toUpperCase()}] ${msg}`);
    if(type === 'success' || type === 'error') alert(msg);
};

const sanitizeForFirestore = (obj) => {
    return JSON.parse(JSON.stringify(obj, (key, value) => {
        return value === undefined ? null : value;
    }));
};

export const adminService = {
    // --- 1. HELP CONTENT ---
    async saveHelpContent(contents) {
        const db = getDB();
        if (!db) { notify("L·ªói k·∫øt n·ªëi CSDL!", "error"); return; }
        if (!get(isAdmin)) { notify("B·∫°n c·∫ßn quy·ªÅn Admin ƒë·ªÉ th·ª±c hi·ªán thao t√°c n√†y!", "error"); return; }
        try {
            await Promise.all([
                setDoc(doc(db, "help_content", "data"), { content: contents.data }),
                setDoc(doc(db, "help_content", "luyke"), { content: contents.luyke }),
                setDoc(doc(db, "help_content", "sknv"), { content: contents.sknv }),
                setDoc(doc(db, "help_content", "realtime"), { content: contents.realtime })
            ]);
            notify('ƒê√£ c·∫≠p nh·∫≠t n·ªôi dung h∆∞·ªõng d·∫´n th√†nh c√¥ng!', 'success');
        } catch (error) { 
            console.error("Error saving help content:", error); 
            notify('L·ªói khi l∆∞u n·ªôi dung h∆∞·ªõng d·∫´n.', 'error'); 
        }
    },

    // --- 2. HOME CONFIG ---
    async saveHomeConfig(configData) {
        const db = getDB();
        if (!db) { notify("L·ªói k·∫øt n·ªëi CSDL!", "error"); return; }
        if (!get(isAdmin)) { notify("B·∫°n c·∫ßn quy·ªÅn Admin!", "error"); return; }
        try {
            const docRef = doc(db, "declarations", "homeConfig");
            await setDoc(docRef, { data: sanitizeForFirestore(configData) });
            homeConfig.set(configData);
            notify('ƒê√£ l∆∞u c·∫•u h√¨nh Trang ch·ªß th√†nh c√¥ng!', 'success');
        } catch (error) { 
            console.error("Error saving home config:", error); 
            notify('L·ªói khi l∆∞u c·∫•u h√¨nh trang ch·ªß: ' + error.message, 'error'); 
        }
    },

    async loadHomeConfig() {
        const db = getDB();
        if (!db) return;
        try {
            const docRef = doc(db, "declarations", "homeConfig");
            const docSnap = await getDoc(docRef);
            if (docSnap.exists()) {
                const raw = docSnap.data();
                // Fallback ƒë·ªçc nhi·ªÅu tr∆∞·ªùng
                const data = raw.data || raw.config || raw;
                if (data) homeConfig.set(data);
            }
        } catch (error) { console.error("Error loading home config:", error); }
    },

    // --- 3. CATEGORY & BRAND STRUCTURE ---
    async saveCategoryDataToFirestore(data) {
        const db = getDB();
        if (!db) { notify("L·ªói k·∫øt n·ªëi CSDL!", "error"); return; }
        if (!get(isAdmin)) { notify("B·∫°n c·∫ßn quy·ªÅn Admin!", "error"); return; }
        try {
            const categoryRef = doc(db, "declarations", "categoryStructure");
            await setDoc(categoryRef, { data: sanitizeForFirestore(data.categories || []) });
            const brandRef = doc(db, "declarations", "brandList");
            await setDoc(brandRef, { data: sanitizeForFirestore(data.brands || []) });
            notify('ƒê·ªìng b·ªô d·ªØ li·ªáu khai b√°o th√†nh c√¥ng!', 'success');
        } catch (error) { 
            console.error("Error saving category data:", error); 
            notify('L·ªói khi ƒë·ªìng b·ªô d·ªØ li·ªáu l√™n cloud.', 'error'); 
        }
    },

    async loadCategoryDataFromFirestore() {
        const db = getDB();
        if (!db) return { categories: [], brands: [] };
        
        await this.loadMappingsGlobal();

        try {
            const catRef = doc(db, "declarations", "categoryStructure");
            const brandRef = doc(db, "declarations", "brandList");
            
            const [catSnap, brandSnap] = await Promise.all([getDoc(catRef), getDoc(brandRef)]);
            
            // [FIX] Fallback ƒë·ªçc data
            const getArray = (snap) => {
                if (!snap.exists()) return [];
                const d = snap.data();
                return d.data || d.items || d.list || [];
            };

            const categories = getArray(catSnap);
            const brands = getArray(brandSnap);

            categoryStructure.set(categories);
            brandList.set(brands);

            return { categories, brands };
        } catch (error) {
            console.error("Error loading category data:", error);
            return { categories: [], brands: [] };
        }
    },

    // --- 4. SYSTEM REVENUE TABLES (B·∫¢NG DOANH THU) ---
    async loadSystemRevenueTables() {
        const db = getDB();
        if (!db) return [];
        try {
            const docRef = doc(db, "declarations", "systemRevenueTables");
            const docSnap = await getDoc(docRef);
            if (docSnap.exists()) {
                const d = docSnap.data();
                // [FIX] ∆Øu ti√™n 'tables', n·∫øu kh√¥ng c√≥ th√¨ t√¨m 'data', 'items'
                const tables = d.tables || d.data || d.items || [];
                console.log(`[AdminService] Loaded ${tables.length} system tables.`);
                return tables;
            }
            return [];
        } catch (e) {
            console.error("L·ªói t·∫£i b·∫£ng h·ªá th·ªëng:", e);
            return [];
        }
    },

    async saveSystemRevenueTables(tables) {
        const db = getDB();
        if (!db) { notify("L·ªói k·∫øt n·ªëi CSDL!", "error"); return; }
        if (!get(isAdmin)) { notify("B·∫°n c·∫ßn quy·ªÅn Admin!", "error"); return; }
        
        // Ch·ªâ l∆∞u b·∫£ng c√≥ c·ªù isSystem = true
        const systemTables = tables.filter(t => t.isSystem).map(t => sanitizeForFirestore(t));
        
        try {
            const docRef = doc(db, "declarations", "systemRevenueTables");
            // L∆∞u th·ªëng nh·∫•t v√†o field 'tables'
            await setDoc(docRef, { 
                tables: systemTables,
                updatedAt: serverTimestamp() 
            });
            notify(`ƒê√£ l∆∞u ${systemTables.length} b·∫£ng m·∫´u h·ªá th·ªëng l√™n Cloud!`, 'success');
        } catch (error) { 
            console.error("Firebase Error Full:", error); 
            notify('L·ªói l∆∞u b·∫£ng h·ªá th·ªëng: ' + error.message, 'error'); 
        }
    },

    // --- 5. MAPPINGS & CONFIGS GLOBAL ---
    async loadMappingsGlobal() {
        const db = getDB();
        if (!db) return;
        
        try {
            console.log("[admin.service] ƒêang t·∫£i c·∫•u h√¨nh Mapping t·ª´ Cloud...");
            // Helper ƒë·ªÉ l·∫•y d·ªØ li·ªáu array an to√†n
            const safeGet = (docSnap, defaultVal = []) => {
                if (!docSnap.exists()) return defaultVal;
                const d = docSnap.data();
                // Ki·ªÉm tra c√°c tr∆∞·ªùng ph·ªï bi·∫øn
                return d.data || d.items || d.mappings || d.configs || d.list || defaultVal;
            };

            const docsToLoad = [
                "macroCategoryConfig", 
                "macroProductGroupConfig", 
                "categoryNameMapping", 
                "groupNameMapping", 
                "brandNameMapping",
                "efficiencyConfig", 
                "qdcConfig",
                "competitionNameMappings"
            ];
            const promises = docsToLoad.map(id => getDoc(doc(db, "declarations", id)));
            
            const results = await Promise.all(promises);
            
            macroCategoryConfig.set(safeGet(results[0]));
            macroProductGroupConfig.set(safeGet(results[1]));
            categoryNameMapping.set(safeGet(results[2], {}));
            groupNameMapping.set(safeGet(results[3], {}));
            brandNameMapping.set(safeGet(results[4], {}));
            efficiencyConfig.set(safeGet(results[5])); // B·∫£ng hi·ªáu qu·∫£
            qdcConfigStore.set(safeGet(results[6]));
            competitionNameMappings.set(safeGet(results[7], {}));

            console.log("[admin.service] ƒê√£ t·∫£i xong Mapping & Configs.");
        } catch (error) {
            console.error("Error loading mappings:", error);
        }
    },

    async saveMacroCategoryConfig(data) {
        const db = getDB();
        if (!db) { notify("L·ªói k·∫øt n·ªëi CSDL!", "error"); return; }
        if (!get(isAdmin)) { notify("B·∫°n c·∫ßn quy·ªÅn Admin!", "error"); return; }
        try {
            const docRef = doc(db, "declarations", "macroCategoryConfig");
            await setDoc(docRef, { data: sanitizeForFirestore(data) });
            notify('ƒê√£ l∆∞u C·∫•u h√¨nh Nh√≥m Ng√†nh H√†ng l·ªõn!', 'success');
        } catch (error) { console.error(error); notify('L·ªói l∆∞u c·∫•u h√¨nh: ' + error.message, 'error'); }
    },

    async saveMacroProductGroupConfig(data) {
        const db = getDB();
        if (!db) { notify("L·ªói k·∫øt n·ªëi CSDL!", "error"); return; }
        if (!get(isAdmin)) { notify("B·∫°n c·∫ßn quy·ªÅn Admin!", "error"); return; }
        try {
            const docRef = doc(db, "declarations", "macroProductGroupConfig");
            await setDoc(docRef, { data: sanitizeForFirestore(data) });
            notify('ƒê√£ l∆∞u C·∫•u h√¨nh Nh√≥m H√†ng L·ªõn!', 'success');
        } catch (error) { console.error(error); notify('L·ªói l∆∞u c·∫•u h√¨nh: ' + error.message, 'error'); }
    },

    async saveNameMapping(type, data) {
        const db = getDB();
        if (!db) { notify("L·ªói k·∫øt n·ªëi CSDL!", "error"); return; }
        if (!get(isAdmin)) { notify("B·∫°n c·∫ßn quy·ªÅn Admin!", "error"); return; }
        let docId = '';
        if (type === 'category') docId = 'categoryNameMapping';
        else if (type === 'group') docId = 'groupNameMapping';
        else if (type === 'brand') docId = 'brandNameMapping';
        try {
            const docRef = doc(db, "declarations", docId);
            await setDoc(docRef, { data: sanitizeForFirestore(data) });
            notify(`ƒê√£ l∆∞u Mapping t√™n ${type}!`, 'success');
        } catch (error) { console.error(error); notify('L·ªói l∆∞u mapping: ' + error.message, 'error'); }
    },

    async saveCompetitionNameMappings(mappings) {
        const db = getDB();
        if (!db) { notify("L·ªói k·∫øt n·ªëi CSDL!", "error"); return; }
        if (!get(isAdmin)) { notify("B·∫°n c·∫ßn quy·ªÅn Admin!", "error"); return; }
        try {
            const docRef = doc(db, "declarations", "competitionNameMappings");
            await setDoc(docRef, { mappings: sanitizeForFirestore(mappings) });
            notify('ƒê√£ l∆∞u B·∫£ng √Ånh X·∫° T√™n Thi ƒêua th√†nh c√¥ng!', 'success');
        } catch (error) {
            console.error("L·ªói khi l∆∞u B·∫£ng √Ånh X·∫° T√™n Thi ƒêua:", error);
            notify('L·ªói khi l∆∞u t√™n r√∫t g·ªçn l√™n cloud.', 'error');
        }
    },

    // --- 6. LOGIC & CALCULATION ---
    async loadDeclarationsFromFirestore() {
        const db = getDB();
        if (!db) return {}; 
        try {
            const declarationIds = ['hinhThucXuat', 'hinhThucXuatGop', 'heSoQuyDoi'];
            const declarations = {};
            await Promise.all(declarationIds.map(async (id) => {
                const docRef = doc(db, "declarations", id);
                const docSnap = await getDoc(docRef);
                declarations[id] = docSnap.exists() ? (docSnap.data().content || '') : '';
            }));
            return declarations;
        } catch (error) { console.error("Error loading declarations:", error); return {}; }
    },

    async saveDeclarationsToFirestore(declarations) {
        const db = getDB();
        if (!db) { notify("L·ªói k·∫øt n·ªëi CSDL!", "error"); return; }
        if (!get(isAdmin)) { notify("B·∫°n c·∫ßn quy·ªÅn Admin!", "error"); return; }
        try {
            await Promise.all([
                setDoc(doc(db, "declarations", "hinhThucXuat"), { content: declarations.ycx }),
                setDoc(doc(db, "declarations", "hinhThucXuatGop"), { content: declarations.ycxGop }),
                setDoc(doc(db, "declarations", "heSoQuyDoi"), { content: declarations.heSo })
            ]);
            notify('ƒê·ªìng b·ªô khai b√°o t√≠nh to√°n th√†nh c√¥ng!', 'success');
        } catch (error) { console.error("Error saving declarations:", error); notify('L·ªói khi ƒë·ªìng b·ªô khai b√°o t√≠nh to√°n.', 'error'); }
    },

    // --- 7. COMPETITION CONFIGS ---
    async saveGlobalCompetitionConfigs(configs) {
        const db = getDB();
        if (!db) { notify("L·ªói k·∫øt n·ªëi CSDL!", "error"); return; }
        if (!get(isAdmin)) { notify("B·∫°n c·∫ßn quy·ªÅn Admin!", "error"); return; }
        try {
            const docRef = doc(db, "declarations", "globalCompetitionConfigs");
            await setDoc(docRef, { configs: sanitizeForFirestore(configs) });
        } catch (error) { console.error("Error saving global comps:", error); }
    },

    async loadGlobalCompetitionConfigs() {
        const db = getDB();
        if (!db) return [];
        try {
            const docRef = doc(db, "declarations", "globalCompetitionConfigs");
            const docSnap = await getDoc(docRef);
            if (docSnap.exists()) {
                const d = docSnap.data();
                return d.configs || d.data || [];
            }
            return [];
        } catch (error) { return []; }
    },

    // --- 8. SPECIAL PRODUCTS ---
    async saveSpecialProductList(products) {
        const db = getDB();
        if (!db) { notify("L·ªói k·∫øt n·ªëi CSDL!", "error"); return; }
        if (!get(isAdmin)) { notify("B·∫°n c·∫ßn quy·ªÅn Admin!", "error"); return; }
        try {
            const docRef = doc(db, "declarations", "specialProductList");
            await setDoc(docRef, { products: sanitizeForFirestore(products) });
            notify('ƒê√£ l∆∞u Danh s√°ch SPƒêQ th√†nh c√¥ng!', 'success');
        } catch (error) { console.error("Error saving special product list:", error); notify('L·ªói khi l∆∞u danh s√°ch SPƒêQ.', 'error'); }
    },

    async loadSpecialProductList() {
        const db = getDB();
        if (!db) return [];
        try {
            const docRef = doc(db, "declarations", "specialProductList");
            const docSnap = await getDoc(docRef);
            if (docSnap.exists()) {
                const d = docSnap.data();
                return d.products || d.data || [];
            }
            return [];
        } catch (error) { console.error("Error loading SPƒêQ:", error); return []; }
    },

    async loadGlobalSpecialPrograms() {
        const db = getDB();
        if (!db) return [];
        try {
            const docRef = doc(db, "declarations", "globalSpecialPrograms");
            const docSnap = await getDoc(docRef);
            if (docSnap.exists()) {
                const d = docSnap.data();
                return d.programs || d.configs || d.data || [];
            }
            return [];
        } catch (error) { return []; }
    },

    // --- 9. EFFICIENCY & QDC CONFIGS ---
    // (B·∫¢NG HI·ªÜU QU·∫¢)
    async saveEfficiencyConfig(config) {
        const db = getDB();
        if (!db) { notify("L·ªói k·∫øt n·ªëi CSDL!", "error"); return; }
        if (!get(isAdmin)) { notify("B·∫°n c·∫ßn quy·ªÅn Admin!", "error"); return; }
        
        try {
            const docRef = doc(db, "declarations", "efficiencyConfig");
            await setDoc(docRef, { 
                data: sanitizeForFirestore(config),
                updatedAt: serverTimestamp() 
            });
            efficiencyConfig.set(config);
            notify('ƒê√£ l∆∞u c·∫•u h√¨nh B·∫£ng Hi·ªáu qu·∫£ h·ªá th·ªëng!', 'success');
        } catch (e) { 
            console.error(e); 
            notify('L·ªói l∆∞u config: ' + e.message, 'error'); 
        }
    },

    async loadEfficiencyConfig() {
        const db = getDB();
        if (!db) return [];
        try {
            const docRef = doc(db, "declarations", "efficiencyConfig");
            const docSnap = await getDoc(docRef);
            if (docSnap.exists()) {
                const d = docSnap.data();
                // [FIX] ƒê·ªçc fallback 'data' ho·∫∑c 'items' ho·∫∑c 'config'
                const data = d.data || d.items || d.config || [];
                console.log(`[AdminService] Loaded efficiency config: ${data.length} items`);
                return data;
            }
            return [];
        } catch (e) { 
            console.error("L·ªói t·∫£i efficiency config:", e);
            return []; 
        }
    },
    
    // (TOP NH√ìM H√ÄNG)
    async saveQdcConfig(selectedGroups) {
         const db = getDB();
        if (!db || !get(isAdmin)) return;
        try {
            const docRef = doc(db, "declarations", "qdcConfig");
            await setDoc(docRef, { data: sanitizeForFirestore(selectedGroups) });
            qdcConfigStore.set(selectedGroups);
        } catch (e) { console.error(e); }
    },
    
    async loadQdcConfig() {
        const db = getDB();
        if (!db) return [];
        try {
            const docRef = doc(db, "declarations", "qdcConfig");
            const docSnap = await getDoc(docRef);
            if (docSnap.exists()) {
                const d = docSnap.data();
                return d.data || d.config || d.items || [];
            }
            return [];
        } catch (e) { return []; }
    }
};
--- END FILE: ./src/services/admin.service.js ---

--- START FILE: ./src/services/analytics.service.js ---
// src/services/analytics.service.js
// Version 2.2 - Full code implementation (Added getSystemStats & trackAction)
import { get } from 'svelte/store';
import { collection, getDocs, doc, setDoc, serverTimestamp, increment } from "firebase/firestore";
import { firebaseStore, isAdmin, currentUser } from '../stores.js';

const getDB = () => {
    const fb = get(firebaseStore);
    return fb.db;
};

export const analyticsService = {
    // L·∫•y danh s√°ch to√†n b·ªô user ƒë·ªÉ t√≠nh to√°n th·ªëng k√™
    async getAllUsers() {
        const db = getDB();
        // Kh√¥ng y√™u c·∫ßu quy·ªÅn Admin ·ªü ƒë√¢y ƒë·ªÉ Home c√≥ th·ªÉ hi·ªÉn th·ªã s·ªë li·ªáu chung
        if (!db) return [];

        try {
            const usersCollection = collection(db, "users");
            const querySnapshot = await getDocs(usersCollection);
            const users = [];
            
            querySnapshot.forEach((doc) => {
                const data = doc.data();
                users.push({
                    email: data.email,
                    loginCount: data.loginCount || 0,
                    lastLogin: data.lastLogin ? data.lastLogin.toDate() : null,
                    actionsTaken: data.actionsTaken || 0
                });
            });
            return users;
        } catch (error) {
            console.error("L·ªói khi l·∫•y danh s√°ch user:", error);
            return [];
        }
    },

    // C·∫≠p nh·∫≠t th√¥ng tin user khi ƒëƒÉng nh·∫≠p
    async upsertUserRecord(email) {
        const db = getDB();
        if (!db || !email) return;

        const userRef = doc(db, "users", email);
        try {
            await setDoc(userRef, {
                email: email,
                lastLogin: serverTimestamp(),
                loginCount: increment(1)
            }, { merge: true });
        } catch (error) {
            console.error("L·ªói c·∫≠p nh·∫≠t user record:", error);
        }
    },

    // H√†m tƒÉng counter th·ªß c√¥ng (Gi·ªØ l·∫°i ƒë·ªÉ t∆∞∆°ng th√≠ch ng∆∞·ª£c n·∫øu c·∫ßn)
    async incrementCounter(fieldName, email = null) {
        const db = getDB();
        if (!db || !fieldName) return;

        if (!email) {
            const user = get(currentUser);
            if (user) email = user.email;
        }

        let docRef;
        const dataToUpdate = { [fieldName]: increment(1) };

        if (fieldName === 'actionsTaken' && email) {
            docRef = doc(db, "users", email);
        } else {
            docRef = doc(db, "analytics", "site_stats");
        }

        try {
            await setDoc(docRef, dataToUpdate, { merge: true });
        } catch (error) {
            console.error(`L·ªói tƒÉng counter ${fieldName}:`, error);
        }
    },

    // [M·ªöI] H√†m l·∫•y t·ªïng h·ª£p s·ªë li·ªáu to√†n h·ªá th·ªëng
    async getSystemStats() {
        const users = await this.getAllUsers();
        
        const stats = users.reduce((acc, user) => {
            acc.totalUsers += 1; // M·ªói user l√† 1 ng∆∞·ªùi d√πng
            acc.totalVisits += (user.loginCount || 0); // T·ªïng s·ªë l·∫ßn ƒëƒÉng nh·∫≠p
            acc.totalActions += (user.actionsTaken || 0); // T·ªïng s·ªë l·∫ßn upload/paste
            return acc;
        }, { totalUsers: 0, totalVisits: 0, totalActions: 0 });

        return stats;
    },

    // [M·ªöI] H√†m ghi nh·∫≠n h√†nh ƒë·ªông (d√πng cho upload/paste)
    async trackAction() {
        const user = get(currentUser);
        if (!user || !user.email) return; // Ch·ªâ t√≠nh khi ƒë√£ ƒëƒÉng nh·∫≠p
        
        const db = getDB();
        if (!db) return;

        const userRef = doc(db, "users", user.email);
        try {
            await setDoc(userRef, {
                actionsTaken: increment(1)
            }, { merge: true });
            console.log("[Analytics] ƒê√£ ghi nh·∫≠n 1 l∆∞·ª£t s·ª≠ d·ª•ng.");
        } catch (error) {
            console.error("L·ªói trackAction:", error);
        }
    }
};
--- END FILE: ./src/services/analytics.service.js ---

--- START FILE: ./src/services/auth.service.js ---
// Version 2.3 - Add Anonymous Auth to fix 403 error
import { get } from 'svelte/store';
import { currentUser, isAdmin } from '../stores.js';
import { analyticsService } from './analytics.service.js';
import { config } from '../config.js';
import { getAuth, signInAnonymously, onAuthStateChanged } from "firebase/auth";

export const authService = {
    /**
     * Ki·ªÉm tra ƒë·ªãnh d·∫°ng email
     * @param {string} email 
     * @returns {boolean}
     */
    isValidEmail(email) {
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        return email && emailRegex.test(email);
    },

    /**
     * [QUAN TR·ªåNG] ƒê·∫£m b·∫£o ng∆∞·ªùi d√πng ƒë√£ ƒëƒÉng nh·∫≠p v√†o Firebase (·∫®n danh)
     * H√†m n√†y c·∫ßn ƒë∆∞·ª£c g·ªçi ngay khi App kh·ªüi ch·∫°y ƒë·ªÉ l·∫•y token.
     * @returns {Promise<User>} Firebase User object
     */
    async ensureAnonymousAuth() {
        const auth = getAuth();
        return new Promise((resolve, reject) => {
            // L·∫Øng nghe tr·∫°ng th√°i x√°c th·ª±c
            const unsubscribe = onAuthStateChanged(auth, (user) => {
                if (user) {
                    console.log("[AuthService] ƒê√£ x√°c th·ª±c Firebase (·∫®n danh):", user.uid);
                    unsubscribe(); // H·ªßy l·∫Øng nghe sau khi ƒë√£ c√≥ user
                    resolve(user);
                } else {
                    console.log("[AuthService] Ch∆∞a c√≥ user, ƒëang ƒëƒÉng nh·∫≠p ·∫©n danh...");
                    signInAnonymously(auth)
                        .catch((error) => {
                            console.error("[AuthService] L·ªói ƒëƒÉng nh·∫≠p ·∫©n danh:", error);
                            reject(error);
                        });
                }
            });
        });
    },

    /**
     * X·ª≠ l√Ω ƒë·ªãnh danh ng∆∞·ªùi d√πng qua Email (Application Layer)
     * @param {string} email 
     * @returns {Promise<boolean>} true n·∫øu th√†nh c√¥ng
     */
    async loginUser(email) {
        const cleanEmail = email.trim();
        if (!this.isValidEmail(cleanEmail)) {
            return false;
        }

        // 1. L∆∞u v√†o LocalStorage ƒë·ªÉ nh·ªõ cho l·∫ßn sau
        localStorage.setItem('userEmail', cleanEmail);

        // 2. C·∫≠p nh·∫≠t Store
        currentUser.set({ email: cleanEmail });

        // 3. G·ªçi Analytics (Upsert user record)
        analyticsService.upsertUserRecord(cleanEmail).catch(err => {
            console.error("[AuthService] L·ªói khi ghi nh·∫≠n user v√†o analytics:", err);
        });

        return true;
    },

    /**
     * Ki·ªÉm tra m·∫≠t kh·∫©u Admin
     * @param {string} password 
     * @returns {boolean}
     */
    checkAdminPassword(password) {
        if (!config || !config.ADMIN_PASSWORD) {
            console.error("[AuthService] Ch∆∞a c·∫•u h√¨nh m·∫≠t kh·∫©u Admin trong config.js");
            return false;
        }
        
        if (password === config.ADMIN_PASSWORD) {
            isAdmin.set(true);
            return true;
        }
        
        return false;
    },

    /**
     * Kh·ªüi t·∫°o: Ki·ªÉm tra xem ƒë√£ c√≥ email l∆∞u trong localStorage ch∆∞a
     * (Ch·ªâ ki·ªÉm tra logic Email, ph·∫ßn Firebase Auth s·∫Ω ch·∫°y ri√™ng)
     */
    initAuth() {
        const savedEmail = localStorage.getItem('userEmail');
        if (savedEmail && this.isValidEmail(savedEmail)) {
            console.log(`[AuthService] T√¨m th·∫•y email ƒë√£ l∆∞u: ${savedEmail}`);
            currentUser.set({ email: savedEmail });
            // Ghi nh·∫≠n phi√™n truy c·∫≠p
            analyticsService.upsertUserRecord(savedEmail);
            return true; // ƒê√£ c√≥ email ƒë·ªãnh danh
        }
        return false; // Ch∆∞a c√≥ email
    }
};
--- END FILE: ./src/services/auth.service.js ---

--- START FILE: ./src/services/capture.service.js ---
/* global Chart */
import { notificationStore, currentUser } from '../stores.js';
import { analyticsService } from './analytics.service.js';
import { get } from 'svelte/store';
// Import c√°c h√†m utils ƒë√£ ƒë∆∞·ª£c s·ª≠a ·ªü tr√™n
import { injectCaptureStyles, swapCanvasToImage } from '../utils/capture.utils.js';

export const captureService = {
    async captureAndDownload(elementToCapture, title, presetClass = '') {
        // 1. Ki·ªÉm tra th∆∞ vi·ªán
        if (typeof window.html2canvas === 'undefined') {
            alert("L·ªói: Th∆∞ vi·ªán html2canvas ch∆∞a t·∫£i xong. Vui l√≤ng F5 l·∫°i trang.");
            return;
        }

        const date = new Date();
        const dateString = date.toLocaleDateString('vi-VN', { day: '2-digit', month: '2-digit' });
        // Format ti√™u ƒë·ªÅ chu·∫©n: Title - HH:MM dd/mm
        const timeString = date.toLocaleTimeString('vi-VN', { hour: '2-digit', minute: '2-digit' });
        const finalTitle = `${title.replace(/_/g, ' ')} - ${timeString} ${dateString}`;
    
        // 2. T·∫°o wrapper t·∫°m th·ªùi (d√πng class CSS t·ª´ utils ƒë·ªÉ ·∫©n n√≥ ƒëi)
        const captureWrapper = document.createElement('div');
        captureWrapper.className = 'capture-container'; // Class n√†y c√≥ left: -9999px
    
        // 3. Th√™m ti√™u ƒë·ªÅ v√†o ·∫£nh
        const titleEl = document.createElement('h2');
        titleEl.className = 'capture-title';
        titleEl.textContent = finalTitle;
        captureWrapper.appendChild(titleEl);
        
        // 4. Clone n·ªôi dung
        const contentClone = elementToCapture.cloneNode(true);
        if (presetClass) { contentClone.classList.add(presetClass); }

        captureWrapper.appendChild(contentClone);
        document.body.appendChild(captureWrapper);
    
        // 5. T·∫Øt animation c·ªßa Chart.js (n·∫øu c√≥) ƒë·ªÉ ch·ª•p kh√¥ng b·ªã m·ªù
        if (typeof Chart !== 'undefined') {
            Chart.defaults.animation = false;
        }
        
        // 6. [QUAN TR·ªåNG] Chuy·ªÉn ƒë·ªïi Canvas th√†nh ·∫¢nh tƒ©nh
        swapCanvasToImage(contentClone);

        // 7. ƒê·ª£i render (Delay 200ms) - C·∫ßn thi·∫øt ƒë·ªÉ browser v·∫Ω ·∫£nh xong
        await new Promise(resolve => setTimeout(resolve, 200));

        try {
            // 8. Ch·ª•p b·∫±ng html2canvas
            const canvas = await window.html2canvas(captureWrapper, {
                scale: 2, // TƒÉng ch·∫•t l∆∞·ª£ng ·∫£nh
                useCORS: true, // Cho ph√©p ·∫£nh t·ª´ domain kh√°c
                backgroundColor: '#f3f4f6', // M√†u n·ªÅn x√°m nh·∫°t
                logging: false,
                windowWidth: captureWrapper.scrollWidth,
                windowHeight: captureWrapper.scrollHeight
            });
    
            // 9. T·∫£i xu·ªëng
            const link = document.createElement('a');
            link.download = `${title}_${dateString.replace(/\//g, '-')}.png`;
            link.href = canvas.toDataURL('image/png');
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            notificationStore.update(s => ({ ...s, visible: true, type: 'success', message: 'ƒê√£ t·∫£i ·∫£nh xu·ªëng th√†nh c√¥ng!' }));
            setTimeout(() => notificationStore.update(s => ({ ...s, visible: false })), 3000);

        } catch (err) {
            console.error('L·ªói captureService:', err);
            alert(`L·ªói khi ch·ª•p ·∫£nh: ${err.message}`);
        } finally {
            // 10. D·ªçn d·∫πp
            if (document.body.contains(captureWrapper)) {
                document.body.removeChild(captureWrapper);
            }
            if (typeof Chart !== 'undefined') {
                Chart.defaults.animation = {}; // B·∫≠t l·∫°i animation
            }
        }
    },
    
    async captureDashboardInParts(contentContainer, baseTitle) {
       if (!contentContainer) {
            alert('L·ªói: Kh√¥ng t√¨m th·∫•y n·ªôi dung ƒë·ªÉ ch·ª•p.');
            return;
        }

        const user = get(currentUser);
        analyticsService.incrementCounter('actionsTaken', user?.email);
        
        notificationStore.update(s => ({ ...s, visible: true, type: 'info', message: `ƒêang x·ª≠ l√Ω ·∫£nh: ${baseTitle}...` }));
    
        // Gom nh√≥m c√°c ph·∫ßn t·ª≠ c·∫ßn ch·ª•p (data-capture-group)
        const captureGroups = new Map();
        contentContainer.querySelectorAll('[data-capture-group]').forEach(el => {
            // Ch·ªâ l·∫•y c√°c ph·∫ßn t·ª≠ ƒëang hi·ªÉn th·ªã (c√≥ offsetParent)
            if (el.offsetParent !== null) {
                const group = el.dataset.captureGroup;
                if (!captureGroups.has(group)) {
                     captureGroups.set(group, []);
                }
                captureGroups.get(group).push(el);
            }
        });
        
        // Inject CSS (QUAN TR·ªåNG: ƒê·ªÉ ƒë·ªãnh d·∫°ng b·∫£ng, mobile preset, v.v.)
        const styleElement = injectCaptureStyles();
        
        if (typeof Chart !== 'undefined') {
            Chart.defaults.animation = false;
        }
        await new Promise(resolve => setTimeout(resolve, 100));
        
        try {
            // Case 1: Kh√¥ng c√≥ group n√†o, ch·ª•p nguy√™n container
            if (captureGroups.size === 0) {
                if (contentContainer.offsetParent !== null) {
                    const preset = contentContainer.dataset.capturePreset;
                    const presetClass = preset ? `preset-${preset}` : '';
                    await this.captureAndDownload(contentContainer, baseTitle, presetClass);
                } else {
                     alert('Kh√¥ng c√≥ n·ªôi dung hi·ªÉn th·ªã ƒë·ªÉ ch·ª•p.');
                }
                return;
            }

            // Case 2: Ch·ª•p t·ª´ng group
            for (const [group, elements] of captureGroups.entries()) {
                const targetElement = elements[0];
                
                // T√¨m ti√™u ƒë·ªÅ con (h3, h4) ƒë·ªÉ ƒë·∫∑t t√™n file cho ƒë·∫πp
                let foundTitle = '';
                if (targetElement) {
                    foundTitle = targetElement.querySelector('h3, h4')?.textContent?.trim() || '';
                }
                
                const captureTitle = (foundTitle || baseTitle)
                                        .replace(/[^a-zA-Z0-9\s√Å-·ªπ]/g, '')
                                        .replace(/\s+/g, '_');
                
                const preset = targetElement.dataset.capturePreset;
                const isKpiGroup = group === 'kpi'; // KPI Group c·∫ßn x·ª≠ l√Ω grid ƒë·∫∑c bi·ªát
                
                let elementToCapture;
                let presetClass = '';

                if (isKpiGroup) {
                    presetClass = 'prepare-for-kpi-capture';
                } else if (preset) {
                    presetClass = `preset-${preset}`;
                }

                // N·∫øu group c√≥ nhi·ªÅu element (v√≠ d·ª• 2 b·∫£ng ngang nhau), gom v√†o container chung
                if (elements.length > 1 && !isKpiGroup) {
                    const tempContainer = document.createElement('div');
                    tempContainer.className = 'capture-layout-container'; // CSS flex column gap 24px
                    elements.forEach(el => tempContainer.appendChild(el.cloneNode(true)));
                    elementToCapture = tempContainer;
                } else {
                    elementToCapture = targetElement;
                }
    
                await this.captureAndDownload(elementToCapture, captureTitle, presetClass);
                
                // Delay nh·ªè gi·ªØa c√°c l·∫ßn ch·ª•p ƒë·ªÉ kh√¥ng treo tr√¨nh duy·ªát
                await new Promise(resolve => setTimeout(resolve, 300));
            }
        } finally {
            styleElement.remove();
            if (typeof Chart !== 'undefined') {
                Chart.defaults.animation = {};
            }
        }

        notificationStore.update(s => ({ ...s, visible: true, type: 'success', message: 'Ho√†n t·∫•t!' }));
        setTimeout(() => notificationStore.update(s => ({ ...s, visible: false })), 3000);
    },
};
--- END FILE: ./src/services/capture.service.js ---

--- START FILE: ./src/services/composerService.js ---
// File: src/services/composerService.js
// M·ª§C ƒê√çCH: Ch·ªâ ch·ª©a logic cho Tr√¨nh t·∫°o Nh·∫≠n x√©t.

import { get } from 'svelte/store';
import { masterReportData } from '../stores.js';
import { dataProcessing } from './dataProcessing.js';
// [FIX L·ªñI IMPORT] D√πng 'import * as utils' thay v√¨ 'import { utils }'
import * as utils from '../utils.js'; 
import { formatters } from '../utils/formatters.js';

const composerServices = {
    // Logic getEmployeeRanking
    getEmployeeRanking(reportData, key, direction = 'desc', count = 3, department = 'ALL') {
        if (!reportData || reportData.length === 0) return [];
        let filteredData = reportData;
        if (department !== 'ALL') {
            filteredData = reportData.filter(e => e.boPhan === department);
        }

        return [...filteredData]
            .filter(e => e[key] > 0)
            .sort((a, b) => direction === 'desc' ? (b[key] || 0) - (a[key] || 0) : (a[key] || 0) - (b[key] || 0))
            .slice(0, count);
    },

    // Logic getEmployeesBelowTarget
    getEmployeesBelowTarget(reportData, dataKey, goalKey, department = 'ALL') {
        if (!reportData || reportData.length === 0) return [];
        let filteredData = reportData;
        if (department !== 'ALL') {
            filteredData = reportData.filter(e => e.boPhan === department);
        }

        return filteredData.filter(employee => {
            const value = employee[dataKey] || 0;
            const target = (employee.mucTieu?.[goalKey] || 0) / 100;
            return target > 0 && value < target;
        }).sort((a, b) => (b[dataKey] || 0) - (a[dataKey] || 0));
    },

    // Logic formatEmployeeList
    formatEmployeeList(employeeArray, valueKey, valueType = 'number') {
        if (!Array.isArray(employeeArray) || employeeArray.length === 0) {
            return " (kh√¥ng c√≥)";
        }
        return "\n" + employeeArray.map((e, index) => {
            const value = e[valueKey];
            let formattedValue = '';
            if (valueType === 'percent') {
                formattedValue = formatters.formatPercentage(value);
            } else if (valueType === 'currency') {
                formattedValue = formatters.formatRevenue(value) + " tr";
            } else {
                formattedValue = formatters.formatNumberOrDash(value);
            }
            return `${index + 1}. ${formatters.getShortEmployeeName(e.hoTen, e.maNV)}: ${formattedValue} @${e.maNV}`;
        }).join("\n");
    },
    
    // Logic processComposerTemplate
    processComposerTemplate(template, supermarketReport, goals, rankingReportData, competitionData, sectionId) {
        if (!template || !supermarketReport || !goals) {
            return "L·ªói: D·ªØ li·ªáu kh√¥ng ƒë·ªß ƒë·ªÉ t·∫°o nh·∫≠n x√©t.";
        }

        const tagMapping = {
            'DTQD': { key: 'doanhThuQuyDoi', format: 'currency' },
            'THUNHAP': { key: 'tongThuNhap', format: 'currency' },
            'TLQD': { key: 'hieuQuaQuyDoi', format: 'percent' },
        };

        const botTargetMapping = {
            'TLQD': { dataKey: 'hieuQuaQuyDoi', goalKey: 'phanTramQD', format: 'percent' },
            'TLTC': { dataKey: 'tyLeTraCham', goalKey: 'phanTramTC', format: 'percent' },
            'PK': { dataKey: 'pctPhuKien', goalKey: 'phanTramPhuKien', format: 'percent' },
            'GD': { dataKey: 'pctGiaDung', goalKey: 'phanTramGiaDung', format: 'percent' },
            'MLN': { dataKey: 'pctMLN', goalKey: 'phanTramMLN', format: 'percent' },
            'SIM': { dataKey: 'pctSim', goalKey: 'phanTramSim', format: 'percent' },
            'VAS': { dataKey: 'pctVAS', goalKey: 'phanTramVAS', format: 'percent' },
            'BH': { dataKey: 'pctBaoHiem', goalKey: 'phanTramBaoHiem', format: 'percent' },
        };

        return template.replace(/\[(.*?)\]/g, (match, tag) => {
            const now = new Date();
            const currentDay = now.getDate() || 1;

            let dtThuc = supermarketReport.doanhThu || 0;
            let dtQd = supermarketReport.doanhThuQuyDoi || 0;
            let phanTramHTQD = goals.doanhThuQD > 0 ? (dtQd / 1000000) / goals.doanhThuQD : 0;

            if (sectionId === 'luyke') {
                // C·∫ßn ƒë·∫£m b·∫£o element t·ªìn t·∫°i tr∆∞·ªõc khi l·∫•y value
                const pasteEl = document.getElementById('paste-luyke');
                const pastedLuyKeData = dataProcessing.parseLuyKePastedData(pasteEl?.value || '');
                
                if (pastedLuyKeData.mainKpis && pastedLuyKeData.mainKpis['Th·ª±c hi·ªán DT th·ª±c']) {
                    dtThuc = parseFloat(pastedLuyKeData.mainKpis['Th·ª±c hi·ªán DT th·ª±c'].replace(/,/g, '')) * 1000000;
                }
                if (pastedLuyKeData.mainKpis && pastedLuyKeData.mainKpis['Th·ª±c hi·ªán DTQƒê']) {
                    dtQd = parseFloat(pastedLuyKeData.mainKpis['Th·ª±c hi·ªán DTQƒê'].replace(/,/g, '')) * 1000000;
                }
                if (pastedLuyKeData.mainKpis && pastedLuyKeData.mainKpis['% HT Target D·ª± Ki·∫øn (Qƒê)']) {
                    phanTramHTQD = (parseFloat(pastedLuyKeData.mainKpis['% HT Target D·ª± Ki·∫øn (Qƒê)'].replace('%', '')) || 0) / 100;
                }
            }

            if (tag === 'NGAY') return now.toLocaleDateString('vi-VN');
            if (tag === 'GIO') return now.toLocaleTimeString('vi-VN', { hour: '2-digit', minute: '2-digit' });

            if (tag === 'DT_THUC') return formatters.formatNumber(dtThuc / 1000000, 0) + " tr";
            if (tag === 'DTQD') return formatters.formatNumber(dtQd / 1000000, 0) + " tr";
            if (tag === '%HT_DTQD') return formatters.formatPercentage(phanTramHTQD);

            if (tag === 'TLQD') {
                if (sectionId === 'luyke') {
                    const pasteEl = document.getElementById('paste-luyke');
                    const pastedLuyKeData = dataProcessing.parseLuyKePastedData(pasteEl?.value || '');
                    if (pastedLuyKeData.mainKpis && pastedLuyKeData.mainKpis['Th·ª±c hi·ªán DT th·ª±c'] && pastedLuyKeData.mainKpis['Th·ª±c hi·ªán DTQƒê']) {
                        const dtThucPasted = parseFloat(String(pastedLuyKeData.mainKpis['Th·ª±c hi·ªán DT th·ª±c']).replace(/,/g, ''));
                        const dtQdPasted = parseFloat(String(pastedLuyKeData.mainKpis['Th·ª±c hi·ªán DTQƒê']).replace(/,/g, ''));
                        if (dtThucPasted > 0) {
                            return formatters.formatPercentage((dtQdPasted / dtThucPasted) - 1);
                        }
                    }
                }
                return formatters.formatPercentage(supermarketReport.hieuQuaQuyDoi || 0);
            }

            if (tag === '%HT_DTT') {
                const target = parseFloat(goals.doanhThuThuc) || 0;
                const percent = target > 0 ? (dtThuc / 1000000) / target : 0;
                return formatters.formatPercentage(percent);
            }
            if (tag === 'DT_CHUAXUAT') return formatters.formatRevenue(supermarketReport.doanhThuQuyDoiChuaXuat || 0) + " tr";
            if (tag === 'SS_CUNGKY') return supermarketReport.comparisonData?.percentage || 'N/A';

            if (tag.startsWith('TD_')) {
                const total = competitionData?.length || 0;
                const dat = (competitionData || []).filter(d => parseFloat(String(d.hoanThanh).replace('%','')) >= 100).length;
                if (tag === 'TD_TONG_CT') return total;
                if (tag === 'TD_CT_DAT') return dat;
                if (tag === 'TD_CT_CHUADAT') return total - dat;
                if (tag === 'TD_TYLE_DAT') return total > 0 ? formatters.formatPercentage(dat / total) : '0%';
            }

            if (tag === 'TOP_QDC_INFO') {
                if (!supermarketReport.qdc) return " (kh√¥ng c√≥)";
                const qdcArray = Object.values(supermarketReport.qdc).filter(item => item.sl > 0);
                const sortedQDC = qdcArray.sort((a,b) => b.dtqd - a.dtqd);
                return "\n" + sortedQDC.map(item => `  ‚Ä¢ ${item.name}: SL ${formatters.formatNumber(item.sl)}, TB ${formatters.formatNumber(item.sl / currentDay, 1)}/ng√†y`).join("\n");
            }
            if (tag === 'TOP_NGANHHANG_SL') {
                if (!supermarketReport.nganhHangChiTiet) return " (kh√¥ng c√≥)";
                const nganhHangArray = Object.values(supermarketReport.nganhHangChiTiet).filter(item => item.quantity > 0);
                const topNganhHang = nganhHangArray.sort((a,b) => b.quantity - a.quantity).slice(0, 10);
                return "\n" + topNganhHang.map(item => `  ‚Ä¢ ${utils.cleanCategoryName(item.name)}: ${formatters.formatNumber(item.quantity)}`).join("\n");
            }

            const rankingRegex = /^(TOP|BOT)(\d)_(\w+)_([\s\S]+)$/;
            const rankingMatch = tag.match(rankingRegex);
            if (rankingMatch && rankingReportData) {
                const [_, type, count, metric, department] = rankingMatch;
                const cleanDepartment = department.replace(/@msnv$/, '').trim();
                const direction = type === 'TOP' ? 'desc' : 'asc';
                const metricInfo = tagMapping[metric];
                if (metricInfo) {
                    let dataForRanking = rankingReportData;
                    // N·∫øu l√† thu nh·∫≠p, l·∫•y t·ª´ masterReportData ƒë·ªÉ c√≥ ƒë·ªß d·ªØ li·ªáu
                    if (metric === 'THUNHAP') {
                         const masterData = get(masterReportData);
                         if (masterData && masterData.sknv.length > 0) {
                            dataForRanking = masterData.sknv;
                         }
                    }
                    const ranking = composerServices.getEmployeeRanking(dataForRanking, metricInfo.key, direction, parseInt(count), cleanDepartment);
                    return composerServices.formatEmployeeList(ranking, metricInfo.key, metricInfo.format);
                }
            }

            const botTargetRegex = /^BOT_TARGET_(\w+)_([\s\S]+)$/;
            const botTargetMatch = tag.match(botTargetRegex);
            if(botTargetMatch && rankingReportData) {
                let [_, metric, department] = botTargetMatch;
                department = department.replace(/@msnv$/, '').trim();
                const metricInfo = botTargetMapping[metric];
                if (metricInfo) {
                    const employeeList = composerServices.getEmployeesBelowTarget(rankingReportData, metricInfo.dataKey, metricInfo.goalKey, department);
                    return composerServices.formatEmployeeList(employeeList, metricInfo.dataKey, metricInfo.format);
                }
            }

            const qdcInfoRegex = /^QDC_INFO_(.+)$/;
            const qdcMatch = tag.match(qdcInfoRegex);
            if(qdcMatch && supermarketReport.qdc){
                const itemName = qdcMatch[1];
                const itemData = Object.values(supermarketReport.qdc).find(i => i.name === itemName);
                return itemData ? `SL ${formatters.formatNumber(itemData.sl)}, TB ${formatters.formatNumber(itemData.sl / currentDay, 1)}/ng√†y` : '(N/A)';
            }

            const nhInfoRegex = /^NH_INFO_(.+)$/;
            const nhMatch = tag.match(nhInfoRegex);
            if(nhMatch && supermarketReport.nganhHangChiTiet){
                const itemName = nhMatch[1];
                 const itemData = Object.values(supermarketReport.nganhHangChiTiet).find(i => utils.cleanCategoryName(i.name) === itemName);
                return itemData ? `SL ${formatters.formatNumber(itemData.quantity)}, TB ${formatters.formatNumber(itemData.quantity / currentDay, 1)}/ng√†y` : '(N/A)';
            }

            return match;
        });
    },
};

export const composerService = composerServices;
--- END FILE: ./src/services/composerService.js ---

--- START FILE: ./src/services/dataProcessing.js ---
// src/services/dataProcessing.js
// Version 3.0 - Modular Facade
// File n√†y ƒë√≥ng vai tr√≤ t·∫≠p h·ª£p c√°c h√†m t·ª´ th∆∞ m·ª•c processing/
// Gi√∫p gi·ªØ nguy√™n API c≈© ƒë·ªÉ kh√¥ng l√†m h·ªèng c√°c component ƒëang s·ª≠ d·ª•ng.

import { helpers } from './processing/helpers.js';
import { normalizers } from './processing/normalizers.js';
import { parsers } from './processing/parsers.js';
import { processors } from './processing/processors.js';

export const dataProcessing = {
    // --- Helpers ---
    findColumnName: helpers.findColumnName,
    getHinhThucXuatTinhDoanhThu: helpers.getHinhThucXuatTinhDoanhThu,
    getHinhThucXuatTraGop: helpers.getHinhThucXuatTraGop,
    getHeSoQuyDoi: helpers.getHeSoQuyDoi,
    _cleanCompetitionName: helpers.cleanCompetitionName,
    classifyInsurance: helpers.classifyInsurance,
    _findHeaderAndProcess: helpers.findHeaderAndProcess, // Public alias cho processors d√πng

    // --- Normalizers ---
    normalizeData: normalizers.normalizeData,
    normalizeCategoryStructureData: normalizers.normalizeCategoryStructureData,
    normalizeSpecialProductData: normalizers.normalizeSpecialProductData,
    normalizeBrandData: normalizers.normalizeBrandData,

    // --- Parsers ---
    processThuongERP: parsers.processThuongERP,
    parseLuyKePastedData: parsers.parseLuyKePastedData,
    parseCompetitionDataFromLuyKe: parsers.parseCompetitionDataFromLuyKe,
    parsePastedThiDuaTableData: parsers.parsePastedThiDuaTableData,

    // --- Processors ---
    debugCompetitionFiltering: processors.debugCompetitionFiltering,
    updateCompetitionNameMappings: processors.updateCompetitionNameMappings,
    processThiDuaNhanVienData: processors.processThiDuaNhanVienData,
    processGioCongData: processors.processGioCongData,
    processThiDuaVungFile: processors.processThiDuaVungFile
};
--- END FILE: ./src/services/dataProcessing.js ---

--- START FILE: ./src/services/dataService.js ---
// src/services/dataService.js
import { fileHandler } from './data/fileHandler.js';
import { pasteHandler } from './data/pasteHandler.js';
import { syncHandler } from './data/syncHandler.js';
import { cacheHandler } from './data/cacheHandler.js';

export const dataService = {
    appController: null,
    init(controller) { this.appController = controller; },

    // --- File Handlers ---
    // [FIX] S·ª≠ d·ª•ng arrow function ƒë·ªÉ wrap, tr√°nh l·ªói undefined khi kh·ªüi t·∫°o module
    handleFileChange: (file, key) => fileHandler.handleFileChange(file, key),
    handleRealtimeFileInput: (event) => fileHandler.handleRealtimeFileInput(event),
    handleCategoryFile: (event) => fileHandler.handleCategoryFile(event),
    handleSpecialProductFileUpload: (event) => fileHandler.handleSpecialProductFileUpload(event),
    handleTemplateDownload: () => fileHandler.handleTemplateDownload(),

    // --- Paste Handlers ---
    handlePasteChange: (text, key1, key2, key3) => pasteHandler.handlePasteChange(text, key1, key2, key3),

    // --- Sync & Cache ---
    syncDownFromCloud: (wh) => syncHandler.syncDownFromCloud(wh),
    downloadFileFromCloud: (key) => syncHandler.downloadFileFromCloud(key),
    loadAllFromCache: () => cacheHandler.loadAllFromCache(),

    _getSavedMetadata(warehouse, dataType) { return null; }
};
--- END FILE: ./src/services/dataService.js ---

--- START FILE: ./src/services/datasync.service.js ---
// src/services/datasync.service.js
import { doc, setDoc, getDoc, serverTimestamp } from "firebase/firestore"; 
import { firebaseStore, currentUser } from '../stores.js'; 
import { get } from 'svelte/store';

const getDB = () => {
    const fb = get(firebaseStore);
    return fb.db;
};

const getCurrentUserEmail = () => {
    const user = get(currentUser);
    return user ? user.email : 'unknown';
};

export const datasyncService = {
    // --- M·ª§C TI√äU (GOALS) ---
    // L∆∞u c·∫•u h√¨nh m·ª•c ti√™u (L≈©y k·∫ø + Realtime) cho kho
    async saveGoalSettings(kho, type, settings) {
        const db = getDB();
        if (!db || !kho) return;

        // type: 'luyke' ho·∫∑c 'realtime'
        const fieldName = type === 'luyke' ? 'luykeGoals' : 'realtimeGoals';

        const khoRef = doc(db, "warehouseData", kho);
        try {
            await setDoc(khoRef, {
                [fieldName]: settings,
                [`${fieldName}UpdatedAt`]: serverTimestamp(),
                [`${fieldName}UpdatedBy`]: getCurrentUserEmail()
            }, { merge: true });
            console.log(`[DataSync] ƒê√£ l∆∞u m·ª•c ti√™u ${type} cho kho ${kho}`);
        } catch (error) {
            console.error(`[DataSync] L·ªói l∆∞u m·ª•c ti√™u ${type}:`, error);
        }
    },

    // T·∫£i c·∫•u h√¨nh m·ª•c ti√™u
    async loadGoalSettings(kho) {
        const db = getDB();
        if (!db || !kho) return { luyke: {}, realtime: {} };

        const khoRef = doc(db, "warehouseData", kho);
        try {
            const docSnap = await getDoc(khoRef);
            if (docSnap.exists()) {
                const data = docSnap.data();
                return {
                    luyke: data.luykeGoals || {},
                    realtime: data.realtimeGoals || {}
                };
            }
            return { luyke: {}, realtime: {} };
        } catch (e) {
            console.error("[DataSync] L·ªói t·∫£i m·ª•c ti√™u:", e);
            return { luyke: {}, realtime: {} };
        }
    },

    // --- C√ÅC H√ÄM KH√ÅC (GI·ªÆ NGUY√äN) ---
    async saveQdcConfig(kho, config) {
        const db = getDB();
        if (!db || !kho) return;
        const khoRef = doc(db, "warehouseData", kho);
        try {
            await setDoc(khoRef, {
                qdcConfig: config,
                qdcConfigUpdatedAt: serverTimestamp(),
                qdcConfigUpdatedBy: getCurrentUserEmail()
            }, { merge: true });
        } catch (error) { console.error(error); }
    },

    async loadQdcConfig(kho) {
        const db = getDB();
        if (!db || !kho) return null;
        const khoRef = doc(db, "warehouseData", kho);
        try {
            const docSnap = await getDoc(khoRef);
            return (docSnap.exists() && docSnap.data().qdcConfig) ? docSnap.data().qdcConfig : null;
        } catch (e) { return null; }
    },

    async saveRealtimeHiddenCategories(kho, hiddenList) {
        const db = getDB();
        if (!db || !kho) return;
        const khoRef = doc(db, "warehouseData", kho);
        try {
            await setDoc(khoRef, {
                realtimeConfig: { hiddenCategories: hiddenList, updatedAt: serverTimestamp(), updatedBy: getCurrentUserEmail() }
            }, { merge: true });
        } catch (error) { console.error(error); }
    },

    async loadRealtimeHiddenCategories(kho) {
        const db = getDB();
        if (!db || !kho) return [];
        const khoRef = doc(db, "warehouseData", kho);
        try {
            const docSnap = await getDoc(khoRef);
            return (docSnap.exists() && docSnap.data().realtimeConfig) ? docSnap.data().realtimeConfig.hiddenCategories || [] : [];
        } catch (e) { return []; }
    },

    async savePersonalRevenueTables(kho, tables) {
        const db = getDB();
        if (!db || !kho) return;
        const personalTables = tables.filter(t => !t.isSystem);
        const khoRef = doc(db, "warehouseData", kho);
        try { await setDoc(khoRef, { personalRevenueTables: personalTables, updatedAt: serverTimestamp() }, { merge: true }); } catch (error) { throw error; }
    },

    async loadPersonalRevenueTables(kho) {
        const db = getDB();
        if (!db || !kho) return [];
        const khoRef = doc(db, "warehouseData", kho);
        try { const docSnap = await getDoc(khoRef); return docSnap.exists() ? (docSnap.data().personalRevenueTables || []) : []; } catch(e) { return []; }
    },

    async saveCustomMetrics(kho, metrics) {
        const db = getDB();
        if (!db || !kho) return;
        const khoRef = doc(db, "warehouseData", kho);
        try { await setDoc(khoRef, { customMetrics: metrics, updatedAt: serverTimestamp() }, { merge: true }); } catch (error) { throw error; }
    },

    async loadCustomMetrics(kho) {
        const db = getDB();
        if (!db || !kho) return [];
        const khoRef = doc(db, "warehouseData", kho);
        try { const docSnap = await getDoc(khoRef); return docSnap.exists() ? (docSnap.data().customMetrics || []) : []; } catch(e) { return []; }
    },

    async saveMetadataToFirestore(kho, dataType, metadata) {
        const db = getDB();
        if (!db || !kho) throw new Error("Invalid parameters.");
        const khoRef = doc(db, "warehouseData", kho);
        const dataToSave = { [dataType]: { ...metadata, updatedAt: serverTimestamp(), updatedBy: getCurrentUserEmail() } };
        try { await setDoc(khoRef, dataToSave, { merge: true }); } catch(e) { throw e; }
    },

    async savePastedDataToFirestore(kho, dataType, content, versionInfo) {
        const db = getDB();
        if (!db || !kho) throw new Error("Invalid parameters.");
        const khoRef = doc(db, "warehouseData", kho);
        const dataToSave = { [dataType]: { content, ...versionInfo, updatedAt: serverTimestamp(), updatedBy: getCurrentUserEmail() } };
        try { await setDoc(khoRef, dataToSave, { merge: true }); } catch(e) { throw e; }
    },

    async saveCompetitionConfigs(kho, configs) {
        const db = getDB();
        if (!db || !kho) return;
        const khoRef = doc(db, "warehouseData", kho);
        try { await setDoc(khoRef, { competitionConfigs: configs, updatedAt: serverTimestamp() }, { merge: true }); } catch (error) { throw error; }
    },

    async loadCompetitionConfigs(kho) {
        const db = getDB();
        if (!db || !kho) return [];
        const khoRef = doc(db, "warehouseData", kho);
        try { const docSnap = await getDoc(khoRef); return docSnap.exists() ? (docSnap.data().competitionConfigs || []) : []; } catch(e) { return []; }
    },

    async saveSpecialPrograms(kho, programs) {
        const db = getDB();
        if (!db || !kho) return;
        const khoRef = doc(db, "warehouseData", kho);
        try { await setDoc(khoRef, { specialPrograms: programs, updatedAt: serverTimestamp() }, { merge: true }); } catch (error) { throw error; }
    },

    async saveWarehouseMetadata(kho, key, metadata) {
        const db = getDB();
        if (!db || !kho) return;
        const khoRef = doc(db, "warehouseData", kho);
        const dataToSave = { [key]: { ...metadata, updatedAt: serverTimestamp(), updatedBy: getCurrentUserEmail() } };
        try { await setDoc(khoRef, dataToSave, { merge: true }); } catch (error) { throw error; }
    },

    async loadWarehouseData(kho) {
        const db = getDB();
        if (!db || !kho) return null;
        const khoRef = doc(db, "warehouseData", kho);
        try { const docSnap = await getDoc(khoRef); return docSnap.exists() ? docSnap.data() : null; } catch (error) { throw error; }
    }
};
--- END FILE: ./src/services/datasync.service.js ---

--- START FILE: ./src/services/employeeService.js ---
// src/services/employeeService.js
// Version 1.1 - Fix Warehouse Selector auto-reset bug on F5
// M·ª§C ƒê√çCH: Ch·ªâ qu·∫£n l√Ω state c·ªßa nh√¢n vi√™n v√† kho.
import { get } from 'svelte/store';
import {
    danhSachNhanVien,
    employeeMaNVMap,
    employeeNameToMaNVMap,
    warehouseList,
    selectedWarehouse
} from '../stores.js';

/**
 * Logic "T·ª± ƒë·ªông l·∫Øng nghe".
 * T·ª± ƒë·ªông ch·∫°y m·ªói khi store 'danhSachNhanVien' b·ªã thay ƒë·ªïi.
 */
danhSachNhanVien.subscribe($danhSachNhanVien => {
    const newMaNVMap = new Map();
    const newNameMap = new Map();
    const newWarehouseList = new Set(); 

    if (!$danhSachNhanVien || $danhSachNhanVien.length === 0) {
        console.warn("[EmployeeService] DSNV r·ªóng, kh√¥ng th·ªÉ t·∫°o maps v√† danh s√°ch kho.");
    } else {
        $danhSachNhanVien.forEach(nv => {
            if (nv.maNV) newMaNVMap.set(String(nv.maNV).trim(), nv);
            if (nv.hoTen) newNameMap.set(nv.hoTen.toLowerCase().replace(/\s+/g, ' '), String(nv.maNV).trim());
            if (nv.maKho) newWarehouseList.add(String(nv.maKho).trim());
        });
  
        console.log(`[EmployeeService] ƒê√£ t·ª± ƒë·ªông c·∫≠p nh·∫≠t Employee Maps: ${newMaNVMap.size} MSNV, ${newNameMap.size} T√™n.`);
    }

    // C·∫≠p nh·∫≠t c√°c stores
    employeeMaNVMap.set(newMaNVMap);
    employeeNameToMaNVMap.set(newNameMap);
    
    const sortedWarehouses = [...newWarehouseList].sort();
    warehouseList.set(sortedWarehouses);
    
    // T·ª± ƒë·ªông ch·ªçn kho ƒë√£ l∆∞u
    const savedWarehouse = localStorage.getItem('selectedWarehouse');
    const currentSelected = get(selectedWarehouse);

    if (savedWarehouse && newWarehouseList.has(savedWarehouse)) {
        // Tr∆∞·ªùng h·ª£p 1: C√≥ kho l∆∞u trong LocalStorage v√† n√≥ h·ª£p l·ªá trong danh s√°ch m·ªõi
        if (currentSelected !== savedWarehouse) {
            selectedWarehouse.set(savedWarehouse);
            console.log(`[EmployeeService] ƒê√£ t·ª± ƒë·ªông ch·ªçn kho ƒë√£ l∆∞u: ${savedWarehouse}`);
        }
    } else if (currentSelected) {
        // Tr∆∞·ªùng h·ª£p 2: ƒêang c√≥ kho ƒë∆∞·ª£c ch·ªçn trong Store
        // [FIX] Ch·ªâ reset n·∫øu danh s√°ch kho M·ªöI c√≥ d·ªØ li·ªáu (ƒë√£ t·∫£i xong) nh∆∞ng kh√¥ng ch·ª©a kho hi·ªán t·∫°i.
        // N·∫øu danh s√°ch r·ªóng (ƒëang t·∫£i), GI·ªÆ NGUY√äN ƒë·ªÉ tr√°nh reset nh·∫ßm khi F5.
        if (newWarehouseList.size > 0 && !newWarehouseList.has(currentSelected)) {
            selectedWarehouse.set(null);
            localStorage.removeItem('selectedWarehouse');
            console.warn(`[EmployeeService] Kho ƒë√£ ch·ªçn (${currentSelected}) kh√¥ng c√≤n t·ªìn t·∫°i trong danh s√°ch m·ªõi. ƒê√£ reset.`);
        } else {
             console.log(`[EmployeeService] Gi·ªØ nguy√™n kho ${currentSelected} (Danh s√°ch kho ƒëang t·∫£i ho·∫∑c kho h·ª£p l·ªá).`);
        }
    }
});
--- END FILE: ./src/services/employeeService.js ---

--- START FILE: ./src/services/excel.service.js ---
/* global XLSX */
import { notificationStore } from '../stores.js'; // [FIX] D√πng Store thay v√¨ file l·∫ª

export const excelService = {
    /**
     * Xu·∫•t b·∫£ng HTML ra file Excel
     * @param {HTMLElement} tableElement - Element b·∫£ng ho·∫∑c container ch·ª©a b·∫£ng
     * @param {string} fileName - T√™n file mu·ªën l∆∞u
     */
    exportTableToExcel(tableElement, fileName) {
        if (!tableElement) {
            notificationStore.show('Kh√¥ng t√¨m th·∫•y n·ªôi dung ƒë·ªÉ xu·∫•t.', 'error'); // [FIX]
            return;
        }

        // T√¨m th·∫ª table b√™n trong n·∫øu element truy·ªÅn v√†o l√† container
        let table = tableElement.tagName === 'TABLE' 
            ? tableElement 
            : tableElement.querySelector('table');

        if (!table) {
            table = tableElement.querySelector('.department-block table, #sknv-summary-container table, #luyke-competition-content table');
        }

        if (!table) {
            notificationStore.show('Kh√¥ng t√¨m th·∫•y b·∫£ng d·ªØ li·ªáu trong khu v·ª±c n√†y ƒë·ªÉ xu·∫•t.', 'error'); // [FIX]
            return;
        }

        try {
            const wb = XLSX.utils.table_to_book(table, { sheet: "Sheet1" });
            XLSX.writeFile(wb, `${fileName}.xlsx`);
            notificationStore.show(`ƒê√£ xu·∫•t file ${fileName}.xlsx th√†nh c√¥ng!`, 'success'); // [FIX]
        } catch (e) {
            console.error('[ExcelService] L·ªói xu·∫•t Excel:', e);
            notificationStore.show('C√≥ l·ªói x·∫£y ra khi xu·∫•t file Excel.', 'error'); // [FIX]
        }
    }
};
--- END FILE: ./src/services/excel.service.js ---

--- START FILE: ./src/services/firebase.service.js ---
// src/services/firebase.service.js
// Version 3.0 - Switch to Legacy Firebase Project (qlst-9e6bd)
import { initializeApp } from "firebase/app";
import { getAuth } from "firebase/auth";
import { getFirestore } from "firebase/firestore";
import { getStorage } from "firebase/storage";
import { firebaseStore } from '../stores.js';

// Config t·ª´ d·ª± √°n g·ªëc "qlst-9e6bd"
const firebaseConfig = {
  apiKey: "AIzaSyAQ3TWcpa4AnTN-32igGseYDlXrCf1BVew",
  authDomain: "qlst-9e6bd.firebaseapp.com",
  projectId: "qlst-9e6bd",
  storageBucket: "qlst-9e6bd.firebasestorage.app",
  messagingSenderId: "2316705291",
  appId: "1:2316705291:web:ebec2963816aea7585b10e",
  measurementId: "G-M0SM0XHCEK"
};

export const firebaseService = {
    initCore() {
        try {
            console.log("[FirebaseService] Initializing Legacy Firebase (qlst-9e6bd)...");
            const app = initializeApp(firebaseConfig);
            const auth = getAuth(app);
            const db = getFirestore(app);
            const storage = getStorage(app);

            // C·∫≠p nh·∫≠t store ƒë·ªÉ c√°c service kh√°c s·ª≠ d·ª•ng
            firebaseStore.set({
                app,
                auth,
                db,
                storage
            });

            console.log("[FirebaseService] Firebase initialized successfully!");
            return { app, auth, db, storage };
        } catch (error) {
            console.error("[FirebaseService] Initialization failed:", error);
            return null;
        }
    }
};
--- END FILE: ./src/services/firebase.service.js ---

--- START FILE: ./src/services/modal.service.js ---
// Version 1.0 - Initial Svelte refactor
// MODULE: UI MODAL MANAGER
// Ch·ª©a c√°c h√†m thu·∫ßn t√∫y ƒë·ªÉ qu·∫£n l√Ω tr·∫°ng th√°i hi·ªÉn th·ªã c·ªßa Modals v√† Drawers.
// T√°i c·∫•u tr√∫c t·ª´ file ui-modal-manager.js g·ªëc

export const modalManager = {
    /**
     * B·∫≠t ho·∫∑c t·∫Øt m·ªôt modal.
     * @param {string} modalId - ID c·ªßa modal (v√≠ d·ª•: 'login-modal').
     * @param {boolean} show - True ƒë·ªÉ hi·ªán, false ƒë·ªÉ ·∫©n.
     */
    toggleModal(modalId, show) {
        const modal = document.getElementById(modalId);
        if (!modal) return;
        modal.classList.toggle('hidden', !show);
    },

    /**
     * B·∫≠t ho·∫∑c t·∫Øt m·ªôt drawer (thanh c√†i ƒë·∫∑t b√™n).
     * @param {string} drawerId - ID c·ªßa drawer (v√≠ d·ª•: 'interface-drawer').
     * @param {boolean} show - True ƒë·ªÉ hi·ªán, false ƒë·ªÉ ·∫©n.
     */
    toggleDrawer(drawerId, show) {
        const drawer = document.getElementById(drawerId);
        const sidebar = document.getElementById('sidebar');
        const overlay = document.getElementById('drawer-overlay');

        if (!drawer || !sidebar || !overlay) return;
        if (show) {
            drawer.classList.remove('hidden');
            setTimeout(() => {
                drawer.classList.add('open');
                 sidebar.classList.add('menu-locked');
                 overlay.classList.remove('hidden');
            }, 10);
        } else {
            drawer.classList.remove('open');
            sidebar.classList.remove('menu-locked');
            overlay.classList.add('hidden');
            setTimeout(() => {
                 if (!drawer.classList.contains('open')) {
                     drawer.classList.add('hidden');
                 }
             }, 300);
        }
    },

    /**
     * ƒê√≥ng t·∫•t c·∫£ c√°c drawer ƒëang m·ªü.
     */
    closeAllDrawers() {
        // Ch√∫ng ta g·ªçi h√†m `toggleDrawer` n·ªôi b·ªô
        this.toggleDrawer('interface-drawer', false);
        this.toggleDrawer('goal-drawer', false);
    },
};
--- END FILE: ./src/services/modal.service.js ---

--- START FILE: ./src/services/reportService.js ---
// src/services/reportService.js
// Version 3.0 - Modular Facade
// File n√†y ch·ªâ ƒë√≥ng vai tr√≤ ƒëi·ªÅu ph·ªëi, logic ƒë√£ ƒë∆∞·ª£c t√°ch ra th∆∞ m·ª•c reports/

import { masterReportLogic } from './reports/master.report.js';
import { competitionReportLogic } from './reports/competition.report.js';
import { detailReportLogic } from './reports/detail.report.js';
import { generalReportLogic } from './reports/general.report.js';

export const reportService = {
    ...masterReportLogic,
    ...competitionReportLogic,
    ...detailReportLogic,
    ...generalReportLogic
};
--- END FILE: ./src/services/reportService.js ---

--- START FILE: ./src/services/settings.service.js ---
// src/services/settings.service.js
import { get } from 'svelte/store';
import { 
    luykeGoalSettings, 
    realtimeGoalSettings, 
    interfaceSettings,
    pastedThiDuaReportData
} from '../stores.js';
import { datasyncService } from './datasync.service.js'; // [M·ªöI] Import

// ... (Gi·ªØ nguy√™n c√°c h·∫±ng s·ªë ALL_EFFICIENCY_ITEMS, PASTED_COMPETITION_SETTINGS_KEY) ...
const ALL_EFFICIENCY_ITEMS = [
    { id: 'dtICT', label: 'DT ICT' },
    { id: 'dtPhuKien', label: 'DT Ph·ª• ki·ªán' },
    { id: 'pctPhuKien', label: '% Ph·ª• ki·ªán' },
    { id: 'dtCE', label: 'DT CE' },
    { id: 'dtGiaDung', label: 'DT Gia d·ª•ng' },
    { id: 'pctGiaDung', label: '% Gia d·ª•ng' },
    { id: 'pctMLN',    label: '% M√°y l·ªçc n∆∞·ªõc' }, 
    { id: 'pctSim',    label: '% Sim' },
    { id: 'pctVAS',    label: '% VAS' },
    { id: 'pctBaoHiem', label: '% B·∫£o hi·ªÉm' }
];
const PASTED_COMPETITION_SETTINGS_KEY = 'pastedCompetitionViewSettings';

export const settingsService = {
    // --- INTERFACE SETTINGS ---
    loadInterfaceSettings() {
        try {
            const saved = localStorage.getItem('interfaceSettings');
            if (saved) {
                const parsed = JSON.parse(saved);
                interfaceSettings.set({ ...get(interfaceSettings), ...parsed });
            }
            this.applyInterfaceStyles(get(interfaceSettings));
            const contrast = localStorage.getItem('contrastLevel') || '3';
            this.updateContrast(contrast);
        } catch (e) { console.error(e); }
    },

    updateInterface(newSettings) {
        interfaceSettings.set(newSettings);
        localStorage.setItem('interfaceSettings', JSON.stringify(newSettings));
        this.applyInterfaceStyles(newSettings);
    },

    updateContrast(level) {
        document.documentElement.dataset.contrast = level;
        localStorage.setItem('contrastLevel', level);
        interfaceSettings.update(s => ({ ...s, contrastLevel: level }));
    },

    applyInterfaceStyles(settings) {
        const root = document.documentElement;
        if (!settings) return;
        if (settings.globalFontSize) root.style.fontSize = `${settings.globalFontSize}px`;
        for (let i = 1; i <= 8; i++) {
            const key = `kpiCard${i}Bg`;
            if (settings[key]) root.style.setProperty(`--kpi-card-${i}-bg`, settings[key]);
        }
        if (settings.kpiTitleColor) root.style.setProperty('--kpi-title-color', settings.kpiTitleColor);
        if (settings.kpiMainColor) root.style.setProperty('--kpi-main-color', settings.kpiMainColor);
        if (settings.kpiSubColor) root.style.setProperty('--kpi-sub-color', settings.kpiSubColor);
        if (settings.kpiFontSize) root.style.setProperty('--kpi-main-font-size', `${settings.kpiFontSize}px`);
    },

    // --- GOAL SETTINGS (M·ª§C TI√äU) - C·∫¨P NH·∫¨T ƒê·ªÇ SYNC CLOUD ---
    
    // [M·ªöI] T·∫£i m·ª•c ti√™u t·ª´ Cloud
    async loadGoalsFromCloud(warehouse) {
        if (!warehouse) return;
        const data = await datasyncService.loadGoalSettings(warehouse);
        
        // C·∫≠p nh·∫≠t store L≈©y k·∫ø
        luykeGoalSettings.update(current => ({
            ...current,
            [warehouse]: data.luyke || {}
        }));

        // C·∫≠p nh·∫≠t store Realtime
        realtimeGoalSettings.update(current => ({
            ...current,
            [warehouse]: data.realtime || { goals: {}, timing: {} }
        }));
    },

    saveLuykeGoalForWarehouse(warehouse, goals) {
        luykeGoalSettings.update(current => {
            const updated = { ...current, [warehouse]: goals };
            // V·∫´n l∆∞u local ƒë·ªÉ backup
            localStorage.setItem('luykeGoalSettings', JSON.stringify(updated)); 
            return updated;
        });
        // [M·ªöI] L∆∞u l√™n Cloud
        datasyncService.saveGoalSettings(warehouse, 'luyke', goals);
    },

    getLuykeGoalSettings(selectedWarehouse = null) {
        const $luykeGoalSettings = get(luykeGoalSettings);
        const settings = { goals: {} };
        const goalKeys = ['doanhThuThuc', 'doanhThuQD', 'phanTramQD', 'phanTramTC', 'phanTramGiaDung', 'phanTramMLN', 'phanTramPhuKien', 'phanTramBaoHiem', 'phanTramSim', 'phanTramVAS'];

        if (selectedWarehouse && $luykeGoalSettings[selectedWarehouse]) {
             const source = $luykeGoalSettings[selectedWarehouse];
             // [FIX] Copy ƒë·ªông t·∫•t c·∫£ c√°c key (ƒë·ªÉ h·ªó tr·ª£ Dynamic Metrics t·ª´ Admin)
             Object.assign(settings.goals, source);
        } else if (!selectedWarehouse) {
             // Logic trung b√¨nh (gi·ªØ nguy√™n n·∫øu c·∫ßn, ho·∫∑c ƒë∆°n gi·∫£n h√≥a)
             return settings;
        }
        return settings;
    },

    saveRealtimeGoalForWarehouse(warehouse, settings) {
        realtimeGoalSettings.update(current => {
            const updated = { ...current, [warehouse]: settings };
            localStorage.setItem('realtimeGoalSettings', JSON.stringify(updated));
            return updated;
        });
        // [M·ªöI] L∆∞u l√™n Cloud
        datasyncService.saveGoalSettings(warehouse, 'realtime', settings);
    },

    getRealtimeGoalSettings(selectedWarehouse = null) {
        const $realtimeGoalSettings = get(realtimeGoalSettings);
        if (selectedWarehouse && $realtimeGoalSettings && $realtimeGoalSettings[selectedWarehouse]) {
            return $realtimeGoalSettings[selectedWarehouse];
        }
        return { goals: {}, timing: {} };
    },

    // --- VIEW SETTINGS (GI·ªÆ NGUY√äN) ---
    saveEfficiencyViewSettings(settings) {
        if (!Array.isArray(settings)) return;
        try { localStorage.setItem('efficiencyViewSettings', JSON.stringify(settings)); } catch (e) {}
    },
    loadEfficiencyViewSettings() {
        try {
            const savedSettingsJSON = localStorage.getItem('efficiencyViewSettings');
            if (savedSettingsJSON) {
                const savedItems = JSON.parse(savedSettingsJSON);
                if (Array.isArray(savedItems) && savedItems.length > 0) {
                    const savedIds = new Set(savedItems.map(s => s.id));
                    const newItems = ALL_EFFICIENCY_ITEMS
                        .filter(item => !savedIds.has(item.id))
                        .map(item => ({ ...item, visible: true }));
                    
                    const currentItems = savedItems
                        .filter(item => ALL_EFFICIENCY_ITEMS.some(config => config.id === item.id))
                        .map(item => {
                            const defaultItem = ALL_EFFICIENCY_ITEMS.find(d => d.id === item.id);
                             return defaultItem ? { ...item, label: defaultItem.label } : item;
                        });
                    return [...currentItems, ...newItems];
                }
            }
        } catch (e) {}
        return ALL_EFFICIENCY_ITEMS.map(item => ({ ...item, visible: true }));
    },
    saveQdcViewSettings(settings) {
        if (!Array.isArray(settings)) return;
        try { localStorage.setItem('qdcViewSettings', JSON.stringify(settings)); } catch (e) {}
    },
    saveCategoryViewSettings(settings) {
        if (!Array.isArray(settings)) return;
        try { localStorage.setItem('categoryViewSettings', JSON.stringify(settings)); } catch (e) {}
    },
    loadQdcViewSettings(allItems) {
        try {
            const saved = localStorage.getItem('qdcViewSettings');
            if (saved) return JSON.parse(saved);
        } catch (e) {}
        return allItems;
    },
    loadCategoryViewSettings(allItems) {
        try {
            const saved = localStorage.getItem('categoryViewSettings');
            if (saved) return JSON.parse(saved);
        } catch (e) {}
        return allItems;
    },
    savePastedCompetitionViewSettings(settings) {
        try { localStorage.setItem(PASTED_COMPETITION_SETTINGS_KEY, JSON.stringify(settings)); } catch (e) {}
    },
    loadPastedCompetitionViewSettings() {
        const pastedDataStoreValue = get(pastedThiDuaReportData);
        if (!pastedDataStoreValue || pastedDataStoreValue.length === 0) return [];
        
        const masterColumns = pastedDataStoreValue[0].competitions.map((comp, index) => ({
            id: `comp_${index}`,
            label: comp.tenNganhHang,
            tenGoc: comp.tenGoc,
            loaiSoLieu: comp.loaiSoLieu,
            visible: true
        }));
        const masterMap = new Map(masterColumns.map(item => [item.tenGoc, item]));

        let savedItems = [];
        try {
            savedItems = JSON.parse(localStorage.getItem(PASTED_COMPETITION_SETTINGS_KEY) || '[]');
        } catch (e) { savedItems = []; }

        const savedMap = new Map(savedItems.map(item => [item.tenGoc, item]));
        const finalSettings = [];
        
        savedItems.forEach(savedItem => {
            if (masterMap.has(savedItem.tenGoc)) {
                const masterItem = masterMap.get(savedItem.tenGoc);
                finalSettings.push({ ...savedItem, id: masterItem.id, label: masterItem.label });
            }
        });
        masterColumns.forEach(masterItem => {
            if (!savedMap.has(masterItem.tenGoc)) finalSettings.push(masterItem);
        });
        return finalSettings;
    }
};
--- END FILE: ./src/services/settings.service.js ---

--- START FILE: ./src/services/sknv.service.js ---
import { formatters } from '../utils/formatters.js';
import { cleanCategoryName } from '../utils.js';

export const sknvService = {
    calculateDepartmentAverages(departmentName, reportData) {
        const departmentEmployees = reportData.filter(e => e.boPhan === departmentName);
        if (departmentEmployees.length === 0) return {};

        const totals = departmentEmployees.reduce((acc, curr) => {
            Object.keys(curr).forEach(key => {
                if (typeof curr[key] === 'number') acc[key] = (acc[key] || 0) + curr[key];
            });
            if (curr.qdc) {
                if (!acc.qdc) acc.qdc = {};
                for (const k in curr.qdc) {
                    if (!acc.qdc[k]) acc.qdc[k] = { sl: 0, dt: 0, dtqd: 0 };
                    acc.qdc[k].sl += curr.qdc[k].sl;
                    acc.qdc[k].dt += curr.qdc[k].dt;
                    acc.qdc[k].dtqd += curr.qdc[k].dtqd;
                }
            }
            return acc;
        }, {});

        const averages = {};
        for (const key in totals) {
            if (key !== 'qdc') averages[key] = totals[key] / departmentEmployees.length;
            else {
                averages.qdc = {};
                for (const qdcKey in totals.qdc) averages.qdc[qdcKey] = {
                    sl: totals.qdc[qdcKey].sl / departmentEmployees.length,
                    dt: totals.qdc[qdcKey].dt / departmentEmployees.length,
                    dtqd: totals.qdc[qdcKey].dtqd / departmentEmployees.length
                };
            }
        }
        return averages;
    },

    evaluateEmployee(employee, departmentAverages) {
        const counts = {
            doanhthu: { above: 0, total: 7 },
            nangsuat: { above: 0, total: 7 },
            hieuqua: { above: 0, total: 6 },
            dongia: { above: 0, total: 7 }
        };

        const check = (group, value, avg, higherIsBetter = true) => {
            if (!isFinite(value) || avg === undefined || !isFinite(avg)) return;
            if (higherIsBetter ? (value >= avg) : (value <= avg)) 
                counts[group].above++;
        };

        check('doanhthu', employee.doanhThu, departmentAverages.doanhThu);
        check('doanhthu', employee.doanhThuQuyDoi, departmentAverages.doanhThuQuyDoi);
        check('doanhthu', employee.hieuQuaQuyDoi, departmentAverages.hieuQuaQuyDoi);
        check('doanhthu', employee.dtCE, departmentAverages.dtCE);
        check('doanhthu', employee.dtICT, departmentAverages.dtICT);
        check('doanhthu', employee.doanhThuTraGop, departmentAverages.doanhThuTraGop);
        check('doanhthu', employee.tyLeTraCham, departmentAverages.tyLeTraCham);
        
        check('nangsuat', employee.tongThuNhap, departmentAverages.tongThuNhap);
        check('nangsuat', employee.thuNhapDuKien, departmentAverages.thuNhapDuKien);
        check('nangsuat', employee.gioCong, departmentAverages.gioCong);
        const tnTrenGc = employee.gioCong > 0 ? employee.tongThuNhap / employee.gioCong : 0;
        const avgTnTrenGc = departmentAverages.gioCong > 0 ? departmentAverages.tongThuNhap / departmentAverages.gioCong : 0;
        check('nangsuat', tnTrenGc, avgTnTrenGc);
        const dtqdTrenGc = employee.gioCong > 0 ? employee.doanhThuQuyDoi / employee.gioCong : 0;
        const avgDtqdTrenGc = departmentAverages.gioCong > 0 ? departmentAverages.doanhThuQuyDoi / departmentAverages.gioCong : 0;
        check('nangsuat', dtqdTrenGc, avgDtqdTrenGc);
        check('nangsuat', employee.thuongNong, departmentAverages.thuongNong);
        check('nangsuat', employee.thuongERP, departmentAverages.thuongERP);

        check('hieuqua', employee.pctPhuKien, departmentAverages.pctPhuKien);
        check('hieuqua', employee.pctGiaDung, departmentAverages.pctGiaDung);
        check('hieuqua', employee.pctMLN, departmentAverages.pctMLN);
        check('hieuqua', employee.pctSim, departmentAverages.pctSim);
        check('hieuqua', employee.pctVAS, departmentAverages.pctVAS);
        check('hieuqua', employee.pctBaoHiem, departmentAverages.pctBaoHiem);

        check('dongia', employee.donGiaTrungBinh, departmentAverages.donGiaTrungBinh);
        check('dongia', employee.donGiaTivi, departmentAverages.donGiaTivi);
        check('dongia', employee.donGiaTuLanh, departmentAverages.donGiaTuLanh);
        check('dongia', employee.donGiaMayGiat, departmentAverages.donGiaMayGiat);
        check('dongia', employee.donGiaMayLanh, departmentAverages.donGiaMayLanh);
        check('dongia', employee.donGiaDienThoai, departmentAverages.donGiaDienThoai);
        check('dongia', employee.donGiaLaptop, departmentAverages.donGiaLaptop);

        const totalAbove = Object.values(counts).reduce((sum, grp) => sum + grp.above, 0);
        const totalCriteria = Object.values(counts).reduce((sum, grp) => sum + grp.total, 0);

        return { ...employee, summary: counts, totalAbove, totalCriteria };
    },

    processReportData(rawReportData) {
        if (!rawReportData || rawReportData.length === 0) return [];
        return rawReportData.map(emp => {
            const deptAvg = this.calculateDepartmentAverages(emp.boPhan, rawReportData);
            return this.evaluateEmployee(emp, deptAvg);
        });
    },

    getDetailStats(employeeData, departmentAverages, customMetrics = []) {
        if (!employeeData || !departmentAverages) return {};

        const { mucTieu } = employeeData;
        const fmtRev = (val) => formatters.formatRevenue(val);
        const fmtNum = (val) => formatters.formatNumberOrDash(val);
        const fmtPct = (val) => formatters.formatPercentage(val);

        const doanhThu = [
            { id: 'dtThuc', label: 'Doanh thu th·ª±c', value: fmtRev(employeeData.doanhThu), average: fmtRev(departmentAverages.doanhThu), rawValue: employeeData.doanhThu, rawAverage: departmentAverages.doanhThu },
            { id: 'dtQD', label: 'Doanh thu Qƒê', value: fmtRev(employeeData.doanhThuQuyDoi), average: fmtRev(departmentAverages.doanhThuQuyDoi), rawValue: employeeData.doanhThuQuyDoi, rawAverage: departmentAverages.doanhThuQuyDoi },
            { id: 'pctQD', label: '% Quy ƒë·ªïi', value: fmtPct(employeeData.hieuQuaQuyDoi), valueClass: (mucTieu && employeeData.hieuQuaQuyDoi < (mucTieu.phanTramQD / 100)) ? 'text-red-600 bg-red-50' : '', average: fmtPct(departmentAverages.hieuQuaQuyDoi), rawValue: employeeData.hieuQuaQuyDoi, rawAverage: departmentAverages.hieuQuaQuyDoi },
            { id: 'dtCE', label: 'DT CE', value: fmtRev(employeeData.dtCE), average: fmtRev(departmentAverages.dtCE), rawValue: employeeData.dtCE, rawAverage: departmentAverages.dtCE },
            { id: 'dtICT', label: 'DT ICT', value: fmtRev(employeeData.dtICT), average: fmtRev(departmentAverages.dtICT), rawValue: employeeData.dtICT, rawAverage: departmentAverages.dtICT },
            { id: 'dtTraCham', label: 'DT Tr·∫£ ch·∫≠m', value: fmtRev(employeeData.doanhThuTraGop), average: fmtRev(departmentAverages.doanhThuTraGop), rawValue: employeeData.doanhThuTraGop, rawAverage: departmentAverages.doanhThuTraGop },
            { id: 'pctTraCham', label: '% Tr·∫£ ch·∫≠m', value: fmtPct(employeeData.tyLeTraCham), valueClass: (mucTieu && employeeData.tyLeTraCham < (mucTieu.phanTramTC / 100)) ? 'text-red-600 bg-red-50' : '', average: fmtPct(departmentAverages.tyLeTraCham), rawValue: employeeData.tyLeTraCham, rawAverage: departmentAverages.tyLeTraCham }
        ];

        const nangSuat = [
            { id: 'thuongNong', label: 'Th∆∞·ªüng n√≥ng', value: fmtRev(employeeData.thuongNong), average: fmtRev(departmentAverages.thuongNong), rawValue: employeeData.thuongNong, rawAverage: departmentAverages.thuongNong },
            { id: 'thuongERP', label: 'Th∆∞·ªüng ERP', value: fmtRev(employeeData.thuongERP), average: fmtRev(departmentAverages.thuongERP), rawValue: employeeData.thuongERP, rawAverage: departmentAverages.thuongERP },
            { id: 'thuNhapLK', label: 'Thu nh·∫≠p LK', value: fmtRev(employeeData.tongThuNhap), average: fmtRev(departmentAverages.tongThuNhap), rawValue: employeeData.tongThuNhap, rawAverage: departmentAverages.tongThuNhap },
            { id: 'thuNhapDK', label: 'Thu nh·∫≠p DK', value: fmtRev(employeeData.thuNhapDuKien), average: fmtRev(departmentAverages.thuNhapDuKien), rawValue: employeeData.thuNhapDuKien, rawAverage: departmentAverages.thuNhapDuKien },
            { id: 'gioCong', label: 'Gi·ªù c√¥ng', value: fmtNum(employeeData.gioCong), average: fmtNum(departmentAverages.gioCong), rawValue: employeeData.gioCong, rawAverage: departmentAverages.gioCong },
            { id: 'tnTrenGc', label: 'TN/Gi·ªù c√¥ng', value: fmtNum(employeeData.gioCong > 0 ? employeeData.tongThuNhap / employeeData.gioCong : 0), average: fmtNum((departmentAverages.gioCong || 0) > 0 ? (departmentAverages.tongThuNhap || 0) / departmentAverages.gioCong : 0), rawValue: employeeData.gioCong > 0 ? employeeData.tongThuNhap / employeeData.gioCong : 0, rawAverage: (departmentAverages.gioCong || 0) > 0 ? (departmentAverages.tongThuNhap || 0) / departmentAverages.gioCong : 0 },
            { id: 'dtqdTrenGc', label: 'DTQƒê/Gi·ªù c√¥ng', value: fmtRev(employeeData.gioCong > 0 ? employeeData.doanhThuQuyDoi / employeeData.gioCong : 0), average: fmtRev((departmentAverages.gioCong || 0) > 0 ? (departmentAverages.doanhThuQuyDoi || 0) / departmentAverages.gioCong : 0), rawValue: employeeData.gioCong > 0 ? employeeData.doanhThuQuyDoi / employeeData.gioCong : 0, rawAverage: (departmentAverages.gioCong || 0) > 0 ? (departmentAverages.doanhThuQuyDoi || 0) / departmentAverages.gioCong : 0 }
        ];

        const hieuQua = [
            { id: 'pctPhuKien', label: '% PK', value: fmtPct(employeeData.pctPhuKien), valueClass: (mucTieu && employeeData.pctPhuKien < (mucTieu.phanTramPhuKien / 100)) ? 'text-red-600 bg-red-50' : '', average: fmtPct(departmentAverages.pctPhuKien), rawValue: employeeData.pctPhuKien, rawAverage: departmentAverages.pctPhuKien },
            { id: 'pctGiaDung', label: '% Gia d·ª•ng', value: fmtPct(employeeData.pctGiaDung), valueClass: (mucTieu && employeeData.pctGiaDung < (mucTieu.phanTramGiaDung / 100)) ? 'text-red-600 bg-red-50' : '', average: fmtPct(departmentAverages.pctGiaDung), rawValue: employeeData.pctGiaDung, rawAverage: departmentAverages.pctGiaDung },
            { id: 'pctMLN', label: '% MLN', value: fmtPct(employeeData.pctMLN), valueClass: (mucTieu && employeeData.pctMLN < (mucTieu.phanTramMLN / 100)) ? 'text-red-600 bg-red-50' : '', average: fmtPct(departmentAverages.pctMLN), rawValue: employeeData.pctMLN, rawAverage: departmentAverages.pctMLN },
            { id: 'pctSim', label: '% Sim', value: fmtPct(employeeData.pctSim), valueClass: (mucTieu && employeeData.pctSim < (mucTieu.phanTramSim / 100)) ? 'text-red-600 bg-red-50' : '', average: fmtPct(departmentAverages.pctSim), rawValue: employeeData.pctSim, rawAverage: departmentAverages.pctSim },
            { id: 'pctVAS', label: '% VAS', value: fmtPct(employeeData.pctVAS), valueClass: (mucTieu && employeeData.pctVAS < (mucTieu.phanTramVAS / 100)) ? 'text-red-600 bg-red-50' : '', average: fmtPct(departmentAverages.pctVAS), rawValue: employeeData.pctVAS, rawAverage: departmentAverages.pctVAS },
            { id: 'pctBaoHiem', label: '% B·∫£o hi·ªÉm', value: fmtPct(employeeData.pctBaoHiem), valueClass: (mucTieu && employeeData.pctBaoHiem < (mucTieu.phanTramBaoHiem / 100)) ? 'text-red-600 bg-red-50' : '', average: fmtPct(departmentAverages.pctBaoHiem), rawValue: employeeData.pctBaoHiem, rawAverage: departmentAverages.pctBaoHiem },
        ];

        const donGia = [
            { id: 'dgTB', label: 'ƒê∆°n gi√° TB', value: fmtRev(employeeData.donGiaTrungBinh), average: fmtRev(departmentAverages.donGiaTrungBinh), rawValue: employeeData.donGiaTrungBinh, rawAverage: departmentAverages.donGiaTrungBinh },
            { id: 'dgTivi', label: 'ƒê∆°n gi√° Tivi', value: fmtRev(employeeData.donGiaTivi), average: fmtRev(departmentAverages.donGiaTivi), rawValue: employeeData.donGiaTivi, rawAverage: departmentAverages.donGiaTivi },
            { id: 'dgTuLanh', label: 'ƒê∆°n gi√° T·ªß l·∫°nh', value: fmtRev(employeeData.donGiaTuLanh), average: fmtRev(departmentAverages.donGiaTuLanh), rawValue: employeeData.donGiaTuLanh, rawAverage: departmentAverages.donGiaTuLanh },
            { id: 'dgMayGiat', label: 'ƒê∆°n gi√° M√°y gi·∫∑t', value: fmtRev(employeeData.donGiaMayGiat), average: fmtRev(departmentAverages.donGiaMayGiat), rawValue: employeeData.donGiaMayGiat, rawAverage: departmentAverages.donGiaMayGiat },
            { id: 'dgMayLanh', label: 'ƒê∆°n gi√° M√°y l·∫°nh', value: fmtRev(employeeData.donGiaMayLanh), average: fmtRev(departmentAverages.donGiaMayLanh), rawValue: employeeData.donGiaMayLanh, rawAverage: departmentAverages.donGiaMayLanh },
            { id: 'dgDienThoai', label: 'ƒê∆°n gi√° ƒêi·ªán tho·∫°i', value: fmtRev(employeeData.donGiaDienThoai), average: fmtRev(departmentAverages.donGiaDienThoai), rawValue: employeeData.donGiaDienThoai, rawAverage: departmentAverages.donGiaDienThoai },
            { id: 'dgLaptop', label: 'ƒê∆°n gi√° Laptop', value: fmtRev(employeeData.donGiaLaptop), average: fmtRev(departmentAverages.donGiaLaptop), rawValue: employeeData.donGiaLaptop, rawAverage: departmentAverages.donGiaLaptop },
        ];

        if (customMetrics && customMetrics.length > 0) {
            customMetrics.forEach(metric => {
                const empVal = this.calculateDynamicMetricValue(employeeData, metric);
                const avgVal = departmentAverages[`custom_${metric.id}`] || 0; 

                const newItem = {
                    id: metric.id,
                    label: metric.label,
                    rawValue: empVal,
                    rawAverage: avgVal,
                    isCustom: true,
                    rawConfig: metric // [M·ªöI] L∆∞u config g·ªëc ƒë·ªÉ c√≥ th·ªÉ s·ª≠a/x√≥a
                };

                if (metric.type === 'UNIT_PRICE') {
                    newItem.value = fmtRev(empVal);
                    newItem.average = fmtRev(avgVal);
                    donGia.push(newItem);
                } else {
                    newItem.value = fmtPct(empVal);
                    newItem.average = fmtPct(avgVal);
                    newItem.valueClass = (metric.target && empVal < (metric.target / 100)) ? 'text-red-600 bg-red-50' : '';
                    hieuQua.push(newItem);
                }
            });
        }

        return { doanhThu, nangSuat, hieuQua, donGia };
    },

    calculateDynamicMetricValue(data, metricConfig) {
        const sumValues = (listNames, metricType) => {
            let total = 0;
            if(!listNames || listNames.length === 0) return 0;

            listNames.forEach(name => {
                const cleanName = cleanCategoryName(name);
                let item = data.doanhThuTheoNganhHang?.[cleanName];
                if (!item && data.doanhThuTheoNhomHang) {
                    item = data.doanhThuTheoNhomHang[cleanName];
                }

                if (item) {
                    if (metricType === 'SL') total += item.quantity;
                    else if (metricType === 'DTQD') total += item.revenueQuyDoi;
                    else total += item.revenue; 
                }
            });
            return total;
        };

        const numVal = sumValues(metricConfig.groupA, metricConfig.typeA);
        const denVal = sumValues(metricConfig.groupB, metricConfig.typeB);

        return denVal > 0 ? numVal / denVal : 0;
    }
};
--- END FILE: ./src/services/sknv.service.js ---

--- START FILE: ./src/services/storage.service.js ---
// src/services/storage.service.js
// Version 3.1 - Fixed: Export both 'storage' (IndexedDB) and 'storageService' (Firebase)
// MODULE: STORAGE SERVICE
import { getStorage, ref, uploadBytesResumable, getDownloadURL } from "firebase/storage";
import { get } from 'svelte/store';
import { firebaseStore, notificationStore } from '../stores.js';

// --- PH·∫¶N 1: FIREBASE STORAGE (M·ªõi) ---

const getStorageInstance = () => {
    const fb = get(firebaseStore);
    if (!fb || !fb.storage) {
        try { return getStorage(); } catch (e) { return null; }
    }
    return fb.storage;
};

const showNotification = (message, type = 'info') => {
    notificationStore.set({ message, type, visible: true });
    setTimeout(() => notificationStore.update(s => ({ ...s, visible: false })), 3000);
};

export const storageService = {
    async getTemplateDownloadURL() {
        const storage = getStorageInstance();
        if (!storage) throw new Error("Firebase Storage ch∆∞a ƒë∆∞·ª£c kh·ªüi t·∫°o.");
        const filePath = 'templates/danh_sach_nhan_vien_mau.xlsx';
        const storageRef = ref(storage, filePath);
        return await getDownloadURL(storageRef);
    },

    async getBookmarkDownloadURL() {
        const storage = getStorageInstance();
        if (!storage) throw new Error("Firebase Storage ch∆∞a ƒë∆∞·ª£c kh·ªüi t·∫°o.");
        const filePath = 'templates/Share_QLST.zip';
        const storageRef = ref(storage, filePath);
        return await getDownloadURL(storageRef);
    },

    async getQrCodeDownloadURL() {
        const storage = getStorageInstance();
        if (!storage) throw new Error("Firebase Storage ch∆∞a ƒë∆∞·ª£c kh·ªüi t·∫°o.");
        const filePath = 'qrcodes/main-qr.jpg';
        const storageRef = ref(storage, filePath);
        return await getDownloadURL(storageRef);
    },

    async uploadFileToStorage(file, storagePath, onProgress) {
        const storage = getStorageInstance();
        if (!storage) throw new Error("Firebase Storage ch∆∞a kh·ªüi t·∫°o.");
        
        const storageRef = ref(storage, storagePath);
        const uploadTask = uploadBytesResumable(storageRef, file);

        return new Promise((resolve, reject) => {
            uploadTask.on('state_changed',
                (snapshot) => {
                    const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                    console.log(`Upload ${storagePath}: ${Math.round(progress)}%`);
                    if (onProgress) onProgress(progress);
                },
                (error) => {
                    console.error(`Upload l·ªói:`, error);
                    showNotification(`L·ªói upload: ${error.code}`, 'error');
                    reject(error);
                },
                async () => {
                    try {
                        const downloadURL = await getDownloadURL(uploadTask.snapshot.ref);
                        console.log('File available at', downloadURL);
                        resolve(downloadURL);
                    } catch (err) {
                        reject(err);
                    }
                }
            );
        });
    },
};

// --- PH·∫¶N 2: INDEXEDDB (C≈© - Kh√¥i ph·ª•c l·∫°i) ---

export const storage = {
    db: null,
    dbName: 'AppStorageDB',
    storeName: 'fileStore',

    openDB() {
        // console.log("[IndexedDB] Opening...");
        return new Promise((resolve, reject) => {
            if (this.db) return resolve(this.db);
            const request = indexedDB.open(this.dbName, 1);
            request.onupgradeneeded = (event) => {
                const db = event.target.result;
                if (!db.objectStoreNames.contains(this.storeName)) {
                    db.createObjectStore(this.storeName, { keyPath: 'id' });
                }
            };
            request.onsuccess = (event) => {
                this.db = event.target.result;
                resolve(this.db);
            };
            request.onerror = (event) => reject(event.target.error);
        });
    },

    async setItem(id, value) {
        try {
            const db = await this.openDB();
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([this.storeName], 'readwrite');
                const store = transaction.objectStore(this.storeName);
                const request = store.put({ id, value });
                request.onsuccess = () => resolve();
                request.onerror = (e) => reject(e.target.error);
            });
        } catch (error) {
            console.error(`[IndexedDB] Error saving ${id}:`, error);
            throw error;
        }
    },

    async getItem(id) {
        try {
            const db = await this.openDB();
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([this.storeName], 'readonly');
                const store = transaction.objectStore(this.storeName);
                const request = store.get(id);
                request.onsuccess = (e) => resolve(e.target.result ? e.target.result.value : null);
                request.onerror = (e) => reject(e.target.error);
            });
        } catch (error) {
            console.error(`[IndexedDB] Error getting ${id}:`, error);
            throw error;
        }
    }
};
--- END FILE: ./src/services/storage.service.js ---

--- START FILE: ./src/styles/base.css ---
/* Version 1.0 - Base styles (Refactored from v6.19) */
/* Ch·ª©a c√°c thi·∫øt l·∫≠p n·ªÅn t·∫£ng: fonts, :root variables, body, scrollbar */

@import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');

:root {
    --global-font-size: 18px;
    --kpi-main-font-size: 36px;
    --bg-lightness-1: 98%; --header-lightness-1: 96%; --header-text-lightness-1: 25%; --special-header-lightness-1: 92%; --below-target-lightness-1: 96%;
    --bg-lightness-2: 96%; --header-lightness-2: 94%; --header-text-lightness-2: 22%; --special-header-lightness-2: 88%; --below-target-lightness-2: 94%;
    --bg-lightness-3: 94%; --header-lightness-3: 92%; --header-text-lightness-3: 18%; --special-header-lightness-3: 85%; --below-target-lightness-3: 92%; /* Normal */
    --bg-lightness-4: 92%; --header-lightness-4: 88%; --header-text-lightness-4: 15%; --special-header-lightness-4: 80%; --below-target-lightness-4: 88%;
    --bg-lightness-5: 90%; --header-lightness-5: 84%; --header-text-lightness-5: 12%; --special-header-lightness-5: 75%; --below-target-lightness-5: 84%;
    --bg-lightness-6: 88%; --header-lightness-6: 80%; --header-text-lightness-6: 10%; --special-header-lightness-6: 70%; --below-target-lightness-6: 80%;
    --kpi-card-1-bg: #38bdf8;
    --kpi-card-2-bg: #34d399; --kpi-card-3-bg: #fbbf24;
    --kpi-card-4-bg: #2dd4bf;
    --kpi-card-5-bg: #a78bfa; --kpi-card-6-bg: #f472b6;
    --kpi-card-7-bg: #818cf8;
    --kpi-card-8-bg: #f87171;
    --kpi-title-color: #ffffff;
    --kpi-main-color: #ffffff;
    --kpi-sub-color: #ffffff;
}

body {
    font-family: 'Inter', sans-serif;
    background-color: #f3f4f6;
    font-size: var(--global-font-size);
}

html[data-contrast="1"] { --bg-lightness: var(--bg-lightness-1); --header-lightness: var(--header-lightness-1); --header-text-lightness: var(--header-text-lightness-1); --special-header-lightness: var(--special-header-lightness-1); --below-target-lightness: var(--below-target-lightness-1); }
html[data-contrast="2"] { --bg-lightness: var(--bg-lightness-2); --header-lightness: var(--header-lightness-2); --header-text-lightness: var(--header-text-lightness-2); --special-header-lightness: var(--special-header-lightness-2); --below-target-lightness: var(--below-target-lightness-2); }
html[data-contrast="3"] { --bg-lightness: var(--bg-lightness-3); --header-lightness: var(--header-lightness-3); --header-text-lightness: var(--header-text-lightness-3);
--below-target-lightness: var(--below-target-lightness-3); }
html[data-contrast="4"] { --bg-lightness: var(--bg-lightness-4); --header-lightness: var(--header-lightness-4); --header-text-lightness: var(--header-text-lightness-4); --special-header-lightness: var(--special-header-lightness-4); --below-target-lightness: var(--below-target-lightness-4); }
html[data-contrast="5"] { --bg-lightness: var(--bg-lightness-5); --header-lightness: var(--header-lightness-5); --header-text-lightness: var(--header-text-lightness-5); --special-header-lightness: var(--special-header-lightness-5); --below-target-lightness: var(--below-target-lightness-5); }
html[data-contrast="6"] { --bg-lightness: var(--bg-lightness-6); --header-lightness: var(--header-lightness-6); --header-text-lightness: var(--header-text-lightness-6); --special-header-lightness: var(--special-header-lightness-6); --below-target-lightness: var(--below-target-lightness-6); }


::-webkit-scrollbar { width: 8px; }
::-webkit-scrollbar-track { background: #f1f1f1; }
::-webkit-scrollbar-thumb { background: #888; border-radius: 10px; }
::-webkit-scrollbar-thumb:hover { background: #555; }

.feather {
    width: 1.1rem;
    height: 1.1rem;
    stroke-width: 1.5;
    flex-shrink: 0;
}
--- END FILE: ./src/styles/base.css ---

--- START FILE: ./src/styles/components.css ---
/* Version 3.1 - FIX LAYOUT REGRESSION & RESIZE SUB-TABS */
/* Ch·ª©a to√†n b·ªô style cho components: Header m·ªõi, Tabs m·ªõi, v√† c√°c th√†nh ph·∫ßn c≈© ƒë∆∞·ª£c kh√¥i ph·ª•c */

/* =========================================
   1. MODERN HEADER & TABS (NEW)
   ========================================= */

/* Header hi·ªán ƒë·∫°i cho 3 tab ch√≠nh */
.modern-page-header {
    background: linear-gradient(to right, #f0f9ff, #ffffff);
    padding: 1rem 1.5rem; /* Gi·∫£m padding d·ªçc m·ªôt ch√∫t cho g·ªçn */
    border-bottom: 1px solid #e5e7eb;
    border-radius: 0.75rem 0.75rem 0 0;
    
    display: flex;
    flex-wrap: wrap;
    align-items: center;
    justify-content: space-between;
    gap: 1rem;
    margin-bottom: 0;
}

.modern-page-header .title-wrapper {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    flex-wrap: wrap;
}

.modern-page-header .main-icon {
    width: 2.25rem; /* Thu nh·ªè icon ch√≠nh m·ªôt ch√∫t cho c√¢n ƒë·ªëi */
    height: 2.25rem;
    color: #2563eb;
    stroke-width: 1.5;
    padding: 5px;
    background-color: white;
    border-radius: 8px;
    box-shadow: 0 1px 2px rgba(0,0,0,0.05);
    border: 1px solid #dbeafe;
    flex-shrink: 0;
}

.modern-page-header .page-title {
    font-size: 1.25rem; /* Gi·∫£m size ti√™u ƒë·ªÅ cho c√¢n ƒë·ªëi h∆°n (20px) */
    font-weight: 800;
    color: #1e40af;
    letter-spacing: -0.01em;
    margin: 0;
    line-height: 1.2;
    text-transform: uppercase; /* Th√™m uppercase cho m·∫°nh m·∫Ω */
}

/* === [FIX] SUB-TAB BUTTON: THU NH·ªé K√çCH TH∆Ø·ªöC === */
.sub-tab-btn {
    border-bottom: 2px solid transparent;
    padding: 0.5rem 0.75rem; /* Gi·∫£m padding ƒë·ªÉ n√∫t g·ªçn h∆°n */
    transition: all 0.2s ease-in-out;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 0.4rem; /* Gi·∫£m kho·∫£ng c√°ch gi·ªØa icon v√† ch·ªØ */
    color: #6b7280;
    font-weight: 600; /* TƒÉng ƒë·ªô ƒë·∫≠m m·ªôt ch√∫t ƒë·ªÉ d·ªÖ ƒë·ªçc ·ªü size nh·ªè */
    font-size: 0.8125rem; /* ~13px: Nh·ªè h∆°n ti√™u ƒë·ªÅ, c√¢n ƒë·ªëi */
    background: transparent;
    border: none;
    cursor: pointer;
    white-space: nowrap;
}

.sub-tab-btn:hover {
    color: #111827;
    background-color: #f3f4f6;
    border-radius: 4px 4px 0 0;
}

.sub-tab-btn .feather {
    width: 1rem; /* Icon nh·ªè l·∫°i (16px) */
    height: 1rem;
    stroke-width: 1.5;
    transition: color 0.2s;
}

/* Active State */
.sub-tab-btn.active {
    border-bottom: 2px solid #2563eb;
    color: #2563eb;
    background-color: #eff6ff;
}

.sub-tab-btn.active .feather {
    color: #2563eb;
    stroke-width: 2;
}

/* =========================================
   2. GENERAL COMPONENTS & TRANSITIONS
   ========================================= */

.nav-link,
.action-btn,
.kpi-card,
.content-card,
.tdv-item-card,
.data-input-group,
.toggle-filters-btn,
.page-header__help-btn,
.column-toggle-btn,
.rt-infographic-summary-card {
    transition: all 0.2s ease-in-out;
}

.nav-link:hover,
.action-btn:hover,
.kpi-card:hover,
.content-card:hover,
.data-input-group:hover,
.toggle-filters-btn:hover,
.rt-infographic-summary-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
}

.tdv-item-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
}

.page-header__help-btn {
    background-color: #fee2e2;
    color: #991b1b;
    border-radius: 9999px;
    width: 2rem;
    height: 2rem;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    border: none;
    cursor: pointer;
}

.page-header__help-btn:hover {
    transform: scale(1.1) translateY(-1px);
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
}

input[type="range"] {
    -webkit-appearance: none;
    appearance: none;
    width: 100%;
    height: 8px;
    background: #e5e7eb;
    border-radius: 5px;
    outline: none;
    transition: background 0.2s;
}

input[type="range"]::-webkit-slider-thumb {
    -webkit-appearance: none;
    appearance: none;
    width: 20px;
    height: 20px;
    background: #3b82f6;
    border-radius: 50%;
    cursor: pointer;
    border: 2px solid white;
    box-shadow: 0 0 5px rgba(0,0,0,0.2);
}

input[type="range"]::-moz-range-thumb {
    width: 20px;
    height: 20px;
    background: #3b82f6;
    border-radius: 50%;
    cursor: pointer;
    border: 2px solid white;
    box-shadow: 0 0 5px rgba(0,0,0,0.2);
}

/* =========================================
   3. CARDS & LAYOUT (KH·∫ÆC PH·ª§C L·ªñI DATA SECTION)
   ========================================= */

.content-card {
    background-color: white;
    border-radius: 0.75rem;
    box-shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1), 0 1px 2px -1px rgb(0 0 0 / 0.1);
    
    /* [FIX QUAN TR·ªåNG] Kh√¥i ph·ª•c padding m·∫∑c ƒë·ªãnh ƒë·ªÉ Tab Data kh√¥ng b·ªã d√≠nh l·ªÅ */
    padding: 1.5rem; 
    
    margin-bottom: 2rem;
    border: 1px solid #e5e7eb;
    overflow: hidden;
}

/* Class h·ªó tr·ª£ cho c√°c card s·ª≠ d·ª•ng Modern Header (ƒë·ªÉ header tr√†n vi·ªÅn) */
/* L∆∞u √Ω: C√°c file .svelte c·ªßa 3 tab kia ƒë√£ c√≥ class "!p-0", class ƒë√≥ s·∫Ω ghi ƒë√® padding tr√™n */
.content-card__body {
    padding: 1.5rem;
}

/* Header c≈© (d√πng cho DataSection - Kh√¥i ph·ª•c hi·ªÉn th·ªã ƒë√∫ng) */
.content-card__header { 
    display: flex; 
    align-items: center; 
    justify-content: flex-start;
    gap: 0.5rem;
    font-size: 1.125rem; 
    font-weight: 700; /* TƒÉng ƒë·ªô ƒë·∫≠m */
    color: #374151; 
    margin-bottom: 1rem;
    margin-top: -0.5rem; /* K√©o l√™n m·ªôt ch√∫t ƒë·ªÉ c√¢n ƒë·ªëi v·ªõi padding card */ 
    padding-bottom: 0.75rem; 
    border-bottom: 1px solid #e5e7eb; 
}

/* Notifications */
#notification { position: fixed; bottom: 20px; right: 20px; padding: 1rem 1.5rem; border-radius: 0.5rem; color: white; z-index: 1200; opacity: 0; transition: opacity 0.5s, transform 0.5s; transform: translateY(100px); }
#notification.show { opacity: 1; transform: translateY(0); }
.notification-success { background-color: #28a745; }
.notification-error { background-color: #dc3545; }

.placeholder-message { 
    border: 2px dashed #f59e0b; 
    background-color: #fffbeb; 
    color: #b45309; 
    padding: 2rem;
    border-radius: 0.75rem; 
    text-align: center; 
    font-weight: 600; 
}

[id$='-subtabs-nav'] { flex-wrap: wrap; }

/* =========================================
   4. DATA INPUT GROUPS (THEMES)
   ========================================= */

.data-input-group {
    border: 1px solid #e5e7eb;
    border-radius: 0.5rem;
    padding: 1rem; /* TƒÉng padding nh·∫π cho input group */
    background-color: #ffffff; /* ƒê·ªïi n·ªÅn th√†nh tr·∫Øng cho s·∫°ch */
    display: flex;
    flex-direction: column;
    border-top: 4px solid #9ca3af;
    box-shadow: 0 1px 2px rgba(0,0,0,0.05);
}

.data-card--blue { background-color: #f0f9ff; border-color: #bae6fd; }
.data-card--green { background-color: #f0fdf4; border-color: #bbf7d0; }
.data-card--yellow { background-color: #fefce8; border-color: #fef08a; }

/* Fix m√†u header trong Data Section */
.data-header--blue { color: #0369a1; border-bottom-color: #7dd3fc; }
.data-header--green { color: #15803d; border-bottom-color: #86efac; }
.data-header--yellow { color: #854d0e; border-bottom-color: #fde047; }

.input-group--blue { border-top-color: #3b82f6; border-color: #dbeafe; }
.input-group--green { border-top-color: #22c55e; border-color: #dcfce7; }
.input-group--yellow { border-top-color: #f59e0b; border-color: #fef3c7; }

.input-group--blue .data-input-group__label { color: #1d4ed8; }
.input-group--green .data-input-group__label { color: #166534; }
.input-group--yellow .data-input-group__label { color: #92400e; }

.data-input-group__label { 
    font-weight: 700; 
    margin-bottom: 0.75rem; 
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-size: 1rem;
}
.data-input-group__label .feather {
    width: 1.25rem;
    height: 1.25rem;
    flex-shrink: 0;
}
.data-input-group__label--link { text-decoration: none; display: inline-flex; }
.data-input-group__label--link:hover { text-decoration: underline; }
.data-input-group__label--link > .font-normal { font-weight: 400; }

.data-input-group__content { display: flex; flex-direction: column; gap: 0.5rem; flex-grow: 1; }
.data-input-group__file-trigger { cursor: pointer; background-color: #e5e7eb; color: #374151; padding: 0.5rem 1rem; border-radius: 0.375rem; font-size: 0.875em; font-weight: 600; white-space: nowrap; }
.data-input-group__file-trigger:hover { background-color: #d1d5db; }
.data-input-group__file-name { font-size: 0.875em; color: #6b7280; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; font-style: italic; }
.data-input-group__link { color: #2563eb; text-decoration: none; font-size: 0.875em; display: inline-flex; }
.data-input-group__link:hover { text-decoration: underline; }
.data-input-group__status-wrapper { min-height: 1rem; margin-top: 0.25rem; }
.data-input-group__status-text { font-size: 0.8rem; font-weight: 600; }
.data-input-group__status-text--default { color: #6b7280; }
.data-input-group__status-text--success { color: #16a34a; }
.data-input-group__status-text--error { color: #dc2626; }

.data-textarea { width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 0.375rem; font-size: 0.875em; font-family: 'Inter', sans-serif; line-height: 1.5; }
.data-textarea:focus { outline: 2px solid transparent; outline-offset: 2px; border-color: #3b82f6; box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.2); }

.progress-bar-container { overflow: hidden; height: 4px; border-radius: 2px; background-color: #e5e7eb; margin-top: 4px; }
.progress-bar { background-image: linear-gradient(45deg, rgba(255, 255, 255, .15) 25%, transparent 25%, transparent 50%, rgba(255, 255, 255, .15) 50%, rgba(255, 255, 255, .15) 75%, transparent 75%, transparent); background-size: 1rem 1rem; animation: progress-bar-stripes 1s linear infinite; background-color: #3b82f6; height: 100%; transition: width 0.3s; }
@keyframes progress-bar-stripes { from { background-position: 1rem 0; } to { background-position: 0 0; } }

/* =========================================
   5. INTERACTIVE TABLES
   ========================================= */

.interactive-row {
    transition: transform 0.2s ease-out, box-shadow 0.2s ease-out;
    cursor: pointer;
}
.interactive-row:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
    background-color: #eff6ff;
}
.interactive-row .employee-name-cell {
    cursor: pointer;
    color: #2563eb;
    transition: color 0.2s ease-out;
}
.interactive-row:hover .employee-name-cell {
    text-decoration: underline;
    color: #1d4ed8;
}

.income-positive { color: #16a34a; }
.income-negative { color: #dc2626; }
.line-clamp-2 { display: -webkit-box; -webkit-line-clamp: 2; line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }

/* =========================================
   6. KPI CARDS
   ========================================= */

.kpi-card { background-color: white; border-radius: 0.75rem; padding: 1rem; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
.kpi-card-title { color: var(--kpi-title-color); opacity: 0.9; font-size: 0.9em; font-weight: 600; text-transform: uppercase; }
.kpi-card p[id$="-main"] { color: var(--kpi-main-color); font-size: var(--kpi-main-font-size); transition: font-size 0.2s ease-in-out; }
.kpi-card p[id$="-sub"], .kpi-card p[id$="-sub1"], .kpi-card p[id$="-sub2"] { color: var(--kpi-sub-color); font-size: 0.95em; }

.kpi-percentage, .kpi-percentage-value { font-weight: 700; }
.kpi-sub-value { opacity: 0.9; }

/* KPI Card Colors */
#luyke-kpi-cards-container .kpi-card:nth-child(1), #realtime-kpi-cards-container .kpi-card:nth-child(1) { background-color: var(--kpi-card-1-bg); }
#luyke-kpi-cards-container .kpi-card:nth-child(2), #realtime-kpi-cards-container .kpi-card:nth-child(2) { background-color: var(--kpi-card-2-bg); }
#luyke-kpi-cards-container .kpi-card:nth-child(3), #realtime-kpi-cards-container .kpi-card:nth-child(3) { background-color: var(--kpi-card-3-bg); }
#luyke-kpi-cards-container .kpi-card:nth-child(4), #realtime-kpi-cards-container .kpi-card:nth-child(4) { background-color: var(--kpi-card-4-bg); }
#luyke-kpi-cards-container .kpi-card:nth-child(5) { background-color: var(--kpi-card-5-bg); }
#luyke-kpi-cards-container .kpi-card:nth-child(6) { background-color: var(--kpi-card-6-bg); }
#luyke-kpi-cards-container .kpi-card:nth-child(7) { background-color: var(--kpi-card-7-bg); }
#luyke-kpi-cards-container .kpi-card:nth-child(8) { background-color: var(--kpi-card-8-bg); }

/* =========================================
   7. BUTTONS & ACTIONS
   ========================================= */

.toggle-filters-btn { display: inline-flex; align-items: center; gap: 0.5rem; padding: 0.5rem 1rem; border-radius: 0.5rem; background-color: #f3f4f6; color: #4b5563; font-weight: 500; font-size: 0.875em; cursor: pointer; margin-bottom: 1rem; border: 1px solid #e5e7eb; }
.toggle-filters-btn .icon { width: 1rem; height: 1rem; transition: transform 0.3s ease-in-out; }
.toggle-filters-btn.active .icon { transform: rotate(180deg); }

.highlight-trigger { background: none; border: none; cursor: pointer; color: #6b7280; }
.highlight-trigger:hover { color: #1d4ed8; }
.highlighted-row td { animation: pulse-bg 2s infinite; }
@keyframes pulse-bg { 0% { background-color: var(--highlight-color, #ffff99); } 50% { background-color: var(--highlight-color-light, #ffffcc); } 100% { background-color: var(--highlight-color, #ffff99); } }

.action-btn {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
    padding: 0.5rem 1rem;
    border-radius: 0.5rem;
    font-weight: 600;
    font-size: 0.8125rem; /* ƒê·ªìng b·ªô size v·ªõi Sub-tab */
    cursor: pointer;
    border: 1px solid transparent;
    transition: all 0.2s;
    box-shadow: 0 1px 2px rgba(0,0,0,0.05);
}
.action-btn--composer { background-color: #ede9fe; color: #5b21b6; border-color: #c4b5fd; }
.action-btn--composer:hover { background-color: #d8b4fe; }
.action-btn--export { background-color: #dcfce7; color: #166534; border-color: #86efac; }
.action-btn--export:hover { background-color: #bbf7d0; }
.action-btn--capture { background-color: #dbeafe; color: #1e40af; border-color: #93c5fd; }
.action-btn--capture:hover { background-color: #bfdbfe; }
.action-btn--save { background-color: #16a34a; color: white; }
.action-btn--save:hover { background-color: #15803d; }
.action-btn--copy { background-color: #2563eb; color: white; }
.action-btn--copy:hover { background-color: #1d4ed8; }

/* =========================================
   8. MODALS
   ========================================= */

.modal { position: fixed; inset: 0; z-index: 1000; display: flex; align-items: center; justify-content: center; }
.modal.hidden { display: none; }
.modal__overlay { position: absolute; inset: 0; background-color: rgba(17, 24, 39, 0.6); backdrop-filter: blur(4px); cursor: pointer; }
.modal__container { position: relative; z-index: 1001; background-color: white; border-radius: 0.75rem; box-shadow: 0 20px 25px -5px rgb(0 0 0 / 0.1), 0 8px 10px -6px rgb(0 0 0 / 0.1); width: 90%; max-width: 600px; max-height: 90vh; display: flex; flex-direction: column; }

#force-update-modal .modal__overlay { cursor: not-allowed; }

.modal__container--large { max-width: 900px; }
.modal__header { padding: 1rem 1.5rem; border-bottom: 1px solid #e5e7eb; display: flex; justify-content: space-between; align-items: center; flex-shrink: 0; }
.modal__title { font-size: 1.25rem; font-weight: 600; color: #1f2937; }
.modal__close-btn { font-size: 1.75rem; line-height: 1; color: #6b7280; background: none; border: none; cursor: pointer; }
.modal__close-btn:hover { color: #111827; }
.modal__content { padding: 1.5rem; overflow-y: auto; flex-grow: 1; }
.modal__content h4 { font-size: 1.125rem; font-weight: 600; color: #1e3a8a; margin-bottom: 0.75rem; }
.modal__content p { margin-bottom: 0.75rem; color: #374151; line-height: 1.6; }
.modal__content ul { list-style-type: disc; list-style-position: inside; margin-left: 0.5rem; }
.modal__content ul > * + * { margin-top: 0.5rem; }
.modal__footer { padding: 1rem 1.5rem; border-top: 1px solid #e5e7eb; background-color: #f9fafb; display: flex; justify-content: flex-end; gap: 0.75rem; flex-shrink: 0; }

#login-modal .modal__overlay { cursor: not-allowed; }
#login-modal .modal__container { box-shadow: 0 25px 50px -12px rgb(0 0 0 / 0.25); }
#login-modal input[type="email"]:focus { border-color: #3b82f6; box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.4); outline: none; }

/* =========================================
   9. INFOGRAPHIC & REALTIME STYLES
   ========================================= */

.view-switcher { display: flex; align-items: center; padding: 0.25rem; background-color: #e5e7eb; border-radius: 0.5rem; }
.view-switcher__btn { padding: 0.5rem 1rem; border: none; background-color: transparent; border-radius: 0.375rem; font-weight: 500; color: #4b5563; cursor: pointer; }
.view-switcher__btn.active { background-color: white; color: #3b82f6; box-shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1); }

.infographic-card { border: 1px solid #e5e7eb; border-radius: 0.5rem; overflow: hidden; }
.infographic-card__header { padding: 0.75rem 1rem; font-weight: 700; }
.infographic-card__header--completed { background-color: #dcfce7; color: #166534; }
.infographic-card__header--pending { background-color: #fee2e2; color: #991b1b; }
.infographic-card__body { padding: 1rem; background-color: #f9fafb; }
.infographic-card__item { border-bottom: 1px dashed #d1d5db; padding: 0.75rem 0; }
.infographic-card__item:last-child { border-bottom: none; }
.infographic-card__title { font-weight: 600; color: #1f2937; margin-bottom: 0.5rem; }
.infographic-card__metrics { display: grid; grid-template-columns: repeat(2, minmax(0, 1fr)); gap: 0.5rem 1rem; font-size: 0.875em; }
.metric-label { color: #6b7280; }
.metric-value { font-weight: 600; color: #111827; text-align: right; }
.metric-value.is-negative { color: #ef4444; }
.metric-value.is-positive { color: #22c55e; }

/* RT Infographic */
.rt-infographic-container { background-color: #f9fafb; border-radius: 0.75rem; border: 1px solid #e5e7eb; padding: 1.5rem; }
.rt-infographic-header .employee-name { font-size: 1.5rem; font-weight: 800; color: #111827; }
.rt-infographic-header .employee-title { font-size: 1rem; font-weight: 500; color: #6b7280; }
.rt-infographic-summary { display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 1rem; margin-top: 1.5rem; }
.rt-infographic-summary-card { background-color: white; border-radius: 0.5rem; padding: 1rem; text-align: center; border: 1px solid #e5e7eb; }
.rt-infographic-summary-card .label { font-size: 0.875em; color: #4b5563; font-weight: 500; display: flex; align-items: center; justify-content: center; gap: 0.25rem; }
.rt-infographic-summary-card .label .feather { width: 1em; height: 1em; }
.rt-infographic-summary-card .value { font-size: 1.75rem; font-weight: 700; color: #3b82f6; margin-top: 0.25rem; }
.rt-infographic-summary-card .value.is-positive { color: #2563eb; }
.rt-infographic-summary-card .value.is-negative { color: #dc2626; }
.rt-infographic-summary-card .value.is-dat { color: #16a34a !important; }
.rt-infographic-summary-card .value.is-gan-dat { color: #f59e0b !important; }
.rt-infographic-summary-card .value.is-can-co-gang { color: #dc2626 !important; }

.rt-infographic-grid { display: grid; grid-template-columns: repeat(1, minmax(0, 1fr)); gap: 1.5rem; margin-top: 1.5rem; }
@media (min-width: 1024px) { .rt-infographic-grid { grid-template-columns: repeat(2, minmax(0, 1fr)); } }
.rt-infographic-section h4 { font-size: 1.125rem; font-weight: 700; color: #1f2937; margin-bottom: 1rem; }
.rt-progress-bar-item { margin-bottom: 0.75rem; }
.rt-progress-bar-label { display: flex; justify-content: space-between; font-size: 0.875em; font-weight: 500; margin-bottom: 0.25rem; }
.rt-progress-bar-container { background-color: #e5e7eb; border-radius: 9999px; height: 0.75rem; overflow: hidden; }
.rt-progress-bar { background-color: #22c55e; height: 100%; border-radius: 9999px; transition: width 0.5s ease-in-out; }

/* RT Customer Accordion */
.rt-customer-accordion { max-height: 400px; overflow-y: auto; border: 1px solid #e5e7eb; border-radius: 0.5rem; }
.rt-customer-header { background-color: white; padding: 0.75rem 1rem; border-bottom: 1px solid #e5e7eb; cursor: pointer; display: flex; justify-content: space-between; align-items: center; font-weight: 600; list-style: none; }
.rt-customer-header::-webkit-details-marker { display: none; }
.rt-customer-header:hover { background-color: #f9fafb; }
.rt-customer-header .arrow { transition: transform 0.3s; }
.rt-customer-header .product-count { color: #dc2626; font-weight: bold; }
details[open] > summary .arrow { transform: rotate(180deg); }
.rt-customer-details { background-color: #f9fafb; padding: 1rem; }
.rt-customer-details table { font-size: 0.8rem; }

/* =========================================
   10. MISCELLANEOUS COMPONENTS
   ========================================= */

.preview-content { background-color: #f3f4f6; padding: 1rem; border-radius: 0.5rem; white-space: pre-wrap; word-wrap: break-word; font-size: 0.875em; line-height: 1.6; color: #1f2937; font-family: 'Inter', sans-serif; }

.header-qr-container { display: flex; flex-direction: column; align-items: center; gap: 4px; border: 2px solid #ef4444; padding: 4px; border-radius: 8px; background-color: white; }
.header-qr-container span { font-size: 0.75rem; font-weight: 600; color: #b91c1c; }
.header-qr-image { width: 50px; height: 50px; background-color: #f3f4f6; border-radius: 4px; }

.selection-item { display: flex; align-items: center; padding: 0.5rem; border-radius: 0.375rem; cursor: pointer; transition: background-color 0.2s ease-in-out; }
.selection-item:hover { background-color: #f3f4f6; }
.selection-item input[type="checkbox"] { width: 1rem; height: 1rem; margin-right: 0.75rem; }
.selection-item label { flex-grow: 1; cursor: pointer; }

.settings-trigger-btn { background: none; border: none; cursor: pointer; color: #9ca3af; transition: color 0.2s ease-in-out, transform 0.2s ease-in-out; padding: 2px; }
.settings-trigger-btn:hover { color: #3b82f6; transform: rotate(45deg); }
.settings-trigger-btn svg { width: 18px; height: 18px; display: block; }

#version-marquee-container { flex-grow: 1; margin: 0 1.5rem; overflow: hidden; position: relative; background-color: #eef2ff; border: 1px solid #c7d2fe; border-radius: 9999px; cursor: pointer; height: 38px; }
#version-marquee-container:hover .marquee-text { animation-play-state: paused; color: #312e81; }
.marquee-text { position: absolute; white-space: nowrap; will-change: transform; animation: marquee-scroll 25s linear infinite; font-weight: 600; color: #4338ca; line-height: 36px; }
@keyframes marquee-scroll { from { transform: translateX(100%); } to { transform: translateX(-100%); } }

.competition-summary-counter strong { font-size: 1.15rem !important; font-weight: 800 !important; white-space: nowrap; }
.competition-summary-counter .text-blue-600 { color: #2563eb !important; }
.competition-summary-counter .text-red-600 { color: #dc2626 !important; }

/* Column Toggle Button */
.column-toggle-btn { padding: 4px 12px; font-size: 12px; font-weight: 500; border: 1px solid; border-radius: 9999px; cursor: pointer; transition: all 0.2s ease-in-out; user-select: none; }
.column-toggle-btn.active { background-color: #3b82f6; color: white; border-color: #3b82f6; }
.column-toggle-btn:not(.active) { background-color: #e5e7eb; color: #374151; border-color: #d1d5db; }
.column-toggle-btn:not(.active):hover { background-color: #d1d5db; }
.column-toggle-btn.draggable-tag { cursor: grab; }
.column-toggle-btn.draggable-tag:active { cursor: grabbing; }
.column-toggle-btn.draggable-tag:hover { transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
.drag-handle-icon { color: #6b7280; transition: color 0.2s ease-in-out; cursor: grab; }
.drag-handle-icon:active { cursor: grabbing; }
.column-toggle-btn.draggable-tag:hover .drag-handle-icon { color: #1f2937; }

/* Draggable & Sortable */
.draggable-header { cursor: move; cursor: grab; }
.draggable-header:active { cursor: grabbing; }
.sortable-ghost { opacity: 0.4; background-color: #c7d2fe; }
.sortable-drag { opacity: 0.95; transform: rotate(-2deg); box-shadow: 0 8px 16px rgba(0,0,0,0.2); }

#sidebar .feather { width: 1.5rem; height: 1.5rem; stroke-width: 2; }
.page-header__help-btn .feather { width: 1.25rem; height: 1.25rem; }

/* LUY KE DETAIL */
.luyke-detail-header h3 { font-size: 1.75rem; font-weight: 800; color: #111827; text-align: center; }
.luyke-detail-progress-item { display: flex; flex-direction: column; gap: 4px; }
.luyke-detail-progress-label { display: flex; justify-content: space-between; align-items: baseline; font-size: 0.875rem; }
.luyke-detail-progress-values { display: flex; justify-content: space-between; font-size: 0.75rem; color: #4b5563; }
.luyke-detail-chart-container { position: relative; height: 350px; width: 100%; }

/* CUSTOMER ACCORDION (LUYKE) */
.customer-accordion-luyke summary { display: flex; flex-wrap: wrap; align-items: center; gap: 1rem; padding: 0.5rem 1rem; cursor: pointer; list-style: none; font-weight: 400; color: #4b5563; }
.customer-accordion-luyke summary:hover { background-color: #f9fafb; }
.customer-accordion-luyke .customer-name-small { font-weight: 500; font-size: 0.9rem; color: #2563eb; flex-grow: 1; min-width: 120px; }
.customer-accordion-luyke .order-metrics { display: flex; align-items: center; gap: 1rem; flex-shrink: 0; font-size: 0.75rem; }
.customer-accordion-luyke .order-metrics span { white-space: nowrap; }
.customer-accordion-luyke .order-metrics strong { font-weight: 500; color: #1f2937; }
.customer-accordion-luyke .order-metrics .text-gray-900 { color: #1f2937 !important; }
.customer-accordion-luyke .order-metrics .text-blue-600 { color: #2563eb !important; }
.customer-accordion-luyke .accordion-arrow { margin-left: auto; color: #9ca3af; transition: transform 0.2s ease-in-out; }
.customer-accordion-luyke details[open] > summary .accordion-arrow { transform: rotate(180deg); }
.customer-accordion-luyke .product-list-scrollable { display: block; max-height: 200px; overflow-y: auto; }
.customer-accordion-luyke .product-list-table { width: 100%; }
.customer-accordion-luyke .qd-below-target { color: #b91c1c; }
.customer-accordion-luyke .qd-above-target { color: #1d4ed8; }

/* CAPTURE PRESETS */
.capture-container.preset-mobile-portrait .preset-mobile-capture-area { box-sizing: border-box; }
.capture-container.preset-mobile-portrait #customer-detail-list-container,
.capture-container.preset-mobile-portrait #unexported-detail-list-container { width: 100% !important; max-width: 100% !important; box-sizing: border-box; }
--- END FILE: ./src/styles/components.css ---

--- START FILE: ./src/styles/dashboard-luyke.css ---
/* src/styles/dashboard-luyke.css */
/* Version 3.3 - Add CSS Variables support for KPI Cards */

/* =========================================
   1. LAYOUT & SCROLLING
   ========================================= */
.luyke-dashboard-container {
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
}

.luyke-tier-1-grid {
    display: grid;
    grid-template-columns: 1fr;
    gap: 1.5rem;
    height: auto;
}

@media (min-width: 1024px) {
    .luyke-tier-1-grid {
        grid-template-columns: repeat(2, 1fr);
        height: 480px;
    }
}

.luyke-widget {
    background-color: #ffffff;
    border: 1px solid #e5e7eb;
    border-radius: 0.75rem;
    box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.05);
    display: flex;
    flex-direction: column;
    height: 100%;
    overflow: hidden;
}

.luyke-widget-body {
    padding: 0.75rem;
    flex-grow: 1;
    overflow-y: auto;
    min-height: 0;
}

.luyke-widget-header {
    padding: 0.75rem 1rem;
    border-bottom: 1px solid #f3f4f6;
    display: flex;
    justify-content: space-between;
    align-items: center;
    background-color: #ffffff;
    flex-shrink: 0;
}

.luyke-widget-title {
    font-size: 0.95rem;
    font-weight: 700;
    color: #374151;
    text-transform: uppercase;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

/* =========================================
   2. KPI CARDS (SOLID STYLE - CSS VARIABLES)
   ========================================= */
.kpi-grid-fixed {
    display: grid;
    grid-template-columns: repeat(1, 1fr);
    gap: 1rem;
}
@media (min-width: 768px) { .kpi-grid-fixed { grid-template-columns: repeat(2, 1fr); } }
@media (min-width: 1280px) { .kpi-grid-fixed { grid-template-columns: repeat(4, 1fr); } }

.kpi-card-solid {
    border-radius: 1rem;
    padding: 1.25rem;
    color: white;
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
    display: flex;
    flex-direction: column;
    justify-content: space-between;
    transition: transform 0.2s, box-shadow 0.2s, background-color 0.3s; /* Th√™m transition bg */
    min-height: 140px;
    position: relative;
    overflow: hidden;
}

/* [M·ªöI] Mapping bi·∫øn CSS cho c√°c th·∫ª KPI */
.kpi-card-solid.card-1 { background-color: var(--kpi-card-1-bg, #38bdf8); }
.kpi-card-solid.card-2 { background-color: var(--kpi-card-2-bg, #34d399); }
.kpi-card-solid.card-3 { background-color: var(--kpi-card-3-bg, #fbbf24); }
.kpi-card-solid.card-4 { background-color: var(--kpi-card-4-bg, #2dd4bf); }
.kpi-card-solid.card-5 { background-color: var(--kpi-card-5-bg, #a78bfa); }
.kpi-card-solid.card-6 { background-color: var(--kpi-card-6-bg, #f472b6); }
.kpi-card-solid.card-7 { background-color: var(--kpi-card-7-bg, #818cf8); }
.kpi-card-solid.card-8 { background-color: var(--kpi-card-8-bg, #f87171); }

.kpi-card-solid:hover {
    transform: translateY(-2px);
    box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.2);
}

.kpi-bg-icon {
    position: absolute;
    right: -10px;
    bottom: -10px;
    opacity: 0.15;
    transform: rotate(-15deg);
    pointer-events: none;
}
.kpi-bg-icon svg { width: 5rem; height: 5rem; }

.kpi-solid-header {
    font-size: 0.75rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    opacity: 0.9;
    margin-bottom: 0.5rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
    color: var(--kpi-title-color, #ffffff); /* D√πng bi·∫øn */
}

.kpi-solid-value {
    font-size: var(--kpi-main-font-size, 2rem); /* D√πng bi·∫øn */
    font-weight: 800;
    line-height: 1;
    margin-bottom: 0.75rem;
    text-shadow: 0 1px 2px rgba(0,0,0,0.1);
    color: var(--kpi-main-color, #ffffff); /* D√πng bi·∫øn */
}

.kpi-solid-sub {
    font-size: 0.8rem;
    font-weight: 500;
    border-top: 1px solid rgba(255,255,255,0.3);
    padding-top: 0.5rem;
    display: flex;
    justify-content: space-between;
    color: var(--kpi-sub-color, #ffffff); /* D√πng bi·∫øn */
}

/* ... (Ph·∫ßn c√≤n l·∫°i c·ªßa file gi·ªØ nguy√™n: EFFICIENCY LIST, CATEGORY CARDS, TOOLBAR, FILTER DROPDOWN) ... */
.eff-item-compact {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    padding: 0.75rem 0;
    border-bottom: 1px dashed #f3f4f6;
    width: 100%;
}
.eff-item-compact:last-child { border-bottom: none; }
.eff-icon-compact {
    width: 2.5rem;
    height: 2.5rem;
    border-radius: 0.5rem;
    background-color: #f3f4f6;
    color: #6b7280;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
}
.eff-content-compact {
    flex-grow: 1;
    min-width: 0;
    display: flex;
    flex-direction: column;
    justify-content: center;
}
.eff-row-top {
    display: flex;
    justify-content: space-between;
    align-items: baseline;
    margin-bottom: 4px;
    width: 100%;
}
.eff-label-text { font-size: 0.9rem; font-weight: 600; color: #374151; }
.eff-value-text { font-size: 1rem; font-weight: 800; }
.eff-row-bottom { display: flex; align-items: center; gap: 0.75rem; width: 100%; }
.eff-bar-container { flex-grow: 1; height: 8px; background-color: #e5e7eb; border-radius: 4px; overflow: hidden; }
.eff-bar-fill { height: 100%; border-radius: 4px; transition: width 0.6s ease-out; }
.eff-target-text { font-size: 0.75rem; color: #6b7280; font-weight: 500; white-space: nowrap; min-width: 65px; text-align: right; }
.luyke-cat-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 0.75rem; }
.cat-card-colorful { border-radius: 0.75rem; padding: 0.75rem; transition: all 0.2s; border: 1px solid transparent; display: flex; flex-direction: column; justify-content: space-between; min-height: 110px; }
.cat-card-colorful:hover { transform: translateY(-3px); box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }
.theme-blue { background-color: #eff6ff; border-color: #bfdbfe; }
.theme-blue .cat-icon-box { background-color: #dbeafe; color: #2563eb; }
.theme-blue .cat-value-text { color: #1e40af; }
.theme-green { background-color: #ecfdf5; border-color: #a7f3d0; }
.theme-green .cat-icon-box { background-color: #d1fae5; color: #059669; }
.theme-green .cat-value-text { color: #065f46; }
.theme-orange { background-color: #fff7ed; border-color: #fed7aa; }
.theme-orange .cat-icon-box { background-color: #ffedd5; color: #ea580c; }
.theme-orange .cat-value-text { color: #9a3412; }
.theme-purple { background-color: #f5f3ff; border-color: #ddd6fe; }
.theme-purple .cat-icon-box { background-color: #ede9fe; color: #7c3aed; }
.theme-purple .cat-value-text { color: #5b21b6; }
.theme-teal { background-color: #f0fdfa; border-color: #99f6e4; }
.theme-teal .cat-icon-box { background-color: #ccfbf1; color: #0f766e; }
.theme-teal .cat-value-text { color: #115e59; }
.theme-gray { background-color: #f9fafb; border-color: #e5e7eb; }
.theme-gray .cat-icon-box { background-color: #f3f4f6; color: #4b5563; }
.theme-gray .cat-value-text { color: #1f2937; }
.theme-warning { background-color: #fffbeb; border-color: #fde047; background-image: repeating-linear-gradient(45deg, #fffbeb, #fffbeb 10px, #fef3c7 10px, #fef3c7 20px); }
.theme-warning .cat-icon-box { background-color: #fff7ed; color: #d97706; }
.theme-warning .cat-value-text { color: #b45309; }
.cat-top-row { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 0.5rem; }
.cat-icon-box { width: 2rem; height: 2rem; border-radius: 0.5rem; display: flex; align-items: center; justify-content: center; }
.cat-name-text { font-size: 0.85rem; font-weight: 700; color: #374151; margin-bottom: 0.25rem; line-height: 1.2; min-height: 2.4em; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
.cat-value-text { font-size: 1.25rem; font-weight: 800; line-height: 1; margin-bottom: 0.5rem; }
.cat-footer-row { display: flex; justify-content: space-between; align-items: center; font-size: 0.7rem; color: #6b7280; padding-top: 0.5rem; border-top: 1px solid rgba(0,0,0,0.05); }
.cat-percent-text { font-weight: 600; opacity: 0.8; }
.luyke-toolbar { background-color: #ffffff; padding: 0.5rem 1rem; border-bottom: 1px solid #e5e7eb; border-radius: 0.75rem 0.75rem 0 0; display: flex; flex-wrap: wrap; justify-content: space-between; align-items: center; gap: 1rem; }
.luyke-toolbar + .luyke-cat-grid, .luyke-toolbar + .luyke-charts-container { background-color: white; padding: 1rem; border: 1px solid #e5e7eb; border-top: none; border-radius: 0 0 0.75rem 0.75rem; }
.toggle-wrapper { display: inline-flex; align-items: center; gap: 8px; cursor: pointer; user-select: none; padding: 6px 12px; border-radius: 999px; background-color: #f3f4f6; border: 1px solid #e5e7eb; transition: all 0.2s; }
.toggle-wrapper:hover { background-color: #e5e7eb; }
.toggle-wrapper.active { background-color: #fff7ed; border-color: #fdba74; }
.toggle-switch { position: relative; width: 36px; height: 20px; background-color: #d1d5db; border-radius: 9999px; transition: background-color 0.3s; flex-shrink: 0; }
.toggle-switch::after { content: ''; position: absolute; top: 2px; left: 2px; width: 16px; height: 16px; background-color: white; border-radius: 50%; transition: transform 0.3s; box-shadow: 0 1px 2px rgba(0,0,0,0.2); }
.toggle-wrapper.active .toggle-switch { background-color: #f97316; }
.toggle-wrapper.active .toggle-switch::after { transform: translateX(16px); }
.toggle-label { font-size: 0.8rem; font-weight: 600; color: #4b5563; }
.toggle-wrapper.active .toggle-label { color: #c2410c; }
.view-mode-btn { display: inline-flex; align-items: center; gap: 4px; padding: 6px 12px; border-radius: 6px; font-size: 0.8rem; font-weight: 600; color: #6b7280; background-color: transparent; border: 1px solid transparent; transition: all 0.2s; }
.view-mode-btn:hover { background-color: #f3f4f6; }
.view-mode-btn.active { background-color: #eff6ff; color: #2563eb; border-color: #bfdbfe; }
.luyke-charts-container { display: grid; grid-template-columns: 1fr; gap: 1.5rem; }
@media (min-width: 1024px) { .luyke-charts-container { grid-template-columns: 4fr 6fr; } }
.chart-box { display: flex; flex-direction: column; height: 350px; position: relative; }
.filter-dropdown { position: absolute; top: 100%; right: 0; margin-top: 0.5rem; width: 280px; background-color: white; border: 1px solid #e5e7eb; border-radius: 0.5rem; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); z-index: 50; display: flex; flex-direction: column; max-height: 400px; }
.filter-header { padding: 0.75rem; border-bottom: 1px solid #f3f4f6; background-color: #f9fafb; border-radius: 0.5rem 0.5rem 0 0; }
.filter-search { width: 100%; padding: 0.5rem; font-size: 0.85rem; border: 1px solid #d1d5db; border-radius: 0.375rem; outline: none; }
.filter-search:focus { border-color: #3b82f6; }
.filter-body { overflow-y: auto; padding: 0.5rem; }
.filter-item { display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem; cursor: pointer; border-radius: 0.25rem; transition: background-color 0.1s; }
.filter-item:hover { background-color: #f3f4f6; }
.filter-item input[type="checkbox"] { width: 1rem; height: 1rem; border-radius: 0.25rem; cursor: pointer; accent-color: #3b82f6; }
.filter-item label { flex-grow: 1; font-size: 0.85rem; color: #374151; cursor: pointer; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.filter-actions { padding: 0.5rem; border-top: 1px solid #f3f4f6; display: flex; justify-content: space-between; background-color: #f9fafb; border-radius: 0 0 0.5rem 0.5rem; }
.filter-btn-link { font-size: 0.75rem; color: #2563eb; background: none; border: none; cursor: pointer; font-weight: 600; }
.filter-btn-link:hover { text-decoration: underline; }
.luyke-icon-btn { padding: 0.4rem; border-radius: 0.375rem; color: #6b7280; background-color: white; border: 1px solid #d1d5db; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; justify-content: center; }
.luyke-icon-btn:hover { color: #3b82f6; border-color: #3b82f6; background-color: #eff6ff; }
.luyke-icon-btn.active { background-color: #dbeafe; color: #1e40af; border-color: #93c5fd; }
.luyke-search-input { padding: 0.4rem 0.75rem; border: 1px solid #d1d5db; border-radius: 0.375rem; font-size: 0.875rem; outline: none; transition: border-color 0.2s; width: 200px; }
.luyke-search-input:focus { border-color: #3b82f6; box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.1); }
--- END FILE: ./src/styles/dashboard-luyke.css ---

--- START FILE: ./src/styles/layout.css ---
/* Version 1.0 - Layout styles (Refactored from v6.19) */
/* Ch·ª©a c√°c ID v√† class ƒë·ªãnh h√¨nh b·ªë c·ª•c ch√≠nh: sidebar, main-content, drawers, page-header */

#sidebar { 
    width: 68px; 
    transition: width 0.3s ease-in-out; 
    overflow-x: hidden; 
}
#sidebar:hover { 
    width: 256px; 
}
#sidebar.menu-locked:hover { 
    width: 68px; 
}

#sidebar .nav-link, #sidebar button {
    white-space: nowrap;
    gap: 1rem;
    justify-content: flex-start; /* FIX: Canh l·ªÅ tr√°i cho icon v√† text */
}

.menu-text {
    transition: opacity 0.2s ease-in-out, width 0.3s ease-in-out;
    opacity: 0;
    white-space: nowrap;
    width: 0;
    overflow: hidden;
}
#sidebar:hover .menu-text {
    opacity: 1;
    transition-delay: 0.1s;
    width: auto;
}
#sidebar.menu-locked:hover .menu-text {
    opacity: 0;
    width: 0;
}

/* === START: S·ª¨A L·ªñI (v6.14) === */
#main-content { 
    transition: margin-left 0.3s ease-in-out; 
    margin-left: 68px; 
    min-width: 0; /* NgƒÉn flex item co gi√£n theo n·ªôi dung con (c√°i b·∫£ng r·ªông) */
}
/* === END: S·ª¨A L·ªñI (v6.14) === */

.settings-drawer { 
    width: 400px; 
    max-width: 90vw; 
    transform: translateX(-100%); 
    transition: transform 0.3s ease-in-out; 
}
.settings-drawer.open { 
    transform: translateX(0); 
}
.close-drawer-btn { 
    font-size: 2rem; 
    line-height: 1; 
}

.page-header { 
    display: flex; 
    flex-wrap: wrap; 
    justify-content: space-between; 
    align-items: center; 
    gap: 1rem; 
    margin-bottom: 1.5rem; 
}
.page-header__title { 
    font-size: 1.75rem; 
    font-weight: 700; 
    color: #1f2937; 
}
--- END FILE: ./src/styles/layout.css ---

--- START FILE: ./src/styles/specific-composer.css ---
/* Version 1.0 - Specific: Composer (Refactored from v6.19) */
/* Ch·ª©a c√°c style CH·ªà d√†nh ri√™ng cho modal Tr√¨nh t·∫°o Nh·∫≠n x√©t & Xem tr∆∞·ªõc */

.composer { 
    display: flex; 
    flex-direction: column; 
    gap: 1.5rem; 
}
.composer__editor { 
    flex-grow: 1; 
}
.composer__tags { 
    width: 100%; 
}
.composer__label { 
    display: block; 
    font-weight: 500; 
    color: #374151; 
    margin-bottom: 0.5rem; 
}
.composer__textarea { 
    width: 100%; 
    border: 1px solid #d1d5db; 
    border-radius: 0.5rem; 
    padding: 0.75rem; 
    font-size: 0.875em; 
    resize: vertical; 
}
.composer__textarea:focus { 
    border-color: #3b82f6; 
    box-shadow: 0 0 0 1px #3b82f6; 
    outline: none; 
}
.composer__nav { 
    display: flex; 
    border-bottom: 1px solid #e5e7eb; 
    margin-bottom: 1rem; 
}
.composer__tab-btn { 
    padding: 0.5rem 1rem; 
    border: none; 
    background-color: transparent; 
    cursor: pointer; 
    font-weight: 500; 
    color: #6b7280; 
    border-bottom: 2px solid transparent; 
    margin-bottom: -1px; 
    font-size: 0.875em; 
}
.composer__tab-btn.active { 
    color: #3b82f6; 
    border-bottom-color: #3b82f6; 
}
.composer__tab-pane {
    display: none; 
}
.composer__tab-pane.active { 
    display: block; 
}
.composer__tag-group { 
    margin-bottom: 1rem; 
}
.composer__tag-group:last-child { 
    margin-bottom: 0; 
}
.composer__tag-group-title { 
    font-weight: 600; 
    font-size: 0.875em; 
    color: #4b5563; 
    margin-bottom: 0.75rem; 
    border-bottom: 1px solid #e5e7eb; 
    padding-bottom: 0.5rem; 
}
.composer__tag-btn { 
    background-color: #e0e7ff; 
    color: #3730a3; 
    border: 1px solid #c7d2fe; 
    border-radius: 9999px; 
    padding: 0.25rem 0.75rem; 
    font-size: 0.8rem; 
    font-weight: 500; 
    cursor: pointer; 
    margin: 0.25rem; 
}
.composer__icon-btn { 
    background-color: #f3f4f6; 
    color: #1f2937; 
    border: 1px solid #d1d5db; 
    border-radius: 9999px; 
    padding: 0.25rem 0.75rem; 
    font-size: 1.1rem; 
    font-weight: 500; 
    cursor: pointer; 
    margin: 0.25rem; 
    line-height: 1; 
}
.composer__filter-group { 
    margin-bottom: 1rem;
    padding-bottom: 1rem; 
    border-bottom: 1px solid #e5e7eb; 
}
.composer__select { 
    width: 100%; 
    padding: 0.5rem; 
    border: 1px solid #d1d5db; 
    border-radius: 0.375rem; 
    background-color: white; 
}
@media (min-width: 768px) { 
    .composer { 
        flex-direction: row; 
    } 
    .composer__tags { 
        width: 350px; 
        flex-shrink: 0; 
        border-left: 1px solid #e5e7eb; 
        padding-left: 1.5rem; 
    } 
}

.preview-content { 
    background-color: #f3f4f6; 
    padding: 1rem; 
    border-radius: 0.5rem; 
    white-space: pre-wrap; 
    word-wrap: break-word; 
    font-size: 0.875em; 
    line-height: 1.6; 
    color: #1f2937; 
    font-family: 'Inter', sans-serif; 
}
--- END FILE: ./src/styles/specific-composer.css ---

--- START FILE: ./src/styles/specific-realtime.css ---
/* Version 1.0 - Specific: Realtime (Refactored from v6.19) */
/* Ch·ª©a c√°c style CH·ªà d√†nh ri√™ng cho tab Realtime */

#video-container iframe {
    aspect-ratio: 16 / 9;
    width: 100%;
    height: auto;
    border-radius: 0.5rem;
}

.rt-customer-details table { 
    font-size: 0.8rem; 
}
--- END FILE: ./src/styles/specific-realtime.css ---

--- START FILE: ./src/styles/specific-sknv.css ---
/* Version 1.8 - No changes for this refactor
/* Version 1.7 - (YC 1) Change competition detail employee name color to dark green
/* Version 1.6 - Adjust detail view layout, colors, and KPI styling
/* Version 1.5 - Add standard 'line-clamp' property for compatibility
/* Version 1.4 - Implement "Multi-lane" layout & fix text wrap for competition detail
/* Version 1.3 - Add 3-column infographic styles and fix capture scroll
/* Version 1.2 - Fix drag-drop cursor for pasted competition toggles
/* Version 1.1 - Add sticky column styles for pasted competition table */
/* Ch·ª©a c√°c style CH·ªà d√†nh ri√™ng cho tab S·ª©c Kh·ªèe Nh√¢n Vi√™n (SKNV) */

#sknv-details-container .sknv-subtable-header th { 
    font-size: 0.875em; 
    font-weight: 600; 
    background-color: #f3f4f6; 
}

/* === START: SKNV INFOGRAPHIC CARD STYLES (V6.0) === */
.sknv-summary-grid {
    display: grid;
    grid-template-columns: 1fr; /* Default to 1 column for mobile */
    gap: 1.5rem;
}

@media (min-width: 768px) { /* 2 columns for tablets */
    .sknv-summary-grid {
        grid-template-columns: repeat(2, 1fr);
    }
}

@media (min-width: 1280px) { /* 4 columns for large desktops */
    .sknv-summary-grid {
        grid-template-columns: repeat(4, 1fr);
    }
}

.sknv-card {
    background-color: #ffffff;
    border: 1px solid #e5e7eb;
    border-radius: 0.75rem;
    padding: 1rem; /* UPDATED: Compact padding */
    box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05); /* UPDATED: Softer shadow */
    display: flex;
    flex-direction: column;
    gap: 0.75rem; /* UPDATED: Reduced gap */
    transition: transform 0.2s ease-out, box-shadow 0.2s ease-out;
    cursor: pointer;
    position: relative; /* Added for medal positioning */
}
.sknv-card:hover {
    transform: translateY(-4px);
    box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.08), 0 4px 6px -2px rgba(0, 0, 0, 0.04);
}

.sknv-card__header {
    display: flex;
    align-items: center;
    gap: 1rem;
}

.sknv-card__avatar {
    width: 48px;
    height: 48px;
    border-radius: 9999px;
    background-color: #eef2ff;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
    /* (v6.18) Th√™m position relative ƒë·ªÉ canh s·ªë Top 3 */
    position: relative;
}

.sknv-card__avatar svg {
    width: 24px;
    height: 24px;
    color: #4338ca;
}

.sknv-card__info {
    flex-grow: 1;
    min-width: 0;
}
.sknv-card__info .name {
    font-weight: 700;
    color: #111827;
    line-height: 1.25;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    display: flex;
    align-items: center;
}

.sknv-card__info .id {
    font-size: 0.875rem;
    color: #6b7280;
}

.sknv-card__main-kpi {
    text-align: center;
    margin: 0.25rem 0; /* UPDATED: Reduced margin */
}

.sknv-card__main-kpi .value {
    font-size: 2.5rem; /* UPDATED: Reduced font size */
    font-weight: 800;
    line-height: 1;
    color: #4b5563;
}

.sknv-card__main-kpi .total {
    font-size: 1.25rem; /* UPDATED */
    font-weight: 600;
    color: #9ca3af;
}

.sknv-card__main-kpi .label {
    display: block;
    font-size: 0.875rem;
    color: #6b7280;
    margin-top: 0.25rem;
    font-weight: 500;
}

.sknv-card-kpi-strong { border-top: 4px solid #16a34a; } /* UPDATED: Added top border */
.sknv-card-kpi-medium { border-top: 4px solid #f59e0b; } /* UPDATED: Added top border */
.sknv-card-kpi-weak { border-top: 4px solid #ef4444; } /* UPDATED: Added top border */
.sknv-card-kpi-strong .value { color: #16a34a; }
.sknv-card-kpi-medium .value { color: #f59e0b; }
.sknv-card-kpi-weak .value { color: #ef4444; }

.sknv-card__sub-kpi-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 0.5rem; /* UPDATED: Reduced gap */
    border-top: 1px solid #f3f4f6;
    padding-top: 0.75rem; /* UPDATED: Reduced padding */
}

.sknv-card__sub-kpi-item {
    background-color: #f9fafb;
    border-radius: 0.5rem;
    padding: 0.5rem; /* UPDATED: Reduced padding */
    text-align: center;
    transition: background-color 0.2s ease-in-out;
}

/* === START: NEW SUB-KPI LAYOUT === */
.sknv-card__sub-kpi-header {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.25rem;
}
.sknv-card__sub-kpi-header .feather {
    width: 1rem;
    height: 1rem;
    stroke-width: 2;
    color: #6b7280;
}
.sknv-card__sub-kpi-header .label {
    font-size: 0.7rem;
    font-weight: 600;
    color: #4b5563;
}
.sknv-card__sub-kpi-item .value {
    font-size: 0.875rem;
    font-weight: 700;
    margin-top: 2px;
    display: block; /* Ensures it's on a new line */
}
/* === END: NEW SUB-KPI LAYOUT === */

.sknv-card__sub-kpi-item.strong { border-bottom: 3px solid #22c55e; }
.sknv-card__sub-kpi-item.medium { border-bottom: 3px solid #f59e0b; }
.sknv-card__sub-kpi-item.weak { border-bottom: 3px solid #ef4444; }
/* === END: SKNV INFOGRAPHIC CARD STYLES === */

/* === START: SKNV Department Grouping Styles (V6.1) === */
.sknv-department-group {
    margin-bottom: 2.5rem; /* Space between department groups */
}

.sknv-department-group:last-child {
    margin-bottom: 1rem; /* Less space for the last group */
}

.sknv-department-header {
    font-size: 1.6rem;
    font-weight: 700;
    color: #1f2937; /* Dark gray for general headers */
    padding-bottom: 0.75rem;
    margin-bottom: 1.5rem;
    border-bottom: 3px solid #d1d5db; /* Light gray border */
    position: relative;
    padding-left: 0.5rem;
    /* (v6.18) Th√™m flex ƒë·ªÉ icon canh gi·ªØa */
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

/* (v6.18) ƒê·ªãnh d·∫°ng cho icon (n·∫øu c√≥) */
.sknv-department-header .header-icon {
    width: 1.4rem;
    height: 1.4rem;
}

.sknv-department-header--priority {
    color: #2563eb; /* Blue for priority department */
    border-bottom-color: #3b82f6; /* Matching blue border */
    background-color: #e0f2fe; /* Light blue background */
    padding: 0.75rem 1rem;
    border-radius: 0.5rem 0.5rem 0 0;
    margin-bottom: 0; /* Remove bottom margin to connect with cards */
    display: flex;
    align-items: center;
    gap: 0.75rem;
}

/* (v6.18) B·ªè icon FontAwesome c≈© */
.sknv-department-header--priority::before {
    content: none;
}

/* Adjust grid gap and padding for priority department to integrate better */
.sknv-department-header--priority + .sknv-summary-grid {
    border-top-left-radius: 0;
    border-top-right-radius: 0;
    margin-top: 0; /* Remove top margin */
    padding-top: 1.5rem; /* Add padding inside grid */
    border: 1px solid #c7d2fe;
    background-color: #f3f4f6; /* Slightly different background */
    padding-left: 1rem;
    padding-right: 1rem;
    padding-bottom: 1rem;
    border-top: none;
}
/* === END: SKNV Department Grouping Styles === */

/* === START: SKNV DETAIL VIEW & MEDALS (V6.4) === */
/* NEW: Wrapper for compact detail view */
#sknv-detail-capture-area {
    max-width: 1100px;
    margin: 0 auto;
}
.sknv-detail-header-card {
    display: flex;
    align-items: center;
    gap: 1.5rem;
    padding: 1rem; /* UPDATED: Compact padding */
    background-color: #eff6ff; /* blue-50 */
    border: 1px solid #dbeafe; /* blue-200 */
    border-top: 4px solid #3b82f6; /* blue-500 */
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03);
}
.sknv-detail-avatar {
    width: 64px;
    height: 64px;
    border-radius: 9999px;
    background-color: #dbeafe; /* blue-200 */
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
}
.sknv-detail-avatar svg {
    width: 32px;
    height: 32px;
    color: #1e40af; /* blue-800 */
}
.sknv-detail-info .name {
    color: #1e40af; /* UPDATED: Dark blue color */
}
.sknv-detail-info .department,
.sknv-detail-info .kpi-summary {
    color: #1f2937; /* dark text */
}
.sknv-detail-info .kpi-summary .font-bold {
    color: #1d4ed8; /* darker blue */
}
.sknv-detail-info .name {
    font-size: 1.5rem;
    font-weight: 800;
    line-height: 1.2;
}
.sknv-detail-info .department {
    font-size: 1rem;
    font-weight: 500;
}
.sknv-detail-info .kpi-summary {
    margin-top: 0.5rem;
    font-weight: 600;
}

.sknv-detail-card-header {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    padding: 0.75rem 1rem; /* UPDATED: Compact padding */
    color: #ffffff;
}
.sknv-detail-card-header .header-icon {
    width: 20px;
    height: 20px;
}
.sknv-header-blue { background-color: #2563eb; }
.sknv-header-green { background-color: #16a34a; }
.sknv-header-orange { background-color: #f97316; }
.sknv-header-yellow { background-color: #ca8a04; }
.sknv-header-indigo { background-color: #4f46e5; }
.sknv-header-purple { background-color: #7e22ce; }

.sknv-detail-grid-body {
    padding: 0.75rem 1rem; /* UPDATED: Compact padding */
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); /* UPDATED */
    gap: 0.75rem; /* UPDATED */
}
.sknv-detail-metric-card {
    display: flex;
    flex-direction: column;
    align-items: center;
    text-align: center;
    padding: 0.5rem; /* UPDATED: Compact padding */
    background-color: #f9fafb;
    border-radius: 0.5rem;
    border: 1px solid #f3f4f6;
    transition: all 0.2s ease-in-out;
}
.sknv-detail-metric-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
}
.sknv-detail-metric-card .label {
    font-weight: 600;
    font-size: 0.8rem; /* UPDATED */
    color: #374151;
}
.sknv-detail-metric-card .value {
    font-weight: 700; /* UPDATED */
    font-size: 1.375rem; /* UPDATED: Reduced font size */
    line-height: 1.2;
    color: #111827;
    margin: 0.25rem 0;
}
.sknv-detail-metric-card .average {
    font-size: 0.7rem; /* UPDATED */
    color: #6b7280;
    font-style: italic;
}
.sknv-detail-metric-card .evaluation-badge {
    margin-top: 0.5rem;
    font-weight: 700;
    padding: 2px 8px;
    border-radius: 9999px;
    font-size: 0.7rem; /* UPDATED */
}
.evaluation-badge.text-green-600 { background-color: #dcfce7; }
.evaluation-badge.text-yellow-600 { background-color: #fef9c3; }

.medal-container {
    position: absolute; /* Changed for positioning */
    /* (v6.19) YC: TƒÉng size + ƒëi·ªÅu ch·ªânh v·ªã tr√≠ */
    top: -10px;
    left: 10px;
    width: 48px;
    height: 48px;
    flex-shrink: 0;
}
.medal-container svg {
    width: 100%;
    height: 100%;
    display: block;
    filter: drop-shadow(0 2px 2px rgba(0,0,0,0.3)); /* Add a nice shadow */
}

/* NEW: Compact tables in detail view */
#sknv-details-container .sknv-subtable-header {
    font-size: 0.8rem;
}
#sknv-details-container .table-bordered td,
#sknv-details-container .table-bordered th {
    padding: 0.5rem;
}
/* === END: SKNV DETAIL VIEW & MEDALS === */

/* === START: SKNV Rank Number Styles (v6.21 - Soft Blue 3D) === */

/* 1. S·ªë th·ª© t·ª± cho Top 3 (ƒê√® l√™n huy ch∆∞∆°ng) - Gi·ªØ nguy√™n */
.sknv-card__avatar-rank {
    font-size: 1.75rem; 
    font-weight: 700; 
    line-height: 1;
    display: flex;
    align-items: center;
    justify-content: center;
    width: 100%;
    height: 100%;
    position: absolute;
    top: 0;
    left: 0;
    z-index: 12; 
    color: #ffffff; 
    text-shadow: 0 1px 2px rgba(0,0,0,0.3);
}

/* 2. ·∫®n n·ªÅn avatar m·∫∑c ƒë·ªãnh khi c√≥ huy ch∆∞∆°ng - Gi·ªØ nguy√™n */
.sknv-card:has(.medal-container) .sknv-card__avatar {
    background-color: transparent;
}

/* 3. [DESIGN M·ªöI] ƒê·ªãnh d·∫°ng cho V√≤ng tr√≤n h·∫°ng 4+ (Soft Blue) */
.sknv-card__avatar--standard {
    /* N·ªÅn Gradient: T·ª´ xanh nh·∫°t sang xanh ƒë·∫≠m h∆°n x√≠u ƒë·ªÉ t·∫°o kh·ªëi c·∫ßu */
    background: linear-gradient(145deg, #eff6ff, #dbeafe); 
    
    /* Vi·ªÅn: M√†u xanh d∆∞∆°ng r√µ n√©t */
    border: 2px solid #93c5fd; 
    
    /* ƒê·ªï b√≥ng: 
       - B√≥ng d∆∞·ªõi: M√†u xanh ƒë·∫≠m m·ªù ƒë·ªÉ t·∫°o ƒë·ªô n·ªïi.
       - B√≥ng tr√™n: M√†u tr·∫Øng ƒë·ªÉ t·∫°o ƒë·ªô b√≥ng s√°ng (highlight).
    */
    box-shadow: 
        3px 3px 6px rgba(37, 99, 235, 0.15), 
        -3px -3px 6px rgba(255, 255, 255, 0.8);
    
    width: 44px; /* Fix size */
    height: 44px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    margin-top: 2px;
    margin-left: 2px;
}

/* 4. [DESIGN M·ªöI] ƒê·ªãnh d·∫°ng cho S·ªê h·∫°ng 4+ */
.sknv-card__avatar--standard .sknv-card__avatar-rank {
    color: #1e40af; /* M√†u ch·ªØ: Xanh d∆∞∆°ng ƒë·∫≠m (Blue 800) thay v√¨ m√†u ƒëen/x√°m */
    position: static; 
    font-size: 1.25rem;
    font-weight: 800; 
    text-shadow: none; /* B·ªè b√≥ng ch·ªØ c·ªßa Top 3 */
    font-family: 'Inter', sans-serif;
}

/* 5. B·ªè SVG c≈© */
.sknv-card__avatar-medal {
    display: none;
}
/* === END: SKNV Rank Number Styles === */

/* === START: Declaration Accordion Styles (v6.11) === */
.declaration-group {
    border-bottom: 1px solid #e5e7eb; /* gray-200 */
}
.declaration-group:last-child {
    border-bottom: none;
}
.declaration-group summary {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 1rem 0.5rem;
    cursor: pointer;
    font-size: 1.125rem; /* text-lg */
    font-weight: 700; /* font-bold */
    color: #374151; /* gray-700 */
    list-style: none; /* Hide default marker */
}
.declaration-group summary::-webkit-details-marker {
    display: none; /* Hide default marker for Chrome */
}
.declaration-group summary:hover {
    background-color: #f9fafb; /* gray-50 */
}
.declaration-group summary::after {
    content: '+';
    font-size: 1.5rem;
    font-weight: 500;
    color: #6b7280; /* gray-500 */
    transition: transform 0.2s ease-in-out;
}
.declaration-group[open] > summary::after {
    transform: rotate(45deg);
    content: '√ó';
}
.declaration-content {
    padding: 1rem 0.5rem 1.5rem 0.5rem;
}
/* === END: Declaration Accordion Styles === */

/* === START: Pasted Competition Column Toggles & Header Wrap (v6.15) === */

/* Container for the toggle buttons */
#pasted-competition-column-toggles {
    padding: 0.75rem;
    border-bottom: 1px solid #e5e7eb;
    display: flex;
    flex-wrap: wrap;
    align-items: center;
    gap: 0.5rem 0.25rem;
    background-color: #f9fafb; /* gray-50 */
}

/* Label for the toggles */
#pasted-competition-column-toggles .non-draggable {
    font-size: 0.875rem; /* text-sm */
    font-weight: 600; /* font-semibold */
    margin-right: 0.5rem; /* mr-2 */
    color: #374151; /* gray-700 */
}

/* Styles for the table headers to allow wrapping */
#pasted-competition-report-container table th {
    white-space: normal; /* Allow text wrapping */
    vertical-align: middle;
    line-height: 1.3;
    max-width: 150px; /* Set a max-width */
    width: 120px; /* Set a base width */
}

/* Keep employee name header slightly wider and no-wrap */
#pasted-competition-report-container table th[data-sort="hoTen"] {
    white-space: nowrap;
    width: 150px;
    min-width: 150px;
}
/* === END: Pasted Competition Styles === */

/* === START: LOGIN MODAL STYLES (V6.7) === */
#login-modal .modal__overlay {
    cursor: not-allowed;
}

#login-modal .modal__container {
    box-shadow: 0 25px 50px -12px rgb(0 0 0 / 0.25);
}

#login-modal input[type="email"]:focus {
    border-color: #3b82f6;
    box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.4);
    outline: none;
}
/* === END: LOGIN MODAL STYLES === */

/* === START: Sticky Columns for Pasted Competition Table (v1.1) === */

/* 1. Container: Ph·∫£i b·∫≠t 'overflow-x-auto' (ƒë√£ c√≥) v√† 'position: relative' (quan tr·ªçng) */
.sknv-pasted-competition-scroller {
    position: relative; /* B·∫Øt bu·ªôc ƒë·ªÉ z-index c·ªßa sticky ho·∫°t ƒë·ªông */
}

/* 2. C√°c √¥ ti√™u ƒë·ªÅ (th) c·∫ßn "ƒë√≥ng bƒÉng" */
#pasted-competition-report-container table th.sticky-col {
    position: -webkit-sticky; /* cho Safari */
    position: sticky;
    z-index: 2; /* Ph·∫£i cao h∆°n z-index c·ªßa c√°c √¥ (td) */
    background-color: #e5e7eb; /* gray-200 (m√†u n·ªÅn thead) - R·∫•t quan tr·ªçng */
}

/* 3. C√°c √¥ d·ªØ li·ªáu (td) c·∫ßn "ƒë√≥ng bƒÉng" */
#pasted-competition-report-container table td.sticky-col {
    position: -webkit-sticky; /* cho Safari */
    position: sticky;
    z-index: 1; /* Ph·∫£i cao h∆°n c√°c √¥ td kh√°c, nh∆∞ng th·∫•p h∆°n th */
    background-color: #ffffff; /* M√†u n·ªÅn c·ªßa d√≤ng (tr·∫Øng) */
}

/* 4. ƒê·∫£m b·∫£o d√≤ng ch·∫µn/l·∫ª c≈©ng ƒë∆∞·ª£c ghi ƒë√® m√†u n·ªÅn */
#pasted-competition-report-container table tr:nth-child(even) td.sticky-col {
    background-color: #f9fafb; /* gray-50 (m√†u d√≤ng ch·∫µn) */
}

/* 5. ƒê·ªãnh v·ªã cho t·ª´ng c·ªôt */
.sticky-col.sticky-col-1 {
    left: 0; /* C·ªôt ƒë·∫ßu ti√™n */
}

.sticky-col.sticky-col-2 {
    left: 150px; /* C·ªôt th·ª© 2 - Ph·∫£i b·∫±ng ƒë·ªô r·ªông c·ªßa c·ªôt 1 (min-width: 150px t·ª´ CSS c≈©) */
}

/* 6. (An to√†n) ƒê·∫£m b·∫£o footer c≈©ng ƒë∆∞·ª£c "ƒë√≥ng bƒÉng" */
#pasted-competition-report-container table tfoot td.sticky-col {
    background-color: hsl(210, 20%, var(--header-lightness)); /* M√†u footer */
    z-index: 3; /* N·∫±m tr√™n c·∫£ ti√™u ƒë·ªÅ v√† n·ªôi dung */
}
/* === END: Sticky Columns (v1.1) === */

/* === START: Y√äU C·∫¶U 2 (v1.2) - S·ª≠a l·ªói con tr·ªè k√©o th·∫£ === */
.column-toggle-btn {
    /* M·∫∑c ƒë·ªãnh l√† pointer ƒë·ªÉ ng∆∞·ªùi d√πng bi·∫øt c√≥ th·ªÉ click b·∫≠t/t·∫Øt */
    cursor: pointer;
}

.column-toggle-btn .drag-handle-icon {
    /* Ch·ªâ ri√™ng icon k√©o m·ªõi c√≥ cursor grab */
    cursor: grab;
}

.column-toggle-btn .drag-handle-icon:active {
    /* Khi ƒëang k√©o icon */
    cursor: grabbing;
}
/* === END: Y√äU C·∫¶U 2 (v1.2) === */

/* === START: UPDATED STYLES (v1.4) - "Multi-lane" Layout & Text Wrap === */

/* Container cho m·ªói "l√†n ƒë∆∞·ªùng" (ƒê·∫°t, G·∫ßn ƒê·∫°t, C·∫ßn C·ªë G·∫Øng) */
.sknv-thidua-lane {
    display: flex;
    flex-direction: column;
}

/* Container ch·ª©a c√°c th·∫ª card, cho ph√©p x·∫øp h√†ng ngang v√† xu·ªëng d√≤ng */
.sknv-thidua-horizontal-content {
    padding: 0.75rem; /* p-3 */
    display: flex;
    flex-direction: row; /* X·∫øp h√†ng ngang */
    flex-wrap: wrap;     /* T·ª± ƒë·ªông xu·ªëng d√≤ng */
    gap: 0.75rem;        /* Kho·∫£ng c√°ch gi·ªØa c√°c th·∫ª */
}

/* Th√¥ng b√°o khi l√†n ƒë∆∞·ªùng tr·ªëng */
.sknv-thidua-horizontal-content .empty-col-msg {
    font-size: 0.875rem; /* text-sm */
    color: #6b7280; /* gray-500 */
    text-align: center;
    padding: 1rem 0;
    font-style: italic;
    width: 100%; /* Chi·∫øm to√†n b·ªô chi·ªÅu r·ªông c·ªßa l√†n ƒë∆∞·ªùng */
}

/* Th·∫ª chi ti·∫øt t·ª´ng ng√†nh h√†ng (Y√™u c·∫ßu 3 - Layout) */
.sknv-thidua-item-card {
    background-color: #ffffff; /* bg-white */
    border-radius: 0.5rem; /* rounded-lg */
    border: 1px solid #e5e7eb; /* border */
    padding: 0.75rem; /* p-3 */
    box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05); /* shadow-sm */
    transition: all 0.2s ease-in-out;
    
    /* Logic x·∫øp h√†ng ngang: */
    /* === START: Y√äU C·∫¶U 3 (v1.6) === */
    flex: 1 1 180px; /* Th·∫ª c√≥ th·ªÉ co gi√£n, c∆° s·ªü l√† 180px (thay v√¨ 220px) */
    min-width: 180px; /* Chi·ªÅu r·ªông t·ªëi thi·ªÉu 180px (thay v√¨ 220px) */
    /* === END: Y√äU C·∫¶U 3 (v1.6) === */
} 
.sknv-thidua-item-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1); /* shadow-md */
}

/* Ti√™u ƒë·ªÅ ng√†nh h√†ng (Y√™u c·∫ßu 1 - Text Wrap) */
.item-card-title {
    font-weight: 600; /* font-semibold */
    color: #1f2937; /* gray-800 */
    margin-bottom: 0.5rem; /* mb-2 */
    
    /* B·∫Øt ƒë·∫ßu s·ª≠a l·ªói wrap text */
    white-space: normal; /* Cho ph√©p xu·ªëng d√≤ng */
    display: -webkit-box;
    -webkit-line-clamp: 2; /* Gi·ªõi h·∫°n 2 d√≤ng */
    line-clamp: 2; /* === TH√äM M·ªöI (v1.5) - S·ª≠a l·ªói t∆∞∆°ng th√≠ch === */
    -webkit-box-orient: vertical;
    overflow: hidden;
    text-overflow: ellipsis;
    min-height: 2.5em; /* ƒê·∫£m b·∫£o ƒë·ªß chi·ªÅu cao cho 2 d√≤ng (line-height 1.25) */
    line-height: 1.25;
    /* K·∫øt th√∫c s·ª≠a l·ªói wrap text */
}

/* C√°c style c√≤n l·∫°i c·ªßa th·∫ª ƒë∆∞·ª£c gi·ªØ nguy√™n */
.item-card-progress-bar-container {
    width: 100%;
    background-color: #e5e7eb; /* gray-200 */
    border-radius: 9999px; /* rounded-full */
    height: 0.75rem; /* h-3 */
    overflow: hidden;
    margin-bottom: 0.5rem; /* mb-2 */
}
.item-card-progress-bar {
    height: 100%;
    border-radius: 9999px;
    transition: width 0.5s ease-in-out;
}
.item-card-metrics {
    font-size: 0.75rem; /* text-xs */
    color: #4b5563; /* gray-600 */
    display: flex;
    justify-content: space-between;
    flex-wrap: wrap;
    gap: 0.25rem 0.5rem; /* gap-x-2 gap-y-1 */
}
.item-card-metrics strong {
    font-weight: 600;
    color: #111827; /* gray-900 */
}
.item-card-metrics .text-green-600 { color: #16a34a; }
.item-card-metrics .text-red-600 { color: #dc2626; }

/* === END: UPDATED STYLES (v1.4) === */


/* === START: S·ª¨A L·ªñI (v1.3) - CƒÉn ch·ªânh icon cho th·∫ª KPI === */
.rt-infographic-summary-card .label {
    font-size: 0.875em;
    color: #4b5563;
    font-weight: 500;
    /* Th√™m c√°c thu·ªôc t√≠nh flex ƒë·ªÉ cƒÉn ch·ªânh icon */
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.25rem; /* 4px */
}
.rt-infographic-summary-card .label .feather {
    width: 1em;
    height: 1em;
}
/* === END: S·ª¨A L·ªñI (v1.3) === */

/* === START: Y√äU C·∫¶U 5 (v1.6) - L√†m d·ªãu m√†u header === */
.sknv-thidua-column-header {
    display: flex;
    align-items: center;
    gap: 0.5rem; /* gap-2 */
    padding: 0.75rem 1rem; /* p-3 */
    border-bottom: 1px solid; /* C·∫≠p nh·∫≠t border color b√™n d∆∞·ªõi */
} 
.sknv-thidua-column-header .feather {
    width: 1.25rem; /* h-5 w-5 */
    height: 1.25rem;
    stroke-width: 2.5;
}
.sknv-thidua-column-header h4 {
    font-size: 1.125rem; /* text-lg */
    font-weight: 700; /* font-bold */
}
.sknv-thidua-column-header.header-blue {
    background-color: #dbeafe; /* blue-100 */
    color: #1e40af; /* blue-800 */
    border-color: #bfdbfe; /* blue-200 */
} 
.sknv-thidua-column-header.header-yellow {
    background-color: #fef9c3; /* yellow-100 */
    color: #854d0e; /* yellow-800 */
    border-color: #fde68a; /* yellow-200 */
} 
.sknv-thidua-column-header.header-red {
    background-color: #fee2e2; /* red-100 */
    color: #991b1b; /* red-800 */
    border-color: #fecaca; /* red-200 */
} 
/* === END: Y√äU C·∫¶U 5 (v1.6) === */


/* === START: (v1.6) Y√™u c·∫ßu t√πy ch·ªânh cho chi ti·∫øt thi ƒëua (Y√™u c·∫ßu 1 & 4) === */

/* Y√™u c·∫ßu 1: Ghi ƒë√® header nh√¢n vi√™n (lo·∫°i b·ªè m√†u t√≠m) */
#sknv-thidua-detail-capture-area .sknv-detail-header-card {
    background-color: #ffffff !important;
    border-color: #e5e7eb !important;
    border-top-width: 4px !important;
    border-top-color: #6b7280 !important; /* gray-500 */
} 
/* === START: THAY ƒê·ªîI (v1.7) === */
#sknv-thidua-detail-capture-area .sknv-detail-header-card .name {
    color: #166534 !important; /* YC 1 (v1.7): ƒê·ªïi sang xanh l√° c√¢y ƒë·∫≠m (green-800) */
} 
/* === END: THAY ƒê·ªîI (v1.7) === */
#sknv-thidua-detail-capture-area .sknv-detail-header-card .department {
    color: #374151 !important; /* gray-700 */
} 
#sknv-thidua-detail-capture-area .sknv-detail-header-card .sknv-card__avatar {
    background-color: #e5e7eb !important; /* gray-200 */
} 
#sknv-thidua-detail-capture-area .sknv-detail-header-card .sknv-card__avatar svg {
    color: #374151 !important; /* gray-700 */
} 

/* Y√™u c·∫ßu 4: Th√™m m√†u cho c√°c th·∫ª KPI */
.rt-infographic-summary-card .value.is-dat {
    color: #16a34a !important; /* green-600 */
} 
.rt-infographic-summary-card .value.is-positive {
    color: #2563eb !important; /* blue-600 */
} 
.rt-infographic-summary-card .value.is-gan-dat {
    color: #f59e0b !important; /* amber-500 */
} 
.rt-infographic-summary-card .value.is-can-co-gang,
.rt-infographic-summary-card .value.is-negative {
    color: #dc2626 !important; /* red-600 */
} 
/* === START: SKNV Rank Number Styles (Design Soft Blue) === */

/* Top 3 Rank Style */
.sknv-card__avatar-rank {
    /* Style m·∫∑c ƒë·ªãnh cho s·ªë c·ªßa Top 3 (ƒë∆∞·ª£c override b·ªüi inline class trong MedalIcon cho m√†u tr·∫Øng) */
    text-shadow: 0 1px 2px rgba(0,0,0,0.3);
}

/* Rank 4+ Circle Style */
.sknv-card__avatar--standard {
    /* N·ªÅn Gradient Xanh d∆∞∆°ng ph·∫•n */
    background: linear-gradient(145deg, #eff6ff, #dbeafe) !important;
    
    /* Vi·ªÅn Xanh d∆∞∆°ng s√°ng */
    border: 2px solid #93c5fd !important;
    
    /* ƒê·ªï b√≥ng n·ªïi kh·ªëi 3D */
    box-shadow: 
        3px 3px 6px rgba(37, 99, 235, 0.15), 
        -3px -3px 6px rgba(255, 255, 255, 0.8) !important;
    
    /* K√≠ch th∆∞·ªõc */
    width: 44px;
    height: 44px;
    border-radius: 50%;
    
    /* CƒÉn gi·ªØa s·ªë */
    display: flex;
    align-items: center;
    justify-content: center;
    
    /* CƒÉn v·ªã tr√≠ so v·ªõi Card */
    margin-top: 2px;
    margin-left: 2px;
}

/* Rank 4+ Text Style */
.sknv-card__avatar--standard .sknv-card__avatar-rank {
    color: #1e40af !important; /* Xanh d∆∞∆°ng ƒë·∫≠m */
    font-size: 1.25rem;
    font-weight: 800;
    text-shadow: none; /* B·ªè b√≥ng c·ªßa Top 3 */
    font-family: 'Inter', sans-serif;
}
/* === END: SKNV Rank Number Styles === */

--- END FILE: ./src/styles/specific-sknv.css ---

--- START FILE: ./src/styles/specific-tdv.css ---
/* Version 1.0 - Specific: TDV (Refactored from v6.19) */
/* Ch·ª©a c√°c style CH·ªà d√†nh ri√™ng cho tab Thi ƒêua V√πng (TDV) */

/* === B·∫ÆT ƒê·∫¶U: B·ªê C·ª§C CHO THI ƒêUA V√ôNG & THI ƒêUA L≈®Y K·∫æ (V5.9) === */
.tdv-rows-container { 
    display: flex; 
    flex-direction: column; 
    gap: 1.5rem; 
}
#subtab-luyke-thi-dua .tdv-row-body {
    display: grid;
    grid-template-columns: 1fr; /* M·∫∑c ƒë·ªãnh 1 c·ªôt cho mobile */
    gap: 1rem;
}
@media (min-width: 768px) { /* 2 c·ªôt cho tablet tr·ªü l√™n */
    #subtab-luyke-thi-dua .tdv-row-body {
        grid-template-columns: repeat(2, 1fr);
    }
}
/* === END: B·ªê C·ª§C M·ªöI === */

.tdv-infographic-card {
    background-color: transparent;
    border: none;
    box-shadow: none;
    padding: 0;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
}
.tdv-header { 
    text-align: center; 
    margin-bottom: 2rem; 
}
.tdv-supermarket-name { 
    font-size: 2em; 
    font-weight: bold; 
    color: #005f73; 
}
.tdv-total-prize-container { 
    margin-top: 0.5rem; 
    font-size: 1.5em; 
    font-weight: bold; 
}
.tdv-total-prize-label { 
    color: #6b7280; 
    font-weight: normal; 
}
.tdv-total-prize-value { 
    color: #d90429; 
    margin-left: 0.5rem; 
}

.tdv-summary-grid { 
    display: grid; 
    grid-template-columns: repeat(2, 1fr); 
    gap: 1rem; 
    margin-top: 1.5rem; 
    margin-bottom: 2rem; 
}
@media (min-width: 768px) { 
    .tdv-summary-grid { 
        grid-template-columns: repeat(5, 1fr); 
    } 
}
.tdv-summary-item { 
    background-color: #ffffff; 
    border-radius: 8px;
    padding: 1rem; 
    text-align: center; 
    box-shadow: 0 2px 4px rgba(0,0,0,0.05); 
    border: 1px solid #e5e7eb;
}
/* === START: S·ª≠a m√†u v√† font-weight cho .tdv-summary-value === */
.tdv-summary-value {
    display: block;
    font-size: 1.75em;
    font-weight: 800; /* TƒÉng ƒë·ªô ƒë·∫≠m */
    color: #005f73; /* ƒê·ªïi m√†u xanh ƒë·∫≠m h∆°n */
}
/* === END: S·ª≠a m√†u === */
.tdv-summary-label { 
    display: block; 
    font-size: 0.9em; 
    color: #4a5568; 
    margin-top: 0.25rem; 
}
/* === START: Th√™m class m√†u cho t·ª∑ l·ªá ƒë·∫°t === */
.tdv-tyledat-high { 
    color: #2563eb !important; /* blue-600 */
} 
.tdv-tyledat-low { 
    color: #dc2626 !important; /* red-600 */
} 
/* === END: Th√™m class m√†u === */

.tdv-row { 
    background-color: #fdfdfd; 
    border-radius: 8px; 
    padding: 1rem; 
    border: 1px solid #dee2e6; 
}
.tdv-row-title { 
    font-size: 1.2em; 
    font-weight: bold;
    padding-bottom: 0.75rem; 
    margin-bottom: 1rem; 
    border-bottom: 2px solid; 
    line-height: 1.3; 
}
.tdv-row-title--prize { 
    border-color: #0d6efd; 
    color: #0d6efd; 
}
.tdv-row-title--soon-prize { 
    border-color: #e9c46a; 
    color: #e9c46a; 
}
.tdv-row-title--effort { 
    border-color: #6c757d; 
    color: #6c757d; 
}
.tdv-row-subtitle { 
    font-size: 0.8em; 
    font-weight: normal; 
    color: #d90429; 
}

/* === START: S·ª≠a layout 4 c·ªôt cho Thi ƒëua v√πng (S·ª¨A L·∫†I SELECTOR) === */
/* *** FIX: Corrected CSS selector to use #subtab-luyke-thidua-vung *** */
#subtab-luyke-thidua-vung .tdv-row-body {
    display: grid;
    grid-template-columns: repeat(1, 1fr); /* 1 c·ªôt cho mobile */
    gap: 1rem;
}
@media (min-width: 768px) { /* 2 c·ªôt cho tablet */
    #subtab-luyke-thidua-vung .tdv-row-body {
        grid-template-columns: repeat(2, 1fr);
    }
}
@media (min-width: 1280px) { /* 4 c·ªôt cho desktop l·ªõn */
    #subtab-luyke-thidua-vung .tdv-row-body {
        grid-template-columns: repeat(4, 1fr);
    }
}
/* === END: S·ª≠a layout === */
.tdv-row-body--effort { 
    display: block; 
}

.tdv-item-card { 
    background: #fff; 
    border: 1px solid #e0e0e0; 
    border-radius: 6px;
    padding: 12px; 
    box-shadow: 0 1px 3px rgba(0,0,0,0.05); 
    overflow: hidden; 
}
.tdv-item-card__title { 
    font-weight: bold;
    margin: 0 0 10px 0; 
    color: #333; 
}
.tdv-progress-bar-container {
    width: 100%;
    background-color: #e9ecef;
    border-radius: 20px;
    height: 28px;
    position: relative;
    font-size: 0.85em;
    font-weight: bold;
    overflow: hidden;
    display: flex;
    align-items: center;
    justify-content: center;
}
.tdv-progress-bar { 
    height: 100%; 
    transition: width 0.5s ease; 
    position: absolute; 
    top: 0; 
    left: 0; 
}
.tdv-progress-bar--blue { 
    background-color: #0d6efd; 
}
.tdv-progress-bar--yellow { 
    background-color: #e9c46a; 
}
.tdv-progress-bar__text {
    position: relative;
    z-index: 1;
    text-shadow: 1px 1px 2px rgba(0,0,0,0.4);
    color: white;
}
.tdv-item-card__details { 
    font-size: 0.85em; 
    color: #555; 
    margin-top: 8px; 
    display: grid; 
    grid-template-columns: repeat(3, 1fr); 
    gap: 5px; 
}
.tdv-item-card__details span { 
    display: block; 
}
.tdv-item-card__details strong { 
    color: #000; 
}
.tdv-item-card__prize { 
    grid-column: 1 / -1; 
    font-weight: bold !important; 
    color: #d90429; 
    margin-top: 4px; 
}

.tdv-effort-subgroup { 
    margin-bottom: 1rem; 
}
.tdv-effort-subgroup:last-child { 
    margin-bottom: 0; 
}
.tdv-effort-subgroup__title { 
    font-weight: bold; 
    margin: 0 0 10px 0; 
    padding-bottom: 5px; 
    border-bottom: 1px solid #dee2e6; 
}
.tdv-effort-subgroup__title--potential { 
    color: #fd7e14; 
}
.tdv-effort-subgroup__title--major { 
    color: #6c757d; 
}
.tdv-effort-list { 
    display: flex; 
    flex-wrap: wrap; 
    gap: 8px; 
}
.tdv-effort-item { 
    background-color: #f1f3f5; 
    color: #495057; 
    padding: 5px 10px; 
    border-radius: 15px; 
    font-size: 0.9em; 
}
--- END FILE: ./src/styles/specific-tdv.css ---

--- START FILE: ./src/styles/tables.css ---
/* Version 1.0 - Tables styles (Refactored from v6.19) */
/* Ch·ª©a c√°c class chung cho b·∫£ng bi·ªÉu: borders, striping, header colors, sort indicators */

.table-bordered { 
    border-collapse: collapse; 
}
.table-bordered th, .table-bordered td { 
    border: 1px solid #e5e7eb; 
}
.table-striped tbody tr:nth-child(even) { 
    background-color: #f9fafb; 
}
.table-footer { 
    background-color: hsl(210, 20%, var(--header-lightness));
    border-top: 2px solid #9ca3af; 
}
.cell-performance.is-below { 
    background-color: hsl(0, 80%, var(--below-target-lightness)) !important; 
}

/* === Sort Indicators === */
.sortable { 
    cursor: pointer; 
    position: relative; 
    user-select: none; 
}
.sort-indicator { 
    display: inline-flex; 
    flex-direction: column; 
    align-items: center; 
    justify-content: center; 
    width: 1em; 
    height: 1em; 
    margin-left: 4px; 
    vertical-align: middle; 
    color: #9ca3af; 
    transition: color 0.2s ease-in-out; 
}
.sortable .sort-indicator::before { 
    content: '‚ñ≤'; 
    font-size: 0.8em; 
    line-height: 0.5; 
    opacity: 0.4; 
}
.sortable .sort-indicator::after { 
    content: '‚ñº'; 
    font-size: 0.8em; 
    line-height: 0.5; 
    opacity: 0.4; 
}
.sortable:hover .sort-indicator { 
    color: #374151; 
}
.sortable.sorted-asc .sort-indicator::before { 
    opacity: 1; 
    color: #3b82f6; 
}
.sortable.sorted-asc .sort-indicator::after { 
    opacity: 0.4; 
}
.sortable.sorted-desc .sort-indicator::after { 
    opacity: 1; 
    color: #3b82f6; 
}
.sortable.sorted-desc .sort-indicator::before { 
    opacity: 0.4;
}

/* === Draggable Headers === */
.draggable-header {
    cursor: move;
    cursor: grab;
}
.draggable-header:active {
    cursor: grabbing;
}
.sortable-ghost {
    opacity: 0.4;
    background-color: #c7d2fe; /* indigo-200 */
}
.sortable-drag {
    opacity: 0.95;
    transform: rotate(-2deg);
    box-shadow: 0 8px 16px rgba(0,0,0,0.2);
}


/* === Table Header Colors === */
.header-bg-blue { background-color: hsl(217, 95%, var(--special-header-lightness)) !important; color: hsl(217, 80%, var(--header-text-lightness)) !important; }
.header-bg-green { background-color: hsl(145, 80%, var(--special-header-lightness)) !important; color: hsl(145, 70%, var(--header-text-lightness)) !important; }
.header-bg-yellow { background-color: hsl(45, 95%, var(--special-header-lightness)) !important; color: hsl(45, 80%, var(--header-text-lightness)) !important; }

.header-group-1 { background-color: hsl(30, 90%, var(--header-lightness)); }
.header-group-2 { background-color: hsl(90, 90%, var(--header-lightness)); }
.header-group-3 { background-color: hsl(180, 90%, var(--header-lightness)); }
.header-group-4 { background-color: hsl(240, 90%, var(--header-lightness)); }
.header-group-5 { background-color: hsl(300, 90%, var(--header-lightness)); }
.header-group-6 { background-color: hsl(0, 90%, var(--header-lightness)); }
.header-group-7 { background-color: hsl(160, 80%, var(--header-lightness)) !important; }
.header-group-8 { background-color: hsl(280, 80%, var(--header-lightness)) !important; }
.header-group-9 { background-color: hsl(70, 80%, var(--header-lightness)) !important; }
.header-group-10 { background-color: hsl(190, 80%, var(--header-lightness)) !important; }
.header-group-11 { background-color: hsl(340, 80%, var(--header-lightness)) !important; }
.header-group-12 { background-color: hsl(20, 80%, var(--header-lightness)) !important; }

.department-header-tv { background-color: #e0e7ff; color: #3730a3; }
.department-header-kho { background-color: #d1fae5; color: #065f46; }
.department-header-tt { background-color: #fef3c7; color: #92400e; }
.category-header-ict { background-color: #dbeafe; color: #1e40af; }
.category-header-phukien { background-color: #fee2e2; color: #991b1b; }
.category-header-giadung { background-color: #fef9c3; color: #854d0e; }
.category-header-ce { background-color: #e0f2fe; color: #0c4a6e; }
.category-header-baohiem { background-color: #f3e8ff; color: #6b21a8; }
.header-bg-indigo { background-color: #e0e7ff; color: #3730a3; }
.header-bg-purple { background-color: #f3e8ff; color: #6b21a8; }

.qdc-group-title { font-weight: 600; }
.qdc-group-ict { background-color: hsl(190, 80%, var(--special-header-lightness)); }
.qdc-group-vas { background-color: hsl(140, 80%, var(--special-header-lightness)); }
.qdc-group-giadung { background-color: hsl(0, 80%, var(--special-header-lightness)); }
.qdc-group-sim { background-color: hsl(40, 80%, var(--special-header-lightness)); }

.competition-header-doanhthu { border-color: #a78bfa; background-color: hsl(260, 90%, var(--bg-lightness)); }
.competition-header-soluong { border-color: #facc15; background-color: hsl(50, 90%, var(--bg-lightness)); }
.header-highlight-special { background-color: hsl(25, 90%, var(--header-lightness)) !important; }
.competition-row-below-100 td { background-color: #fee2e2; color: #991b1b; }

.header-highlight { background-color: hsl(50, 95%, var(--special-header-lightness)) !important; }
--- END FILE: ./src/styles/tables.css ---

--- START FILE: ./src/styles/vendor.css ---
/* Version 1.0 - Vendor overrides (Refactored from v6.19) */
/* Ch·ª©a c√°c style ghi ƒë√® l√™n th∆∞ vi·ªán b√™n th·ª© ba, v√≠ d·ª•: Choices.js */

#dtnv-realtime-employee-selector-container .choices__inner { 
    min-width: 300px; 
}
#dtnv-realtime-employee-selector-container .choices__list--single { 
    min-width: 300px; 
}

.choices__inner { 
    min-height: 42px; 
}
.choices__list--multiple .choices__item { 
    background-color: #3b82f6; 
    border-color: #2563eb; 
}

#goal-drawer .choices__inner {
    min-width: 250px;
}

#goal-drawer .choices__list--dropdown,
#goal-drawer .choices__list[aria-expanded] {
    min-width: 100%;
    width: auto;
    word-break: normal;
}

#goal-drawer .choices__list--multiple .choices__item {
    display: inline-flex;
    align-items: center;
    background-color: #3b82f6;
    border: 1px solid #2563eb;
    color: white;
    border-radius: 9999px;
    padding: 2px 8px;
    font-size: 0.8em;
    font-weight: 500;
    margin: 2px 4px 2px 0;
}
#goal-drawer .choices__inner {
    height: auto !important;
    min-height: 42px !important;
    display: flex !important;
    flex-wrap: wrap !important;
}
--- END FILE: ./src/styles/vendor.css ---

--- START FILE: ./src/utils/capture.utils.js ---
// Version 2.0 - Restore Logic from Legacy Project (Fix Blank Image)
import { get } from 'svelte/store';
import { charts } from '../stores.js'; // Store ch·ª©a instance bi·ªÉu ƒë·ªì

/**
 * Ch√®n CSS styles ƒë·ªông ƒë·ªÉ ƒë·ªãnh d·∫°ng ·∫£nh ch·ª•p (Gi·ªëng h·ªát file g·ªëc)
 */
export const injectCaptureStyles = () => {
    const styleId = 'dynamic-capture-styles';
    document.getElementById(styleId)?.remove();

    const styles = `
        .capture-container { 
            padding: 24px; 
            background-color: #f3f4f6; 
            box-sizing: border-box; 
            width: fit-content; 
            position: absolute;
            /* QUAN TR·ªåNG: D√πng left -9999px thay v√¨ opacity/display none ƒë·ªÉ ƒë·∫£m b·∫£o render */
            left: -9999px;
            top: 0;
            z-index: -1;
        }
        .capture-layout-container { 
            display: flex; 
            flex-direction: column; 
            gap: 24px; 
        }
        .capture-title { 
            font-size: 28px; 
            font-weight: 700; 
            text-align: center; 
            color: #1f2937; 
            margin-bottom: 24px; 
            padding: 12px; 
            background-color: #ffffff; 
            border-radius: 0.75rem; 
            box-shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1), 0 1px 2px -1px rgb(0 0 0 / 0.1); 
        }
        /* --- VIRTUAL STAGES / PRESETS --- */
        .prepare-for-kpi-capture {
            display: grid !important;
            grid-template-columns: repeat(2, 1fr) !important;
            gap: 24px !important;
            width: 900px !important;
        }
        .preset-mobile-portrait {
            width: 550px !important; 
        }
        .preset-landscape-table {
            width: fit-content !important;
        }
        .preset-landscape-table table {
            table-layout: fixed !important;
        }
        .preset-landscape-table th, 
        .preset-landscape-table td {
            width: 95px !important;
            word-wrap: break-word;
        }
        .preset-landscape-table th:first-child,
        .preset-landscape-table td:first-child {
            width: 180px !important;
        }
        .preset-large-font-report {
            width: 800px !important;
        }
        .preset-large-font-report table th {
            white-space: normal !important;
            vertical-align: middle;
        }
        .preset-large-font-report table td {
            font-size: 22px !important;
            vertical-align: middle;
        }
        .preset-infographic-wide {
            width: 1100px !important;
        }
    `;

    const styleElement = document.createElement('style');
    styleElement.id = styleId;
    styleElement.innerHTML = styles;
    document.head.appendChild(styleElement);
    return styleElement;
};

/**
 * T√¨m v√† thay th·∫ø t·∫•t c·∫£ <canvas> c·ªßa Chart.js b·∫±ng <img> tƒ©nh.
 * Logic n√†y kh·∫Øc ph·ª•c l·ªói ·∫£nh tr·∫Øng ·ªü bi·ªÉu ƒë·ªì.
 * @param {HTMLElement} element - V√πng DOM (clone) s·∫Øp ƒë∆∞·ª£c ch·ª•p.
 */
export const swapCanvasToImage = (element) => {
    console.log("[CaptureUtils] B·∫Øt ƒë·∫ßu chuy·ªÉn ƒë·ªïi Canvas sang ·∫¢nh...");
    const canvasElements = element.querySelectorAll('canvas');
    let replacedCount = 0;
    
    // L·∫•y danh s√°ch chart instance t·ª´ store Svelte
    const $charts = get(charts);

    canvasElements.forEach(canvas => {
        const chartId = canvas.id;
        
        // C√°ch 1: Th·ª≠ l·∫•y t·ª´ Store (n·∫øu Chart Component ƒë√£ ƒëƒÉng k√Ω)
        if (chartId && $charts[chartId]) {
            try {
                const chart = $charts[chartId];
                const base64Image = chart.toBase64Image(); // L·∫•y ·∫£nh tƒ©nh t·ª´ Chart.js
                
                if (base64Image) {
                    replaceCanvasWithImg(canvas, base64Image);
                    replacedCount++;
                    return;
                }
            } catch (e) {
                console.error(`[CaptureUtils] L·ªói khi l·∫•y ·∫£nh t·ª´ chart '${chartId}':`, e);
            }
        }

        // C√°ch 2: Fallback - Th·ª≠ l·∫•y tr·ª±c ti·∫øp t·ª´ canvas element (n·∫øu kh√¥ng c√≥ trong store)
        // C√°ch n√†y ho·∫°t ƒë·ªông n·∫øu canvas g·ªëc ƒë√£ ƒë∆∞·ª£c render xong
        try {
            // T√¨m canvas g·ªëc trong DOM th·∫≠t (kh√¥ng ph·∫£i b·∫£n clone)
            const originalCanvas = document.getElementById(chartId);
            if (originalCanvas) {
                const base64Image = originalCanvas.toDataURL('image/png');
                if (base64Image && base64Image !== 'data:,') {
                    replaceCanvasWithImg(canvas, base64Image);
                    replacedCount++;
                }
            }
        } catch (e) {
            console.warn(`[CaptureUtils] Kh√¥ng th·ªÉ fallback toDataURL cho ${chartId}`);
        }
    });
    console.log(`[CaptureUtils] ƒê√£ ho√°n ƒë·ªïi th√†nh c√¥ng ${replacedCount} bi·ªÉu ƒë·ªì.`);
};

// Helper thay th·∫ø node
function replaceCanvasWithImg(canvasNode, src) {
    const img = document.createElement('img');
    img.src = src;
    // Gi·ªØ nguy√™n k√≠ch th∆∞·ªõc ƒë·ªÉ tr√°nh v·ª° layout
    img.style.width = canvasNode.style.width || `${canvasNode.width}px`;
    img.style.height = canvasNode.style.height || `${canvasNode.height}px`;
    img.style.display = 'block';
    
    // Copy c√°c class c≈© sang
    img.className = canvasNode.className;
    
    // Thay th·∫ø canvas b·∫±ng img
    if (canvasNode.parentNode) {
        canvasNode.parentNode.replaceChild(img, canvasNode);
    }
}
--- END FILE: ./src/utils/capture.utils.js ---

--- START FILE: ./src/utils/formatters.js ---
// src/utils/formatters.js
// Version 4.0 - Format 0 as "-"
export const formatters = {
    /**
     * ƒê·ªãnh d·∫°ng s·ªë l∆∞·ª£ng. 0 -> "-"
     */
    formatNumber: (value, decimals = 0) => {
        if (!isFinite(value) || value === null || value === 0) return '-';
        return new Intl.NumberFormat('vi-VN', { minimumFractionDigits: decimals, maximumFractionDigits: decimals }).format(value);
    },

    /**
     * ƒê·ªãnh d·∫°ng doanh thu (chia cho 1 tri·ªáu). 0 -> "-"
     */
    formatRevenue(value, decimals = 1) {
         if (!isFinite(value) || value === null) return '-';
         
         // N·∫øu gi√° tr·ªã qu√° nh·ªè (g·∫ßn b·∫±ng 0) -> tr·∫£ v·ªÅ "-"
         if (Math.abs(value) < 1000) return '-'; 

         const millions = value / 1000000;
         return new Intl.NumberFormat('vi-VN', {
             minimumFractionDigits: 0,
             maximumFractionDigits: decimals
         }).format(millions);
     },

     /**
      * ƒê·ªãnh d·∫°ng s·ªë th∆∞·ªùng (gi·ªØ nguy√™n logic c≈© cho c√°c tr∆∞·ªùng h·ª£p kh√°c)
      */
     formatNumberOrDash: (value, decimals = 1) => {
          if (!isFinite(value) || value === null || Math.abs(value) < 0.01) return '-';
          return new Intl.NumberFormat('vi-VN', {
              minimumFractionDigits: 0,
              maximumFractionDigits: decimals
          }).format(value);
      },

      /**
       * ƒê·ªãnh d·∫°ng ph·∫ßn trƒÉm. 0 -> "-"
       */
     formatPercentage: (value, decimals = 0) => {
          if (!isFinite(value) || value === null) return '-';
          
          // Ki·ªÉm tra s·ªë 0 tuy·ªát ƒë·ªëi ho·∫∑c r·∫•t nh·ªè
          if (Math.abs(value) < 0.0001) return '-';

          const percentageValue = value * 100;
          return new Intl.NumberFormat('vi-VN', {
             minimumFractionDigits: decimals,
             maximumFractionDigits: decimals
          }).format(percentageValue) + '%';
      },

    getShortEmployeeName(hoTen, maNV) {
        if (!hoTen) return maNV || '';
        const nameParts = hoTen.split(' ').filter(p => p);
        let displayName = hoTen;
        if (nameParts.length > 2) {
            displayName = nameParts.slice(-2).join(' ');
        }
        return `${displayName} - ${maNV}`;
    },
};
--- END FILE: ./src/utils/formatters.js ---

--- START FILE: ./src/components/admin/AdminCalculation.svelte ---
<script>
    import { onMount, afterUpdate } from 'svelte';
    import { declarations } from '../../stores.js';
    import { adminService } from '../../services/admin.service.js';
    import { config } from '../../config.js';

    let ycxValue = '';
    let ycxGopValue = '';
    let heSoValue = '';

    $: if ($declarations) {
        ycxValue = $declarations.hinhThucXuat || config.DEFAULT_DATA.HINH_THUC_XUAT_TINH_DOANH_THU.join('\n');
        ycxGopValue = $declarations.hinhThucXuatGop || config.DEFAULT_DATA.HINH_THUC_XUAT_TRA_GOP.join('\n');
        
        if ($declarations.heSoQuyDoi) {
            heSoValue = $declarations.heSoQuyDoi;
        } else {
            heSoValue = Object.entries(config.DEFAULT_DATA.HE_SO_QUY_DOI)
                .map(([k, v]) => `${k},${v}`)
                .join('\n');
        }
    }

    async function saveDeclarations() {
        const dataToSave = { ycx: ycxValue, ycxGop: ycxGopValue, heSo: heSoValue };
        await adminService.saveDeclarationsToFirestore(dataToSave);
        declarations.set({ 
            hinhThucXuat: ycxValue, 
            hinhThucXuatGop: ycxGopValue, 
            heSoQuyDoi: heSoValue 
        });
    }

    afterUpdate(() => { if (typeof feather !== 'undefined') feather.replace(); });
</script>

<div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden mb-6 transition-all hover:shadow-md">
    <details class="group">
        <summary class="flex justify-between items-center p-5 cursor-pointer bg-white hover:bg-slate-50 transition-colors list-none select-none">
            <div class="flex items-center gap-3">
                <div class="p-2 bg-indigo-50 rounded-lg text-indigo-600">
                    <i data-feather="sliders"></i>
                </div>
                <div>
                    <h3 class="font-bold text-slate-700 text-lg">D·ªØ li·ªáu t√≠nh to√°n & Logic</h3>
                    <p class="text-xs text-slate-500">C·∫•u h√¨nh H√¨nh th·ª©c xu·∫•t, H·ªá s·ªë quy ƒë·ªïi...</p>
                </div>
            </div>
            <span class="transform transition-transform duration-200 group-open:rotate-180 text-slate-400">
                <i data-feather="chevron-down"></i>
            </span>
        </summary>
        
        <div class="p-6 border-t border-slate-100 bg-slate-50/50">
            <div class="grid md:grid-cols-2 gap-6"> 
                <div>
                    <label for="decl-ycx" class="block text-sm font-bold text-slate-700 mb-2 flex items-center gap-2">
                        H√¨nh th·ª©c xu·∫•t (T√≠nh doanh thu)
                        <span class="text-xs font-normal text-slate-400 bg-white border px-2 py-0.5 rounded-full">M·ªói lo·∫°i 1 d√≤ng</span>
                    </label> 
                    <textarea id="decl-ycx" rows="8" class="w-full p-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 font-mono text-xs bg-white text-slate-600 leading-relaxed shadow-sm" placeholder="Nh·∫≠p d·ªØ li·ªáu..." bind:value={ycxValue}></textarea> 
                </div>
                <div> 
                    <label for="decl-ycx-gop" class="block text-sm font-bold text-slate-700 mb-2 flex items-center gap-2">
                        H√¨nh th·ª©c xu·∫•t (Tr·∫£ g√≥p)
                         <span class="text-xs font-normal text-slate-400 bg-white border px-2 py-0.5 rounded-full">M·ªói lo·∫°i 1 d√≤ng</span>
                    </label> 
                    <textarea id="decl-ycx-gop" rows="8" class="w-full p-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 font-mono text-xs bg-white text-slate-600 leading-relaxed shadow-sm" placeholder="Nh·∫≠p d·ªØ li·ªáu..." bind:value={ycxGopValue}></textarea> 
                </div>
                <div class="md:col-span-2"> 
                    <label for="decl-heso" class="block text-sm font-bold text-slate-700 mb-2 flex items-center gap-2">
                        H·ªá s·ªë quy ƒë·ªïi
                        <span class="text-xs font-normal text-slate-400 bg-white border px-2 py-0.5 rounded-full">Format: T√™n nh√≥m h√†ng, H·ªá s·ªë</span>
                    </label> 
                    <textarea id="decl-heso" rows="8" class="w-full p-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 font-mono text-xs bg-white text-slate-600 leading-relaxed shadow-sm" placeholder="VD: ƒêi·ªán tho·∫°i, 1" bind:value={heSoValue}></textarea> 
                </div>
            </div> 
            
            <div class="mt-6 flex justify-end pt-4 border-t border-slate-200">
                <button on:click={saveDeclarations} class="bg-indigo-600 text-white px-5 py-2.5 rounded-lg hover:bg-indigo-700 transition font-semibold shadow-sm flex items-center gap-2">
                    <i data-feather="save" class="w-4 h-4"></i>
                    L∆∞u C·∫•u H√¨nh
                </button> 
            </div> 
        </div>
    </details>
</div>
--- END FILE: ./src/components/admin/AdminCalculation.svelte ---

--- START FILE: ./src/components/admin/AdminCategory.svelte ---
<script>
    import { onMount } from 'svelte';
    import { adminService } from '../../services/admin.service.js';
    
    // Import c√°c component con
    import CategoryUploader from './category/CategoryUploader.svelte';
    import NameMappingEditor from './category/NameMappingEditor.svelte';
    import MacroGroupEditor from './category/MacroGroupEditor.svelte';
    import MacroProductGroupEditor from './category/MacroProductGroupEditor.svelte'; // [M·ªöI]

    onMount(() => {
        // T·∫£i d·ªØ li·ªáu c·∫ßn thi·∫øt khi v√†o component
        adminService.loadCategoryDataFromFirestore();
    });
</script>

<div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden mb-6 transition-all hover:shadow-md">
    <details class="group declaration-group" open>
        <summary class="flex justify-between items-center p-5 cursor-pointer bg-white hover:bg-slate-50 transition-colors list-none select-none">
            <div class="flex items-center gap-3">
                <div class="p-2 bg-blue-50 rounded-lg text-blue-600">
                    <i data-feather="upload-cloud"></i>
                </div>
                <div>
                    <h3 class="font-bold text-slate-700 text-lg">N·∫°p d·ªØ li·ªáu C·∫•u tr√∫c</h3>
                    <p class="text-xs text-slate-500">T·∫£i l√™n file Excel c·∫•u tr√∫c (Ng√†nh h√†ng, Nh√≥m h√†ng, H√£ng)</p>
                </div>
            </div>
            <span class="transform transition-transform duration-200 group-open:rotate-180 text-slate-400">
                <i data-feather="chevron-down"></i>
            </span>
        </summary>
        <div class="declaration-content bg-white border-t border-slate-100">
            <CategoryUploader />
        </div>
    </details>

    <details class="group declaration-group">
        <summary class="flex justify-between items-center p-5 cursor-pointer bg-white hover:bg-slate-50 transition-colors list-none select-none">
            <div class="flex items-center gap-3">
                <div class="p-2 bg-purple-50 rounded-lg text-purple-600">
                    <i data-feather="layers"></i>
                </div>
                <div>
                    <h3 class="font-bold text-slate-700 text-lg">Khai b√°o Nh√≥m Ng√†nh H√†ng L·ªõn</h3>
                    <p class="text-xs text-slate-500">T·∫°o nh√≥m g·ªôp (VD: ICT, CE) t·ª´ c√°c nh√≥m h√†ng con</p>
                </div>
            </div>
            <span class="transform transition-transform duration-200 group-open:rotate-180 text-slate-400">
                <i data-feather="chevron-down"></i>
            </span>
        </summary>
        <div class="declaration-content bg-white border-t border-slate-100">
            <MacroGroupEditor />
        </div>
    </details>

    <details class="group declaration-group">
        <summary class="flex justify-between items-center p-5 cursor-pointer bg-white hover:bg-slate-50 transition-colors list-none select-none">
            <div class="flex items-center gap-3">
                <div class="p-2 bg-teal-50 rounded-lg text-teal-600">
                    <i data-feather="package"></i>
                </div>
                <div>
                    <h3 class="font-bold text-slate-700 text-lg">Khai b√°o Nh√≥m H√†ng L·ªõn</h3>
                    <p class="text-xs text-slate-500">T·∫°o nh√≥m g·ªôp (VD: Gia d·ª•ng l·ªõn) t·ª´ c√°c nh√≥m h√†ng nh·ªè</p>
                </div>
            </div>
            <span class="transform transition-transform duration-200 group-open:rotate-180 text-slate-400">
                <i data-feather="chevron-down"></i>
            </span>
        </summary>
        <div class="declaration-content bg-white border-t border-slate-100">
            <MacroProductGroupEditor />
        </div>
    </details>

    <details class="group declaration-group">
        <summary class="flex justify-between items-center p-5 cursor-pointer bg-white hover:bg-slate-50 transition-colors list-none select-none">
            <div class="flex items-center gap-3">
                <div class="p-2 bg-green-50 rounded-lg text-green-600">
                    <i data-feather="tag"></i>
                </div>
                <div>
                    <h3 class="font-bold text-slate-700 text-lg">Khai b√°o T√™n Ng√†nh H√†ng</h3>
                    <p class="text-xs text-slate-500">Ch·ªânh s·ª≠a t√™n hi·ªÉn th·ªã cho Ng√†nh H√†ng</p>
                </div>
            </div>
            <span class="transform transition-transform duration-200 group-open:rotate-180 text-slate-400">
                <i data-feather="chevron-down"></i>
            </span>
        </summary>
        <div class="declaration-content bg-white border-t border-slate-100">
            <NameMappingEditor type="category" />
        </div>
    </details>

    <details class="group declaration-group">
        <summary class="flex justify-between items-center p-5 cursor-pointer bg-white hover:bg-slate-50 transition-colors list-none select-none">
            <div class="flex items-center gap-3">
                <div class="p-2 bg-orange-50 rounded-lg text-orange-600">
                    <i data-feather="package"></i>
                </div>
                <div>
                    <h3 class="font-bold text-slate-700 text-lg">Khai b√°o T√™n Nh√≥m H√†ng</h3>
                    <p class="text-xs text-slate-500">Ch·ªânh s·ª≠a t√™n hi·ªÉn th·ªã cho Nh√≥m H√†ng</p>
                </div>
            </div>
            <span class="transform transition-transform duration-200 group-open:rotate-180 text-slate-400">
                <i data-feather="chevron-down"></i>
            </span>
        </summary>
        <div class="declaration-content bg-white border-t border-slate-100">
            <NameMappingEditor type="group" />
        </div>
    </details>

    <details class="group declaration-group">
        <summary class="flex justify-between items-center p-5 cursor-pointer bg-white hover:bg-slate-50 transition-colors list-none select-none">
            <div class="flex items-center gap-3">
                <div class="p-2 bg-red-50 rounded-lg text-red-600">
                    <i data-feather="briefcase"></i>
                </div>
                <div>
                    <h3 class="font-bold text-slate-700 text-lg">Khai b√°o T√™n H√£ng</h3>
                    <p class="text-xs text-slate-500">Ch·ªânh s·ª≠a t√™n hi·ªÉn th·ªã cho Nh√† s·∫£n xu·∫•t</p>
                </div>
            </div>
            <span class="transform transition-transform duration-200 group-open:rotate-180 text-slate-400">
                <i data-feather="chevron-down"></i>
            </span>
        </summary>
        <div class="declaration-content bg-white border-t border-slate-100">
            <NameMappingEditor type="brand" />
        </div>
    </details>
</div>
--- END FILE: ./src/components/admin/AdminCategory.svelte ---

--- START FILE: ./src/components/admin/AdminCompetition.svelte ---
<script>
    import { onMount, afterUpdate } from 'svelte';
    import { globalCompetitionConfigs, brandList, categoryStructure } from '../../stores.js';
    import { adminService } from '../../services/admin.service.js';

    let isFormOpen = false;
    let editingIndex = -1;
    let isLoading = false;

    // Bi·∫øn t√¨m ki·∫øm
    let searchBrand = '';
    let searchGroup = '';

    let formData = { id: '', name: '', brands: [], groups: [], type: 'doanhthu', minPrice: '', maxPrice: '', excludeApple: false };

    $: availableBrands = $brandList || [];
    $: availableGroups = [...new Set(($categoryStructure || []).map(c => c.nhomHang).filter(Boolean))].sort();

    // L·ªçc danh s√°ch d·ª±a tr√™n t·ª´ kh√≥a t√¨m ki·∫øm
    $: filteredBrands = availableBrands.filter(b => b.toLowerCase().includes(searchBrand.toLowerCase()));
    $: filteredGroups = availableGroups.filter(g => g.toLowerCase().includes(searchGroup.toLowerCase()));

    function resetForm() {
        formData = { id: '', name: '', brands: [], groups: [], type: 'doanhthu', minPrice: '', maxPrice: '', excludeApple: false };
        editingIndex = -1;
        searchBrand = '';
        searchGroup = '';
    }
    function openAddForm() { resetForm(); isFormOpen = true; }
    function openEditForm(index) {
        const config = $globalCompetitionConfigs[index];
        editingIndex = index;
        formData = {
            id: config.id, name: config.name, brands: [...(config.brands || [])], groups: [...(config.groups || [])],
            type: config.type || 'doanhthu',
            minPrice: config.minPrice ? config.minPrice / 1000000 : '',
            maxPrice: config.maxPrice ? config.maxPrice / 1000000 : '',
            excludeApple: config.excludeApple || false
        };
        isFormOpen = true;
    }
    function closeForm() { isFormOpen = false; resetForm(); }
    function toggleSelection(list, item) { return list.includes(item) ? list.filter(i => i !== item) : [...list, item]; }

    async function saveCompetition() {
        if (!formData.name) return alert("Vui l√≤ng nh·∫≠p t√™n ch∆∞∆°ng tr√¨nh!");
        if (formData.brands.length === 0) return alert("Vui l√≤ng ch·ªçn √≠t nh·∫•t m·ªôt H√£ng!");
        isLoading = true;
        const configToSave = {
            id: formData.id || `comp_${Date.now()}`,
            name: formData.name, brands: formData.brands, groups: formData.groups,
            type: formData.type,
            minPrice: formData.minPrice ? parseFloat(formData.minPrice) * 1000000 : 0,
            maxPrice: formData.maxPrice ? parseFloat(formData.maxPrice) * 1000000 : 0,
            excludeApple: formData.excludeApple
        };

        let newConfigs = [...$globalCompetitionConfigs];
        if (editingIndex >= 0) newConfigs[editingIndex] = configToSave; else newConfigs.push(configToSave);

        // C·∫≠p nh·∫≠t UI ngay l·∫≠p t·ª©c
        globalCompetitionConfigs.set(newConfigs);
        localStorage.setItem('temp_globalCompetitionConfigs', JSON.stringify(newConfigs)); // Backup LocalStorage

        try {
            await adminService.saveGlobalCompetitionConfigs(newConfigs);
        } catch (error) { 
            console.error("L·ªói Cloud:", error);
            alert(`L∆∞u Cloud th·∫•t b·∫°i (${error.code}). D·ªØ li·ªáu ƒë√£ ƒë∆∞·ª£c l∆∞u v√†o tr√¨nh duy·ªát ƒë·ªÉ b·∫°n test.`);
        } finally { 
            isLoading = false; 
            closeForm();
        }
    }

    async function deleteCompetition(index) {
        if (!confirm("X√≥a ch∆∞∆°ng tr√¨nh n√†y?")) return;
        let newConfigs = [...$globalCompetitionConfigs];
        newConfigs.splice(index, 1);
        
        globalCompetitionConfigs.set(newConfigs);
        localStorage.setItem('temp_globalCompetitionConfigs', JSON.stringify(newConfigs));

        try {
            await adminService.saveGlobalCompetitionConfigs(newConfigs);
        } catch (error) { 
             console.error("L·ªói Cloud:", error);
             // Kh√¥ng alert l·ªói x√≥a ƒë·ªÉ tr·∫£i nghi·ªám m∆∞·ª£t h∆°n, v√¨ ƒë√£ x√≥a ·ªü local
        }
    }

    onMount(() => {
        if ($globalCompetitionConfigs.length === 0) {
            const backup = localStorage.getItem('temp_globalCompetitionConfigs');
            if (backup) globalCompetitionConfigs.set(JSON.parse(backup));
        }
    });
    afterUpdate(() => { if (typeof feather !== 'undefined') feather.replace(); });
</script>

<div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden mb-6 transition-all hover:shadow-md">
    <div class="p-5 bg-white border-b border-slate-100 flex justify-between items-center">
        <div class="flex items-center gap-4">
            <div class="p-2.5 bg-red-50 rounded-lg text-red-600 shadow-sm">
                <i data-feather="flag" class="w-6 h-6"></i>
            </div>
            <div>
                <div class="flex items-center gap-3">
                    <h3 class="font-bold text-slate-800 text-lg">Qu·∫£n l√Ω Thi ƒêua (Global)</h3>
                    <span class="bg-red-100 text-red-700 text-[10px] font-extrabold px-2 py-0.5 rounded-full uppercase tracking-wide border border-red-200">Quan tr·ªçng</span>
                </div>
                <p class="text-sm text-slate-500 mt-0.5">C·∫•u h√¨nh c√°c ch∆∞∆°ng tr√¨nh thi ƒëua √°p d·ª•ng cho to√†n h·ªá th·ªëng</p>
            </div>
        </div>
    </div>
    
    <div class="p-6 bg-slate-50/30"> 
        {#if !isFormOpen}
            <div class="space-y-3">
                {#if $globalCompetitionConfigs.length === 0}
                    <div class="text-center py-10 border-2 border-dashed border-slate-200 rounded-xl bg-slate-50">
                        <p class="text-slate-400 italic mb-4">Ch∆∞a c√≥ ch∆∞∆°ng tr√¨nh thi ƒëua n√†o.</p>
                        <button on:click={openAddForm} class="px-4 py-2 bg-white border border-slate-300 text-slate-600 rounded-lg hover:border-blue-500 hover:text-blue-600 font-medium transition shadow-sm">
                            + T·∫°o ch∆∞∆°ng tr√¨nh ƒë·∫ßu ti√™n
                        </button>
                    </div>
                {:else}
                    {#each $globalCompetitionConfigs as config, index}
                        <div class="flex justify-between items-center p-4 bg-white rounded-xl border border-slate-200 shadow-sm hover:border-blue-300 hover:shadow-md transition group/item">
                            <div>
                                <div class="flex items-center gap-3">
                                    <h4 class="font-bold text-slate-800 text-base">{config.name}</h4>
                                    <span class="text-[10px] uppercase px-2 py-0.5 rounded-full font-bold border {config.type === 'doanhthu' ? 'bg-blue-50 text-blue-700 border-blue-100' : 'bg-yellow-50 text-yellow-700 border-yellow-100'}">
                                        {config.type === 'doanhthu' ? 'Doanh thu' : 'S·ªë l∆∞·ª£ng'}
                                    </span>
                                </div>
                                <div class="text-xs text-slate-500 mt-1.5 flex items-center gap-4">
                                    <span class="flex items-center gap-1 bg-slate-100 px-2 py-0.5 rounded"><i data-feather="briefcase" class="w-3 h-3"></i> {config.brands.join(', ')}</span>
                                    <span class="flex items-center gap-1 bg-slate-100 px-2 py-0.5 rounded"><i data-feather="layers" class="w-3 h-3"></i> {config.groups.length > 0 ? config.groups.join(', ') : 'T·∫•t c·∫£ nh√≥m'}</span>
                                </div>
                            </div>
                            <div class="flex gap-2 opacity-100 sm:opacity-0 sm:group-hover/item:opacity-100 transition-opacity">
                                <button on:click={() => openEditForm(index)} class="p-2 text-slate-400 hover:text-blue-600 hover:bg-blue-50 rounded-lg transition" title="S·ª≠a"><i data-feather="edit-2" class="w-4 h-4"></i></button>
                                <button on:click={() => deleteCompetition(index)} class="p-2 text-slate-400 hover:text-red-600 hover:bg-red-50 rounded-lg transition" title="X√≥a"><i data-feather="trash-2" class="w-4 h-4"></i></button>
                            </div>
                        </div>
                    {/each}
                    <button on:click={openAddForm} class="w-full py-3 mt-4 border-2 border-dashed border-slate-300 rounded-xl text-slate-500 hover:border-blue-500 hover:text-blue-600 hover:bg-blue-50/50 font-semibold transition flex justify-center items-center gap-2">
                        <i data-feather="plus-circle" class="w-5 h-5"></i> Th√™m ch∆∞∆°ng tr√¨nh m·ªõi
                    </button>
                {/if}
            </div>
        {:else}
            <div class="bg-white p-6 rounded-xl border border-blue-100 shadow-lg animate-fade-in relative">
                <button on:click={closeForm} class="absolute top-4 right-4 text-slate-400 hover:text-slate-600 p-1 rounded-md hover:bg-slate-100 transition">
                    <i data-feather="x" class="w-5 h-5"></i>
                </button>

                <h3 class="font-bold text-lg mb-6 text-slate-800 flex items-center gap-2">
                    <span class="bg-blue-100 text-blue-600 p-1.5 rounded-lg"><i data-feather={editingIndex >= 0 ? "edit" : "plus"} class="w-4 h-4"></i></span>
                    {editingIndex >= 0 ? 'Ch·ªânh s·ª≠a ch∆∞∆°ng tr√¨nh' : 'Th√™m ch∆∞∆°ng tr√¨nh m·ªõi'}
                </h3>
                
                <div class="space-y-5">
                    <div>
                        <label class="block text-sm font-bold text-slate-700 mb-1">T√™n ch∆∞∆°ng tr√¨nh</label>
                        <input type="text" bind:value={formData.name} class="w-full p-2.5 border border-slate-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition" placeholder="VD: Thi ƒëua Tivi Sony T9...">
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label class="block text-sm font-bold text-slate-700 mb-2">H√£ng s·∫£n xu·∫•t (B·∫Øt bu·ªôc)</label>
                            <input type="text" bind:value={searchBrand} class="w-full mb-2 p-2 border rounded text-xs" placeholder="üîç T√¨m h√£ng..." />
                            <div class="h-40 overflow-y-auto p-3 border border-slate-200 rounded-lg bg-slate-50 grid grid-cols-2 gap-2 custom-scrollbar">
                                {#each filteredBrands as brand}
                                    <label class="flex items-center space-x-2 text-sm cursor-pointer hover:bg-white p-1.5 rounded-md transition border border-transparent hover:border-slate-200">
                                        <input type="checkbox" checked={formData.brands.includes(brand)} on:change={() => formData.brands = toggleSelection(formData.brands, brand)} class="rounded text-blue-600 focus:ring-blue-500 border-slate-300">
                                        <span class="text-slate-700 truncate" title={brand}>{brand}</span>
                                    </label>
                                {/each}
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-bold text-slate-700 mb-2">Nh√≥m h√†ng</label>
                            <input type="text" bind:value={searchGroup} class="w-full mb-2 p-2 border rounded text-xs" placeholder="üîç T√¨m nh√≥m h√†ng..." />
                            <div class="h-40 overflow-y-auto p-3 border border-slate-200 rounded-lg bg-slate-50 grid grid-cols-1 gap-2 custom-scrollbar">
                                {#each filteredGroups as group}
                                    <label class="flex items-center space-x-2 text-sm cursor-pointer hover:bg-white p-1.5 rounded-md transition border border-transparent hover:border-slate-200">
                                        <input type="checkbox" checked={formData.groups.includes(group)} on:change={() => formData.groups = toggleSelection(formData.groups, group)} class="rounded text-blue-600 focus:ring-blue-500 border-slate-300">
                                        <span class="text-slate-700 truncate" title={group}>{group}</span>
                                    </label>
                                {/each}
                            </div>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 bg-slate-50 p-4 rounded-lg border border-slate-200">
                        <div>
                            <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Lo·∫°i ƒëo l∆∞·ªùng</label>
                            <select bind:value={formData.type} class="w-full p-2 border border-slate-300 rounded-md text-sm bg-white focus:ring-1 focus:ring-blue-500">
                                <option value="doanhthu">Theo Doanh thu</option>
                                <option value="soluong">Theo S·ªë l∆∞·ª£ng</option>
                            </select>
                        </div>
                        {#if formData.type === 'soluong'}
                            <div class="animate-fade-in">
                                <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Gi√° t·ª´ (Tr)</label>
                                <input type="number" bind:value={formData.minPrice} class="w-full p-2 border border-slate-300 rounded-md text-sm focus:ring-1 focus:ring-blue-500" placeholder="VD: 3">
                            </div>
                            <div class="animate-fade-in">
                                <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Gi√° ƒë·∫øn (Tr)</label>
                                <input type="number" bind:value={formData.maxPrice} class="w-full p-2 border border-slate-300 rounded-md text-sm focus:ring-1 focus:ring-blue-500" placeholder="VD: 10">
                            </div>
                        {/if}
                    </div>
                    <div class="flex items-center gap-2 pl-1">
                        <input type="checkbox" id="exclude-apple" bind:checked={formData.excludeApple} class="rounded text-blue-600 focus:ring-blue-500 border-slate-300 w-4 h-4">
                        <label for="exclude-apple" class="text-sm text-slate-700 cursor-pointer font-medium select-none">Tr·ª´ h√£ng Apple kh·ªèi d·ªØ li·ªáu</label>
                    </div>
                    <div class="flex justify-end gap-3 mt-8 pt-4 border-t border-slate-100">
                        <button on:click={closeForm} class="px-5 py-2.5 text-slate-600 bg-white border border-slate-300 rounded-lg hover:bg-slate-50 transition font-medium" disabled={isLoading}>H·ªßy b·ªè</button>
                        <button on:click={saveCompetition} class="px-5 py-2.5 bg-blue-600 text-white font-bold rounded-lg hover:bg-blue-700 transition flex items-center gap-2 shadow-md disabled:opacity-70" disabled={isLoading}>
                            {#if isLoading}<span class="animate-spin">‚Üª</span>{/if}
                            {!isLoading ? 'L∆∞u Ch∆∞∆°ng tr√¨nh' : 'ƒêang l∆∞u...'}
                        </button>
                    </div>
                </div>
            </div>
        {/if}
    </div>
</div>
--- END FILE: ./src/components/admin/AdminCompetition.svelte ---

--- START FILE: ./src/components/admin/AdminEfficiency.svelte ---
<script>
    import { onMount } from 'svelte';
    import { efficiencyConfig, modalState } from '../../stores.js';
    import { adminService } from '../../services/admin.service.js';
    
    // Load config khi mount
    onMount(async () => {
        const configs = await adminService.loadEfficiencyConfig();
        efficiencyConfig.set(configs);
    });

    function openAddModal() {
        // M·ªü modal th√™m ch·ªâ s·ªë (T·∫≠n d·ª•ng modal ƒë√£ c√≥)
        modalState.update(s => ({ ...s, activeModal: 'add-efficiency-modal', payload: null }));
    }

    function editItem(item) {
        modalState.update(s => ({ ...s, activeModal: 'add-efficiency-modal', payload: item }));
    }

    async function deleteItem(id) {
        if (!confirm("B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a ch·ªâ s·ªë h·ªá th·ªëng n√†y? N√≥ s·∫Ω bi·∫øn m·∫•t kh·ªèi b·∫£ng c·ªßa t·∫•t c·∫£ ng∆∞·ªùi d√πng.")) return;
        
        const newConfig = $efficiencyConfig.filter(i => i.id !== id);
        efficiencyConfig.set(newConfig);
        await adminService.saveEfficiencyConfig(newConfig);
    }

    // H√†m n√†y ƒë∆∞·ª£c g·ªçi khi Modal l∆∞u th√†nh c√¥ng (th√¥ng qua s·ª± ki·ªán dispatch ho·∫∑c store update)
    // ·ªû ƒë√¢y ta l·∫Øng nghe s·ª± ki·ªán t·ª´ App.svelte (n∆°i ƒë·∫∑t modal) ho·∫∑c update tr·ª±c ti·∫øp store trong modal
</script>

<div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden mb-6 transition-all hover:shadow-md">
    <div class="p-5 bg-white border-b border-slate-100 flex justify-between items-center">
        <div class="flex items-center gap-4">
            <div class="p-2.5 bg-orange-50 rounded-lg text-orange-600 shadow-sm">
               <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" /></svg>
            </div>
            <div>
                <div class="flex items-center gap-3">
                    <h3 class="font-bold text-slate-800 text-lg">C·∫•u h√¨nh B·∫£ng Hi·ªáu qu·∫£ (H·ªá th·ªëng)</h3>
                    <span class="bg-orange-100 text-orange-700 text-[10px] font-extrabold px-2 py-0.5 rounded-full uppercase tracking-wide border border-orange-200">Global</span>
                </div>
                <p class="text-sm text-slate-500 mt-0.5">C√°c ch·ªâ s·ªë n√†y s·∫Ω hi·ªÉn th·ªã m·∫∑c ƒë·ªãnh cho to√†n b·ªô nh√¢n vi√™n/si√™u th·ªã</p>
            </div>
        </div>
        <button on:click={openAddModal} class="px-4 py-2 bg-orange-600 text-white rounded-lg hover:bg-orange-700 font-bold shadow-sm flex items-center gap-2 text-sm transition-all">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" /></svg>
            Th√™m ch·ªâ s·ªë
        </button>
    </div>
    
    <div class="p-6 bg-slate-50/50">
        {#if $efficiencyConfig.length === 0}
            <div class="text-center py-8 border-2 border-dashed border-slate-300 rounded-xl">
                <p class="text-slate-500 italic">Ch∆∞a c√≥ ch·ªâ s·ªë h·ªá th·ªëng n√†o.</p>
            </div>
        {:else}
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                {#each $efficiencyConfig as item}
                    <div class="bg-white p-4 rounded-lg border border-slate-200 shadow-sm flex flex-col hover:border-orange-300 transition-colors group relative">
                        <div class="flex justify-between items-start mb-2">
                            <h4 class="font-bold text-slate-800">{item.label}</h4>
                            <div class="flex gap-1 opacity-0 group-hover:opacity-100 transition-opacity absolute top-2 right-2 bg-white/90 p-1 rounded border border-gray-100 shadow-sm">
                                <button class="p-1.5 text-slate-400 hover:text-blue-600 hover:bg-blue-50 rounded" title="S·ª≠a" on:click={() => editItem(item)}>
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" /></svg>
                                </button>
                                <button class="p-1.5 text-slate-400 hover:text-red-600 hover:bg-red-50 rounded" title="X√≥a" on:click={() => deleteItem(item.id)}>
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
                                </button>
                            </div>
                        </div>
                        
                        <div class="text-xs text-slate-500 space-y-1 mt-auto">
                            <p><strong>Lo·∫°i:</strong> {item.type === 'SL' ? 'S·ªë l∆∞·ª£ng' : (item.type === 'DTQD' ? 'Doanh thu Qƒê' : 'Doanh thu Th·ª±c')}</p>
                            <p><strong>M·ª•c ti√™u:</strong> {item.target}%</p>
                            <p class="truncate" title={item.groupA.join(', ')}><strong>T·ª≠ s·ªë:</strong> {item.groupA.join(', ')}</p>
                            <p class="truncate" title={item.groupB.join(', ')}><strong>M·∫´u s·ªë:</strong> {item.groupB.join(', ')}</p>
                        </div>
                    </div>
                {/each}
            </div>
        {/if}
    </div>
</div>
--- END FILE: ./src/components/admin/AdminEfficiency.svelte ---

--- START FILE: ./src/components/admin/AdminHelp.svelte ---
<script>
    import { afterUpdate } from 'svelte';
    import { helpContent } from '../../stores.js';
    import { adminService } from '../../services/admin.service.js';

    let localHelpContent = { ...$helpContent };

    $: if ($helpContent) {
        if (!localHelpContent.data && $helpContent.data) localHelpContent = { ...$helpContent };
    }

    async function saveHelp() {
        await adminService.saveHelpContent(localHelpContent);
        helpContent.set({ ...localHelpContent });
    }

    afterUpdate(() => { if (typeof feather !== 'undefined') feather.replace(); });
</script>

<div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden mb-6 transition-all hover:shadow-md">
    <details class="group"> 
        <summary class="flex justify-between items-center p-5 cursor-pointer bg-white hover:bg-slate-50 transition-colors list-none select-none">
            <div class="flex items-center gap-3">
                <div class="p-2 bg-green-50 rounded-lg text-green-600">
                    <i data-feather="book-open"></i>
                </div>
                <div>
                    <h3 class="font-bold text-slate-700 text-lg">N·ªôi dung H∆∞·ªõng d·∫´n</h3>
                    <p class="text-xs text-slate-500">Ch·ªânh s·ª≠a popup h∆∞·ªõng d·∫´n (?) t·∫°i c√°c tab</p>
                </div>
            </div>
            <span class="transform transition-transform duration-200 group-open:rotate-180 text-slate-400">
                <i data-feather="chevron-down"></i>
            </span>
        </summary> 
        
        <div class="p-6 border-t border-slate-100 bg-slate-50/50"> 
            <div class="grid grid-cols-1 gap-6"> 
                {#each [
                    { id: 'data', label: 'Tab C·∫≠p nh·∫≠t d·ªØ li·ªáu' },
                    { id: 'luyke', label: 'Tab L≈©y k·∫ø' },
                    { id: 'sknv', label: 'Tab S·ª©c kh·ªèe NV' },
                    { id: 'realtime', label: 'Tab Realtime' }
                ] as tab}
                    <div class="bg-white p-4 rounded-lg border border-slate-200 shadow-sm">
                        <label for="help-{tab.id}" class="block text-sm font-bold text-slate-700 mb-2">{tab.label}</label>
                        <textarea 
                            id="help-{tab.id}" 
                            rows="4" 
                            class="w-full p-3 border border-slate-300 rounded-lg text-sm focus:ring-2 focus:ring-green-500 focus:border-green-500 outline-none text-slate-600" 
                            bind:value={localHelpContent[tab.id]}
                            placeholder="Nh·∫≠p n·ªôi dung h∆∞·ªõng d·∫´n (h·ªó tr·ª£ HTML c∆° b·∫£n)..."
                        ></textarea>
                    </div>
                {/each}
            </div> 
            <div class="mt-6 flex justify-end pt-4 border-t border-slate-200">
                <button on:click={saveHelp} class="bg-green-600 text-white px-5 py-2.5 rounded-lg hover:bg-green-700 transition font-semibold shadow-sm flex items-center gap-2">
                    <i data-feather="save" class="w-4 h-4"></i>
                    L∆∞u H∆∞·ªõng D·∫´n
                </button> 
            </div> 
        </div>
    </details>
</div>
--- END FILE: ./src/components/admin/AdminHelp.svelte ---

--- START FILE: ./src/components/admin/AdminHomeConfig.svelte ---
<script>
    // Version 2.2 - Larger Textarea and Template Insert for Changelog
    import { onMount, afterUpdate } from 'svelte';
    import { homeConfig } from '../../stores.js';
    import { adminService } from '../../services/admin.service.js';

    let localConfig = {
        videoUrl: '',
        timeline: [],
        sliderImages: [],
        changelogs: []
    };

    $: if ($homeConfig) {
        localConfig = JSON.parse(JSON.stringify($homeConfig));
    }

    let activeTab = 'video'; 
    let isSaving = false;

    // --- LOGIC TIMELINE VIDEO ---
    function addTimelineItem() {
        localConfig.timeline = [...localConfig.timeline, { time: '00:00', label: 'M·ªëc m·ªõi' }];
    }
    function removeTimelineItem(index) {
        localConfig.timeline = localConfig.timeline.filter((_, i) => i !== index);
    }

    // --- LOGIC SLIDER ·∫¢NH ---
    function addSliderItem() {
        localConfig.sliderImages = [...localConfig.sliderImages, { url: '', title: '' }];
    }
    function removeSliderItem(index) {
        localConfig.sliderImages = localConfig.sliderImages.filter((_, i) => i !== index);
    }

    // --- LOGIC CHANGELOG ---
    function addChangelogItem() {
        const today = new Date().toLocaleDateString('vi-VN');
        localConfig.changelogs = [{ version: '', date: today, content: '' }, ...localConfig.changelogs];
    }
    function removeChangelogItem(index) {
        localConfig.changelogs = localConfig.changelogs.filter((_, i) => i !== index);
    }
    
    // [M·ªöI] H√†m ch√®n m·∫´u so·∫°n th·∫£o
    function insertTemplate(index) {
        const template = `<ul>
    <li><strong>T√≠nh nƒÉng ch√≠nh 1:</strong>
        <ul style="list-style-type: circle; margin-left: 20px;">
            <li>Chi ti·∫øt A</li>
            <li>Chi ti·∫øt B</li>
        </ul>
    </li>
    <li><strong>S·ª≠a l·ªói:</strong> M√¥ t·∫£ l·ªói ƒë√£ s·ª≠a.</li>
</ul>`;
        localConfig.changelogs[index].content = template;
    }

    // --- H√ÄM L∆ØU CHUNG ---
    async function saveAllConfig() {
        console.log("ƒêang l∆∞u c·∫•u h√¨nh...", localConfig);
        isSaving = true;
        try {
            await adminService.saveHomeConfig(localConfig);
        } catch (e) {
            console.error(e);
            alert("L·ªói khi l∆∞u: " + e.message);
        } finally {
            isSaving = false;
        }
    }

    afterUpdate(() => { if (typeof feather !== 'undefined') feather.replace(); });
</script>

<div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden mb-6 transition-all hover:shadow-md">
    <details class="group" open> <summary class="flex justify-between items-center p-5 cursor-pointer bg-white hover:bg-slate-50 transition-colors list-none select-none">
            <div class="flex items-center gap-3">
                <div class="p-2 bg-pink-50 rounded-lg text-pink-600">
                    <i data-feather="layout"></i>
                </div>
                <div>
                    <h3 class="font-bold text-slate-700 text-lg">Qu·∫£n l√Ω Trang ch·ªß</h3>
                    <p class="text-xs text-slate-500">C·∫•u h√¨nh Video, Slide ·∫£nh & L·ªãch s·ª≠ c·∫≠p nh·∫≠t</p>
                </div>
            </div>
            <span class="transform transition-transform duration-200 group-open:rotate-180 text-slate-400">
                <i data-feather="chevron-down"></i>
            </span>
        </summary>
        
        <div class="p-6 border-t border-slate-100 bg-slate-50/50">
            
            <div class="flex space-x-2 mb-6 border-b border-gray-200 pb-1">
                <button 
                    class="px-4 py-2 font-medium text-sm rounded-t-lg transition-colors {activeTab === 'video' ? 'bg-white text-pink-600 border-x border-t border-gray-200' : 'text-gray-500 hover:text-gray-700'}"
                    on:click={() => activeTab = 'video'}
                >
                    Video & Timeline
                </button>
                <button 
                    class="px-4 py-2 font-medium text-sm rounded-t-lg transition-colors {activeTab === 'slider' ? 'bg-white text-pink-600 border-x border-t border-gray-200' : 'text-gray-500 hover:text-gray-700'}"
                    on:click={() => activeTab = 'slider'}
                >
                    Slide ·∫¢nh
                </button>
                <button 
                    class="px-4 py-2 font-medium text-sm rounded-t-lg transition-colors {activeTab === 'changelog' ? 'bg-white text-pink-600 border-x border-t border-gray-200' : 'text-gray-500 hover:text-gray-700'}"
                    on:click={() => activeTab = 'changelog'}
                >
                    L·ªãch s·ª≠ c·∫≠p nh·∫≠t
                </button>
            </div>

            {#if activeTab === 'video'}
                <div class="space-y-4 animate-fade-in">
                    <div>
                        <label class="block text-sm font-bold text-slate-700 mb-1">Youtube Embed URL</label>
                        <input type="text" bind:value={localConfig.videoUrl} class="w-full p-2 border rounded-md text-sm" placeholder="https://www.youtube.com/embed/...">
                        <p class="text-xs text-gray-400 mt-1">L∆∞u √Ω: Ph·∫£i l√† link "Embed" (Nh√∫ng) c·ªßa Youtube.</p>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-bold text-slate-700 mb-2">Timeline (M·ª•c l·ª•c video)</label>
                        <div class="space-y-2">
                            {#each localConfig.timeline as item, index}
                                <div class="flex items-center gap-2">
                                    <input type="text" bind:value={item.time} class="w-20 p-2 border rounded-md text-sm text-center" placeholder="00:00">
                                    <input type="text" bind:value={item.label} class="flex-grow p-2 border rounded-md text-sm" placeholder="M√¥ t·∫£...">
                                    <button on:click={() => removeTimelineItem(index)} class="text-red-500 hover:bg-red-50 p-2 rounded"><i data-feather="trash-2" class="w-4 h-4"></i></button>
                                </div>
                            {/each}
                        </div>
                        <button on:click={addTimelineItem} class="mt-2 text-sm text-blue-600 hover:underline flex items-center gap-1">
                            <i data-feather="plus" class="w-3 h-3"></i> Th√™m m·ªëc th·ªùi gian
                        </button>
                    </div>
                </div>
            {/if}

            {#if activeTab === 'slider'}
                <div class="space-y-4 animate-fade-in">
                    <p class="text-xs text-gray-500 bg-blue-50 p-2 rounded">
                        M·∫πo: S·ª≠ d·ª•ng link tr·ª±c ti·∫øp c·ªßa ·∫£nh (ƒëu√¥i .jpg, .png). Ho·∫∑c ƒë∆∞·ªùng d·∫´n n·ªôi b·ªô (VD: /slides/anh1.jpg).
                    </p>
                    <div class="space-y-4">
                        {#each localConfig.sliderImages as img, index}
                            <div class="flex flex-col gap-2 p-3 border rounded-lg bg-white shadow-sm">
                                <div class="flex justify-between items-center">
                                    <span class="text-xs font-bold text-gray-400">Slide #{index + 1}</span>
                                    <button on:click={() => removeSliderItem(index)} class="text-red-500 text-xs hover:underline">X√≥a</button>
                                </div>
                                <input type="text" bind:value={img.url} class="w-full p-2 border rounded-md text-sm" placeholder="Link ·∫£nh (URL)...">
                                <input type="text" bind:value={img.title} class="w-full p-2 border rounded-md text-sm" placeholder="Ti√™u ƒë·ªÅ ·∫£nh (hi·ªÉn th·ªã ƒë√® l√™n ·∫£nh)...">
                            </div>
                        {/each}
                    </div>
                    <button on:click={addSliderItem} class="w-full py-2 border-2 border-dashed border-gray-300 rounded-lg text-gray-500 hover:border-pink-500 hover:text-pink-500 transition">
                        + Th√™m Slide M·ªõi
                    </button>
                </div>
            {/if}

            {#if activeTab === 'changelog'}
                <div class="space-y-4 animate-fade-in">
                    <button on:click={addChangelogItem} class="w-full py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition shadow-sm">
                        + Th√™m b·∫£n c·∫≠p nh·∫≠t m·ªõi
                    </button>
                    <div class="space-y-6 max-h-[600px] overflow-y-auto pr-2">
                        {#each localConfig.changelogs as log, index}
                            <div class="flex flex-col gap-3 p-4 border rounded-xl bg-white shadow-sm relative">
                                <button on:click={() => removeChangelogItem(index)} class="absolute top-4 right-4 text-red-500 hover:bg-red-50 p-1.5 rounded"><i data-feather="trash-2" class="w-4 h-4"></i></button>
                                
                                <div class="flex gap-4 pr-10">
                                    <div class="flex flex-col gap-1 w-1/4">
                                        <label class="text-xs font-bold text-gray-500 uppercase">Phi√™n b·∫£n</label>
                                        <input type="text" bind:value={log.version} class="w-full p-2 border rounded text-sm font-bold text-blue-700" placeholder="4.2">
                                    </div>
                                    <div class="flex flex-col gap-1 w-1/4">
                                        <label class="text-xs font-bold text-gray-500 uppercase">Ng√†y</label>
                                        <input type="text" bind:value={log.date} class="w-full p-2 border rounded text-sm" placeholder="dd/mm/yyyy">
                                    </div>
                                </div>

                                <div class="flex flex-col gap-1">
                                    <div class="flex justify-between items-end">
                                        <label class="text-xs font-bold text-gray-500 uppercase">N·ªôi dung (H·ªó tr·ª£ HTML)</label>
                                        <button 
                                            class="text-xs text-blue-600 hover:underline flex items-center gap-1 bg-blue-50 px-2 py-1 rounded"
                                            on:click={() => insertTemplate(index)}
                                        >
                                            <i data-feather="code" class="w-3 h-3"></i> Ch√®n m·∫´u chu·∫©n
                                        </button>
                                    </div>
                                    <textarea 
                                        bind:value={log.content} 
                                        rows="12" 
                                        class="w-full p-3 border rounded text-sm font-mono leading-relaxed focus:ring-2 focus:ring-blue-500 outline-none" 
                                        placeholder="Nh·∫≠p n·ªôi dung c·∫≠p nh·∫≠t..."
                                    ></textarea>
                                </div>
                            </div>
                        {/each}
                    </div>
                </div>
            {/if}

            <div class="mt-6 flex justify-end pt-4 border-t border-slate-200">
                <button 
                    on:click={saveAllConfig} 
                    disabled={isSaving} 
                    class="bg-pink-600 text-white px-5 py-2.5 rounded-lg hover:bg-pink-700 transition font-semibold shadow-sm flex items-center gap-2 disabled:opacity-50"
                >
                    {#if isSaving}
                        <svg class="animate-spin h-4 w-4 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                        ƒêang l∆∞u...
                    {:else}
                        <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path><polyline points="17 21 17 13 7 13 7 21"></polyline><polyline points="7 3 7 8 15 8"></polyline></svg>
                        L∆∞u C·∫•u H√¨nh
                    {/if}
                </button>
            </div>
        </div>
    </details>
</div>

<style>
    .animate-fade-in { animation: fadeIn 0.3s ease-out; }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
</style>
--- END FILE: ./src/components/admin/AdminHomeConfig.svelte ---

--- START FILE: ./src/components/admin/AdminMappings.svelte ---
<script>
    import { afterUpdate } from 'svelte';
    import { competitionNameMappings } from '../../stores.js';
    import { adminService } from '../../services/admin.service.js';

    let mappingSearch = '';
    let isSaving = false;
    let debounceTimer;
    
    // Subscribe store
    $: mappings = $competitionNameMappings || {};

    // Chuy·ªÉn object mappings th√†nh array ƒë·ªÉ render b·∫£ng
    $: mappingList = Object.entries(mappings).map(([original, short], index) => ({
        originalName: original,
        shortName: short || original, // M·∫∑c ƒë·ªãnh hi·ªÉn th·ªã t√™n g·ªëc n·∫øu ch∆∞a c√≥ t√™n r√∫t g·ªçn
        index: index + 1
    }));

    // L·ªçc danh s√°ch
    $: filteredList = mappingList.filter(item => {
        const term = mappingSearch.toLowerCase();
        return item.originalName.toLowerCase().includes(term) || 
               item.shortName.toLowerCase().includes(term);
    });

    function handleMappingInput(originalName, event) {
        const newShortName = event.target.value;
        
        // C·∫≠p nh·∫≠t store local ngay l·∫≠p t·ª©c ƒë·ªÉ UI ph·∫£n h·ªìi nhanh
        competitionNameMappings.update(current => {
            return { ...current, [originalName]: newShortName };
        });
    }

    async function saveAllMappings() {
        isSaving = true;
        try {
            await adminService.saveCompetitionNameMappings($competitionNameMappings);
        } catch (e) {
            console.error(e);
            alert("L·ªói khi l∆∞u mapping.");
        } finally {
            isSaving = false;
        }
    }

    afterUpdate(() => { if (typeof feather !== 'undefined') feather.replace(); });
</script>

<div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden mb-6 transition-all hover:shadow-md">
    <details class="group" open> 
        <summary class="flex justify-between items-center p-5 cursor-pointer bg-white hover:bg-slate-50 transition-colors list-none select-none">
            <div class="flex items-center gap-3">
                <div class="p-2 bg-teal-50 rounded-lg text-teal-600">
                    <i data-feather="git-merge"></i>
                </div>
                <div>
                    <h3 class="font-bold text-slate-700 text-lg">T√™n R√∫t G·ªçn Thi ƒêua</h3>
                    <p class="text-xs text-slate-500">ƒê·∫∑t t√™n ng·∫Øn g·ªçn cho c√°c c·ªôt thi ƒëua tr√™n b·∫£ng b√°o c√°o</p>
                </div>
            </div>
            <span class="transform transition-transform duration-200 group-open:rotate-180 text-slate-400">
                <i data-feather="chevron-down"></i>
            </span>
        </summary> 
        
        <div class="p-6 border-t border-slate-100 bg-slate-50/50"> 
            
            <div class="flex flex-col sm:flex-row justify-between items-center gap-4 mb-4">
                <div class="relative flex-grow w-full sm:w-auto">
                    <span class="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400">
                        <i data-feather="search" class="w-4 h-4"></i>
                    </span>
                    <input 
                        type="text" 
                        class="w-full pl-10 p-2.5 border border-slate-300 rounded-lg text-sm focus:ring-2 focus:ring-teal-500 outline-none bg-white" 
                        placeholder="T√¨m ki·∫øm t√™n thi ƒëua..." 
                        bind:value={mappingSearch}
                    >
                </div>
                <button 
                    class="px-4 py-2 bg-teal-600 text-white rounded-lg hover:bg-teal-700 font-bold text-sm shadow-sm flex items-center gap-2 disabled:opacity-50"
                    on:click={saveAllMappings}
                    disabled={isSaving}
                >
                    {#if isSaving}
                        <span class="animate-spin">‚Üª</span> ƒêang l∆∞u...
                    {:else}
                        <i data-feather="save" class="w-4 h-4"></i> L∆∞u Thay ƒê·ªïi
                    {/if}
                </button>
            </div>

            <div class="border border-slate-200 rounded-lg bg-white shadow-inner overflow-hidden">
                <div class="max-h-[500px] overflow-y-auto custom-scrollbar"> 
                    {#if filteredList.length === 0}
                        <div class="flex flex-col items-center justify-center p-12 text-slate-400">
                            <i data-feather="inbox" class="w-10 h-10 mb-3 opacity-50"></i>
                            <p class="text-sm font-medium">Ch∆∞a c√≥ d·ªØ li·ªáu thi ƒëua.</p>
                            <p class="text-xs mt-1">Vui l√≤ng d√°n d·ªØ li·ªáu "Thi ƒëua nh√¢n vi√™n" ·ªü tab C·∫≠p nh·∫≠t d·ªØ li·ªáu ƒë·ªÉ h·ªá th·ªëng t·ª± ƒë·ªông tr√≠ch xu·∫•t t√™n.</p>
                        </div>
                    {:else}
                        <table class="min-w-full text-sm border-collapse">
                            <thead class="text-xs text-slate-600 uppercase bg-slate-100 font-bold sticky top-0 z-10 shadow-sm">
                                <tr>
                                    <th class="px-4 py-3 border-b text-center w-16">STT</th>
                                    <th class="px-4 py-3 border-b text-left w-1/2">T√™n G·ªëc (T·ª´ d·ªØ li·ªáu d√°n)</th>
                                    <th class="px-4 py-3 border-b text-left w-1/2 text-teal-700">T√™n R√∫t G·ªçn (Hi·ªÉn th·ªã)</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-slate-100">
                                {#each filteredList as item}
                                    <tr class="hover:bg-slate-50 transition-colors group">
                                        <td class="px-4 py-3 text-center text-slate-400 text-xs font-mono">{item.index}</td>
                                        <td class="px-4 py-3 text-slate-700 text-xs leading-relaxed font-medium break-words select-all">
                                            {item.originalName}
                                        </td>
                                        <td class="px-4 py-2">
                                            <input 
                                                type="text" 
                                                class="w-full p-2 border border-slate-200 rounded-md text-sm font-semibold text-teal-800 focus:border-teal-500 focus:ring-1 focus:ring-teal-500 outline-none bg-slate-50 focus:bg-white transition-all placeholder-slate-300" 
                                                value={item.shortName} 
                                                on:input={(e) => handleMappingInput(item.originalName, e)}
                                                placeholder={item.originalName}
                                            >
                                        </td>
                                    </tr>
                                {/each}
                            </tbody>
                        </table>
                    {/if}
                </div> 
            </div>
            
            <p class="text-xs text-slate-500 mt-3 italic flex items-center gap-1">
                <i data-feather="info" class="w-3 h-3"></i>
                M·∫πo: T√™n r√∫t g·ªçn m·∫∑c ƒë·ªãnh s·∫Ω gi·ªëng t√™n g·ªëc. B·∫°n h√£y s·ª≠a l·∫°i cho ng·∫Øn g·ªçn ƒë·ªÉ b·∫£ng hi·ªÉn th·ªã ƒë·∫πp h∆°n.
            </p>
        </div>
    </details>
</div>

<style>
    .custom-scrollbar::-webkit-scrollbar { width: 6px; }
    .custom-scrollbar::-webkit-scrollbar-track { background: #f1f1f1; }
    .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
    .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
</style>
--- END FILE: ./src/components/admin/AdminMappings.svelte ---

--- START FILE: ./src/components/admin/AdminRevenueTables.svelte ---
<script>
    import { onMount } from 'svelte';
    import { customRevenueTables, modalState } from '../../stores.js';
    import { adminService } from '../../services/admin.service.js';
    
    // Load b·∫£ng h·ªá th·ªëng khi mount
    onMount(async () => {
        const tables = await adminService.loadSystemRevenueTables();
        // Merge v·ªõi local ƒë·ªÉ hi·ªÉn th·ªã ƒë·ªß (nh∆∞ng ·ªü m√†n h√¨nh Admin n√†y ta ∆∞u ti√™n hi·ªÉn th·ªã System Table ƒë·ªÉ qu·∫£n l√Ω)
        // Tuy nhi√™n, ƒë·ªÉ nh·∫•t qu√°n store, ta update store ch√≠nh
        customRevenueTables.update(current => {
            // L·ªçc b·ªè system c≈©, th√™m system m·ªõi t·ª´ cloud
            const userTables = current.filter(t => !t.isSystem);
            return [...tables, ...userTables];
        });
    });

    $: systemTables = $customRevenueTables.filter(t => t.isSystem);

    function openAddModal() {
        // M·∫∑c ƒë·ªãnh t·∫°o b·∫£ng System khi ·ªü trong trang Admin
        modalState.update(s => ({ ...s, activeModal: 'add-revenue-table-modal', payload: { isSystem: true } }));
    }

    function editTable(table) {
        modalState.update(s => ({ ...s, activeModal: 'add-revenue-table-modal', payload: table }));
    }

    async function deleteTable(id) {
        if(!confirm("B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a b·∫£ng h·ªá th·ªëng n√†y? H√†nh ƒë·ªông n√†y s·∫Ω ·∫£nh h∆∞·ªüng ƒë·∫øn to√†n b·ªô ng∆∞·ªùi d√πng.")) return;
        
        const newTables = $customRevenueTables.filter(t => t.id !== id);
        customRevenueTables.set(newTables);
        
        // L∆∞u l·∫°i danh s√°ch m·ªõi l√™n Cloud
        await adminService.saveSystemRevenueTables(newTables);
    }
</script>

<div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden mb-6 transition-all hover:shadow-md">
    <div class="p-5 bg-white border-b border-slate-100 flex justify-between items-center">
        <div class="flex items-center gap-4">
            <div class="p-2.5 bg-indigo-50 rounded-lg text-indigo-600 shadow-sm">
               <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" /></svg>
            </div>
            <div>
                <div class="flex items-center gap-3">
                    <h3 class="font-bold text-slate-800 text-lg">C·∫•u h√¨nh B·∫£ng Doanh thu (H·ªá th·ªëng)</h3>
                    <span class="bg-indigo-100 text-indigo-700 text-[10px] font-extrabold px-2 py-0.5 rounded-full uppercase tracking-wide border border-indigo-200">Global</span>
                </div>
                <p class="text-sm text-slate-500 mt-0.5">T·∫°o c√°c b·∫£ng m·∫´u hi·ªÉn th·ªã ·ªü tab "SKNV - DT Ng√†nh h√†ng" v√† "Realtime"</p>
            </div>
        </div>
        <button on:click={openAddModal} class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 font-bold shadow-sm flex items-center gap-2 text-sm transition-all">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" /></svg>
            T·∫°o b·∫£ng m·ªõi
        </button>
    </div>
    
    <div class="p-6 bg-slate-50/50">
        {#if systemTables.length === 0}
            <div class="text-center py-8 border-2 border-dashed border-slate-300 rounded-xl">
                <p class="text-slate-500 italic">Ch∆∞a c√≥ b·∫£ng h·ªá th·ªëng n√†o.</p>
            </div>
        {:else}
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                {#each systemTables as table}
                    <div class="bg-white p-4 rounded-lg border border-slate-200 shadow-sm flex flex-col hover:border-indigo-300 transition-colors group">
                        <div class="flex justify-between items-start mb-2">
                            <h4 class="font-bold text-slate-800 text-lg">{table.title}</h4>
                            <div class="flex gap-1 opacity-0 group-hover:opacity-100 transition-opacity">
                                <button class="p-1.5 text-slate-400 hover:text-blue-600 hover:bg-blue-50 rounded" title="S·ª≠a" on:click={() => editTable(table)}>
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" /></svg>
                                </button>
                                <button class="p-1.5 text-slate-400 hover:text-red-600 hover:bg-red-50 rounded" title="X√≥a" on:click={() => deleteTable(table.id)}>
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
                                </button>
                            </div>
                        </div>
                        
                        <div class="mt-auto">
                            <p class="text-xs text-slate-500 font-semibold uppercase mb-2">C·∫•u tr√∫c:</p>
                            <div class="flex flex-wrap gap-2">
                                {#each table.subColumns as col}
                                    <span class="px-2 py-1 bg-slate-100 text-slate-600 rounded text-xs border border-slate-200">
                                        {col.header} 
                                        <span class="text-slate-400 text-[10px] ml-1">
                                            ({[col.metrics.sl?'SL':'', col.metrics.dt?'DT':'', col.metrics.dtqd?'Qƒê':''].filter(Boolean).join('/')})
                                        </span>
                                    </span>
                                {/each}
                            </div>
                        </div>
                    </div>
                {/each}
            </div>
        {/if}
    </div>
</div>
--- END FILE: ./src/components/admin/AdminRevenueTables.svelte ---

--- START FILE: ./src/components/admin/AdminSpecialProducts.svelte ---
<script>
    import { specialProductList } from '../../stores.js';
    import { adminService } from '../../services/admin.service.js';
    import * as dataService from '../../services/dataService.js';
    import { onMount } from 'svelte';

    let isLoading = false;
    let showList = false;

    // Subscribe to store
    $: products = $specialProductList || [];

    async function handleFileUpload(event) {
        isLoading = true;
        try {
            await dataService.handleSpecialProductFileUpload(event);
            // Auto-save to localStorage for testing persistence
            localStorage.setItem('temp_specialProductList', JSON.stringify($specialProductList));
        } catch (error) {
            alert(error.message);
        } finally {
            isLoading = false;
        }
    }

    async function saveToCloud() {
        if (products.length === 0) return alert("Ch∆∞a c√≥ d·ªØ li·ªáu ƒë·ªÉ l∆∞u!");
        isLoading = true;
        try {
            await adminService.saveSpecialProductList(products);
            // Backup to localStorage
            localStorage.setItem('temp_specialProductList', JSON.stringify(products));
        } catch (error) {
            console.error(error);
            alert("L·ªói l∆∞u: " + error.message);
        } finally {
            isLoading = false;
        }
    }

    // Load backup on mount if store is empty (Test mode)
    onMount(() => {
        if (products.length === 0) {
            const backup = localStorage.getItem('temp_specialProductList');
            if (backup) specialProductList.set(JSON.parse(backup));
        }
    });
</script>

<div class="bg-white p-6 rounded-xl shadow-sm border border-slate-200 mt-6 transition-all hover:shadow-md">
    <div class="flex justify-between items-center mb-6">
        <h2 class="text-xl font-bold text-slate-800 flex items-center gap-2">
            <div class="p-2 bg-purple-50 rounded-lg text-purple-600">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l2.286 6.857L21 12l-5.714 2.143L13 21l-2.286-6.857L5 12l5.714-2.143L13 3z" />
                </svg>
            </div>
            S·∫£n Ph·∫©m ƒê·∫∑c Quy·ªÅn
        </h2>
        
        <div class="flex gap-2">
            <button 
                class="px-4 py-2 text-sm font-medium text-slate-600 bg-slate-100 rounded-lg hover:bg-slate-200 transition-colors"
                on:click={() => dataService.handleTemplateDownload()}
            >
                T·∫£i File M·∫´u
            </button>
            <button 
                class="px-4 py-2 text-sm font-medium text-white bg-purple-600 rounded-lg hover:bg-purple-700 transition-colors flex items-center gap-2 disabled:opacity-50"
                on:click={saveToCloud}
                disabled={isLoading}
            >
                {#if isLoading}
                    <svg class="animate-spin h-4 w-4 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                {:else}
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path d="M7.707 10.293a1 1 0 10-1.414 1.414l3 3a1 1 0 001.414 0l3-3a1 1 0 00-1.414-1.414L11 11.586V6h5a2 2 0 012 2v7a2 2 0 01-2 2H4a2 2 0 01-2-2V8a2 2 0 012-2h5v5.586l-1.293-1.293zM9 4a1 1 0 012 0v2H9V4z" /></svg>
                {/if}
                L∆∞u L√™n Cloud
            </button>
        </div>
    </div>

    <div class="mb-8 p-6 bg-purple-50/50 rounded-xl border-2 border-dashed border-purple-200 hover:border-purple-400 transition-colors text-center group">
        <input 
            type="file" 
            id="special-product-upload" 
            class="hidden" 
            accept=".xlsx, .xls"
            on:change={handleFileUpload}
        />
        <label for="special-product-upload" class="cursor-pointer flex flex-col items-center gap-3">
            <div class="p-3 bg-white rounded-full shadow-sm group-hover:scale-110 transition-transform">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-purple-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" />
                </svg>
            </div>
            <div>
                <span class="text-purple-600 font-bold hover:underline">Nh·∫•n ƒë·ªÉ t·∫£i file Excel</span>
                <span class="text-slate-500 block text-sm mt-1">Y√™u c·∫ßu c·ªôt: M√£ SP, T√™n SP, Nh√≥m h√†ng</span>
            </div>
        </label>
    </div>

    {#if products.length > 0}
        <div class="border border-slate-200 rounded-xl overflow-hidden">
            <div class="bg-slate-50 px-4 py-3 border-b flex justify-between items-center">
                <div class="flex items-center gap-2">
                    <span class="bg-green-100 text-green-700 px-2.5 py-0.5 rounded-full text-xs font-bold flex items-center gap-1">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" /></svg>
                        ƒê√£ t·∫£i {products.length} s·∫£n ph·∫©m
                    </span>
                </div>
                <button 
                    class="text-xs font-medium text-purple-600 hover:text-purple-800 hover:underline"
                    on:click={() => showList = !showList}
                >
                    {showList ? 'Thu g·ªçn danh s√°ch' : 'Xem chi ti·∫øt danh s√°ch'}
                </button>
            </div>

            {#if showList}
                <div class="overflow-x-auto max-h-96">
                    <table class="w-full text-sm text-left">
                        <thead class="text-xs text-slate-500 uppercase bg-slate-50 sticky top-0">
                            <tr>
                                <th class="px-4 py-2 w-32">M√£ SP</th>
                                <th class="px-4 py-2">T√™n S·∫£n Ph·∫©m</th>
                                <th class="px-4 py-2 w-48">Nh√≥m H√†ng</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-slate-100">
                            {#each products as item}
                                <tr class="bg-white hover:bg-purple-50 transition-colors">
                                    <td class="px-4 py-2 font-mono text-xs text-slate-500">{item.maSanPham}</td>
                                    <td class="px-4 py-2 font-medium text-slate-700">{item.tenSanPham}</td>
                                    <td class="px-4 py-2 text-slate-500 text-xs">{item.nhomHang}</td>
                                </tr>
                            {/each}
                        </tbody>
                    </table>
                </div>
            {/if}
        </div>
    {/if}
</div>
--- END FILE: ./src/components/admin/AdminSpecialProducts.svelte ---

--- START FILE: ./src/components/admin/AdminUserStats.svelte ---
<script>
    import { onMount, afterUpdate } from 'svelte';
    import { userStats } from '../../stores.js';
    import { analyticsService } from '../../services/analytics.service.js';

    let userList = [];
    let sortKey = 'lastLogin';
    let sortDirection = 'desc';
    let isLoading = false;

    onMount(async () => {
        isLoading = true;
        try {
            userList = await analyticsService.getAllUsers();
            userStats.set(userList);
        } catch (error) { console.error(error); } 
        finally { isLoading = false; }
    });

    function sortUsers(key) {
        if (sortKey === key) { sortDirection = sortDirection === 'desc' ? 'asc' : 'desc'; } 
        else { sortKey = key; sortDirection = 'desc'; }
    }

    $: sortedUsers = [...userList].sort((a, b) => {
        let valA = a[sortKey];
        let valB = b[sortKey];
        if (sortKey === 'lastLogin') {
            valA = valA ? new Date(valA).getTime() : 0;
            valB = valB ? new Date(valB).getTime() : 0;
        } else if (sortKey === 'loginCount' || sortKey === 'actionsTaken') {
            valA = Number(valA) || 0;
            valB = Number(valB) || 0;
        } else {
            valA = String(valA || '').toLowerCase();
            valB = String(valB || '').toLowerCase();
        }
        if (valA < valB) return sortDirection === 'asc' ? -1 : 1;
        if (valA > valB) return sortDirection === 'asc' ? 1 : -1;
        return 0;
    });

    function formatDate(dateVal) {
        if (!dateVal) return '-';
        const date = dateVal.toDate ? dateVal.toDate() : new Date(dateVal);
        return `${date.getHours()}:${String(date.getMinutes()).padStart(2, '0')} ${date.getDate()}/${date.getMonth()+1}`;
    }

    afterUpdate(() => { if (typeof feather !== 'undefined') feather.replace(); });
</script>

<div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden mb-6 transition-all hover:shadow-md">
    <div class="p-5 bg-white border-b border-slate-100 flex justify-between items-center">
        <div class="flex items-center gap-3">
            <div class="p-2 bg-orange-50 rounded-lg text-orange-600">
                <i data-feather="users"></i>
            </div>
            <div>
                <h3 class="font-bold text-slate-700 text-lg">Th·ªëng k√™ Ng∆∞·ªùi d√πng</h3>
                <p class="text-xs text-slate-500">Theo d√µi truy c·∫≠p v√† t·∫ßn su·∫•t s·ª≠ d·ª•ng h·ªá th·ªëng</p>
            </div>
        </div>
    </div>
    
    <div class="p-0"> 
        <div class="overflow-x-auto max-h-[500px]"> 
            {#if isLoading}
                <div class="p-10 flex flex-col justify-center items-center text-slate-400 gap-3">
                    <svg class="animate-spin h-8 w-8 text-orange-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                    <span class="text-sm">ƒêang t·∫£i d·ªØ li·ªáu...</span>
                </div>
            {:else if userList.length === 0}
                <div class="p-10 text-center text-slate-400 italic bg-slate-50/50">
                    <i data-feather="user-x" class="w-8 h-8 mx-auto mb-2 opacity-50"></i>
                    Ch∆∞a c√≥ d·ªØ li·ªáu ng∆∞·ªùi d√πng.
                </div>
            {:else}
                <table class="min-w-full text-sm border-collapse">
                    <thead class="text-xs text-slate-500 uppercase bg-slate-50 sticky top-0 z-10">
                        <tr>
                            <th class="px-6 py-3 text-left font-semibold cursor-pointer hover:bg-slate-100" on:click={() => sortUsers('email')}>Email</th>
                            <th class="px-6 py-3 text-right font-semibold cursor-pointer hover:bg-slate-100" on:click={() => sortUsers('loginCount')}>Truy c·∫≠p</th>
                            <th class="px-6 py-3 text-right font-semibold cursor-pointer hover:bg-slate-100" on:click={() => sortUsers('actionsTaken')}>Thao t√°c</th>
                            <th class="px-6 py-3 text-right font-semibold cursor-pointer hover:bg-slate-100" on:click={() => sortUsers('lastLogin')}>L·∫ßn cu·ªëi</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-slate-100">
                        {#each sortedUsers as user}
                            <tr class="hover:bg-orange-50/30 transition-colors group/row">
                                <td class="px-6 py-3 font-medium text-slate-700 group-hover/row:text-orange-700">{user.email}</td>
                                <td class="px-6 py-3 text-right font-mono text-slate-600 bg-slate-50/50">{user.loginCount || 0}</td>
                                <td class="px-6 py-3 text-right font-mono text-slate-600">{user.actionsTaken || 0}</td>
                                <td class="px-6 py-3 text-right text-xs text-slate-400">{formatDate(user.lastLogin)}</td>
                            </tr>
                        {/each}
                    </tbody>
                </table>
            {/if}
        </div> 
    </div>
</div>
--- END FILE: ./src/components/admin/AdminUserStats.svelte ---

--- START FILE: ./src/components/common/FileInput.svelte ---
<script>
  /* global feather */
  import { onMount } from 'svelte';
  // [FIX] Import ƒë√∫ng object dataService
  import { dataService } from '../../services/dataService.js';
  import { 
    danhSachNhanVien, rawGioCongData, ycxData, thuongNongData,
    ycxDataThangTruoc, thuongNongDataThangTruoc,
    fileSyncState 
  } from '../../stores.js';

  export let label = "Ch∆∞a c√≥ nh√£n";
  export let icon = "file";
  export let saveKey = ""; 

  let fileName = "Ch∆∞a th√™m file";
  let statusHTML = ""; 
  let isLoading = false;
  let statusClass = "text-gray-500";
  let localError = ""; // [FIX] Bi·∫øn l∆∞u l·ªói c·ª•c b·ªô
  
  const storeMap = {
    'saved_danhsachnv': danhSachNhanVien,
    'saved_giocong': rawGioCongData,
    'saved_ycx': ycxData,
    'saved_thuongnong': thuongNongData,
    'saved_ycx_thangtruoc': ycxDataThangTruoc,
    'saved_thuongnong_thangtruoc': thuongNongDataThangTruoc
  };
  let dataStore = storeMap[saveKey];

  $: syncState = $fileSyncState[saveKey];
  $: dataCount = $dataStore ? $dataStore.length : 0;

  // Logic hi·ªÉn th·ªã tr·∫°ng th√°i (Reactive)
  $: {
      if (isLoading) {
          statusHTML = "ƒêang x·ª≠ l√Ω...";
          statusClass = "text-blue-600 font-semibold";
      } else if (localError) {
          // [FIX] ∆Øu ti√™n hi·ªÉn th·ªã l·ªói n·∫øu c√≥
          statusHTML = localError;
          statusClass = "text-red-600 font-bold";
      } else if (syncState) {
          if (syncState.status === 'update_available') {
              statusClass = "text-orange-600 font-semibold";
              statusHTML = `
                  <span>${syncState.message}</span>
                  <button class="ml-2 px-2 py-0.5 bg-blue-100 text-blue-700 text-xs rounded hover:bg-blue-200 border border-blue-300 font-bold btn-download-cloud pointer-events-auto">
                      T·∫£i & X·ª≠ l√Ω
                  </button>
              `;
          } else if (syncState.status === 'downloading') {
              statusClass = "text-blue-600";
              statusHTML = syncState.message;
          } else if (syncState.status === 'error') {
              statusClass = "text-red-600";
              statusHTML = syncState.message;
          } else {
              // Synced ho·∫∑c Cached
              statusClass = "text-green-600 font-medium";
              statusHTML = syncState.message;
              if (syncState.metadata?.fileName) fileName = syncState.metadata.fileName;
          }
      } else if (dataCount > 0) {
          // Fallback khi ch∆∞a c√≥ syncState nh∆∞ng c√≥ data trong store
          statusClass = "text-green-600";
          statusHTML = `‚úì ƒê√£ t·∫£i ${dataCount} d√≤ng (Local)`;
          
          if (saveKey === 'saved_danhsachnv') {
               const savedName = localStorage.getItem('_localDsnvFilename');
               if(savedName) fileName = savedName;
          }
      } else {
          statusHTML = "";
      }
  }

  async function handleChange(event) {
    const file = event.target.files[0];
    if (!file) return;
    
    isLoading = true;
    localError = ""; // Reset l·ªói c≈©
    fileName = file.name;

    try {
      // G·ªçi service
      const result = await dataService.handleFileChange(file, saveKey);
      
      if (!result.success) {
          localError = result.message;
      }
    } catch (err) {
      console.error(err);
      localError = `L·ªói: ${err.message}`;
    } finally {
      isLoading = false;
      event.target.value = null;
    }
  }

  function handleContainerClick(e) {
      if (e.target.closest('.btn-download-cloud')) {
          e.preventDefault(); 
          e.stopPropagation();
          dataService.downloadFileFromCloud(saveKey);
      }
  }
  
  onMount(() => {
     if (typeof feather !== 'undefined') feather.replace();
  });
</script>

<div class="data-input-group input-group--yellow" on:click={handleContainerClick}> 
    <div class="data-input-group__label"> 
       <i data-feather={icon} class="h-5 w-5 feather"></i>
        <span>{label}:</span>
    </div> 
    <div class="data-input-group__content"> 
        <div class="flex items-center gap-2"> 
            <label for="file-{saveKey}" class="data-input-group__file-trigger" class:opacity-50={isLoading}>
                {isLoading ? 'ƒêang ch·∫°y...' : 'Th√™m file'}
            </label>
            <span class="data-input-group__file-name" title={fileName}>{fileName}</span> 
        </div> 
        
        {#if saveKey === 'saved_danhsachnv'}
            <button on:click={() => dataService.handleTemplateDownload()} class="data-input-group__link text-left">T·∫£i file m·∫´u</button> 
        {/if}

        <input type="file" id="file-{saveKey}" class="hidden" accept=".xlsx, .xls, .csv" on:change={handleChange} disabled={isLoading}> 
        
        <div class="data-input-group__status-wrapper"> 
            <span class="data-input-group__status-text {statusClass}">{@html statusHTML}</span> 
        </div> 
        
        {#if isLoading || (syncState && syncState.status === 'downloading')}
            <div class="progress-bar-container">
                <div class="progress-bar" style="width: 100%; background-color: #3b82f6;"></div>
            </div>
        {/if}
    </div> 
</div>
--- END FILE: ./src/components/common/FileInput.svelte ---

--- START FILE: ./src/components/common/GlobalNotification.svelte ---
<script>
  import { notificationStore } from '../../stores.js';
</script>

{#if $notificationStore.visible}
  <div 
    class="fixed bottom-5 right-5 p-4 rounded-lg shadow-md text-white z-[1200] transition-all duration-500 transform translate-y-0
           {$notificationStore.type === 'success' ? 'bg-green-500' : 'bg-red-500'}"
    role="alert"
  >
    {$notificationStore.message}
  </div>
{/if}
--- END FILE: ./src/components/common/GlobalNotification.svelte ---

--- START FILE: ./src/components/common/PasteInput.svelte ---
<script>
  /* global feather */
  import { onMount } from 'svelte';
  import { dataService } from '../../services/dataService.js';
  import { 
    competitionData,
    pastedThiDuaReportData,
    thuongERPData,
    thuongERPDataThangTruoc,
    fileSyncState 
  } from '../../stores.js';

  export let label = "Ch∆∞a c√≥ nh√£n";
  export let icon = "clipboard";
  export let link = "#"; 
  export let saveKeyPaste = ""; 
  export let saveKeyRaw = ""; 
  export let saveKeyProcessed = ""; 

  let textareaEl;
  let pastedText = "";
  let localError = "";

  const storeMap = {
    'daily_paste_luyke': competitionData,
    'daily_paste_thiduanv': pastedThiDuaReportData,
    'daily_paste_thuongerp': thuongERPData,
    'saved_thuongerp_thangtruoc': thuongERPDataThangTruoc
  };
  
  const unitMap = {
    'daily_paste_luyke': 'CT thi ƒëua',
    'daily_paste_thiduanv': 'nh√¢n vi√™n',
    'daily_paste_thuongerp': 'nh√¢n vi√™n',
    'saved_thuongerp_thangtruoc': 'nh√¢n vi√™n'
  };

  const countStore = storeMap[saveKeyProcessed || saveKeyPaste];

  $: syncState = $fileSyncState[saveKeyPaste];
  $: dataCount = countStore ? $countStore?.length || 0 : 0;

  let statusHTML = "";
  let statusClass = "text-gray-500";
  let isLoading = false;

  $: {
      const unit = unitMap[saveKeyPaste] || 'd√≤ng';
      const countDisplay = `(${dataCount} ${unit})`;

      if (isLoading) {
          statusHTML = "ƒêang x·ª≠ l√Ω...";
          statusClass = "text-blue-600 font-semibold";
      } else if (localError) {
          statusHTML = localError;
          statusClass = "text-red-600 font-bold";
      } else if (syncState) {
          if (syncState.status === 'update_available') {
              statusClass = "text-orange-600 font-semibold";
              const msg = syncState.message || "C√≥ d·ªØ li·ªáu m·ªõi";
              statusHTML = `
                  <span class="mr-2">${msg}</span>
                  <button class="px-2 py-0.5 bg-blue-100 text-blue-700 text-xs rounded hover:bg-blue-200 border border-blue-300 font-bold btn-download-cloud pointer-events-auto shadow-sm">
                      T·∫£i & X·ª≠ l√Ω
                  </button>
              `;
          } else if (syncState.status === 'downloading') {
              statusClass = "text-blue-600";
              statusHTML = syncState.message || "ƒêang t·∫£i...";
          } else if (syncState.status === 'error') {
              statusClass = "text-red-600";
              statusHTML = syncState.message;
          } else if (syncState.status === 'synced' || syncState.status === 'cached') {
              // [FIX LOGIC] Ch·ªâ b√°o l·ªói 0 NV n·∫øu ƒê√É C√ì TEXT (pastedText > 0)
              // N·∫øu pastedText tr·ªëng, nghƒ©a l√† ch∆∞a t·∫£i n·ªôi dung v·ªÅ, th√¨ kh√¥ng coi l√† l·ªói
              if (dataCount === 0 && saveKeyPaste === 'daily_paste_thiduanv' && pastedText.length > 0) {
                  statusClass = "text-red-600 font-bold";
                  statusHTML = `‚ö† ƒê√£ x·ª≠ l√Ω 0 NV. Vui l√≤ng ki·ªÉm tra DSNV!`;
              } else {
                  statusClass = "text-green-600 font-medium";
                  const prefix = syncState.status === 'synced' ? '‚úì ƒê√£ ƒë·ªìng b·ªô' : '‚úì ƒê√£ t·∫£i';
                  let cleanMsg = syncState.message
                      .replace('‚úì ƒê√£ ƒë·ªìng b·ªô', '')
                      .replace('‚úì ƒê√£ t·∫£i', '')
                      .replace('(Local)', '')
                      .trim();
                  
                  // Logic hi·ªÉn th·ªã th√¥ng minh: N·∫øu ch∆∞a c√≥ text, g·ª£i √Ω t·∫£i
                  if (pastedText.length === 0 && syncState.status === 'synced') {
                      // ƒê√£ ƒë·ªìng b·ªô metadata nh∆∞ng ch∆∞a c√≥ text -> Hi·ªÉn th·ªã n√∫t t·∫£i l·∫°i cho ch·∫Øc
                       statusHTML = `
                          <span class="mr-2 text-gray-500">‚úì ƒê√£ bi·∫øt c√≥ d·ªØ li·ªáu tr√™n Cloud.</span>
                          <button class="px-2 py-0.5 bg-green-50 text-green-700 text-xs rounded hover:bg-green-100 border border-green-200 font-bold btn-download-cloud pointer-events-auto shadow-sm">
                              T·∫£i v·ªÅ m√°y
                          </button>
                      `;
                  } else {
                       // Hi·ªÉn th·ªã b√¨nh th∆∞·ªùng
                       if (cleanMsg.includes('d√≤ng') || cleanMsg.includes('nh√¢n vi√™n') || cleanMsg.includes('CT')) {
                           if(cleanMsg.includes('tr∆∞·ªõc') || cleanMsg.includes('v·ª´a xong')) {
                               statusHTML = `${prefix} ${countDisplay} ${cleanMsg}`;
                           } else {
                               statusHTML = `${prefix} ${countDisplay}`;
                           }
                      } else {
                           statusHTML = `${prefix} ${countDisplay} ${cleanMsg}`;
                      }
                  }
              }
          } else if (syncState.status === 'checking') {
               statusClass = "text-gray-500 italic";
               statusHTML = "ƒêang ki·ªÉm tra ƒë·ªìng b·ªô...";
          }
      } else if (dataCount > 0) {
          statusClass = "text-green-600";
          statusHTML = `‚úì ƒê√£ t·∫£i ${countDisplay} (Local)`;
      } else {
          statusHTML = "";
      }
  }

  onMount(() => {
    const textLoadKey = saveKeyRaw || saveKeyPaste;
    pastedText = localStorage.getItem(textLoadKey) || "";
    
    window.addEventListener('cloud-paste-loaded', (e) => {
        if (e.detail.key === saveKeyPaste) {
            pastedText = e.detail.text;
        }
    });

    if (typeof feather !== 'undefined') feather.replace();
  });

  let pasteTimer;
  function handleInput(event) {
      const text = event.target.value;
      pastedText = text;
      localError = "";
      clearTimeout(pasteTimer);
      
      if (!text || text.trim().length < 5) return;
      
      isLoading = true;
      pasteTimer = setTimeout(async () => {
          try {
            const result = await dataService.handlePasteChange(
                text, 
                saveKeyPaste, 
                saveKeyRaw, 
                saveKeyProcessed
            );
            if (!result.success) localError = result.message;
          } catch (err) {
            console.error(`L·ªói paste ${label}:`, err);
            localError = `L·ªói: ${err.message}`;
          } finally {
            isLoading = false;
          }
      }, 500);
  }

  function handleContainerClick(e) {
      if (e.target.closest('.btn-download-cloud')) {
          e.preventDefault();
          e.stopPropagation();
          dataService.downloadFileFromCloud(saveKeyPaste);
      }
  }
</script>

<div class="data-input-group input-group--blue h-full" on:click={handleContainerClick}>
    <a href={link} target="_blank" class="data-input-group__label data-input-group__label--link">
        <i data-feather={icon} class="h-5 w-5 feather"></i>
        <span>{label}: <span class="font-normal text-xs text-gray-500 ml-1">(Copy t·ª´ BI)</span></span>
    </a>
    <div class="data-input-group__content flex flex-col flex-grow">
        <textarea 
            bind:this={textareaEl}
            rows="5" 
            class="data-textarea flex-grow mb-1" 
            placeholder="D√°n d·ªØ li·ªáu ƒë√£ sao ch√©p v√†o ƒë√¢y..."
            on:input={handleInput}
            value={pastedText}
            disabled={isLoading}
        ></textarea>
        
        <div class="data-input-group__status-wrapper min-h-[20px]">
            <span class="data-input-group__status-text {statusClass} flex items-center gap-1">
                {@html statusHTML}
            </span>
        </div>
        
        {#if isLoading || (syncState && syncState.status === 'downloading')}
             <div class="progress-bar-container mt-1">
                <div class="progress-bar" style="width: 100%; background-color: #3b82f6;"></div>
            </div>
        {/if}
    </div>
</div>
--- END FILE: ./src/components/common/PasteInput.svelte ---

--- START FILE: ./src/components/common/SortableTh.svelte ---
<script>
  import { createEventDispatcher } from 'svelte';
  
  // Props
  export let key = '';           // Key ƒë·ªãnh danh c·ªôt
  export let label = '';         // T√™n hi·ªÉn th·ªã
  export let sortKey = '';       // C·ªôt ƒëang ƒë∆∞·ª£c sort
  export let sortDirection = 'desc'; // H∆∞·ªõng sort
  export let align = 'left';     // CƒÉn l·ªÅ: left, right, center
  export let className = '';     // Class t√πy ch·ªânh th√™m (vd: sticky, width)

  const dispatch = createEventDispatcher();

  function handleClick() {
    dispatch('sort', key);
  }

  $: isActive = sortKey === key;
  
  // Logic cƒÉn l·ªÅ flexbox
  $: alignClass = align === 'right' ? 'justify-end' : 
                  align === 'center' ? 'justify-center' : 
                  'justify-start';

  // Logic cƒÉn l·ªÅ text
  $: textAlignClass = align === 'right' ? 'text-right' : 
                      align === 'center' ? 'text-center' : 
                      'text-left';
</script>

<th 
  class="px-4 py-3 cursor-pointer transition select-none hover:bg-slate-200 {textAlignClass} {className} {isActive ? 'bg-blue-50' : ''}"
  on:click={handleClick}
  role="columnheader"
  aria-sort={isActive ? (sortDirection === 'asc' ? 'ascending' : 'descending') : 'none'}
>
  <div class="flex items-center gap-1 {alignClass}">
    <span class="font-bold uppercase text-xs {isActive ? 'text-blue-800' : 'text-slate-700'}">
      {label}
    </span>
    
    <span class="flex flex-col items-center justify-center w-4 h-4">
      {#if !isActive}
        <svg xmlns="http://www.w3.org/2000/svg" class="w-3 h-3 text-gray-400 opacity-50" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
          <path stroke-linecap="round" stroke-linejoin="round" d="M7 16V4m0 0L3 8m4-4l4 4m6 0v12m0 0l4-4m-4 4l-4-4" />
        </svg>
      {:else if sortDirection === 'asc'}
        <svg xmlns="http://www.w3.org/2000/svg" class="w-3.5 h-3.5 text-blue-700" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="3">
          <path stroke-linecap="round" stroke-linejoin="round" d="M5 15l7-7 7 7" />
        </svg>
      {:else}
        <svg xmlns="http://www.w3.org/2000/svg" class="w-3.5 h-3.5 text-blue-700" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="3">
          <path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7" />
        </svg>
      {/if}
    </span>
  </div>
</th>
--- END FILE: ./src/components/common/SortableTh.svelte ---

--- START FILE: ./src/components/drawers/GoalDrawer.svelte ---
<script>
    import { onMount, afterUpdate } from 'svelte';
    import { 
        drawerState, 
        warehouseList, 
        luykeGoalSettings, 
        realtimeGoalSettings,
        modalState,
        localCompetitionConfigs, 
        selectedWarehouse,
        efficiencyConfig // C·∫•u h√¨nh admin
    } from '../../stores.js';
    import { settingsService } from '../../services/settings.service.js';
    import { datasyncService } from '../../services/datasync.service.js';
    import { adminService } from '../../services/admin.service.js';
    
    let activeTab = 'monthly';
    let localSelectedWarehouse = ''; 
    
    let currentLuykeGoals = {};
    let currentRealtimeGoals = { goals: {}, timing: {} };

    $: isOpen = $drawerState.activeDrawer === 'goal-drawer';

    // T·ª± ƒë·ªông ch·ªçn kho
    $: if (isOpen && !localSelectedWarehouse) {
        localSelectedWarehouse = $selectedWarehouse || ($warehouseList.length > 0 ? $warehouseList[0] : '');
    }

    // [M·ªöI] Khi ƒë·ªïi kho, t·∫£i d·ªØ li·ªáu t·ª´ Cloud
    $: if (isOpen && localSelectedWarehouse) {
        loadGoals(localSelectedWarehouse);
    }

    async function loadGoals(kho) {
        await settingsService.loadGoalsFromCloud(kho);
        
        // C·∫≠p nh·∫≠t bi·∫øn local ƒë·ªÉ bind v√†o input
        currentLuykeGoals = { ...($luykeGoalSettings[kho] || {}) };
        
        const rtSettings = $realtimeGoalSettings[kho] || { goals: {}, timing: {} };
        currentRealtimeGoals = {
            goals: { ...rtSettings.goals },
            timing: { ...rtSettings.timing }
        };
    }
    
    onMount(async () => {
        const configs = await adminService.loadEfficiencyConfig();
        efficiencyConfig.set(configs);
        if (typeof feather !== 'undefined') feather.replace();
    });

    afterUpdate(() => {
        if (typeof feather !== 'undefined') feather.replace();
    });

    function close() {
        drawerState.update(s => ({ ...s, activeDrawer: null }));
    }

    function switchTab(tab) {
        activeTab = tab;
    }

    function saveLuyke() {
        if (!localSelectedWarehouse) return;
        settingsService.saveLuykeGoalForWarehouse(localSelectedWarehouse, currentLuykeGoals);
    }

    function saveRealtime() {
        if (!localSelectedWarehouse) return;
        settingsService.saveRealtimeGoalForWarehouse(localSelectedWarehouse, currentRealtimeGoals);
    }

    // C√°c h√†m qu·∫£n l√Ω thi ƒëua (gi·ªØ nguy√™n)
    function openCompetitionManager() {
        if (localSelectedWarehouse) selectedWarehouse.set(localSelectedWarehouse);
        modalState.update(s => ({ ...s, activeModal: 'user-competition-modal' }));
    }
    function editCompetition(index) {
        if (localSelectedWarehouse) selectedWarehouse.set(localSelectedWarehouse);
        modalState.update(s => ({ ...s, activeModal: 'user-competition-modal', editingIndex: index }));
    }
    async function deleteCompetition(index) {
        if (!confirm("B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a ch∆∞∆°ng tr√¨nh thi ƒëua n√†y?")) return;
        let newConfigs = [...$localCompetitionConfigs];
        newConfigs.splice(index, 1);
        localCompetitionConfigs.set(newConfigs);
        if (localSelectedWarehouse) {
            try { await datasyncService.saveCompetitionConfigs(localSelectedWarehouse, newConfigs); } catch(e) { console.error(e); }
        }
    }

    const percentageInputs = [
        { id: 'phanTramQD', label: '% Quy ƒë·ªïi' },
        { id: 'phanTramTC', label: '% Tr·∫£ ch·∫≠m' }
    ];
</script>

{#if isOpen}
    <div class="fixed inset-0 bg-black/40 z-40 transition-opacity" on:click={close} role="button" tabindex="0"></div>
{/if}

<div class="fixed top-0 left-0 h-full bg-white shadow-2xl z-50 p-6 overflow-y-auto w-[500px] max-w-[95vw] transition-transform duration-300 ease-in-out transform {isOpen ? 'translate-x-0' : '-translate-x-full'}">
    
    <div class="flex justify-between items-center mb-6">
        <h3 class="text-xl font-bold text-gray-800">Thi·∫øt l·∫≠p m·ª•c ti√™u</h3>
        <button class="text-gray-500 hover:text-gray-800 text-3xl leading-none" on:click={close}>&times;</button>
    </div>

    <div class="border-b border-gray-200 mb-6 flex space-x-6">
        <button class="pb-2 border-b-2 font-medium text-sm transition-colors {activeTab === 'monthly' ? 'border-blue-600 text-blue-600' : 'border-transparent text-gray-500 hover:text-gray-700'}" on:click={() => switchTab('monthly')}>
            M·ª•c ti√™u Th√°ng (L≈©y k·∫ø)
        </button>
        <button class="pb-2 border-b-2 font-medium text-sm transition-colors {activeTab === 'daily' ? 'border-blue-600 text-blue-600' : 'border-transparent text-gray-500 hover:text-gray-700'}" on:click={() => switchTab('daily')}>
            M·ª•c ti√™u Ng√†y (Realtime)
        </button>
    </div>

    <div class="space-y-8">
        <div>
            <label for="goal-warehouse" class="block text-sm font-bold text-gray-700 mb-1">Thi·∫øt l·∫≠p cho kho</label>
            <select id="goal-warehouse" class="w-full p-2.5 border border-gray-300 rounded-lg text-sm bg-white shadow-sm focus:ring-2 focus:ring-blue-500 outline-none font-semibold text-blue-700" bind:value={localSelectedWarehouse}>
                {#if $warehouseList.length === 0}
                    <option value="">Vui l√≤ng t·∫£i file DSNV...</option>
                {:else}
                    {#each $warehouseList as kho}
                        <option value={kho}>{kho}</option>
                    {/each}
                {/if}
            </select>
        </div>

        {#if activeTab === 'monthly'}
            <div class="space-y-5 animate-fade-in">
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label for="luyke-dtt" class="block text-sm font-medium text-gray-700">Target DT Th·ª±c</label>
                        <input type="number" id="luyke-dtt" class="luyke-goal-input mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500" bind:value={currentLuykeGoals.doanhThuThuc} on:input={saveLuyke}>
                    </div>
                    <div>
                        <label for="luyke-dtqd" class="block text-sm font-medium text-gray-700">Target DT Qƒê</label>
                        <input type="number" id="luyke-dtqd" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500" bind:value={currentLuykeGoals.doanhThuQD} on:input={saveLuyke}>
                    </div>
                </div>

                <details class="group border rounded-lg overflow-hidden" open>
                    <summary class="p-3 text-sm font-bold cursor-pointer bg-gray-50 hover:bg-gray-100 flex justify-between items-center select-none">
                         M·ª•c ti√™u khai th√°c (%)
                        <span class="transform group-open:rotate-180 transition-transform">‚ñº</span>
                    </summary>
                    <div class="p-4 bg-white border-t grid grid-cols-2 gap-4">
                        {#each percentageInputs as input}
                            <div>
                                <label for="luyke-{input.id}" class="block text-sm font-medium text-gray-700">{input.label}</label>
                                <input type="number" id="luyke-{input.id}" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500" bind:value={currentLuykeGoals[input.id]} on:input={saveLuyke}>
                            </div>
                        {/each}
                        
                        {#each $efficiencyConfig as item}
                            <div>
                                <label for="goal-{item.id}" class="block text-sm font-medium text-gray-700 truncate" title={item.label}>
                                    {item.label} (MT: {item.target}%)
                                </label>
                                <input 
                                    type="number" 
                                    id="goal-{item.id}" 
                                    class="mt-1 block w-full p-2 border border-blue-200 bg-blue-50 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500" 
                                    placeholder={item.target} 
                                    bind:value={currentLuykeGoals[item.id]} 
                                    on:input={saveLuyke}
                                >
                            </div>
                        {/each}
                    </div>
                </details>
            </div>
        {/if}

        {#if activeTab === 'daily'}
            <div class="space-y-5 animate-fade-in">
                <div class="grid grid-cols-2 gap-4 items-end">
                    <div>
                        <label for="rt-open" class="block text-sm font-medium text-gray-700 mb-1">Gi·ªù m·ªü c·ª≠a</label>
                        <input type="time" id="rt-open" class="p-2 border border-gray-300 rounded-md shadow-sm w-full" bind:value={currentRealtimeGoals.timing['rt-open-hour']} on:input={saveRealtime}>
                    </div>
                    <div>
                        <label for="rt-close" class="block text-sm font-medium text-gray-700 mb-1">Gi·ªù ƒë√≥ng c·ª≠a</label>
                        <input type="time" id="rt-close" class="p-2 border border-gray-300 rounded-md shadow-sm w-full" bind:value={currentRealtimeGoals.timing['rt-close-hour']} on:input={saveRealtime}>
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label for="rt-dtt" class="block text-sm font-medium text-gray-700">DT Th·ª±c (tri·ªáu)</label>
                        <input type="number" id="rt-dtt" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500" bind:value={currentRealtimeGoals.goals.doanhThuThuc} on:input={saveRealtime}>
                    </div>
                    <div>
                        <label for="rt-dtqd" class="block text-sm font-medium text-gray-700">DT Qƒê (tri·ªáu)</label>
                        <input type="number" id="rt-dtqd" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500" bind:value={currentRealtimeGoals.goals.doanhThuQD} on:input={saveRealtime}>
                    </div>
                </div>
                
                <details class="group border rounded-lg overflow-hidden" open>
                    <summary class="p-3 text-sm font-bold cursor-pointer bg-gray-50 hover:bg-gray-100 flex justify-between items-center select-none">
                         M·ª•c ti√™u t·ª∑ l·ªá Realtime (%)
                        <span class="transform group-open:rotate-180 transition-transform">‚ñº</span>
                    </summary>
                    <div class="p-4 bg-white border-t grid grid-cols-2 gap-4">
                        {#each percentageInputs as input}
                            <div>
                                <label for="rt-{input.id}" class="block text-sm font-medium text-gray-700">{input.label}</label>
                                <input type="number" id="rt-{input.id}" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500" bind:value={currentRealtimeGoals.goals[input.id]} on:input={saveRealtime}>
                            </div>
                        {/each}
                         {#each $efficiencyConfig as item}
                            <div>
                                <label for="rt-goal-{item.id}" class="block text-sm font-medium text-gray-700 truncate" title={item.label}>{item.label}</label>
                                <input type="number" id="rt-goal-{item.id}" class="mt-1 block w-full p-2 border border-blue-200 bg-blue-50 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500" placeholder={item.target} bind:value={currentRealtimeGoals.goals[item.id]} on:input={saveRealtime}>
                            </div>
                        {/each}
                    </div>
                </details>
            </div>
        {/if}

        <div class="border-t pt-6 space-y-4">
            <div class="flex justify-between items-center">
                <h4 class="text-lg font-bold text-gray-800">Qu·∫£n l√Ω Ch∆∞∆°ng tr√¨nh Thi ƒëua</h4>
                <button on:click={openCompetitionManager} class="text-sm bg-blue-600 text-white px-3 py-1.5 rounded-lg hover:bg-blue-700 font-medium flex items-center gap-1 shadow-sm"><i data-feather="plus-circle" class="w-4 h-4"></i> T·∫°o m·ªõi</button>
            </div>
            <div class="space-y-3 max-h-[300px] overflow-y-auto pr-1 custom-scrollbar pb-2">
                {#if $localCompetitionConfigs.length === 0}
                    <div class="text-center py-6 bg-gray-50 rounded-lg border border-dashed border-gray-300">
                        <p class="text-gray-500 text-sm italic">Ch∆∞a c√≥ ch∆∞∆°ng tr√¨nh n√†o.</p>
                    </div>
                {:else}
                    {#each $localCompetitionConfigs as config, index}
                        <div class="bg-white border border-gray-200 rounded-xl p-4 shadow-sm relative group hover:border-blue-300 hover:shadow-md transition-all">
                            <h4 class="text-lg font-bold text-gray-800 mb-2 pr-16">{config.name}</h4>
                            <div class="text-sm mb-1"><span class="font-semibold text-gray-600">H√£ng:</span> <span class="font-bold text-blue-600 ml-1">{config.brands.join(', ')}</span></div>
                            <div class="absolute top-4 right-4 flex gap-2">
                                <button on:click={() => editCompetition(index)} class="p-1.5 text-gray-400 hover:text-blue-600 hover:bg-blue-50 rounded-md transition-colors"><i data-feather="edit-2" class="w-4 h-4"></i></button>
                                <button on:click={() => deleteCompetition(index)} class="p-1.5 text-gray-400 hover:text-red-600 hover:bg-red-50 rounded-md transition-colors"><i data-feather="trash-2" class="w-4 h-4"></i></button>
                            </div>
                        </div>
                    {/each}
                {/if}
            </div>
        </div>
    </div>
</div>

<style>
    @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
    .animate-fade-in { animation: fadeIn 0.3s ease-out; }
    .custom-scrollbar::-webkit-scrollbar { width: 4px; }
    .custom-scrollbar::-webkit-scrollbar-track { background: #f1f1f1; }
    .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 2px; }
    .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
</style>
--- END FILE: ./src/components/drawers/GoalDrawer.svelte ---

--- START FILE: ./src/components/drawers/InterfaceDrawer.svelte ---
<script>
    import { drawerState, interfaceSettings } from '../../stores.js';
    // [FIX] C·∫≠p nh·∫≠t ƒë∆∞·ªùng d·∫´n settings service
    import { settingsService } from '../../services/settings.service.js';
    import { onMount } from 'svelte';

    // ... (Gi·ªØ nguy√™n ph·∫ßn code c√≤n l·∫°i)
    $: isOpen = $drawerState.activeDrawer === 'interface-drawer';

    function close() {
        drawerState.update(s => ({ ...s, activeDrawer: null }));
    }

    function onContrastChange(event) {
        const level = event.target.value;
        settingsService.updateContrast(level);
    }

    function onSettingChange() {
        settingsService.updateInterface($interfaceSettings);
    }
    
    onMount(() => {
        settingsService.loadInterfaceSettings();
    });
</script>

{#if isOpen}
    <div 
        class="fixed inset-0 bg-black/40 z-40 transition-opacity"
        on:click={close}
        role="button"
        tabindex="0"
    ></div>
{/if}

<div 
    class="fixed top-0 left-0 h-full bg-white shadow-2xl z-50 p-6 overflow-y-auto w-[400px] max-w-[90vw] transition-transform duration-300 ease-in-out transform {isOpen ? 'translate-x-0' : '-translate-x-full'}"
>
    <div class="flex justify-between items-center mb-6">
        <h3 class="text-xl font-bold text-gray-800">C√†i ƒë·∫∑t giao di·ªán</h3>
        <button 
            class="text-gray-500 hover:text-gray-800 text-3xl leading-none"
            on:click={close}
        >&times;</button>
    </div>
    <div class="space-y-6">
        <div>
            <label for="contrast-selector" class="block text-sm font-medium text-gray-700 mb-2">ƒê·ªô t∆∞∆°ng ph·∫£n</label>
            <select 
                id="contrast-selector" 
                class="w-full p-2 border rounded-lg text-sm bg-white shadow-sm focus:ring-2 focus:ring-blue-500 outline-none"
                value={$interfaceSettings.contrastLevel || '3'}
                on:change={onContrastChange}
            >
                <option value="1">R·∫•t nh·∫π</option>
                <option value="2">Nh·∫π</option>
                <option value="3">B√¨nh th∆∞·ªùng</option>
                <option value="4">Cao</option>
                <option value="5">R·∫•t cao</option>
                <option value="6">Cao nh·∫•t</option>
            </select>
        </div>

        <div>
            <label for="global-font-size-slider" class="flex justify-between text-sm font-medium text-gray-700 mb-2">
                <span>C·ª° ch·ªØ to√†n trang</span>
                <span class="font-bold text-blue-600">{$interfaceSettings.globalFontSize}px</span>
            </label>
            <input 
                type="range" 
                id="global-font-size-slider" 
                min="12" max="25" step="1" 
                class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-blue-600"
                bind:value={$interfaceSettings.globalFontSize}
                on:input={onSettingChange}
            >
        </div>

        <div>
             <label for="kpi-font-size-slider" class="flex justify-between text-sm font-medium text-gray-700 mb-2">
                <span>C·ª° ch·ªØ th·∫ª KPI</span>
                <span class="font-bold text-blue-600">{$interfaceSettings.kpiFontSize}px</span>
            </label>
            <input 
                type="range" 
                id="kpi-font-size-slider" 
                min="24" max="48" step="2" 
                class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-blue-600"
                bind:value={$interfaceSettings.kpiFontSize}
                on:input={onSettingChange}
            >
        </div>

        <div>
            <h4 class="text-sm font-medium text-gray-700 mb-2">M√†u s·∫Øc th·∫ª KPI</h4>
            <div class="grid grid-cols-2 gap-4">
                {#each [1, 2, 3, 4, 5, 6, 7, 8] as num}
                    <div class="flex items-center gap-2">
                        <input 
                            type="color" 
                            id="kpi-color-{num}" 
                            class="p-1 h-10 w-14 block bg-white border border-gray-300 cursor-pointer rounded-lg"
                            bind:value={$interfaceSettings[`kpiCard${num}Bg`]}
                            on:input={onSettingChange}
                        >
                        <label for="kpi-color-{num}" class="text-sm">Th·∫ª {num}</label>
                    </div>
                {/each}
            </div>
        </div>

        <div>
            <h4 class="text-sm font-medium text-gray-700 mb-2">M√†u ch·ªØ th·∫ª KPI</h4>
             <div class="space-y-2">
                 <div class="flex items-center gap-2">
                    <input 
                        type="color" 
                        id="kpi-title-color" 
                        class="p-1 h-10 w-14 block bg-white border border-gray-300 cursor-pointer rounded-lg"
                        bind:value={$interfaceSettings.kpiTitleColor}
                        on:input={onSettingChange}
                    >
                    <label for="kpi-title-color" class="text-sm">Ti√™u ƒë·ªÅ th·∫ª</label>
                </div>
                <div class="flex items-center gap-2">
                    <input 
                        type="color" 
                        id="kpi-main-color" 
                        class="p-1 h-10 w-14 block bg-white border border-gray-300 cursor-pointer rounded-lg"
                        bind:value={$interfaceSettings.kpiMainColor}
                        on:input={onSettingChange}
                    >
                    <label for="kpi-main-color" class="text-sm">Gi√° tr·ªã ch√≠nh</label>
                </div>
                <div class="flex items-center gap-2">
                    <input 
                        type="color" 
                        id="kpi-sub-color" 
                        class="p-1 h-10 w-14 block bg-white border border-gray-300 cursor-pointer rounded-lg"
                        bind:value={$interfaceSettings.kpiSubColor}
                        on:input={onSettingChange}
                    >
                    <label for="kpi-sub-color" class="text-sm">Gi√° tr·ªã ph·ª•</label>
                </div>
            </div>
        </div>
    </div>
</div>
--- END FILE: ./src/components/drawers/InterfaceDrawer.svelte ---

--- START FILE: ./src/components/health-staff/CategoryRevenueView.svelte ---
<script>
  import { onMount } from 'svelte';
  import { customRevenueTables, modalState, isAdmin, selectedWarehouse } from '../../stores.js';
  import { adminService } from '../../services/admin.service.js';
  import { datasyncService } from '../../services/datasync.service.js';
  import DynamicRevenueTable from './DynamicRevenueTable.svelte';

  export let reportData = [];

  // [FIX CRASH] Logic t√≠nh to√°n visibleTables an to√†n tuy·ªát ƒë·ªëi
  // D√π store c√≥ data r√°c (id=null), h√†m n√†y s·∫Ω c·∫•p ID t·∫°m ƒë·ªÉ render kh√¥ng b·ªã l·ªói
  $: visibleTables = ($customRevenueTables || []).reduce((acc, table, index) => {
      // Ch·ªâ l·∫•y b·∫£ng ch∆∞a b·ªã ·∫©n
      if (table.isVisible !== false) {
          acc.push({
              ...table,
              // N·∫øu id null/undefined, t·∫°o id t·∫°m d·ª±a tr√™n index ƒë·ªÉ Svelte kh√¥ng b√°o duplicate key
              id: table.id ? table.id : `fallback_render_id_${index}` 
          });
      }
      return acc;
  }, []);

  // [LOGIC M·ªöI] Khi Kho thay ƒë·ªïi -> T·∫£i l·∫°i d·ªØ li·ªáu
  $: if ($selectedWarehouse) {
      loadData($selectedWarehouse);
  }

  async function loadData(kho) {
      console.log(`[CategoryView] Loading tables for warehouse: ${kho}`);
      
      try {
          // 1. T·∫£i b·∫£ng H·ªá th·ªëng (Global)
          const systemTables = await adminService.loadSystemRevenueTables();
          
          // 2. T·∫£i b·∫£ng C√° nh√¢n (Warehouse Cloud)
          const personalTables = await datasyncService.loadPersonalRevenueTables(kho);

          // 3. T·∫£i Preferences ·∫©n/hi·ªán (Local)
          const hiddenSystemIds = JSON.parse(localStorage.getItem('hiddenSystemTableIds') || '[]');

          // 4. Merge & Sanitize (L√†m s·∫°ch d·ªØ li·ªáu)
          const finalSystemTables = (systemTables || []).map((t, index) => ({
              ...t,
              // G√°n ID c·ª©ng n·∫øu thi·∫øu ƒë·ªÉ l∆∞u v√†o Store chu·∫©n
              id: t.id || `sys_gen_${index}_${Date.now()}`, 
              isSystem: true,
              isVisible: !hiddenSystemIds.includes(t.id)
          }));

          const safePersonalTables = (personalTables || []).map((t, index) => ({
              ...t,
              // G√°n ID c·ª©ng n·∫øu thi·∫øu
              id: t.id || `per_gen_${index}_${Date.now()}` 
          }));

          // C·∫≠p nh·∫≠t Store (S·∫Ω k√≠ch ho·∫°t l·∫°i reactive statement visibleTables ·ªü tr√™n)
          customRevenueTables.set([...finalSystemTables, ...safePersonalTables]);
      } catch (e) {
          console.error("[CategoryView] L·ªói t·∫£i d·ªØ li·ªáu b·∫£ng:", e);
      }
  }

  // --- C√ÅC H√ÄM X·ª¨ L√ù S·ª∞ KI·ªÜN (GI·ªÆ NGUY√äN) ---
  async function savePersonalTables() {
      if (!$selectedWarehouse) return;
      const personalTables = $customRevenueTables.filter(t => !t.isSystem);
      await datasyncService.savePersonalRevenueTables($selectedWarehouse, personalTables);
  }

  function saveHiddenPreferences() {
      const hiddenIds = $customRevenueTables
          .filter(t => t.isSystem && t.isVisible === false)
          .map(t => t.id);
      localStorage.setItem('hiddenSystemTableIds', JSON.stringify(hiddenIds));
  }

  function toggleTableVisibility(id) {
      // N·∫øu id l√† fallback (do l·ªói d·ªØ li·ªáu), b·ªè qua ƒë·ªÉ tr√°nh l·ªói logic
      if (!id || String(id).startsWith('fallback_render_id_')) return;

      customRevenueTables.update(items => items.map(t => t.id === id ? { ...t, isVisible: !t.isVisible } : t));
      savePersonalTables();
      saveHiddenPreferences();
  }

  function editTable(table) {
      if (String(table.id).startsWith('fallback_render_id_')) {
          alert("B·∫£ng n√†y ƒëang b·ªã l·ªói d·ªØ li·ªáu, kh√¥ng th·ªÉ s·ª≠a.");
          return;
      }
      if (table.isSystem && !$isAdmin) {
          alert("B·∫°n kh√¥ng c√≥ quy·ªÅn ch·ªânh s·ª≠a B·∫£ng h·ªá th·ªëng.");
          return;
      }
      modalState.update(s => ({ ...s, activeModal: 'add-revenue-table-modal', payload: table }));
  }

  async function deleteTable(id) {
      if (!id || String(id).startsWith('fallback_render_id_')) {
          // X√≥a "b·∫£ng ma" kh·ªèi store local ƒë·ªÉ s·∫°ch m·∫Øt
          customRevenueTables.update(items => items.filter(t => t.id)); // L·ªçc b·ªè item ko c√≥ id th·ª±c
          return;
      }

      const targetTable = $customRevenueTables.find(t => t.id === id);
      if (!targetTable) return;

      if (targetTable.isSystem) {
          if ($isAdmin) {
              if (!confirm("C·∫¢NH B√ÅO ADMIN: X√≥a b·∫£ng H·ªÜ TH·ªêNG n√†y vƒ©nh vi·ªÖn?")) return;
              const newTables = $customRevenueTables.filter(t => t.id !== id);
              customRevenueTables.set(newTables);
              await adminService.saveSystemRevenueTables(newTables);
          } else {
              if (!confirm("·∫®n b·∫£ng n√†y kh·ªèi m√†n h√¨nh c·ªßa b·∫°n?")) return;
              customRevenueTables.update(items => items.map(t => t.id === id ? { ...t, isVisible: false } : t));
              saveHiddenPreferences();
          }
      } else {
          if (!confirm("B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a b·∫£ng n√†y? H√†nh ƒë·ªông n√†y s·∫Ω x√≥a tr√™n Cloud c·ªßa kho hi·ªán t·∫°i.")) return;
          customRevenueTables.update(items => items.filter(t => t.id !== id));
          await savePersonalTables();
      }
  }

  function openAddModal() {
      if (!$selectedWarehouse) {
          alert("Vui l√≤ng ch·ªçn Kho tr∆∞·ªõc khi t·∫°o b·∫£ng m·ªõi.");
          return;
      }
      modalState.update(s => ({ ...s, activeModal: 'add-revenue-table-modal', payload: null }));
  }

  $: hasAnyData = reportData.length > 0;
  const colors = ['blue', 'green', 'orange', 'purple', 'teal', 'indigo', 'rose'];
  const getColor = (index) => colors[index % colors.length];
</script>

{#if $customRevenueTables.length > 0}
<div class="mb-6 flex flex-wrap items-center gap-2 bg-white p-3 rounded-xl border border-gray-200 shadow-sm">
    <div class="text-xs font-bold uppercase text-gray-500 mr-2 flex items-center gap-1">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z" /></svg>
        B·∫£ng hi·ªÉn th·ªã:
    </div>
    {#each $customRevenueTables as table, index}
        <button 
            class="px-3 py-1.5 rounded-full text-xs font-medium border transition-all duration-200 flex items-center gap-1.5 select-none
                   {table.isVisible !== false ? 'bg-blue-600 text-white border-blue-600 shadow-md transform -translate-y-0.5' : 'bg-gray-100 text-gray-500 border-gray-200 hover:bg-gray-200'}
                   {table.isSystem ? 'border-dashed' : ''}"
            on:click={() => toggleTableVisibility(table.id || `fallback_render_id_${index}`)}
            title={table.isSystem ? "B·∫£ng h·ªá th·ªëng" : "B·∫£ng c√° nh√¢n"}
        >
            {#if table.isSystem}<span class="text-[10px] mr-0.5 opacity-70">üåê</span>{/if}
            {table.title || '(Kh√¥ng t√™n)'}
        </button>
    {/each}
    <button class="px-3 py-1.5 rounded-full text-xs font-bold border border-dashed border-gray-300 text-gray-500 hover:text-blue-600 hover:border-blue-400 hover:bg-blue-50 transition-colors ml-auto flex items-center gap-1" on:click={openAddModal}>
        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" /></svg>
        T·∫°o m·ªõi
    </button>
</div>
{/if}

{#if !hasAnyData}
    <div class="p-12 text-center bg-gray-50 rounded-xl border border-gray-200 border-dashed">
         <p class="text-gray-500 font-medium">Ch∆∞a c√≥ d·ªØ li·ªáu b√°o c√°o nh√¢n vi√™n.</p>
    </div>
{:else if $customRevenueTables.length === 0}
    <div class="p-12 text-center bg-white rounded-xl border border-blue-100 shadow-sm flex flex-col items-center">
         <div class="w-16 h-16 bg-blue-50 rounded-full flex items-center justify-center mb-4 text-blue-500">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" /></svg>
         </div>
         <h4 class="text-lg font-bold text-gray-800 mb-2">Ch∆∞a c√≥ B·∫£ng b√°o c√°o n√†o</h4>
         <p class="text-gray-500 mb-6 max-w-md">B·∫°n ch∆∞a t·∫°o b·∫£ng theo d√µi n√†o.</p>
         <button class="px-6 py-2.5 bg-blue-600 text-white rounded-lg font-bold hover:bg-blue-700 shadow-md flex items-center gap-2" on:click={openAddModal}>
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" /></svg>
            T·∫°o b·∫£ng ngay
        </button>
    </div>
{:else if visibleTables.length === 0}
    <div class="p-12 text-center bg-gray-50 rounded-xl border border-gray-200">
         <p class="text-gray-500 font-medium">B·∫°n ƒë√£ ·∫©n t·∫•t c·∫£ c√°c b·∫£ng. Vui l√≤ng b·∫≠t l·∫°i tr√™n thanh c√¥ng c·ª•.</p>
    </div>
{:else}
    <div class="grid grid-cols-1 xl:grid-cols-2 gap-6 pb-10">
        {#each visibleTables as table, index (table.id)}
            <div data-capture-group="category-revenue">
                <DynamicRevenueTable 
                    config={table}
                    {reportData}
                    colorTheme={getColor(index)}
                    on:edit={() => editTable(table)}
                    on:delete={() => deleteTable(table.id)}
                />
            </div>
        {/each}
    </div>
{/if}
--- END FILE: ./src/components/health-staff/CategoryRevenueView.svelte ---

--- START FILE: ./src/components/health-staff/CompetitionTab.svelte ---
<script>
  import { onMount } from 'svelte';
  import { 
      ycxData, 
      globalCompetitionConfigs, 
      localCompetitionConfigs,
      pastedThiDuaReportData 
  } from '../../stores.js';
  import { services } from '../../services.js';

  import CompetitionModeSelector from './competition/CompetitionModeSelector.svelte';
  import ProgramView from './competition/ProgramView.svelte';
  import EmployeeView from './competition/EmployeeView.svelte';
  // [NEW] Import view chi ti·∫øt m·ªõi
  import CompetitionDetailView from './competition/CompetitionDetailView.svelte';

  // [Y√äU C·∫¶U] M·∫∑c ƒë·ªãnh v√†o l√† xem theo nh√¢n vi√™n
  let activeView = 'employee'; 
  let programReportData = [];
  
  // [NEW] State cho view chi ti·∫øt
  let isDetailView = false;
  let selectedEmployeeId = null;

  // Logic t√≠nh to√°n cho Program View (T·ª± ƒë·ªông khi YCX ho·∫∑c Config thay ƒë·ªïi)
  $: {
      if ($ycxData.length > 0) {
          const allConfigs = [...$globalCompetitionConfigs, ...$localCompetitionConfigs];
          programReportData = services.calculateCompetitionFocusReport($ycxData, allConfigs);
      } else {
          programReportData = [];
      }
  }

  function handleViewChange(event) {
      activeView = event.detail;
      // Reset v·ªÅ list khi ƒë·ªïi tab con
      isDetailView = false;
      selectedEmployeeId = null;
  }

  // [NEW] X·ª≠ l√Ω khi click v√†o nh√¢n vi√™n
  function handleViewDetail(event) {
      selectedEmployeeId = event.detail.employeeId;
      isDetailView = true;
  }

  // [NEW] X·ª≠ l√Ω quay l·∫°i
  function handleBackToList() {
      isDetailView = false;
      selectedEmployeeId = null;
  }
</script>

<div class="space-y-6">
    <div class="flex flex-wrap items-center justify-between gap-4 bg-white p-4 rounded-xl border border-gray-200 shadow-sm">
        <div class="flex items-center gap-3">
            <div class="p-2 bg-purple-100 rounded-lg text-purple-600">
                <i data-feather="award" class="w-5 h-5"></i>
            </div>
            <div>
                <h3 class="text-lg font-bold text-gray-800 uppercase leading-tight">Thi ƒêua L≈©y K·∫ø</h3>
                <p class="text-xs text-gray-500">Theo d√µi ti·∫øn ƒë·ªô c√°c ch∆∞∆°ng tr√¨nh thi ƒëua</p>
            </div>
        </div>
        
        <CompetitionModeSelector {activeView} on:change={handleViewChange} />
    </div>

    <div class="min-h-[400px]">
        {#if activeView === 'program'}
            <ProgramView reportData={programReportData} />
        {:else}
            {#if isDetailView && selectedEmployeeId}
                <CompetitionDetailView 
                    employeeId={selectedEmployeeId}
                    allReportData={$pastedThiDuaReportData}
                    on:back={handleBackToList}
                />
            {:else}
                <EmployeeView 
                    reportData={$pastedThiDuaReportData} 
                    on:viewChange={(e) => activeView = e.detail}
                    on:viewDetail={handleViewDetail} 
                />
            {/if}
        {/if}
    </div>
</div>
--- END FILE: ./src/components/health-staff/CompetitionTab.svelte ---

--- START FILE: ./src/components/health-staff/DynamicRevenueTable.svelte ---
<script>
  import { createEventDispatcher } from 'svelte';
  import { formatters } from '../../utils/formatters.js';
  import SortableTh from '../common/SortableTh.svelte';
  import { isAdmin } from '../../stores.js';
  
  export let config; 
  export let reportData = []; 
  export let colorTheme = 'blue'; 

  const dispatch = createEventDispatcher();

  let sortKey = 'mainValue'; 
  let sortDirection = 'desc';

  // ƒê·∫£m b·∫£o object tableMetrics lu√¥n t·ªìn t·∫°i v√† c√≥ gi√° tr·ªã m·∫∑c ƒë·ªãnh
  $: tableMetrics = {
      sl: config.tableMetrics?.sl ?? false,
      dt: config.tableMetrics?.dt ?? true, // M·∫∑c ƒë·ªãnh hi·ªán DT n·∫øu k c√≥ config
      dtqd: config.tableMetrics?.dtqd ?? false
  };

  // Helper: M√†u s·∫Øc header ph·ª•
  const getSubHeaderColor = (index) => {
      const colors = [
          'bg-indigo-100 text-indigo-900 border-indigo-200', 
          'bg-emerald-100 text-emerald-900 border-emerald-200', 
          'bg-amber-100 text-amber-900 border-amber-200', 
          'bg-rose-100 text-rose-900 border-rose-200', 
          'bg-cyan-100 text-cyan-900 border-cyan-200'
      ];
      return colors[index % colors.length];
  };

  const normalizeStr = (str) => {
      if (!str) return '';
      return str.toLowerCase()
          .normalize("NFD").replace(/[\u0300-\u036f]/g, "") 
          .replace(/\s+/g, '') 
          .replace(/[^\w\d]/g, '');
  };

  const findItemData = (employee, rawName) => {
      const target = normalizeStr(rawName);
      const scanObject = (obj) => {
          if (!obj) return null;
          const foundKey = Object.keys(obj).find(key => {
              const current = normalizeStr(key);
              return current.includes(target) || target.includes(current);
          });
          return foundKey ? obj[foundKey] : null;
      };
      let result = scanObject(employee.doanhThuTheoNhomHang);
      if (result) return result;
      result = scanObject(employee.doanhThuTheoNganhHang);
      return result;
  };

  $: processedData = reportData.map(employee => {
      const row = {
          maNV: employee.maNV,
          hoTen: employee.hoTen,
          mainValue: 0,
          mainValue_dtqd: 0,
          mainValue_sl: 0,
          columns: {} 
      };

      if (config.subColumns && Array.isArray(config.subColumns)) {
          config.subColumns.forEach(col => {
              const metrics = col.metrics || { sl: false, dt: true, dtqd: false };
              let sl = 0, dt = 0, dtqd = 0;
              let details = [];

              col.items.forEach(rawItemName => {
                  const itemData = findItemData(employee, rawItemName);
                  if (itemData) {
                      const qty = itemData.quantity || 0;
                      const rev = itemData.revenue || 0;
                      const revQd = itemData.revenueQuyDoi || 0;

                      sl += qty;
                      dt += rev;
                      dtqd += revQd;
                      
                      if (qty > 0 || rev > 0) {
                          details.push(`${rawItemName}: ${formatters.formatNumber(qty)} / ${formatters.formatRevenue(rev)}`);
                      }
                  }
              });

              row.columns[col.header] = { sl, dt, dtqd, tooltip: details.join('\n') };
              
              if (metrics.dt) row.mainValue += dt;
              if (metrics.dtqd) row.mainValue_dtqd += dtqd;
              if (metrics.sl) row.mainValue_sl += sl;
              
              // Fallback: N·∫øu kh√¥ng ch·ªçn metric n√†o th√¨ c·ªông SL v√†o mainValue (ƒë·ªÉ sort)
              if (!metrics.dt && !metrics.dtqd && !metrics.sl) row.mainValue += sl;
          });
      }
      // Ch·ªâ hi·ªán nh√¢n vi√™n c√≥ s·ªë li·ªáu (SL > 0 ho·∫∑c DT > 0)
      return (row.mainValue > 0 || row.mainValue_sl > 0 || row.mainValue_dtqd > 0) ? row : null;
  }).filter(Boolean);

  $: totals = processedData.reduce((acc, row) => {
      acc.mainValue += row.mainValue;
      acc.mainValue_dtqd += row.mainValue_dtqd;
      acc.mainValue_sl += row.mainValue_sl;

      Object.keys(row.columns).forEach(key => {
          if (!acc.columns[key]) acc.columns[key] = { sl: 0, dt: 0, dtqd: 0 };
          acc.columns[key].sl += row.columns[key].sl;
          acc.columns[key].dt += row.columns[key].dt;
          acc.columns[key].dtqd += row.columns[key].dtqd;
      });
      return acc;
  }, { mainValue: 0, mainValue_dtqd: 0, mainValue_sl: 0, columns: {} });

  function handleSort(event) {
      const key = event.detail;
      if (sortKey === key) sortDirection = sortDirection === 'desc' ? 'asc' : 'desc';
      else { sortKey = key; sortDirection = 'desc'; }
  }
  
  // H√†m sort th·ªß c√¥ng cho c·ªôt T√™n (v√¨ kh√¥ng d√πng SortableTh)
  function handleManualSort(key) {
      if (sortKey === key) sortDirection = sortDirection === 'desc' ? 'asc' : 'desc';
      else { sortKey = key; sortDirection = 'asc'; } // Default asc cho t√™n
  }

  $: sortedData = [...processedData].sort((a, b) => {
      if (sortKey === 'hoTen') return sortDirection === 'asc' ? a.hoTen.localeCompare(b.hoTen) : b.hoTen.localeCompare(a.hoTen);
      if (sortKey === 'mainValue') return sortDirection === 'asc' ? a.mainValue - b.mainValue : b.mainValue - a.mainValue;
      if (sortKey === 'totalSL') return sortDirection === 'asc' ? a.mainValue_sl - b.mainValue_sl : b.mainValue_sl - a.mainValue_sl;
      if (sortKey === 'totalDTQD') return sortDirection === 'asc' ? a.mainValue_dtqd - b.mainValue_dtqd : b.mainValue_dtqd - a.mainValue_dtqd;

      if (sortKey.includes('|')) {
          const [colHeader, type] = sortKey.split('|');
          const valA = a.columns[colHeader]?.[type] || 0;
          const valB = b.columns[colHeader]?.[type] || 0;
          return sortDirection === 'asc' ? valA - valB : valB - valA;
      }
      return sortDirection === 'asc' ? a.mainValue - b.mainValue : b.mainValue - a.mainValue;
  });

  const themeMap = {
      blue: { header: 'bg-blue-50 border-blue-200', title: 'text-blue-800' },
      green: { header: 'bg-green-50 border-green-200', title: 'text-green-800' },
      orange: { header: 'bg-orange-50 border-orange-200', title: 'text-orange-800' },
      purple: { header: 'bg-purple-50 border-purple-200', title: 'text-purple-800' },
      teal: { header: 'bg-teal-50 border-teal-200', title: 'text-teal-800' },
      indigo: { header: 'bg-indigo-50 border-indigo-200', title: 'text-indigo-800' },
      rose: { header: 'bg-rose-50 border-rose-200', title: 'text-rose-800' },
  };
  $: theme = themeMap[colorTheme] || themeMap.blue;
  
  $: totalColSpan = (tableMetrics.sl ? 1 : 0) + (tableMetrics.dt ? 1 : 0) + (tableMetrics.dtqd ? 1 : 0);
</script>

<div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden h-full flex flex-col transition-all hover:shadow-md relative group/card">
    
    {#if !config.isSystem || $isAdmin}
        <div class="absolute top-3 right-3 opacity-0 group-hover/card:opacity-100 transition-opacity flex gap-1 z-10 bg-white/80 backdrop-blur rounded-lg p-1 shadow-sm border border-gray-100">
            {#if !config.isSystem}<button class="p-1.5 text-gray-400 hover:text-blue-600 rounded hover:bg-blue-50" title="Ch·ªânh s·ª≠a" on:click|stopPropagation={() => dispatch('edit')}><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" /></svg></button>{/if}
            <button class="p-1.5 text-gray-400 hover:text-red-600 rounded hover:bg-red-50" title={config.isSystem ? "X√≥a b·∫£ng h·ªá th·ªëng" : "X√≥a b·∫£ng"} on:click|stopPropagation={() => dispatch('delete')}><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg></button>
        </div>
    {/if}

    <div class="px-5 py-4 border-b {theme.header} flex justify-between items-center">
        <div class="flex items-center gap-3 w-full">
            <h4 class="text-lg font-bold uppercase {theme.title} truncate" title={config.title}>{config.title}</h4>
            </div>
    </div>
    
    {#if sortedData.length === 0}
        <div class="flex-grow flex items-center justify-center p-8 bg-slate-50/30">
             <p class="text-gray-400 italic text-sm">Ch∆∞a c√≥ ph√°t sinh d·ªØ li·ªáu.</p>
        </div>
    {:else}
        <div class="overflow-x-auto flex-grow custom-scrollbar relative">
            <table class="min-w-full text-sm border-collapse border-0">
                <thead class="bg-gray-50 text-xs uppercase text-gray-600 font-bold sticky top-0 z-20 shadow-sm">
                    <tr>
                        <th 
                            class="px-4 py-2 pl-5 min-w-[180px] sticky left-0 z-30 bg-gray-100 border-r border-b border-gray-300 shadow-[2px_0_5px_-2px_rgba(0,0,0,0.1)] cursor-pointer hover:bg-gray-200 transition select-none text-left"
                            rowspan="2"
                            on:click={() => handleManualSort('hoTen')}
                        >
                            <div class="flex items-center gap-1 justify-start">
                                <span class="font-bold uppercase text-xs {sortKey === 'hoTen' ? 'text-blue-800' : 'text-slate-700'}">Nh√¢n vi√™n</span>
                                <span class="flex flex-col items-center justify-center w-4 h-4">
                                    {#if sortKey !== 'hoTen'}
                                        <svg xmlns="http://www.w3.org/2000/svg" class="w-3 h-3 text-gray-400 opacity-50" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M7 16V4m0 0L3 8m4-4l4 4m6 0v12m0 0l4-4m-4 4l-4-4" /></svg>
                                    {:else if sortDirection === 'asc'}
                                        <svg xmlns="http://www.w3.org/2000/svg" class="w-3.5 h-3.5 text-blue-700" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="3"><path stroke-linecap="round" stroke-linejoin="round" d="M5 15l7-7 7 7" /></svg>
                                    {:else}
                                        <svg xmlns="http://www.w3.org/2000/svg" class="w-3.5 h-3.5 text-blue-700" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="3"><path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7" /></svg>
                                    {/if}
                                </span>
                            </div>
                        </th>
                        
                        {#if totalColSpan > 0}
                            <th colspan={totalColSpan} class="px-2 py-2 text-center border-b border-r border-gray-300 text-gray-900 bg-gray-200">
                                T·ªîNG H·ª¢P
                            </th>
                        {/if}

                        {#each config.subColumns as col, index}
                            {@const metrics = col.metrics || { sl: false, dt: true, dtqd: false }}
                            {@const colSpan = (metrics.sl ? 1 : 0) + (metrics.dt ? 1 : 0) + (metrics.dtqd ? 1 : 0)}
                            {#if colSpan > 0}
                                <th colspan={colSpan} class="px-2 py-2 text-center border-b border-r border-gray-200 {getSubHeaderColor(index)}">
                                    {col.header}
                                </th>
                            {/if}
                        {/each}
                    </tr>

                    <tr>
                        {#if tableMetrics.sl}
                            <SortableTh key="totalSL" label="SL" align="right" className="min-w-[60px] text-gray-700 bg-gray-100 border-r border-gray-300 border-b" {sortKey} {sortDirection} on:sort={handleSort} />
                        {/if}
                        {#if tableMetrics.dt}
                             <SortableTh key="mainValue" label="DT" align="right" className="min-w-[80px] text-blue-800 bg-gray-100 border-r border-gray-300 border-b" {sortKey} {sortDirection} on:sort={handleSort} />
                        {/if}
                        {#if tableMetrics.dtqd}
                              <SortableTh key="totalDTQD" label="Qƒê" align="right" className="min-w-[80px] text-purple-800 bg-gray-100 border-r border-gray-300 border-b" {sortKey} {sortDirection} on:sort={handleSort} />
                        {/if}

                        {#each config.subColumns as col}
                            {@const metrics = col.metrics || { sl: false, dt: true, dtqd: false }}
                            {#if metrics.sl}
                                <SortableTh key={`${col.header}|sl`} label="SL" align="right" className="min-w-[60px] text-gray-500 bg-white border-r border-gray-200 border-b" {sortKey} {sortDirection} on:sort={handleSort} />
                            {/if}
                            {#if metrics.dt}
                                <SortableTh key={`${col.header}|dt`} label="DT" align="right" className="min-w-[80px] text-blue-600 bg-white border-r border-gray-200 border-b" {sortKey} {sortDirection} on:sort={handleSort} />
                            {/if}
                            {#if metrics.dtqd}
                                <SortableTh key={`${col.header}|dtqd`} label="Qƒê" align="right" className="min-w-[80px] text-purple-600 bg-white border-r border-gray-200 border-b" {sortKey} {sortDirection} on:sort={handleSort} />
                            {/if}
                        {/each}
                    </tr>
                </thead>

                <tbody class="divide-y divide-gray-100">
                    {#each sortedData as item (item.maNV)}
                        <tr class="hover:bg-blue-50/50 transition-colors group">
                            <td class="px-5 py-2 font-semibold text-gray-700 border-r border-b border-gray-300 bg-white group-hover:bg-blue-50/50 sticky left-0 z-10 whitespace-nowrap shadow-[2px_0_5px_-2px_rgba(0,0,0,0.05)]">
                                <span class="text-blue-700">{formatters.getShortEmployeeName(item.hoTen, item.maNV)}</span>
                            </td>
                            
                            {#if tableMetrics.sl}
                                <td class="px-2 py-2 text-right font-bold text-gray-800 bg-gray-50/50 border-r border-gray-300 border-b">{formatters.formatNumber(item.mainValue_sl)}</td>
                            {/if}
                            {#if tableMetrics.dt}
                                <td class="px-2 py-2 text-right font-bold text-blue-800 bg-gray-50/50 border-r border-gray-300 border-b">{formatters.formatRevenue(item.mainValue)}</td>
                            {/if}
                            {#if tableMetrics.dtqd}
                                <td class="px-2 py-2 text-right font-bold text-purple-800 bg-gray-50/50 border-r border-gray-300 border-b">{formatters.formatRevenue(item.mainValue_dtqd)}</td>
                            {/if}

                            {#each config.subColumns as col}
                                {@const cell = item.columns[col.header]}
                                {@const metrics = col.metrics || { sl: false, dt: true, dtqd: false }}
                                {#if metrics.sl}
                                    <td class="px-2 py-2 text-right border-r border-gray-200 border-b text-gray-600">{formatters.formatNumber(cell?.sl)}</td>
                                {/if}
                                {#if metrics.dt}
                                    <td class="px-2 py-2 text-right border-r border-gray-200 border-b font-medium text-gray-800">{formatters.formatRevenue(cell?.dt)}</td>
                                {/if}
                                {#if metrics.dtqd}
                                    <td class="px-2 py-2 text-right border-r border-gray-200 border-b font-medium text-purple-600">{formatters.formatRevenue(cell?.dtqd)}</td>
                                {/if}
                            {/each}
                        </tr>
                    {/each}
                </tbody>

                <tfoot class="bg-gray-100 font-bold text-gray-800 border-t border-gray-300 sticky bottom-0 z-20">
                    <tr>
                        <td class="px-5 py-2 sticky left-0 bg-gray-200 z-30 border-r border-gray-300 shadow-[2px_0_5px_-2px_rgba(0,0,0,0.1)]">T·ªîNG</td>
                        
                        {#if tableMetrics.sl}
                             <td class="px-2 py-2 text-right border-r border-gray-300 bg-gray-200">{formatters.formatNumber(totals.mainValue_sl)}</td>
                        {/if}
                        {#if tableMetrics.dt}
                             <td class="px-2 py-2 text-right border-r border-gray-300 bg-gray-200 text-blue-800">{formatters.formatRevenue(totals.mainValue)}</td>
                        {/if}
                        {#if tableMetrics.dtqd}
                             <td class="px-2 py-2 text-right border-r border-gray-300 bg-gray-200 text-purple-800">{formatters.formatRevenue(totals.mainValue_dtqd)}</td>
                        {/if}

                        {#each config.subColumns as col}
                            {@const total = totals.columns[col.header]}
                            {@const metrics = col.metrics || { sl: false, dt: true, dtqd: false }}
                            {#if metrics.sl}
                                <td class="px-2 py-2 text-right border-r border-gray-300">{formatters.formatNumber(total?.sl)}</td>
                            {/if}
                            {#if metrics.dt}
                                <td class="px-2 py-2 text-right border-r border-gray-300 text-blue-700">{formatters.formatRevenue(total?.dt)}</td>
                            {/if}
                            {#if metrics.dtqd}
                                <td class="px-2 py-2 text-right border-r border-gray-300 text-purple-700">{formatters.formatRevenue(total?.dtqd)}</td>
                            {/if}
                        {/each}
                    </tr>
                </tfoot>
            </table>
        </div>
    {/if}
</div>

<style>
    .custom-scrollbar::-webkit-scrollbar { width: 6px; height: 6px; }
    .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
    .custom-scrollbar::-webkit-scrollbar-thumb { background: #e5e7eb; border-radius: 3px; }
    .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #d1d5db; }
</style>
--- END FILE: ./src/components/health-staff/DynamicRevenueTable.svelte ---

--- START FILE: ./src/components/health-staff/EfficiencyTable.svelte ---
<script>
  import { formatters } from '../../utils/formatters.js';
  import { getSortedDepartmentList } from '../../utils.js';
  import { efficiencyConfig } from '../../stores.js'; // [M·ªöI] Import ƒë·ªÉ l·∫•y config ƒë·ªông

  export let reportData = [];

  // [FIX] C·∫•u h√¨nh c·ªôt C·ªê ƒê·ªäNH (Hardcoded) kh·ªõp v·ªõi key trong master.report.js
  const FIXED_COLUMNS = [
      { id: 'dtICT', label: 'DT ICT', isRate: false, headerClass: 'bg-blue-100 text-blue-900' },
      { id: 'dtPhuKien', label: 'DT Ph·ª• ki·ªán', isRate: false, headerClass: 'bg-blue-100 text-blue-900' },
      { id: 'pctPhuKien', label: '% Ph·ª• ki·ªán', isRate: true, targetKey: 'phanTramPhuKien', headerClass: 'bg-blue-100 text-blue-900' },
      
      { id: 'dtCE', label: 'DT CE', isRate: false, headerClass: 'bg-green-100 text-green-900' },
      { id: 'dtGiaDung', label: 'DT Gia d·ª•ng', isRate: false, headerClass: 'bg-green-100 text-green-900' },
      { id: 'pctGiaDung', label: '% Gia d·ª•ng', isRate: true, targetKey: 'phanTramGiaDung', headerClass: 'bg-green-100 text-green-900' },
      { id: 'pctMLN', label: '% MLN', isRate: true, targetKey: 'phanTramMLN', headerClass: 'bg-green-100 text-green-900' },
      
      { id: 'pctSim', label: '% Sim', isRate: true, targetKey: 'phanTramSim', headerClass: 'bg-yellow-100 text-yellow-900' },
      { id: 'pctVAS', label: '% VAS', isRate: true, targetKey: 'phanTramVAS', headerClass: 'bg-yellow-100 text-yellow-900' },
      { id: 'pctBaoHiem', label: '% B·∫£o hi·ªÉm', isRate: true, targetKey: 'phanTramBaoHiem', headerClass: 'bg-yellow-100 text-yellow-900' }
  ];

  // [M·ªöI] Merge c·ªôt c·ªë ƒë·ªãnh + c·ªôt ƒë·ªông t·ª´ Admin
  $: ALL_COLUMNS = [
      ...FIXED_COLUMNS,
      ...($efficiencyConfig || []).map(conf => ({
          id: conf.id, // ID ƒë·ªông (VD: eff_12345)
          label: conf.label,
          isRate: true,
          targetKey: conf.id, // Key m·ª•c ti√™u tr√πng v·ªõi ID ch·ªâ s·ªë
          isDynamic: true,
          headerClass: 'bg-purple-100 text-purple-900'
      }))
  ];

  let visibleColumnIds = [];
  // Init visible columns
  $: if (visibleColumnIds.length === 0 && ALL_COLUMNS.length > 0) {
      visibleColumnIds = ALL_COLUMNS.map(c => c.id);
  }

  let sortKey = 'dtICT';
  let sortDirection = 'desc';
  let groupedData = {};
  let departmentOrder = [];

  $: {
    const groups = {}; 
    if (reportData && reportData.length > 0) {
        reportData.forEach(item => {
          const dept = item.boPhan || 'Kh√°c';
          if (!groups[dept]) groups[dept] = []; 
          groups[dept].push(item);
        });
        groupedData = groups; 
        departmentOrder = getSortedDepartmentList(reportData);
    } else { 
        groupedData = {};
        departmentOrder = [];
    }
  }

  function handleSort(key) {
    if (sortKey === key) sortDirection = sortDirection === 'desc' ? 'asc' : 'desc';
    else { sortKey = key; sortDirection = 'desc'; }
  }

  // Logic l·∫•y gi√° tr·ªã an to√†n
  const getValue = (item, colId, isDynamic) => {
      if (isDynamic) {
          // V·ªõi ch·ªâ s·ªë ƒë·ªông, gi√° tr·ªã n·∫±m trong dynamicMetrics
          return item.dynamicMetrics?.[colId]?.value || 0;
      }
      return item[colId] || 0;
  };

  $: sortEmployees = (dept) => {
      const items = groupedData[dept] || [];
      return [...items].sort((a, b) => {
          if (sortKey === 'hoTen') {
             const nameA = a.hoTen || '';
             const nameB = b.hoTen || '';
             return sortDirection === 'asc' ? nameA.localeCompare(nameB) : nameB.localeCompare(nameA);
          }
          
          // Check xem sort key l√† ƒë·ªông hay tƒ©nh ƒë·ªÉ l·∫•y gi√° tr·ªã ƒë√∫ng
          const isDynamicSort = $efficiencyConfig.some(c => c.id === sortKey);
          let valA = getValue(a, sortKey, isDynamicSort);
          let valB = getValue(b, sortKey, isDynamicSort);
          
          return sortDirection === 'asc' ? valA - valB : valB - valA;
      });
  };

  function toggleColumn(columnId) {
      if (visibleColumnIds.includes(columnId)) visibleColumnIds = visibleColumnIds.filter(id => id !== columnId);
      else visibleColumnIds = [...visibleColumnIds, columnId];
  }

  // [FIX] Logic T√¥ m√†u √¥
  function getCellClass(item, colDef) {
    const value = getValue(item, colDef.id, colDef.isDynamic);
    
    if (colDef.isRate) {
        // L·∫•y target: N·∫øu l√† c·ªôt ƒë·ªông, l·∫•y t·ª´ settings, n·∫øu tƒ©nh l·∫•y t·ª´ mucTieu
        let target = 0;
        if (colDef.isDynamic) {
             // Target ƒë·ªông ƒë∆∞·ª£c l∆∞u trong mucTieu v·ªõi key ch√≠nh l√† ID ch·ªâ s·ªë
             target = (item.mucTieu?.[colDef.targetKey] || 0) / 100;
             // Fallback: N·∫øu user ch∆∞a set m·ª•c ti√™u ri√™ng, l·∫•y default t·ª´ config
             if (target === 0) {
                 const cfg = $efficiencyConfig.find(c => c.id === colDef.id);
                 target = (cfg?.target || 0) / 100;
             }
        } else {
             target = (item.mucTieu?.[colDef.targetKey] || 0) / 100;
        }

        if (target > 0 && value < target) return 'text-red-600 font-bold bg-red-50'; // Kh√¥ng ƒë·∫°t
        return 'text-red-800 font-bold'; // M·∫∑c ƒë·ªãnh % l√† ƒë·ªè ƒë·∫≠m
    } 
    
    if (colDef.id.startsWith('dt')) return 'text-blue-700 font-medium';
    return 'text-gray-900 font-medium';
  }

  function getHeaderClass(deptName) {
    if (deptName.includes('T∆∞ V·∫•n')) return 'bg-blue-100 text-blue-800 border-blue-200';
    if (deptName.includes('Kho')) return 'bg-green-100 text-green-800 border-green-200';
    return 'bg-gray-100 text-gray-800 border-gray-200';
  }
</script>

<div class="space-y-8 mt-4 animate-fade-in">
  <div class="bg-white p-3 rounded-lg shadow-sm border border-gray-200 flex flex-wrap gap-2 items-center">
     <span class="text-xs font-bold text-gray-500 uppercase mr-2">Hi·ªÉn th·ªã c·ªôt:</span>
     {#each ALL_COLUMNS as col}
        <button 
          class="px-3 py-1 rounded-full text-xs font-medium border transition-colors select-none
                 {visibleColumnIds.includes(col.id) ? 'bg-blue-600 text-white border-blue-600' : 'bg-gray-50 text-gray-500 border-gray-200 hover:bg-gray-100'}"
          on:click={() => toggleColumn(col.id)}
        >
            {col.label}
        </button>
     {/each}
  </div>

  {#each departmentOrder as deptName}
    {#if groupedData[deptName]}
      <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
        <div class="p-4 border-b {getHeaderClass(deptName)}">
          <h4 class="text-lg font-bold uppercase">{deptName}</h4>
        </div>

        <div class="overflow-x-auto">
          <table class="min-w-full text-sm text-left border-collapse">
            <thead class="text-xs text-gray-700 uppercase font-bold sticky top-0 z-20 shadow-sm">
               <tr>
                <th class="px-4 py-3 bg-gray-200 cursor-pointer hover:bg-gray-300 transition sticky left-0 z-30 min-w-[200px]" on:click={() => handleSort('hoTen')}>
                   <div class="flex items-center gap-1">
                    <span>Nh√¢n vi√™n</span>
                    {#if sortKey === 'hoTen'}<span>{sortDirection === 'asc' ? '‚ñ≤' : '‚ñº'}</span>{/if}
                  </div>
                </th>

                {#each ALL_COLUMNS as col}
                  {#if visibleColumnIds.includes(col.id)}
                     <th class="px-4 py-3 cursor-pointer hover:opacity-80 transition whitespace-nowrap text-right {col.headerClass}" on:click={() => handleSort(col.id)}>
                       <div class="flex items-center justify-end gap-1">
                         <span>{col.label}</span>
                         {#if sortKey === col.id}<span>{sortDirection === 'asc' ? '‚ñ≤' : '‚ñº'}</span>{/if}
                       </div>
                     </th>
                  {/if}
                {/each}
              </tr>
            </thead>
            <tbody class="divide-y divide-gray-200">
              {#each sortEmployees(deptName) as item (item.maNV)}
                <tr class="hover:bg-blue-50 transition-colors duration-150">
                  <td class="px-4 py-2 font-semibold text-blue-700 sticky left-0 bg-white hover:bg-blue-50 z-10 border-r border-gray-200 whitespace-nowrap">
                    {formatters.getShortEmployeeName(item.hoTen, item.maNV)}
                  </td>
                  {#each ALL_COLUMNS as col}
                    {#if visibleColumnIds.includes(col.id)}
                       {@const val = getValue(item, col.id, col.isDynamic)}
                       <td class="px-4 py-2 text-right border-l border-gray-100 {getCellClass(item, col)}">
                          {#if col.isRate}
                            {formatters.formatPercentage(val)}
                         {:else}
                            {formatters.formatRevenue(val)}
                         {/if}
                      </td>
                     {/if}
                  {/each}
                </tr>
              {/each}
            </tbody>
          </table>
        </div>
      </div>
    {/if}
  {/each}
</div>

<style>
    .animate-fade-in { animation: fadeIn 0.4s ease-out; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
</style>
--- END FILE: ./src/components/health-staff/EfficiencyTable.svelte ---

--- START FILE: ./src/components/health-staff/EmployeeDetailModal.svelte ---
<script>
    import { createEventDispatcher } from 'svelte';
    
    // Props nh·∫≠n v√†o t·ª´ cha
    export let isOpen = false;
    export let employeeCode = '';
    export let employeeName = '';
    export let employeeDept = '';
    export let rawData = []; // D·ªØ li·ªáu g·ªëc (reportData) ƒë·ªÉ l·ªçc

    const dispatch = createEventDispatcher();

    // Bi·∫øn n·ªôi b·ªô
    let history = [];
    let summary = {
        totalErrors: 0,
        totalDeducted: 0,
        totalBonus: 0,
        finalScore: 100 // Gi·∫£ s·ª≠ ƒëi·ªÉm g·ªëc l√† 100, ho·∫∑c t√≠nh theo logic d·ª± √°n
    };

    // Reactive: Khi employeeCode ho·∫∑c rawData thay ƒë·ªïi, t√≠nh to√°n l·∫°i
    $: if (isOpen && employeeCode && rawData.length > 0) {
        analyzeEmployeeData();
    }

    function analyzeEmployeeData() {
        // 1. L·ªçc d·ªØ li·ªáu c·ªßa nh√¢n vi√™n n√†y
        const records = rawData.filter(item => item.maNV === employeeCode);

        // 2. S·∫Øp x·∫øp theo ng√†y m·ªõi nh·∫•t -> c≈© nh·∫•t
        history = records.sort((a, b) => {
            const dateA = new Date(a.ngayViPham.split('/').reverse().join('-'));
            const dateB = new Date(b.ngayViPham.split('/').reverse().join('-'));
            return dateB - dateA;
        });

        // 3. T√≠nh to√°n t·ªïng h·ª£p
        let errors = 0;
        let deducted = 0;
        let bonus = 0;

        history.forEach(item => {
            const point = parseFloat(item.diemTru) || 0;
            if (point < 0) {
                // ƒêi·ªÉm √¢m l√† ƒëi·ªÉm tr·ª´ (tu·ª≥ quy ∆∞·ªõc data g·ªëc c·ªßa b·∫°n, ·ªü ƒë√¢y gi·∫£ s·ª≠ < 0 l√† tr·ª´)
                // Ho·∫∑c n·∫øu data g·ªëc l∆∞u s·ªë d∆∞∆°ng cho c·ªôt ƒëi·ªÉm tr·ª´:
                // C·∫ßn check logic g·ªëc. Th∆∞·ªùng l√† c·ªôt 'diemTru' l∆∞u s·ªë ƒëi·ªÉm b·ªã tr·ª´.
                // ·ªû ƒë√¢y t√¥i gi·∫£ ƒë·ªãnh theo logic th√¥ng th∆∞·ªùng:
                
                // N·∫øu item.loai === 'ƒêi·ªÉm c·ªông' ho·∫∑c diemTru > 0 trong ng·ªØ c·∫£nh c·ªông...
                // D·ª±a v√†o file g·ªëc: th∆∞·ªùng c√≥ ph√¢n lo·∫°i ho·∫∑c check d·∫•u
            }
            
            // Logic b√°m s√°t d·ª± √°n g·ªëc: 
            // D·ª± √°n g·ªëc th∆∞·ªùng c·ªông d·ªìn ƒëi·ªÉm. Gi·∫£ s·ª≠ diemTru l√† s·ªë ƒëi·ªÉm t√°c ƒë·ªông.
            if (item.loaiViPham === 'ƒêi·ªÉm c·ªông' || (item.ghiChu && item.ghiChu.includes('ƒêi·ªÉm c·ªông'))) {
                 bonus += Math.abs(point);
            } else {
                 errors++;
                 deducted += Math.abs(point);
            }
        });

        summary = {
            totalErrors: errors,
            totalDeducted: deducted,
            totalBonus: bonus,
            finalScore: 100 - deducted + bonus // C√¥ng th·ª©c v√≠ d·ª•
        };
    }

    function close() {
        dispatch('close');
    }
</script>

{#if isOpen}
    <div class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4" on:click={close}>
        <div class="bg-white rounded-lg shadow-xl w-full max-w-4xl max-h-[90vh] flex flex-col overflow-hidden" on:click|stopPropagation>
            
            <div class="bg-blue-600 text-white p-4 flex justify-between items-center">
                <div>
                    <h3 class="text-xl font-bold uppercase">Chi ti·∫øt thi ƒëua: {employeeName}</h3>
                    <p class="text-sm opacity-90">{employeeCode} - {employeeDept}</p>
                </div>
                <button on:click={close} class="text-white hover:text-gray-200">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>

            <div class="p-4 bg-gray-50 border-b flex flex-wrap gap-4 justify-around text-center">
                <div class="bg-white p-3 rounded shadow-sm border border-gray-200 min-w-[150px]">
                    <span class="block text-gray-500 text-xs uppercase">S·ªë l·ªói vi ph·∫°m</span>
                    <span class="block text-2xl font-bold text-red-500">{summary.totalErrors}</span>
                </div>
                <div class="bg-white p-3 rounded shadow-sm border border-gray-200 min-w-[150px]">
                    <span class="block text-gray-500 text-xs uppercase">T·ªïng ƒëi·ªÉm tr·ª´</span>
                    <span class="block text-2xl font-bold text-red-600">-{summary.totalDeducted}</span>
                </div>
                <div class="bg-white p-3 rounded shadow-sm border border-gray-200 min-w-[150px]">
                    <span class="block text-gray-500 text-xs uppercase">T·ªïng ƒëi·ªÉm c·ªông</span>
                    <span class="block text-2xl font-bold text-green-600">+{summary.totalBonus}</span>
                </div>
                 </div>

            <div class="flex-1 overflow-y-auto p-4">
                {#if history.length === 0}
                    <div class="text-center text-gray-500 py-10">Nh√¢n vi√™n n√†y ch∆∞a c√≥ ghi nh·∫≠n thi ƒëua n√†o.</div>
                {:else}
                    <table class="min-w-full text-sm border-collapse border border-gray-200">
                        <thead class="bg-gray-100 sticky top-0 shadow-sm">
                            <tr>
                                <th class="border p-2 text-left">Ng√†y</th>
                                <th class="border p-2 text-left">Lo·∫°i/Vi ph·∫°m</th>
                                <th class="border p-2 text-left">N·ªôi dung chi ti·∫øt</th>
                                <th class="border p-2 text-center text-nowrap">ƒêi·ªÉm</th>
                            </tr>
                        </thead>
                        <tbody>
                            {#each history as item}
                                <tr class="hover:bg-gray-50">
                                    <td class="border p-2 whitespace-nowrap">{item.ngayViPham}</td>
                                    <td class="border p-2 font-medium">
                                        {#if item.loaiViPham === 'ƒêi·ªÉm c·ªông'}
                                            <span class="text-green-600">ƒêi·ªÉm c·ªông</span>
                                        {:else}
                                            <span class="text-red-600">{item.loaiViPham || 'Vi ph·∫°m'}</span>
                                        {/if}
                                    </td>
                                    <td class="border p-2">{item.noiDung || item.tenLoi}</td>
                                    <td class="border p-2 text-center font-bold" 
                                        class:text-red-600={parseFloat(item.diemTru) < 0 || (item.loaiViPham !== 'ƒêi·ªÉm c·ªông')}
                                        class:text-green-600={item.loaiViPham === 'ƒêi·ªÉm c·ªông'}
                                    >
                                        {item.diemTru}
                                    </td>
                                </tr>
                            {/each}
                        </tbody>
                    </table>
                {/if}
            </div>

            <div class="p-4 border-t bg-gray-50 text-right">
                <button on:click={close} class="px-4 py-2 bg-gray-200 hover:bg-gray-300 rounded text-gray-700 font-medium">
                    ƒê√≥ng
                </button>
            </div>
        </div>
    </div>
{/if}
--- END FILE: ./src/components/health-staff/EmployeeDetailModal.svelte ---

--- START FILE: ./src/components/health-staff/IncomeTable.svelte ---
<script>
  import { formatters } from '../../utils/formatters.js';
  
  export let reportData = [];

  let sortKey = 'tongThuNhap';
  let sortDirection = 'desc';

  // C·∫•u h√¨nh c·ªôt
  const columns = [
      { key: 'hoTen', label: 'Nh√¢n vi√™n', align: 'left' },
      { key: 'gioCong', label: 'Gi·ªù c√¥ng', align: 'right' },
      { key: 'tongThuNhap', label: 'T·ªïng Thu Nh·∫≠p', align: 'right' },
      { key: 'thuNhapDuKien', label: 'Thu nh·∫≠p DK', align: 'right' },
      { key: 'thuNhapThangTruoc', label: 'Th√°ng tr∆∞·ªõc', align: 'right' },
      { key: 'chenhLechThuNhap', label: '+/- Th√°ng tr∆∞·ªõc', align: 'right' }
  ];

  function handleSort(key) {
      if (sortKey === key) {
          sortDirection = sortDirection === 'desc' ? 'asc' : 'desc';
      } else {
          sortKey = key;
          sortDirection = 'desc';
      }
  }

  // Logic s·∫Øp x·∫øp
  $: sortedData = [...reportData].sort((a, b) => {
      let valA = a[sortKey];
      let valB = b[sortKey];

      if (sortKey === 'hoTen') {
          return sortDirection === 'asc' ? String(valA).localeCompare(String(valB)) : String(valB).localeCompare(String(valA));
      }
      // X·ª≠ l√Ω s·ªë
      return sortDirection === 'asc' ? (Number(valA)||0) - (Number(valB)||0) : (Number(valB)||0) - (Number(valA)||0);
  });

  // T√≠nh t·ªïng
  $: totals = reportData.reduce((acc, item) => {
      acc.gioCong += item.gioCong || 0;
      acc.tongThuNhap += item.tongThuNhap || 0;
      acc.thuNhapDuKien += item.thuNhapDuKien || 0;
      acc.thuNhapThangTruoc += item.thuNhapThangTruoc || 0;
      acc.chenhLechThuNhap += item.chenhLechThuNhap || 0;
      return acc;
  }, { gioCong: 0, tongThuNhap: 0, thuNhapDuKien: 0, thuNhapThangTruoc: 0, chenhLechThuNhap: 0 });

  // T√≠nh trung b√¨nh Thu nh·∫≠p d·ª± ki·∫øn ƒë·ªÉ so s√°nh
  $: avgIncome = reportData.length > 0 ? totals.thuNhapDuKien / reportData.length : 0;

  // H√†m style cho √¥ d·ªØ li·ªáu
  function getCellClass(item, colKey) {
      if (colKey === 'tongThuNhap') return 'font-bold text-blue-700';
      
      if (colKey === 'thuNhapDuKien') {
          // D∆∞·ªõi trung b√¨nh th√¨ m√†u ƒë·ªè, tr√™n th√¨ xanh
          return item.thuNhapDuKien < avgIncome 
              ? 'font-bold text-red-600 bg-red-50' 
              : 'font-bold text-green-700 bg-green-50';
      }

      if (colKey === 'chenhLechThuNhap') {
          return item.chenhLechThuNhap >= 0 
              ? 'font-bold text-green-600' 
              : 'font-bold text-red-600';
      }

      return 'text-gray-700';
  }
</script>

<div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden mt-4 animate-fade-in">
    <div class="px-6 py-4 border-b border-gray-200 flex justify-between items-center bg-orange-50">
        <div class="flex items-center gap-2">
            <div class="p-2 bg-orange-100 rounded-lg text-orange-600">
                <i data-feather="briefcase" class="w-5 h-5"></i>
            </div>
            <div>
                <h3 class="font-bold text-gray-800 text-lg uppercase">B·∫£ng L∆∞∆°ng & Thu Nh·∫≠p</h3>
                <p class="text-xs text-gray-500">
                    Thu nh·∫≠p DK TB: <span class="font-bold text-orange-600">{formatters.formatRevenue(avgIncome)}</span>
                </p>
            </div>
        </div>
        <span class="text-xs font-bold bg-orange-100 text-orange-700 px-3 py-1 rounded-full shadow-sm">ƒê∆°n v·ªã: VNƒê</span>
    </div>

    <div class="overflow-x-auto">
        <table class="min-w-full text-sm text-left border-collapse">
            <thead class="bg-gray-100 text-xs uppercase text-gray-500 font-bold sticky top-0 z-10 shadow-sm">
                <tr>
                    {#each columns as col}
                        <th 
                            class="px-4 py-3 cursor-pointer hover:bg-gray-200 transition select-none whitespace-nowrap {col.align === 'right' ? 'text-right' : 'text-left'}"
                            on:click={() => handleSort(col.key)}
                        >
                            <div class="flex items-center gap-1 {col.align === 'right' ? 'justify-end' : ''}">
                                {col.label}
                                {#if sortKey === col.key}
                                    <span class="ml-1 text-orange-600">{sortDirection === 'asc' ? '‚ñ≤' : '‚ñº'}</span>
                                {/if}
                            </div>
                        </th>
                    {/each}
                </tr>
            </thead>
            <tbody class="divide-y divide-gray-100">
                {#if sortedData.length === 0}
                    <tr><td colspan={columns.length} class="p-12 text-center text-gray-400 italic bg-gray-50">Ch∆∞a c√≥ d·ªØ li·ªáu. Vui l√≤ng t·∫£i file Th∆∞·ªüng/Gi·ªù c√¥ng.</td></tr>
                {:else}
                    {#each sortedData as item, index (item.maNV)}
                        <tr class="hover:bg-orange-50 transition-colors duration-150 group {index % 2 === 0 ? 'bg-white' : 'bg-slate-50/50'}">
                            <td class="px-4 py-3 font-semibold text-gray-700 whitespace-nowrap border-r border-gray-100 group-hover:text-orange-800">
                                {formatters.getShortEmployeeName(item.hoTen, item.maNV)}
                            </td>
                            <td class="px-4 py-3 text-right border-r border-gray-100 font-medium">
                                {formatters.formatNumberOrDash(item.gioCong)}
                            </td>
                            <td class="px-4 py-3 text-right {getCellClass(item, 'tongThuNhap')}">
                                {formatters.formatRevenue(item.tongThuNhap)}
                            </td>
                            <td class="px-4 py-3 text-right {getCellClass(item, 'thuNhapDuKien')}">
                                {formatters.formatRevenue(item.thuNhapDuKien)}
                            </td>
                            <td class="px-4 py-3 text-right text-gray-600 font-medium">
                                {formatters.formatRevenue(item.thuNhapThangTruoc)}
                            </td>
                            <td class="px-4 py-3 text-right border-l border-gray-100 {getCellClass(item, 'chenhLechThuNhap')}">
                                {formatters.formatRevenue(item.chenhLechThuNhap)}
                            </td>
                        </tr>
                    {/each}
                {/if}
            </tbody>
            <tfoot class="bg-gray-100 font-bold text-gray-900 border-t-2 border-gray-300 text-xs uppercase">
                <tr>
                    <td class="px-4 py-3">T·ªîNG C·ªòNG</td>
                    <td class="px-4 py-3 text-right">{formatters.formatNumberOrDash(totals.gioCong)}</td>
                    <td class="px-4 py-3 text-right text-blue-700">{formatters.formatRevenue(totals.tongThuNhap)}</td>
                    <td class="px-4 py-3 text-right text-green-700">{formatters.formatRevenue(totals.thuNhapDuKien)}</td>
                    <td class="px-4 py-3 text-right">{formatters.formatRevenue(totals.thuNhapThangTruoc)}</td>
                    <td class="px-4 py-3 text-right">{formatters.formatRevenue(totals.chenhLechThuNhap)}</td>
                </tr>
            </tfoot>
        </table>
    </div>
</div>

<style>
    .animate-fade-in { animation: fadeIn 0.4s ease-out; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
</style>
--- END FILE: ./src/components/health-staff/IncomeTable.svelte ---

--- START FILE: ./src/components/health-staff/RevenueTable.svelte ---
<script>
  import { createEventDispatcher } from 'svelte';
  import { formatters } from '../../utils/formatters.js';
  
  export let reportData = [];

  const dispatch = createEventDispatcher();
  let sortKey = 'doanhThu';
  let sortDirection = 'desc';

  // [C·∫§U H√åNH] Gi·ªØ nguy√™n
  const columns = [
      { key: 'hoTen', label: 'Nh√¢n vi√™n', align: 'left', headerClass: 'bg-gray-100 text-gray-700' },
      { key: 'doanhThu', label: 'DT Th·ª±c', align: 'right', headerClass: 'bg-blue-100 text-blue-800 border-l border-blue-200' },
      { key: 'doanhThuQuyDoi', label: 'DT Quy ƒê·ªïi', align: 'right', headerClass: 'bg-blue-100 text-blue-800' },
      { key: 'hieuQuaQuyDoi', label: '% Qƒê', align: 'right', headerClass: 'bg-blue-100 text-blue-800' },
      { key: 'doanhThuTraGop', label: 'DT Tr·∫£ ch·∫≠m', align: 'right', headerClass: 'bg-green-100 text-green-800 border-l border-green-200' },
      { key: 'tyLeTraCham', label: '% Tr·∫£ ch·∫≠m', align: 'right', headerClass: 'bg-green-100 text-green-800' },
      { key: 'doanhThuChuaXuat', label: 'DT Ch∆∞a Xu·∫•t', align: 'right', headerClass: 'bg-yellow-50 text-yellow-800 border-l border-yellow-200' }
  ];

  function handleSort(key) {
      if (sortKey === key) sortDirection = sortDirection === 'desc' ? 'asc' : 'desc';
      else { sortKey = key; sortDirection = 'desc'; }
  }

  $: sortedData = [...reportData].sort((a, b) => {
      let valA = a[sortKey];
      let valB = b[sortKey];
      if (sortKey === 'hoTen') return sortDirection === 'asc' ? String(valA).localeCompare(String(valB)) : String(valB).localeCompare(String(valA));
      return sortDirection === 'asc' ? (Number(valA)||0) - (Number(valB)||0) : (Number(valB)||0) - (Number(valA)||0);
  });

  $: totals = reportData.reduce((acc, item) => {
      acc.doanhThu += item.doanhThu || 0;
      acc.doanhThuQuyDoi += item.doanhThuQuyDoi || 0;
      acc.doanhThuTraGop += item.doanhThuTraGop || 0;
      acc.doanhThuChuaXuat += item.doanhThuChuaXuat || 0;
      return acc;
  }, { doanhThu: 0, doanhThuQuyDoi: 0, doanhThuTraGop: 0, doanhThuChuaXuat: 0 });

  $: totalPctQD = totals.doanhThu > 0 ? (totals.doanhThuQuyDoi / totals.doanhThu) - 1 : 0;
  $: totalPctTC = totals.doanhThu > 0 ? totals.doanhThuTraGop / totals.doanhThu : 0;

  // [FIX] Logic t√¥ m√†u
  function getCellClass(item, colKey) {
      if (['doanhThu', 'doanhThuQuyDoi', 'doanhThuTraGop', 'doanhThuChuaXuat'].includes(colKey)) {
          return 'font-bold text-gray-800';
      }

      if (!item.mucTieu) return 'text-gray-600'; // N·∫øu kh√¥ng c√≥ m·ª•c ti√™u th√¨ kh√¥ng t√¥ m√†u

      if (colKey === 'hieuQuaQuyDoi') {
          // Target %Quy ƒê·ªïi (VD: 80%)
          const target = (item.mucTieu.phanTramQD || 0) / 100;
          if (target === 0) return 'text-blue-800 font-bold';
          return item.hieuQuaQuyDoi >= target 
              ? 'text-green-600 font-extrabold bg-green-50' // ƒê·∫°t
              : 'text-red-600 font-bold bg-red-50';        // Kh√¥ng ƒë·∫°t
      }
      
      if (colKey === 'tyLeTraCham') {
          // Target % Tr·∫£ ch·∫≠m
          const target = (item.mucTieu.phanTramTC || 0) / 100;
          if (target === 0) return 'text-green-800 font-bold';
          return item.tyLeTraCham >= target 
              ? 'text-green-600 font-extrabold bg-green-50' 
              : 'text-red-600 font-bold bg-red-50';
      }
      return 'text-gray-600';
  }

  function handleRowClick(employeeId) { dispatch('viewDetail', { employeeId }); }
</script>

<div class="bg-white rounded-xl shadow-md border border-gray-200 overflow-hidden mt-6 animate-fade-in">
    <div class="px-6 py-4 border-b border-gray-200 flex justify-between items-center bg-gray-50">
        <div class="flex items-center gap-2">
            <div class="p-2 bg-blue-100 rounded-lg text-blue-600"><i data-feather="dollar-sign" class="w-5 h-5"></i></div>
            <div>
                <h3 class="font-bold text-gray-800 text-lg uppercase">Chi ti·∫øt Doanh Thu L≈©y K·∫ø</h3>
                <p class="text-xs text-gray-500">D·ªØ li·ªáu ƒë∆∞·ª£c c·∫≠p nh·∫≠t t·ª´ file YCX m·ªõi nh·∫•t</p>
            </div>
        </div>
        <span class="text-xs font-bold bg-blue-100 text-blue-700 px-3 py-1 rounded-full shadow-sm">ƒê∆°n v·ªã: VNƒê</span>
    </div>

    <div class="overflow-x-auto">
        <table class="min-w-full text-sm text-left border-collapse">
            <thead class="uppercase text-xs font-bold sticky top-0 z-10 shadow-sm">
                <tr>
                    {#each columns as col}
                        <th class="px-4 py-3 cursor-pointer transition select-none whitespace-nowrap {col.headerClass} {col.align === 'right' ? 'text-right' : 'text-left'}" on:click={() => handleSort(col.key)}>
                            <div class="flex items-center gap-1 {col.align === 'right' ? 'justify-end' : ''}">
                                {col.label}
                                {#if sortKey === col.key}<span class="ml-1 text-blue-600">{sortDirection === 'asc' ? '‚ñ≤' : '‚ñº'}</span>{/if}
                            </div>
                        </th>
                    {/each}
                </tr>
            </thead>
            <tbody class="divide-y divide-gray-100">
                {#if sortedData.length === 0}
                    <tr><td colspan={columns.length} class="p-12 text-center text-gray-400 italic bg-gray-50">Ch∆∞a c√≥ d·ªØ li·ªáu hi·ªÉn th·ªã.</td></tr>
                {:else}
                    {#each sortedData as item, index (item.maNV)}
                        <tr class="hover:bg-blue-50 transition-colors duration-150 group cursor-pointer {index % 2 === 0 ? 'bg-white' : 'bg-slate-50/50'}" on:click={() => handleRowClick(item.maNV)}>
                            <td class="px-4 py-3 font-semibold text-blue-700 whitespace-nowrap border-r border-gray-100 group-hover:text-blue-800 group-hover:underline">
                                {formatters.getShortEmployeeName(item.hoTen, item.maNV)}
                            </td>
                            <td class="px-4 py-3 text-right border-r border-gray-100 {getCellClass(item, 'doanhThu')}">{formatters.formatRevenue(item.doanhThu)}</td>
                            <td class="px-4 py-3 text-right {getCellClass(item, 'doanhThuQuyDoi')}">{formatters.formatRevenue(item.doanhThuQuyDoi)}</td>
                            <td class="px-4 py-3 text-right {getCellClass(item, 'hieuQuaQuyDoi')}">{formatters.formatPercentage(item.hieuQuaQuyDoi)}</td>
                            <td class="px-4 py-3 text-right border-l border-gray-100 {getCellClass(item, 'doanhThuTraGop')}">{formatters.formatRevenue(item.doanhThuTraGop)}</td>
                            <td class="px-4 py-3 text-right {getCellClass(item, 'tyLeTraCham')}">{formatters.formatPercentage(item.tyLeTraCham)}</td>
                            <td class="px-4 py-3 text-right border-l border-gray-100 text-gray-500 font-medium">{formatters.formatRevenue(item.doanhThuChuaXuat)}</td>
                        </tr>
                    {/each}
                {/if}
            </tbody>
            <tfoot class="bg-gray-100 font-bold text-gray-900 border-t-2 border-gray-300 text-xs uppercase">
                <tr>
                    <td class="px-4 py-3">T·ªîNG C·ªòNG</td>
                    <td class="px-4 py-3 text-right text-base">{formatters.formatRevenue(totals.doanhThu)}</td>
                    <td class="px-4 py-3 text-right text-base text-blue-700">{formatters.formatRevenue(totals.doanhThuQuyDoi)}</td>
                    <td class="px-4 py-3 text-right text-base text-blue-700">{formatters.formatPercentage(totalPctQD)}</td>
                    <td class="px-4 py-3 text-right text-base">{formatters.formatRevenue(totals.doanhThuTraGop)}</td>
                    <td class="px-4 py-3 text-right text-base">{formatters.formatPercentage(totalPctTC)}</td>
                    <td class="px-4 py-3 text-right text-base text-gray-600">{formatters.formatRevenue(totals.doanhThuChuaXuat)}</td>
                </tr>
            </tfoot>
        </table>
    </div>
</div>
<style>.animate-fade-in { animation: fadeIn 0.4s ease-out; } @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }</style>
--- END FILE: ./src/components/health-staff/RevenueTable.svelte ---

--- START FILE: ./src/components/luyke/LuykeCategoryTable.svelte ---
<script>
  import { onMount, afterUpdate, tick } from 'svelte';
  import { formatters } from '../../utils/formatters.js';
  import { cleanCategoryName, getRandomBrightColor } from '../../utils.js';

  export let items = []; // D·ªØ li·ªáu Ng√†nh h√†ng (bao g·ªìm Macro Categories)
  export let unexportedItems = []; 
  export let rawSource = []; 
  export let numDays = 1;

  // --- STATE ---
  let showUnexported = false;
  let viewMode = 'grid'; 
  let searchText = '';
  let sortMode = 'revenue_desc';
  
  let isSettingsOpen = false;
  let filterSearch = '';
  let hiddenCategories = new Set(); 

  let chartInstancePie = null;
  let chartInstanceBar = null;

  // --- PERSISTENT FILTER ---
  const STORAGE_KEY = 'luyke_category_hidden_items';

  onMount(() => {
      const saved = localStorage.getItem(STORAGE_KEY);
      if (saved) {
          try {
              hiddenCategories = new Set(JSON.parse(saved));
          } catch (e) { console.error(e); }
      }
  });

  function saveHiddenState() {
      localStorage.setItem(STORAGE_KEY, JSON.stringify([...hiddenCategories]));
  }

  // --- REACTIVE TITLE ---
  $: titleText = showUnexported 
      ? "CHI TI·∫æT CH∆ØA XU·∫§T (Qƒê)" 
      : (viewMode === 'grid' ? "CHI TI·∫æT NG√ÄNH H√ÄNG" : "T·ª∂ TR·ªåNG NG√ÄNH H√ÄNG");
  
  $: titleIcon = showUnexported ? "alert-circle" : (viewMode === 'grid' ? "grid" : "pie-chart");
  $: titleClass = showUnexported ? "text-orange-700" : "text-gray-700";
  $: iconClass = showUnexported ? "text-orange-600" : "text-blue-600";

  function getCategoryTheme(name) {
      const n = name.toLowerCase();
      if (n.includes('ƒëi·ªán t·ª≠') || n.includes('tivi')) return { icon: 'tv', theme: 'theme-teal' };
      if (n.includes('m√°y gi·∫∑t') || n.includes('s·∫•y')) return { icon: 'disc', theme: 'theme-blue' };
      if (n.includes('m√°y l·∫°nh') || n.includes('n∆∞·ªõc n√≥ng') || n.includes('ƒëi·ªÅu h√≤a')) return { icon: 'wind', theme: 'theme-blue' };
      if (n.includes('t·ªß l·∫°nh') || n.includes('t·ªß ƒë√¥ng') || n.includes('t·ªß m√°t')) return { icon: 'server', theme: 'theme-blue' };
      if (n.includes('l·ªçc n∆∞·ªõc')) return { icon: 'droplet', theme: 'theme-blue' };
      if (n.includes('tablet') || n.includes('m√°y t√≠nh b·∫£ng')) return { icon: 'tablet', theme: 'theme-green' };
      if (n.includes('laptop') || n.includes('m√°y t√≠nh')) return { icon: 'monitor', theme: 'theme-teal' };
      if (n.includes('ƒëi·ªán tho·∫°i') || n.includes('smartphone')) return { icon: 'smartphone', theme: 'theme-blue' };
      if (n.includes('vas') || n.includes('software') || n.includes('ph·∫ßn m·ªÅm')) return { icon: 'command', theme: 'theme-gray' };
      if (n.includes('it') || n.includes('m√°y in')) return { icon: 'printer', theme: 'theme-gray' };
      if (n.includes('d·ª•ng c·ª•') || n.includes('b·∫øp') || n.includes('dao') || n.includes('k√©o')) return { icon: 'scissors', theme: 'theme-orange' };
      if (n.includes('gia d·ª•ng') || n.includes('n·ªìi')) return { icon: 'home', theme: 'theme-orange' };
      if (n.includes('th·∫ª c√†o')) return { icon: 'credit-card', theme: 'theme-green' };
      if (n.includes('sim')) return { icon: 'cpu', theme: 'theme-green' };
      if (n.includes('ph·ª• ki·ªán') || n.includes('c√°p') || n.includes('s·∫°c')) return { icon: 'headphones', theme: 'theme-purple' };
      if (n.includes('ƒë·ªìng h·ªì')) return { icon: 'watch', theme: 'theme-gray' };
      if (n.includes('b·∫£o hi·ªÉm') || n.includes('bh')) return { icon: 'shield', theme: 'theme-green' };
      return { icon: 'tag', theme: 'theme-gray' };
  }

  // --- FILTER ---
  $: allCategoryNames = items.map(i => i.name || i.nganhHang).sort();
  
  $: filterList = allCategoryNames.filter(name => 
      name.toLowerCase().includes(filterSearch.toLowerCase())
  );

  function toggleCategoryVisibility(name) {
      if (hiddenCategories.has(name)) {
          hiddenCategories.delete(name);
      } else {
          hiddenCategories.add(name);
      }
      hiddenCategories = new Set(hiddenCategories);
      saveHiddenState();
  }

  function toggleAllVisibility(show) {
      if (show) {
          hiddenCategories = new Set();
      } else {
          hiddenCategories = new Set(allCategoryNames);
      }
      saveHiddenState();
  }

  // --- DATA LOGIC ---
  $: sourceData = showUnexported ? unexportedItems : items;

  // [QUAN TR·ªåNG] Logic L·ªçc d√πng chung cho c·∫£ Grid v√† Chart
  $: filteredItems = sourceData.filter(item => {
      const name = item.name || item.nganhHang || '';
      const visibilityMatch = !hiddenCategories.has(name);
      const valueMatch = showUnexported ? (item.soLuong > 0) : true;
      return visibilityMatch && valueMatch;
  });

  // Grid c√≥ th√™m filter search text (nh∆∞ng kh√¥ng ·∫£nh h∆∞·ªüng chart)
  $: gridDisplayItems = filteredItems.filter(item => {
      const name = item.name || item.nganhHang || '';
      return !searchText || name.toLowerCase().includes(searchText.toLowerCase());
  });

  $: sortedItems = [...gridDisplayItems].sort((a, b) => {
      const getRev = (i) => showUnexported ? (i.doanhThuQuyDoi || 0) : (i.revenue || 0);
      const getQty = (i) => showUnexported ? (i.soLuong || 0) : (i.quantity || 0);
      const getName = (i) => (i.name || i.nganhHang || '');

      if (sortMode === 'revenue_desc') return getRev(b) - getRev(a);
      if (sortMode === 'quantity_desc') return getQty(b) - getQty(a);
      if (sortMode === 'name_asc') return getName(a).localeCompare(getName(b));
      return 0;
  });

  $: totalRevenue = sourceData.reduce((sum, item) => sum + (showUnexported ? (item.doanhThuQuyDoi || 0) : (item.revenue || 0)), 0);
  $: maxVal = Math.max(...sourceData.map(i => showUnexported ? (i.doanhThuQuyDoi || 0) : (i.revenue || 0)), 1);

  // --- CHART LOGIC ---
  
  // 1. Pie Chart Data (Top 13 + Others)
  $: pieData = (() => {
      // L·∫•y danh s√°ch ƒë√£ l·ªçc, s·∫Øp x·∫øp gi·∫£m d·∫ßn
      const sorted = filteredItems
          .filter(i => (i.revenue || 0) > 0)
          .sort((a, b) => b.revenue - a.revenue);
      
      // N·∫øu √≠t h∆°n ho·∫∑c b·∫±ng 14 m·ª•c, hi·ªÉn th·ªã h·∫øt
      if (sorted.length <= 14) return sorted;

      // N·∫øu nhi·ªÅu h∆°n, l·∫•y Top 13
      const top13 = sorted.slice(0, 13);
      // Gom ph·∫ßn c√≤n l·∫°i v√†o "Kh√°c"
      const others = sorted.slice(13);
      const otherRevenue = others.reduce((sum, item) => sum + item.revenue, 0);

      return [
          ...top13,
          { name: 'Kh√°c', revenue: otherRevenue }
      ];
  })();

  // 2. Bar Chart Data (Top 15 H√£ng)
  $: barData = calculateBrandData(rawSource, filteredItems);

  function calculateBrandData(source, visibleItems) {
      if (!source || source.length === 0) return [];
      
      // T·∫°o whitelist c√°c ng√†nh h√†ng ƒêANG HI·ªÇN TH·ªä (ƒë√£ chu·∫©n h√≥a t√™n)
      const visibleCategoryNames = new Set(visibleItems.map(i => cleanCategoryName(i.name || i.nganhHang)));
      
      const brands = {};

      source.forEach(row => {
          // Chu·∫©n h√≥a t√™n ng√†nh h√†ng c·ªßa d√≤ng d·ªØ li·ªáu
          const rowCategoryName = cleanCategoryName(row.nganhHang);
          
          // [FIX] Ch·ªâ t√≠nh n·∫øu ng√†nh h√†ng n√†y n·∫±m trong danh s√°ch hi·ªÉn th·ªã
          if (!visibleCategoryNames.has(rowCategoryName)) return;

          const brandName = row.nhaSanXuat || 'Kh√°c';
          const revenue = parseFloat(String(row.thanhTien || "0").replace(/,/g, '')) || 0;
          
          if (!brands[brandName]) brands[brandName] = { name: brandName, revenue: 0 };
          brands[brandName].revenue += revenue;
      });
      return Object.values(brands).sort((a, b) => b.revenue - a.revenue).slice(0, 15);
  }

  async function renderCharts() {
      if (typeof Chart === 'undefined') return;
      await tick();

      const ctxPie = document.getElementById('luyke-cat-pie-chart');
      if (ctxPie) {
          if (chartInstancePie) chartInstancePie.destroy();
          
          // T√≠nh t·ªïng doanh thu c·ªßa Pie ƒë·ªÉ t√≠nh % ch√≠nh x√°c
          const totalPieRevenue = pieData.reduce((sum, item) => sum + item.revenue, 0);

          chartInstancePie = new Chart(ctxPie, {
              type: 'doughnut',
              data: {
                  labels: pieData.map(d => d.name),
                  datasets: [{
                      data: pieData.map(d => d.revenue),
                      backgroundColor: pieData.map(() => getRandomBrightColor()),
                      borderWidth: 1
                  }]
              },
              options: { 
                  responsive: true, 
                  maintainAspectRatio: false, 
                  plugins: { 
                      legend: { 
                          position: 'right', 
                          labels: { 
                              boxWidth: 10,
                              font: { size: 11 },
                              generateLabels: (chart) => {
                                  const data = chart.data;
                                  if (data.labels.length && data.datasets.length) {
                                      return data.labels.map((label, i) => {
                                          const value = data.datasets[0].data[i];
                                          const formattedValue = formatters.formatRevenue(value,0);
                                          const pct = totalPieRevenue > 0 ? (value / totalPieRevenue * 100).toFixed(1) + "%" : "0%";
                                          return {
                                              text: `${label} (${pct}) - ${formattedValue}`,
                                              fillStyle: data.datasets[0].backgroundColor[i],
                                              hidden: isNaN(data.datasets[0].data[i]),
                                              index: i
                                          };
                                      });
                                  }
                                  return [];
                              }
                          } 
                      },
                      datalabels: {
                          formatter: (value, ctx) => {
                              const percentage = totalPieRevenue > 0 ? (value / totalPieRevenue * 100).toFixed(1) + "%" : "0%";
                              // Ch·ªâ hi·ªán n·∫øu > 3% ƒë·ªÉ ƒë·ª° r·ªëi
                              if ((value / totalPieRevenue) < 0.03) return "";
                              return percentage;
                          },
                          color: '#fff',
                          font: { weight: 'bold', size: 10 }
                      }
                  } 
              },
              plugins: [ChartDataLabels]
          });
      }

      const ctxBar = document.getElementById('luyke-brand-bar-chart');
      if (ctxBar) {
          if (chartInstanceBar) chartInstanceBar.destroy();
          chartInstanceBar = new Chart(ctxBar, {
              type: 'bar',
              data: {
                  labels: barData.map(d => d.name),
                  datasets: [{
                      label: 'Doanh thu',
                      data: barData.map(d => d.revenue / 1000000), // Chia cho 1 tri·ªáu ƒë·ªÉ hi·ªán s·ªë nh·ªè
                      backgroundColor: barData.map(() => getRandomBrightColor()),
                      borderRadius: 4
                  }]
              },
              options: {
                  indexAxis: 'y',
                  responsive: true,
                  maintainAspectRatio: false,
                  plugins: { 
                      legend: { display: false },
                      datalabels: {
                          anchor: 'end',
                          align: 'end',
                          formatter: (value) => formatters.formatNumber(value, 0),
                          color: '#4b5563',
                          font: { weight: 'bold', size: 10 }
                      },
                      tooltip: {
                          callbacks: {
                              label: (ctx) => formatters.formatRevenue(ctx.raw * 1000000)
                          }
                      }
                  },
                  scales: { x: { beginAtZero: true } }
              },
              plugins: [ChartDataLabels]
          });
      }
  }

  // Reactive: G·ªçi renderCharts khi switch sang chart view ho·∫∑c data thay ƒë·ªïi
  $: if (viewMode === 'chart') { 
      setTimeout(renderCharts, 0); 
  }

  function handleWindowClick(e) {
      if (isSettingsOpen && !e.target.closest('.filter-wrapper')) {
          isSettingsOpen = false;
      }
  }

  afterUpdate(() => {
    if (typeof feather !== 'undefined') feather.replace();
  });
</script>

<svelte:window on:click={handleWindowClick} />

<div class="luyke-tier-2-container">
    
    <div class="luyke-toolbar" style="flex-wrap: nowrap; gap: 8px;">
        <div class="luyke-toolbar-left" style="flex-grow: 1; min-width: 0;">
            <h3 class="text-lg font-bold uppercase flex items-center gap-2 {titleClass} truncate">
                <i data-feather={titleIcon} class="{iconClass} flex-shrink-0"></i>
                <span class="truncate">{titleText}</span>
            </h3>
        </div>

        <div class="luyke-toolbar-right" style="flex-shrink: 0; display: flex; align-items: center; gap: 8px;">
            
            <div class="flex bg-gray-100 p-0.5 rounded-lg border border-gray-200">
                <button 
                    class="view-mode-btn {viewMode === 'grid' ? 'active' : ''}" 
                    on:click={() => viewMode = 'grid'}
                    title="Xem d·∫°ng th·∫ª"
                >
                    <i data-feather="grid" class="w-4 h-4"></i>
                    <span class="hidden sm:inline text-xs ml-1">Th·∫ª</span>
                </button>
                <button 
                    class="view-mode-btn {viewMode === 'chart' ? 'active' : ''}" 
                    on:click={() => viewMode = 'chart'}
                    title="Xem bi·ªÉu ƒë·ªì"
                >
                    <i data-feather="pie-chart" class="w-4 h-4"></i>
                    <span class="hidden sm:inline text-xs ml-1">Bi·ªÉu ƒë·ªì</span>
                </button>
            </div>

            {#if viewMode === 'grid'}
                <div 
                    class="toggle-wrapper {showUnexported ? 'active' : ''}" 
                    on:click={() => showUnexported = !showUnexported}
                    title="Xem doanh thu ch∆∞a xu·∫•t"
                    style="padding: 4px 8px;"
                >
                    <div class="toggle-switch" style="width: 28px; height: 16px;"></div>
                    <span class="toggle-label text-xs whitespace-nowrap">Ch∆∞a xu·∫•t</span>
                </div>
            {/if}

            <div class="relative filter-wrapper">
                <button 
                    class="luyke-icon-btn {isSettingsOpen ? 'active' : ''}" 
                    on:click={() => isSettingsOpen = !isSettingsOpen}
                    title="L·ªçc hi·ªÉn th·ªã ng√†nh h√†ng"
                >
                    <i data-feather="filter" class="w-4 h-4"></i>
                </button>

                {#if isSettingsOpen}
                    <div class="filter-dropdown">
                        <div class="filter-header">
                            <input type="text" class="filter-search" placeholder="T√¨m ng√†nh h√†ng..." bind:value={filterSearch} />
                        </div>
                        <div class="filter-body custom-scrollbar">
                            {#if filterList.length === 0}
                                <p class="text-xs text-gray-500 text-center p-2">Kh√¥ng t√¨m th·∫•y.</p>
                            {:else}
                                {#each filterList as name}
                                    <div class="filter-item" on:click={() => toggleCategoryVisibility(name)}>
                                        <input type="checkbox" checked={!hiddenCategories.has(name)} />
                                        <label>{name}</label>
                                    </div>
                                {/each}
                            {/if}
                        </div>
                        <div class="filter-actions">
                            <button class="filter-btn-link" on:click={() => toggleAllVisibility(true)}>Hi·ªán t·∫•t c·∫£</button>
                            <button class="filter-btn-link text-red-600" on:click={() => toggleAllVisibility(false)}>·∫®n t·∫•t c·∫£</button>
                        </div>
                    </div>
                {/if}
            </div>

            {#if viewMode === 'grid'}
                <div class="relative hidden lg:block">
                    <input type="text" placeholder="T√¨m nhanh..." class="luyke-search-input" style="width: 140px;" bind:value={searchText} />
                </div>
                <select class="p-1.5 border rounded text-xs bg-white outline-none cursor-pointer max-w-[100px]" bind:value={sortMode}>
                    <option value="revenue_desc">DT ‚Üì</option>
                    <option value="quantity_desc">SL ‚Üì</option>
                </select>
            {/if}
        </div>
    </div>

    {#if viewMode === 'grid'}
        {#if sortedItems.length === 0}
            <div class="p-12 text-center bg-white border border-gray-200 border-t-0 rounded-b-xl">
                <p class="text-gray-500">{showUnexported ? 'Kh√¥ng c√≥ ƒë∆°n h√†ng ch∆∞a xu·∫•t.' : 'Kh√¥ng c√≥ d·ªØ li·ªáu hi·ªÉn th·ªã.'}</p>
            </div>
        {:else}
            <div class="luyke-cat-grid p-4 bg-white border border-gray-200 border-t-0 rounded-b-xl">
                {#each sortedItems as item (item.name || item.nganhHang)}
                    {@const name = item.name || item.nganhHang}
                    {@const revenue = showUnexported ? item.doanhThuQuyDoi : item.revenue}
                    {@const quantity = showUnexported ? item.soLuong : item.quantity}
                    {@const style = getCategoryTheme(name)}
                    
                    {@const marketSharePercent = totalRevenue > 0 ? (revenue / totalRevenue) * 100 : 0}
                    {@const barPercent = maxVal > 0 ? (revenue / maxVal) * 100 : 0}
                    {@const finalTheme = showUnexported ? 'theme-warning' : style.theme}

                    <div class="cat-card-colorful {finalTheme}">
                        <div class="cat-top-row">
                            <div class="cat-icon-box">
                                <i data-feather={style.icon} class="w-5 h-5"></i>
                            </div>
                            {#if !showUnexported}
                                <span class="cat-percent-text text-xs" title="T·ª∑ tr·ªçng ƒë√≥ng g√≥p">
                                    {formatters.formatPercentage(marketSharePercent/100)}
                                </span>
                            {/if}
                        </div>
                        
                        <h4 class="cat-name-text" title={name}>{name}</h4>
                        
                        <div class="cat-value-text">
                            {formatters.formatRevenue(revenue,0)}
                        </div>
                        
                        <div class="cat-footer-row">
                            <span>SL: <strong>{formatters.formatNumber(quantity)}</strong></span>
                            {#if !showUnexported}
                                <span>TB: <strong>{formatters.formatNumber(quantity/numDays, 0)}</strong>/ng√†y</span>
                            {/if}
                        </div>

                        <div class="cat-bar-bg">
                            <div class="cat-bar-fill" style="width: {barPercent}%"></div>
                        </div>
                    </div>
                {/each}
            </div>
        {/if}
    {:else}
        <div class="luyke-charts-container p-4 bg-white border border-gray-200 border-t-0 rounded-b-xl">
            <div class="chart-box">
                <h4 class="text-sm font-bold text-gray-700 mb-2 text-center">T·ª∑ tr·ªçng Doanh Thu (ƒêVT: Tri·ªáu)</h4>
                <div class="relative h-full w-full"><canvas id="luyke-cat-pie-chart"></canvas></div>
            </div>
            <div class="chart-box">
                <h4 class="text-sm font-bold text-gray-700 mb-2 text-center">Top 15 H√£ng (ƒêVT: Tri·ªáu)</h4>
                <div class="relative h-full w-full"><canvas id="luyke-brand-bar-chart"></canvas></div>
            </div>
        </div>
    {/if}
</div>
--- END FILE: ./src/components/luyke/LuykeCategoryTable.svelte ---

--- START FILE: ./src/components/luyke/LuykeEfficiencyTable.svelte ---
<script>
  import { afterUpdate, createEventDispatcher, onMount } from 'svelte';
  import { formatters } from '../../utils/formatters.js';

  export let items = []; 
  export let dynamicItems = [];
  export let supermarketData = {}; 
  
  const dispatch = createEventDispatcher();

  let isSettingsOpen = false;
  let filterSearch = '';
  let hiddenIds = new Set(); 

  const STORAGE_KEY = 'luyke_efficiency_hidden_ids';

  onMount(() => {
      const saved = localStorage.getItem(STORAGE_KEY);
      if (saved) {
          try { hiddenIds = new Set(JSON.parse(saved)); } catch (e) {}
      }
  });

  function saveHiddenState() {
      localStorage.setItem(STORAGE_KEY, JSON.stringify([...hiddenIds]));
  }

  const iconMap = {
      'pctPhuKien': 'headphones', 'pctGiaDung': 'home', 'pctMLN': 'droplet',
      'pctSim': 'cpu', 'pctVAS': 'layers', 'pctBaoHiem': 'shield', 'tyLeTraCham': 'credit-card'
  };

  $: displayItems = [
      ...items,
      ...(dynamicItems || []).map(cfg => {
          const metric = supermarketData.dynamicMetrics?.[cfg.id];
          return {
              id: cfg.id,
              label: cfg.label,
              value: metric ? metric.value : 0,
              target: cfg.target, // Target t·ª´ config admin
              isDynamic: true,
              rawConfig: cfg
          };
      })
  ];

  $: filterList = displayItems.filter(item => item.label.toLowerCase().includes(filterSearch.toLowerCase()));
  $: visibleItems = displayItems.filter(item => !hiddenIds.has(item.id));

  function toggleVisibility(id) {
      if (hiddenIds.has(id)) hiddenIds.delete(id); else hiddenIds.add(id);
      hiddenIds = new Set(hiddenIds);
      saveHiddenState();
  }

  function toggleAllVisibility(show) {
      hiddenIds = show ? new Set() : new Set(displayItems.map(i => i.id));
      saveHiddenState();
  }

  // [LOGIC M·ªöI] M√†u s·∫Øc d·ª±a tr√™n M·ª•c ti√™u
  function getProgressColor(val, target) {
      const t = (target || 0) / 100;
      if (t <= 0) return '#3b82f6'; // M·∫∑c ƒë·ªãnh xanh n·∫øu ko c√≥ target
      return val >= t ? '#16a34a' : '#ef4444'; // Xanh l√° n·∫øu ƒë·∫°t, ƒê·ªè n·∫øu r·ªõt
  }

  function handleWindowClick(e) {
      if (isSettingsOpen && !e.target.closest('.filter-wrapper')) isSettingsOpen = false;
  }
  
  function handleDelete(id) {
      if(confirm('B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a ch·ªâ s·ªë n√†y?')) dispatch('delete', id);
  }

  afterUpdate(() => { if (typeof feather !== 'undefined') feather.replace(); });
</script>

<svelte:window on:click={handleWindowClick} />
<div class="luyke-widget h-full">
  <div class="luyke-widget-header">
    <div class="luyke-widget-title">
      <div class="p-1.5 bg-blue-100 rounded text-blue-600 mr-2">
          <i data-feather="bar-chart-2" class="w-4 h-4"></i>
      </div>
      <span>Hi·ªáu Qu·∫£ Khai Th√°c</span>
    </div>
    <div class="flex items-center gap-2">
        <button class="text-blue-600 hover:bg-blue-50 p-1.5 rounded text-xs font-bold flex items-center gap-1 border border-blue-200" on:click={() => dispatch('add')} title="Th√™m ch·ªâ s·ªë m·ªõi">
            <i data-feather="plus" class="w-3 h-3"></i> Th√™m
        </button>
        <div class="relative filter-wrapper">
            <button class="luyke-icon-btn {isSettingsOpen ? 'active' : ''}" on:click={() => isSettingsOpen = !isSettingsOpen}><i data-feather="filter" class="w-4 h-4"></i></button>
            {#if isSettingsOpen}
                <div class="filter-dropdown">
                    <div class="filter-header"><input type="text" class="filter-search" placeholder="T√¨m ch·ªâ s·ªë..." bind:value={filterSearch} /></div>
                    <div class="filter-body custom-scrollbar" style="max-height: 250px;">
                        {#each filterList as item (item.id)}
                            <div class="filter-item" on:click={() => toggleVisibility(item.id)}>
                                <input type="checkbox" checked={!hiddenIds.has(item.id)} /> <label>{item.label}</label>
                            </div>
                        {/each}
                    </div>
                    <div class="filter-actions">
                        <button class="filter-btn-link" on:click={() => toggleAllVisibility(true)}>Hi·ªán t·∫•t c·∫£</button>
                        <button class="filter-btn-link text-red-600" on:click={() => toggleAllVisibility(false)}>·∫®n t·∫•t c·∫£</button>
                    </div>
                </div>
            {/if}
        </div>
    </div>
  </div>

  <div class="luyke-widget-body custom-scrollbar">
    {#if visibleItems.length === 0}
       <div class="flex flex-col items-center justify-center h-full text-gray-400"><p class="text-sm">ƒê√£ ·∫©n h·∫øt d·ªØ li·ªáu.</p></div>
    {:else}
      <div class="flex flex-col gap-0">
        {#each visibleItems as item (item.id)}
          {@const targetVal = (item.target || 0) / 100}
          {@const color = getProgressColor(item.value, item.target)}
          {@const percent = Math.min((item.value * 100), 100)}
          
          <div class="eff-item-compact group relative hover:bg-gray-50 transition-colors">
            <div class="eff-icon-compact"><i data-feather={iconMap[item.id] || 'activity'} class="w-4 h-4"></i></div>
            <div class="eff-content-compact">
                <div class="eff-row-top">
                    <span class="eff-label-text">{item.label}</span>
                    <span class="eff-value-text" style="color: {color}">{formatters.formatPercentage(item.value)}</span>
                </div>
                <div class="eff-row-bottom">
                    <div class="eff-bar-container">
                        <div class="eff-bar-fill" style="width: {percent}%; background-color: {color};"></div>
                    </div>
                    {#if item.target > 0}
                        <span class="eff-target-text {item.value < targetVal ? 'text-red-500 font-bold' : 'text-green-600'}">MT: {item.target}%</span>
                    {/if}
                </div>
            </div>
            {#if item.isDynamic}
                <div class="absolute right-2 top-2 hidden group-hover:flex gap-1 bg-white shadow-sm border border-gray-200 rounded p-1 z-10">
                    <button on:click|stopPropagation={() => dispatch('edit', item.rawConfig)} class="text-gray-500 hover:text-blue-600 p-1"><i data-feather="edit-2" class="w-3 h-3"></i></button>
                    <button on:click|stopPropagation={() => handleDelete(item.id)} class="text-gray-500 hover:text-red-600 p-1"><i data-feather="trash-2" class="w-3 h-3"></i></button>
                </div>
            {/if}
          </div>
        {/each}
      </div>
    {/if}
  </div>
</div>
--- END FILE: ./src/components/luyke/LuykeEfficiencyTable.svelte ---

--- START FILE: ./src/components/luyke/LuykeQdcTable.svelte ---
<script>
  import { afterUpdate } from 'svelte';
  import { formatters } from '../../utils/formatters.js';
  import { cleanCategoryName } from '../../utils.js';
  import { categoryStructure, macroProductGroupConfig, selectedWarehouse } from '../../stores.js';
  import { datasyncService } from '../../services/datasync.service.js';

  export let items = []; 
  export let numDays = 1;

  let isSettingsOpen = false;
  let filterSearch = '';
  let saveTimer;
  let localConfig = []; // Danh s√°ch c√°c nh√≥m ƒê∆Ø·ª¢C CH·ªåN

  // 1. Data Sources: T·∫°o danh s√°ch t·∫•t c·∫£ nh√≥m h√†ng c√≥ th·ªÉ c√≥
  $: allGroupsFromStructure = [...new Set(($categoryStructure || []).map(c => cleanCategoryName(c.nhomHang)).filter(Boolean))].sort();
  $: allMacroGroups = ($macroProductGroupConfig || []).map(m => m.name);
  $: allPresentGroups = items.map(i => i.name).sort();
  $: allGroups = [...new Set([...allGroupsFromStructure, ...allMacroGroups, ...allPresentGroups])].sort();

  $: filterList = allGroups.filter(name => 
      name.toLowerCase().includes(filterSearch.toLowerCase())
  );

  // 2. Logic Load Config theo Kho
  $: if ($selectedWarehouse) {
      loadConfigForWarehouse($selectedWarehouse);
  } else {
      // N·∫øu kh√¥ng c√≥ kho (view to√†n b·ªô), m·∫∑c ƒë·ªãnh hi·ªán t·∫•t c·∫£
      localConfig = [...allGroups];
  }

  async function loadConfigForWarehouse(kho) {
      console.log(`[LuykeQdc] Loading config for warehouse: ${kho}`);
      try {
          const savedConfig = await datasyncService.loadQdcConfig(kho);
          if (savedConfig && Array.isArray(savedConfig)) {
              localConfig = savedConfig;
          } else {
              // [QUAN TR·ªåNG] N·∫øu ch∆∞a c√≥ config (null), m·∫∑c ƒë·ªãnh ch·ªçn T·∫§T C·∫¢
              localConfig = [...allGroups];
          }
      } catch (e) {
          console.error("Error loading config:", e);
          localConfig = [...allGroups];
      }
  }

  // 3. Logic L∆∞u Config theo Kho
  function toggleQdcSelection(name) {
      if (localConfig.includes(name)) {
          localConfig = localConfig.filter(n => n !== name);
      } else {
          localConfig = [...localConfig, name];
      }
      
      // Debounce l∆∞u cloud ƒë·ªÉ tr√°nh spam request
      clearTimeout(saveTimer);
      saveTimer = setTimeout(() => {
          if ($selectedWarehouse) {
              console.log(`[LuykeQdc] Saving config for ${$selectedWarehouse}...`);
              datasyncService.saveQdcConfig($selectedWarehouse, localConfig);
          }
      }, 500); 
  }

  function toggleAllVisibility(show) {
      if (show) {
          localConfig = [...allGroups];
      } else {
          localConfig = [];
      }
      
      if ($selectedWarehouse) {
          datasyncService.saveQdcConfig($selectedWarehouse, localConfig);
      }
  }

  // 4. Logic Hi·ªÉn th·ªã
  $: sortedItems = (() => {
      // L·ªçc danh s√°ch items d·ª±a tr√™n localConfig
      let candidates = items.filter(item => localConfig.includes(item.name));
      return candidates.sort((a, b) => (b.dtqd || 0) - (a.dtqd || 0));
  })();

  $: maxVal = sortedItems.length > 0 ? (sortedItems[0].dtqd || 1) : 1;

  function handleWindowClick(e) {
      if (isSettingsOpen && !e.target.closest('.filter-wrapper')) {
          isSettingsOpen = false;
      }
  }

  afterUpdate(() => {
    if (typeof feather !== 'undefined') feather.replace();
  });
</script>

<svelte:window on:click={handleWindowClick} />

<div class="luyke-widget h-full flex flex-col">
  <div class="luyke-widget-header">
    <div class="luyke-widget-title">
      <div class="p-1.5 bg-yellow-100 rounded text-yellow-600 mr-2">
          <i data-feather="star" class="w-4 h-4"></i>
      </div>
      <span>TOP NH√ìM H√ÄNG</span>
    </div>

    <div class="relative filter-wrapper">
        <button class="luyke-icon-btn {isSettingsOpen ? 'active' : ''}" on:click={() => isSettingsOpen = !isSettingsOpen} title="Ch·ªçn nh√≥m h√†ng">
             <i data-feather="filter" class="w-4 h-4"></i>
        </button>
        {#if isSettingsOpen}
            <div class="filter-dropdown">
                <div class="filter-header">
                    <input type="text" class="filter-search" placeholder="T√¨m nh√≥m h√†ng..." bind:value={filterSearch} />
                </div>
                <div class="filter-body custom-scrollbar" style="max-height: 250px;">
                    {#if filterList.length === 0}
                         <p class="text-xs text-gray-500 text-center p-2">Kh√¥ng t√¨m th·∫•y.</p>
                    {:else}
                        {#each filterList as name}
                            {@const isChecked = localConfig.includes(name)}
                            <div class="filter-item" on:click={() => toggleQdcSelection(name)}>
                                 <input type="checkbox" checked={isChecked} />
                                <label class="{isChecked ? 'font-bold text-blue-700' : ''}">{name}</label>
                            </div>
                        {/each}
                    {/if}
                 </div>
                <div class="filter-actions">
                    <button class="filter-btn-link" on:click={() => toggleAllVisibility(true)}>Hi·ªán t·∫•t c·∫£</button>
                    <button class="filter-btn-link text-red-600" on:click={() => toggleAllVisibility(false)}>·∫®n t·∫•t c·∫£</button>
                </div>
            </div>
        {/if}
    </div>
  </div>

  <div class="luyke-widget-body custom-scrollbar">
    {#if sortedItems.length === 0}
        <div class="flex flex-col items-center justify-center h-full text-gray-400 py-10">
          <p class="text-sm">Kh√¥ng c√≥ d·ªØ li·ªáu hi·ªÉn th·ªã.</p>
          {#if items.length > 0}
             <p class="text-xs mt-1">B·∫°n ƒë√£ ·∫©n t·∫•t c·∫£ nh√≥m h√†ng.</p>
          {/if}
       </div>
    {:else}
      <div class="flex flex-col gap-0">
        {#each sortedItems as item, index (item.name)}
          {@const percent = maxVal > 0 ? (item.dtqd / maxVal) * 100 : 0}
          <div class="py-2 border-b border-dashed border-gray-100 last:border-0 hover:bg-gray-50 transition-colors px-1">
            <div class="flex items-center gap-3">
               <div class="w-6 text-center font-bold text-gray-400 text-xs">#{index + 1}</div>
                <div class="flex-grow min-w-0">
                   <div class="flex justify-between items-center mb-1">
                       <span class="text-sm font-semibold text-gray-700 truncate pr-2" title={item.name}>{item.name}</span>
                       <span class="text-sm font-bold text-blue-600 whitespace-nowrap">{formatters.formatRevenue(item.dtqd)}</span>
                   </div>
                   <div class="w-full h-1.5 bg-gray-100 rounded-full overflow-hidden mb-1">
                        <div class="h-full bg-yellow-400 rounded-full" style="width: {percent}%"></div>
                   </div>
                   <div class="flex justify-between text-[10px] text-gray-500 flex-wrap gap-y-1">
                       <div class="flex gap-2">
                           <span>DT: <strong>{formatters.formatRevenue(item.dt)}</strong></span>
                           <span class="text-blue-600">Qƒê: <strong>{formatters.formatRevenue(item.dtqd)}</strong></span>
                       </div>
                       <div class="flex gap-2">
                           <span>SL: {formatters.formatNumber(item.quantity || item.sl)}</span>
                           <span>TB: <strong>{formatters.formatNumber((item.quantity || item.sl) / numDays, 0)}</strong>/ng√†y</span>
                       </div>
                    </div>
               </div>
            </div>
          </div>
        {/each}
      </div>
    {/if}
  </div>
</div>
--- END FILE: ./src/components/luyke/LuykeQdcTable.svelte ---

--- START FILE: ./src/components/luyke/LuykeSieuThi.svelte ---
<script>
  import { onMount, afterUpdate } from 'svelte';
  import { 
    competitionData, 
    selectedWarehouse,
    interfaceSettings,
    macroCategoryConfig,
    macroProductGroupConfig, 
    efficiencyConfig,
    qdcConfigStore,
    modalState,
    categoryNameMapping,
    warehouseCustomMetrics
  } from '../../stores.js';
  import { formatters } from '../../utils/formatters.js';
  import { reportService } from '../../services/reportService.js';
  import { settingsService } from '../../services/settings.service.js';
  import { dataProcessing } from '../../services/dataProcessing.js';
  import { adminService } from '../../services/admin.service.js';
  import { datasyncService } from '../../services/datasync.service.js';
  import * as utils from '../../utils.js';
  
  import LuykeEfficiencyTable from './LuykeEfficiencyTable.svelte';
  import LuykeQdcTable from './LuykeQdcTable.svelte';
  import LuykeCategoryTable from './LuykeCategoryTable.svelte';

  export let supermarketReport = {};
  export let filteredYCXData = []; 
  export let goals = {};
  export let numDays = 1;

  let localSupermarketReport = {};
  let localGoals = {};
  let luykeCardData = {};
  let competitionSummary = { dat: 0, total: 0 };
  let comparisonData = { value: 0, percentage: 'N/A' };
  let luotKhachData = { value: 0, percentage: 'N/A' };
  
  let chuaXuatReport = [];
  let categoryItems = []; 
  let qdcItems = []; 

  let channelStats = {
      dxm: { val: 0, pct: 0 },
      tgdd: { val: 0, pct: 0 }
  };

  let combinedEfficiencyItems = [];

  onMount(async () => {
      const savedEffConfig = await adminService.loadEfficiencyConfig();
      if(savedEffConfig.length > 0) efficiencyConfig.set(savedEffConfig);
      
      const savedQdcConfig = await adminService.loadQdcConfig();
      if(savedQdcConfig.length > 0) qdcConfigStore.set(savedQdcConfig);
  });

  $: if ($selectedWarehouse) {
      loadLocalMetrics($selectedWarehouse);
  }

  async function loadLocalMetrics(kho) {
      const localData = await datasyncService.loadCustomMetrics(kho);
      warehouseCustomMetrics.set(localData);
  }

  $: combinedEfficiencyItems = [
      ...($efficiencyConfig || []).map(i => ({ ...i, isSystem: true })),
      ...($warehouseCustomMetrics || []).map(i => ({ ...i, isSystem: false }))
  ];

  const cleanValue = (str) => {
      if (typeof str === 'number') return str;
      if (!str || typeof str !== 'string') return 0;
      const cleanStr = str.replace(/,|%/g, '').trim();
      const val = parseFloat(cleanStr);
      return isNaN(val) ? 0 : val;
  };

  $: {
    const _triggerMacroCat = $macroCategoryConfig;
    const _triggerMacroProd = $macroProductGroupConfig;
    const _triggerEff = $efficiencyConfig;
    const _triggerMap = $categoryNameMapping;
    const _triggerLocalEff = $warehouseCustomMetrics;

    localSupermarketReport = supermarketReport || {};
    localGoals = goals || {};

    const pastedText = typeof localStorage !== 'undefined' ? localStorage.getItem('daily_paste_luyke') : '';
    const pastedData = dataProcessing.parseLuyKePastedData(pastedText || '');
    const { mainKpis, dtDuKien, dtqdDuKien, dtTraCham, tyLeTraCham } = pastedData;
    
    const hasPasteData = mainKpis && mainKpis['Th·ª±c hi·ªán DT th·ª±c'];

    comparisonData = pastedData.comparisonData || { value: 0, percentage: 'N/A' };
    luotKhachData = pastedData.luotKhachData || { value: 0, percentage: 'N/A' };

    const excelData = {
        dtThuc: localSupermarketReport.doanhThu || 0,
        dtQd: localSupermarketReport.doanhThuQuyDoi || 0,
        dtGop: localSupermarketReport.doanhThuTraGop || 0,
        tyLeGop: localSupermarketReport.tyLeTraCham || 0,
        tyLeQd: localSupermarketReport.hieuQuaQuyDoi || 0,
        chuaXuatQd: localSupermarketReport.doanhThuQuyDoiChuaXuat || 0
    };

    let finalDtThuc, finalDtQd, finalDtGop, finalTyLeGop, finalTyLeQd;

    if (hasPasteData) {
        finalDtThuc = cleanValue(mainKpis['Th·ª±c hi·ªán DT th·ª±c']) * 1000000;
        finalDtQd = cleanValue(mainKpis['Th·ª±c hi·ªán DTQƒê']) * 1000000;
        finalDtGop = dtTraCham * 1000000;
        finalTyLeGop = tyLeTraCham / 100;
        finalTyLeQd = finalDtThuc > 0 ? ((finalDtQd / finalDtThuc) - 1) : 0;
    } else {
        finalDtThuc = excelData.dtThuc;
        finalDtQd = excelData.dtQd;
        finalDtGop = excelData.dtGop;
        finalTyLeGop = excelData.tyLeGop;
        finalTyLeQd = excelData.tyLeQd;
    }

    const targetThuc = parseFloat(localGoals?.doanhThuThuc || 0) * 1000000;
    const targetQD = parseFloat(localGoals?.doanhThuQD || 0) * 1000000;
    
    let phanTramTargetQd = 0;
    if (hasPasteData && mainKpis['% HT Target D·ª± Ki·∫øn (Qƒê)']) {
         phanTramTargetQd = cleanValue(mainKpis['% HT Target D·ª± Ki·∫øn (Qƒê)']) / 100;
    } else {
         phanTramTargetQd = targetQD > 0 ? ((dtqdDuKien * 1000000) / targetQD) : 0;
    }

    const phanTramTargetThuc = targetThuc > 0 ? ((dtDuKien * 1000000) / targetThuc) : 0;
    
    const compData = $competitionData || [];
    competitionSummary.total = compData.length;
    competitionSummary.dat = compData.filter(d => (parseFloat(String(d.hoanThanh).replace('%','')) || 0) >= 100).length;
    const tyLeThiDuaDat = competitionSummary.total > 0 ? competitionSummary.dat / competitionSummary.total : 0;

    luykeCardData = {
      dtThucLK: finalDtThuc,
      dtQdLK: finalDtQd,
      phanTramQd: finalTyLeQd,
      dtGop: finalDtGop,
      phanTramGop: finalTyLeGop,
      dtThucDuKien: dtDuKien * 1000000, 
      dtQdDuKien: dtqdDuKien * 1000000, 
      phanTramTargetQd: phanTramTargetQd, 
      phanTramTargetThuc: phanTramTargetThuc, 
      chuaXuatQuyDoi: excelData.chuaXuatQd,
      tyLeThiDuaDat: tyLeThiDuaDat
    };

    const calcChannelStat = (keywords) => {
        const groupConfig = ($macroCategoryConfig || []).find(g => {
            if (!g.name) return false;
            const normName = g.name.trim().toLowerCase().normalize("NFC");
            return keywords.some(k => normName.includes(k));
        });

        if (!groupConfig || !groupConfig.items) return 0;

        const details = localSupermarketReport.nganhHangChiTiet || {};
        let totalVal = 0;

        groupConfig.items.forEach(rawName => {
            const cleanKey = utils.cleanCategoryName(rawName);
            if (details[cleanKey]) {
                totalVal += (details[cleanKey].revenueQuyDoi || 0);
            }
        });
        return totalVal;
    };

    const valDXM = calcChannelStat(['ƒëmx', 'dmx', 'dien may xanh']);
    const valTGDD = calcChannelStat(['tgdd', 'the gioi di dong']);
    const totalChannelRevenue = (valDXM + valTGDD) || 1; 

    channelStats = {
        dxm: { val: valDXM, pct: valDXM / totalChannelRevenue },
        tgdd: { val: valTGDD, pct: valTGDD / totalChannelRevenue }
    };

    chuaXuatReport = reportService.generateLuyKeChuaXuatReport(filteredYCXData);
    
    qdcItems = Object.entries(localSupermarketReport.nhomHangChiTiet || {})
      .map(([name, values]) => ({ 
          id: name,
          name, 
          dtqd: values.revenueQuyDoi, 
          sl: values.quantity, 
          dt: values.revenue, 
          ...values 
      }));

    categoryItems = Object.entries(localSupermarketReport.nganhHangChiTiet || {})
      .map(([name, values]) => ({ name, dtqd: values.revenueQuyDoi, ...values }));
  }

  function openAddEffModal() {
      modalState.update(s => ({ ...s, activeModal: 'add-efficiency-modal', payload: null }));
  }

  function handleEditEffConfig(event) {
      modalState.update(s => ({ ...s, activeModal: 'add-efficiency-modal', payload: event.detail }));
  }

  async function handleDeleteEffConfig(event) {
      const id = event.detail;
      const isSystem = $efficiencyConfig.some(i => i.id === id);
      
      if (isSystem) {
          alert("ƒê√¢y l√† ch·ªâ s·ªë h·ªá th·ªëng, b·∫°n kh√¥ng th·ªÉ x√≥a. H√£y d√πng b·ªô l·ªçc ƒë·ªÉ ·∫©n n√≥ ƒëi.");
          return;
      }

      if (confirm("X√≥a ch·ªâ s·ªë c√° nh√¢n n√†y?")) {
          const newLocalMetrics = $warehouseCustomMetrics.filter(i => i.id !== id);
          warehouseCustomMetrics.set(newLocalMetrics);
          if ($selectedWarehouse) {
              await datasyncService.saveCustomMetrics($selectedWarehouse, newLocalMetrics);
          }
      }
  }

  afterUpdate(() => {
    if (typeof feather !== 'undefined') feather.replace();
  });
</script>

<div class="luyke-dashboard-container">
  
  <div>
      <h2 id="luyke-supermarket-title" class="text-2xl font-bold text-gray-800 mb-4 flex items-center gap-2">
        <i data-feather="bar-chart" class="text-blue-600"></i>
        B√°o c√°o L≈©y k·∫ø {$selectedWarehouse ? '- ' + $selectedWarehouse : '(To√†n b·ªô)'}
      </h2>

      <div id="luyke-kpi-cards-container" data-capture-group="kpi" class="kpi-grid-fixed">
        
        <div class="kpi-card-solid card-1">
            <div class="kpi-solid-header">Doanh Thu Th·ª±c <i data-feather="dollar-sign"></i></div>
            <div class="kpi-solid-value">{formatters.formatNumber((luykeCardData.dtThucLK || 0) / 1000000, 0)}</div>
            <div class="kpi-solid-sub">
                <span>DK: {formatters.formatNumber((luykeCardData.dtThucDuKien || 0) / 1000000, 0)}</span>
                <span>MT: {formatters.formatNumber(localGoals?.doanhThuThuc || 0)}</span>
            </div>
            <div class="kpi-bg-icon"><i data-feather="dollar-sign"></i></div>
        </div>

        <div class="kpi-card-solid card-2">
            <div class="kpi-solid-header">DT Quy ƒê·ªïi <i data-feather="refresh-cw"></i></div>
            <div class="kpi-solid-value">{formatters.formatNumber((luykeCardData.dtQdLK || 0) / 1000000, 0)}</div>
            <div class="kpi-solid-sub">
                <span>DK: {formatters.formatNumber((luykeCardData.dtQdDuKien || 0) / 1000000, 0)}</span>
                <span>MT: {formatters.formatNumber(localGoals?.doanhThuQD || 0)}</span>
            </div>
            <div class="kpi-bg-icon"><i data-feather="refresh-cw"></i></div>
        </div>

        <div class="kpi-card-solid card-3">
            <div class="kpi-solid-header">% HT Target (Qƒê) <i data-feather="target"></i></div>
            <div class="kpi-solid-value">{formatters.formatPercentage(luykeCardData.phanTramTargetQd || 0)}</div>
            <div class="kpi-solid-sub">
                <span>% HT DT Th·ª±c: {formatters.formatPercentage(luykeCardData.phanTramTargetThuc || 0)}</span>
            </div>
            <div class="kpi-bg-icon"><i data-feather="target"></i></div>
        </div>

        <div class="kpi-card-solid card-4">
            <div class="kpi-solid-header">Hi·ªáu qu·∫£ Qƒê <i data-feather="trending-up"></i></div>
            <div class="kpi-solid-value">{formatters.formatPercentage(luykeCardData.phanTramQd || 0)}</div>
            <div class="kpi-solid-sub">
                <span>M·ª•c ti√™u: {formatters.formatNumber(localGoals?.phanTramQD || 0)}%</span>
            </div>
            <div class="kpi-bg-icon"><i data-feather="trending-up"></i></div>
        </div>

        <div class="kpi-card-solid card-5">
            <div class="kpi-solid-header">T·ª∑ l·ªá Tr·∫£ ch·∫≠m <i data-feather="credit-card"></i></div>
            <div class="kpi-solid-value">{formatters.formatPercentage(luykeCardData.phanTramGop || 0)}</div>
            <div class="kpi-solid-sub">
                <span>Doanh s·ªë: {formatters.formatNumber((luykeCardData.dtGop || 0) / 1000000, 0)}</span>
            </div>
            <div class="kpi-bg-icon"><i data-feather="credit-card"></i></div>
        </div>

        <div class="kpi-card-solid card-6">
            <div class="kpi-solid-header">Thi ƒëua ƒë·∫°t <i data-feather="award"></i></div>
            <div class="kpi-solid-value">{competitionSummary.dat}/{competitionSummary.total}</div>
            <div class="kpi-solid-sub">
                <span>T·ª∑ l·ªá ƒë·∫°t: {formatters.formatPercentage(luykeCardData.tyLeThiDuaDat)}</span>
            </div>
            <div class="kpi-bg-icon"><i data-feather="award"></i></div>
        </div>

        <div class="kpi-card-solid card-7">
            <div class="kpi-solid-header">TƒÉng tr∆∞·ªüng CK <i data-feather="activity"></i></div>
            <div class="kpi-solid-value">{comparisonData.percentage || 'N/A'}</div>
            <div class="kpi-solid-sub">
                <span>L∆∞·ª£t kh√°ch: {luotKhachData.percentage || 'N/A'}</span>
            </div>
            <div class="kpi-bg-icon"><i data-feather="activity"></i></div>
        </div>

        <div class="kpi-card-solid card-8">
            <div class="kpi-solid-header">T·ª∑ tr·ªçng k√™nh <i data-feather="pie-chart"></i></div>
            <div class="flex flex-col gap-1 mt-1">
                <div class="flex justify-between items-baseline border-b border-white/20 pb-1">
                    <span class="text-sm font-semibold opacity-90">ƒêMX</span>
                    <div class="text-right">
                        <span class="text-lg font-bold">{formatters.formatRevenue(channelStats.dxm.val, 0)}</span>
                        <span class="text-xs opacity-90 ml-1 font-bold">({formatters.formatPercentage(channelStats.dxm.pct)})</span>
                    </div>
                </div>
                <div class="flex justify-between items-baseline pt-1">
                    <span class="text-sm font-semibold opacity-90">TGDD</span>
                    <div class="text-right">
                        <span class="text-lg font-bold">{formatters.formatRevenue(channelStats.tgdd.val, 0)}</span>
                        <span class="text-xs opacity-90 ml-1 font-bold">({formatters.formatPercentage(channelStats.tgdd.pct)})</span>
                    </div>
                </div>
            </div>
            <div class="kpi-bg-icon"><i data-feather="pie-chart"></i></div>
        </div>

      </div>
  </div>

  <div class="luyke-tier-1-grid" data-capture-group="tier1">
      <LuykeEfficiencyTable 
          items={[]} 
          dynamicItems={combinedEfficiencyItems} 
          supermarketData={localSupermarketReport}
          on:add={openAddEffModal}
          on:edit={handleEditEffConfig}
          on:delete={handleDeleteEffConfig}
      />
      <LuykeQdcTable 
          items={qdcItems} 
          numDays={numDays} 
      />
  </div>

  <div data-capture-group="tier2">
      <LuykeCategoryTable 
          items={categoryItems} 
          unexportedItems={chuaXuatReport}
          rawSource={filteredYCXData} 
          {numDays} 
      />
  </div>

</div>
--- END FILE: ./src/components/luyke/LuykeSieuThi.svelte ---

--- START FILE: ./src/components/luyke/LuykeThiDua.svelte ---
<script>
  import { afterUpdate } from 'svelte';
  import { competitionData } from '../../stores.js';
  import { formatters } from '../../utils/formatters.js';

  let viewType = 'summary'; // 'summary' | 'completion'
  let sortedData = [];
  
  // Stats calculation
  let summary = {
      total: 0,
      achieved: 0,
      revenueTotal: 0,
      revenueAchieved: 0,
      quantityTotal: 0,
      quantityAchieved: 0,
      overallRate: 0
  };

  $: {
    const data = ($competitionData || []).map(item => { 
      const hoanThanhValue = (parseFloat(String(item.hoanThanh).replace('%','')) || 0); 
      return { ...item, hoanThanhValue: hoanThanhValue }; 
    });

    summary = data.reduce((acc, d) => {
      acc.total++;
      if (d.hoanThanhValue >= 100) acc.achieved++;
      
      if (d.type === 'doanhThu') {
          acc.revenueTotal++;
          if (d.hoanThanhValue >= 100) acc.revenueAchieved++;
      }
      if (d.type === 'soLuong') {
          acc.quantityTotal++;
          if (d.hoanThanhValue >= 100) acc.quantityAchieved++;
      }
      return acc;
    }, { total: 0, achieved: 0, revenueTotal: 0, revenueAchieved: 0, quantityTotal: 0, quantityAchieved: 0 });

    summary.overallRate = summary.total > 0 ? (summary.achieved / summary.total) * 100 : 0;
    sortedData = data; 
  }

  function setViewType(newType) {
    viewType = newType;
  }
  
  function sortData(items) {
    return [...items].sort((a, b) => b.hoanThanhValue - a.hoanThanhValue); 
  };

  function getRateColor(rate) {
      if (rate >= 80) return 'text-green-600'; 
      if (rate >= 50) return 'text-yellow-600'; 
      return 'text-red-600';
  }

  $: rateStyle = getRateColor(summary.overallRate);

  afterUpdate(() => {
    if (typeof feather !== 'undefined') {
      feather.replace();
    }
  });
</script>

{#snippet flatKpiCard(title, value, subText, icon, colorClass, barPercent = 0)}
    <div class="bg-white border border-gray-200 rounded-xl p-4 shadow-sm hover:shadow-md transition-all h-full min-h-[120px] flex items-stretch justify-between relative overflow-hidden group">
        
        <div class="flex flex-col justify-between items-start z-10 mr-4 flex-grow">
            <div class="flex items-center gap-2.5">
                <div class="w-8 h-8 rounded-lg bg-gray-100 flex items-center justify-center text-gray-500 border border-gray-200 group-hover:bg-white group-hover:{colorClass} transition-colors">
                    <i data-feather={icon} class="w-4 h-4"></i>
                </div>
                <span class="text-xs font-extrabold uppercase text-gray-600 tracking-wider leading-tight">{title}</span>
            </div>

            <div class="w-full mt-auto pt-3">
                {#if barPercent > 0}
                    <div class="w-full bg-gray-100 rounded-full h-1.5 mb-2 max-w-[100px]">
                        <div class="h-1.5 rounded-full {colorClass.replace('text-', 'bg-')}" style="width: {Math.min(barPercent, 100)}%"></div>
                    </div>
                {/if}
                <div class="text-[11px] font-semibold text-gray-400 leading-snug">
                    {@html subText}
                </div>
            </div>
        </div>

        <div class="flex items-center justify-end z-10 flex-shrink-0">
            <span class="text-5xl font-black {colorClass} tracking-tighter leading-none drop-shadow-sm">{value}</span>
        </div>
    </div>
{/snippet}

{#snippet competitionCard(item)}
    {@const isProjectedCompleted = item.hoanThanhValue >= 100}
    {@const isActualCompleted = item.luyKe >= item.target}
    {@const colorBase = isProjectedCompleted ? 'green' : (item.hoanThanhValue >= 80 ? 'yellow' : 'red')}
    {@const textColor = `text-${colorBase}-600`}
    {@const barColor = `bg-${colorBase}-500`}
    {@const topBorderColor = `border-${colorBase}-500`}
    {@const targetRemaining = (item.target || 0) - (item.luyKe || 0)}
    {@const daysLeft = Math.max(30 - (new Date().getDate()), 1)}
    {@const dailyTarget = (item.target > 0 && targetRemaining > 0) ? (targetRemaining / daysLeft) : 0}

    <div class="bg-white border border-gray-200 border-t-4 {topBorderColor} rounded-lg p-3 shadow-sm hover:shadow-md hover:-translate-y-0.5 transition-all flex flex-col h-full">
        <div class="flex justify-between items-start gap-3 mb-2">
            <h4 class="font-bold text-gray-800 text-sm leading-snug line-clamp-2 flex-grow" title={item.name}>
                {item.name}
            </h4>
            <span class="text-2xl font-extrabold {textColor} leading-none flex-shrink-0">
                {formatters.formatPercentage(item.hoanThanhValue / 100)}
            </span>
        </div>

        <div class="w-full bg-gray-100 rounded-full h-1.5 mb-3">
            <div class="h-1.5 rounded-full {barColor} transition-all duration-500" style="width: {Math.min(item.hoanThanhValue, 100)}%"></div>
        </div>

        <div class="mt-auto pt-2 border-t border-dashed border-gray-100 grid grid-cols-2 gap-2 text-xs items-end">
            <div>
                <span class="block text-[10px] text-gray-400 uppercase font-semibold">TH / MT</span>
                <div class="text-gray-700 font-bold whitespace-nowrap">
                    <span>{formatters.formatNumberOrDash(item.luyKe)}</span>
                    <span class="text-gray-300 font-normal mx-0.5">/</span>
                    <span>{formatters.formatNumberOrDash(item.target)}</span>
                </div>
            </div>
            <div class="text-right">
                {#if !isActualCompleted}
                    <div class="inline-block bg-red-50 text-red-600 px-2 py-1 rounded text-[10px] font-bold border border-red-100">
                        C·∫ßn: {formatters.formatNumberOrDash(dailyTarget)}/ng√†y
                    </div>
                {:else}
                    <span class="text-green-600 font-bold text-[10px] flex items-center justify-end gap-1">
                        <i data-feather="check-circle" class="w-3 h-3"></i> ƒê√£ ƒë·∫°t
                    </span>
                {/if}
            </div>
        </div>
    </div>
{/snippet}

<div class="luyke-dashboard-container">
    
    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 mb-6" data-capture-group="kpi-thidua">
        
        {@render flatKpiCard(
            'T·ªïng Ch∆∞∆°ng tr√¨nh', 
            summary.total, 
            `DT: <strong class="text-blue-600">${summary.revenueTotal}</strong> ‚Ä¢ SL: <strong class="text-orange-600">${summary.quantityTotal}</strong>`,
            'layers',
            'text-gray-700'
        )}

        {@render flatKpiCard(
            'T·ª∑ l·ªá ƒê·∫°t', 
            formatters.formatPercentage(summary.overallRate / 100), 
            `ƒê√£ ƒë·∫°t: <strong class="${getRateColor(summary.overallRate)}">${summary.achieved}</strong> / ${summary.total}`,
            'target',
            getRateColor(summary.overallRate),
            summary.overallRate
        )}

        {@render flatKpiCard(
            'Thi ƒëua Doanh thu', 
            `${summary.revenueAchieved}/${summary.revenueTotal}`, 
            `T·ª∑ l·ªá ƒë·∫°t: <strong>${summary.revenueTotal > 0 ? formatters.formatPercentage(summary.revenueAchieved / summary.revenueTotal) : '0%'}</strong>`,
            'dollar-sign',
            'text-blue-600',
            summary.revenueTotal > 0 ? (summary.revenueAchieved / summary.revenueTotal) * 100 : 0
        )}

        {@render flatKpiCard(
            'Thi ƒëua S·ªë l∆∞·ª£ng', 
            `${summary.quantityAchieved}/${summary.quantityTotal}`, 
            `T·ª∑ l·ªá ƒë·∫°t: <strong>${summary.quantityTotal > 0 ? formatters.formatPercentage(summary.quantityAchieved / summary.quantityTotal) : '0%'}</strong>`,
            'box',
            'text-orange-600',
            summary.quantityTotal > 0 ? (summary.quantityAchieved / summary.quantityTotal) * 100 : 0
        )}

    </div>

    <div class="luyke-tier-2-container">
        
        <div class="luyke-toolbar">
            <div class="luyke-toolbar-left">
                <h3 class="text-lg font-bold uppercase flex items-center gap-2 text-gray-700">
                    <i data-feather="list" class="text-blue-600"></i>
                    Chi ti·∫øt ({summary.total})
                </h3>
            </div>

            <div class="luyke-toolbar-right flex items-center gap-2">
                <div class="flex bg-gray-100 p-0.5 rounded-lg border border-gray-200">
                    <button 
                        class="view-mode-btn {viewType === 'summary' ? 'active' : ''}" 
                        on:click={() => setViewType('summary')}
                    >
                        <i data-feather="grid" class="w-4 h-4"></i>
                        <span class="hidden sm:inline text-xs ml-1">Theo Lo·∫°i</span>
                    </button>
                    <button 
                        class="view-mode-btn {viewType === 'completion' ? 'active' : ''}" 
                        on:click={() => setViewType('completion')}
                    >
                        <i data-feather="check-circle" class="w-4 h-4"></i>
                        <span class="hidden sm:inline text-xs ml-1">Ti·∫øn ƒë·ªô</span>
                    </button>
                </div>
            </div>
        </div>

        <div class="p-4 bg-white border border-gray-200 border-t-0 rounded-b-xl min-h-[400px]">
            {#if sortedData.length === 0}
                <div class="p-12 text-center bg-gray-50 rounded-lg border-2 border-dashed border-gray-200">
                    <p class="text-gray-500 font-bold mb-2">Ch∆∞a c√≥ d·ªØ li·ªáu hi·ªÉn th·ªã.</p>
                    <p class="text-xs text-gray-400">Vui l√≤ng d√°n "Data l≈©y k·∫ø" ·ªü tab C·∫≠p nh·∫≠t d·ªØ li·ªáu.</p>
                </div>
            {:else}
                
                <div class="flex flex-col gap-8">
                    {#if viewType === 'summary'}
                        {@const dataDoanhThu = sortData(sortedData.filter(d => d.type === 'doanhThu'))}
                        {@const dataSoLuong = sortData(sortedData.filter(d => d.type === 'soLuong'))}

                        {#if dataDoanhThu.length > 0}
                            <div>
                                <h4 class="text-sm font-bold text-blue-800 uppercase flex items-center gap-2 mb-4 pb-2 border-b border-blue-100">
                                    <span class="bg-blue-100 p-1 rounded"><i data-feather="dollar-sign" class="w-4 h-4"></i></span>
                                    Thi ƒêua Doanh Thu ({dataDoanhThu.length})
                                </h4>
                                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                                    {#each dataDoanhThu as item}
                                        {@render competitionCard(item)}
                                    {/each}
                                </div>
                            </div>
                        {/if}

                        {#if dataSoLuong.length > 0}
                            <div>
                                <h4 class="text-sm font-bold text-orange-800 uppercase flex items-center gap-2 mb-4 pb-2 border-b border-orange-100">
                                    <span class="bg-orange-100 p-1 rounded"><i data-feather="box" class="w-4 h-4"></i></span>
                                    Thi ƒêua S·ªë L∆∞·ª£ng ({dataSoLuong.length})
                                </h4>
                                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                                    {#each dataSoLuong as item}
                                        {@render competitionCard(item)}
                                    {/each}
                                </div>
                            </div>
                        {/if}

                    {:else if viewType === 'completion'}
                        {@const completed = sortData(sortedData.filter(d => d.hoanThanhValue >= 100))}
                        {@const pending = sortData(sortedData.filter(d => d.hoanThanhValue < 100))}

                        {#if completed.length > 0}
                            <div>
                                <h4 class="text-sm font-bold text-green-800 uppercase flex items-center gap-2 mb-4 pb-2 border-b border-green-100">
                                    <span class="bg-green-100 p-1 rounded"><i data-feather="check" class="w-4 h-4"></i></span>
                                    ƒê√£ ho√†n th√†nh ({completed.length})
                                </h4>
                                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                                    {#each completed as item}
                                        {@render competitionCard(item)}
                                    {/each}
                                </div>
                            </div>
                        {/if}

                        {#if pending.length > 0}
                            <div>
                                <h4 class="text-sm font-bold text-red-800 uppercase flex items-center gap-2 mb-4 pb-2 border-b border-red-100">
                                    <span class="bg-red-100 p-1 rounded"><i data-feather="clock" class="w-4 h-4"></i></span>
                                    C·∫ßn n·ªó l·ª±c th√™m ({pending.length})
                                </h4>
                                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                                    {#each pending as item}
                                        {@render competitionCard(item)}
                                    {/each}
                                </div>
                            </div>
                        {/if}
                    {/if}
                </div>
            {/if}
        </div>
    </div>
</div>
--- END FILE: ./src/components/luyke/LuykeThiDua.svelte ---

--- START FILE: ./src/components/luyke/LuykeThiDuaVung.svelte ---
<script>
  /* global XLSX, feather */
  import { onMount } from 'svelte';
  import { get } from 'svelte/store';
  import { 
    thiDuaVungChiTiet, 
    thiDuaVungTong, 
    choices 
  } from '../../stores.js';
  import { dataProcessing } from '../../services/dataProcessing.js';
  import { reportService } from '../../services/reportService.js';
  import TdvInfographic from './TdvInfographic.svelte';

  let fileStatus = "";
  let isLoading = false;
  let supermarketNames = [];
  let selectedSupermarket = "";
  let reportData = null;
  let choicesInstance = null;
  let selectElement = null; 

  async function _handleFileRead(file) {
      return new Promise((resolve, reject) => {
          if (!file) return reject(new Error("No file provided."));
          const reader = new FileReader();
          reader.onload = (event) => {
              try {
                  const data = new Uint8Array(event.target.result);
                  const workbook = XLSX.read(data, { type: 'array', cellDates: true, cellText: true });
                 resolve(workbook);
              } catch (err) { reject(err); }
          };
          reader.onerror = (err) => reject(new Error("Could not read the file: " + err));
          reader.readAsArrayBuffer(file);
      });
  }

  async function handleFileInput(event) {
    const file = event.target.files[0];
    const fileNameEl = document.getElementById('file-name-thidua-vung');
    if (!file) {
      if (fileNameEl) fileNameEl.textContent = "Ch∆∞a th√™m file";
      fileStatus = "";
      return;
    }

    isLoading = true;
    if (fileNameEl) fileNameEl.textContent = file.name;
    fileStatus = "ƒêang x·ª≠ l√Ω file...";

    try {
      const workbook = await _handleFileRead(file);
      const { chiTietData, tongData } = dataProcessing.processThiDuaVungFile(workbook);
      
      if (!tongData || tongData.length === 0) {
        throw new Error('Kh√¥ng t√¨m th·∫•y d·ªØ li·ªáu h·ª£p l·ªá trong file.');
      }

      thiDuaVungChiTiet.set(chiTietData);
      thiDuaVungTong.set(tongData);
 
      const supermarketKey = Object.keys(tongData[0]).find(k => k.trim().toLowerCase().includes('si√™u th·ªã'));
      supermarketNames = [...new Set(tongData.map(row => row[supermarketKey]).filter(Boolean))].sort();

      if (choicesInstance) {
        choicesInstance.clearStore();
        choicesInstance.setChoices(
          supermarketNames.map(name => ({ value: name, label: name })),
          'value',
          'label',
          true
        );
      }
      
      fileStatus = `‚úÖ ƒê√£ x·ª≠ l√Ω ${supermarketNames.length} si√™u th·ªã.`;
    } catch (error) {
      console.error("L·ªói x·ª≠ l√Ω file Thi ƒêua V√πng:", error);
      fileStatus = `‚ùå L·ªói: ${error.message}`;
    } finally {
      isLoading = false;
      event.target.value = null; 
    }
  }

  function handleFilterChange() {
    if (!choicesInstance) return;
    const selectedValue = choicesInstance.getValue(true);
    selectedSupermarket = selectedValue;
 
    if (selectedValue) {
      reportData = reportService.generateThiDuaVungReport(selectedValue);
    } else {
      reportData = null;
    }
  }

  onMount(() => {
    if (typeof Choices !== 'undefined' && selectElement) {
      choicesInstance = new Choices(selectElement, {
        searchEnabled: true,
        removeItemButton: false,
        itemSelectText: 'Ch·ªçn',
        searchPlaceholderValue: 'T√¨m ki·∫øm si√™u th·ªã...'
      });
      choices.update(c => ({ ...c, thiDuaVung_sieuThi: choicesInstance }));
    }
    
    if (typeof feather !== 'undefined') {
      feather.replace();
    }
  });
</script>

<div class="content-card"> 
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 items-end"> 
        <div class="data-input-group input-group--blue"> 
            <div class="flex flex-col sm:flex-row sm:items-center sm:gap-4"> 
                <label class="data-input-group__label !mb-2 sm:!mb-0 flex-shrink-0">File Thi ƒêua V√πng:</label> 
                <div class="flex items-center gap-2"> 
                    <label 
                        for="file-thidua-vung" 
                        class="data-input-group__file-trigger"
                        class:opacity-50={isLoading}
                    >
                        {isLoading ? 'ƒêang x·ª≠ l√Ω...' : 'Th√™m file'}
                    </label> 
                    <span id="file-name-thidua-vung" class="data-input-group__file-name">Ch∆∞a th√™m file</span> 
                </div>
            </div> 
            <input 
                type="file" 
                id="file-thidua-vung" 
                class="hidden" 
                data-name="Thi ƒëua v√πng" 
                accept=".xlsx, .xls, .csv"
                on:change={handleFileInput}
                disabled={isLoading}
            > 
            <div class="data-input-group__status-wrapper mt-2">
                <span 
                    class="data-input-group__status-text"
                    class:text-green-600={fileStatus.startsWith('‚úÖ')}
                    class:text-red-600={fileStatus.startsWith('‚ùå')}
                >
                    {fileStatus}
                </span>
            </div> 
        </div>
        
        <div class="data-input-group input-group--yellow h-full" style="min-height: 104px;"> 
             <label class="data-input-group__label">Ch·ªçn Si√™u th·ªã:</label> 
             <div class="data-input-group__content">
                <select 
                    id="thidua-vung-filter-supermarket" 
                    bind:this={selectElement}
                    on:change={handleFilterChange}
                >
                    <option value="">Vui l√≤ng t·∫£i file...</option>
                </select> 
             </div>
        </div> 
    </div>
</div> 

<div id="thidua-vung-infographic-container" class="mt-6"> 
    {#if reportData}
        <TdvInfographic {reportData} />
    {:else}
        <div class="placeholder-message">Vui l√≤ng t·∫£i file v√† ch·ªçn m·ªôt si√™u th·ªã ƒë·ªÉ xem b√°o c√°o.</div> 
    {/if}
</div>
--- END FILE: ./src/components/luyke/LuykeThiDuaVung.svelte ---

--- START FILE: ./src/components/luyke/LuykeUnexportedTable.svelte ---
<script>
  import { afterUpdate } from 'svelte';
  import { sortState } from '../../stores.js';
  import { formatters } from '../../utils/formatters.js';
  // FIX: ƒê∆∞·ªùng d·∫´n ƒë√∫ng
  import SortableTh from '../common/SortableTh.svelte';

  export let items = [];

  const tableType = 'luyke_chuaxuat';
  
  let totals = { soLuong: 0, doanhThuThuc: 0, doanhThuQuyDoi: 0 };

  function handleSort(event) {
    const sortKey = event.detail;
    const currentState = $sortState[tableType] || { key: 'doanhThuQuyDoi', direction: 'desc' };
    let newDirection;
    if (currentState.key === sortKey) {
      newDirection = currentState.direction === 'desc' ? 'asc' : 'desc';
    } else {
      newDirection = 'desc';
    }
    sortState.update(current => {
      current[tableType] = { key: sortKey, direction: newDirection };
      return current;
    });
  }

  $: currentSortKey = $sortState[tableType]?.key || 'doanhThuQuyDoi';
  $: currentSortDirection = $sortState[tableType]?.direction || 'desc';

  $: sortedItems = [...items].sort((a, b) => {
    const key = currentSortKey;
    const direction = currentSortDirection;
    let valA, valB;
     if (key === 'nganhHang') {
      valA = a.nganhHang || ''; valB = b.nganhHang || '';
      return direction === 'asc' ? valA.localeCompare(valB) : valB.localeCompare(valA);
    } else {
      valA = a[key] || 0; valB = b[key] || 0;
    }
    return direction === 'asc' ? valA - valB : valB - valA;
  });

  $: totals = items.reduce((acc, item) => {
      acc.soLuong += item.soLuong; 
      acc.doanhThuThuc += item.doanhThuThuc; 
      acc.doanhThuQuyDoi += item.doanhThuQuyDoi; 
      return acc; 
  }, { soLuong: 0, doanhThuThuc: 0, doanhThuQuyDoi: 0 });
</script>

<div data-capture-group="2" class="bg-white rounded-xl shadow-md p-4 sm:p-6 border border-gray-200 h-full flex flex-col">
  <h3 class="text-xl font-bold uppercase mb-4 border-b pb-2">Doanh thu ch∆∞a xu·∫•t</h3>
  
  {#if sortedItems.length === 0}
     <div class="flex-grow flex items-center justify-center">
        <p class="text-gray-500 font-bold p-4 text-center">Kh√¥ng c√≥ ƒë∆°n h√†ng n√†o ch∆∞a xu·∫•t.</p>
     </div>
  {:else}
    <div id="luyke-unexported-revenue-content" class="overflow-x-auto flex-grow">
        <table class="min-w-full text-sm table-bordered table-striped" data-table-type={tableType}>
        <thead class="text-xs text-slate-800 uppercase bg-slate-200 font-bold sticky top-0 z-10 shadow-sm">
            <tr>
            <SortableTh key="nganhHang" label="Ng√†nh h√†ng" sortKey={currentSortKey} sortDirection={currentSortDirection} on:sort={handleSort} />
            <SortableTh key="soLuong" label="S·ªë l∆∞·ª£ng" align="right" sortKey={currentSortKey} sortDirection={currentSortDirection} on:sort={handleSort} />
            <SortableTh key="doanhThuThuc" label="Doanh thu th·ª±c" align="right" sortKey={currentSortKey} sortDirection={currentSortDirection} on:sort={handleSort} />
            <SortableTh key="doanhThuQuyDoi" label="Doanh thu Qƒê" align="right" sortKey={currentSortKey} sortDirection={currentSortDirection} on:sort={handleSort} />
            </tr>
        </thead>
        <tbody>
            {#each sortedItems as item (item.nganhHang)}
            <tr class="hover:bg-gray-50">
                <td class="px-4 py-2 font-semibold">{item.nganhHang}</td>
                <td class="px-4 py-2 text-right font-bold">{formatters.formatNumber(item.soLuong)}</td>
                <td class="px-4 py-2 text-right font-bold">{formatters.formatRevenue(item.doanhThuThuc)}</td> 
                <td class="px-4 py-2 text-right font-bold text-blue-600">{formatters.formatRevenue(item.doanhThuQuyDoi)}</td> 
            </tr>
            {/each}
        </tbody>
        <tfoot class="table-footer font-bold bg-gray-100 border-t-2 border-gray-300 sticky bottom-0">
            <tr>
                <td class="px-4 py-2">T·ªïng</td>
                <td class="px-4 py-2 text-right">{formatters.formatNumber(totals.soLuong)}</td>
                <td class="px-4 py-2 text-right">{formatters.formatRevenue(totals.doanhThuThuc)}</td> 
                <td class="px-4 py-2 text-right">{formatters.formatRevenue(totals.doanhThuQuyDoi)}</td> 
            </tr>
        </tfoot>
        </table>
    </div>
  {/if}
</div>
--- END FILE: ./src/components/luyke/LuykeUnexportedTable.svelte ---

--- START FILE: ./src/components/luyke/TdvInfographic.svelte ---
<script>
  // Component n√†y nh·∫≠n d·ªØ li·ªáu ƒë√£ ƒë∆∞·ª£c x·ª≠ l√Ω v√† ch·ªâ render ra HTML.
  import { formatters } from '../../utils/formatters.js';

  export let reportData;

  // --- Logic render ƒë∆∞·ª£c di chuy·ªÉn t·ª´ ui-thidua-vung.js ---
  let summary, coGiai, sapCoGiai, tiemNang, canCoGangNhieu;
  let keyMap = {};
  let soonPrizeTitleText = '';
  let tyLeDatClass = '';

  // Helper function (gi·ªØ nguy√™n t·ª´ file g·ªëc)
  const findKey = (item, keyword) => {
      if (!item) return keyword; 
      return Object.keys(item).find(k => k.trim().toLowerCase().includes(keyword.toLowerCase())) || keyword;
  }

  // $: l√† m·ªôt kh·ªëi reactive. N√≥ s·∫Ω t·ª± ƒë·ªông ch·∫°y l·∫°i khi 'reportData' thay ƒë·ªïi.
  $: {
    if (!reportData) {
      // N·∫øu kh√¥ng c√≥ data, reset
      summary = null;
      coGiai = [];
      sapCoGiai = [];
      tiemNang = [];
      canCoGangNhieu = [];
} else {
      // Destructure d·ªØ li·ªáu
      ({ summary, coGiai, sapCoGiai, tiemNang, canCoGangNhieu } = reportData);

      // T√¨m keys (gi·ªëng h·ªát logic c≈©)
      const firstItem = coGiai[0] || sapCoGiai[0] || tiemNang[0] || canCoGangNhieu[0];
      keyMap = {
          sieuThi: findKey(summary, 'si√™u th·ªã'),
          tongThuongTamTinh: findKey(summary, 't·ªïng th∆∞·ªüng t·∫°m t·ªânh'),
          slThiDua: findKey(summary, 'sl nh thi ƒëua'),
          slDat: findKey(summary, 'sl nh >100%'),
          tyLeDat: findKey(summary, 't·ª∑ l·ªá nh ƒë·∫°t >100%'),
          slCoGiai: findKey(summary, 'sl nh d·ª± ki·∫øn ƒë·∫°t gi·∫£i'),
          nganhHang: findKey(firstItem, 'ng√†nh h√†ng'),
          phanTramDuKien: findKey(firstItem, '% d·ª± ki·∫øn'),
          duKienVuot: findKey(firstItem, 'd·ª± ki·∫øn d.thu'),
          hangVuotTroi: findKey(firstItem, 'h·∫°ng v∆∞·ª£t tr·ªôi'),
          hangTarget: findKey(firstItem, 'h·∫°ng % target'),
          tongThuong: findKey(firstItem, 't·ªïng th∆∞·ªüng'),
          hangCoGiaiKenh: 'hangCoGiaiKenh'
      };

      // T√≠nh to√°n text/class (gi·ªëng h·ªát logic c≈©)
      const totalSoonPrize = sapCoGiai.reduce((sum, item) => sum + (item.thuongTiemNang || 0), 0);
      soonPrizeTitleText = totalSoonPrize > 0 ? ` - DK: ${formatters.formatNumber(totalSoonPrize)}ƒë` : '';

      const tyLeDatValue = summary[keyMap.tyLeDat] || 0;
      tyLeDatClass = tyLeDatValue >= 0.6 ? 'tdv-tyledat-high' : 'tdv-tyledat-low';
    }
  }
</script>

{#if reportData}
<div class="tdv-infographic-card" data-capture-group="thidua-vung">
    <div class="tdv-header">
        <h2 class="tdv-supermarket-name">{summary[keyMap.sieuThi]}</h2>
        <div class="tdv-total-prize-container">
            <span class="tdv-total-prize-label">T·ªïng th∆∞·ªüng t·∫°m t√≠nh:</span>
            <span class="tdv-total-prize-value">{formatters.formatNumber(summary[keyMap.tongThuongTamTinh])}ƒë</span>
        </div>
    </div>

    <div class="tdv-summary-grid">
        <div class="tdv-summary-item">
            <span class="tdv-summary-value">{formatters.formatNumber(summary[keyMap.slThiDua])}</span>
            <span class="tdv-summary-label">Ng√†nh thi ƒëua</span>
        </div>
        <div class="tdv-summary-item">
            <span class="tdv-summary-value">{formatters.formatNumber(summary[keyMap.slDat])}</span>
            <span class="tdv-summary-label">Ng√†nh >100%</span>
        </div>
        <div class="tdv-summary-item">
            <span class="tdv-summary-value {tyLeDatClass}">{formatters.formatPercentage(summary[keyMap.tyLeDat] || 0)}</span>
            <span class="tdv-summary-label">T·ª∑ l·ªá ƒë·∫°t</span>
        </div>
         <div class="tdv-summary-item">
            <span class="tdv-summary-value">{formatters.formatNumber(summary[keyMap.slCoGiai])}</span>
            <span class="tdv-summary-label">Ng√†nh d·ª± ki·∫øn c√≥ gi·∫£i</span>
        </div>
        <div class="tdv-summary-item">
            <span class="tdv-summary-value">{formatters.formatNumber(summary[keyMap.hangCoGiaiKenh])}</span>
            <span class="tdv-summary-label">H·∫°ng c√≥ gi·∫£i (K√™nh)</span>
        </div>
    </div>

    <div class="tdv-rows-container">
        <div class="tdv-row">
            <h3 class="tdv-row-title tdv-row-title--prize">Ng√†nh h√†ng c√≥ gi·∫£i ({coGiai.length})</h3>
            <div class="tdv-row-body grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                {#if coGiai.length > 0}
                    {#each coGiai as item (item[keyMap.nganhHang])}
                        <div class="tdv-item-card">
                            <p class="tdv-item-card__title">{item[keyMap.nganhHang]}</p>
                            <div class="tdv-progress-bar-container">
                                <div class="tdv-progress-bar tdv-progress-bar--blue" style="width: {Math.min(item[keyMap.phanTramDuKien] * 100, 100)}%;"></div>
                                <span class="tdv-progress-bar__text">{formatters.formatPercentage(item[keyMap.phanTramDuKien])}</span>
                            </div>
                            <div class="tdv-item-card__details">
                                <span>V∆∞·ª£t: <strong>{formatters.formatNumber(item[keyMap.duKienVuot])}</strong></span>
                                <span>H·∫°ng DT/SL: <strong>{item[keyMap.hangVuotTroi]}</strong></span>
                                <span>H·∫°ng %: <strong>{item[keyMap.hangTarget]}</strong></span>
                                <span class="tdv-item-card__prize">Th∆∞·ªüng: <strong>{formatters.formatNumber(item[keyMap.tongThuong])}</strong></span>
                            </div>
                        </div>
                    {/each}
                {:else}
                    <p class="text-xs text-gray-500 col-span-full">Kh√¥ng c√≥.</p>
                {/if}
            </div>
        </div>

        <div class="tdv-row">
            <h3 class="tdv-row-title tdv-row-title--soon-prize">S·∫Øp c√≥ gi·∫£i ({sapCoGiai.length})<span class="tdv-row-subtitle">{soonPrizeTitleText}</span></h3>
            <div class="tdv-row-body grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                {#if sapCoGiai.length > 0}
                    {#each sapCoGiai as item (item[keyMap.nganhHang])}
                        <div class="tdv-item-card">
                            <p class="tdv-item-card__title">{item[keyMap.nganhHang]}</p>
                            <div class="tdv-progress-bar-container">
                                <div class="tdv-progress-bar tdv-progress-bar--yellow" style="width: {Math.min(item[keyMap.phanTramDuKien] * 100, 100)}%;"></div>
                                <span class="tdv-progress-bar__text">{formatters.formatPercentage(item[keyMap.phanTramDuKien])}</span>
                            </div>
                            <div class="tdv-item-card__details">
                                <span>C√°ch gi·∫£i: <strong>{item.khoangCach} h·∫°ng</strong></span>
                                <span>H·∫°ng DT/SL: <strong>{item[keyMap.hangVuotTroi]}</strong></span>
                                <span>H·∫°ng %: <strong>{item[keyMap.hangTarget]}</strong></span>
                                <span class="tdv-item-card__prize">Th∆∞·ªüng DK: <strong>{formatters.formatNumber(item.thuongTiemNang)}</strong></span>
                            </div>
                        </div>
                    {/each}
                {:else}
                    <p class="text-xs text-gray-500 col-span-full">Kh√¥ng c√≥.</p>
                {/if}
            </div>
        </div>

        <div class="tdv-row">
            <h3 class="tdv-row-title tdv-row-title--effort">Nh√≥m c√≤n l·∫°i ({tiemNang.length + canCoGangNhieu.length})</h3>
            <div class="tdv-row-body tdv-row-body--effort">
                {#if tiemNang.length > 0}
                    <div class="tdv-effort-subgroup">
                        <h4 class="tdv-effort-subgroup__title tdv-effort-subgroup__title--potential">Ti·ªÅm nƒÉng (c√°ch 21-40 h·∫°ng)</h4>
                        <div class="tdv-effort-list">
                            {#each tiemNang as item (item[keyMap.nganhHang])}
                                <div class="tdv-effort-item">{item[keyMap.nganhHang]} (c√°ch {item.khoangCach})</div>
                            {/each}
                        </div>
                    </div>
                {/if}

                {#if canCoGangNhieu.length > 0}
                     <div class="tdv-effort-subgroup">
                        <h4 class="tdv-effort-subgroup__title tdv-effort-subgroup__title--major">C·∫ßn c·ªë g·∫Øng nhi·ªÅu</h4>
                        <div class="tdv-effort-list">
                            {#each canCoGangNhieu as item (item[keyMap.nganhHang])}
                                <div class="tdv-effort-item">{item[keyMap.nganhHang]}</div>
                            {/each}
                        </div>
                    </div>
                {/if}

                {#if tiemNang.length === 0 && canCoGangNhieu.length === 0}
                    <p class="text-xs text-gray-500">Kh√¥ng c√≥.</p>
                {/if}
            </div>
        </div>
    </div>
</div>
{/if}
--- END FILE: ./src/components/luyke/TdvInfographic.svelte ---

--- START FILE: ./src/components/modals/AddEfficiencyColumnModal.svelte ---
<script>
    import { createEventDispatcher } from 'svelte';
    import { categoryStructure } from '../../stores.js';
    import { cleanCategoryName } from '../../utils.js';

    export let isOpen = false;
    export let editItem = null; // N·∫øu null l√† th√™m m·ªõi, c√≥ data l√† s·ª≠a
    
    // [M·ªöI] Bi·∫øn c·ªù ƒë·ªÉ x√°c ƒë·ªãnh ƒëang m·ªü t·ª´ Admin hay User
    export let isAdmin = false;

    const dispatch = createEventDispatcher();

    // D·ªØ li·ªáu form
    let label = '';
    let groupA = []; // Danh s√°ch t√™n nh√≥m/ng√†nh h√†ng t·ª≠ s·ªë
    let groupB = []; // Danh s√°ch t√™n nh√≥m/ng√†nh h√†ng m·∫´u s·ªë
    let target = 80;
    let type = 'DTTL'; // 'SL', 'DTTL' (Doanh thu th·ª±c), 'DTQD'
    let searchA = '';
    let searchB = '';

    // L·∫•y danh s√°ch duy nh·∫•t t·ª´ categoryStructure
    $: uniqueCategories = [...new Set(($categoryStructure || []).map(c => cleanCategoryName(c.nganhHang)).filter(Boolean))].sort();
    $: uniqueGroups = [...new Set(($categoryStructure || []).map(c => cleanCategoryName(c.nhomHang)).filter(Boolean))].sort();
    
    let modeA = 'group'; // 'group' | 'category'
    let modeB = 'category'; // 'group' | 'category'

    $: listSourceA = modeA === 'group' ? uniqueGroups : uniqueCategories;
    $: listSourceB = modeB === 'group' ? uniqueGroups : uniqueCategories;

    $: filteredListA = listSourceA.filter(i => i.toLowerCase().includes(searchA.toLowerCase()));
    $: filteredListB = listSourceB.filter(i => i.toLowerCase().includes(searchB.toLowerCase()));

    // Kh·ªüi t·∫°o khi edit
    $: if (isOpen) {
        if (editItem) {
            label = editItem.label;
            groupA = [...(editItem.groupA || [])];
            groupB = [...(editItem.groupB || [])];
            target = editItem.target;
            type = editItem.type || 'DTTL';
            modeA = editItem.modeA || 'group';
            modeB = editItem.modeB || 'category';
        } else {
            // Reset form khi th√™m m·ªõi
            label = '';
            groupA = [];
            groupB = [];
            target = 80;
            type = 'DTTL';
            modeA = 'group';
            modeB = 'category';
            searchA = '';
            searchB = '';
        }
    }

    function toggleSelection(list, item) {
        if (list.includes(item)) return list.filter(i => i !== item);
        return [...list, item];
    }

    function toggleAll(isA, sourceList) {
        if (isA) {
            groupA = groupA.length === sourceList.length ? [] : [...sourceList];
        } else {
            groupB = groupB.length === sourceList.length ? [] : [...sourceList];
        }
    }

    function handleSave() {
        if (!label.trim()) {
            alert("Vui l√≤ng nh·∫≠p T√™n c·ªôt.");
            return;
        }
        if (groupA.length === 0) {
            alert("Vui l√≤ng ch·ªçn √≠t nh·∫•t 1 m·ª•c cho T·ª≠ s·ªë (Nh√≥m A).");
            return;
        }
        if (groupB.length === 0) {
            alert("Vui l√≤ng ch·ªçn √≠t nh·∫•t 1 m·ª•c cho M·∫´u s·ªë (Nh√≥m B).");
            return;
        }

        dispatch('save', {
            id: editItem ? editItem.id : `eff_${Date.now()}`,
            label, 
            groupA, 
            groupB, 
            // [LOGIC M·ªöI] N·∫øu l√† Admin, target = 0 (ƒë·ªÉ c·∫•u h√¨nh ·ªü ch·ªó kh√°c). N·∫øu User, l·∫•y gi√° tr·ªã nh·∫≠p.
            target: isAdmin ? 0 : target, 
            type, 
            modeA, 
            modeB
        });
        close();
    }

    function close() {
        dispatch('close');
    }
</script>

{#if isOpen}
<div class="fixed inset-0 bg-gray-900 bg-opacity-50 z-[1300] flex items-center justify-center p-4 backdrop-blur-sm" on:click={close} role="button" tabindex="0">
    <div class="bg-white rounded-xl shadow-2xl w-full max-w-4xl max-h-[90vh] flex flex-col overflow-hidden" on:click|stopPropagation>
        
        <div class="p-5 border-b border-gray-200 flex justify-between items-center bg-gray-50">
            <div>
                <h3 class="text-xl font-bold text-gray-800 flex items-center gap-2">
                    {editItem ? 'Ch·ªânh s·ª≠a' : 'Th√™m'} C·ªôt T·ª∑ l·ªá Nh√≥m h√†ng
                    {#if isAdmin}
                        <span class="text-xs bg-orange-100 text-orange-700 px-2 py-0.5 rounded border border-orange-200 uppercase">System Config</span>
                    {/if}
                </h3>
                <p class="text-sm text-gray-500 mt-1">C√¥ng th·ª©c t√≠nh: (T·ªïng Nh√≥m A / T·ªïng Nh√≥m B) * 100%</p>
            </div>
            <button on:click={close} class="text-gray-400 hover:text-red-500 transition-colors text-3xl leading-none">&times;</button>
        </div>

        <div class="p-6 overflow-y-auto flex-1 custom-scrollbar bg-white">
            
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div class="space-y-4">
                    <div>
                        <label for="col-label" class="block text-sm font-bold text-gray-700 mb-1">T√™n hi·ªÉn th·ªã (Label)</label>
                        <input id="col-label" type="text" bind:value={label} class="w-full p-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none text-sm" placeholder="VD: % Gia d·ª•ng, % Ph·ª• ki·ªán...">
                    </div>
                    
                    <div class="grid grid-cols-2 gap-4">
                        {#if !isAdmin}
                            <div>
                                <label for="col-target" class="block text-sm font-bold text-gray-700 mb-1">M·ª•c ti√™u khai th√°c (%)</label>
                                <input id="col-target" type="number" bind:value={target} class="w-full p-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none text-sm" placeholder="80">
                            </div>
                        {:else}
                            <div class="col-span-1 flex items-center p-2 bg-gray-100 rounded text-xs text-gray-500 italic">
                                Target ƒë∆∞·ª£c thi·∫øt l·∫≠p ri√™ng t·∫°i module "Thi·∫øt l·∫≠p m·ª•c ti√™u".
                            </div>
                        {/if}
                        
                        <div>
                            <label class="block text-sm font-bold text-gray-700 mb-1">Lo·∫°i d·ªØ li·ªáu t√≠nh</label>
                            <div class="flex flex-col gap-2 mt-1">
                                <label class="cursor-pointer flex items-center text-sm"><input type="radio" bind:group={type} value="DTTL" class="mr-2 accent-blue-600"> Doanh thu Th·ª±c</label>
                                <label class="cursor-pointer flex items-center text-sm"><input type="radio" bind:group={type} value="DTQD" class="mr-2 accent-blue-600"> Doanh thu Qƒê</label>
                                <label class="cursor-pointer flex items-center text-sm"><input type="radio" bind:group={type} value="SL" class="mr-2 accent-blue-600"> S·ªë l∆∞·ª£ng</label>
                            </div>
                        </div>
                    </div>
                    
                    {#if !isAdmin}
                        <div class="bg-yellow-50 p-3 rounded-lg border border-yellow-200 text-xs text-yellow-800 leading-relaxed">
                            <strong>L∆∞u √Ω:</strong> N·∫øu t·ª∑ l·ªá c·ªßa nh√¢n vi√™n nh·ªè h∆°n M·ª•c ti√™u, √¥ s·∫Ω ƒë∆∞·ª£c t√¥ ƒë·ªè. Ng∆∞·ª£c l·∫°i s·∫Ω c√≥ m√†u xanh.
                        </div>
                    {/if}
                </div>

                <div class="hidden lg:flex items-center justify-center bg-blue-50 rounded-lg border border-blue-100 p-6 text-center">
                    <div>
                        <div class="w-12 h-12 bg-blue-100 text-blue-600 rounded-full flex items-center justify-center mx-auto mb-3">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                        </div>
                        <h4 class="font-bold text-blue-800 mb-1">H∆∞·ªõng d·∫´n ch·ªçn nh√≥m</h4>
                        <p class="text-sm text-blue-700">
                            <strong>Nh√≥m A (T·ª≠ s·ªë):</strong> C√°c nh√≥m h√†ng con c·∫ßn t√≠nh t·ª∑ l·ªá (VD: N·ªìi c∆°m, B·∫øp ga...).<br>
                            <strong>Nh√≥m B (M·∫´u s·ªë):</strong> Ng√†nh h√†ng m·∫π ƒë·ªÉ so s√°nh (VD: Gia d·ª•ng, CE...).
                        </p>
                    </div>
                </div>
            </div>

            <hr class="my-6 border-gray-200">

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 h-[450px]">
                <div class="flex flex-col border rounded-xl overflow-hidden border-gray-300 shadow-sm">
                    <div class="p-3 bg-blue-50 border-b border-blue-100">
                        <h4 class="font-bold text-blue-800 text-sm uppercase">T√™n Nh√≥m A (T·ª≠ s·ªë)</h4>
                        <div class="flex gap-4 mt-2 text-xs font-medium text-gray-600">
                            <label class="flex items-center cursor-pointer hover:text-blue-700">
                                <input type="radio" bind:group={modeA} value="group" class="mr-1 accent-blue-600"> Nh√≥m h√†ng
                            </label>
                            <label class="flex items-center cursor-pointer hover:text-blue-700">
                                <input type="radio" bind:group={modeA} value="category" class="mr-1 accent-blue-600"> Ng√†nh h√†ng
                            </label>
                        </div>
                    </div>
                    
                    <div class="p-2 border-b border-gray-200 bg-white">
                        <input type="text" bind:value={searchA} class="w-full p-2 border border-gray-300 rounded text-sm focus:border-blue-500 outline-none" placeholder="T√¨m ki·∫øm...">
                    </div>

                    <div class="flex-grow overflow-y-auto p-2 bg-slate-50 custom-scrollbar">
                        <div class="mb-2 px-2 flex justify-between items-center">
                            <span class="text-xs font-bold text-gray-500">{groupA.length} ƒë√£ ch·ªçn</span>
                            <button class="text-xs text-blue-600 hover:underline font-medium" on:click={() => toggleAll(true, filteredListA)}>
                                {groupA.length === filteredListA.length ? 'B·ªè ch·ªçn t·∫•t c·∫£' : 'Ch·ªçn t·∫•t c·∫£'}
                            </button>
                        </div>
                        <div class="space-y-1">
                            {#each filteredListA as item}
                                <label class="flex items-center p-2 hover:bg-white rounded cursor-pointer transition-colors border border-transparent hover:border-blue-200 group">
                                    <input type="checkbox" checked={groupA.includes(item)} on:change={() => groupA = toggleSelection(groupA, item)} class="mr-3 w-4 h-4 accent-blue-600 rounded border-gray-300">
                                    <span class="text-sm text-gray-700 group-hover:text-blue-700">{item}</span>
                                </label>
                            {/each}
                        </div>
                    </div>
                </div>

                <div class="flex flex-col border rounded-xl overflow-hidden border-gray-300 shadow-sm">
                    <div class="p-3 bg-green-50 border-b border-green-100">
                        <h4 class="font-bold text-green-800 text-sm uppercase">T√™n Nh√≥m B (M·∫´u s·ªë)</h4>
                        <div class="flex gap-4 mt-2 text-xs font-medium text-gray-600">
                            <label class="flex items-center cursor-pointer hover:text-green-700">
                                <input type="radio" bind:group={modeB} value="group" class="mr-1 accent-green-600"> Nh√≥m h√†ng
                            </label>
                            <label class="flex items-center cursor-pointer hover:text-green-700">
                                <input type="radio" bind:group={modeB} value="category" class="mr-1 accent-green-600"> Ng√†nh h√†ng
                            </label>
                        </div>
                    </div>
                    
                    <div class="p-2 border-b border-gray-200 bg-white">
                        <input type="text" bind:value={searchB} class="w-full p-2 border border-gray-300 rounded text-sm focus:border-green-500 outline-none" placeholder="T√¨m ki·∫øm...">
                    </div>

                    <div class="flex-grow overflow-y-auto p-2 bg-slate-50 custom-scrollbar">
                        <div class="mb-2 px-2 flex justify-between items-center">
                            <span class="text-xs font-bold text-gray-500">{groupB.length} ƒë√£ ch·ªçn</span>
                            <button class="text-xs text-green-600 hover:underline font-medium" on:click={() => toggleAll(false, filteredListB)}>
                                {groupB.length === filteredListB.length ? 'B·ªè ch·ªçn t·∫•t c·∫£' : 'Ch·ªçn t·∫•t c·∫£'}
                            </button>
                        </div>
                        <div class="space-y-1">
                            {#each filteredListB as item}
                                <label class="flex items-center p-2 hover:bg-white rounded cursor-pointer transition-colors border border-transparent hover:border-green-200 group">
                                    <input type="checkbox" checked={groupB.includes(item)} on:change={() => groupB = toggleSelection(groupB, item)} class="mr-3 w-4 h-4 accent-green-600 rounded border-gray-300">
                                    <span class="text-sm text-gray-700 group-hover:text-green-700">{item}</span>
                                </label>
                            {/each}
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="p-4 border-t border-gray-200 bg-gray-50 flex justify-end gap-3">
            <button on:click={close} class="px-5 py-2.5 bg-white border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-100 font-medium transition-colors shadow-sm">H·ªßy</button>
            <button on:click={handleSave} class="px-6 py-2.5 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-bold shadow-md transition-colors flex items-center gap-2">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" />
                </svg>
                L∆∞u
            </button>
        </div>
    </div>
</div>
{/if}

<style>
    .custom-scrollbar::-webkit-scrollbar { width: 6px; }
    .custom-scrollbar::-webkit-scrollbar-track { background: #f1f1f1; }
    .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
    .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
</style>
--- END FILE: ./src/components/modals/AddEfficiencyColumnModal.svelte ---

--- START FILE: ./src/components/modals/AddMetricModal.svelte ---
<script>
    import { createEventDispatcher } from 'svelte';
    import { categoryStructure, macroCategoryConfig, macroProductGroupConfig } from '../../stores.js';
    import { cleanCategoryName } from '../../utils.js';

    export let isOpen = false;
    export let editItem = null; // [M·ªöI] Nh·∫≠n item c·∫ßn s·ª≠a

    const dispatch = createEventDispatcher();

    // Form data
    let label = '';
    let selectedGroups = [];
    let revenueType = 'REAL';
    let search = '';

    // Data Source
    $: allItems = [
        ...($macroCategoryConfig || []).map(m => m.name),
        ...($macroProductGroupConfig || []).map(m => m.name),
        ...[...new Set(($categoryStructure || []).map(c => cleanCategoryName(c.nganhHang)).filter(Boolean))],
        ...[...new Set(($categoryStructure || []).map(c => cleanCategoryName(c.nhomHang)).filter(Boolean))]
    ].sort();

    $: filteredList = allItems.filter(i => i.toLowerCase().includes(search.toLowerCase()));

    // [M·ªöI] Logic Reset / Load Data khi m·ªü modal
    $: if (isOpen) {
        if (editItem) {
            // Ch·∫ø ƒë·ªô S·ª≠a: Load d·ªØ li·ªáu t·ª´ item c≈©
            label = editItem.label;
            // V·ªõi ƒë∆°n gi√°, groupA v√† groupB gi·ªëng nhau, l·∫•y groupA l√† ƒë·ªß
            selectedGroups = [...(editItem.groupA || [])];
            // X√°c ƒë·ªãnh lo·∫°i doanh thu: N·∫øu typeA l√† DTQD -> CONVERTED, ng∆∞·ª£c l·∫°i REAL
            revenueType = editItem.typeA === 'DTQD' ? 'CONVERTED' : 'REAL';
            search = '';
        } else {
            // Ch·∫ø ƒë·ªô Th√™m m·ªõi: Reset tr·∫Øng
            label = '';
            selectedGroups = [];
            revenueType = 'REAL';
            search = '';
        }
    }

    function toggleItem(item) {
        if (selectedGroups.includes(item)) {
            selectedGroups = selectedGroups.filter(i => i !== item);
        } else {
            selectedGroups = [...selectedGroups, item];
        }
    }

    function handleSelectAll(isSelect) {
        selectedGroups = isSelect ? [...filteredList] : [];
    }

    function handleSave() {
        if (!label.trim()) return alert("Vui l√≤ng nh·∫≠p T√™n ƒê∆°n gi√°.");
        if (selectedGroups.length === 0) return alert("Vui l√≤ng ch·ªçn √≠t nh·∫•t 1 nh√≥m h√†ng.");

        const payload = {
            id: editItem ? editItem.id : `custom_price_${Date.now()}`, // Gi·ªØ ID c≈© n·∫øu s·ª≠a
            label: label,
            groupA: selectedGroups,
            groupB: selectedGroups,
            type: 'UNIT_PRICE',
            typeA: revenueType === 'REAL' ? 'DTTL' : 'DTQD',
            typeB: 'SL'
        };

        dispatch('save', payload);
        dispatch('close');
    }

    function close() {
        dispatch('close');
    }
</script>

{#if isOpen}
<div class="fixed inset-0 bg-gray-900 bg-opacity-60 z-[1300] flex items-center justify-center p-4 backdrop-blur-sm animate-fade-in" on:click={close} role="button" tabindex="0">
    <div class="bg-white rounded-xl shadow-2xl w-full max-w-lg flex flex-col max-h-[90vh] overflow-hidden" on:click|stopPropagation>
        
        <div class="p-5 border-b border-gray-200 flex justify-between items-center bg-gray-50">
            <div>
                <h3 class="text-lg font-bold text-gray-800 uppercase">
                    {editItem ? 'Ch·ªânh S·ª≠a ƒê∆°n Gi√°' : 'Th√™m ƒê∆°n Gi√° M·ªõi'}
                </h3>
                <p class="text-xs text-gray-500 mt-1">C√¥ng th·ª©c: T·ªïng Doanh thu / T·ªïng S·ªë l∆∞·ª£ng</p>
            </div>
            <button on:click={close} class="text-gray-400 hover:text-red-500 transition-colors text-2xl leading-none">&times;</button>
        </div>

        <div class="p-6 overflow-y-auto flex-1 bg-white custom-scrollbar">
            <div class="space-y-6">
                <div>
                    <label class="block text-sm font-bold text-gray-700 mb-2">1. ƒê·∫∑t t√™n ƒê∆°n gi√° <span class="text-red-500">*</span></label>
                    <input type="text" bind:value={label} class="w-full p-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none text-sm font-semibold" placeholder="VD: ƒêG Tivi, ƒêG Gia d·ª•ng..." autoFocus>
                </div>

                <div class="flex flex-col h-[300px] border border-gray-200 rounded-lg p-3 shadow-sm bg-gray-50">
                    <label class="block text-sm font-bold text-gray-700 mb-2">2. Ch·ªçn Nh√≥m h√†ng t√≠nh to√°n</label>
                    <div class="mb-2 relative">
                        <input type="text" bind:value={search} class="w-full p-2 pl-8 border border-gray-300 rounded text-xs focus:border-blue-500 outline-none bg-white" placeholder="T√¨m ki·∫øm nh√≥m h√†ng...">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 absolute left-2.5 top-2 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" /></svg>
                    </div>
                    <div class="flex justify-between items-center mb-2 px-1">
                        <span class="text-xs font-bold text-blue-600">ƒê√£ ch·ªçn: {selectedGroups.length}</span>
                        <div class="space-x-2">
                            <button on:click={() => handleSelectAll(true)} class="text-xs text-gray-500 hover:text-blue-600 underline">Ch·ªçn h·∫øt</button>
                            <button on:click={() => handleSelectAll(false)} class="text-xs text-gray-500 hover:text-red-600 underline">B·ªè ch·ªçn</button>
                        </div>
                    </div>
                    <div class="flex-grow overflow-y-auto custom-scrollbar bg-white border border-gray-200 rounded">
                        {#each filteredList as item}
                            <label class="flex items-center p-2 hover:bg-blue-50 cursor-pointer transition-colors border-b border-gray-100 last:border-0">
                                <input type="checkbox" checked={selectedGroups.includes(item)} on:change={() => toggleItem(item)} class="mr-3 w-4 h-4 accent-blue-600 rounded border-gray-300">
                                <span class="text-sm text-gray-700">{item}</span>
                            </label>
                        {/each}
                    </div>
                </div>

                <div class="bg-blue-50 p-4 rounded-lg border border-blue-100">
                    <label class="block text-sm font-bold text-blue-800 mb-2">3. Ch·ªçn lo·∫°i Doanh thu (T·ª≠ s·ªë)</label>
                    <div class="flex gap-6">
                        <label class="inline-flex items-center cursor-pointer">
                            <input type="radio" bind:group={revenueType} value="REAL" class="w-4 h-4 text-blue-600 border-gray-300 focus:ring-blue-500">
                            <span class="ml-2 text-sm text-gray-700 font-medium">Doanh thu Th·ª±c (DTLK)</span>
                        </label>
                        <label class="inline-flex items-center cursor-pointer">
                            <input type="radio" bind:group={revenueType} value="CONVERTED" class="w-4 h-4 text-purple-600 border-gray-300 focus:ring-purple-500">
                            <span class="ml-2 text-sm text-gray-700 font-medium">Doanh thu Quy ƒë·ªïi (DTQƒê)</span>
                        </label>
                    </div>
                </div>
            </div>
        </div>

        <div class="p-4 border-t border-gray-200 bg-gray-50 flex justify-end gap-3">
            <button on:click={close} class="px-5 py-2.5 bg-white border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-100 font-medium text-sm transition-colors shadow-sm">Hu·ª∑ b·ªè</button>
            <button on:click={handleSave} class="px-6 py-2.5 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-bold text-sm shadow-md transition-colors flex items-center gap-2">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" /></svg>
                L∆∞u ƒê∆°n Gi√°
            </button>
        </div>
    </div>
</div>
{/if}

<style>
    .custom-scrollbar::-webkit-scrollbar { width: 6px; }
    .custom-scrollbar::-webkit-scrollbar-track { background: #f1f1f1; }
    .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
    .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
    .animate-fade-in { animation: fadeIn 0.2s ease-out; }
    @keyframes fadeIn { from { opacity: 0; transform: scale(0.98); } to { opacity: 1; transform: scale(1); } }
</style>
--- END FILE: ./src/components/modals/AddMetricModal.svelte ---

--- START FILE: ./src/components/modals/AddRevenueTableModal.svelte ---
<script>
    import { createEventDispatcher } from 'svelte';
    import { categoryStructure, isAdmin } from '../../stores.js';
    import { cleanCategoryName } from '../../utils.js';

    export let isOpen = false;
    export let editItem = null; 

    const dispatch = createEventDispatcher();
    let isBackdropMouseDown = false; 

    // --- FORM DATA ---
    let title = '';
    let selectedMainCategories = [];
    let isSystemTemplate = false;
    let subColumns = [];
    
    // Metric t·ªïng cho to√†n b·∫£ng
    let tableMetrics = { sl: false, dt: true, dtqd: false };

    let searchMainCat = '';
    
    // State t√¨m ki·∫øm cho t·ª´ng dropdown c·ªôt con (Object: { index: searchText })
    let subSearchMap = {};

    // --- DATA SOURCES ---
    $: uniqueMainCategories = [...new Set(($categoryStructure || []).map(c => cleanCategoryName(c.nganhHang)).filter(Boolean))].sort();
    $: filteredMainCategories = uniqueMainCategories.filter(c => c.toLowerCase().includes(searchMainCat.toLowerCase()));

    $: availableSubGroups = [...new Set(
        ($categoryStructure || [])
            .filter(c => selectedMainCategories.includes(cleanCategoryName(c.nganhHang)))
            .map(c => cleanCategoryName(c.nhomHang))
            .filter(Boolean)
    )].sort();

    // --- INIT ---
    $: if (isOpen) {
        if (editItem) {
            title = editItem.title || '';
            selectedMainCategories = [...(editItem.mainCategories || [])];
            isSystemTemplate = !!editItem.isSystem;
            // Load metrics t·ªïng
            tableMetrics = { sl: false, dt: true, dtqd: false, ...(editItem.tableMetrics || {}) };
            
            subColumns = (editItem.subColumns || []).map(col => ({ 
                ...col, 
                id: col.id || Math.random().toString(36).substr(2, 9),
                header: col.header || '',
                items: [...(col.items || [])],
                metrics: { sl: false, dt: true, dtqd: false, ...(col.metrics || {}) },
                isDropdownOpen: false
            }));
        } else {
            resetForm();
        }
    }

    function resetForm() {
        title = '';
        selectedMainCategories = [];
        searchMainCat = '';
        subColumns = [];
        isSystemTemplate = false;
        tableMetrics = { sl: false, dt: true, dtqd: false };
        subSearchMap = {};
        addColumn(); 
    }

    // --- LOGIC ---
    function toggleMainCategory(cat) {
        if (selectedMainCategories.includes(cat)) {
            selectedMainCategories = selectedMainCategories.filter(c => c !== cat);
        } else {
            selectedMainCategories = [...selectedMainCategories, cat];
        }
    }

    function addColumn() {
        subColumns = [...subColumns, {
            id: Math.random().toString(36).substr(2, 9),
            header: '',
            items: [],
            metrics: { sl: false, dt: true, dtqd: false },
            isDropdownOpen: false 
        }];
    }

    function removeColumn(index) {
        subColumns = subColumns.filter((_, i) => i !== index);
    }

    function toggleColumnDropdown(index) {
        subColumns = subColumns.map((col, i) => {
            if (i === index) {
                // Reset search text khi m·ªü
                if (!col.isDropdownOpen) subSearchMap[index] = ''; 
                return { ...col, isDropdownOpen: !col.isDropdownOpen };
            }
            return { ...col, isDropdownOpen: false };
        });
    }

    function toggleSubItem(colIndex, item) {
        const col = subColumns[colIndex];
        if (col.items.includes(item)) {
            col.items = col.items.filter(i => i !== item);
        } else {
            col.items = [...col.items, item];
        }
        subColumns[colIndex] = col;
    }

    function handleSave() {
        if (!title.trim()) return alert("Vui l√≤ng nh·∫≠p T√™n b·∫£ng.");
        if (selectedMainCategories.length === 0) return alert("Vui l√≤ng ch·ªçn √≠t nh·∫•t 1 Ng√†nh h√†ng ch√≠nh.");
        if (subColumns.length === 0) return alert("Vui l√≤ng th√™m √≠t nh·∫•t 1 nh√≥m h√†ng.");
        
        // Validate metrics t·ªïng
        if (!tableMetrics.sl && !tableMetrics.dt && !tableMetrics.dtqd) {
             tableMetrics.dt = true; // Default fallback
        }

        for (const col of subColumns) {
            if (!col.header.trim()) return alert("Vui l√≤ng ƒë·∫∑t t√™n cho t·∫•t c·∫£ c√°c nh√≥m h√†ng.");
            if (col.items.length === 0) return alert(`Nh√≥m "${col.header}" ch∆∞a ch·ªçn th√†nh ph·∫ßn con n√†o.`);
            if (!col.metrics.sl && !col.metrics.dt && !col.metrics.dtqd) {
                return alert(`Nh√≥m "${col.header}" ch∆∞a ch·ªçn ch·ªâ s·ªë hi·ªÉn th·ªã (SL/DT/Qƒê).`);
            }
        }

        const payload = {
            id: editItem ? editItem.id : `table_${Date.now()}`,
            title,
            mainCategories: selectedMainCategories,
            tableMetrics,
            subColumns: subColumns.map(c => ({ 
                header: c.header, 
                items: c.items,
                metrics: {
                    sl: !!c.metrics.sl,
                    dt: !!c.metrics.dt,
                    dtqd: !!c.metrics.dtqd
                }
            })),
            isSystem: isSystemTemplate === true,
            isVisible: true
        };

        dispatch('save', payload);
        close();
    }

    function close() {
        dispatch('close');
    }

    function handleContentClick(e) {
        if (!e.target.closest('.sub-item-dropdown') && !e.target.closest('.sub-item-trigger')) {
            subColumns = subColumns.map(c => ({ ...c, isDropdownOpen: false }));
        }
    }

    function handleBackdropMouseDown(e) {
        if (e.target === e.currentTarget) isBackdropMouseDown = true;
    }
    function handleBackdropClick(e) {
        if (e.target === e.currentTarget && isBackdropMouseDown) close();
        isBackdropMouseDown = false;
    }
</script>

<svelte:window on:click={handleContentClick} />

{#if isOpen}
<div 
    class="fixed inset-0 bg-gray-900/60 z-[1300] flex items-center justify-center p-4 backdrop-blur-sm animate-fade-in" 
    role="button" 
    tabindex="0" 
    on:mousedown={handleBackdropMouseDown}
    on:click={handleBackdropClick}
>
    <div 
        class="bg-white rounded-xl shadow-2xl w-full max-w-6xl h-[90vh] flex flex-col overflow-hidden border border-gray-200" 
        role="button" 
        tabindex="0" 
        on:click|stopPropagation={handleContentClick}
        on:mousedown|stopPropagation={() => isBackdropMouseDown = false}
    >
        
        <div class="px-6 py-4 border-b border-gray-200 flex justify-between items-center bg-gray-50">
            <div>
                <h3 class="text-xl font-bold text-gray-800">
                    {editItem ? 'Ch·ªânh s·ª≠a B·∫£ng theo d√µi' : 'T·∫°o B·∫£ng theo d√µi m·ªõi'}
                </h3>
                <p class="text-xs text-gray-500 mt-1">Thi·∫øt k·∫ø b·∫£ng b√°o c√°o theo phong c√°ch Excel ƒëa t·∫ßng.</p>
            </div>
            <button on:click={close} class="text-gray-400 hover:text-red-500 transition-colors text-2xl leading-none p-2 rounded-full hover:bg-gray-200">&times;</button>
        </div>

        <div class="flex-grow flex flex-col md:flex-row overflow-hidden">
            
            <div class="w-full md:w-1/3 border-r border-gray-200 p-6 bg-white overflow-y-auto custom-scrollbar flex flex-col gap-6">
                <div>
                    <label class="block text-sm font-bold text-gray-700 mb-2">1. T√™n B·∫£ng <span class="text-red-500">*</span></label>
                    <input type="text" bind:value={title} class="w-full p-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none text-sm font-semibold" placeholder="VD: Gia d·ª•ng M√πa h√®...">
                </div>
                
                <div class="bg-blue-50 p-3 rounded-lg border border-blue-100">
                    <label class="block text-sm font-bold text-blue-800 mb-2">2. Ch·ªâ s·ªë T·ªîNG (Header B·∫£ng)</label>
                    <div class="flex gap-4">
                        <label class="flex items-center gap-1.5 cursor-pointer hover:bg-blue-100/50 p-1 rounded transition-colors" on:click|stopPropagation>
                            <input type="checkbox" bind:checked={tableMetrics.sl} class="w-4 h-4 rounded text-blue-600 focus:ring-blue-500">
                            <span class="text-sm text-gray-700">T·ªïng S·ªë l∆∞·ª£ng</span>
                        </label>
                        <label class="flex items-center gap-1.5 cursor-pointer hover:bg-blue-100/50 p-1 rounded transition-colors" on:click|stopPropagation>
                            <input type="checkbox" bind:checked={tableMetrics.dt} class="w-4 h-4 rounded text-green-600 focus:ring-green-500">
                            <span class="text-sm text-gray-700">T·ªïng Doanh thu</span>
                        </label>
                        <label class="flex items-center gap-1.5 cursor-pointer hover:bg-blue-100/50 p-1 rounded transition-colors" on:click|stopPropagation>
                            <input type="checkbox" bind:checked={tableMetrics.dtqd} class="w-4 h-4 rounded text-purple-600 focus:ring-purple-500">
                            <span class="text-sm text-gray-700">T·ªïng DT Quy ƒë·ªïi</span>
                        </label>
                    </div>
                </div>

                <div>
                    <label class="block text-sm font-bold text-gray-700 mb-2">3. L·ªçc ngu·ªìn (Ng√†nh h√†ng ch√≠nh)</label>
                    <div class="mb-2 relative">
                        <input type="text" bind:value={searchMainCat} placeholder="T√¨m ki·∫øm..." class="w-full p-2 pl-8 border border-gray-300 rounded text-xs focus:border-blue-500 outline-none" />
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 absolute left-2.5 top-2 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" /></svg>
                    </div>
                    <div class="h-48 border border-gray-300 rounded-lg overflow-y-auto custom-scrollbar p-2 bg-gray-50">
                        {#if filteredMainCategories.length === 0}
                            <p class="text-xs text-gray-400 italic text-center mt-4">Kh√¥ng t√¨m th·∫•y.</p>
                        {:else}
                            {#each filteredMainCategories as cat}
                                <label class="flex items-center gap-2 p-1.5 hover:bg-white rounded cursor-pointer transition-colors border-b border-gray-100 last:border-0" on:click|stopPropagation>
                                    <input type="checkbox" checked={selectedMainCategories.includes(cat)} on:change={() => toggleMainCategory(cat)} class="rounded text-blue-600 focus:ring-blue-500 border-gray-300">
                                    <span class="text-sm text-gray-600">{cat}</span>
                                </label>
                            {/each}
                        {/if}
                    </div>
                    <p class="text-xs text-gray-500 mt-1 italic">* Ch·ªçn ƒë·ªÉ l·ªçc danh s√°ch nh√≥m h√†ng con.</p>
                </div>

                {#if $isAdmin}
                    <div class="p-3 bg-purple-50 border border-purple-200 rounded-lg mt-auto">
                        <label class="flex items-center gap-2 cursor-pointer" on:click|stopPropagation>
                            <input type="checkbox" bind:checked={isSystemTemplate} class="w-4 h-4 text-purple-600 rounded focus:ring-purple-500 border-gray-300">
                            <span class="text-sm font-bold text-purple-800">L∆∞u l√†m M·∫´u h·ªá th·ªëng</span>
                        </label>
                        <p class="text-xs text-purple-600 mt-1 pl-6">B·∫£ng n√†y s·∫Ω hi·ªÉn th·ªã cho t·∫•t c·∫£ ng∆∞·ªùi d√πng.</p>
                    </div>
                {/if}
            </div>

            <div class="w-full md:w-2/3 p-6 bg-slate-50 overflow-y-auto custom-scrollbar flex flex-col">
                <div class="flex justify-between items-center mb-4">
                    <label class="text-sm font-bold text-gray-700">4. C·∫•u h√¨nh C·ªôt hi·ªÉn th·ªã & Gom nh√≥m</label>
                    <button class="text-sm bg-blue-600 text-white px-3 py-1.5 rounded-lg hover:bg-blue-700 font-medium flex items-center gap-1 shadow-sm" on:click={addColumn}>
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" /></svg>
                        Th√™m nh√≥m h√†ng
                    </button>
                </div>

                {#if selectedMainCategories.length === 0}
                    <div class="flex-grow flex items-center justify-center border-2 border-dashed border-gray-300 rounded-xl bg-white/50">
                        <div class="text-center p-6">
                            <span class="text-4xl">üëà</span>
                            <p class="text-gray-500 font-medium mt-2">Vui l√≤ng ch·ªçn "L·ªçc ngu·ªìn" b√™n tr√°i tr∆∞·ªõc.</p>
                        </div>
                    </div>
                {:else}
                    <div class="space-y-3 pb-4">
                        {#each subColumns as col, index (col.id)}
                            <div class="bg-white p-4 rounded-xl border border-gray-200 shadow-sm flex flex-col gap-3 relative group animate-fade-in-up">
                                <button class="absolute top-2 right-2 text-gray-300 hover:text-red-500 p-1 transition-colors" on:click={() => removeColumn(index)} title="X√≥a c·ªôt n√†y">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" /></svg>
                                </button>

                                <div class="grid grid-cols-1 md:grid-cols-12 gap-4 items-start">
                                    <div class="md:col-span-4">
                                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">T√™n nh√≥m hi·ªÉn th·ªã</label>
                                        <input type="text" bind:value={col.header} class="w-full p-2 border border-gray-300 rounded text-sm font-semibold focus:border-blue-500 outline-none" placeholder="VD: Camera T·ªïng">
                                    </div>

                                    <div class="md:col-span-8 relative">
                                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Th√†nh ph·∫ßn (Gom nh√≥m)</label>
                                        
                                        <div 
                                            class="w-full min-h-[38px] p-1.5 border border-gray-300 rounded bg-white cursor-pointer flex flex-wrap gap-1 items-center sub-item-trigger focus-within:ring-2 focus-within:ring-blue-100 focus-within:border-blue-400 transition-all"
                                            on:click|stopPropagation={() => toggleColumnDropdown(index)}
                                            role="button" tabindex="0"
                                        >
                                            {#if col.items.length === 0}
                                                <span class="text-gray-400 text-sm ml-1 select-none">-- Ch·ªçn nh√≥m h√†ng con --</span>
                                            {:else}
                                                {#each col.items as item}
                                                    <span class="bg-blue-50 text-blue-700 px-2 py-0.5 rounded text-xs font-medium flex items-center gap-1 border border-blue-100">
                                                        {item} <span class="cursor-pointer hover:text-blue-900 font-bold" on:click|stopPropagation={() => toggleSubItem(index, item)}>&times;</span>
                                                    </span>
                                                {/each}
                                            {/if}
                                            <div class="ml-auto pr-1 text-gray-400"><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" /></svg></div>
                                        </div>

                                        {#if col.isDropdownOpen}
                                            <div class="absolute top-full left-0 w-full mt-1 bg-white border border-gray-200 rounded-lg shadow-xl z-50 max-h-60 overflow-y-auto custom-scrollbar sub-item-dropdown animate-fade-in-fast" on:click|stopPropagation>
                                                <div class="p-2 sticky top-0 bg-white border-b border-gray-100">
                                                    <input 
                                                        type="text" 
                                                        class="w-full p-1.5 text-xs border border-gray-300 rounded focus:border-blue-500 outline-none" 
                                                        placeholder="L·ªçc danh s√°ch..."
                                                        bind:value={subSearchMap[index]}
                                                        on:click|stopPropagation
                                                        on:keydown|stopPropagation
                                                    />
                                                </div>
                                                <div class="p-1">
                                                    {#if true}
                                                        {@const currentSubSearch = subSearchMap[index] || ''}
                                                        {@const filteredSubGroups = availableSubGroups.filter(s => s.toLowerCase().includes(currentSubSearch.toLowerCase()))}
                                                        
                                                        {#if filteredSubGroups.length === 0}
                                                            <p class="text-center text-sm text-gray-400 py-4">Kh√¥ng t√¨m th·∫•y.</p>
                                                        {:else}
                                                            {#each filteredSubGroups as subGroup}
                                                                <label class="flex items-center px-3 py-2 hover:bg-blue-50 cursor-pointer rounded transition-colors border-b border-gray-50 last:border-0" on:click|stopPropagation>
                                                                    <input type="checkbox" checked={col.items.includes(subGroup)} on:change={() => toggleSubItem(index, subGroup)} class="mr-3 w-4 h-4 accent-blue-600">
                                                                    <span class="text-sm text-gray-700">{subGroup}</span>
                                                                </label>
                                                            {/each}
                                                        {/if}
                                                    {/if}
                                                </div>
                                            </div>
                                        {/if}
                                    </div>
                                </div>

                                <div class="bg-gray-50 p-2 rounded-lg border border-gray-100 flex items-center gap-4">
                                    <span class="text-xs font-bold text-gray-500 uppercase">Hi·ªÉn th·ªã:</span>
                                    <label class="flex items-center gap-1.5 cursor-pointer hover:bg-white px-2 py-1 rounded transition-colors" on:click|stopPropagation>
                                        <input type="checkbox" bind:checked={col.metrics.sl} class="w-4 h-4 rounded text-blue-600 focus:ring-blue-500">
                                        <span class="text-xs font-semibold text-gray-700">S·ªë l∆∞·ª£ng</span>
                                    </label>
                                    <label class="flex items-center gap-1.5 cursor-pointer hover:bg-white px-2 py-1 rounded transition-colors" on:click|stopPropagation>
                                        <input type="checkbox" bind:checked={col.metrics.dt} class="w-4 h-4 rounded text-green-600 focus:ring-green-500">
                                        <span class="text-xs font-semibold text-gray-700">Doanh thu</span>
                                    </label>
                                    <label class="flex items-center gap-1.5 cursor-pointer hover:bg-white px-2 py-1 rounded transition-colors" on:click|stopPropagation>
                                        <input type="checkbox" bind:checked={col.metrics.dtqd} class="w-4 h-4 rounded text-purple-600 focus:ring-purple-500">
                                        <span class="text-xs font-semibold text-gray-700">DT Quy ƒë·ªïi</span>
                                    </label>
                                </div>
                            </div>
                        {/each}
                    </div>
                {/if}
            </div>
        </div>

        <div class="p-4 border-t border-gray-200 bg-gray-50 flex justify-end gap-3">
            <button on:click={close} class="px-5 py-2.5 bg-white border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-100 font-medium text-sm transition-colors shadow-sm">H·ªßy</button>
            <button on:click={handleSave} class="px-6 py-2.5 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-bold shadow-md transition-colors flex items-center gap-2 text-sm">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" /></svg>
                L∆∞u B·∫£ng
            </button>
        </div>
    </div>
</div>
{/if}

<style>
    .custom-scrollbar::-webkit-scrollbar { width: 6px; }
    .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
    .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
    .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
    
    .animate-fade-in { animation: fadeIn 0.3s ease-out; }
    .animate-fade-in-up { animation: fadeInUp 0.3s ease-out; }
    .animate-fade-in-fast { animation: fadeIn 0.15s ease-out; }

    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    @keyframes fadeInUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
</style>
--- END FILE: ./src/components/modals/AddRevenueTableModal.svelte ---

--- START FILE: ./src/components/modals/AdminModal.svelte ---
<script>
    import { modalState, activeTab } from '../../stores.js';
    import { authService } from '../../services/auth.service.js';
    import { tick } from 'svelte';

    let password = '';
    let showError = false;
    let passwordInput;
    let isBackdropMouseDown = false; // [FIX] Bi·∫øn c·ªù ki·ªÉm tra

    // Reactive: Ki·ªÉm tra modal
    $: isOpen = $modalState.activeModal === 'admin-modal';

    // Reactive: Khi m·ªü modal, reset form v√† focus input
    $: if (isOpen) {
        resetForm();
        focusInput();
    }

    async function focusInput() {
        await tick();
        if (passwordInput) passwordInput.focus();
    }

    function resetForm() {
        password = '';
        showError = false;
    }

    function close() {
        modalState.update(s => ({ ...s, activeModal: null }));
    }

    function submit() {
        const isValid = authService.checkAdminPassword(password);
        if (isValid) {
            activeTab.set('declaration-section');
            close();
        } else {
            showError = true;
            password = '';
            focusInput();
        }
    }

    function handleKeydown(event) {
        if (event.key === 'Enter') submit();
        else if (event.key === 'Escape') close();
    }

    // [FIX] Logic x·ª≠ l√Ω click backdrop an to√†n
    function handleBackdropMouseDown(e) {
        if (e.target === e.currentTarget) {
            isBackdropMouseDown = true;
        }
    }

    function handleBackdropClick(e) {
        if (e.target === e.currentTarget && isBackdropMouseDown) {
            close();
        }
        isBackdropMouseDown = false; // Reset sau m·ªói l·∫ßn click
    }
</script>

{#if isOpen}
    <div 
        class="fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center z-[1050] transition-opacity backdrop-blur-sm"
        on:mousedown={handleBackdropMouseDown}
        on:click={handleBackdropClick}
        role="button"
        tabindex="0"
    >
        <div 
            class="bg-white p-6 rounded-xl shadow-xl w-full max-w-sm mx-4 transform transition-all scale-100"
            on:click|stopPropagation
            on:mousedown|stopPropagation={() => isBackdropMouseDown = false} 
        >
            <div class="mb-4">
                <h3 class="text-lg font-bold text-gray-900">Truy c·∫≠p khu v·ª±c Admin</h3>
            </div>
            
            <p class="text-sm text-gray-600 mb-4">
                 Vui l√≤ng nh·∫≠p m·∫≠t kh·∫©u ƒë·ªÉ xem v√† ch·ªânh s·ª≠a ph·∫ßn Khai b√°o.
            </p>

            <div class="mb-6">
                <input 
                    bind:this={passwordInput}
                    type="password" 
                    class="w-full p-2.5 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition-colors 
                           {showError ? 'border-red-500 bg-red-50' : 'border-gray-300'}" 
                    placeholder="Nh·∫≠p m·∫≠t kh·∫©u..."
                    bind:value={password}
                    on:keydown={handleKeydown}
                >
                {#if showError}
                    <p class="text-red-500 text-sm mt-2 animate-pulse flex items-center">
                         <span class="mr-1">üö´</span> M·∫≠t kh·∫©u kh√¥ng ƒë√∫ng. Vui l√≤ng th·ª≠ l·∫°i.
                    </p>
                {/if}
            </div>

            <div class="flex justify-end space-x-3 border-t pt-4">
                <button 
                    class="px-4 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 transition-colors font-medium text-sm"
                    on:click={close}
                >
                    H·ªßy
                </button>
                <button 
                    class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors font-bold text-sm shadow-sm"
                    on:click={submit}
                >
                    X√°c nh·∫≠n
                </button>
            </div>
        </div>
    </div>
{/if}
--- END FILE: ./src/components/modals/AdminModal.svelte ---

--- START FILE: ./src/components/modals/ComposerModal.svelte ---
<script>
  import { onMount, tick } from 'svelte';
  import { 
    modalState, 
    composerTemplates, 
    danhSachNhanVien, 
    ycxData, 
    realtimeYCXData, 
    luykeGoalSettings, 
    realtimeGoalSettings, 
    selectedWarehouse, 
    masterReportData,
    competitionData,
    globalCompetitionConfigs,
    localCompetitionConfigs,
    notificationStore
  } from '../../stores.js';
  
  import { composerService } from '../../services/composerService.js';
  import { reportService } from '../../services/reportService.js';
  
  // [S·ª¨A L·ªñI]: Import t·ª´ services thay v√¨ modules
  import { settingsService } from '../../services/settings.service.js';
  
  import { cleanCategoryName } from '../../utils.js';

  // --- C·∫§U H√åNH TAB ---
  const CONFIG = {
      luyke: {
          label: 'S·ª©c kh·ªèe Si√™u th·ªã (L≈©y k·∫ø)',
          subTabs: [
              { id: 'subtab-luyke-sieu-thi', label: 'Si√™u th·ªã L≈©y k·∫ø' },
              { id: 'subtab-luyke-thi-dua', label: 'Thi ƒëua L≈©y k·∫ø' },
              { id: 'subtab-luyke-thidua-vung', label: 'Thi ƒêua V√πng TNB' }
          ]
      },
      sknv: {
          label: 'S·ª©c kh·ªèe Nh√¢n vi√™n',
          subTabs: [
              { id: 'subtab-sknv', label: 'SKNV' },
              { id: 'subtab-doanhthu', label: 'Doanh thu LK' },
              { id: 'subtab-thunhap', label: 'Thu nh·∫≠p' },
              { id: 'subtab-hieuqua', label: 'Hi·ªáu qu·∫£ NV LK' },
              { id: 'subtab-nganhhang', label: 'DT ng√†nh h√†ng' },
              { id: 'subtab-thidua', label: 'Thi ƒëua NV LK' }
          ]
      },
      realtime: {
          label: 'Doanh thu Realtime',
          subTabs: [
              { id: 'subtab-realtime-sieu-thi', label: 'Si√™u th·ªã Realtime' },
              { id: 'subtab-realtime-nhan-vien', label: 'DT NV Realtime' },
              { id: 'subtab-realtime-hieu-qua-nhan-vien', label: 'Hi·ªáu qu·∫£ NV Realtime' },
              { id: 'subtab-realtime-nganh-hang', label: 'Ng√†nh h√†ng Realtime' },
              { id: 'subtab-realtime-hang-ban', label: 'DT H√£ng Realtime' },
              { id: 'subtab-realtime-thi-dua', label: 'Thi ƒëua NV Realtime' }
          ]
      }
  };

  // --- STATE ---
  $: isOpen = $modalState.activeModal === 'composer-modal';
  $: context = $modalState.context || 'luyke'; 
  
  let activeSubTabId = '';
  let activeTagTab = 'general'; 
  let editorContent = '';
  let textareaEl;
  
  // Filter Ranking
  let rankingDept = 'ALL';
  $: uniqueDepartments = [...new Set($danhSachNhanVien.map(nv => nv.boPhan).filter(Boolean))].sort();

  // Computed Data cho Tags
  let supermarketReport = {};
  let rankingReportData = [];
  let compData = [];
  let currentGoals = {};

  // --- LOGIC ---

  // 1. Kh·ªüi t·∫°o khi m·ªü Modal
  $: if (isOpen && context) {
      initializeData();
  }

  async function initializeData() {
      if (!activeSubTabId && CONFIG[context]) {
          activeSubTabId = CONFIG[context].subTabs[0].id;
      }
      
      if ($composerTemplates[context] && $composerTemplates[context][activeSubTabId]) {
          editorContent = $composerTemplates[context][activeSubTabId];
      } else {
          editorContent = '';
      }

      await calculateReportData();
  }

  // 2. T√≠nh to√°n d·ªØ li·ªáu n·ªÅn
  async function calculateReportData() {
      const warehouse = $selectedWarehouse;
      let sourceData = [];
      let isRealtime = false;

      if (context === 'realtime') {
          sourceData = $realtimeYCXData;
          const settings = settingsService.getRealtimeGoalSettings(warehouse);
          currentGoals = settings.goals || {};
          isRealtime = true;
      } else {
          sourceData = $ycxData;
          const settings = settingsService.getLuykeGoalSettings(warehouse);
          currentGoals = settings.goals || {};
      }

      const masterReport = reportService.generateMasterReportData(sourceData, currentGoals, isRealtime);
      
      if (warehouse) {
          rankingReportData = masterReport.filter(nv => nv.maKho == warehouse);
      } else {
          rankingReportData = masterReport;
      }

      supermarketReport = reportService.aggregateReport(rankingReportData, warehouse);
      
      if (context === 'luyke' || context === 'sknv') {
          compData = $competitionData; 
      } else {
           compData = []; 
      }
  }

  // 3. Chuy·ªÉn ƒë·ªïi Subtab
  function switchSubTab(tabId) {
      if (activeSubTabId) {
          updateTemplateStore(activeSubTabId, editorContent);
      }
      
      activeSubTabId = tabId;
      editorContent = $composerTemplates[context]?.[tabId] || '';
  }

  function updateTemplateStore(tabId, content) {
      composerTemplates.update(s => {
          if (!s[context]) s[context] = {};
          s[context][tabId] = content;
          return s;
      });
      localStorage.setItem('composerTemplates', JSON.stringify($composerTemplates));
  }

  // 4. Ch√®n Tag
  function insertTag(tag, isTemplate = false) {
      if (!textareaEl) return;
      
      let textToInsert = tag;
      if (isTemplate) {
          textToInsert = tag.replace('{dept}', rankingDept);
      }

      const start = textareaEl.selectionStart;
      const end = textareaEl.selectionEnd;
      const value = textareaEl.value;

      editorContent = value.substring(0, start) + textToInsert + value.substring(end);
      
      tick().then(() => {
          const newCursorPos = start + textToInsert.length;
          textareaEl.selectionStart = newCursorPos;
          textareaEl.selectionEnd = newCursorPos;
          textareaEl.focus();
      });
  }

  // 5. X·ª≠ l√Ω Save & Preview
  function handleSave() {
      updateTemplateStore(activeSubTabId, editorContent);
      notificationStore.show('ƒê√£ l∆∞u m·∫´u nh·∫≠n x√©t!', 'success');
  }

  function handlePreviewAndCopy() {
      if (!editorContent.trim()) {
          notificationStore.show('N·ªôi dung tr·ªëng.', 'error');
          return;
      }

      const processedText = composerService.processComposerTemplate(
          editorContent,
          supermarketReport,
          currentGoals,
          rankingReportData,
          compData,
          context
      );

      navigator.clipboard.writeText(processedText).then(() => {
          notificationStore.show('ƒê√£ sao ch√©p n·ªôi dung (ƒë√£ x·ª≠ l√Ω) v√†o b·ªô nh·ªõ t·∫°m!', 'success');
      }).catch(err => {
          console.error(err);
          notificationStore.show('L·ªói khi sao ch√©p.', 'error');
      });
  }

  function close() {
      modalState.update(s => ({ ...s, activeModal: null }));
  }
</script>

{#if isOpen}
    <div class="fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center z-[1100] backdrop-blur-sm" on:click={close} role="button" tabindex="0">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-5xl mx-4 flex flex-col h-[90vh]" on:click|stopPropagation>
            
            <div class="p-4 border-b border-gray-200 flex justify-between items-center bg-slate-50 rounded-t-xl">
                <div>
                    <h3 class="text-lg font-bold text-slate-800 flex items-center gap-2">
                        <i data-feather="pen-tool" class="w-5 h-5 text-indigo-600"></i>
                        Tr√¨nh t·∫°o Nh·∫≠n x√©t - {CONFIG[context]?.label}
                    </h3>
                </div>
                <button class="text-gray-400 hover:text-red-500" on:click={close}>
                    <i data-feather="x" class="w-6 h-6"></i>
                </button>
            </div>

            <div class="flex-grow flex flex-col md:flex-row overflow-hidden">
                
                <div class="flex-1 flex flex-col border-r border-gray-200 p-4">
                    <div class="flex space-x-2 overflow-x-auto mb-3 pb-2 border-b border-gray-100">
                        {#each CONFIG[context]?.subTabs || [] as tab}
                            <button 
                                class="px-3 py-1.5 text-xs font-medium rounded-md transition-colors whitespace-nowrap
                                       {activeSubTabId === tab.id ? 'bg-indigo-100 text-indigo-700' : 'bg-gray-100 text-gray-600 hover:bg-gray-200'}"
                                on:click={() => switchSubTab(tab.id)}
                            >
                                {tab.label}
                            </button>
                        {/each}
                    </div>

                    <textarea 
                        bind:this={textareaEl}
                        bind:value={editorContent}
                        class="flex-grow w-full p-4 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 outline-none resize-none font-mono text-sm leading-relaxed"
                        placeholder="So·∫°n th·∫£o n·ªôi dung t·∫°i ƒë√¢y... S·ª≠ d·ª•ng c√°c th·∫ª b√™n ph·∫£i ƒë·ªÉ ch√®n d·ªØ li·ªáu t·ª± ƒë·ªông."
                    ></textarea>

                    <div class="mt-4 flex justify-between items-center">
                        <button on:click={handleSave} class="px-4 py-2 bg-green-600 text-white rounded-lg font-medium hover:bg-green-700 flex items-center gap-2 text-sm">
                            <i data-feather="save" class="w-4 h-4"></i> L∆∞u m·∫´u n√†y
                        </button>
                        <button on:click={handlePreviewAndCopy} class="px-6 py-2 bg-blue-600 text-white rounded-lg font-bold hover:bg-blue-700 flex items-center gap-2 shadow-md">
                            <i data-feather="copy" class="w-4 h-4"></i> X·ª≠ l√Ω & Sao ch√©p
                        </button>
                    </div>
                </div>

                <div class="w-full md:w-80 bg-slate-50 flex flex-col border-l border-gray-200">
                    <div class="flex border-b border-gray-200 bg-white">
                        {#each ['general', 'kpi', 'ranking', 'details'] as tab}
                            <button 
                                class="flex-1 py-3 text-xs font-bold uppercase tracking-wide text-center hover:bg-slate-50 transition-colors border-b-2 
                                       {activeTagTab === tab ? 'border-indigo-600 text-indigo-600' : 'border-transparent text-gray-500'}"
                                on:click={() => activeTagTab = tab}
                            >
                                {tab}
                            </button>
                        {/each}
                    </div>

                    <div class="flex-grow overflow-y-auto p-4 custom-scrollbar">
                        
                        {#if activeTagTab === 'general'}
                            <div class="space-y-4">
                                <div>
                                    <h5 class="text-xs font-bold text-gray-500 uppercase mb-2">Chung</h5>
                                    <div class="flex flex-wrap gap-2">
                                        <button class="tag-btn" on:click={() => insertTag('[NGAY]')}>Ng√†y</button>
                                        <button class="tag-btn" on:click={() => insertTag('[GIO]')}>Gi·ªù</button>
                                    </div>
                                </div>
                                <div>
                                    <h5 class="text-xs font-bold text-gray-500 uppercase mb-2">Bi·ªÉu t∆∞·ª£ng</h5>
                                    <div class="grid grid-cols-5 gap-2">
                                        {#each ['üìä','üí∞','üí•','üéØ','üìà','üì¶','‚ö†Ô∏è','üî•','‚úÖ','üöÄ'] as icon}
                                            <button class="icon-btn" on:click={() => insertTag(icon)}>{icon}</button>
                                        {/each}
                                    </div>
                                </div>
                            </div>

                        {:else if activeTagTab === 'kpi'}
                            <div class="space-y-4">
                                <h5 class="text-xs font-bold text-gray-500 uppercase mb-2">KPIs Ch√≠nh</h5>
                                <div class="flex flex-col gap-2">
                                    <button class="tag-btn w-full text-left" on:click={() => insertTag('[DT_THUC]')}>Doanh thu Th·ª±c</button>
                                    <button class="tag-btn w-full text-left" on:click={() => insertTag('[DTQD]')}>Doanh thu Quy ƒë·ªïi</button>
                                    <button class="tag-btn w-full text-left" on:click={() => insertTag('[%HT_DTT]')}>% HT DT Th·ª±c</button>
                                    <button class="tag-btn w-full text-left" on:click={() => insertTag('[%HT_DTQD]')}>% HT DT Qƒê</button>
                                    <button class="tag-btn w-full text-left" on:click={() => insertTag('[TLQD]')}>T·ª∑ l·ªá Quy ƒë·ªïi</button>
                                    <button class="tag-btn w-full text-left" on:click={() => insertTag('[DT_CHUAXUAT]')}>DT Ch∆∞a xu·∫•t</button>
                                    <button class="tag-btn w-full text-left" on:click={() => insertTag('[SS_CUNGKY]')}>So s√°nh C√πng k·ª≥</button>
                                </div>
                            </div>

                        {:else if activeTagTab === 'ranking'}
                            <div class="space-y-4">
                                <div>
                                    <label for="composer-dept" class="text-xs font-bold text-gray-500 uppercase mb-1 block">L·ªçc B·ªô ph·∫≠n:</label>
                                    <select id="composer-dept" class="w-full p-2 text-sm border rounded bg-white" bind:value={rankingDept}>
                                        <option value="ALL">To√†n si√™u th·ªã</option>
                                        {#each uniqueDepartments as dept}
                                            <option value={dept}>{dept}</option>
                                        {/each}
                                    </select>
                                </div>
                                
                                <div>
                                    <h5 class="text-xs font-bold text-gray-500 uppercase mb-2">X·∫øp h·∫°ng (Top/Bot 3)</h5>
                                    <div class="grid grid-cols-2 gap-2">
                                        <button class="tag-btn" on:click={() => insertTag('[TOP3_DTQD_{dept}@msnv]', true)}>Top 3 DTQƒê</button>
                                        <button class="tag-btn" on:click={() => insertTag('[BOT3_DTQD_{dept}@msnv]', true)}>Bot 3 DTQƒê</button>
                                        <button class="tag-btn" on:click={() => insertTag('[TOP3_THUNHAP_{dept}@msnv]', true)}>Top 3 Thu nh·∫≠p</button>
                                        <button class="tag-btn" on:click={() => insertTag('[BOT3_THUNHAP_{dept}@msnv]', true)}>Bot 3 Thu nh·∫≠p</button>
                                        <button class="tag-btn" on:click={() => insertTag('[TOP3_TLQD_{dept}@msnv]', true)}>Top 3 %Qƒê</button>
                                        <button class="tag-btn" on:click={() => insertTag('[BOT3_TLQD_{dept}@msnv]', true)}>Bot 3 %Qƒê</button>
                                    </div>
                                </div>

                                <div>
                                    <h5 class="text-xs font-bold text-gray-500 uppercase mb-2">D∆∞·ªõi M·ª•c ti√™u (List)</h5>
                                    <div class="flex flex-wrap gap-2">
                                        <button class="tag-btn" on:click={() => insertTag('[BOT_TARGET_TLQD_{dept}@msnv]', true)}>% Quy ƒë·ªïi</button>
                                        <button class="tag-btn" on:click={() => insertTag('[BOT_TARGET_TLTC_{dept}@msnv]', true)}>% Tr·∫£ ch·∫≠m</button>
                                        <button class="tag-btn" on:click={() => insertTag('[BOT_TARGET_PK_{dept}@msnv]', true)}>% Ph·ª• ki·ªán</button>
                                        <button class="tag-btn" on:click={() => insertTag('[BOT_TARGET_GD_{dept}@msnv]', true)}>% Gia d·ª•ng</button>
                                    </div>
                                </div>
                            </div>

                        {:else if activeTagTab === 'details'}
                            <div class="space-y-4">
                                <div>
                                    <h5 class="text-xs font-bold text-gray-500 uppercase mb-2">Thi ƒëua (L≈©y k·∫ø)</h5>
                                    <div class="grid grid-cols-2 gap-2">
                                        <button class="tag-btn" on:click={() => insertTag('[TD_TONG_CT]')}>T·ªïng CT</button>
                                        <button class="tag-btn" on:click={() => insertTag('[TD_CT_DAT]')}>S·ªë ƒë·∫°t</button>
                                        <button class="tag-btn" on:click={() => insertTag('[TD_CT_CHUADAT]')}>S·ªë ch∆∞a ƒë·∫°t</button>
                                        <button class="tag-btn" on:click={() => insertTag('[TD_TYLE_DAT]')}>% ƒê·∫°t</button>
                                    </div>
                                </div>

                                <div>
                                    <h5 class="text-xs font-bold text-gray-500 uppercase mb-2">Nh√≥m QƒêC (C√≥ s·ªë)</h5>
                                    <button class="tag-btn w-full mb-2 text-indigo-700 bg-indigo-50" on:click={() => insertTag('[TOP_QDC_INFO]')}>
                                        Ch√®n Top QƒêC (SL & TB/Ng√†y)
                                    </button>
                                    <div class="flex flex-wrap gap-2">
                                        {#if supermarketReport.qdc}
                                            {#each Object.values(supermarketReport.qdc).filter(i=>i.sl>0).sort((a,b)=>b.dtqd-a.dtqd) as item}
                                                <button class="tag-btn text-xs" on:click={() => insertTag(`[QDC_INFO_${item.name}]`)}>{item.name}</button>
                                            {/each}
                                        {/if}
                                    </div>
                                </div>

                                <div>
                                    <h5 class="text-xs font-bold text-gray-500 uppercase mb-2">Ng√†nh h√†ng (C√≥ s·ªë)</h5>
                                    <button class="tag-btn w-full mb-2 text-indigo-700 bg-indigo-50" on:click={() => insertTag('[TOP_NGANHHANG_SL]')}>
                                        Ch√®n Top SL Ng√†nh h√†ng
                                    </button>
                                    <div class="flex flex-wrap gap-2">
                                        {#if supermarketReport.nganhHangChiTiet}
                                            {#each Object.values(supermarketReport.nganhHangChiTiet).filter(i=>i.quantity>0).sort((a,b)=>b.revenue-a.revenue).slice(0, 10) as item}
                                                <button class="tag-btn text-xs" on:click={() => insertTag(`[NH_INFO_${cleanCategoryName(item.name)}]`)}>{cleanCategoryName(item.name)}</button>
                                            {/each}
                                        {/if}
                                    </div>
                                </div>
                            </div>
                        {/if}
                    </div>
                </div>
            </div>
        </div>
    </div>
{/if}

<style>
    .tag-btn {
        background-color: #eef2ff;
        color: #4338ca;
        border: 1px solid #c7d2fe;
        padding: 0.25rem 0.5rem;
        border-radius: 0.375rem;
        font-size: 0.75rem;
        font-weight: 500;
        transition: all 0.2s;
    }
    .tag-btn:hover {
        background-color: #e0e7ff;
        border-color: #818cf8;
    }
    .icon-btn {
        background-color: white;
        border: 1px solid #e5e7eb;
        border-radius: 0.375rem;
        padding: 0.5rem;
        font-size: 1.25rem;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s;
    }
    .icon-btn:hover {
        background-color: #f9fafb;
        border-color: #d1d5db;
        transform: scale(1.1);
    }
    .custom-scrollbar::-webkit-scrollbar { width: 4px; }
    .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
    .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 2px; }
</style>
--- END FILE: ./src/components/modals/ComposerModal.svelte ---

--- START FILE: ./src/components/modals/CustomerDetailModal.svelte ---
<script>
    import { modalState } from '../../stores.js';
    import { formatters } from '../../utils/formatters.js';

    // L·∫•y d·ªØ li·ªáu t·ª´ store modalState
    $: isOpen = $modalState.activeModal === 'customer-detail-modal';
    $: customerData = $modalState.payload?.customers || [];
    $: mucTieu = $modalState.payload?.mucTieu || {};

    $: conversionRateTarget = (mucTieu?.phanTramQD || 0) / 100;

    function close() {
        modalState.update(s => ({ ...s, activeModal: null, payload: null }));
    }

    // S·∫Øp x·∫øp local trong modal
    let sortKey = 'totalRealRevenue';
    let sortDirection = 'desc';

    function handleSort(key) {
        if (sortKey === key) {
            sortDirection = sortDirection === 'desc' ? 'asc' : 'desc';
        } else {
            sortKey = key;
            sortDirection = 'desc';
        }
    }

    $: sortedCustomers = [...customerData].sort((a, b) => {
        let valA = a[sortKey];
        let valB = b[sortKey];
        return sortDirection === 'desc' ? valB - valA : valA - valB;
    });
</script>

{#if isOpen}
    <div class="fixed inset-0 bg-gray-900/50 z-[1200] flex items-center justify-center backdrop-blur-sm" on:click={close} role="button" tabindex="0">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-3xl mx-4 flex flex-col max-h-[90vh]" on:click|stopPropagation>
            
            <div class="p-4 border-b flex justify-between items-center bg-blue-50 rounded-t-xl">
                <h3 class="text-lg font-bold text-blue-900">Chi ti·∫øt ƒê∆°n h√†ng theo Kh√°ch h√†ng</h3>
                <button class="text-gray-500 hover:text-gray-800 text-2xl leading-none" on:click={close}>&times;</button>
            </div>

            <div class="p-3 bg-gray-50 border-b flex gap-2 items-center">
                <span class="text-xs font-bold text-gray-500 uppercase">S·∫Øp x·∫øp:</span>
                <button 
                    class="px-3 py-1 rounded-full text-xs font-medium border transition-colors {sortKey === 'totalRealRevenue' ? 'bg-blue-600 text-white' : 'bg-white text-gray-600 hover:bg-gray-100'}"
                    on:click={() => handleSort('totalRealRevenue')}
                >
                    Doanh thu {sortKey === 'totalRealRevenue' ? (sortDirection === 'desc' ? '‚Üì' : '‚Üë') : ''}
                </button>
                <button 
                    class="px-3 py-1 rounded-full text-xs font-medium border transition-colors {sortKey === 'conversionRate' ? 'bg-blue-600 text-white' : 'bg-white text-gray-600 hover:bg-gray-100'}"
                    on:click={() => handleSort('conversionRate')}
                >
                    % Quy ƒë·ªïi {sortKey === 'conversionRate' ? (sortDirection === 'desc' ? '‚Üì' : '‚Üë') : ''}
                </button>
            </div>

            <div class="overflow-y-auto p-4 space-y-3 bg-slate-50/30 flex-grow">
                {#if sortedCustomers.length === 0}
                    <p class="text-center text-gray-500 py-8">Kh√¥ng c√≥ d·ªØ li·ªáu.</p>
                {:else}
                    {#each sortedCustomers as customer, index}
                        <details class="bg-white rounded-lg shadow-sm border border-gray-200 group">
                            <summary class="flex flex-wrap items-center gap-3 p-3 cursor-pointer list-none select-none hover:bg-gray-50 transition-colors">
                                <div class="flex items-center gap-2 flex-grow min-w-[200px]">
                                    <span class="text-xs font-bold text-gray-400 w-5">{index + 1}.</span>
                                    <span class="text-sm font-semibold text-blue-700">{customer.name}</span>
                                </div>
                                
                                <div class="flex items-center gap-3 text-xs text-gray-600">
                                    <span>SL: <strong>{customer.totalQuantity}</strong></span>
                                    <span>DT: <strong>{formatters.formatRevenue(customer.totalRealRevenue, 1)}</strong></span>
                                    <span>DTQƒê: <strong class="text-blue-600">{formatters.formatRevenue(customer.totalConvertedRevenue, 1)}</strong></span>
                                    <span class="font-bold {customer.conversionRate >= conversionRateTarget ? 'text-green-600' : 'text-red-600'}">
                                        {formatters.formatPercentage(customer.conversionRate)}
                                    </span>
                                </div>
                                <span class="text-gray-400 transform group-open:rotate-180 transition-transform ml-auto">‚ñº</span>
                            </summary>
                            
                            <div class="p-3 border-t border-gray-100 bg-slate-50/50 text-xs">
                                <table class="w-full">
                                    <tbody>
                                        {#each customer.products as p}
                                            <tr class="border-b last:border-0 border-gray-200/50">
                                                <td class="py-1.5 pr-2 text-gray-700">{p.productName}</td>
                                                <td class="py-1.5 px-2 text-right whitespace-nowrap">SL: <strong>{p.quantity}</strong></td>
                                                <td class="py-1.5 px-2 text-right whitespace-nowrap">DT: <strong>{formatters.formatRevenue(p.realRevenue, 1)}</strong></td>
                                                <td class="py-1.5 pl-2 text-right whitespace-nowrap">Qƒê: <strong class="text-blue-600">{formatters.formatRevenue(p.convertedRevenue, 1)}</strong></td>
                                            </tr>
                                        {/each}
                                    </tbody>
                                </table>
                            </div>
                        </details>
                    {/each}
                {/if}
            </div>

            <div class="p-4 border-t bg-white rounded-b-xl flex justify-end">
                <button class="px-4 py-2 bg-gray-100 hover:bg-gray-200 text-gray-700 rounded-lg text-sm font-medium" on:click={close}>ƒê√≥ng</button>
            </div>
        </div>
    </div>
{/if}
--- END FILE: ./src/components/modals/CustomerDetailModal.svelte ---

--- START FILE: ./src/components/modals/LoginModal.svelte ---
<script>
    import { modalState } from '../../stores.js';
    import { authService } from '../../services/auth.service.js';
    // [FIX] X√≥a import ui t·ª´ ui.js (file ƒë√£ b·ªã x√≥a)
    // import { ui } from '../../ui.js'; 
    
    // State n·ªôi b·ªô
    let email = '';
    let errorMsg = '';
    let isSubmitting = false;

    // Reactive: Ki·ªÉm tra modal c√≥ ƒëang m·ªü kh√¥ng
    $: isOpen = $modalState.activeModal === 'login-modal';

    function close() {
        modalState.update(s => ({ ...s, activeModal: null }));
    }

    async function handleSubmit() {
        errorMsg = '';
        isSubmitting = true;

        try {
            const success = await authService.loginUser(email);
            
            if (success) {
                // [FIX] D√πng alert t·∫°m th·ªùi thay v√¨ ui.showNotification
                // V√¨ modal login ch·ªâ hi·ªán 1 l·∫ßn ƒë·∫ßu, alert l√† ch·∫•p nh·∫≠n ƒë∆∞·ª£c
                // alert(`Ch√†o m·ª´ng ${email}!`); 
                close();
            } else {
                errorMsg = 'Vui l√≤ng nh·∫≠p m·ªôt ƒë·ªãa ch·ªâ email h·ª£p l·ªá.';
            }
        } catch (e) {
            console.error(e);
            errorMsg = 'C√≥ l·ªói x·∫£y ra. Vui l√≤ng th·ª≠ l·∫°i.';
        } finally {
            isSubmitting = false;
        }
    }

    function handleKeydown(event) {
        if (event.key === 'Enter') {
            handleSubmit();
        }
    }
</script>

{#if isOpen}
    <div 
        class="fixed inset-0 bg-gray-900 bg-opacity-60 z-[1100] flex items-center justify-center cursor-not-allowed backdrop-blur-sm"
    >
        <div 
            class="bg-white p-6 rounded-xl shadow-2xl w-full max-w-[420px] mx-4 transform transition-all scale-100 cursor-default"
            on:click|stopPropagation
        >
            <div class="mb-6 border-b border-gray-100 pb-4">
                <h3 class="text-xl font-bold text-gray-800">Ch√†o m·ª´ng ƒë·∫øn v·ªõi C√¥ng c·ª• Ph√¢n t√≠ch</h3>
            </div>
            
            <div class="space-y-4">
                <p class="text-gray-600 text-sm leading-relaxed">
                    Vui l√≤ng nh·∫≠p email c·ªßa b·∫°n ƒë·ªÉ b·∫Øt ƒë·∫ßu s·ª≠ d·ª•ng. Email n√†y s·∫Ω ƒë∆∞·ª£c d√πng ƒë·ªÉ ƒë·ªãnh danh v√† ƒë·ªìng b·ªô d·ªØ li·ªáu trong t∆∞∆°ng lai.
                </p>
                
                <div>
                    <label for="login-email-input" class="block text-sm font-medium text-gray-700 mb-1">Email c·ªßa b·∫°n</label>
                    <input 
                        type="email" 
                        id="login-email-input" 
                        class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition-colors
                               {errorMsg ? 'border-red-500 bg-red-50' : 'border-gray-300'}"
                        placeholder="your.email@example.com"
                        bind:value={email}
                        on:keydown={handleKeydown}
                        disabled={isSubmitting}
                    >
                    {#if errorMsg}
                        <p class="text-red-500 text-sm mt-2 flex items-center animate-pulse">
                            <span class="mr-1">‚ö†Ô∏è</span> {errorMsg}
                        </p>
                    {/if}
                </div>

                <button 
                    id="login-submit-btn" 
                    class="w-full bg-blue-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-blue-700 transition-colors shadow-md disabled:opacity-70 disabled:cursor-not-allowed"
                    on:click={handleSubmit}
                    disabled={isSubmitting}
                >
                    {isSubmitting ? 'ƒêang x·ª≠ l√Ω...' : 'X√°c nh·∫≠n & Ti·∫øp t·ª•c'}
                </button>
            </div>
        </div>
    </div>
{/if}
--- END FILE: ./src/components/modals/LoginModal.svelte ---

--- START FILE: ./src/components/modals/UnexportedDetailModal.svelte ---
<script>
    import { modalState } from '../../stores.js';
    import { formatters } from '../../utils/formatters.js';

    $: isOpen = $modalState.activeModal === 'unexported-detail-modal';
    $: unexportedDetails = $modalState.payload?.unexportedDetails || [];

    function close() {
        modalState.update(s => ({ ...s, activeModal: null, payload: null }));
    }
</script>

{#if isOpen}
    <div class="fixed inset-0 bg-gray-900/50 z-[1200] flex items-center justify-center backdrop-blur-sm" on:click={close} role="button" tabindex="0">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-2xl mx-4 flex flex-col max-h-[90vh]" on:click|stopPropagation>
            
            <div class="p-4 border-b flex justify-between items-center bg-yellow-50 rounded-t-xl">
                <h3 class="text-lg font-bold text-yellow-800">Chi ti·∫øt Doanh thu Ch∆∞a xu·∫•t</h3>
                <button class="text-gray-500 hover:text-gray-800 text-2xl leading-none" on:click={close}>&times;</button>
            </div>

            <div class="overflow-y-auto p-4 space-y-3 bg-slate-50/30 flex-grow">
                {#if unexportedDetails.length === 0}
                    <p class="text-center text-gray-500 py-8">Kh√¥ng c√≥ ƒë∆°n h√†ng n√†o ch∆∞a xu·∫•t.</p>
                {:else}
                    {#each unexportedDetails as group, index}
                        <details class="bg-white rounded-lg shadow-sm border border-gray-200 group">
                            <summary class="flex justify-between items-center p-3 cursor-pointer list-none select-none hover:bg-gray-50 transition-colors">
                                <div class="flex items-center gap-2">
                                    <span class="font-bold text-gray-500 text-sm">{index + 1}.</span>
                                    <span class="font-semibold text-gray-800 text-sm">{group.name}</span>
                                </div>
                                
                                <div class="flex items-center gap-3 text-xs text-gray-600">
                                    <span>SL: <strong>{group.totalSL}</strong></span>
                                    <span>DTQƒê: <strong class="text-blue-600">{formatters.formatRevenue(group.totalDTQD, 1)}</strong></span>
                                </div>
                                <span class="text-gray-400 transform group-open:rotate-180 transition-transform ml-2">‚ñº</span>
                            </summary>
                            
                            <div class="p-3 border-t border-gray-100 bg-slate-50/50 text-xs">
                                <table class="w-full">
                                    <tbody>
                                        {#each group.products as p}
                                            <tr class="border-b last:border-0 border-gray-200/50">
                                                <td class="py-1.5 pr-2 text-gray-700">{p.name}</td>
                                                <td class="py-1.5 px-2 text-right whitespace-nowrap">SL: <strong>{p.sl}</strong></td>
                                                <td class="py-1.5 pl-2 text-right whitespace-nowrap">DTQƒê: <strong class="text-blue-600">{formatters.formatRevenue(p.dtqd, 1)}</strong></td>
                                            </tr>
                                        {/each}
                                    </tbody>
                                </table>
                            </div>
                        </details>
                    {/each}
                {/if}
            </div>

            <div class="p-4 border-t bg-white rounded-b-xl flex justify-end">
                <button class="px-4 py-2 bg-gray-100 hover:bg-gray-200 text-gray-700 rounded-lg text-sm font-medium" on:click={close}>ƒê√≥ng</button>
            </div>
        </div>
    </div>
{/if}
--- END FILE: ./src/components/modals/UnexportedDetailModal.svelte ---

--- START FILE: ./src/components/modals/UserCompetitionModal.svelte ---
<script>
    import { 
        modalState, 
        localCompetitionConfigs, // [QUAN TR·ªåNG] D√πng bi·∫øn local thay v√¨ global
        categoryStructure,
        brandList,
        selectedWarehouse
    } from '../../stores.js';
    import { datasyncService } from '../../services/datasync.service.js';

    $: isOpen = $modalState.activeModal === 'user-competition-modal';

    // --- STATE VIEW ---
    let currentView = 'menu'; 
    let editingIndex = -1;
    let isLoading = false;
    
    // Form data chu·∫©n thi·∫øt k·∫ø c≈©
    let formData = { 
        id: '', name: '', groups: [], brands: [], 
        type: 'doanhthu', minPrice: '', maxPrice: '', excludeApple: false 
    };

    // Search
    let searchGroup = '';
    let searchBrand = '';

    // Data Sources
    $: availableGroups = [...new Set(($categoryStructure || []).map(c => c.nhomHang).filter(Boolean))].sort();
    $: filteredGroups = availableGroups.filter(g => g.toLowerCase().includes(searchGroup.toLowerCase()));
    
    $: availableBrands = $brandList || [];
    $: filteredBrands = availableBrands.filter(b => b.toLowerCase().includes(searchBrand.toLowerCase()));

    // Reset khi m·ªü modal
    $: if (isOpen) {
        if ($selectedWarehouse) {
            currentView = 'menu';
        }
    }

    function close() {
        modalState.update(s => ({ ...s, activeModal: null }));
        resetForm();
        currentView = 'menu';
    }

    // --- NAVIGATION ---
    function goToSpecialProgram() {
        modalState.update(s => ({ ...s, activeModal: 'user-special-program-modal' }));
    }

    function goToBrandCompetition() {
        // N·∫øu ch∆∞a c√≥ ch∆∞∆°ng tr√¨nh n√†o, v√†o th·∫≥ng form t·∫°o m·ªõi
        if ($localCompetitionConfigs.length === 0) {
            openAddForm();
        } else {
            currentView = 'list';
        }
    }

    function backToMenu() { currentView = 'menu'; }
    function backToList() { currentView = 'list'; resetForm(); }

    // --- LOGIC FORM ---
    function resetForm() {
        formData = { 
            id: '', name: '', groups: [], brands: [], 
            type: 'doanhthu', minPrice: '', maxPrice: '', excludeApple: false 
        };
        editingIndex = -1;
        searchGroup = ''; searchBrand = '';
    }

    function openAddForm() { 
        resetForm(); 
        currentView = 'form';
    }

    function openEditForm(index) {
        // [FIX] L·∫•y t·ª´ localCompetitionConfigs
        const config = $localCompetitionConfigs[index];
        if (!config) return;
        
        editingIndex = index;
        formData = {
            id: config.id,
            name: config.name,
            groups: [...(config.groups || [])],
            brands: [...(config.brands || [])],
            type: config.type || 'doanhthu',
            minPrice: config.minPrice ? config.minPrice / 1000000 : '', 
            maxPrice: config.maxPrice ? config.maxPrice / 1000000 : '',
            excludeApple: config.excludeApple || false
        };
        currentView = 'form';
    }

    function toggleSelection(list, item) {
        return list.includes(item) ? list.filter(i => i !== item) : [...list, item];
    }

    async function saveProgram() {
        if (!$selectedWarehouse) return alert("Vui l√≤ng ch·ªçn Kho tr∆∞·ªõc!");
        if (!formData.name) return alert("Vui l√≤ng nh·∫≠p t√™n ch∆∞∆°ng tr√¨nh!");
        if (formData.brands.length === 0) return alert("Vui l√≤ng ch·ªçn √≠t nh·∫•t m·ªôt H√£ng!");
        
        isLoading = true;
        
        const configToSave = {
            id: formData.id || `comp_${Date.now()}`,
            name: formData.name,
            groups: formData.groups,
            brands: formData.brands,
            type: formData.type,
            minPrice: formData.minPrice ? parseFloat(formData.minPrice) * 1000000 : 0,
            maxPrice: formData.maxPrice ? parseFloat(formData.maxPrice) * 1000000 : 0,
            excludeApple: formData.excludeApple,
            target: 0
        };

        // [FIX] C·∫≠p nh·∫≠t v√†o localCompetitionConfigs
        let newConfigs = [...$localCompetitionConfigs];
        if (editingIndex >= 0) newConfigs[editingIndex] = configToSave;
        else newConfigs.push(configToSave);

        localCompetitionConfigs.set(newConfigs); // Update Store UI ngay l·∫≠p t·ª©c

        try {
            // [FIX] L∆∞u v√†o Document c·ªßa Kho (WarehouseData) thay v√¨ Global Declarations
            await datasyncService.saveCompetitionConfigs($selectedWarehouse, newConfigs);
            if (currentView === 'form') backToList();
        } catch (error) {
            console.error(error);
            alert(`L·ªói l∆∞u: ${error.message}`);
        } finally { 
            isLoading = false;
        }
    }

    async function deleteProgram(index) {
        if (!confirm("X√≥a ch∆∞∆°ng tr√¨nh n√†y?")) return;
        
        // [FIX] X√≥a t·ª´ localCompetitionConfigs
        let newConfigs = [...$localCompetitionConfigs];
        newConfigs.splice(index, 1);
        localCompetitionConfigs.set(newConfigs);
        
        try {
            await datasyncService.saveCompetitionConfigs($selectedWarehouse, newConfigs);
        } catch(e) { console.error(e); }
    }
</script>

{#if isOpen}
    <div class="fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center z-[1100] backdrop-blur-sm" on:click={close} role="button" tabindex="0">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-2xl mx-4 flex flex-col max-h-[90vh]" on:click|stopPropagation>
            
            <div class="p-5 border-b border-gray-200 flex justify-between items-center bg-blue-50 rounded-t-xl">
                <div>
                    <h3 class="text-lg font-bold text-blue-800 flex items-center gap-2">
                        <i data-feather="award"></i> 
                        {#if currentView === 'menu'}
                            T·∫°o ch∆∞∆°ng tr√¨nh thi ƒëua
                        {:else if currentView === 'list'}
                            Danh s√°ch Thi ƒëua (H√£ng)
                        {:else}
                            {editingIndex >= 0 ? 'S·ª≠a ch∆∞∆°ng tr√¨nh' : 'Th√™m ch∆∞∆°ng tr√¨nh m·ªõi'}
                        {/if}
                    </h3>
                    {#if $selectedWarehouse}
                        <p class="text-xs text-blue-600 mt-1">Kho ƒëang ch·ªçn: <span class="font-bold">{$selectedWarehouse}</span></p>
                    {/if}
                </div>
                <button class="text-gray-500 hover:text-red-500 text-2xl leading-none" on:click={close}>&times;</button>
            </div>
            
            <div class="p-6 overflow-y-auto bg-slate-50/30 flex-grow">
                {#if !$selectedWarehouse}
                    <div class="p-8 text-center bg-yellow-50 border border-yellow-200 rounded-lg">
                        <p class="text-yellow-700 font-semibold">Vui l√≤ng ch·ªçn Kho ·ªü tab "C·∫≠p nh·∫≠t d·ªØ li·ªáu" tr∆∞·ªõc.</p>
                    </div>

                {:else if currentView === 'menu'}
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-4">
                        <button 
                            class="flex flex-col items-center justify-center p-8 bg-white border-2 border-blue-100 rounded-xl shadow-sm hover:shadow-md hover:border-blue-500 hover:bg-blue-50 transition group"
                            on:click={goToBrandCompetition}
                        >
                            <div class="p-4 bg-blue-100 rounded-full text-blue-600 mb-4 group-hover:scale-110 transition-transform">
                                <i data-feather="briefcase" class="w-8 h-8"></i>
                            </div>
                            <h4 class="text-lg font-bold text-gray-800 group-hover:text-blue-700">Thi ƒëua theo H√£ng</h4>
                            <p class="text-sm text-gray-500 text-center mt-2">T·∫°o thi ƒëua d·ª±a tr√™n doanh s·ªë c·ªßa c√°c H√£ng (Apple, Samsung...).</p>
                        </button>

                        <button 
                            class="flex flex-col items-center justify-center p-8 bg-white border-2 border-purple-100 rounded-xl shadow-sm hover:shadow-md hover:border-purple-500 hover:bg-purple-50 transition group"
                            on:click={goToSpecialProgram}
                        >
                            <div class="p-4 bg-purple-100 rounded-full text-purple-600 mb-4 group-hover:scale-110 transition-transform">
                                <i data-feather="star" class="w-8 h-8"></i>
                            </div>
                            <h4 class="text-lg font-bold text-gray-800 group-hover:text-purple-700">Thi ƒëua ƒê·∫∑c Quy·ªÅn</h4>
                            <p class="text-sm text-gray-500 text-center mt-2">Theo d√µi c√°c s·∫£n ph·∫©m tr·ªçng t√¢m (SPƒêQ) ƒë∆∞·ª£c ch·ªâ ƒë·ªãnh ri√™ng.</p>
                        </button>
                    </div>

                {:else if currentView === 'list'}
                    <div class="mb-4">
                        <button on:click={backToMenu} class="text-sm text-gray-500 hover:text-blue-600 flex items-center gap-1 mb-4">
                            <i data-feather="arrow-left" class="w-4 h-4"></i> Quay l·∫°i ch·ªçn lo·∫°i
                        </button>
                    </div>

                    <div class="space-y-3">
                        {#if $localCompetitionConfigs.length === 0}
                            <div class="text-center py-8 bg-gray-50 rounded-lg border-2 border-dashed border-gray-200">
                                <p class="text-gray-500 mb-2">Ch∆∞a c√≥ ch∆∞∆°ng tr√¨nh n√†o.</p>
                                <button on:click={openAddForm} class="text-blue-600 font-bold hover:underline">+ T·∫°o m·ªõi ngay</button>
                            </div>
                        {:else}
                            {#each $localCompetitionConfigs as config, index}
                                <div class="flex justify-between items-start p-4 bg-white rounded-lg border border-gray-200 shadow-sm hover:shadow-md transition group/item">
                                    <div>
                                        <div class="flex items-center gap-2">
                                            <h4 class="font-bold text-gray-800 text-base">{config.name}</h4>
                                            <span class="text-[10px] uppercase px-2 py-0.5 rounded-full font-bold border {config.type === 'doanhthu' ? 'bg-blue-50 text-blue-700 border-blue-100' : 'bg-yellow-50 text-yellow-700 border-yellow-100'}">
                                                {config.type === 'doanhthu' ? 'Doanh thu' : 'S·ªë l∆∞·ª£ng'}
                                            </span>
                                        </div>
                                        <div class="text-xs text-gray-500 mt-1.5 flex flex-wrap gap-y-1 gap-x-4">
                                            <span><strong>H√£ng:</strong> {config.brands.join(', ')}</span>
                                            {#if config.groups.length > 0}
                                                <span><strong>Nh√≥m:</strong> {config.groups.join(', ')}</span>
                                            {/if}
                                            {#if config.excludeApple}
                                                <span class="text-red-500 font-medium">No Apple</span>
                                            {/if}
                                        </div>
                                    </div>
                                    <div class="flex gap-2">
                                        <button on:click={() => openEditForm(index)} class="p-2 text-blue-600 hover:bg-blue-50 rounded"><i data-feather="edit-2" class="w-4 h-4"></i></button>
                                        <button on:click={() => deleteProgram(index)} class="p-2 text-red-600 hover:bg-red-50 rounded"><i data-feather="trash-2" class="w-4 h-4"></i></button>
                                    </div>
                                </div>
                            {/each}
                             <button on:click={openAddForm} class="w-full py-3 mt-2 border-2 border-dashed border-blue-200 text-blue-600 rounded-lg font-semibold hover:bg-blue-50 transition flex justify-center items-center gap-2">
                                <i data-feather="plus-circle" class="w-4 h-4"></i> Th√™m ch∆∞∆°ng tr√¨nh m·ªõi
                            </button>
                        {/if}
                    </div>

                {:else if currentView === 'form'}
                    <div class="bg-white p-5 rounded-lg border border-blue-100 shadow-sm">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="font-bold text-lg text-slate-700">{editingIndex >= 0 ? 'Ch·ªânh s·ª≠a' : 'Th√™m m·ªõi'}</h3>
                            <button on:click={backToList} class="text-sm text-gray-500 hover:underline">H·ªßy b·ªè</button>
                        </div>
                        
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-bold text-slate-700 mb-1">T√™n ch∆∞∆°ng tr√¨nh</label>
                                <input type="text" bind:value={formData.name} class="w-full p-2 border rounded-md focus:ring-2 focus:ring-blue-500 outline-none" placeholder="VD: Thi ƒëua Tivi Sony...">
                            </div>

                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-bold text-slate-700 mb-1">H√£ng s·∫£n xu·∫•t <span class="text-red-500">*</span></label>
                                    <input type="text" bind:value={searchBrand} class="w-full mb-2 p-2 border rounded text-xs" placeholder="üîç T√¨m h√£ng..." />
                                    <div class="h-40 overflow-y-auto p-2 border rounded bg-slate-50 grid grid-cols-1 gap-1 custom-scrollbar">
                                        {#each filteredBrands as brand}
                                            <label class="flex items-center space-x-2 text-xs cursor-pointer hover:bg-white p-1 rounded border border-transparent hover:border-gray-200">
                                                <input type="checkbox" checked={formData.brands.includes(brand)} on:change={() => formData.brands = toggleSelection(formData.brands, brand)} class="rounded text-blue-600 focus:ring-blue-500 border-slate-300">
                                                <span class="text-slate-700 truncate" title={brand}>{brand}</span>
                                            </label>
                                        {/each}
                                    </div>
                                </div>
                                <div>
                                    <label class="block text-sm font-bold text-slate-700 mb-1">Nh√≥m h√†ng (T√πy ch·ªçn)</label>
                                    <input type="text" bind:value={searchGroup} class="w-full mb-2 p-2 border rounded text-xs" placeholder="üîç T√¨m nh√≥m h√†ng..." />
                                    <div class="h-40 overflow-y-auto p-2 border rounded bg-slate-50 grid grid-cols-1 gap-1 custom-scrollbar">
                                        {#each filteredGroups as group}
                                            <label class="flex items-center space-x-2 text-xs cursor-pointer hover:bg-white p-1 rounded border border-transparent hover:border-gray-200">
                                                <input type="checkbox" checked={formData.groups.includes(group)} on:change={() => formData.groups = toggleSelection(formData.groups, group)} class="rounded text-blue-600 focus:ring-blue-500 border-slate-300">
                                                <span class="text-slate-700 truncate" title={group}>{group}</span>
                                            </label>
                                        {/each}
                                    </div>
                                </div>
                            </div>
                            
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-3 bg-slate-50 p-3 rounded border border-slate-200">
                                <div>
                                    <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Lo·∫°i ƒëo l∆∞·ªùng</label>
                                    <select bind:value={formData.type} class="w-full p-2 border border-slate-300 rounded-md text-sm bg-white">
                                        <option value="doanhthu">Theo Doanh thu</option>
                                        <option value="soluong">Theo S·ªë l∆∞·ª£ng</option>
                                    </select>
                                </div>
                                {#if formData.type === 'soluong'}
                                    <div>
                                        <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Gi√° t·ª´ (Tr)</label>
                                        <input type="number" bind:value={formData.minPrice} class="w-full p-2 border border-slate-300 rounded-md text-sm" placeholder="VD: 3">
                                    </div>
                                    <div>
                                        <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Gi√° ƒë·∫øn (Tr)</label>
                                        <input type="number" bind:value={formData.maxPrice} class="w-full p-2 border border-slate-300 rounded-md text-sm" placeholder="VD: 10">
                                    </div>
                                {/if}
                            </div>

                            <div class="flex items-center gap-2 pt-2">
                                <input type="checkbox" id="exclude-apple" bind:checked={formData.excludeApple} class="rounded text-blue-600 focus:ring-blue-500 border-slate-300 w-4 h-4">
                                <label for="exclude-apple" class="text-sm text-slate-700 cursor-pointer select-none">Tr·ª´ h√£ng Apple kh·ªèi d·ªØ li·ªáu so s√°nh</label>
                            </div>

                            <div class="flex justify-end gap-3 pt-4 border-t mt-4">
                                <button on:click={backToList} class="px-4 py-2 text-gray-600 bg-white border rounded hover:bg-gray-50">H·ªßy</button>
                                <button on:click={saveProgram} class="px-4 py-2 bg-blue-600 text-white font-bold rounded hover:bg-blue-700 disabled:opacity-50" disabled={isLoading}>{isLoading ? 'ƒêang l∆∞u...' : 'L∆∞u'}</button>
                            </div>
                        </div>
                    </div>
                {/if}
            </div>
        </div>
    </div>
{/if}
--- END FILE: ./src/components/modals/UserCompetitionModal.svelte ---

--- START FILE: ./src/components/modals/UserSpecialProgramModal.svelte ---
<script>
    import { 
        modalState, 
        globalSpecialPrograms, 
        categoryStructure,
        selectedWarehouse
    } from '../../stores.js';
    import { datasyncService } from '../../services/datasync.service.js';

    $: isOpen = $modalState.activeModal === 'user-special-program-modal';

    let isFormOpen = false;
    let editingIndex = -1;
    let isLoading = false;
    
    let formData = { id: '', name: '', groups: [] };
    let searchGroup = '';

    // L·∫•y danh s√°ch nh√≥m h√†ng t·ª´ c·∫•u tr√∫c ng√†nh h√†ng
    $: availableGroups = [...new Set(($categoryStructure || []).map(c => c.nhomHang).filter(Boolean))].sort();
    $: filteredGroups = availableGroups.filter(g => g.toLowerCase().includes(searchGroup.toLowerCase()));

    // Khi m·ªü modal, t·∫£i d·ªØ li·ªáu c·ªßa kho hi·ªán t·∫°i
    $: if (isOpen && $selectedWarehouse) {
        loadConfigs();
    }

    // Logic t·∫£i t·ª´ Cloud (Hi·ªán t·∫°i ƒëang gi·∫£ l·∫≠p d√πng bi·∫øn global, th·ª±c t·∫ø s·∫Ω t·∫£i t·ª´ datasyncService)
    async function loadConfigs() {
        // T·∫°m th·ªùi d√πng store globalSpecialPrograms ƒë√£ ƒë∆∞·ª£c load ·ªü main.js
        // V·ªÅ sau s·∫Ω g·ªçi datasyncService.loadSpecialPrograms($selectedWarehouse)
    }

    function close() {
        modalState.update(s => ({ ...s, activeModal: null }));
        closeForm();
    }

    function resetForm() {
        formData = { id: '', name: '', groups: [] };
        editingIndex = -1;
        searchGroup = '';
    }

    function openAddForm() { resetForm(); isFormOpen = true; }

    function openEditForm(index) {
        const config = $globalSpecialPrograms[index];
        editingIndex = index;
        formData = {
            id: config.id,
            name: config.name,
            groups: [...(config.groups || [])]
        };
        isFormOpen = true;
    }

    function closeForm() { isFormOpen = false; resetForm(); }

    function toggleSelection(list, item) {
        return list.includes(item) ? list.filter(i => i !== item) : [...list, item];
    }

    async function saveProgram() {
        if (!$selectedWarehouse) return alert("Vui l√≤ng ch·ªçn Kho ·ªü tab C·∫≠p nh·∫≠t d·ªØ li·ªáu tr∆∞·ªõc!");
        if (!formData.name) return alert("Vui l√≤ng nh·∫≠p t√™n ch∆∞∆°ng tr√¨nh!");
        if (formData.groups.length === 0) return alert("Vui l√≤ng ch·ªçn √≠t nh·∫•t m·ªôt Nh√≥m h√†ng!");

        isLoading = true;
        const configToSave = {
            id: formData.id || `sp_${Date.now()}`,
            name: formData.name,
            groups: formData.groups
        };

        let newConfigs = [...$globalSpecialPrograms];
        if (editingIndex >= 0) newConfigs[editingIndex] = configToSave;
        else newConfigs.push(configToSave);

        // C·∫≠p nh·∫≠t Store
        globalSpecialPrograms.set(newConfigs);

        try {
            // L∆∞u l√™n Cloud th√¥ng qua Service c·ªßa Kho
            // (Gi·∫£ ƒë·ªãnh datasyncService ƒë√£ c√≥ h√†m n√†y ho·∫∑c d√πng chung c∆° ch·∫ø l∆∞u)
            // ·ªû b∆∞·ªõc tr∆∞·ªõc t√¥i ƒë√£ h∆∞·ªõng d·∫´n th√™m saveSpecialPrograms v√†o datasync.service.js
            await datasyncService.saveSpecialPrograms($selectedWarehouse, newConfigs); 
            closeForm();
        } catch (error) {
            console.error(error);
            alert(`L·ªói l∆∞u Cloud: ${error.message}`);
        } finally { isLoading = false; }
    }

    async function deleteProgram(index) {
        if (!confirm("X√≥a ch∆∞∆°ng tr√¨nh n√†y?")) return;
        let newConfigs = [...$globalSpecialPrograms];
        newConfigs.splice(index, 1);
        globalSpecialPrograms.set(newConfigs);
        
        try {
            await datasyncService.saveSpecialPrograms($selectedWarehouse, newConfigs); 
        } catch(e) { console.error(e); }
    }
</script>

{#if isOpen}
    <div class="fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center z-[1100] backdrop-blur-sm" on:click={close} role="button" tabindex="0">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-2xl mx-4 flex flex-col max-h-[90vh]" on:click|stopPropagation>
            <div class="p-5 border-b border-gray-200 flex justify-between items-center bg-purple-50 rounded-t-xl">
                <div>
                    <h3 class="text-lg font-bold text-purple-800 flex items-center gap-2">
                        <i data-feather="star"></i> Qu·∫£n l√Ω SP ƒê·∫∑c Quy·ªÅn (User)
                    </h3>
                    <p class="text-xs text-purple-600 mt-1">D·ªØ li·ªáu ƒë·ªìng b·ªô cho kho: <span class="font-bold">{$selectedWarehouse || '(Ch∆∞a ch·ªçn kho)'}</span></p>
                </div>
                <button class="text-gray-500 hover:text-red-500 text-2xl leading-none" on:click={close}>&times;</button>
            </div>
            
            <div class="p-6 overflow-y-auto">
                {#if !$selectedWarehouse}
                    <div class="p-8 text-center bg-yellow-50 border border-yellow-200 rounded-lg">
                        <p class="text-yellow-700 font-semibold">Vui l√≤ng ch·ªçn Kho ·ªü tab "C·∫≠p nh·∫≠t d·ªØ li·ªáu" ƒë·ªÉ s·ª≠ d·ª•ng t√≠nh nƒÉng n√†y.</p>
                    </div>
                {:else if !isFormOpen}
                    <div class="space-y-3">
                        {#if $globalSpecialPrograms.length === 0}
                            <div class="text-center py-8 bg-gray-50 rounded-lg border-2 border-dashed border-gray-200">
                                <p class="text-gray-500 mb-2">Ch∆∞a c√≥ ch∆∞∆°ng tr√¨nh SPƒêQ n√†o.</p>
                                <button on:click={openAddForm} class="text-purple-600 font-bold hover:underline">+ T·∫°o ch∆∞∆°ng tr√¨nh ƒë·∫ßu ti√™n</button>
                            </div>
                        {:else}
                            {#each $globalSpecialPrograms as config, index}
                                <div class="flex justify-between items-start p-4 bg-white rounded-lg border border-gray-200 shadow-sm hover:shadow-md transition">
                                    <div>
                                        <h4 class="font-bold text-gray-800 text-lg">{config.name}</h4>
                                        <div class="text-sm text-gray-600 mt-1">
                                            <p><strong>Nh√≥m h√†ng:</strong> {config.groups.join(', ')}</p>
                                        </div>
                                    </div>
                                    <div class="flex gap-2">
                                        <button on:click={() => openEditForm(index)} class="p-2 text-blue-600 hover:bg-blue-50 rounded"><i data-feather="edit-2" class="w-4 h-4"></i></button>
                                        <button on:click={() => deleteProgram(index)} class="p-2 text-red-600 hover:bg-red-50 rounded"><i data-feather="trash-2" class="w-4 h-4"></i></button>
                                    </div>
                                </div>
                            {/each}
                             <button on:click={openAddForm} class="w-full py-3 mt-2 border-2 border-dashed border-purple-200 text-purple-600 rounded-lg font-semibold hover:bg-purple-50 transition flex justify-center items-center gap-2">
                                <i data-feather="plus-circle" class="w-4 h-4"></i> Th√™m ch∆∞∆°ng tr√¨nh SPƒêQ
                            </button>
                        {/if}
                    </div>
                {:else}
                    <div class="bg-slate-50 p-5 rounded-lg border border-slate-200">
                        <h3 class="font-bold text-lg mb-4 text-slate-700">{editingIndex >= 0 ? 'Ch·ªânh s·ª≠a' : 'Th√™m m·ªõi'}</h3>
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-bold text-slate-700 mb-1">T√™n ch∆∞∆°ng tr√¨nh</label>
                                <input type="text" bind:value={formData.name} class="w-full p-2 border rounded-md focus:ring-2 focus:ring-purple-500 outline-none" placeholder="VD: Tivi ƒê·∫∑c Quy·ªÅn...">
                            </div>
                            <div>
                                <label class="block text-sm font-bold text-slate-700 mb-2">Ch·ªçn Nh√≥m h√†ng</label>
                                <input type="text" bind:value={searchGroup} class="w-full mb-2 p-2 border rounded text-xs" placeholder="üîç T√¨m nh√≥m h√†ng..." />
                                <div class="h-48 overflow-y-auto p-2 border rounded bg-white grid grid-cols-1 gap-1 custom-scrollbar">
                                    {#each filteredGroups as group}
                                        <label class="flex items-center space-x-2 text-xs cursor-pointer hover:bg-gray-50 p-1 rounded"><input type="checkbox" checked={formData.groups.includes(group)} on:change={() => formData.groups = toggleSelection(formData.groups, group)} class="rounded text-purple-600 focus:ring-purple-500 border-slate-300"><span>{group}</span></label>
                                    {/each}
                                </div>
                            </div>
                            <div class="flex justify-end gap-3 pt-4">
                                <button on:click={closeForm} class="px-4 py-2 text-gray-600 bg-white border rounded hover:bg-gray-50">H·ªßy</button>
                                <button on:click={saveProgram} class="px-4 py-2 bg-purple-600 text-white font-bold rounded hover:bg-purple-700 disabled:opacity-50" disabled={isLoading}>{isLoading ? 'ƒêang l∆∞u...' : 'L∆∞u'}</button>
                            </div>
                        </div>
                    </div>
                {/if}
            </div>
        </div>
    </div>
{/if}
--- END FILE: ./src/components/modals/UserSpecialProgramModal.svelte ---

--- START FILE: ./src/components/realtime/RealtimeSection.svelte ---
<script>
  import { onMount } from 'svelte';
  
  // [FIX] S·ª≠a 'import * as dataService' th√†nh 'import { dataService }'
  import { dataService } from '../../services/dataService.js';
  
  import { warehouseList, modalState, selectedWarehouse } from '../../stores.js';
  import { actionService } from '../../services/action.service.js';

  import SummaryTab from './summary/SummaryTab.svelte';
  import EmployeeTab from './employee/EmployeeTab.svelte';
  import EfficiencyTab from './efficiency/EfficiencyTab.svelte';
  import CategoryTab from './category/CategoryTab.svelte';
  import BrandTab from './brand/BrandTab.svelte';
  import CompetitionTab from './competition/CompetitionTab.svelte';

  export let activeTab;
  let activeSubTabId = 'subtab-realtime-sieu-thi'; 
  
  function handleSubTabClick(event) {
      const button = event.currentTarget;
      activeSubTabId = button.dataset.target;
  }

  function handleWarehouseChange(event) {
      selectedWarehouse.set(event.target.value);
  }

  async function handleFileUpload(event) {
    // B√¢y gi·ªù h√†m n√†y s·∫Ω ho·∫°t ƒë·ªông ƒë√∫ng
    await dataService.handleRealtimeFileInput(event);
  }

  // === ACTIONS ===
  function handleCompose() {
    modalState.update(s => ({ ...s, activeModal: 'composer-modal', context: 'realtime' }));
  }
  function handleExport() {
    actionService.handleExport('realtime');
  }
  function handleCapture() {
    actionService.handleCapture('realtime');
  }

  $: if (activeTab === 'realtime-section') {
    Promise.resolve().then(() => {
      if (typeof window.feather !== 'undefined') window.feather.replace();
    });
  }
</script>

<section id="realtime-section" class="page-section {activeTab === 'realtime-section' ? '' : 'hidden'}">
    
    <div class="content-card mb-6 !p-0">
        <div class="modern-page-header flex flex-wrap justify-between items-center">
            
            <div class="title-wrapper flex items-center gap-4 flex-wrap">
                <i data-feather="trending-up" class="main-icon hidden sm:block"></i>
                
                <div class="flex items-center gap-2">
                    <h2 class="page-title text-xl sm:text-2xl font-bold text-blue-800">Doanh Thu Realtime</h2>
                    <button class="page-header__help-btn" data-help-id="realtime" title="Xem h∆∞·ªõng d·∫´n">
                        <i data-feather="help-circle"></i>
                    </button>
                </div>

                <div class="flex items-center gap-2 pl-4 border-l-2 border-blue-100 ml-2">
                    <label for="realtime-filter-warehouse" class="text-sm font-semibold text-gray-600 whitespace-nowrap">Kho:</label>
                     <select 
                       id="realtime-filter-warehouse" 
                       class="p-2 border rounded-lg text-sm shadow-sm bg-white border-blue-200 text-blue-700 font-bold min-w-[120px] focus:ring-2 focus:ring-blue-500 outline-none cursor-pointer hover:bg-blue-50 transition"
                       value={$selectedWarehouse}
                       on:change={handleWarehouseChange}
                     >
                       <option value="">-- To√†n b·ªô --</option>
                       {#each $warehouseList as kho}
                          <option value={kho}>{kho}</option>
                       {/each}
                    </select>
                </div>
            </div>

            <div class="flex flex-wrap items-center gap-3 ml-auto mt-2 sm:mt-0">
                
                <div class="flex items-center gap-2 pr-4 border-r border-blue-100">
                    <a href="https://report.mwgroup.vn/home/dashboard/077" target="_blank" class="text-blue-600 hover:text-blue-800 hover:underline text-xs font-medium flex items-center gap-1 bg-blue-50 px-2 py-1.5 rounded transition-colors">
                        <i data-feather="external-link" class="w-3 h-3"></i> L·∫•y file
                    </a>
                    <label for="realtime-file-input" class="cursor-pointer bg-white text-blue-700 px-3 py-1.5 rounded-lg hover:bg-blue-50 transition text-sm font-bold flex items-center gap-2 shadow-sm border border-blue-200">
                         <i data-feather="upload" class="w-4 h-4"></i>
                        <span>T·∫£i file</span>
                    </label>
                    <input 
                        type="file" 
                        id="realtime-file-input" 
                        class="hidden" 
                        accept=".xlsx, .xls, .csv"
                        on:change={handleFileUpload}
                    >
                </div>

                <div class="flex items-center gap-2">
                     <button id="compose-realtime-notification-btn" class="action-btn action-btn--composer" title="Nh·∫≠n x√©t" on:click={handleCompose}>
                        <i data-feather="pen-tool" class="w-4 h-4"></i>
                        <span class="hidden lg:inline">Nh·∫≠n x√©t</span>
                     </button>
                    <button id="export-realtime-btn" class="action-btn action-btn--export" title="Xu·∫•t Excel" on:click={handleExport}>
                         <i data-feather="download" class="w-4 h-4"></i>
                        <span class="hidden lg:inline">Xu·∫•t Excel</span>
                    </button>
                    <button id="capture-realtime-btn" class="action-btn action-btn--capture" title="Ch·ª•p ·∫£nh" on:click={handleCapture}>
                        <i data-feather="camera" class="w-4 h-4"></i>
                        <span class="hidden lg:inline">Ch·ª•p</span>
                     </button>
                </div>
            </div>
        </div>

        <div class="content-card__body p-4">
            <div class="mb-6 overflow-x-auto pb-2">
                <nav id="realtime-subtabs-nav" class="flex space-x-2 border-b border-gray-100 pb-1 w-full min-w-max" aria-label="Tabs">
                    <button 
                        class="sub-tab-btn {activeSubTabId === 'subtab-realtime-sieu-thi' ? 'active' : ''}" 
                        data-target="subtab-realtime-sieu-thi"
                        data-title="SieuThiRealtime"
                        on:click={handleSubTabClick}
                    >
                        <i data-feather="zap"></i>
                        <span>Si√™u th·ªã Realtime</span>
                    </button>
                       
                    <button 
                        class="sub-tab-btn {activeSubTabId === 'subtab-realtime-nhan-vien' ? 'active' : ''}" 
                        data-target="subtab-realtime-nhan-vien"
                        data-title="DTNVRealtime"
                        on:click={handleSubTabClick}
                    >
                        <i data-feather="pie-chart"></i>
                        <span>DT NV Realtime</span>
                    </button>

                    <button 
                        class="sub-tab-btn {activeSubTabId === 'subtab-realtime-hieu-qua-nhan-vien' ? 'active' : ''}" 
                        data-target="subtab-realtime-hieu-qua-nhan-vien"
                        data-title="HieuQuaKhaiThacRealtime"
                        on:click={handleSubTabClick}
                    >
                        <i data-feather="bar-chart-2"></i>
                        <span>Hi·ªáu qu·∫£ NV Realtime</span>
                    </button>

                      <button 
                        class="sub-tab-btn {activeSubTabId === 'subtab-realtime-nganh-hang' ? 'active' : ''}" 
                        data-target="subtab-realtime-nganh-hang"
                        data-title="NganhHangRealtime"
                        on:click={handleSubTabClick}
                    >
                        <i data-feather="layers"></i>
                        <span>Ng√†nh h√†ng Realtime</span>
                    </button>

                    <button 
                        class="sub-tab-btn {activeSubTabId === 'subtab-realtime-hang-ban' ? 'active' : ''}" 
                        data-target="subtab-realtime-hang-ban"
                        data-title="HangRealtime"
                        on:click={handleSubTabClick}
                    >
                        <i data-feather="tag"></i>
                        <span>DT H√£ng Realtime</span>
                    </button>

                    <button 
                        class="sub-tab-btn {activeSubTabId === 'subtab-realtime-thi-dua' ? 'active' : ''}" 
                        data-target="subtab-realtime-thi-dua"
                        data-title="ThiDuaNhanVienRealtime"
                        on:click={handleSubTabClick}
                    >
                        <i data-feather="award"></i>
                        <span>Thi ƒëua NV Realtime</span>
                    </button>
                </nav>
            </div>

            <div id="realtime-subtabs-content">
                {#if activeSubTabId === 'subtab-realtime-sieu-thi'}
                    <div id="subtab-realtime-sieu-thi" class="sub-tab-content">
                        <SummaryTab {selectedWarehouse} />
                    </div>
                
                {:else if activeSubTabId === 'subtab-realtime-nhan-vien'}
                    <div id="subtab-realtime-nhan-vien" class="sub-tab-content" data-capture-preset="large-font-report">
                        <EmployeeTab {selectedWarehouse} />
                    </div>
                    
                {:else if activeSubTabId === 'subtab-realtime-hieu-qua-nhan-vien'}
                    <div id="subtab-realtime-hieu-qua-nhan-vien" class="sub-tab-content" data-capture-preset="landscape-table">
                        <EfficiencyTab {selectedWarehouse} />
                    </div>

                {:else if activeSubTabId === 'subtab-realtime-nganh-hang'}
                    <div id="subtab-realtime-nganh-hang" class="sub-tab-content" data-capture-preset="mobile-portrait">
                        <CategoryTab {selectedWarehouse} />
                    </div>

                {:else if activeSubTabId === 'subtab-realtime-hang-ban'}
                    <div id="subtab-realtime-hang-ban" class="sub-tab-content">
                        <BrandTab {selectedWarehouse} />
                    </div>

                {:else if activeSubTabId === 'subtab-realtime-thi-dua'}
                    <div id="subtab-realtime-thi-dua" class="sub-tab-content">
                        <CompetitionTab {selectedWarehouse} />
                    </div>
                    
                {:else}
                    <div class="p-12 text-center bg-gray-50 rounded-lg border border-dashed border-gray-300">
                        <p class="text-gray-500 font-medium">Ch·ª©c nƒÉng tab <strong>{activeSubTabId}</strong> ƒëang ƒë∆∞·ª£c ph√°t tri·ªÉn.</p>
                    </div>
                {/if}
            </div>
        </div>
    </div>

</section>
--- END FILE: ./src/components/realtime/RealtimeSection.svelte ---

--- START FILE: ./src/services/data/cacheHandler.js ---
import { get } from 'svelte/store';
import { danhSachNhanVien, competitionData, pastedThiDuaReportData, thuongERPData, thuongERPDataThangTruoc } from '../../stores.js';
import { storage } from '../storage.service.js';
import { dataProcessing } from '../dataProcessing.js';
import { adminService } from '../admin.service.js';
import { FILE_MAPPING, LOCAL_DSNV_FILENAME_KEY } from './constants.js';
import { updateSyncState } from './syncHandler.js';

export const cacheHandler = {
    async loadAllFromCache() {
        try { await storage.openDB(); } catch (err) { console.error("L·ªói DB:", err); }

        adminService.loadMappingsGlobal();

        console.log("[DataService] B·∫Øt ƒë·∫ßu t·∫£i DSNV t·ª´ cache...");
        const dsnvData = await storage.getItem('saved_danhsachnv');
        if (dsnvData && dsnvData.length > 0) {
            danhSachNhanVien.set(dsnvData);
            const fileName = localStorage.getItem(LOCAL_DSNV_FILENAME_KEY) || 'DSNV (Cache)';
            updateSyncState('saved_danhsachnv', 'cached', `‚úì ƒê√£ t·∫£i ${dsnvData.length} d√≤ng (Ch·ªâ l∆∞u m√°y n√†y)`, { fileName });
        } else {
            updateSyncState('saved_danhsachnv', 'error', 'Ch∆∞a c√≥ DSNV. Vui l√≤ng t·∫£i file.', null);
        }
        
        const otherFiles = ['saved_giocong', 'saved_ycx', 'saved_thuongnong', 'saved_ycx_thangtruoc', 'saved_thuongnong_thangtruoc'];
        await Promise.all(otherFiles.map(async (key) => {
            const data = await storage.getItem(key);
            if (data && data.length > 0) {
                FILE_MAPPING[key].store.set(data);
                updateSyncState(key, 'cached', `‚úì ƒê√£ t·∫£i ${data.length} d√≤ng (Local)`, null);
             }
        }));

        console.log("[DataService] B·∫Øt ƒë·∫ßu x·ª≠ l√Ω d·ªØ li·ªáu Paste...");
        try {
            const luykeText = localStorage.getItem('daily_paste_luyke');
            if (luykeText) {
                dataProcessing.parseLuyKePastedData(luykeText);
                dataProcessing.parseCompetitionDataFromLuyKe(luykeText);
                updateSyncState('daily_paste_luyke', 'cached', `(Local)`, null);
            }
            const erpText = localStorage.getItem('daily_paste_thuongerp');
            if (erpText) {
                const data = dataProcessing.processThuongERP(erpText);
                thuongERPData.set(data);
                updateSyncState('daily_paste_thuongerp', 'cached', `(Local)`, null);
            }
            const rawThiDua = localStorage.getItem('raw_paste_thiduanv');
            if (rawThiDua) {
                const parsedData = dataProcessing.parsePastedThiDuaTableData(rawThiDua);
                if (parsedData.success) {
                    const $competitionData = get(competitionData);
                    const processedData = dataProcessing.processThiDuaNhanVienData(parsedData, $competitionData);
                    pastedThiDuaReportData.set(processedData);
                    updateSyncState('daily_paste_thiduanv', 'cached', `(Local)`, null);
                }
            }
            const erpTTText = localStorage.getItem('saved_thuongerp_thangtruoc');
            if (erpTTText) {
                 const data = dataProcessing.processThuongERP(erpTTText);
                 thuongERPDataThangTruoc.set(data);
                 updateSyncState('saved_thuongerp_thangtruoc', 'cached', `(Local)`, null);
            }
        } catch (err) { console.error("L·ªói t·∫£i cache paste:", err); }
    }
};
--- END FILE: ./src/services/data/cacheHandler.js ---

--- START FILE: ./src/services/data/constants.js ---
import { 
    danhSachNhanVien, rawGioCongData, ycxData, thuongNongData,
    ycxDataThangTruoc, thuongNongDataThangTruoc, thuongERPData, 
    thuongERPDataThangTruoc, competitionData, pastedThiDuaReportData
} from '../../stores.js';
import { dataProcessing } from '../dataProcessing.js';

export const LOCAL_DSNV_FILENAME_KEY = '_localDsnvFilename';

export const FILE_MAPPING = {
    'saved_danhsachnv': { store: danhSachNhanVien, normalizeType: 'danhsachnv', name: 'DS Nh√¢n vi√™n', localOnly: true },
    'saved_giocong': { store: rawGioCongData, normalizeType: 'giocong', name: 'Gi·ªù c√¥ng' },
    'saved_ycx': { store: ycxData, normalizeType: 'ycx', name: 'YCX L≈©y k·∫ø' },
    'saved_thuongnong': { store: thuongNongData, normalizeType: 'thuongnong', name: 'Th∆∞·ªüng n√≥ng' },
    'saved_ycx_thangtruoc': { store: ycxDataThangTruoc, normalizeType: 'ycx', name: 'YCX Th√°ng tr∆∞·ªõc' },
    'saved_thuongnong_thangtruoc': { store: thuongNongDataThangTruoc, normalizeType: 'thuongnong', name: 'Th∆∞·ªüng n√≥ng TT' }
};

export const PASTE_MAPPING = {
    'daily_paste_luyke': { 
        processFunc: dataProcessing.parseCompetitionDataFromLuyKe, 
        store: competitionData,
        isThiDuaNV: false,
        name: 'Data L≈©y K·∫ø'
    },
    'daily_paste_thuongerp': { 
        processFunc: dataProcessing.processThuongERP, 
        store: thuongERPData,
        isThiDuaNV: false,
        name: 'Th∆∞·ªüng ERP'
    },
    'saved_thuongerp_thangtruoc': { 
        processFunc: dataProcessing.processThuongERP, 
        store: thuongERPDataThangTruoc,
        isThiDuaNV: false,
        name: 'Th∆∞·ªüng ERP (TT)'
    },
    'daily_paste_thiduanv': { 
        processFunc: dataProcessing.processThiDuaNhanVienData, 
        store: pastedThiDuaReportData,
        isThiDuaNV: true,
        name: 'Thi ƒëua NV'
    }
};
--- END FILE: ./src/services/data/constants.js ---

--- START FILE: ./src/services/data/fileHandler.js ---
/* global XLSX */
import { get } from 'svelte/store';
import { 
    selectedWarehouse, 
    currentUser, 
    realtimeYCXData, 
    categoryStructure, 
    brandList, 
    specialProductList 
} from '../../stores.js';
import { dataProcessing } from '../dataProcessing.js';
import { storage, storageService } from '../storage.service.js';
import { datasyncService } from '../datasync.service.js';
import { analyticsService } from '../analytics.service.js';
import { FILE_MAPPING, LOCAL_DSNV_FILENAME_KEY } from './constants.js';
import { updateSyncState } from './syncHandler.js';

// H√†m ƒë·ªçc file Excel th√†nh Workbook
async function _handleFileRead(fileBlob) {
    return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = (event) => {
            try {
                const data = new Uint8Array(event.target.result);
                const workbook = XLSX.read(data, { type: 'array', cellDates: true, cellText: true });
                resolve(workbook);
            } catch (err) { reject(err); }
        };
        reader.onerror = (err) => reject(new Error("Kh√¥ng th·ªÉ ƒë·ªçc file."));
        reader.readAsArrayBuffer(fileBlob);
    });
}

export const fileHandler = {
    // 1. X·ª≠ l√Ω c√°c file d·ªØ li·ªáu ch√≠nh (DSNV, Gi·ªù c√¥ng, YCX, Th∆∞·ªüng n√≥ng...)
    async handleFileChange(file, saveKey) {
        const mapping = FILE_MAPPING[saveKey];
        if (!mapping) return { success: false, message: `L·ªói mapping: ${saveKey}` };
        
        updateSyncState(saveKey, 'uploading', 'ƒêang ƒë·ªçc & chu·∫©n h√≥a...');
        
        try {
            const workbook = await _handleFileRead(file);
            const sheetName = workbook.SheetNames[0];
            const rawData = XLSX.utils.sheet_to_json(workbook.Sheets[sheetName], { raw: false, defval: null });
            
            const { normalizedData, success, missingColumns } = dataProcessing.normalizeData(rawData, mapping.normalizeType);
            
            if (!success) {
                updateSyncState(saveKey, 'error', `Thi·∫øu c·ªôt: ${missingColumns.join(', ')}`);
                return { success: false, message: `Thi·∫øu c·ªôt b·∫Øt bu·ªôc: ${missingColumns.join(', ')}` };
            }

            // L∆∞u v√†o Store
            mapping.store.set(normalizedData);
            
            // L∆∞u v√†o IndexedDB (Cache Local)
            await storage.setItem(saveKey, normalizedData); 
            
            // X·ª≠ l√Ω ri√™ng cho DSNV (ch·ªâ l∆∞u local)
            if (saveKey === 'saved_danhsachnv') {
                localStorage.setItem(LOCAL_DSNV_FILENAME_KEY, file.name);
                updateSyncState(saveKey, 'cached', `‚úì ƒê√£ t·∫£i ${normalizedData.length} d√≤ng (Local)`, null);
                return { success: true, count: normalizedData.length, message: `Th√†nh c√¥ng` };
            }

            // X·ª≠ l√Ω Upload l√™n Cloud (n·∫øu ƒë√£ ch·ªçn kho)
            const warehouse = get(selectedWarehouse);
            if (warehouse && !mapping.localOnly) {
                updateSyncState(saveKey, 'uploading', 'ƒêang t·∫£i l√™n Cloud...');
                try {
                    const path = `warehouse_data/${warehouse}/${saveKey}_${Date.now()}_${file.name}`;
                    const downloadUrl = await storageService.uploadFileToStorage(file, path);
                    
                    const metadata = {
                        downloadURL: downloadUrl,
                        fileName: file.name,
                        fileType: 'excel',
                        rowCount: normalizedData.length,
                        updatedAt: new Date(),
                        updatedBy: get(currentUser)?.email || 'T√¥i'
                    };
                    
                    await datasyncService.saveWarehouseMetadata(warehouse, saveKey, metadata);
                    updateSyncState(saveKey, 'synced', `‚úì ƒê√£ ƒë·ªìng b·ªô`, metadata);
                } catch (e) {
                    console.error("L·ªói upload cloud:", e);
                    updateSyncState(saveKey, 'error', `L·ªói l∆∞u Cloud: ${e.message}`, null);
                    // Kh√¥ng return false ·ªü ƒë√¢y v√¨ d·ªØ li·ªáu local ƒë√£ ok
                }
            } else {
                 updateSyncState(saveKey, 'synced', `‚úì ƒê√£ t·∫£i ${normalizedData.length} d√≤ng`, null);
            }
            
            analyticsService.trackAction();
            return { success: true, count: normalizedData.length, message: `Th√†nh c√¥ng` };

        } catch (err) {
            console.error(err);
            updateSyncState(saveKey, 'error', `L·ªói: ${err.message}`, null);
            return { success: false, message: `L·ªói x·ª≠ l√Ω file: ${err.message}` };
        }
    },

    // 2. X·ª≠ l√Ω file Realtime (T∆∞∆°ng t·ª± YCX nh∆∞ng l∆∞u v√†o store ri√™ng)
    async handleRealtimeFileInput(event) {
        const file = event.target.files[0];
        if (!file) return;

        console.log("[FileHandler] B·∫Øt ƒë·∫ßu x·ª≠ l√Ω Realtime:", file.name);
        
        try {
            const workbook = await _handleFileRead(file);
            const sheetName = workbook.SheetNames[0];
            const rawData = XLSX.utils.sheet_to_json(workbook.Sheets[sheetName], { raw: false, defval: null });

            // T√°i s·ª≠ d·ª•ng logic chu·∫©n h√≥a c·ªßa 'ycx' v√¨ c·∫•u tr√∫c file gi·ªëng nhau
            const { normalizedData, success, missingColumns } = dataProcessing.normalizeData(rawData, 'ycx');

            if (!success) {
                alert(`File thi·∫øu c·ªôt: ${missingColumns.join(', ')}`);
                return;
            }

            // C·∫≠p nh·∫≠t store
            realtimeYCXData.set(normalizedData);
            
            // Ghi nh·∫≠n analytics
            analyticsService.trackAction();
            
            console.log(`[FileHandler] ƒê√£ n·∫°p ${normalizedData.length} d√≤ng realtime.`);
            // Reset input
            event.target.value = null;

        } catch (error) {
            console.error("L·ªói x·ª≠ l√Ω Realtime:", error);
            alert("L·ªói ƒë·ªçc file Realtime: " + error.message);
        }
    },

    // 3. X·ª≠ l√Ω file C·∫•u tr√∫c Ng√†nh h√†ng (Admin)
    async handleCategoryFile(event) {
        const file = event.target.files[0];
        if (!file) return;

        try {
            const workbook = await _handleFileRead(file);
            const sheetName = workbook.SheetNames[0];
            const rawData = XLSX.utils.sheet_to_json(workbook.Sheets[sheetName], { raw: false, defval: null });

            const { success, normalizedData, error } = dataProcessing.normalizeCategoryStructureData(rawData);
            
            if (!success) {
                throw new Error(error);
            }

            // C·∫≠p nh·∫≠t Store
            categoryStructure.set(normalizedData);
            
            // T√°ch danh s√°ch H√£ng (Brand) t·ª´ d·ªØ li·ªáu
            const brands = [...new Set(normalizedData.map(i => i.nhaSanXuat).filter(Boolean))].sort();
            brandList.set(brands);

            console.log(`[FileHandler] ƒê√£ n·∫°p ${normalizedData.length} d√≤ng c·∫•u tr√∫c & ${brands.length} h√£ng.`);
            
            // Reset input
            event.target.value = null;
            return { success: true, count: normalizedData.length };

        } catch (err) {
            console.error("L·ªói file c·∫•u tr√∫c:", err);
            throw err;
        }
    },

    // 4. X·ª≠ l√Ω file S·∫£n ph·∫©m ƒê·∫∑c quy·ªÅn (Admin)
    async handleSpecialProductFileUpload(event) {
        const file = event.target.files[0];
        if (!file) return;

        try {
            const workbook = await _handleFileRead(file);
            const sheetName = workbook.SheetNames[0];
            const rawData = XLSX.utils.sheet_to_json(workbook.Sheets[sheetName], { raw: false, defval: null });

            const { success, normalizedData, error } = dataProcessing.normalizeSpecialProductData(rawData);

            if (!success) {
                throw new Error(error);
            }

            specialProductList.set(normalizedData);
            console.log(`[FileHandler] ƒê√£ n·∫°p ${normalizedData.length} SPƒêQ.`);
            
            event.target.value = null;
            return { success: true, count: normalizedData.length };

        } catch (err) {
            console.error("L·ªói file SPƒêQ:", err);
            throw err;
        }
    },

    // 5. T·∫£i file m·∫´u
    async handleTemplateDownload() {
        try {
            const url = await storageService.getTemplateDownloadURL();
            if (url) {
                const a = document.createElement('a');
                a.href = url;
                a.target = "_blank";
                a.download = "Template_DSNV.xlsx";
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
            } else {
                alert("Kh√¥ng t√¨m th·∫•y link t·∫£i m·∫´u.");
            }
        } catch (e) {
            console.error("L·ªói t·∫£i template:", e);
            alert("L·ªói khi l·∫•y link t·∫£i m·∫´u: " + e.message);
        }
    }
};
--- END FILE: ./src/services/data/fileHandler.js ---

--- START FILE: ./src/services/data/pasteHandler.js ---
import { get } from 'svelte/store';
import { selectedWarehouse, currentUser, competitionData, pastedThiDuaReportData } from '../../stores.js';
import { dataProcessing } from '../dataProcessing.js';
import { storageService } from '../storage.service.js';
import { datasyncService } from '../datasync.service.js';
import { analyticsService } from '../analytics.service.js';
import { PASTE_MAPPING } from './constants.js';
import { updateSyncState } from './syncHandler.js';

export const pasteHandler = {
    async handlePasteChange(pastedText, saveKeyPaste, saveKeyRaw, saveKeyProcessed) {
        const primaryKey = saveKeyProcessed || saveKeyPaste;
        const mapping = PASTE_MAPPING[primaryKey];
        if (!mapping) return { success: false, message: `L·ªói mapping paste` };
        
        updateSyncState(saveKeyPaste, 'uploading', 'ƒêang x·ª≠ l√Ω...');
        try {
            let processedData;
            let processedCount = 0;
            if (mapping.isThiDuaNV) {
                const parsedData = dataProcessing.parsePastedThiDuaTableData(pastedText);
                if (!parsedData.success) throw new Error(parsedData.error);
                dataProcessing.updateCompetitionNameMappings(parsedData.mainHeaders);
                const $competitionData = get(competitionData);
                processedData = dataProcessing.processThiDuaNhanVienData(parsedData, $competitionData);
                mapping.store.set(processedData);
                localStorage.setItem(saveKeyRaw, pastedText);
                localStorage.setItem(saveKeyProcessed, JSON.stringify(processedData));
                processedCount = processedData.length;
            } else if (mapping.processFunc) {
                processedData = mapping.processFunc(pastedText);
                mapping.store.set(processedData);
                localStorage.setItem(saveKeyPaste, pastedText);
                processedCount = processedData?.length || 0;
                if (saveKeyPaste === 'daily_paste_luyke') {
                     const comps = dataProcessing.parseCompetitionDataFromLuyKe(pastedText);
                     dataProcessing.parseLuyKePastedData(pastedText);
                     processedCount = comps.length;
                }
            }
            const warehouse = get(selectedWarehouse);
            if (warehouse) {
                try {
                    updateSyncState(saveKeyPaste, 'uploading', 'ƒêang l∆∞u Cloud...');
                    const blob = new Blob([pastedText], { type: 'text/plain' });
                    const path = `warehouse_data/${warehouse}/${primaryKey}_${Date.now()}.txt`;
                    const downloadUrl = await storageService.uploadFileToStorage(blob, path);
                    const metadata = {
                        downloadURL: downloadUrl,
                        fileName: 'du_lieu_dan.txt',
                        fileType: 'text',
                        rowCount: processedCount, 
                        updatedAt: new Date(),
                        updatedBy: get(currentUser)?.email || 'T√¥i'
                    };
                    await datasyncService.saveWarehouseMetadata(warehouse, primaryKey, metadata);
                    updateSyncState(saveKeyPaste, 'synced', `‚úì ƒê√£ ƒë·ªìng b·ªô`, metadata);
                } catch (e) {
                    console.error("Cloud paste upload error:", e);
                    updateSyncState(saveKeyPaste, 'error', `L·ªói ƒë·ªìng b·ªô Cloud: ${e.message}`);
                }
            } else {
                 updateSyncState(saveKeyPaste, 'cached', `‚úì ƒê√£ x·ª≠ l√Ω (Local)`, null);
            }
            analyticsService.trackAction();
            return { success: true, message: `Th√†nh c√¥ng` };
        } catch (err) {
            updateSyncState(saveKeyPaste, 'error', `L·ªói: ${err.message}`);
            return { success: false, message: `L·ªói: ${err.message}` };
        }
    }
};
--- END FILE: ./src/services/data/pasteHandler.js ---

--- START FILE: ./src/services/data/syncHandler.js ---
/* global XLSX */
import { get } from 'svelte/store';
import { fileSyncState, selectedWarehouse, currentUser, competitionData, pastedThiDuaReportData, thuongERPData, thuongERPDataThangTruoc } from '../../stores.js';
import { datasyncService } from '../datasync.service.js';
import { storage } from '../storage.service.js';
import { dataProcessing } from '../dataProcessing.js';
import { FILE_MAPPING, PASTE_MAPPING } from './constants.js';

export function updateSyncState(key, status, message, metadata = null) {
    fileSyncState.update(s => ({
        ...s,
        [key]: { status, message, metadata, timestamp: Date.now() }
    }));
}

export function formatTimeAgo(dateInput) {
    if (!dateInput) return '';
    const date = dateInput.toDate ? dateInput.toDate() : new Date(dateInput);
    const seconds = Math.floor((new Date() - date) / 1000);
    
    let interval = seconds / 3600;
    if (interval > 1) return Math.floor(interval) + " gi·ªù tr∆∞·ªõc";
    interval = seconds / 60;
    if (interval > 1) return Math.floor(interval) + " ph√∫t tr∆∞·ªõc";
    return "v·ª´a xong";
}

export const syncHandler = {
    async syncDownFromCloud(warehouse) {
        if (!warehouse) return { success: false, message: "Ch∆∞a ch·ªçn kho." };
        console.log(`[DataService] B·∫Øt ƒë·∫ßu ƒë·ªìng b·ªô kho ${warehouse}...`);
        
        for (const key of Object.keys(FILE_MAPPING)) {
            if (!FILE_MAPPING[key].localOnly) updateSyncState(key, 'checking', 'ƒêang ki·ªÉm tra...', null);
        }
        for (const key of Object.keys(PASTE_MAPPING)) {
            updateSyncState(key, 'checking', 'ƒêang ki·ªÉm tra...', null);
        }

        try {
            const cloudData = await datasyncService.loadWarehouseData(warehouse);
            if (!cloudData) {
                 return { success: true, message: "Kho ch∆∞a c√≥ d·ªØ li·ªáu tr√™n Cloud." };
            }
            const userEmail = get(currentUser)?.email;

            // X·ª≠ l√Ω File Excel
            for (const [key, mapping] of Object.entries(FILE_MAPPING)) {
                if (mapping.localOnly) continue;
                const cloudMeta = cloudData[key];
                const localMetaStr = localStorage.getItem(`_meta_${warehouse}_${key}`);
                const localMeta = localMetaStr ? JSON.parse(localMetaStr) : {};
                if (!cloudMeta) continue;

                const timeAgo = formatTimeAgo(cloudMeta.updatedAt);
                const isMyUpload = cloudMeta.updatedBy === userEmail;
                const isNewer = (cloudMeta.timestamp || 0) > (localMeta.timestamp || 0);
                const currentStoreData = get(mapping.store);
                const isStoreEmpty = !currentStoreData || currentStoreData.length === 0;

                if (isNewer) {
                     const msg = isMyUpload ? `C√≥ b·∫£n m·ªõi t·ª´ b·∫°n ${timeAgo}` : `C√≥ c·∫≠p nh·∫≠t m·ªõi t·ª´ ${cloudMeta.updatedBy} ${timeAgo}`;
                    updateSyncState(key, 'update_available', msg, cloudMeta);
                } else {
                    if (isStoreEmpty) {
                        console.log(`[Auto-Download] ${key} ƒë√£ ƒë·ªìng b·ªô metadata nh∆∞ng Store r·ªóng. ƒêang t·ª± t·∫£i v·ªÅ...`);
                        updateSyncState(key, 'downloading', 'ƒêang t·ª± ƒë·ªông t·∫£i v·ªÅ...', cloudMeta);
                        await this.downloadFileFromCloud(key);
                    } else {
                         updateSyncState(key, 'synced', `‚úì ƒê√£ ƒë·ªìng b·ªô ${timeAgo} (${cloudMeta.rowCount || 0} d√≤ng)`, cloudMeta);
                    }
                }
            }

            // X·ª≠ l√Ω Paste Data
            for (const [key, mapping] of Object.entries(PASTE_MAPPING)) {
                const cloudMeta = cloudData[key]; 
                const localMetaStr = localStorage.getItem(`_meta_${warehouse}_${key}`);
                const localMeta = localMetaStr ? JSON.parse(localMetaStr) : {};
                if (cloudMeta) {
                    const timeAgo = formatTimeAgo(cloudMeta.updatedAt);
                    const isMyUpload = cloudMeta.updatedBy === userEmail;
                    const isNewer = (cloudMeta.timestamp || 0) > (localMeta.timestamp || 0);
                    let uiKey = key;
                    if (isNewer) {
                         const msg = isMyUpload ? `C√≥ b·∫£n m·ªõi t·ª´ b·∫°n ${timeAgo}` : `C√≥ c·∫≠p nh·∫≠t m·ªõi t·ª´ ${cloudMeta.updatedBy} ${timeAgo}`;
                         updateSyncState(uiKey, 'update_available', msg, cloudMeta);
                    } else {
                         const currentStoreData = get(mapping.store);
                         const isStoreEmpty = !currentStoreData || currentStoreData.length === 0;
                         if (isStoreEmpty) {
                              console.log(`[Auto-Download] ${uiKey} (Paste) ƒë√£ ƒë·ªìng b·ªô metadata nh∆∞ng Store r·ªóng. ƒêang t·ª± t·∫£i...`);
                              updateSyncState(uiKey, 'downloading', 'ƒêang t·ª± t·∫£i...', cloudMeta);
                              await this.downloadFileFromCloud(uiKey);
                         } else {
                              updateSyncState(uiKey, 'synced', `‚úì ƒê√£ ƒë·ªìng b·ªô ${timeAgo}`, cloudMeta);
                         }
                    }
                }
            }
            return { success: true, message: `ƒê√£ ki·ªÉm tra d·ªØ li·ªáu kho ${warehouse}.` };
        } catch (error) {
            console.error("Sync error:", error);
            return { success: false, message: "L·ªói k·∫øt n·ªëi Cloud: " + error.message };
        }
    },

    async downloadFileFromCloud(key) {
        const state = get(fileSyncState)[key];
        const warehouse = get(selectedWarehouse);
        if (!state?.metadata?.downloadURL || !warehouse) return;
        
        updateSyncState(key, 'downloading', 'ƒêang t·∫£i xu·ªëng...', state.metadata);
        
        try {
            const response = await fetch(state.metadata.downloadURL);
            
            if (FILE_MAPPING[key]) {
                const blob = await response.blob();
                const workbook = await new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                         const data = new Uint8Array(e.target.result);
                         resolve(XLSX.read(data, { type: 'array', cellDates: true, cellText: true }));
                    };
                    reader.onerror = reject;
                    reader.readAsArrayBuffer(blob);
                });
                const rawData = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]], { raw: false, defval: null });
                const mapping = FILE_MAPPING[key];
                const { normalizedData } = dataProcessing.normalizeData(rawData, mapping.normalizeType);
                mapping.store.set(normalizedData);
                await storage.setItem(key, normalizedData);
                const metaToSave = { ...state.metadata, timestamp: state.metadata.timestamp || Date.now() };
                localStorage.setItem(`_meta_${warehouse}_${key}`, JSON.stringify(metaToSave));
                const timeAgo = formatTimeAgo(state.metadata.updatedAt);
                updateSyncState(key, 'synced', `‚úì ƒê√£ ƒë·ªìng b·ªô ${timeAgo} (${normalizedData.length} d√≤ng)`, state.metadata);
            
            } else if (PASTE_MAPPING[key]) {
                const textContent = await response.text();
                const mapping = PASTE_MAPPING[key];
                let processedCount = 0;
                
                if (mapping.isThiDuaNV) {
                     localStorage.setItem('raw_paste_thiduanv', textContent);
                    const parsedData = dataProcessing.parsePastedThiDuaTableData(textContent);
                    if (parsedData.success) {
                        dataProcessing.updateCompetitionNameMappings(parsedData.mainHeaders);
                        const $competitionData = get(competitionData);
                        const processedData = dataProcessing.processThiDuaNhanVienData(parsedData, $competitionData);
                        mapping.store.set(processedData);
                        processedCount = processedData.length;
                        localStorage.setItem('daily_paste_thiduanv', JSON.stringify(processedData)); 
                    }
                } else if (mapping.processFunc) {
                     const processedData = mapping.processFunc(textContent);
                    mapping.store.set(processedData);
                    processedCount = processedData?.length || 0;
                    localStorage.setItem(key, textContent);
                    if (key === 'daily_paste_luyke') {
                         const comps = dataProcessing.parseCompetitionDataFromLuyKe(textContent);
                         dataProcessing.parseLuyKePastedData(textContent);
                         processedCount = comps.length;
                    }
                }
                const metaToSave = { 
                    ...state.metadata, 
                    timestamp: state.metadata.timestamp || Date.now(),
                    rowCount: processedCount 
                };
                localStorage.setItem(`_meta_${warehouse}_${key}`, JSON.stringify(metaToSave));
                const timeAgo = formatTimeAgo(state.metadata.updatedAt);
                updateSyncState(key, 'synced', `‚úì ƒê√£ ƒë·ªìng b·ªô ${timeAgo}`, metaToSave);
                window.dispatchEvent(new CustomEvent('cloud-paste-loaded', { detail: { key, text: textContent } }));
            }
            return { success: true };
        } catch (e) {
            console.error(e);
            updateSyncState(key, 'error', 'L·ªói t·∫£i file: ' + e.message, state.metadata);
            return { success: false, message: e.message };
        }
    }
};
--- END FILE: ./src/services/data/syncHandler.js ---

--- START FILE: ./src/services/processing/helpers.js ---
/* global XLSX */
import { get } from 'svelte/store';
import { config } from '../../config.js';
import { declarations } from '../../stores.js';

export const helpers = {
    findColumnName(header, aliases) {
        for (const colName of header) {
            const processedColName = String(colName || '').trim().toLowerCase();
            if (aliases.includes(processedColName)) {
                return colName;
            }
        }
        return null;
    },

    getHinhThucXuatTinhDoanhThu: () => {
        const declarationData = get(declarations).hinhThucXuat;
        if (declarationData) return new Set(declarationData.split('\n').map(l => l.trim()).filter(Boolean));
        return new Set(config.DEFAULT_DATA.HINH_THUC_XUAT_TINH_DOANH_THU);
    },

    getHinhThucXuatTraGop: () => {
        const declarationData = get(declarations).hinhThucXuatGop;
        if (declarationData) return new Set(declarationData.split('\n').map(l => l.trim()).filter(Boolean));
        return new Set(config.DEFAULT_DATA.HINH_THUC_XUAT_TRA_GOP);
    },

    getHeSoQuyDoi: () => {
        const declarationData = get(declarations).heSoQuyDoi;
        const heSoMap = {};
        if (declarationData) {
            declarationData.split('\n').filter(l => l.trim()).forEach(line => {
                const parts = line.split(',');
                if (parts.length >= 2) {
                    const key = parts[0].trim();
                    const value = parseFloat(parts[1].trim());
                    if (key && !isNaN(value)) heSoMap[key] = value;
                }
            });
            return Object.keys(heSoMap).length > 0 ? heSoMap : config.DEFAULT_DATA.HE_SO_QUY_DOI;
        }
        return config.DEFAULT_DATA.HE_SO_QUY_DOI;
    },

    cleanCompetitionName(name) {
        return name.replace(/thi ƒëua doanh thu b√°n h√†ng|thi ƒëua doanh thu|thi ƒëua s·ªë l∆∞·ª£ng/gi, "").trim();
    },

    classifyInsurance: (productName) => {
        if (!productName || typeof productName !== 'string') return null;
        const name = productName.trim().toLowerCase();
        if (name.includes('b·∫£o h√†nh m·ªü r·ªông')) return 'BHMR';
        if (name.includes('1 ƒë·ªïi 1')) return 'BH1d1';
        if (name.includes('kho·∫£n vay')) return 'BHKV';
        if (name.includes('r∆°i v·ª°')) return 'BHRV';
        if (name.includes('samsung care+')) return 'BHSC';
        if (name.includes('√¥ t√¥') || name.includes('v·∫≠t ch·∫•t √¥ t√¥')) return 'BHOTO';
        if (name.includes('xe m√°y') || name.includes('xe moto')) return 'BHXM';
        if (name.includes('x√£ h·ªôi') || name.includes('y t·∫ø')) return 'BHYT';
        return null;
    },

    findHeaderAndProcess(sheet, requiredKeywords) {
        if (!sheet) return [];
        const rows = XLSX.utils.sheet_to_json(sheet, { header: 1, defval: null });
        if (rows.length === 0) return [];

        let headerRowIndex = -1;
        let foundHeaders = [];

        for (let i = 0; i < Math.min(rows.length, 10); i++) {
            const row = rows[i];
            const lowerCaseRow = row.map(cell => String(cell || '').trim().toLowerCase());

            const allKeywordsFound = requiredKeywords.every(keyword =>
                lowerCaseRow.some(cell => cell.includes(keyword))
            );

            if (allKeywordsFound) {
                headerRowIndex = i;
                foundHeaders = rows[i].map(cell => String(cell || '').trim());
                break;
            }
        }

        if (headerRowIndex === -1) {
            throw new Error(`Kh√¥ng t√¨m th·∫•y d√≤ng ti√™u ƒë·ªÅ ch·ª©a ƒë·ªß c√°c t·ª´ kh√≥a: ${requiredKeywords.join(', ')}.`);
        }

        const dataRows = rows.slice(headerRowIndex + 1);
        const jsonData = dataRows.map(row => {
            const obj = {};
            foundHeaders.forEach((header, index) => {
                if (header) {
                    const value = row[index];
                    const upperKey = header.toUpperCase();
                    if (upperKey.includes('K√äNH') || upperKey.includes('SI√äU TH·ªä') || upperKey.includes('NG√ÄNH H√ÄNG') || upperKey.includes('T·ªàNH') || upperKey.includes('BOSS')) {
                        obj[header] = value;
                    } else if (typeof value === 'string' && value.includes('%')) {
                        obj[header] = parseFloat(value.replace(/%|,/g, '')) / 100 || 0;
                    } else if (value !== null && value !== undefined) {
                        obj[header] = parseFloat(String(value).replace(/,/g, '')) || 0;
                    } else {
                        obj[header] = 0;
                    }
                }
            });
            return obj;
        }).filter(obj => {
            const supermarketKey = Object.keys(obj).find(k => k.toLowerCase().includes('si√™u th·ªã'));
            return supermarketKey && obj[supermarketKey];
        });

        return jsonData;
    }
};
--- END FILE: ./src/services/processing/helpers.js ---

--- START FILE: ./src/services/processing/normalizers.js ---
import { config } from '../../config.js';
import { debugInfo, rawGioCongData } from '../../stores.js';
import { helpers } from './helpers.js';

export const normalizers = {
    normalizeCategoryStructureData(rawData) {
        if (!rawData || rawData.length === 0) {
            return { success: false, error: 'File r·ªóng.', normalizedData: [] };
        }
        const header = Object.keys(rawData[0] || {});
        
        const nganhHangCol = helpers.findColumnName(header, ['ng√†nh h√†ng', 'nganh hang']);
        const nhomHangCol = helpers.findColumnName(header, ['nh√≥m h√†ng', 'nhom hang']);
        const nhaSanXuatCol = helpers.findColumnName(header, ['nh√† s·∫£n xu·∫•t', 'nha san xuat', 'h√£ng', 'brand']);

        const missingCols = [];
        if (!nganhHangCol) missingCols.push('"Ng√†nh h√†ng"');
        if (!nhomHangCol) missingCols.push('"Nh√≥m h√†ng"');
        if (!nhaSanXuatCol) missingCols.push('"Nh√† s·∫£n xu·∫•t"');

        if (missingCols.length > 0) {
            return { success: false, error: `File thi·∫øu c√°c c·ªôt: ${missingCols.join(', ')}`, normalizedData: [] };
        }

        const normalizedData = rawData
            .map(row => ({
                nganhHang: String(row[nganhHangCol] || '').trim(),
                nhomHang: String(row[nhomHangCol] || '').trim(),
                nhaSanXuat: String(row[nhaSanXuatCol] || '').trim(),
            }))
            .filter(item => item.nganhHang && item.nhomHang);
            
        return { success: true, normalizedData };
    },
    
    normalizeSpecialProductData(rawData) {
        if (!rawData || rawData.length === 0) {
            return { success: false, error: 'File r·ªóng.', normalizedData: [] };
        }
        const header = Object.keys(rawData[0] || {});
        const maSpCol = helpers.findColumnName(header, ['m√£ s·∫£n ph·∫©m', 'masanpham', 'm√£ sp', 'product code']);
        const nhomHangCol = helpers.findColumnName(header, ['nh√≥m h√†ng', 'nhom hang']);
        const tenSpCol = helpers.findColumnName(header, ['t√™n s·∫£n ph·∫©m', 'tensanpham', 't√™n sp']);

        const missingColumns = [];
        if (!maSpCol) missingColumns.push('M√£ s·∫£n ph·∫©m');
        if (!nhomHangCol) missingColumns.push('Nh√≥m h√†ng');
        if (!tenSpCol) missingColumns.push('T√™n s·∫£n ph·∫©m');

        if (missingColumns.length > 0) {
            return { success: false, error: `File thi·∫øu c√°c c·ªôt b·∫Øt bu·ªôc: ${missingColumns.join(', ')}.`, normalizedData: [] };
        }

        const normalizedData = rawData
            .map(row => ({
                maSanPham: String(row[maSpCol] || '').trim(),
                nhomHang: String(row[nhomHangCol] || '').trim(),
                tenSanPham: String(row[tenSpCol] || '').trim(),
            }))
            .filter(item => item.maSanPham && item.nhomHang && item.tenSanPham);

        return { success: true, normalizedData };
    },

    normalizeBrandData(rawData) {
        if (!rawData || rawData.length === 0) {
             return { success: false, error: 'Sheet "H√£ng" r·ªóng.', normalizedData: [] };
        }
        const header = Object.keys(rawData[0] || {});
        const brandCol = helpers.findColumnName(header, ['h√£ng', 't√™n h√£ng', 'nh√† s·∫£n xu·∫•t']);
        if (!brandCol) {
            return { success: false, error: 'Sheet "H√£ng" ph·∫£i c√≥ c·ªôt "H√£ng" ho·∫∑c "T√™n H√£ng".', normalizedData: [] };
        }

        const normalizedData = rawData
            .map(row => String(row[brandCol] || '').trim())
            .filter(brand => brand);
        return { success: true, normalizedData: [...new Set(normalizedData)].sort() };
    },

    normalizeData(rawData, fileType) {
        const mapping = config.COLUMN_MAPPINGS[fileType];
        if (!mapping) {
            console.error(`No column mapping found for fileType: ${fileType}`);
            return { normalizedData: [], success: false, missingColumns: ['Unknown mapping'] };
        }

        if (!rawData || rawData.length === 0) {
            return { normalizedData: [], success: true, missingColumns: [] };
        }

        const header = Object.keys(rawData[0] || {});
        const foundMapping = {};
        let allRequiredFound = true;
        const missingColumns = [];

        const newDebugInfo = { required: [], found: header, firstFiveMsnv: [] };
        for (const key in mapping) {
            const { required, displayName, aliases } = mapping[key];
            const foundName = helpers.findColumnName(header, aliases);
            foundMapping[key] = foundName;

            if (required) {
                const status = !!foundName;
                newDebugInfo.required.push({ displayName, foundName: foundName || 'Kh√¥ng t√¨m th·∫•y', status: status });
                if (!status) {
                    allRequiredFound = false;
                    missingColumns.push(displayName);
                }
            }
        }

        if (fileType === 'giocong' || fileType === 'thuongnong') {
            if (!foundMapping.maNV && !foundMapping.hoTen) {
                 allRequiredFound = false;
                const missingMsg = 'M√£ NV ho·∫∑c T√™n NV';
                missingColumns.push(missingMsg);
                if (!newDebugInfo.required.some(r => r.displayName.includes('NV'))) {
                     newDebugInfo.required.push({ displayName: missingMsg, foundName: 'Kh√¥ng t√¨m th·∫•y', status: false });
                }
            }
        }

        if (!allRequiredFound) {
            debugInfo.update(currentInfo => ({ ...currentInfo, [fileType]: newDebugInfo }));
            return { normalizedData: [], success: false, missingColumns };
        }

        const normalizedData = rawData.map(row => {
            const newRow = {};
            for (const key in foundMapping) {
                if (foundMapping[key]) {
                    if (key === 'maNV' || key === 'hoTen' || key === 'maSanPham') {
                         newRow[key] = String(row[foundMapping[key]] || '').trim();
                    } else if ((key === 'ngayTao' || key === 'ngayHenGiao') && row[foundMapping[key]]) {
                        const dateValue = row[foundMapping[key]];
                        if (dateValue instanceof Date) {
                             newRow[key] = dateValue;
                        } else if (typeof dateValue === 'number') {
                            newRow[key] = new Date(Math.round((dateValue - 25569) * 86400 * 1000));
                        } else if (typeof dateValue === 'string') {
                             const parsedDate = new Date(dateValue.replace(/(\d{2})\/(\d{2})\/(\d{4})/, '$2/$1/$3'));
                            if (!isNaN(parsedDate.getTime())) newRow[key] = parsedDate;
                        }
                    } else {
                         newRow[key] = row[foundMapping[key]];
                    }
                }
            }
            return newRow;
        });

        if (fileType === 'giocong') {
            const giocongRawList = rawData.map(row => {
                const newRow = {};
                for (const key in foundMapping) {
                    if (foundMapping[key]) newRow[key] = row[foundMapping[key]];
                }
                return newRow;
            });
            rawGioCongData.set(giocongRawList);
        }

        newDebugInfo.firstFiveMsnv = normalizedData.slice(0, 5).map(r => r.maNV).filter(Boolean);
        debugInfo.update(currentInfo => ({ ...currentInfo, [fileType]: newDebugInfo }));
        
        return { normalizedData, success: true, missingColumns: [] };
    }
};
--- END FILE: ./src/services/processing/normalizers.js ---

--- START FILE: ./src/services/processing/parsers.js ---
import { competitionData, debugInfo } from '../../stores.js';
import { helpers } from './helpers.js';

export const parsers = {
    processThuongERP: (pastedText) => {
        if (!pastedText || !pastedText.trim()) return [];
        const lines = pastedText.trim().split('\n');
        const results = [];
        const regex = /(ƒêML_|TGD|ƒêMM|ƒêMS).*?(BP .*?)(?:Nh√¢n Vi√™n|Tr∆∞·ªüng Ca)(.*?)([\d,]+)$/;
        lines.forEach(line => {
            const match = line.replace(/\s+/g, ' ').match(regex);
            if (match) results.push({ name: match[3].trim(), bonus: match[4].trim() });
        });
        return results;
    },

    parseLuyKePastedData: (text) => {
        const defaults = {
            mainKpis: {},
            comparisonData: { value: 0, percentage: 'N/A' },
            luotKhachData: { value: 0, percentage: 'N/A' },
            dtDuKien: 0, dtqdDuKien: 0, dtTraCham: 0, tyLeTraCham: 0 
        };
        if (!text) return defaults;

        const allLines = text.split('\n').map(line => line.trim());
        const textContent = allLines.join(' ');

        const patterns = {
            'Th·ª±c hi·ªán DT th·ª±c': /DTLK\s+([\d,.]+)/,
            'Th·ª±c hi·ªán DTQƒê': /DTQƒê\s+([\d,.]+)/,
            '% HT Target D·ª± Ki·∫øn (Qƒê)': /% HT Target D·ª± Ki·∫øn \(Qƒê\)\s+([\d.]+%?)/,
        };

        for (const [key, regex] of Object.entries(patterns)) {
            const match = textContent.match(regex);
            if (match && match[1]) {
                defaults.mainKpis[key] = match[1];
            }
        }

        const findValueAfterKeyword = (lines, keyword, isQd = false) => {
            let keywordRegex;
            if (isQd) {
                keywordRegex = new RegExp(keyword.replace('(', '\\(').replace(')', '\\)'));
            } else {
                keywordRegex = new RegExp(`^${keyword}$`);
            }

            const index = lines.findIndex(line => keywordRegex.test(line) && !/l∆∞·ª£t kh√°ch/i.test(line));
            if (index !== -1 && index + 1 < lines.length) {
                return parseFloat(lines[index + 1].replace(/,/g, '').replace(/%/g, '')) || 0;
            }
            return 0;
        };

        defaults.dtDuKien = findValueAfterKeyword(allLines, "DT D·ª± Ki·∫øn");
        defaults.dtqdDuKien = findValueAfterKeyword(allLines, "DT D·ª± Ki·∫øn (Qƒê)", true);
        defaults.dtTraCham = findValueAfterKeyword(allLines, "DT Si√™u th·ªã");
        defaults.tyLeTraCham = findValueAfterKeyword(allLines, "T·ª∑ Tr·ªçng Tr·∫£ G√≥p");

        const dtckIndex = allLines.findIndex(line => line.includes('DTCK Th√°ng'));
        if (dtckIndex !== -1 && dtckIndex + 1 < allLines.length) {
            const valueLine = allLines[dtckIndex + 1];
            const values = valueLine.split(/\s+/);
            if (values.length >= 2) {
                defaults.comparisonData = {
                    value: parseFloat(values[0].replace(/,/g, '')) || 0,
                    percentage: values[1] || 'N/A'
                };
            }
        }

        const luotKhachIndex = allLines.findIndex(line => line.includes('L∆∞·ª£t Kh√°ch CK Th√°ng'));
        if (luotKhachIndex !== -1 && luotKhachIndex + 1 < allLines.length) {
            const valueLine = allLines[luotKhachIndex + 1];
            const values = valueLine.split(/\s+/);
            if (values.length >= 2) {
                defaults.luotKhachData = {
                    value: parseFloat(values[0].replace(/,/g, '')) || 0,
                    percentage: values[1] || 'N/A'
                };
            }
        }

        return defaults;
    },

    parseCompetitionDataFromLuyKe: (text) => {
        if (!text || !text.trim()) return [];
        const lines = text.split('\n').map(l => l.trim());
        const results = [];
        let currentCompetition = null;

        for (let i = 0; i < lines.length; i++) {
            const line = lines[i];
            if (line.toLowerCase().startsWith('thi ƒëua')) {
                if (currentCompetition) results.push(currentCompetition);
                currentCompetition = {
                    name: line.replace("Thi ƒëua doanh thu", "DT").replace("Thi ƒëua s·ªë l∆∞·ª£ng", "SL"),
                    type: line.toLowerCase().includes('doanh thu') ? 'doanhThu' : 'soLuong',
                    luyKe: 0, target: 0, hoanThanh: '0%'
                };
            } else if (currentCompetition) {
                if (line.startsWith('DTLK') || line.startsWith('SLLK') || line.startsWith('DTQƒê')) {
                     if (i + 1 < lines.length) {
                         currentCompetition.luyKe = parseFloat(lines[i + 1].replace(/,/g, '')) || 0;
                    }
                } else if (line.startsWith('Target')) {
                    if (i + 1 < lines.length) {
                        currentCompetition.target = parseFloat(lines[i + 1].replace(/,/g, '')) || 0;
                    }
                } else if (line.startsWith('% HT D·ª± Ki·∫øn')) {
                    if (i + 1 < lines.length) {
                         currentCompetition.hoanThanh = lines[i + 1] || '0%';
                    }
                }
            }
        }
        if (currentCompetition) results.push(currentCompetition);

        competitionData.set(results);
        return results;
    },

    parsePastedThiDuaTableData(rawText) {
        const newDebugInfo = { required: [], found: [], status: 'B·∫Øt ƒë·∫ßu ph√¢n t√≠ch...' };

        if (!rawText || !rawText.trim()) {
            newDebugInfo.status = 'L·ªói: D·ªØ li·ªáu d√°n v√†o r·ªóng.';
            debugInfo.update(current => ({ ...current, 'thiduanv-pasted': newDebugInfo }));
            return { success: false, error: newDebugInfo.status, mainHeaders: [], subHeaders: [], dataRows: [] };
        }

        const lines = rawText.split('\n').map(line => line.trim()).filter(line => line.length > 0);
        const splitRegex = /\s{2,}|\t/; 
        const numberCheckRegex = /^-?[\d,.]+$/;

        const mainHeaderStartIndex = lines.findIndex(line => line.includes('Ph√≤ng ban'));
        const subHeaderStartIndex = lines.findIndex(line => line.startsWith('DTLK') || line.startsWith('SLLK') || line.startsWith('DTQƒê'));
        
        let dataEndIndex = lines.findIndex(line => line.includes('H·ªó tr·ª£ BI'));
        if (dataEndIndex === -1) {
            dataEndIndex = lines.length;
        }

        const dataRowsStartIndex = lines.findIndex((line, index) => {
            if (index <= subHeaderStartIndex) return false;
            const parts = line.split(splitRegex).map(p => p.trim());
            const firstPart = parts[0] || "";

            if (firstPart.startsWith('T·ªïng') || firstPart.startsWith('BP ') || firstPart.startsWith('DTLK') || firstPart.startsWith('SLLK') || firstPart.startsWith('DTQƒê')) {
               return false;
            }
            return parts.length > 1 && numberCheckRegex.test(parts[1]);
        });

        if (mainHeaderStartIndex === -1 || subHeaderStartIndex === -1 || dataRowsStartIndex === -1) {
            let error = "D·ªØ li·ªáu kh√¥ng h·ª£p l·ªá thi ƒëua ng√†nh h√†ng theo nh√¢n vi√™n, vui l√≤ng ki·ªÉm tra l·∫°i";
            newDebugInfo.status = error;
            debugInfo.update(current => ({ ...current, 'thiduanv-pasted': newDebugInfo }));
            return { success: false, error: error, mainHeaders: [], subHeaders: [], dataRows: [] };
        }
        
        const mainHeaderLines = lines.slice(mainHeaderStartIndex + 1, subHeaderStartIndex);
        const mainHeaderString = mainHeaderLines.join('\t');
        const mainHeaders = mainHeaderString.split(splitRegex).filter(Boolean);
        newDebugInfo.found.push({ name: 'Ti√™u ƒë·ªÅ ch√≠nh (Ng√†nh h√†ng)', value: `${mainHeaders.length} m·ª•c`, status: mainHeaders.length > 0 });

        const subHeaderLines = lines.slice(subHeaderStartIndex, dataRowsStartIndex);
        const subHeaderString = subHeaderLines.join('\t');
        const subHeaders = subHeaderString.split(/\s+/).filter(Boolean);
        newDebugInfo.found.push({ name: 'Ti√™u ƒë·ªÅ ph·ª• (SLLK/DTQƒê)', value: `${subHeaders.length} m·ª•c`, status: subHeaders.length > 0 });

        const potentialDataLines = lines.slice(dataRowsStartIndex, dataEndIndex);
        const dataRows = [];
        
        for (const line of potentialDataLines) {
            const parts = line.split(splitRegex).map(p => p.trim());
            const firstPart = parts[0] || "";

            if (firstPart.startsWith('T·ªïng') || firstPart.startsWith('BP ')) {
                continue;
            }

            if (parts.length > 1 && numberCheckRegex.test(parts[1])) {
                dataRows.push({
                    name: firstPart,
                    values: parts.slice(1)
                });
            }
        }
        newDebugInfo.found.push({ name: 'D√≤ng d·ªØ li·ªáu nh√¢n vi√™n', value: `${dataRows.length} d√≤ng`, status: dataRows.length > 0 });

        if (mainHeaders.length === 0 || subHeaders.length === 0 || dataRows.length === 0) {
            newDebugInfo.status = 'L·ªói: Kh√¥ng th·ªÉ ph√¢n t√≠ch d·ªØ li·ªáu. Thi·∫øu Ti√™u ƒë·ªÅ ch√≠nh, Ti√™u ƒë·ªÅ ph·ª•, ho·∫∑c D√≤ng d·ªØ li·ªáu (sau khi l·ªçc).';
            debugInfo.update(current => ({ ...current, 'thiduanv-pasted': newDebugInfo }));
            return { success: false, error: newDebugInfo.status, mainHeaders, subHeaders, dataRows };
        }
        
        const expectedDataCols = subHeaders.length;
        if (dataRows.length > 0 && dataRows[0].values.length !== expectedDataCols) {
             newDebugInfo.status = `C·∫£nh b√°o: S·ªë c·ªôt kh√¥ng kh·ªõp! Ti√™u ƒë·ªÅ ph·ª• (${expectedDataCols}) vs D·ªØ li·ªáu (${dataRows[0].values.length}).`;
        } else {
           newDebugInfo.status = `Ph√¢n t√≠ch th√†nh c√¥ng.`;
        }
        
        debugInfo.update(current => ({ ...current, 'thiduanv-pasted': newDebugInfo }));
        return { success: true, mainHeaders, subHeaders, dataRows };
    }
};
--- END FILE: ./src/services/processing/parsers.js ---

--- START FILE: ./src/services/processing/processors.js ---
// src/services/processing/processors.js
import { get } from 'svelte/store';
import { 
    danhSachNhanVien, employeeMaNVMap, competitionNameMappings, 
    debugInfo, rawGioCongData, employeeNameToMaNVMap 
} from '../../stores.js';
import { helpers } from './helpers.js';
import { normalizers } from './normalizers.js';

export const processors = {
    debugCompetitionFiltering(rawTestData) {
        if (!rawTestData || rawTestData.length === 0) return [];

        const { normalizedData } = normalizers.normalizeData(rawTestData, 'ycx');
        if (normalizedData.length === 0) return [];

        const hinhThucXuatTinhDoanhThu = helpers.getHinhThucXuatTinhDoanhThu();
        const debugResults = normalizedData.map(row => {
            const checks = {
                isDoanhThuHTX: hinhThucXuatTinhDoanhThu.has(row.hinhThucXuat),
                isThuTien: (row.trangThaiThuTien || "").trim() === 'ƒê√£ thu',
                isChuaHuy: (row.trangThaiHuy || "").trim() === 'Ch∆∞a h·ªßy',
                isChuaTra: (row.tinhTrangTra || "").trim() === 'Ch∆∞a tr·∫£',
                isDaXuat: (row.trangThaiXuat || "").trim() === 'ƒê√£ xu·∫•t'
            };
            const isOverallValid = checks.isDoanhThuHTX && checks.isThuTien && checks.isChuaHuy && checks.isChuaTra && checks.isDaXuat;
            return { rowData: row, checks: checks, isOverallValid: isOverallValid };
        });
        return debugResults;
    },

    // [M·ªöI] H√†m c·∫≠p nh·∫≠t store Mapping khi c√≥ d·ªØ li·ªáu paste m·ªõi
    updateCompetitionNameMappings(mainHeaders) {
        if (!mainHeaders || mainHeaders.length === 0) return;
        
        const oldMappings = get(competitionNameMappings) || {};
        const newMappings = { ...oldMappings };
        let hasChanges = false;

        mainHeaders.forEach(originalName => {
            // Ch·ªâ th√™m n·∫øu t√™n n√†y ch∆∞a t·ªìn t·∫°i trong mapping
            if (!newMappings.hasOwnProperty(originalName)) {
                // [Y√äU C·∫¶U] M·∫∑c ƒë·ªãnh ƒëi·ªÅn t√™n r√∫t g·ªçn = t√™n g·ªëc
                newMappings[originalName] = originalName; 
                hasChanges = true;
            }
        });

        if (hasChanges) {
            console.log("[Processors] Ph√°t hi·ªán t√™n thi ƒëua m·ªõi, c·∫≠p nh·∫≠t store mapping.");
            competitionNameMappings.set(newMappings);
            // L∆∞u √Ω: Ch√∫ng ta ch·ªâ c·∫≠p nh·∫≠t store ·ªü client. 
            // Admin s·∫Ω c·∫ßn v√†o tab Khai b√°o ƒë·ªÉ review v√† b·∫•m L∆∞u ƒë·ªÉ ƒë·∫©y l√™n Cloud.
        }
    },

    processThiDuaNhanVienData(parsedData, luykeCompetitionData) {
        const { mainHeaders, subHeaders, dataRows } = parsedData;
        const newDebugInfo = { required: [], found: [], status: 'ƒêang x·ª≠ l√Ω...' };
        
        const $danhSachNhanVien = get(danhSachNhanVien);
        if ($danhSachNhanVien.length === 0) {
            newDebugInfo.status = 'L·ªói: Danh s√°ch nh√¢n vi√™n (DSNV) ch∆∞a ƒë∆∞·ª£c t·∫£i l√™n.';
            debugInfo.update(current => ({ ...current, 'thiduanv-pasted': newDebugInfo }));
            return [];
        }
        if (mainHeaders.length === 0 || dataRows.length === 0 || subHeaders.length === 0) {
            newDebugInfo.status = 'L·ªói: D·ªØ li·ªáu d√°n v√†o kh√¥ng h·ª£p l·ªá.';
            debugInfo.update(current => ({ ...current, 'thiduanv-pasted': newDebugInfo }));
            return [];
        }

        // [QUAN TR·ªåNG] G·ªçi h√†m c·∫≠p nh·∫≠t mapping ngay khi x·ª≠ l√Ω d·ªØ li·ªáu
        this.updateCompetitionNameMappings(mainHeaders);

        const nameMappings = get(competitionNameMappings) || {};
        const competitionTargets = (luykeCompetitionData || []).map(comp => ({
            ...comp,
            cleanedName: helpers.cleanCompetitionName(comp.name)
        }));
        
        const finalReport = [];
        const totalEmployeesInDSNV = $danhSachNhanVien.length;
        const $employeeMaNVMap = get(employeeMaNVMap);

        dataRows.forEach(row => {
            const nameParts = row.name.split(' - ');
            const msnv = nameParts.length > 1 ? nameParts[nameParts.length - 1].trim() : null;

            let employee;
            if (msnv) {
                employee = $employeeMaNVMap.get(msnv);
            }

            if (!employee) {
                employee = { hoTen: row.name, maNV: msnv || 'N/A', boPhan: 'Nh√¢n vi√™n kh√¥ng t√¨m th·∫•y' };
            }

            const employeeResult = {
                maNV: employee.maNV,
                hoTen: employee.hoTen,
                boPhan: employee.boPhan,
                completedCount: 0,
                totalCompetitions: mainHeaders.length,
                competitions: []
            };

            for (let i = 0; i < mainHeaders.length; i++) {
                const originalName = mainHeaders[i];
                const loaiSoLieu = subHeaders[i];
                
                // [Y√äU C·∫¶U] L·∫•y t√™n r√∫t g·ªçn t·ª´ mapping, fallback v·ªÅ t√™n g·ªëc
                const shortName = nameMappings[originalName] || originalName;
                
                const cleanedName = helpers.cleanCompetitionName(originalName);
                const matchedTarget = competitionTargets.find(t => t.cleanedName === cleanedName);
                const groupTarget = matchedTarget ? matchedTarget.target : 0;
                const individualTarget = totalEmployeesInDSNV > 0 ? groupTarget / totalEmployeesInDSNV : 0;

                const giaTri = parseFloat(String(row.values[i] || '0').replace(/,/g, '')) || 0;
                const actualSales = giaTri;
                const percentExpected = individualTarget > 0 ? actualSales / individualTarget : (actualSales > 0 ? Infinity : 0);
                
                if (percentExpected >= 1) employeeResult.completedCount++;

                employeeResult.competitions.push({
                    tenNganhHang: shortName, // D√πng t√™n r√∫t g·ªçn cho hi·ªÉn th·ªã
                    tenGoc: originalName,    // Gi·ªØ t√™n g·ªëc ƒë·ªÉ ƒë·ªëi chi·∫øu
                    loaiSoLieu: loaiSoLieu,
                    giaTri: giaTri,
                    thucHien: actualSales,
                    mucTieu: individualTarget,
                    percentExpected: percentExpected,
                });
            }

            employeeResult.completionRate = employeeResult.totalCompetitions > 0 ? employeeResult.completedCount / employeeResult.totalCompetitions : 0;
            finalReport.push(employeeResult);
        });

        newDebugInfo.status = `Th√†nh c√¥ng: ƒê√£ x·ª≠ l√Ω b√°o c√°o cho ${finalReport.length} nh√¢n vi√™n.`;
        debugInfo.update(current => ({ ...current, 'thiduanv-pasted': newDebugInfo }));
        return finalReport;
    },

    processGioCongData: () => {
        const gioCongByMSNV = {};
        let currentMaNV = null;
        if (!get(rawGioCongData) || get(rawGioCongData).length === 0) return gioCongByMSNV;

        for (const row of get(rawGioCongData)) {
            const maNV = String(row.maNV || '').trim();
            const hoTen = String(row.hoTen || '').trim().replace(/\s+/g, ' ');
            let foundMaNV = maNV || get(employeeNameToMaNVMap).get(hoTen.toLowerCase()) || null;
            if (foundMaNV) currentMaNV = foundMaNV;

            if (currentMaNV && gioCongByMSNV[currentMaNV] === undefined) {
                gioCongByMSNV[currentMaNV] = 0;
            }

            const gioCongValue = parseFloat(String(row.tongGioCong || '0').replace(/,/g, '')) || 0;
            if (currentMaNV && gioCongValue > 0) {
                gioCongByMSNV[currentMaNV] += gioCongValue;
            }
        }
        return gioCongByMSNV;
    },

    processThiDuaVungFile(workbook) {
        const sheetNames = workbook.SheetNames;
        
        const chiTietSheetName = sheetNames.find(name => {
            const upperName = name.toUpperCase();
            return upperName.includes('CHITIET') || upperName.includes('CHI TI·∫æT');
        });
        
        const tongSheetName = sheetNames.find(name => {
            const upperName = name.toUpperCase();
            return upperName.includes('TONG') || upperName.includes('SIEU THI');
        });

        const chiTietSheet = chiTietSheetName ? workbook.Sheets[chiTietSheetName] : null;
        const tongSheet = tongSheetName ? workbook.Sheets[tongSheetName] : null;

        if (!chiTietSheet || !tongSheet) {
            throw new Error('File Excel ph·∫£i ch·ª©a sheet (CHITIET/CHI TI·∫æT) v√† (TONG/SIEU THI).');
        }
        
        const chiTietData = helpers.findHeaderAndProcess(chiTietSheet, ['si√™u th·ªã', 'ng√†nh h√†ng', 'k√™nh']);
        const tongData = helpers.findHeaderAndProcess(tongSheet, ['si√™u th·ªã', 't·ªïng th∆∞·ªüng']);

        return { chiTietData, tongData };
    }
};
--- END FILE: ./src/services/processing/processors.js ---

--- START FILE: ./src/services/reports/competition.report.js ---
// src/services/reports/competition.report.js
// Version 1.0 - Competition logic
import { get } from 'svelte/store';
import * as utils from '../../utils.js';
import { dataProcessing } from '../dataProcessing.js';
import {
    danhSachNhanVien,
    specialProductList,
    thiDuaVungChiTiet,
    thiDuaVungTong
} from '../../stores.js';

export const competitionReportLogic = {
    calculateSpecialProductReport(sourceYcxData, specialProgramConfigs) {
        const $specialProductList = get(specialProductList);
        if (!sourceYcxData || sourceYcxData.length === 0 ||
            !specialProgramConfigs || specialProgramConfigs.length === 0 ||
            !$specialProductList || $specialProductList.length === 0) {
            return [];
        }

        const hinhThucXuatTinhDoanhThu = dataProcessing.getHinhThucXuatTinhDoanhThu();
        const validSalesData = sourceYcxData.filter(row => {
            const isDoanhThuHTX = hinhThucXuatTinhDoanhThu.has(row.hinhThucXuat);
            const isBaseValid = (row.trangThaiThuTien || "").trim() === 'ƒê√£ thu' &&
                                (row.trangThaiHuy || "").trim() === 'Ch∆∞a h·ªßy' &&
                                (row.tinhTrangTra || "").trim() === 'Ch∆∞a tr·∫£' &&
                                (row.trangThaiXuat || "").trim() === 'ƒê√£ xu·∫•t';
            return isBaseValid && isDoanhThuHTX;
        });
        if (validSalesData.length === 0) return [];

        const $danhSachNhanVien = get(danhSachNhanVien);
        const report = specialProgramConfigs.map(program => {
            const programGroups = new Set((program.groups || []).map(g => String(g).trim()));
            if (programGroups.size === 0) return null;

            const specialProductSet = new Set(
                $specialProductList
                    .filter(sp => programGroups.has(String(sp.nhomHang).trim()))
                    .map(sp => String(sp.maSanPham).trim())
            );

            const totalGroupSales = validSalesData.filter(row => 
                programGroups.has(String(row.nhomHang).trim())
            );
    
            if (totalGroupSales.length === 0) return null;

            const employeeResults = $danhSachNhanVien.map(employee => {
                const stats = { slDacQuyen: 0, slNhomHang: 0, dtDacQuyen: 0, dtNhomHang: 0 };
                const employeeSales = totalGroupSales.filter(row => {
                    const msnvMatch = String(row.nguoiTao || '').match(/(\d+)/);
                    return msnvMatch && msnvMatch[1].trim() === employee.maNV;
                });
                if (employeeSales.length === 0) {
                    return { ...employee, ...stats, tyLeSL: 0, tyLeDT: 0 };
                }

                employeeSales.forEach(row => {
                    const maSanPham = String(row.maSanPham || '').trim();
                    const thanhTien = parseFloat(String(row.thanhTien || "0").replace(/,/g, '')) || 0;
                    const soLuong = parseInt(String(row.soLuong || "0"), 10) || 0;

                    stats.slNhomHang += soLuong;
                    stats.dtNhomHang += thanhTien;

                    if (specialProductSet.has(maSanPham)) {
                        stats.slDacQuyen += soLuong;
                        stats.dtDacQuyen += thanhTien;
                    }
                });
                const tyLeSL = stats.slNhomHang > 0 ? (stats.slDacQuyen / stats.slNhomHang) : 0;
                const tyLeDT = stats.dtNhomHang > 0 ? (stats.dtDacQuyen / stats.dtNhomHang) : 0;

                return {
                    maNV: employee.maNV,
                    hoTen: employee.hoTen,
                    boPhan: employee.boPhan,
                    ...stats,
                    tyLeSL,
                    tyLeDT
                };
            }).filter(e => e.slNhomHang > 0); 

            return {
                program: program,
                employeeData: employeeResults,
            };
        }).filter(Boolean); 

        return report;
    },

    calculateCompetitionFocusReport(sourceYcxData, competitionConfigs) {
        if (!sourceYcxData || sourceYcxData.length === 0 || !competitionConfigs || competitionConfigs.length === 0) {
            return [];
        }

        const hinhThucXuatTinhDoanhThu = dataProcessing.getHinhThucXuatTinhDoanhThu();
        const validSalesData = sourceYcxData.filter(row => {
            const isDoanhThuHTX = hinhThucXuatTinhDoanhThu.has(row.hinhThucXuat);
            const isBaseValid = (row.trangThaiThuTien || "").trim() === 'ƒê√£ thu' &&
                                 (row.trangThaiHuy || "").trim() === 'Ch∆∞a h·ªßy' &&
                                 (row.tinhTrangTra || "").trim() === 'Ch∆∞a tr·∫£' &&
                                (row.trangThaiXuat || "").trim() === 'ƒê√£ xu·∫•t';
            return isBaseValid && isDoanhThuHTX;
        });
        const $danhSachNhanVien = get(danhSachNhanVien);

        const report = competitionConfigs.map(config => {
            const cleanedConfigGroups = new Set((config.groups || []).map(g => utils.cleanCategoryName(g)));

            let baseSalesData = validSalesData.filter(row => {
                const cleanNhomHangFromYCX = utils.cleanCategoryName(row.nhomHang);
                const isInGroup = cleanedConfigGroups.has(cleanNhomHangFromYCX);
                
                if (!isInGroup) return false;

                if (config.type === 'soluong' && (config.minPrice > 0 || config.maxPrice > 0)) {
                    const price = (parseFloat(String(row.thanhTien || "0").replace(/,/g, '')) || 0) / (parseInt(String(row.soLuong || "1"), 10) || 1);
                    const minPrice = config.minPrice || 0;
                    const maxPrice = config.maxPrice || Infinity;
                    if (price < minPrice || price > maxPrice) return false;
                }
                return true;
            });

            if (config.excludeApple) {
                baseSalesData = baseSalesData.filter(row => row.nhaSanXuat !== 'Apple');
            }

            const employeeResults = $danhSachNhanVien.map(employee => {
                let performanceByBrand = {};
                let totalTargetRevenue = 0;
                let totalTargetQuantity = 0;
                let baseCategoryRevenue = 0;
                let baseCategoryQuantity = 0;

                baseSalesData.forEach(row => {
                    const msnvMatch = String(row.nguoiTao || '').match(/(\d+)/);
                     if (msnvMatch && msnvMatch[1].trim() === employee.maNV) {
                        const revenueValue = (parseFloat(String(row.thanhTien || "0").replace(/,/g, '')) || 0);
                        const quantityValue = (parseInt(String(row.soLuong || "0"), 10) || 0);

                        baseCategoryRevenue += revenueValue;
                        baseCategoryQuantity += quantityValue;

                        const brand = row.nhaSanXuat;
                        if ((config.brands || []).includes(brand)) {
                            if (!performanceByBrand[brand]) {
                                performanceByBrand[brand] = { revenue: 0, quantity: 0 };
                            }
                            performanceByBrand[brand].revenue += revenueValue;
                            performanceByBrand[brand].quantity += quantityValue;

                            totalTargetRevenue += revenueValue;
                            totalTargetQuantity += quantityValue;
                        }
                    }
                });
                return {
                    maNV: employee.maNV,
                    hoTen: employee.hoTen,
                    boPhan: employee.boPhan,
                    performanceByBrand,
                    targetBrandsRevenue: totalTargetRevenue,
                    targetBrandsQuantity: totalTargetQuantity,
                    baseCategoryRevenue,
                    baseCategoryQuantity,
                    tyLeDT: baseCategoryRevenue > 0 ? (totalTargetRevenue / baseCategoryRevenue) : 0,
                    tyLeSL: baseCategoryQuantity > 0 ? (totalTargetQuantity / baseCategoryQuantity) : 0,
                };
            }).filter(e => e.baseCategoryRevenue > 0 || e.baseCategoryQuantity > 0);

            return {
                competition: config,
                employeeData: employeeResults,
            };
        }).filter(r => r.employeeData.length > 0);

        return report;
    },

    generateThiDuaVungReport(selectedSupermarket) {
        const $thiDuaVungChiTiet = get(thiDuaVungChiTiet);
        const $thiDuaVungTong = get(thiDuaVungTong);

        if (!selectedSupermarket || !$thiDuaVungChiTiet || $thiDuaVungChiTiet.length === 0 || !$thiDuaVungTong || $thiDuaVungTong.length === 0) {
            return null;
        }

        const findKey = (data, keyword) => {
            if (!data || data.length === 0) return null;
            return Object.keys(data[0]).find(k => k.trim().toLowerCase().includes(keyword.toLowerCase())) || keyword;
        };
        const supermarketKeyTong = findKey($thiDuaVungTong, 'si√™u th·ªã');
        const supermarketKeyChiTiet = findKey($thiDuaVungChiTiet, 'si√™u th·ªã');
        const tongThuongKey = findKey($thiDuaVungChiTiet, 't·ªïng th∆∞·ªüng');
        const hangVuotTroiKey = findKey($thiDuaVungChiTiet, 'h·∫°ng v∆∞·ª£t tr·ªôi');
        const hangTargetKey = findKey($thiDuaVungChiTiet, 'h·∫°ng % target');
        const layTopKey = findKey($thiDuaVungChiTiet, 'l·∫•y top');
        const kenhKey = findKey($thiDuaVungChiTiet, 'k√™nh');
        const nganhHangKey = findKey($thiDuaVungChiTiet, 'ng√†nh h√†ng');

        if (!supermarketKeyTong || !supermarketKeyChiTiet) {
            console.error("Kh√¥ng th·ªÉ t√¨m th·∫•y c·ªôt 'si√™u th·ªã' trong d·ªØ li·ªáu.");
            return null;
        }

        const summary = $thiDuaVungTong.find(row => row[supermarketKeyTong] === selectedSupermarket);
        if (!summary) return null;

        const chiTiet = $thiDuaVungChiTiet.filter(row => row[supermarketKeyChiTiet] === selectedSupermarket);

        if (chiTiet.length > 0 && layTopKey) {
            summary.hangCoGiaiKenh = chiTiet[0][layTopKey];
        } else {
            summary.hangCoGiaiKenh = 'N/A';
        }

        const report = { summary, coGiai: [], sapCoGiai: [], tiemNang: [], canCoGangNhieu: [] };

        const getPotentialPrize = (kenh, nganhHang) => {
            const winningSupermarkets = $thiDuaVungChiTiet.filter(sm =>
                sm[kenhKey] === kenh && sm[nganhHangKey] === nganhHang && sm[tongThuongKey] > 0
            );
            if (winningSupermarkets.length === 0) return 0;
            return Math.min(...winningSupermarkets.map(s => s[tongThuongKey]));
        };

        chiTiet.forEach(nganhHang => {
            if (nganhHang[tongThuongKey] > 0) {
                report.coGiai.push(nganhHang);
            } else {
                const hangVuotTroi = nganhHang[hangVuotTroiKey] || Infinity;
                const hangTarget = nganhHang[hangTargetKey] || Infinity;
                const hangCoGiai = nganhHang[layTopKey] || 0;

                const khoangCach = Math.min(
                    (hangVuotTroi > 0 && hangVuotTroi > hangCoGiai) ? hangVuotTroi - hangCoGiai : Infinity,
                    (hangTarget > 0 && hangTarget > hangCoGiai) ? hangTarget - hangCoGiai : Infinity
                );
                nganhHang.khoangCach = khoangCach;

                if (hangCoGiai > 0 && khoangCach <= 20) {
                    nganhHang.thuongTiemNang = getPotentialPrize(nganhHang[kenhKey], nganhHang[nganhHangKey]);
                    report.sapCoGiai.push(nganhHang);
                } else if (hangCoGiai > 0 && khoangCach > 20 && khoangCach <= 40) {
                    report.tiemNang.push(nganhHang);
                } else {
                    report.canCoGangNhieu.push(nganhHang);
                }
            }
        });

        report.coGiai.sort((a, b) => b[tongThuongKey] - a[tongThuongKey]);
        report.sapCoGiai.sort((a, b) => a.khoangCach - b.khoangCach);
        report.tiemNang.sort((a, b) => a.khoangCach - b.khoangCach);

        return report;
    }
};
--- END FILE: ./src/services/reports/competition.report.js ---

--- START FILE: ./src/services/reports/detail.report.js ---
// src/services/reports/detail.report.js
// Version 1.0 - Detail views logic
import { get } from 'svelte/store';
import * as utils from '../../utils.js';
import { formatters } from '../../utils/formatters.js';
import { dataProcessing } from '../dataProcessing.js';
import { masterReportData } from '../../stores.js';

export const detailReportLogic = {
    generateRealtimeEmployeeDetailReport(employeeMaNV, realtimeYCXData) {
        if (!employeeMaNV || !realtimeYCXData || realtimeYCXData.length === 0) return null;

        const employeeData = realtimeYCXData.filter(row => {
            const msnvMatch = String(row.nguoiTao || '').match(/(\d+)/);
            return msnvMatch && msnvMatch[1].trim() === String(employeeMaNV);
        });

        if (employeeData.length === 0) return null;

        const hinhThucXuatTinhDoanhThu = dataProcessing.getHinhThucXuatTinhDoanhThu();
        const heSoQuyDoi = dataProcessing.getHeSoQuyDoi();

        const summary = {
            totalRealRevenue: 0,
            totalConvertedRevenue: 0,
            unexportedRevenue: 0
        };
        const byProductGroup = {};
        const byCustomer = {};

        employeeData.forEach(row => {
            const isDoanhThuHTX = hinhThucXuatTinhDoanhThu.has(row.hinhThucXuat);
            const isBaseValid = (row.trangThaiThuTien || "").trim() === 'ƒê√£ thu' && (row.trangThaiHuy || "").trim() === 'Ch∆∞a h·ªßy' && (row.tinhTrangTra || "").trim() === 'Ch∆∞a tr·∫£';

            if (isDoanhThuHTX && isBaseValid) {
                const realRevenue = parseFloat(String(row.thanhTien || "0").replace(/,/g, '')) || 0;
                const quantity = parseInt(String(row.soLuong || "0"), 10) || 0;
                const heSo = heSoQuyDoi[row.nhomHang] || 1;
                const convertedRevenue = realRevenue * heSo;
                const groupName = utils.cleanCategoryName(row.nhomHang || 'Kh√°c');
                const customerName = row.tenKhachHang || 'Kh√°ch l·∫ª';

                if ((row.trangThaiXuat || "").trim() === 'ƒê√£ xu·∫•t') {
                    summary.totalRealRevenue += realRevenue;
                    summary.totalConvertedRevenue += convertedRevenue;

                    if (!byProductGroup[groupName]) {
                        byProductGroup[groupName] = { name: groupName, quantity: 0, realRevenue: 0, convertedRevenue: 0 };
                    }
                    byProductGroup[groupName].quantity += quantity;
                    byProductGroup[groupName].realRevenue += realRevenue;
                    byProductGroup[groupName].convertedRevenue += convertedRevenue;

                    if (!byCustomer[customerName]) {
                        byCustomer[customerName] = { name: customerName, products: [], totalQuantity: 0 };
                    }
                    byCustomer[customerName].products.push({
                        productName: row.tenSanPham,
                        quantity: quantity,
                        realRevenue: realRevenue,
                        convertedRevenue: convertedRevenue,
                    });
                    byCustomer[customerName].totalQuantity += quantity;
                } else if ((row.trangThaiXuat || "").trim() === 'Ch∆∞a xu·∫•t') {
                    summary.unexportedRevenue += convertedRevenue;
                }
            }
        });

        summary.totalOrders = Object.keys(byCustomer).length;
        summary.bundledOrderCount = Object.values(byCustomer).filter(c => c.totalQuantity > 1).length;
        summary.conversionRate = summary.totalRealRevenue > 0 ? (summary.totalConvertedRevenue / summary.totalRealRevenue) - 1 : 0;

        return {
            summary,
            byProductGroup: Object.values(byProductGroup).sort((a, b) => b.realRevenue - a.realRevenue),
            byCustomer: Object.values(byCustomer)
        };
    },

    generateLuyKeEmployeeDetailReport(employeeMaNV, luykeYCXData) {
        if (!employeeMaNV || !luykeYCXData || luykeYCXData.length === 0) {
            return null;
        }

        const employeeData = luykeYCXData.filter(row => {
            const msnvMatch = String(row.nguoiTao || '').match(/(\d+)/);
            return msnvMatch && msnvMatch[1].trim() === String(employeeMaNV);
        });

        if (employeeData.length === 0) {
             return null;
        }

        const hinhThucXuatTinhDoanhThu = dataProcessing.getHinhThucXuatTinhDoanhThu();
        const heSoQuyDoi = dataProcessing.getHeSoQuyDoi();

        const summary = {
            totalRealRevenue: 0,
            totalConvertedRevenue: 0,
            unexportedRevenue: 0, 
        };
        const byProductGroup = {};
        const byCustomer = {};
        const categoryChartDataMap = {};
        const dailyStats = {}; 
        const unexportedDetails = {};
        
        const $masterReportData = get(masterReportData);
        const employeeMasterData = $masterReportData.sknv.find(e => String(e.maNV) === String(employeeMaNV));
        if (employeeMasterData) {
            summary.unexportedRevenue = employeeMasterData.doanhThuChuaXuat || 0;
        }

        employeeData.forEach(row => {
            const isDoanhThuHTX = hinhThucXuatTinhDoanhThu.has(row.hinhThucXuat);
            const isBaseValid = (row.trangThaiThuTien || "").trim() === 'ƒê√£ thu' &&
                                (row.trangThaiHuy || "").trim() === 'Ch∆∞a h·ªßy' &&
                                (row.tinhTrangTra || "").trim() === 'Ch∆∞a tr·∫£';

            if (isDoanhThuHTX && isBaseValid) {
                const realRevenue = parseFloat(String(row.thanhTien || "0").replace(/,/g, '')) || 0;
                const quantity = parseInt(String(row.soLuong || "0"), 10) || 0;
                if(isNaN(realRevenue) || isNaN(quantity)) return;

                const heSo = heSoQuyDoi[row.nhomHang] || 1;
                const convertedRevenue = realRevenue * heSo;
                const groupName = utils.cleanCategoryName(row.nhomHang || 'Kh√°c');
                const customerName = row.tenKhachHang || 'Kh√°ch L·∫ª';
                const categoryName = utils.cleanCategoryName(row.nganhHang || 'Kh√°c');
                const productName = row.tenSanPham || 'Kh√¥ng r√µ';
                
                if ((row.trangThaiXuat || "").trim() === 'ƒê√£ xu·∫•t') {
                    summary.totalRealRevenue += realRevenue;
                    summary.totalConvertedRevenue += convertedRevenue;

                    if (!byProductGroup[groupName]) {
                        byProductGroup[groupName] = { name: groupName, quantity: 0, realRevenue: 0, convertedRevenue: 0 };
                    }
                    byProductGroup[groupName].quantity += quantity;
                    byProductGroup[groupName].realRevenue += realRevenue;
                    byProductGroup[groupName].convertedRevenue += convertedRevenue;

                    if (!categoryChartDataMap[categoryName]) {
                        categoryChartDataMap[categoryName] = { name: categoryName, revenue: 0 };
                    }
                    categoryChartDataMap[categoryName].revenue += realRevenue;
                    if (!byCustomer[customerName]) {
                        byCustomer[customerName] = { name: customerName, products: [], totalQuantity: 0, totalRealRevenue: 0, totalConvertedRevenue: 0 };
                    }
                    byCustomer[customerName].products.push({
                        productName: row.tenSanPham,
                        quantity: quantity,
                        realRevenue: realRevenue,
                        convertedRevenue: convertedRevenue,
                    });
                    byCustomer[customerName].totalQuantity += quantity;
                    byCustomer[customerName].totalRealRevenue += realRevenue;
                    byCustomer[customerName].totalConvertedRevenue += convertedRevenue;
                    
                    const ngayTao = row.ngayTao;
                    if (ngayTao instanceof Date) {
                        const dateString = ngayTao.toISOString().split('T')[0];
                        if (!dailyStats[dateString]) {
                            dailyStats[dateString] = { date: ngayTao, revenue: 0, convertedRevenue: 0 };
                        }
                        dailyStats[dateString].revenue += realRevenue;
                        dailyStats[dateString].convertedRevenue += convertedRevenue;
                    }

                } else if ((row.trangThaiXuat || "").trim() === 'Ch∆∞a xu·∫•t') {
                    if (!unexportedDetails[groupName]) {
                        unexportedDetails[groupName] = { name: groupName, totalSL: 0, totalDTQD: 0, products: {} };
                    }
                    if (!unexportedDetails[groupName].products[productName]) {
                        unexportedDetails[groupName].products[productName] = { name: productName, sl: 0, dtqd: 0 };
                    }
                    unexportedDetails[groupName].products[productName].sl += quantity;
                    unexportedDetails[groupName].products[productName].dtqd += convertedRevenue;
                    unexportedDetails[groupName].totalSL += quantity;
                    unexportedDetails[groupName].totalDTQD += convertedRevenue;
                }
            }
        });

        summary.totalOrders = Object.keys(byCustomer).length;
        summary.bundledOrderCount = Object.values(byCustomer).filter(c => c.products.length > 1).length;
        summary.conversionRate = summary.totalRealRevenue > 0 ? (summary.totalConvertedRevenue / summary.totalRealRevenue) - 1 : 0;

        for (const customerName in byCustomer) {
            const customer = byCustomer[customerName];
            customer.conversionRate = customer.totalRealRevenue > 0 ? (customer.totalConvertedRevenue / customer.totalRealRevenue) - 1 : 0;
        }
        for (const groupName in byProductGroup) {
            const group = byProductGroup[groupName];
            group.conversionRate = group.realRevenue > 0 ? (group.convertedRevenue / group.realRevenue) - 1 : 0;
        }

        const finalDailyStats = Object.values(dailyStats).sort((a, b) => a.date - b.date);
        const finalUnexportedDetails = Object.values(unexportedDetails)
            .map(group => ({
                ...group,
                products: Object.values(group.products).sort((a, b) => b.dtqd - a.dtqd)
            }))
            .sort((a, b) => b.totalDTQD - a.totalDTQD);

        return {
            summary,
            topProductGroups: Object.values(byProductGroup)
                .sort((a, b) => b.realRevenue - a.realRevenue)
                .slice(0, 8),
            categoryChartData: Object.values(categoryChartDataMap),
            byCustomer: Object.values(byCustomer)
                .sort((a,b) => b.totalRealRevenue - a.totalRealRevenue),
            dailyStats: finalDailyStats, 
            unexportedDetails: finalUnexportedDetails 
        };
    }
};
--- END FILE: ./src/services/reports/detail.report.js ---

--- START FILE: ./src/services/reports/general.report.js ---
// src/services/reports/general.report.js
// Version 1.0 - General reports (Brand, Unexported)
import { get } from 'svelte/store';
import * as utils from '../../utils.js';
import { dataProcessing } from '../dataProcessing.js';
import { employeeMaNVMap } from '../../stores.js';

export const generalReportLogic = {
    generateRealtimeBrandReport(realtimeYCXData, selectedCategory, selectedBrand) {
        if (!realtimeYCXData || realtimeYCXData.length === 0) return { byBrand: [], byEmployee: [] };
        
        const $employeeMaNVMap = get(employeeMaNVMap);

        const filteredData = realtimeYCXData.filter(row => {
            const categoryMatch = !selectedCategory || utils.cleanCategoryName(row.nganhHang) === selectedCategory;
            const brandMatch = !selectedBrand || (row.nhaSanXuat || 'H√£ng kh√°c') === selectedBrand;
            const isDoanhThuHTX = dataProcessing.getHinhThucXuatTinhDoanhThu().has(row.hinhThucXuat);
            const isBaseValid = (row.trangThaiThuTien || "").trim() === 'ƒê√£ thu' && (row.trangThaiHuy || "").trim() === 'Ch∆∞a h·ªßy' && (row.tinhTrangTra || "").trim() === 'Ch∆∞a tr·∫£' && (row.trangThaiXuat || "").trim() === 'ƒê√£ xu·∫•t';

            return categoryMatch && brandMatch && isDoanhThuHTX && isBaseValid;
        });

        const byBrand = {};
        const byEmployee = {};

        filteredData.forEach(row => {
            const brand = row.nhaSanXuat || 'H√£ng kh√°c';
            const msnvMatch = String(row.nguoiTao || '').match(/(\d+)/);
            const employeeId = msnvMatch ? msnvMatch[1].trim() : 'Unknown';
            const realRevenue = parseFloat(String(row.thanhTien || "0").replace(/,/g, '')) || 0;
            const quantity = parseInt(String(row.soLuong || "0"), 10) || 0;

            if (!byBrand[brand]) {
                byBrand[brand] = { name: brand, quantity: 0, revenue: 0 };
            }
            byBrand[brand].quantity += quantity;
            byBrand[brand].revenue += realRevenue;

            if (!byEmployee[employeeId]) {
                const employeeInfo = $employeeMaNVMap.get(employeeId);
                byEmployee[employeeId] = { id: employeeId, name: employeeInfo ? employeeInfo.hoTen : `NV ${employeeId}`, quantity: 0, revenue: 0 };
            }
            byEmployee[employeeId].quantity += quantity;
            byEmployee[employeeId].revenue += realRevenue;
        });

        const brandArray = Object.values(byBrand).map(b => ({...b, avgPrice: b.quantity > 0 ? b.revenue / b.quantity : 0})).sort((a,b) => b.revenue - a.revenue);
        const employeeArray = Object.values(byEmployee).sort((a,b) => b.revenue - a.revenue);

        return { byBrand: brandArray, byEmployee: employeeArray };
    },

    generateLuyKeChuaXuatReport(sourceYcxData) {
        if (!sourceYcxData || sourceYcxData.length === 0) return [];

        const hinhThucXuatTinhDoanhThu = dataProcessing.getHinhThucXuatTinhDoanhThu();
        const heSoQuyDoi = dataProcessing.getHeSoQuyDoi();
        const report = {};

        sourceYcxData.forEach(row => {
            const isDoanhThuHTX = hinhThucXuatTinhDoanhThu.has(row.hinhThucXuat);
            const isBaseValid = (row.trangThaiThuTien || "").trim() === 'ƒê√£ thu' &&
                                (row.trangThaiHuy || "").trim() === 'Ch∆∞a h·ªßy' &&
                                (row.tinhTrangTra || "").trim() === 'Ch∆∞a tr·∫£' &&
                                (row.trangThaiXuat || "").trim() === 'Ch∆∞a xu·∫•t';

            if (isBaseValid && isDoanhThuHTX) {
                const thanhTien = parseFloat(String(row.thanhTien || "0").replace(/,/g, '')) || 0;
                const soLuong = parseInt(String(row.soLuong || "0"), 10) || 0;
                if (isNaN(thanhTien) || isNaN(soLuong)) return;

                const nganhHangName = utils.cleanCategoryName(row.nganhHang);
                const heSo = heSoQuyDoi[row.nhomHang] || 1;

                if (!report[nganhHangName]) {
                    report[nganhHangName] = {
                        nganhHang: nganhHangName,
                        soLuong: 0,
                        doanhThuThuc: 0,
                        doanhThuQuyDoi: 0
                    };
                }

                report[nganhHangName].soLuong += soLuong;
                report[nganhHangName].doanhThuThuc += thanhTien;
                report[nganhHangName].doanhThuQuyDoi += thanhTien * heSo;
            }
        });

        return Object.values(report);
    },

    generateRealtimeChuaXuatReport(sourceRealtimeYcxData) {
        if (!sourceRealtimeYcxData || sourceRealtimeYcxData.length === 0) return [];

        const hinhThucXuatTinhDoanhThu = dataProcessing.getHinhThucXuatTinhDoanhThu();
        const heSoQuyDoi = dataProcessing.getHeSoQuyDoi();
        const report = {};

        sourceRealtimeYcxData.forEach(row => {
            const isDoanhThuHTX = hinhThucXuatTinhDoanhThu.has(row.hinhThucXuat);
            const isBaseValid = (row.trangThaiThuTien || "").trim() === 'ƒê√£ thu' &&
                                (row.trangThaiHuy || "").trim() === 'Ch∆∞a h·ªßy' &&
                                (row.tinhTrangTra || "").trim() === 'Ch∆∞a tr·∫£' &&
                                (row.trangThaiXuat || "").trim() === 'Ch∆∞a xu·∫•t';

            if (isBaseValid && isDoanhThuHTX) {
                const thanhTien = parseFloat(String(row.thanhTien || "0").replace(/,/g, '')) || 0;
                const soLuong = parseInt(String(row.soLuong || "0"), 10) || 0;
                if (isNaN(thanhTien) || isNaN(soLuong)) return;

                const nganhHangName = utils.cleanCategoryName(row.nganhHang);
                const heSo = heSoQuyDoi[row.nhomHang] || 1;

                if (!report[nganhHangName]) {
                    report[nganhHangName] = {
                        nganhHang: nganhHangName,
                        soLuong: 0,
                        doanhThuThuc: 0,
                        doanhThuQuyDoi: 0
                    };
                }

                report[nganhHangName].soLuong += soLuong;
                report[nganhHangName].doanhThuThuc += thanhTien;
                report[nganhHangName].doanhThuQuyDoi += thanhTien * heSo;
            }
        });

        return Object.values(report);
    }
};
--- END FILE: ./src/services/reports/general.report.js ---

--- START FILE: ./src/services/reports/master.report.js ---
// src/services/reports/master.report.js
// Version 5.0 - Full Explicit Logic: Hardcode IDs + Dynamic Keywords (No Refactoring/Shortcuts)
import { get } from 'svelte/store';
import { config } from '../../config.js';
import * as utils from '../../utils.js';
import { dataProcessing } from '../dataProcessing.js';
import {
    danhSachNhanVien,
    employeeNameToMaNVMap,
    thuongNongData,
    thuongERPData,
    thuongNongDataThangTruoc,
    thuongERPDataThangTruoc,
    macroCategoryConfig,
    macroProductGroupConfig,
    efficiencyConfig
} from '../../stores.js';

// Helper chu·∫©n h√≥a chu·ªói
const normalize = (str) => {
    if (!str) return '';
    return str.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "").trim();
};

export const masterReportLogic = {
    generateMasterReportData: (sourceData, goalSettings, isRealtime = false) => {
        const $danhSachNhanVien = get(danhSachNhanVien);
        if (!$danhSachNhanVien || $danhSachNhanVien.length === 0) return [];

        const hinhThucXuatTinhDoanhThu = dataProcessing.getHinhThucXuatTinhDoanhThu();
        const hinhThucXuatTraGop = dataProcessing.getHinhThucXuatTraGop();
        const heSoQuyDoi = dataProcessing.getHeSoQuyDoi();
        const PG = config.PRODUCT_GROUPS; // L·∫•y danh s√°ch ID c·ª©ng (1491, 42...)
        const gioCongByMSNV = dataProcessing.processGioCongData();
        
        // 1. Load C·∫•u h√¨nh t·ª´ Admin
        const $macroProductGroupConfig = get(macroProductGroupConfig) || [];
        const $macroCategoryConfig = get(macroCategoryConfig) || [];
        const $efficiencyConfig = get(efficiencyConfig) || [];

        // 2. X√¢y d·ª±ng b·ªô t·ª´ kh√≥a Dynamic t·ª´ Admin
        // (V·∫´n gi·ªØ logic n√†y ƒë·ªÉ b·∫Øt c√°c nh√≥m h√†ng m·ªõi t·∫°o)
        const uiKeywords = {
            dtICT: [], dtCE: [], dtPhuKien: [], dtGiaDung: [],
            dtMLN: [], dtSim: [], dtVAS: [], dtBaoHiem: []
        };
        const uiIdentity = {
            dtICT: ['ict', 'ƒëi·ªán tho·∫°i', 'laptop', 'tablet'],
            dtCE: ['ce', 'ƒëi·ªán t·ª≠', 'tivi', 'loa', '√¢m thanh'],
            dtPhuKien: ['ph·ª• ki·ªán', 'pk'],
            dtGiaDung: ['gia d·ª•ng', 'gd'],
            dtMLN: ['m√°y l·ªçc n∆∞·ªõc', 'mln', 'l·ªçc n∆∞·ªõc'],
            dtSim: ['sim', 'th·∫ª c√†o'],
            dtVAS: ['vas', 'd·ªãch v·ª•'],
            dtBaoHiem: ['b·∫£o hi·ªÉm', 'r∆°i v·ª°']
        };

        const loadKeywords = (configs) => {
            if (!Array.isArray(configs)) return;
            configs.forEach(group => {
                const groupName = normalize(group.name);
                for (const [uiKey, ids] of Object.entries(uiIdentity)) {
                    if (ids.some(id => groupName.includes(id))) {
                        if (group.items) group.items.forEach(i => uiKeywords[uiKey].push(normalize(i)));
                    }
                }
            });
        };
        loadKeywords($macroProductGroupConfig);
        loadKeywords($macroCategoryConfig);

        // Map cho Ch·ªâ s·ªë ƒë·ªông (Dynamic Metrics)
        const macroToItemsMap = {};
        const buildMacroMap = (configs) => {
            if (Array.isArray(configs)) {
                configs.forEach(macro => {
                    if (macro.items && Array.isArray(macro.items)) {
                        macroToItemsMap[normalize(macro.name)] = macro.items.map(i => normalize(i));
                    }
                });
            }
        };
        buildMacroMap($macroCategoryConfig);
        buildMacroMap($macroProductGroupConfig);

        // 3. X·ª≠ l√Ω d·ªØ li·ªáu L∆∞∆°ng/Th∆∞·ªüng (Gi·ªØ nguy√™n ƒë·∫ßy ƒë·ªß)
        const $thuongNongData = get(thuongNongData) || [];
        const $employeeNameToMaNVMap = get(employeeNameToMaNVMap);
        const $thuongERPData = get(thuongERPData) || [];
        const $thuongNongDataThangTruoc = get(thuongNongDataThangTruoc) || [];
        const $thuongERPDataThangTruoc = get(thuongERPDataThangTruoc) || [];

        const thuongNongByMSNV = {};
        $thuongNongData.forEach(row => {
            const msnv = String(row.maNV || '').trim() || $employeeNameToMaNVMap.get(String(row.hoTen).toLowerCase());
            if(msnv) thuongNongByMSNV[msnv] = (thuongNongByMSNV[msnv]||0) + (parseFloat(String(row.diemThuong||0).replace(/,/g,''))||0);
        });

        const thuongNongThangTruocByMSNV = {};
        $thuongNongDataThangTruoc.forEach(row => {
            const msnv = String(row.maNV || '').trim() || $employeeNameToMaNVMap.get(String(row.hoTen).toLowerCase());
            if(msnv) thuongNongThangTruocByMSNV[msnv] = (thuongNongThangTruocByMSNV[msnv]||0) + (parseFloat(String(row.diemThuong||0).replace(/,/g,''))||0);
        });

        // =================================================================================
        // V√íNG L·∫∂P CH√çNH (MAIN LOOP)
        // =================================================================================
        return $danhSachNhanVien.map((employee) => {
            // Kh·ªüi t·∫°o ƒë·∫ßy ƒë·ªß c√°c tr∆∞·ªùng, kh√¥ng b·ªè s√≥t tr∆∞·ªùng n√†o
            let data = {
                doanhThu: 0, doanhThuQuyDoi: 0, doanhThuTraGop: 0,
                doanhThuChuaXuat: 0, doanhThuQuyDoiChuaXuat: 0,
                doanhThuGiaoXa: 0, doanhThuQuyDoiGiaoXa: 0,
                
                // Dictionary l∆∞u chi ti·∫øt ƒë·ªÉ t√≠nh Dynamic Metrics
                doanhThuTheoNganhHang: {}, 
                doanhThuTheoNhomHang: {}, 
                
                // N∆°i ch·ª©a k·∫øt qu·∫£ t√≠nh ch·ªâ s·ªë ƒë·ªông
                dynamicMetrics: {},
                
                // QDC Object
                qdc: {},
                
                // C√ÅC C·ªòT UI C·ªê ƒê·ªäNH (Quan tr·ªçng)
                dtICT: 0, dtCE: 0, 
                dtPhuKien: 0, dtGiaDung: 0, 
                dtSim: 0, dtVAS: 0, dtBaoHiem: 0, dtMLN: 0,

                // Chi ti·∫øt nh·ªè (Legacy support)
                dtTivi: 0, slTivi: 0, dtTuLanh: 0, slTuLanh: 0,
                dtMayGiat: 0, slMayGiat: 0, dtMayLanh: 0, slMayLanh: 0,
                dtDienThoai: 0, slDienThoai: 0, dtLaptop: 0, slLaptop: 0
            };

            // Init QDC
            for (const key in PG.QDC_GROUPS) {
                data.qdc[key] = { sl: 0, dt: 0, dtqd: 0, name: PG.QDC_GROUPS[key].name };
            }

            if (sourceData && Array.isArray(sourceData)) {
                sourceData.forEach(row => {
                    const msnvMatch = String(row.nguoiTao || '').match(/(\d+)/);
                    if (msnvMatch && msnvMatch[1].trim() === employee.maNV) {
                        
                        const hinhThucXuat = row.hinhThucXuat;
                        const trangThaiXuat = row.trangThaiXuat;
                        
                        // ƒêI·ªÄU KI·ªÜN L·ªåC D·ªÆ LI·ªÜU
                        const isDoanhThuHTX = !hinhThucXuat || hinhThucXuatTinhDoanhThu.has(hinhThucXuat);
                        // Ch·ªâ l·∫•y "ƒê√£ xu·∫•t"
                        const isDaXuat = !trangThaiXuat || trangThaiXuat.trim() === 'ƒê√£ xu·∫•t' || trangThaiXuat.trim() === 'ƒê√£ giao';

                        if (isDoanhThuHTX && isDaXuat) {
                            const thanhTien = parseFloat(String(row.thanhTien || "0").replace(/,/g, '')) || 0;
                            const soLuong = parseInt(String(row.soLuong || "0"), 10) || 0;
                            const heSo = heSoQuyDoi[row.nhomHang] || 1;
                            
                            const nhomHangCode = String(row.nhomHang || '').match(/^\d+/)?.[0] || null;
                            const rawNhomHang = normalize(row.nhomHang);
                            const rawNganhHang = normalize(row.nganhHang);

                            // Tracking chi ti·∫øt v√†o bucket (ƒë·ªÉ t√≠nh Dynamic Metrics sau n√†y)
                            const trackMetric = (container, name) => {
                                if (!name) return;
                                const cleanName = utils.cleanCategoryName(name); 
                                if (!container[cleanName]) {
                                    container[cleanName] = { 
                                        name: cleanName, 
                                        revenue: 0, 
                                        quantity: 0, 
                                        revenueQuyDoi: 0 
                                    };
                                }
                                container[cleanName].revenue += thanhTien;
                                container[cleanName].quantity += soLuong;
                                container[cleanName].revenueQuyDoi += thanhTien * heSo;
                            }
                            trackMetric(data.doanhThuTheoNganhHang, row.nganhHang);
                            trackMetric(data.doanhThuTheoNhomHang, row.nhomHang);

                            // C·ªông t·ªïng doanh thu
                            data.doanhThu += thanhTien;
                            data.doanhThuQuyDoi += thanhTien * heSo;

                            if (hinhThucXuat && hinhThucXuatTraGop.has(hinhThucXuat)) {
                                data.doanhThuTraGop += thanhTien;
                            }

                            // ==========================================================
                            // PH√ÇN LO·∫†I NH√ìM H√ÄNG (K·∫øt h·ª£p Hardcode ID + Dynamic Keyword)
                            // ƒê√¢y l√† ph·∫ßn ƒë·∫£m b·∫£o kh√¥ng m·∫•t d·ªØ li·ªáu
                            // ==========================================================
                            
                            // 1. Logic Hardcode ID (∆Øu ti√™n cao nh·∫•t - D·ªØ li·ªáu c≈© ch·∫Øc ch·∫Øn ƒë√∫ng)
                            let mapped = false;

                            // ICT: ƒêi·ªán tho·∫°i, Laptop, Tablet...
                            if (PG.DIEN_THOAI.includes(nhomHangCode) || PG.LAPTOP.includes(nhomHangCode) || PG.TABLET && PG.TABLET.includes(nhomHangCode)) {
                                data.dtICT += thanhTien;
                                mapped = true;
                            }

                            // CE: Tivi, T·ªß l·∫°nh, M√°y gi·∫∑t, M√°y l·∫°nh...
                            if (PG.TIVI.includes(nhomHangCode) || PG.TU_LANH.includes(nhomHangCode) || PG.MAY_GIAT.includes(nhomHangCode) || PG.MAY_LANH.includes(nhomHangCode) || PG.DONG_HO && PG.DONG_HO.includes(nhomHangCode)) {
                                data.dtCE += thanhTien;
                                mapped = true;
                            }

                            // Ph·ª• Ki·ªán
                            if (PG.PHU_KIEN && PG.PHU_KIEN.includes(nhomHangCode)) {
                                data.dtPhuKien += thanhTien;
                                mapped = true;
                            }

                            // Gia D·ª•ng
                            if (PG.GIA_DUNG && PG.GIA_DUNG.includes(nhomHangCode)) {
                                data.dtGiaDung += thanhTien;
                                mapped = true;
                            }

                            // M√°y L·ªçc N∆∞·ªõc
                            if (PG.MAY_LOC_NUOC && PG.MAY_LOC_NUOC.includes(nhomHangCode)) {
                                data.dtMLN += thanhTien;
                                mapped = true;
                            }

                            // Sim S·ªë
                            if (PG.SIM && PG.SIM.includes(nhomHangCode)) {
                                data.dtSim += thanhTien;
                                mapped = true;
                            }

                            // D·ªãch v·ª• (VAS)
                            if (PG.VAS && PG.VAS.includes(nhomHangCode)) {
                                data.dtVAS += thanhTien;
                                mapped = true;
                            }
                            
                            // B·∫£o hi·ªÉm
                            if (PG.BAO_HIEM_VAS && PG.BAO_HIEM_VAS.includes(nhomHangCode)) {
                                data.dtBaoHiem += thanhTien;
                                mapped = true;
                            }

                            // 2. Logic Dynamic (B·ªï sung n·∫øu Hardcode ch∆∞a b·∫Øt ƒë∆∞·ª£c HO·∫∂C ƒë·ªÉ b·∫Øt th√™m theo t√™n)
                            // Qu√©t qua c√°c t·ª´ kh√≥a ƒë√£ load t·ª´ Admin Config
                            if (!mapped) {
                                const checkDynamic = (uiKey) => {
                                    const keywords = uiKeywords[uiKey];
                                    if (keywords && keywords.some(k => rawNhomHang.includes(k) || rawNganhHang.includes(k))) {
                                        data[uiKey] += thanhTien;
                                    }
                                };
                                checkDynamic('dtICT');
                                checkDynamic('dtCE');
                                checkDynamic('dtPhuKien');
                                checkDynamic('dtGiaDung');
                                checkDynamic('dtMLN');
                                checkDynamic('dtSim');
                                checkDynamic('dtVAS');
                                checkDynamic('dtBaoHiem');
                            }

                            // Logic Chi ti·∫øt con (D√πng cho b√°o c√°o c≈© n·∫øu c·∫ßn)
                            if (PG.DIEN_THOAI.includes(nhomHangCode)) { data.dtDienThoai += thanhTien; data.slDienThoai += soLuong; }
                            if (PG.LAPTOP.includes(nhomHangCode)) { data.dtLaptop += thanhTien; data.slLaptop += soLuong; }
                            if (PG.TIVI.includes(nhomHangCode)) { data.dtTivi += thanhTien; data.slTivi += soLuong; }
                            if (PG.TU_LANH.includes(nhomHangCode)) { data.dtTuLanh += thanhTien; data.slTuLanh += soLuong; }
                            if (PG.MAY_GIAT.includes(nhomHangCode)) { data.dtMayGiat += thanhTien; data.slMayGiat += soLuong; }
                            if (PG.MAY_LANH.includes(nhomHangCode)) { data.dtMayLanh += thanhTien; data.slMayLanh += soLuong; }

                            // Logic QDC
                            for (const key in PG.QDC_GROUPS) {
                                if (PG.QDC_GROUPS[key].codes.includes(nhomHangCode)) {
                                    data.qdc[key].sl += soLuong; 
                                    data.qdc[key].dt += thanhTien; 
                                    data.qdc[key].dtqd += thanhTien * heSo;
                                }
                            }
                        }
                        // X·ª≠ l√Ω Doanh thu ch∆∞a xu·∫•t
                        else if (trangThaiXuat === 'Ch∆∞a xu·∫•t') {
                            const thanhTien = parseFloat(String(row.thanhTien || "0").replace(/,/g, '')) || 0;
                            const heSo = heSoQuyDoi[row.nhomHang] || 1;
                            data.doanhThuChuaXuat += thanhTien;
                            data.doanhThuQuyDoiChuaXuat += thanhTien * heSo;
                        }
                    }
                });
            }

            // 4. T√≠nh to√°n Ch·ªâ s·ªë ƒê·ªông (Efficiency Config t·ª´ Admin)
            if ($efficiencyConfig && Array.isArray($efficiencyConfig)) {
                $efficiencyConfig.forEach(cfg => {
                    try {
                        if (!cfg.id || !cfg.groupA || !cfg.groupB) return;

                        const numType = cfg.typeA || cfg.type || 'DTTL';
                        const denType = cfg.typeB || (numType === 'SL' ? 'SL' : 'DTTL');

                        const calcValue = (groupList, type) => {
                            let total = 0;
                            groupList.forEach(shortName => {
                                const normShort = normalize(shortName);
                                // H√†m qu√©t ƒë·ªá quy
                                const scanBucket = (bucket) => {
                                    for (const [key, val] of Object.entries(bucket)) {
                                        if (normalize(key).includes(normShort)) {
                                            if (type === 'SL') total += val.quantity;
                                            else if (type === 'DTQD') total += val.revenueQuyDoi;
                                            else total += val.revenue;
                                        }
                                    }
                                };
                                scanBucket(data.doanhThuTheoNganhHang);
                                scanBucket(data.doanhThuTheoNhomHang);
                            });
                            return total;
                        };

                        const num = calcValue(cfg.groupA, numType);
                        const den = calcValue(cfg.groupB, denType);

                        data.dynamicMetrics[cfg.id] = {
                            value: den > 0 ? num / den : 0,
                            target: goalSettings && goalSettings[cfg.id] ? parseFloat(goalSettings[cfg.id]) : (cfg.target || 0),
                            label: cfg.label
                        };
                    } catch (e) {
                        // Silent fail ƒë·ªÉ kh√¥ng crash
                    }
                });
            }

            // 5. T√≠nh to√°n c√°c T·ª∑ l·ªá ph·∫ßn trƒÉm c·ªë ƒë·ªãnh (Hardcoded Percentages)
            const totalRevenue = data.doanhThu > 0 ? data.doanhThu : 1;
            const pctPhuKien = data.dtPhuKien / totalRevenue;
            const pctGiaDung = data.dtGiaDung / totalRevenue;
            const pctMLN = data.dtMLN / totalRevenue;
            const pctSim = data.dtSim / totalRevenue;
            const pctVAS = data.dtVAS / totalRevenue;
            const pctBaoHiem = data.dtBaoHiem / totalRevenue;

            const hieuQuaQuyDoi = data.doanhThu > 0 ? (data.doanhThuQuyDoi / data.doanhThu) - 1 : 0;
            const tyLeTraCham = data.doanhThu > 0 ? data.doanhThuTraGop / data.doanhThu : 0;

            // 6. T√≠nh to√°n L∆∞∆°ng Th∆∞·ªüng
            const gioCong = gioCongByMSNV[employee.maNV] || 0;
            const thuongNong = thuongNongByMSNV[employee.maNV] || 0;
            const erpEntry = $thuongERPData.find(e => e.name.includes(employee.hoTen));
            const thuongERP = erpEntry ? parseFloat(erpEntry.bonus.replace(/,/g, '')) : 0;
            const tongThuNhap = thuongNong + thuongERP;

            const today = new Date();
            const daysInMonth = new Date(today.getFullYear(), today.getMonth() + 1, 0).getDate();
            let thuNhapDuKien = 0;
            if (today.getDate() > 1) {
                thuNhapDuKien = (tongThuNhap / (today.getDate() - 1)) * daysInMonth;
            } else {
                thuNhapDuKien = tongThuNhap * daysInMonth;
            }

            const thuongNongThangTruoc = thuongNongThangTruocByMSNV[employee.maNV] || 0;
            const erpEntryThangTruoc = $thuongERPDataThangTruoc.find(e => e.name.includes(employee.hoTen));
            const thuongERPThangTruoc = erpEntryThangTruoc ? parseFloat(erpEntryThangTruoc.bonus.replace(/,/g, '')) : 0;
            const thuNhapThangTruoc = (thuongNongThangTruoc || 0) + thuongERPThangTruoc;
            const chenhLechThuNhap = thuNhapDuKien - thuNhapThangTruoc;

            const totalQuantity = Object.values(data.doanhThuTheoNganhHang).reduce((sum, c) => sum + c.quantity, 0);
            const donGiaTrungBinh = totalQuantity > 0 ? data.doanhThu / totalQuantity : 0;

            // 7. Tr·∫£ v·ªÅ k·∫øt qu·∫£ cu·ªëi c√πng
            return { 
                ...employee, 
                ...data, // Spread data v√†o (dtICT, dtCE...)
                pctPhuKien, pctGiaDung, pctMLN, pctSim, pctVAS, pctBaoHiem,
                hieuQuaQuyDoi, tyLeTraCham,
                gioCong, thuongNong, thuongERP, tongThuNhap, thuNhapDuKien, thuNhapThangTruoc, chenhLechThuNhap, 
                donGiaTrungBinh,
                mucTieu: goalSettings 
            };
        });
    },

    aggregateReport(reportData, selectedWarehouse = null) {
        if (!reportData || reportData.length === 0) return {};

        // T√≠nh t·ªïng h·ª£p cho to√†n si√™u th·ªã
        const supermarketReport = reportData.reduce((acc, curr) => {
            // C·ªông d·ªìn t·∫•t c·∫£ c√°c tr∆∞·ªùng s·ªë (bao g·ªìm c·∫£ dtICT, dtCE...)
            for (const key in curr) {
                if (typeof curr[key] === 'number') {
                    acc[key] = (acc[key] || 0) + curr[key];
                }
            }
            
            // Merge chi ti·∫øt Ng√†nh h√†ng / Nh√≥m h√†ng
            ['doanhThuTheoNganhHang', 'doanhThuTheoNhomHang'].forEach(dictKey => {
                if(curr[dictKey]) {
                    if(!acc[dictKey]) acc[dictKey] = {};
                    Object.entries(curr[dictKey]).forEach(([k, v]) => {
                        if(!acc[dictKey][k]) acc[dictKey][k] = { ...v };
                        else {
                            acc[dictKey][k].revenue += v.revenue;
                            acc[dictKey][k].quantity += v.quantity;
                            acc[dictKey][k].revenueQuyDoi += v.revenueQuyDoi;
                        }
                    });
                }
            });

            return acc;
        }, { doanhThu: 0, dynamicMetrics: {} });

        supermarketReport.nganhHangChiTiet = supermarketReport.doanhThuTheoNganhHang;
        supermarketReport.nhomHangChiTiet = supermarketReport.doanhThuTheoNhomHang;

        // T√≠nh l·∫°i % T·ªïng h·ª£p Si√™u th·ªã
        const totalRevenue = supermarketReport.doanhThu || 1;
        supermarketReport.pctPhuKien = (supermarketReport.dtPhuKien || 0) / totalRevenue;
        supermarketReport.pctGiaDung = (supermarketReport.dtGiaDung || 0) / totalRevenue;
        supermarketReport.pctMLN = (supermarketReport.dtMLN || 0) / totalRevenue;
        supermarketReport.pctSim = (supermarketReport.dtSim || 0) / totalRevenue;
        supermarketReport.pctVAS = (supermarketReport.dtVAS || 0) / totalRevenue;
        supermarketReport.pctBaoHiem = (supermarketReport.dtBaoHiem || 0) / totalRevenue;
        
        supermarketReport.hieuQuaQuyDoi = (supermarketReport.doanhThuQuyDoi || 0) / totalRevenue - 1;
        supermarketReport.tyLeTraCham = (supermarketReport.doanhThuTraGop || 0) / totalRevenue;
        supermarketReport.comparisonData = { value: 0, percentage: 'N/A' }; 

        // T√≠nh l·∫°i QDC Don gia
        if (supermarketReport.qdc) {
            for (const key in supermarketReport.qdc) {
                const group = supermarketReport.qdc[key];
                group.donGia = group.sl > 0 ? group.dt / group.sl : 0;
            }
        }

        // T√≠nh l·∫°i Dynamic Metrics cho c·∫•p Si√™u th·ªã
        const $efficiencyConfig = get(efficiencyConfig) || [];
        const $macroProductGroupConfig = get(macroProductGroupConfig) || [];
        const $macroCategoryConfig = get(macroCategoryConfig) || [];
        supermarketReport.dynamicMetrics = {};
        
        // Helper map cho Dynamic
        const macroToItemsMap = {}; 
        const addToMap = (configs) => {
            if(Array.isArray(configs)) {
                configs.forEach(m => { 
                    if(m.items && Array.isArray(m.items)) {
                        macroToItemsMap[normalize(m.name)] = m.items.map(i=>normalize(i)); 
                    }
                });
            }
        };
        addToMap($macroCategoryConfig);
        addToMap($macroProductGroupConfig);

        if (Array.isArray($efficiencyConfig) && $efficiencyConfig.length > 0) {
            $efficiencyConfig.forEach(cfg => {
                try {
                    if (!cfg.id || !cfg.groupA || !cfg.groupB) return;

                    const numType = cfg.typeA || 'DTTL';
                    const denType = cfg.typeB || 'DTTL'; // M·∫∑c ƒë·ªãnh DTTL

                    const calcGroupValue = (groupList, valueType) => {
                        let total = 0;
                        if (!Array.isArray(groupList) || groupList.length === 0) return 0;
                        
                        groupList.forEach(rawName => {
                            if(!rawName) return;
                            const cleanCfgName = normalize(rawName);
                            // Qu√©t buckets
                             const scanBucket = (bucket) => {
                                for (const [k, v] of Object.entries(bucket)) {
                                    if (normalize(k).includes(cleanCfgName)) {
                                        if(valueType==='SL') total+=v.quantity;
                                        else if(valueType==='DTQD') total+=v.revenueQuyDoi;
                                        else total+=v.revenue;
                                    }
                                }
                            };
                            scanBucket(supermarketReport.doanhThuTheoNganhHang);
                            scanBucket(supermarketReport.doanhThuTheoNhomHang);
                        });
                        return total;
                    };

                    const numVal = calcGroupValue(cfg.groupA, numType);
                    const denVal = calcGroupValue(cfg.groupB, denType);
                    
                    supermarketReport.dynamicMetrics[cfg.id] = {
                        value: denVal > 0 ? numVal / denVal : 0,
                        target: cfg.target,
                        label: cfg.label
                    };
                } catch(e) {}
            });
        }

        return supermarketReport;
    }
};
--- END FILE: ./src/services/reports/master.report.js ---

--- START FILE: ./src/components/admin/category/CategoryUploader.svelte ---
<script>
    import { categoryStructure, brandList } from '../../../stores.js';
    import { dataService } from '../../../services/dataService.js';

    let isLoading = false;
    let showRawData = false;

    // T√≠nh to√°n s·ªë li·ªáu th·ªëng k√™ t·ª´ Store
    // Khi F5, adminService load d·ªØ li·ªáu t·ª´ Cloud v√†o Store -> bi·∫øn n√†y t·ª± c·∫≠p nh·∫≠t -> UI hi·ªÉn th·ªã l·∫°i
    $: uniqueCategories = $categoryStructure ? [...new Set($categoryStructure.map(i => i.nganhHang).filter(Boolean))] : [];
    $: uniqueGroups = $categoryStructure ? [...new Set($categoryStructure.map(i => i.nhomHang).filter(Boolean))] : [];
    $: totalBrands = $brandList ? $brandList.length : 0;
    
    // Check xem c√≥ d·ªØ li·ªáu kh√¥ng ƒë·ªÉ hi·ªÉn th·ªã b·∫£ng
    $: hasData = $categoryStructure.length > 0;

    async function handleCategoryUpload(event) {
        isLoading = true;
        try {
            await dataService.handleCategoryFile(event);
        } catch (error) {
            alert(error.message);
        } finally {
            isLoading = false;
        }
    }
</script>

<div class="space-y-6">
    <div class="flex justify-between items-center">
        <div class="text-sm text-gray-500 italic">
            B∆∞·ªõc 1: T·∫£i l√™n file Excel c·∫•u tr√∫c (B·∫Øt bu·ªôc 3 c·ªôt: Ng√†nh h√†ng, Nh√≥m h√†ng, Nh√† s·∫£n xu·∫•t).
        </div>
        <button 
            class="px-3 py-1.5 text-xs font-medium text-slate-600 bg-slate-100 rounded hover:bg-slate-200 transition-colors"
            on:click={() => dataService.handleTemplateDownload()}
        >
            T·∫£i File M·∫´u
        </button>
    </div>

    <div class="p-6 bg-slate-50 rounded-xl border-2 border-dashed border-slate-300 hover:border-blue-400 transition-colors text-center">
        <input 
            type="file" 
            id="category-upload-input" 
            class="hidden" 
            accept=".xlsx, .xls"
            on:change={handleCategoryUpload}
            disabled={isLoading}
        />
        <label for="category-upload-input" class="cursor-pointer flex flex-col items-center gap-3">
            <div class="p-3 bg-white rounded-full shadow-sm">
                {#if isLoading}
                    <svg class="animate-spin h-8 w-8 text-blue-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                {:else}
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-blue-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" />
                    </svg>
                {/if}
            </div>
            <div>
                <span class="text-blue-600 font-medium hover:underline">T·∫£i l√™n file Excel</span>
                <span class="text-slate-500"> c·∫•u tr√∫c ng√†nh h√†ng</span>
            </div>
        </label>
    </div>

    {#if hasData}
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <div class="p-3 bg-blue-50 rounded-lg border border-blue-100 flex justify-between items-center">
                <span class="text-sm text-blue-700 font-medium">T·ªïng Ng√†nh H√†ng</span>
                <span class="text-xl font-bold text-blue-700">{uniqueCategories.length}</span>
            </div>
            <div class="p-3 bg-green-50 rounded-lg border border-green-100 flex justify-between items-center">
                <span class="text-sm text-green-700 font-medium">T·ªïng Nh√≥m H√†ng</span>
                <span class="text-xl font-bold text-green-700">{uniqueGroups.length}</span>
            </div>
            <div class="p-3 bg-purple-50 rounded-lg border border-purple-100 flex justify-between items-center">
                <span class="text-sm text-purple-700 font-medium">T·ªïng H√£ng</span>
                <span class="text-xl font-bold text-purple-700">{totalBrands}</span>
            </div>
        </div>

        <div class="border rounded-lg overflow-hidden">
            <div class="bg-slate-100 px-4 py-2 border-b flex justify-between items-center">
                <h3 class="font-bold text-slate-700 text-xs uppercase">D·ªØ li·ªáu th√¥ (Preview)</h3>
                <button 
                    class="text-xs text-blue-600 hover:underline"
                    on:click={() => showRawData = !showRawData}
                >
                    {showRawData ? '·∫®n chi ti·∫øt' : 'Xem chi ti·∫øt'}
                </button>
            </div>
            
            {#if showRawData}
            <div class="overflow-x-auto max-h-60">
                <table class="w-full text-sm text-left">
                    <thead class="text-xs text-slate-500 uppercase bg-slate-50 sticky top-0">
                        <tr>
                            <th class="px-4 py-2">Ng√†nh H√†ng</th>
                            <th class="px-4 py-2">Nh√≥m H√†ng</th>
                            <th class="px-4 py-2">Nh√† S·∫£n Xu·∫•t</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-slate-200">
                        {#each $categoryStructure.slice(0, 100) as item}
                            <tr class="bg-white hover:bg-slate-50">
                                <td class="px-4 py-1 text-slate-600">{item.nganhHang}</td>
                                <td class="px-4 py-1 font-medium text-slate-700">{item.nhomHang}</td>
                                <td class="px-4 py-1 text-slate-500 italic">{item.nhaSanXuat}</td>
                            </tr>
                        {/each}
                    </tbody>
                </table>
            </div>
            {/if}
        </div>
    {/if}
</div>
--- END FILE: ./src/components/admin/category/CategoryUploader.svelte ---

--- START FILE: ./src/components/admin/category/MacroGroupEditor.svelte ---
<script>
    import { onMount } from 'svelte';
    import { categoryStructure, macroCategoryConfig } from '../../../stores.js';
    import { adminService } from '../../../services/admin.service.js';

    let localConfigs = []; 
    let isSaving = false;
    let editingId = null; 
    let itemSearch = '';

    // [C·∫¨P NH·∫¨T] L·∫•y danh s√°ch Ng√†nh H√†ng (Category) thay v√¨ Nh√≥m H√†ng (Group)
    // ƒê·ªÉ hi·ªÉn th·ªã danh s√°ch tick ch·ªçn ng·∫Øn g·ªçn h∆°n
    $: rawCategories = [...new Set(($categoryStructure || []).map(c => c.nganhHang).filter(Boolean))].sort();
    
    $: if ($macroCategoryConfig) {
        localConfigs = JSON.parse(JSON.stringify($macroCategoryConfig));
    }

    function addGroup() {
        const name = prompt("Nh·∫≠p t√™n Nh√≥m Ng√†nh H√†ng l·ªõn (VD: ICT, CE...):");
        if (name && name.trim()) {
            const id = 'macro_' + Date.now();
            localConfigs = [...localConfigs, { id, name: name.trim(), items: [] }];
            editingId = id; 
        }
    }

    function removeGroup(id) {
        if (!confirm("B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a nh√≥m n√†y?")) return;
        localConfigs = localConfigs.filter(g => g.id !== id);
    }

    function toggleItem(groupId, itemName) {
        const groupIndex = localConfigs.findIndex(g => g.id === groupId);
        if (groupIndex === -1) return;

        const currentItems = new Set(localConfigs[groupIndex].items || []);
        if (currentItems.has(itemName)) {
            currentItems.delete(itemName);
        } else {
            currentItems.add(itemName);
        }
        localConfigs[groupIndex].items = [...currentItems];
    }

    async function handleSave() {
        isSaving = true;
        try {
            await adminService.saveMacroCategoryConfig(localConfigs);
            macroCategoryConfig.set(localConfigs);
        } catch (e) {
            alert(e.message);
        } finally {
            isSaving = false;
        }
    }

    // Filter items cho vi·ªác ch·ªçn
    $: filteredRawCategories = rawCategories.filter(g => g.toLowerCase().includes(itemSearch.toLowerCase()));
</script>

<div class="space-y-4">
    <div class="flex justify-between items-center mb-4">
        <p class="text-sm text-gray-500">
            ƒê·ªãnh nghƒ©a c√°c nh√≥m l·ªõn (VD: Gom "ƒêi·ªán tho·∫°i", "Laptop" v√†o nh√≥m "ICT").
            <br><span class="text-xs text-orange-600 font-semibold">* L∆∞u √Ω: Danh s√°ch d∆∞·ªõi ƒë√¢y l√† c√°c Ng√†nh H√†ng (Category).</span>
        </p>
        <div class="flex gap-2">
            <button 
                class="px-3 py-1.5 text-xs font-bold text-green-700 bg-green-50 border border-green-200 rounded hover:bg-green-100 transition"
                on:click={addGroup}
            >
                + Th√™m Nh√≥m L·ªõn
            </button>
            <button 
                class="px-4 py-1.5 text-xs font-bold text-white bg-indigo-600 rounded hover:bg-indigo-700 transition shadow-sm disabled:opacity-50"
                on:click={handleSave}
                disabled={isSaving}
            >
                {#if isSaving}L∆∞u...{:else}L∆∞u C·∫•u H√¨nh{/if}
            </button>
        </div>
    </div>

    {#if localConfigs.length === 0}
        <div class="p-8 text-center border-2 border-dashed border-gray-200 rounded-lg bg-gray-50">
            <p class="text-gray-400">Ch∆∞a c√≥ nh√≥m n√†o. H√£y b·∫•m "Th√™m Nh√≥m L·ªõn".</p>
        </div>
    {:else}
        <div class="grid gap-4">
            {#each localConfigs as group (group.id)}
                <div class="border border-gray-200 rounded-lg bg-white overflow-hidden shadow-sm">
                    <div 
                        class="p-3 bg-gray-50 flex justify-between items-center cursor-pointer hover:bg-gray-100 transition"
                        on:click={() => editingId = (editingId === group.id ? null : group.id)}
                    >
                        <div class="flex items-center gap-2">
                            <span class="transform transition-transform {editingId === group.id ? 'rotate-90' : ''}">‚ñ∂</span>
                            <h4 class="font-bold text-slate-700">{group.name}</h4>
                            <span class="bg-blue-100 text-blue-800 text-xs font-medium px-2 py-0.5 rounded-full">
                                {group.items?.length || 0} m·ª•c
                            </span>
                        </div>
                        <button 
                            class="text-red-500 hover:text-red-700 p-1"
                            on:click|stopPropagation={() => removeGroup(group.id)}
                            title="X√≥a nh√≥m"
                        >
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
                        </button>
                    </div>

                    {#if editingId === group.id}
                        <div class="p-4 border-t border-gray-200 bg-white animate-fade-in">
                            <div class="mb-2">
                                <input 
                                    type="text" 
                                    class="w-full p-2 border rounded text-xs bg-slate-50 focus:bg-white transition outline-none focus:ring-1 focus:ring-blue-500" 
                                    placeholder="üîç T√¨m ki·∫øm ng√†nh h√†ng..." 
                                    bind:value={itemSearch}
                                />
                            </div>
                            
                            <div class="max-h-60 overflow-y-auto grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-2 custom-scrollbar">
                                {#each filteredRawCategories as rawItem}
                                    {@const isChecked = group.items.includes(rawItem)}
                                    <label class="flex items-center gap-2 p-1.5 rounded border {isChecked ? 'bg-blue-50 border-blue-200' : 'border-transparent hover:bg-gray-50'} cursor-pointer transition">
                                        <input 
                                            type="checkbox" 
                                            checked={isChecked} 
                                            on:change={() => toggleItem(group.id, rawItem)}
                                            class="rounded text-blue-600 focus:ring-blue-500"
                                        />
                                        <span class="text-xs text-gray-700 truncate" title={rawItem}>
                                            {rawItem}
                                        </span>
                                    </label>
                                {/each}
                            </div>
                        </div>
                    {/if}
                </div>
            {/each}
        </div>
    {/if}
</div>

<style>
    .animate-fade-in { animation: fadeIn 0.2s ease-out; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(-5px); } to { opacity: 1; transform: translateY(0); } }
</style>
--- END FILE: ./src/components/admin/category/MacroGroupEditor.svelte ---

--- START FILE: ./src/components/admin/category/MacroProductGroupEditor.svelte ---
<script>
    import { onMount } from 'svelte';
    import { categoryStructure, macroProductGroupConfig } from '../../../stores.js';
    import { adminService } from '../../../services/admin.service.js';
    import { cleanCategoryName } from '../../../utils.js';

    let localConfigs = []; 
    let isSaving = false;
    let editingId = null; 
    let itemSearch = '';

    // [M·ªöI] L·∫•y danh s√°ch Nh√≥m H√†ng (Product Group) ƒë·ªÉ tick ch·ªçn
    $: rawProductGroups = [...new Set(($categoryStructure || []).map(c => cleanCategoryName(c.nhomHang)).filter(Boolean))].sort();
    
    $: if ($macroProductGroupConfig) {
        localConfigs = JSON.parse(JSON.stringify($macroProductGroupConfig));
    }

    function addGroup() {
        const name = prompt("Nh·∫≠p t√™n Nh√≥m H√†ng L·ªõn (VD: ƒêi·ªán tho·∫°i & Laptop, Gia d·ª•ng l·ªõn...):");
        if (name && name.trim()) {
            const id = 'macro_pg_' + Date.now();
            localConfigs = [...localConfigs, { id, name: name.trim(), items: [] }];
            editingId = id; 
        }
    }

    function removeGroup(id) {
        if (!confirm("B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a nh√≥m n√†y?")) return;
        localConfigs = localConfigs.filter(g => g.id !== id);
    }

    function toggleItem(groupId, itemName) {
        const groupIndex = localConfigs.findIndex(g => g.id === groupId);
        if (groupIndex === -1) return;

        const currentItems = new Set(localConfigs[groupIndex].items || []);
        if (currentItems.has(itemName)) {
            currentItems.delete(itemName);
        } else {
            currentItems.add(itemName);
        }
        localConfigs[groupIndex].items = [...currentItems];
    }

    async function handleSave() {
        isSaving = true;
        try {
            await adminService.saveMacroProductGroupConfig(localConfigs);
            macroProductGroupConfig.set(localConfigs);
        } catch (e) {
            alert(e.message);
        } finally {
            isSaving = false;
        }
    }

    // Filter items cho vi·ªác ch·ªçn
    $: filteredRawGroups = rawProductGroups.filter(g => g.toLowerCase().includes(itemSearch.toLowerCase()));
</script>

<div class="space-y-4">
    <div class="flex justify-between items-center mb-4">
        <p class="text-sm text-gray-500">
            ƒê·ªãnh nghƒ©a c√°c nh√≥m h√†ng l·ªõn (VD: Gom "N·ªìi c∆°m", "B·∫øp ga" v√†o nh√≥m "Gia d·ª•ng nh√† b·∫øp").
            <br><span class="text-xs text-orange-600 font-semibold">* L∆∞u √Ω: Danh s√°ch d∆∞·ªõi ƒë√¢y l√† c√°c Nh√≥m H√†ng (Product Group).</span>
        </p>
        <div class="flex gap-2">
            <button 
                class="px-3 py-1.5 text-xs font-bold text-teal-700 bg-teal-50 border border-teal-200 rounded hover:bg-teal-100 transition"
                on:click={addGroup}
            >
                + Th√™m Nh√≥m H√†ng L·ªõn
            </button>
            <button 
                class="px-4 py-1.5 text-xs font-bold text-white bg-indigo-600 rounded hover:bg-indigo-700 transition shadow-sm disabled:opacity-50"
                on:click={handleSave}
                disabled={isSaving}
            >
                {#if isSaving}L∆∞u...{:else}L∆∞u C·∫•u H√¨nh{/if}
            </button>
        </div>
    </div>

    {#if localConfigs.length === 0}
        <div class="p-8 text-center border-2 border-dashed border-gray-200 rounded-lg bg-gray-50">
            <p class="text-gray-400">Ch∆∞a c√≥ nh√≥m n√†o. H√£y b·∫•m "Th√™m Nh√≥m H√†ng L·ªõn".</p>
        </div>
    {:else}
        <div class="grid gap-4">
            {#each localConfigs as group (group.id)}
                <div class="border border-gray-200 rounded-lg bg-white overflow-hidden shadow-sm">
                    <div 
                        class="p-3 bg-gray-50 flex justify-between items-center cursor-pointer hover:bg-gray-100 transition"
                        on:click={() => editingId = (editingId === group.id ? null : group.id)}
                    >
                        <div class="flex items-center gap-2">
                            <span class="transform transition-transform {editingId === group.id ? 'rotate-90' : ''}">‚ñ∂</span>
                            <h4 class="font-bold text-slate-700">{group.name}</h4>
                            <span class="bg-teal-100 text-teal-800 text-xs font-medium px-2 py-0.5 rounded-full">
                                {group.items?.length || 0} m·ª•c
                            </span>
                        </div>
                        <button 
                            class="text-red-500 hover:text-red-700 p-1"
                            on:click|stopPropagation={() => removeGroup(group.id)}
                            title="X√≥a nh√≥m"
                        >
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
                        </button>
                    </div>

                    {#if editingId === group.id}
                        <div class="p-4 border-t border-gray-200 bg-white animate-fade-in">
                            <div class="mb-2">
                                <input 
                                    type="text" 
                                    class="w-full p-2 border rounded text-xs bg-slate-50 focus:bg-white transition outline-none focus:ring-1 focus:ring-teal-500" 
                                    placeholder="üîç T√¨m ki·∫øm nh√≥m h√†ng..." 
                                    bind:value={itemSearch}
                                />
                            </div>
                            
                            <div class="max-h-60 overflow-y-auto grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-2 custom-scrollbar">
                                {#each filteredRawGroups as rawItem}
                                    {@const isChecked = group.items.includes(rawItem)}
                                    <label class="flex items-center gap-2 p-1.5 rounded border {isChecked ? 'bg-teal-50 border-teal-200' : 'border-transparent hover:bg-gray-50'} cursor-pointer transition">
                                        <input 
                                            type="checkbox" 
                                            checked={isChecked} 
                                            on:change={() => toggleItem(group.id, rawItem)}
                                            class="rounded text-teal-600 focus:ring-teal-500"
                                        />
                                        <span class="text-xs text-gray-700 truncate" title={rawItem}>
                                            {rawItem}
                                        </span>
                                    </label>
                                {/each}
                            </div>
                        </div>
                    {/if}
                </div>
            {/each}
        </div>
    {/if}
</div>

<style>
    .animate-fade-in { animation: fadeIn 0.2s ease-out; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(-5px); } to { opacity: 1; transform: translateY(0); } }
</style>
--- END FILE: ./src/components/admin/category/MacroProductGroupEditor.svelte ---

--- START FILE: ./src/components/admin/category/NameMappingEditor.svelte ---
<script>
    import { onMount } from 'svelte';
    import { categoryStructure, categoryNameMapping, groupNameMapping, brandNameMapping } from '../../../stores.js';
    import { adminService } from '../../../services/admin.service.js';
    // [FIX] Import h√†m cleanNameRaw
    import { cleanNameRaw } from '../../../utils.js';

    export let type = 'category'; // 'category' | 'group' | 'brand'

    let searchText = '';
    let isSaving = false;
    let localMapping = {}; 

    $: sourceData = $categoryStructure || [];
    
    let mappingStore, rawKey;
    
    $: if (type === 'category') {
        mappingStore = categoryNameMapping;
        rawKey = 'nganhHang';
    } else if (type === 'group') {
        mappingStore = groupNameMapping;
        rawKey = 'nhomHang';
    } else { // brand
        mappingStore = brandNameMapping;
        rawKey = 'nhaSanXuat';
    }
    
    $: uniqueRawNames = [...new Set(sourceData.map(item => item[rawKey]).filter(Boolean))].sort();

    $: {
        localMapping = { ...$mappingStore };
    }

    $: filteredList = uniqueRawNames.filter(name => 
        name.toLowerCase().includes(searchText.toLowerCase()) || 
        (localMapping[name] || '').toLowerCase().includes(searchText.toLowerCase())
    );

    // H√†m l·∫•y t√™n g·ª£i √Ω hi·ªÉn th·ªã tr√™n giao di·ªán (c·ªôt gi·ªØa)
    function getSuggestedName(rawName) {
        return cleanNameRaw(rawName);
    }

    async function handleSave() {
        isSaving = true;
        try {
            await adminService.saveNameMapping(type, localMapping);
            mappingStore.set(localMapping);
        } catch (e) {
            console.error(e);
            alert(e.message);
        } finally {
            isSaving = false;
        }
    }

    // [FIX] H√†m ƒëi·ªÅn t·ª± ƒë·ªông gi·ªù s·∫Ω d√πng logic l√†m s·∫°ch x·ªãn
    function autoFillAll() {
        if (!confirm("H√†nh ƒë·ªông n√†y s·∫Ω ƒëi·ªÅn t√™n g·ª£i √Ω (ƒë√£ l√†m s·∫°ch) v√†o t·∫•t c·∫£ c√°c √¥ tr·ªëng. Ti·∫øp t·ª•c?")) return;
        uniqueRawNames.forEach(raw => {
            if (!localMapping[raw]) {
                localMapping[raw] = cleanNameRaw(raw);
            }
        });
        localMapping = { ...localMapping };
    }
</script>

<div class="space-y-4">
    <div class="flex justify-between items-center bg-white p-2 rounded border border-gray-200">
        <input 
            type="text" 
            placeholder="üîç T√¨m t√™n g·ªëc ho·∫∑c t√™n hi·ªÉn th·ªã..." 
            class="flex-grow p-2 text-sm outline-none"
            bind:value={searchText}
        />
        <div class="flex gap-2">
            <button 
                class="px-3 py-1.5 text-xs font-medium text-blue-600 bg-blue-50 rounded hover:bg-blue-100 transition"
                on:click={autoFillAll}
            >
                ‚ú® ƒêi·ªÅn t·ª± ƒë·ªông
            </button>
            <button 
                class="px-4 py-1.5 text-xs font-bold text-white bg-indigo-600 rounded hover:bg-indigo-700 transition shadow-sm flex items-center gap-1 disabled:opacity-50"
                on:click={handleSave}
                disabled={isSaving}
            >
                {#if isSaving}L∆∞u...{:else}L∆∞u C·∫•u H√¨nh{/if}
            </button>
        </div>
    </div>

    {#if uniqueRawNames.length === 0}
        <div class="p-8 text-center border-2 border-dashed border-gray-200 rounded-lg">
            <p class="text-gray-500">Ch∆∞a c√≥ d·ªØ li·ªáu g·ªëc. Vui l√≤ng t·∫£i file Excel ·ªü m·ª•c tr√™n tr∆∞·ªõc.</p>
        </div>
    {:else}
        <div class="border rounded-lg overflow-hidden bg-white shadow-sm max-h-[500px] overflow-y-auto custom-scrollbar">
            <table class="w-full text-sm">
                <thead class="bg-gray-100 text-xs uppercase font-bold text-gray-600 sticky top-0 z-10 shadow-sm">
                    <tr>
                        <th class="px-4 py-3 text-left w-1/3">T√™n G·ªëc (Trong Excel)</th>
                        <th class="px-4 py-3 text-left w-1/3 text-gray-400">T√™n G·ª£i √ù (Auto)</th>
                        <th class="px-4 py-3 text-left w-1/3 text-indigo-700">T√™n Hi·ªÉn Th·ªã (Ch·ªânh s·ª≠a)</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-gray-100">
                    {#each filteredList as rawName}
                        {@const suggested = getSuggestedName(rawName)}
                        <tr class="hover:bg-slate-50 transition-colors group">
                            <td class="px-4 py-2 font-mono text-xs text-gray-600 select-all">{rawName}</td>
                            <td class="px-4 py-2 text-gray-400 italic text-xs select-all">{suggested}</td>
                            <td class="px-4 py-1">
                                <input 
                                    type="text" 
                                    class="w-full p-1.5 border border-gray-200 rounded text-sm font-medium text-indigo-800 focus:ring-1 focus:ring-indigo-500 focus:border-indigo-500 outline-none placeholder-gray-300"
                                    placeholder={suggested}
                                    bind:value={localMapping[rawName]}
                                />
                            </td>
                        </tr>
                    {/each}
                </tbody>
            </table>
        </div>
        <p class="text-xs text-gray-500 mt-2 italic text-right">
            * C√°c √¥ ƒë·ªÉ tr·ªëng s·∫Ω t·ª± ƒë·ªông hi·ªÉn th·ªã theo "T√™n G·ª£i √ù".
        </p>
    {/if}
</div>
--- END FILE: ./src/components/admin/category/NameMappingEditor.svelte ---

--- START FILE: ./src/components/health-staff/competition/CompetitionCard.svelte ---
<script>
  import { formatters } from '../../../utils/formatters.js';
  
  export let item; // D·ªØ li·ªáu c·ªßa 1 ch∆∞∆°ng tr√¨nh
  
  // T√≠nh to√°n logic hi·ªÉn th·ªã
  $: hoanThanhValue = item.hoanThanhValue || 0;
  $: isCompleted = hoanThanhValue >= 100;
  $: progressColor = isCompleted ? 'bg-blue-600' : 'bg-yellow-400';
  
  // T√≠nh m·ª•c ti√™u ng√†y (n·∫øu ch∆∞a ƒë·∫°t)
  $: targetRemaining = (item.target || 0) - (item.luyKe || 0);
  $: daysLeft = Math.max(30 - (new Date().getDate()), 1);
  $: dailyTarget = (item.target > 0 && targetRemaining > 0) ? (targetRemaining / daysLeft) : 0;
</script>

<div class="bg-white border border-gray-200 rounded-lg p-3 shadow-sm hover:shadow-md transition-all hover:-translate-y-0.5">
    <p class="font-semibold text-gray-800 mb-2 text-sm line-clamp-2 h-10" title={item.name}>
        {item.name}
    </p>
    
    <div class="w-full bg-gray-200 rounded-full h-3 overflow-hidden mb-2 relative">
        <div 
            class="h-full rounded-full transition-all duration-500 {progressColor}" 
            style="width: {Math.min(hoanThanhValue, 100)}%;"
        ></div>
        <span class="absolute inset-0 flex items-center justify-center text-[10px] font-bold text-gray-700 drop-shadow-md">
            {formatters.formatPercentage(hoanThanhValue / 100)}
        </span>
    </div>

    <div class="flex justify-between items-end text-xs text-gray-600">
        <div>
            <div class="flex flex-col">
                <span>L≈©y k·∫ø: <strong>{formatters.formatNumberOrDash(item.luyKe)}</strong></span>
                <span>Target: <strong>{formatters.formatNumberOrDash(item.target)}</strong></span>
            </div>
        </div>
        
        {#if isCompleted}
            <span class="font-bold text-green-600 bg-green-50 px-2 py-1 rounded">ƒê·∫°t</span>
        {:else}
            <div class="text-right">
                <span class="block text-gray-400">C·∫ßn/ng√†y:</span>
                <strong class="text-red-600">{formatters.formatNumberOrDash(dailyTarget)}</strong>
            </div>
        {/if}
    </div>
</div>
--- END FILE: ./src/components/health-staff/competition/CompetitionCard.svelte ---

--- START FILE: ./src/components/health-staff/competition/CompetitionDetailView.svelte ---
<script>
    import { createEventDispatcher, afterUpdate } from 'svelte'; // [QUAN TR·ªåNG] Th√™m afterUpdate
    import { formatters } from '../../../utils/formatters.js';
    import { competitionNameMappings } from '../../../stores.js';
    import { settingsService } from '../../../services/settings.service.js';

    export let employeeId;
    export let allReportData = []; 

    const dispatch = createEventDispatcher();

    // --- LOGIC T√çNH TO√ÅN ---
    let employee = null;
    let stats = {
        dat: [],
        ganDat: [],
        canCoGang: [],
        summary: { total: 0, dat: 0, rate: 0, ganDat: 0, canCoGang: 0 }
    };

    $: {
        if (employeeId && allReportData.length > 0) {
            employee = allReportData.find(e => e.maNV === employeeId);

            if (employee) {
                // L·∫•y c·∫•u h√¨nh t√™n c·ªôt hi·ªÉn th·ªã
                let columnSettings = settingsService.loadPastedCompetitionViewSettings();
                if (!columnSettings || columnSettings.length === 0) {
                     columnSettings = settingsService.loadPastedCompetitionViewSettings(); 
                }
                
                const activeColumns = columnSettings
                    .filter(col => col.visible)
                    .map(col => ({
                        ...col,
                        label: $competitionNameMappings[col.tenGoc] || col.label || col.tenGoc
                    }));

                // T√≠nh Trung b√¨nh b·ªô ph·∫≠n
                const deptEmployees = allReportData.filter(e => e.boPhan === employee.boPhan);
                const deptAvgs = {};
                
                activeColumns.forEach(col => {
                    let sum = 0;
                    let count = 0;
                    deptEmployees.forEach(e => {
                        const comp = e.competitions.find(c => c.tenGoc === col.tenGoc);
                        if (comp && comp.giaTri > 0) {
                            sum += comp.giaTri;
                            count++;
                        }
                    });
                    deptAvgs[col.tenGoc] = count > 0 ? sum / count : 0;
                });

                // Ph√¢n lo·∫°i ch·ªâ s·ªë
                let datList = [], ganDatList = [], canCoGangList = [];

                activeColumns.forEach(col => {
                    const compData = employee.competitions.find(c => c.tenGoc === col.tenGoc);
                    const val = compData ? compData.giaTri : 0;
                    const avg = deptAvgs[col.tenGoc] || 0;
                    
                    if (avg > 0 || val > 0) {
                        const item = {
                            name: col.label,
                            value: val,
                            avg: avg,
                            diff: val - avg,
                            percentOfAvg: avg > 0 ? (val / avg) * 100 : 0
                        };

                        if (val >= avg) {
                            datList.push(item);
                        } else if (item.percentOfAvg >= 70) {
                            ganDatList.push(item);
                        } else {
                            canCoGangList.push(item);
                        }
                    }
                });

                stats = {
                    dat: datList.sort((a,b) => b.percentOfAvg - a.percentOfAvg),
                    ganDat: ganDatList.sort((a,b) => b.percentOfAvg - a.percentOfAvg),
                    canCoGang: canCoGangList.sort((a,b) => a.percentOfAvg - b.percentOfAvg),
                    summary: {
                        total: datList.length + ganDatList.length + canCoGangList.length,
                        dat: datList.length,
                        ganDat: ganDatList.length,
                        canCoGang: canCoGangList.length,
                        rate: 0
                    }
                };
                stats.summary.rate = stats.summary.total > 0 
                    ? (stats.summary.dat / stats.summary.total) * 100 
                    : 0;
            }
        }
    }

    function goBack() {
        dispatch('back');
    }

    // [QUAN TR·ªåNG] K√≠ch ho·∫°t icon sau khi render
    afterUpdate(() => {
        if (typeof feather !== 'undefined') feather.replace();
    });
</script>

<div class="animate-fade-in pb-10 bg-gray-50 min-h-screen p-4 sm:p-6">
    <button on:click={goBack} class="mb-4 flex items-center gap-2 text-gray-500 hover:text-blue-600 transition-colors font-semibold">
        <i data-feather="arrow-left" class="w-5 h-5"></i> Quay l·∫°i b·∫£ng t·ªïng h·ª£p
    </button>

    {#if employee}
        <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-5 mb-6 flex items-center gap-5">
            <div class="w-16 h-16 rounded-full bg-gray-100 flex items-center justify-center text-gray-500 border border-gray-200 shadow-inner">
                <i data-feather="user" class="w-8 h-8"></i>
            </div>
            <div>
                <h2 class="text-2xl font-bold text-gray-800">{employee.hoTen} <span class="text-gray-400 font-medium text-lg">- {employee.maNV}</span></h2>
                <span class="inline-block mt-1 px-3 py-1 rounded-full bg-blue-50 text-blue-700 text-xs font-bold border border-blue-100">
                    {employee.boPhan}
                </span>
            </div>
        </div>

        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 mb-8">
            <div class="bg-white p-4 rounded-xl border border-gray-200 shadow-sm text-center">
                <p class="text-xs font-bold text-gray-500 uppercase mb-1">Ng√†nh h√†ng ƒê·∫°t</p>
                <p class="text-3xl font-extrabold text-gray-800">
                    <span class="text-blue-600">{stats.summary.dat}</span>
                    <span class="text-gray-300 text-xl">/ {stats.summary.total}</span>
                </p>
            </div>

            <div class="bg-white p-4 rounded-xl border border-gray-200 shadow-sm text-center">
                <p class="text-xs font-bold text-gray-500 uppercase mb-1">T·ª∑ l·ªá ƒë·∫°t (tr√™n nh√≥m c√≥ TB)</p>
                <p class="text-3xl font-extrabold text-red-500">
                    {formatters.formatNumber(stats.summary.rate, 0)}%
                </p>
            </div>

            <div class="bg-white p-4 rounded-xl border border-gray-200 shadow-sm text-center">
                <p class="text-xs font-bold text-gray-500 uppercase mb-1">G·∫ßn ƒê·∫°t (>=70%)</p>
                <p class="text-3xl font-extrabold text-yellow-500">{stats.summary.ganDat}</p>
            </div>

            <div class="bg-white p-4 rounded-xl border border-gray-200 shadow-sm text-center">
                <p class="text-xs font-bold text-gray-500 uppercase mb-1">C·∫ßn C·ªë G·∫Øng</p>
                <p class="text-3xl font-extrabold text-red-600">{stats.summary.canCoGang}</p>
            </div>
        </div>

        <div class="space-y-8">
            
            <div class="bg-blue-50/50 rounded-xl border border-blue-100 overflow-hidden">
                <div class="px-5 py-3 bg-blue-100/50 border-b border-blue-200 flex items-center gap-2">
                    <i data-feather="check-circle" class="w-5 h-5 text-blue-600"></i>
                    <h3 class="font-bold text-blue-800 uppercase text-lg">Nh√≥m ƒê·∫°t ({stats.dat.length})</h3>
                </div>
                <div class="p-5 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                    {#each stats.dat as item}
                        <div class="bg-white p-4 rounded-lg border border-blue-100 shadow-sm hover:shadow-md transition-shadow">
                            <h4 class="font-bold text-gray-800 mb-2 truncate" title={item.name}>{item.name}</h4>
                            <div class="w-full bg-gray-100 rounded-full h-2 mb-3">
                                <div class="bg-blue-500 h-2 rounded-full" style="width: 100%"></div>
                            </div>
                            <div class="text-xs space-y-1">
                                <div class="flex justify-between">
                                    <span class="text-gray-500">Th·ª±c hi·ªán:</span>
                                    <span class="font-bold text-gray-800">{formatters.formatNumber(item.value)}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-500">TB B·ªô ph·∫≠n:</span>
                                    <span class="font-bold text-gray-800">{formatters.formatNumber(item.avg)}</span>
                                </div>
                                <div class="flex justify-between border-t border-dashed border-gray-200 pt-1 mt-1">
                                    <span class="text-gray-500">Ch√™nh l·ªách:</span>
                                    <span class="font-bold text-green-600">+{formatters.formatNumber(item.diff)}</span>
                                </div>
                            </div>
                        </div>
                    {/each}
                    {#if stats.dat.length === 0}
                        <p class="text-sm text-gray-400 italic col-span-full text-center py-4">Kh√¥ng c√≥ ng√†nh h√†ng n√†o ƒë·∫°t.</p>
                    {/if}
                </div>
            </div>

            <div class="bg-yellow-50/50 rounded-xl border border-yellow-100 overflow-hidden">
                <div class="px-5 py-3 bg-yellow-100/50 border-b border-yellow-200 flex items-center gap-2">
                    <i data-feather="trending-up" class="w-5 h-5 text-yellow-600"></i>
                    <h3 class="font-bold text-yellow-800 uppercase text-lg">Nh√≥m G·∫ßn ƒê·∫°t ({stats.ganDat.length})</h3>
                </div>
                <div class="p-5 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                    {#each stats.ganDat as item}
                        <div class="bg-white p-4 rounded-lg border border-yellow-100 shadow-sm hover:shadow-md transition-shadow">
                            <h4 class="font-bold text-gray-800 mb-2 truncate" title={item.name}>{item.name}</h4>
                            <div class="w-full bg-gray-100 rounded-full h-2 mb-3">
                                <div class="bg-yellow-400 h-2 rounded-full" style="width: {item.percentOfAvg}%"></div>
                            </div>
                            <div class="text-xs space-y-1">
                                <div class="flex justify-between">
                                    <span class="text-gray-500">Th·ª±c hi·ªán:</span>
                                    <span class="font-bold text-gray-800">{formatters.formatNumber(item.value)}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-500">TB B·ªô ph·∫≠n:</span>
                                    <span class="font-bold text-gray-800">{formatters.formatNumber(item.avg)}</span>
                                </div>
                                <div class="flex justify-between border-t border-dashed border-gray-200 pt-1 mt-1">
                                    <span class="text-gray-500">Ch√™nh l·ªách:</span>
                                    <span class="font-bold text-red-500">{formatters.formatNumber(item.diff)}</span>
                                </div>
                            </div>
                        </div>
                    {/each}
                    {#if stats.ganDat.length === 0}
                        <p class="text-sm text-gray-400 italic col-span-full text-center py-4">Kh√¥ng c√≥ ng√†nh h√†ng n√†o.</p>
                    {/if}
                </div>
            </div>

            <div class="bg-red-50/50 rounded-xl border border-red-100 overflow-hidden">
                <div class="px-5 py-3 bg-red-100/50 border-b border-red-200 flex items-center gap-2">
                    <i data-feather="alert-circle" class="w-5 h-5 text-red-600"></i>
                    <h3 class="font-bold text-red-800 uppercase text-lg">Nh√≥m C·∫ßn C·ªë G·∫Øng ({stats.canCoGang.length})</h3>
                </div>
                <div class="p-5 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                    {#each stats.canCoGang as item}
                        <div class="bg-white p-4 rounded-lg border border-red-100 shadow-sm hover:shadow-md transition-shadow">
                            <h4 class="font-bold text-gray-800 mb-2 truncate" title={item.name}>{item.name}</h4>
                            <div class="w-full bg-gray-100 rounded-full h-2 mb-3">
                                <div class="bg-red-400 h-2 rounded-full" style="width: {Math.max(item.percentOfAvg, 5)}%"></div>
                            </div>
                            <div class="text-xs space-y-1">
                                <div class="flex justify-between">
                                    <span class="text-gray-500">Th·ª±c hi·ªán:</span>
                                    <span class="font-bold text-gray-800">{formatters.formatNumber(item.value)}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-500">TB B·ªô ph·∫≠n:</span>
                                    <span class="font-bold text-gray-800">{formatters.formatNumber(item.avg)}</span>
                                </div>
                                <div class="flex justify-between border-t border-dashed border-gray-200 pt-1 mt-1">
                                    <span class="text-gray-500">Ch√™nh l·ªách:</span>
                                    <span class="font-bold text-red-600">{formatters.formatNumber(item.diff)}</span>
                                </div>
                            </div>
                        </div>
                    {/each}
                    {#if stats.canCoGang.length === 0}
                        <p class="text-sm text-gray-400 italic col-span-full text-center py-4">Tuy·ªát v·ªùi! Kh√¥ng c√≥ ng√†nh h√†ng y·∫øu k√©m.</p>
                    {/if}
                </div>
            </div>

        </div>

    {:else}
        <div class="p-10 text-center">
            <p class="text-gray-500">ƒêang t·∫£i d·ªØ li·ªáu chi ti·∫øt...</p>
        </div>
    {/if}
</div>

<style>
    .animate-fade-in { animation: fadeIn 0.3s ease-out; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
</style>
--- END FILE: ./src/components/health-staff/competition/CompetitionDetailView.svelte ---

--- START FILE: ./src/components/health-staff/competition/CompetitionModeSelector.svelte ---
<script>
  import { createEventDispatcher } from 'svelte';
  export let activeView = 'employee'; // 'program' | 'employee'

  const dispatch = createEventDispatcher();

  function setView(view) {
      dispatch('change', view);
  }
</script>

<div class="flex justify-start items-center">
    <div class="flex bg-gray-200 p-1 rounded-lg shadow-inner">
        <button 
            class="px-4 py-1.5 rounded-md text-sm font-medium transition-all duration-200 {activeView === 'employee' ? 'bg-white text-blue-600 shadow-sm' : 'text-gray-500 hover:text-gray-700'}"
            on:click={() => setView('employee')}
        >
            Theo Nh√¢n Vi√™n
        </button>
        <button 
            class="px-4 py-1.5 rounded-md text-sm font-medium transition-all duration-200 {activeView === 'program' ? 'bg-white text-blue-600 shadow-sm' : 'text-gray-500 hover:text-gray-700'}"
            on:click={() => setView('program')}
        >
            Theo Ch∆∞∆°ng Tr√¨nh
        </button>
    </div>
</div>
--- END FILE: ./src/components/health-staff/competition/CompetitionModeSelector.svelte ---

--- START FILE: ./src/components/health-staff/competition/EmployeeView.svelte ---
<script>
  import { createEventDispatcher, afterUpdate } from 'svelte';
  import { pastedThiDuaReportData, competitionNameMappings } from '../../../stores.js'; 
  import { settingsService } from '../../../services/settings.service.js';
  import { formatters } from '../../../utils/formatters.js';
  
  export let reportData = []; 
  const dispatch = createEventDispatcher();

  // --- STATE ---
  let columnSettings = [];
  let sortKey = 'hoTen';
  let sortDirection = 'asc';
  
  // D·ªØ li·ªáu ph·∫≥ng
  let allEmployees = [];
  let deptAverages = {}; 

  // Palette m√†u cho header
  const headerColors = [
      'bg-red-100 text-red-900 border-red-200',
      'bg-orange-100 text-orange-900 border-orange-200',
      'bg-amber-100 text-amber-900 border-amber-200',
      'bg-lime-100 text-lime-900 border-lime-200',
      'bg-teal-100 text-teal-900 border-teal-200',
      'bg-cyan-100 text-cyan-900 border-cyan-200',
      'bg-sky-100 text-sky-900 border-sky-200',
      'bg-indigo-100 text-indigo-900 border-indigo-200',
      'bg-fuchsia-100 text-fuchsia-900 border-fuchsia-200',
      'bg-rose-100 text-rose-900 border-rose-200'
  ];

  function getHeaderColor(index) {
      return headerColors[index % headerColors.length];
  }

  // --- REACTIVE PROCESSING ---
  $: {
      if (reportData && reportData.length > 0) {
          let savedSettings = settingsService.loadPastedCompetitionViewSettings();
          // N·∫øu ch∆∞a c√≥ setting l∆∞u, load m·∫∑c ƒë·ªãnh (logic loadPastedCompetitionViewSettings ƒë√£ handle vi·ªác t·∫°o default t·ª´ d·ªØ li·ªáu)
          if (!savedSettings || savedSettings.length === 0) {
              savedSettings = settingsService.loadPastedCompetitionViewSettings();
          }
          columnSettings = savedSettings;

          // Map t√™n hi·ªÉn th·ªã
          columnSettings = columnSettings.map(col => ({
              ...col,
              label: $competitionNameMappings[col.tenGoc] || col.label || col.tenGoc
          }));

          const groups = {};
          reportData.forEach(item => {
              const dept = item.boPhan || 'Ch∆∞a ph√¢n lo·∫°i';
              if (!groups[dept]) groups[dept] = [];
              groups[dept].push(item);
          });

          const avgs = {};
          Object.keys(groups).forEach(deptName => {
              const deptData = groups[deptName];
              const deptAvg = {};
              columnSettings.forEach(col => {
                  let total = 0;
                  let count = 0;
                  deptData.forEach(emp => {
                      const compData = emp.competitions.find(c => c.tenGoc === col.tenGoc);
                      const giaTri = compData?.giaTri || 0;
                      if (giaTri > 0) { 
                          total += giaTri;
                          count++;
                      }
                  });
                  deptAvg[col.tenGoc] = count > 0 ? total / count : 0;
              });
              avgs[deptName] = deptAvg;
          });
          deptAverages = avgs;

          allEmployees = [...reportData];
      } else {
          allEmployees = [];
      }
  }

  $: visibleColumns = columnSettings.filter(col => col.visible);

  // --- SORT LOGIC ---
  function handleSort(key) {
      if (sortKey === key) {
          sortDirection = sortDirection === 'desc' ? 'asc' : 'desc';
      } else {
          sortKey = key;
          sortDirection = key.startsWith('comp_') || key === 'totalScore' ? 'desc' : 'asc';
      }
  }

  $: sortedEmployees = [...allEmployees].sort((a, b) => {
      let valA, valB;
      
      if (sortKey.startsWith('comp_')) {
            const sortCol = columnSettings.find(c => c.id === sortKey);
            if (!sortCol) return 0;
            valA = a.competitions.find(c => c.tenGoc === sortCol.tenGoc)?.giaTri || 0;
            valB = b.competitions.find(c => c.tenGoc === sortCol.tenGoc)?.giaTri || 0;
            return sortDirection === 'asc' ? valA - valB : valB - valA;

      } else if (sortKey === 'totalScore') {
            const getScore = (emp) => {
                const deptAvg = deptAverages[emp.boPhan] || {};
                let score = 0;
                emp.competitions.forEach(comp => {
                    if (deptAvg[comp.tenGoc] > 0 && comp.giaTri >= deptAvg[comp.tenGoc]) score++;
                });
                return score;
            };
            valA = getScore(a);
            valB = getScore(b);
            return sortDirection === 'asc' ? valA - valB : valB - valA;

      } else {
            valA = a[sortKey] || '';
            valB = b[sortKey] || '';
            return sortDirection === 'asc' ? valA.localeCompare(valB) : valB.localeCompare(valA);
      }
  });

  // --- TOGGLE LOGIC ---
  function toggleColumn(col) {
      const newSettings = columnSettings.map(c => 
          c.tenGoc === col.tenGoc ? { ...c, visible: !c.visible } : c
      );
      columnSettings = newSettings;
      settingsService.savePastedCompetitionViewSettings(newSettings);
  }

  // --- FOOTER CALCULATION ---
  function calculateTotal(col) {
      return allEmployees.reduce((sum, emp) => {
          const comp = emp.competitions.find(c => c.tenGoc === col.tenGoc);
          return sum + (comp?.giaTri || 0);
      }, 0);
  }

  function calculateTotalScore() {
      return allEmployees.reduce((total, item) => {
          const avgScores = deptAverages[item.boPhan] || {};
          const score = item.competitions.reduce((acc, c) => (avgScores[c.tenGoc] > 0 && c.giaTri >= avgScores[c.tenGoc]) ? acc + 1 : acc, 0);
          return total + score;
      }, 0);
  }

  // --- VIEW SWITCHING ---
  function switchToProgram() {
      dispatch('viewChange', 'program');
  }

  afterUpdate(() => {
    if (typeof feather !== 'undefined') feather.replace();
  });
</script>

<div class="space-y-4 animate-fade-in">
    {#if reportData.length === 0}
        <div class="p-8 text-center bg-gray-50 border-2 border-dashed border-gray-300 rounded-lg">
            <p class="text-gray-500">Vui l√≤ng d√°n d·ªØ li·ªáu "Thi ƒëua nh√¢n vi√™n" ·ªü tab "C·∫≠p nh·∫≠t d·ªØ li·ªáu".</p>
        </div>
    {:else}
        
        <div class="bg-slate-50 p-3 rounded-lg border border-slate-200">
            <p class="text-xs font-bold text-gray-500 uppercase mb-2">Hi·ªÉn th·ªã c·ªôt:</p>
            <div class="flex flex-wrap gap-2">
                {#each columnSettings as col}
                    <button 
                        type="button"
                        class="px-3 py-1 rounded-full text-xs font-medium border transition-all select-none
                                {col.visible ? 'bg-blue-600 text-white border-blue-600' : 'bg-white text-gray-500 border-gray-300 hover:bg-gray-50'}"
                        on:click={() => toggleColumn(col)}
                        title={col.loaiSoLieu}
                    >
                        {col.label}
                    </button>
                {/each}
            </div>
        </div>

        <div class="bg-white rounded-xl shadow-md border border-gray-200 overflow-hidden" data-capture-group="pasted-competition">
            
            <div class="p-4 bg-white border-b border-gray-200 flex justify-between items-center">
                <div>
                    <h3 class="text-lg font-bold text-purple-800 uppercase flex items-center gap-2">
                        <i data-feather="award" class="w-5 h-5"></i>
                        Thi ƒêua L≈©y K·∫ø
                    </h3>
                    <p class="text-xs text-gray-500 mt-0.5 ml-7">Theo d√µi ti·∫øn ƒë·ªô c√°c ch∆∞∆°ng tr√¨nh thi ƒëua</p>
                </div>

                <div class="flex items-center bg-gray-100 rounded-lg p-1 border border-gray-200 shadow-inner">
                    <button 
                        type="button"
                        class="px-4 py-1.5 rounded-md text-xs font-bold transition-all shadow-sm bg-white text-blue-700 cursor-default"
                    >
                        Nh√¢n vi√™n
                    </button>
                    <button 
                        type="button"
                        class="px-4 py-1.5 rounded-md text-xs font-medium text-gray-500 hover:text-gray-900 hover:bg-gray-200 transition-colors cursor-pointer"
                        on:click={switchToProgram}
                    >
                        Ch∆∞∆°ng tr√¨nh
                    </button>
                </div>
            </div>
            
            <div class="overflow-x-auto sknv-pasted-competition-scroller relative" style="max-height: 700px;">
                <table class="w-full text-sm text-left border-separate border-spacing-0">
                    <thead class="text-xs uppercase font-bold text-gray-700 sticky top-0 z-20 shadow-sm">
                        <tr>
                            <th class="bg-gray-100 border-b border-r border-gray-200 min-w-[150px] w-[150px] sticky left-0 z-30 px-2 py-2 cursor-pointer hover:bg-gray-200 transition select-none align-middle text-sm" on:click={() => handleSort('hoTen')}>
                                Nh√¢n vi√™n
                            </th>
                            
                            <th class="bg-gray-100 border-b border-r border-gray-200 w-[100px] min-w-[100px] sticky left-[150px] z-30 px-1 py-2 text-center cursor-pointer hover:bg-gray-200 transition select-none align-middle" on:click={() => handleSort('totalScore')}>
                                ƒê·∫°t
                            </th>

                            {#each visibleColumns as col, index}
                                <th 
                                    class="px-1 py-1 w-auto min-w-[60px] max-w-[90px] whitespace-normal break-words border-b border-r border-gray-200 {getHeaderColor(index)} align-middle cursor-pointer hover:opacity-80 transition select-none"
                                    on:click={() => handleSort(col.id)}
                                    title="{col.label} (B·∫•m ƒë·ªÉ s·∫Øp x·∫øp)"
                                >
                                    <div class="text-[10px] font-bold leading-3 text-center whitespace-normal break-words min-h-[32px] flex items-center justify-center">
                                        {col.label}
                                    </div>
                                </th>
                            {/each}
                        </tr>
                    </thead>
                    
                    <tbody class="divide-y divide-gray-100">
                        {#each sortedEmployees as item (item.maNV)}
                            {@const avgScores = deptAverages[item.boPhan] || {}}
                            {@const score = item.competitions.reduce((acc, c) => (avgScores[c.tenGoc] > 0 && c.giaTri >= avgScores[c.tenGoc]) ? acc + 1 : acc, 0)}
                            
                            <tr 
                                class="hover:bg-blue-50 transition-colors group cursor-pointer"
                                on:click={() => dispatch('viewDetail', { employeeId: item.maNV })}
                            >
                                <td class="px-2 py-1.5 font-semibold text-blue-700 bg-white group-hover:bg-blue-50 sticky left-0 z-10 border-r border-gray-200 whitespace-nowrap text-[13px] truncate max-w-[150px]" title="{item.hoTen} - {item.maNV}">
                                    {formatters.getShortEmployeeName(item.hoTen, item.maNV)}
                                </td>
                                
                                <td class="px-1 py-1.5 w-[100px] min-w-[100px] text-center font-bold text-green-600 bg-white group-hover:bg-blue-50 border-r border-gray-200 text-[14px] sticky left-[150px] z-10">
                                    {score}
                                </td>

                                {#each visibleColumns as col}
                                    {@const comp = item.competitions.find(c => c.tenGoc === col.tenGoc)}
                                    {@const val = comp?.giaTri || 0}
                                    {@const avg = avgScores[col.tenGoc] || 0}
                                    {@const isBelow = avg > 0 && val < avg}
                                    {@const isRevenue = col.loaiSoLieu && col.loaiSoLieu.includes('DT')}
                                    {@const textColorClass = isRevenue ? 'text-blue-700' : 'text-gray-900'}
                                    
                                    <td class="px-1 py-1.5 text-right border-r border-gray-100 font-bold text-[13px] {isBelow ? 'bg-red-50' : ''} {textColorClass} whitespace-nowrap overflow-hidden">
                                        {#if val === 0}
                                            <span class="text-gray-300 font-normal">-</span>
                                        {:else}
                                            {formatters.formatNumber(val)}
                                        {/if}
                                    </td>
                                {/each}
                            </tr>
                        {/each}
                    </tbody>
                    
                    <tfoot class="text-xs uppercase sticky bottom-0 z-20 shadow-[0_-1px_2px_rgba(0,0,0,0.1)]">
                        <tr class="bg-yellow-50 text-yellow-800 font-semibold border-t-2 border-gray-300">
                            <td class="px-2 py-2 sticky left-0 bg-yellow-100 border-r border-gray-300 z-30 text-center text-[13px]">
                                TRUNG B√åNH
                            </td>
                            <td class="px-2 py-2 border-r border-gray-300 bg-yellow-100 sticky left-[150px] z-30 text-center text-[13px] font-bold text-green-700">
                                {allEmployees.length > 0 ? formatters.formatNumber(calculateTotalScore() / allEmployees.length, 1) : 0}
                            </td>
                            {#each visibleColumns as col}
                                <td class="px-1 py-2 text-right border-r border-gray-300 text-[13px]">
                                    {allEmployees.length > 0 ? formatters.formatNumber(calculateTotal(col) / allEmployees.length, 0) : 0}
                                </td>
                            {/each}
                        </tr>

                        <tr class="bg-gray-200 text-gray-900 font-bold border-t border-gray-300">
                            <td class="px-2 py-2 sticky left-0 bg-gray-300 border-r border-gray-300 z-30 text-center text-[13px]">
                                T·ªîNG
                            </td>
                            <td class="px-2 py-2 border-r border-gray-300 bg-gray-300 sticky left-[150px] z-30 text-center text-[13px]">
                                {calculateTotalScore()}
                            </td>
                            {#each visibleColumns as col}
                                <td class="px-1 py-2 text-right border-r border-gray-300 text-[13px]">
                                    {formatters.formatNumber(calculateTotal(col))}
                                </td>
                            {/each}
                        </tr>
                    </tfoot>
                </table>
            </div>
        </div>
    {/if}
</div>

<style>
    .animate-fade-in { animation: fadeIn 0.4s ease-out; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    .sticky { position: sticky; }
    
    .custom-scrollbar::-webkit-scrollbar { width: 4px; height: 4px; }
    .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
    .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 2px; }

    table { border-spacing: 0; }
    /* CSS cho Line Clamp 2 d√≤ng */
    .line-clamp-2 {
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
    }
</style>
--- END FILE: ./src/components/health-staff/competition/EmployeeView.svelte ---

--- START FILE: ./src/components/health-staff/competition/FocusCompetitionTable.svelte ---
<script>
  import { formatters } from '../../../utils/formatters.js';
  
  // Nh·∫≠n d·ªØ li·ªáu c·ªßa 1 ch∆∞∆°ng tr√¨nh ƒë√£ ƒë∆∞·ª£c t√≠nh to√°n
  export let competitionResult; 
  
  // Destructure d·ªØ li·ªáu
  $: competition = competitionResult.competition;
  $: employeeData = competitionResult.employeeData;
  $: brands = competition.brands || [];
  
  // State s·∫Øp x·∫øp
  let sortKey = 'tyLeDT';
  let sortDirection = 'desc';

  function handleSort(key) {
      if (sortKey === key) {
          sortDirection = sortDirection === 'desc' ? 'asc' : 'desc';
      } else {
          sortKey = key;
          sortDirection = 'desc';
      }
  }

  // Logic s·∫Øp x·∫øp d·ªØ li·ªáu
  $: sortedData = [...employeeData].sort((a, b) => {
      let valA = 0;
      let valB = 0;

      if (sortKey === 'hoTen') {
          return sortDirection === 'asc' 
              ? a.hoTen.localeCompare(b.hoTen) 
              : b.hoTen.localeCompare(a.hoTen);
      } 
      // Sort ƒë·ªông cho c√°c c·ªôt h√£ng (VD: samsung_quantity)
      else if (sortKey.includes('_quantity') || sortKey.includes('_revenue')) {
          const [brandName, type] = sortKey.split('_');
          const perfA = a.performanceByBrand[brandName] || { quantity: 0, revenue: 0 };
          const perfB = b.performanceByBrand[brandName] || { quantity: 0, revenue: 0 };
          valA = perfA[type] || 0;
          valB = perfB[type] || 0;
      } 
      else {
          valA = Number(a[sortKey]) || 0;
          valB = Number(b[sortKey]) || 0;
      }
      return sortDirection === 'asc' ? valA - valB : valB - valA;
  });

  // T√≠nh t·ªïng footer
  $: totals = employeeData.reduce((acc, item) => {
      acc.baseCategoryQuantity += item.baseCategoryQuantity;
      acc.baseCategoryRevenue += item.baseCategoryRevenue;
      brands.forEach(brand => {
          if (!acc.performanceByBrand[brand]) acc.performanceByBrand[brand] = { quantity: 0, revenue: 0 };
          const perf = item.performanceByBrand[brand] || { quantity: 0, revenue: 0 };
          acc.performanceByBrand[brand].quantity += perf.quantity;
          acc.performanceByBrand[brand].revenue += perf.revenue;
      });
      return acc;
  }, { baseCategoryQuantity: 0, baseCategoryRevenue: 0, performanceByBrand: {} });

  $: totalTyLeDT = totals.baseCategoryRevenue > 0 ? 
     Object.values(totals.performanceByBrand).reduce((sum, b) => sum + b.revenue, 0) / totals.baseCategoryRevenue : 0;

  // Helper class
  const headerClass = (key) => `px-2 py-3 cursor-pointer select-none hover:bg-indigo-100 transition ${sortKey === key ? 'bg-indigo-50 text-indigo-700' : ''}`;
</script>

<div class="bg-white rounded-xl shadow-md border border-gray-200 overflow-hidden flex flex-col h-full">
    <div class="p-4 bg-gray-50 border-b-2 border-indigo-200 flex justify-between items-center">
        <div>
            <h3 class="text-lg font-bold text-indigo-800 uppercase">{competition.name}</h3>
            <p class="text-xs text-indigo-600 font-medium mt-1">
                H√£ng: <span class="font-bold">{brands.join(', ')}</span>
            </p>
        </div>
        <div class="bg-white px-3 py-1 rounded border border-indigo-100 text-xs font-medium text-gray-500">
            M·ª•c ti√™u: {competition.target || 0}%
        </div>
    </div>

    <div class="overflow-x-auto flex-grow">
        <table class="min-w-full text-sm text-left border-collapse">
            <thead class="text-xs text-slate-700 uppercase bg-slate-100 font-bold sticky top-0 z-10">
                <tr>
                    <th rowspan="2" class="{headerClass('hoTen')} bg-gray-200 min-w-[180px]" on:click={() => handleSort('hoTen')}>
                        Nh√¢n vi√™n {sortKey === 'hoTen' ? (sortDirection === 'asc' ? '‚ñ≤' : '‚ñº') : ''}
                    </th>
                    {#each brands as brand}
                        <th colspan="2" class="px-2 py-1 text-center border-l border-gray-300 bg-purple-100 text-purple-900">{brand}</th>
                    {/each}
                    <th colspan="2" class="px-2 py-1 text-center border-l border-gray-300 bg-blue-100 text-blue-900">T·ªïng Nh√≥m</th>
                    <th colspan="2" class="px-2 py-1 text-center border-l border-gray-300 bg-orange-100 text-orange-900">T·ª∑ l·ªá</th>
                </tr>
                <tr>
                    {#each brands as brand}
                        <th class="{headerClass(`${brand}_quantity`)} text-right border-l border-gray-200" on:click={() => handleSort(`${brand}_quantity`)}>SL</th>
                        <th class="{headerClass(`${brand}_revenue`)} text-right" on:click={() => handleSort(`${brand}_revenue`)}>DT</th>
                    {/each}
                    
                    <th class="{headerClass('baseCategoryQuantity')} text-right border-l border-gray-200" on:click={() => handleSort('baseCategoryQuantity')}>SL</th>
                    <th class="{headerClass('baseCategoryRevenue')} text-right" on:click={() => handleSort('baseCategoryRevenue')}>DT</th>
                    
                    <th class="{headerClass('tyLeSL')} text-right border-l border-gray-200" on:click={() => handleSort('tyLeSL')}>% SL</th>
                    <th class="{headerClass('tyLeDT')} text-right" on:click={() => handleSort('tyLeDT')}>% DT</th>
                </tr>
            </thead>
            
            <tbody class="divide-y divide-gray-100">
                {#each sortedData as item}
                    <tr class="hover:bg-indigo-50 transition-colors">
                        <td class="px-4 py-2 font-semibold text-indigo-900 whitespace-nowrap sticky left-0 bg-white hover:bg-indigo-50 border-r border-gray-200">
                            {formatters.getShortEmployeeName(item.hoTen, item.maNV)}
                        </td>
                        
                        {#each brands as brand}
                            {@const perf = item.performanceByBrand[brand] || {quantity: 0, revenue: 0}}
                            <td class="px-2 py-2 text-right border-l border-gray-100 text-gray-500">{formatters.formatNumberOrDash(perf.quantity)}</td>
                            <td class="px-2 py-2 text-right font-medium">{formatters.formatRevenue(perf.revenue)}</td>
                        {/each}

                        <td class="px-2 py-2 text-right border-l border-gray-200 font-bold bg-blue-50/30">{formatters.formatNumberOrDash(item.baseCategoryQuantity)}</td>
                        <td class="px-2 py-2 text-right font-bold bg-blue-50/30">{formatters.formatRevenue(item.baseCategoryRevenue)}</td>
                        
                        <td class="px-2 py-2 text-right border-l border-gray-200 text-gray-500">{formatters.formatPercentage(item.tyLeSL)}</td>
                        <td class="px-2 py-2 text-right font-bold {item.tyLeDT >= (competition.target/100) ? 'text-green-600' : 'text-red-500'}">{formatters.formatPercentage(item.tyLeDT)}</td>
                    </tr>
                {/each}
            </tbody>
            
            <tfoot class="bg-gray-100 font-bold text-gray-800 border-t-2 border-gray-300">
                <tr>
                    <td class="px-4 py-2">T·ªïng</td>
                    {#each brands as brand}
                        {@const perf = totals.performanceByBrand[brand] || {quantity: 0, revenue: 0}}
                        <td class="px-2 py-2 text-right border-l border-gray-200">{formatters.formatNumberOrDash(perf.quantity)}</td>
                        <td class="px-2 py-2 text-right">{formatters.formatRevenue(perf.revenue)}</td>
                    {/each}
                    <td class="px-2 py-2 text-right border-l border-gray-200">{formatters.formatNumberOrDash(totals.baseCategoryQuantity)}</td>
                    <td class="px-2 py-2 text-right">{formatters.formatRevenue(totals.baseCategoryRevenue)}</td>
                    <td class="px-2 py-2 text-right border-l border-gray-200">-</td>
                    <td class="px-2 py-2 text-right text-blue-700">{formatters.formatPercentage(totalTyLeDT)}</td>
                </tr>
            </tfoot>
        </table>
    </div>
</div>
--- END FILE: ./src/components/health-staff/competition/FocusCompetitionTable.svelte ---

--- START FILE: ./src/components/health-staff/competition/ProgramView.svelte ---
<script>
  import FocusCompetitionTable from './FocusCompetitionTable.svelte';

  export let reportData = []; // M·∫£ng k·∫øt qu·∫£ t√≠nh to√°n t·ª´ service
</script>

{#if reportData.length === 0}
    <div class="p-12 text-center bg-white border-2 border-dashed border-gray-300 rounded-xl">
        <p class="text-gray-500 font-medium">Kh√¥ng c√≥ d·ªØ li·ªáu ch∆∞∆°ng tr√¨nh thi ƒëua.</p>
        <p class="text-sm text-gray-400 mt-2">
            Vui l√≤ng ki·ªÉm tra:
            1. ƒê√£ t·∫°o ch∆∞∆°ng tr√¨nh trong "Thi·∫øt l·∫≠p m·ª•c ti√™u"?
            2. ƒê√£ t·∫£i file YCX?
            3. C√≥ ph√°t sinh doanh thu cho c√°c nh√≥m h√†ng ƒë√£ ch·ªçn?
        </p>
    </div>
{:else}
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 pb-10">
        {#each reportData as result (result.competition.id)}
            <div class="h-full">
                <FocusCompetitionTable competitionResult={result} />
            </div>
        {/each}
    </div>
{/if}
--- END FILE: ./src/components/health-staff/competition/ProgramView.svelte ---

--- START FILE: ./src/components/health-staff/detail/CardFilter.svelte ---
<script>
    import { createEventDispatcher } from 'svelte';
    
    export let items = []; // Array { id, label, visible }

    const dispatch = createEventDispatcher();
    let isOpen = false;
    let containerRef; 

    function toggleDropdown() {
        isOpen = !isOpen;
    }

    function toggleItem(id) {
        dispatch('change', id);
    }

    // ƒê√≥ng dropdown khi click ra ngo√†i container c·ªßa ch√≠nh component n√†y
    function close(e) {
        if (isOpen && containerRef && !containerRef.contains(e.target)) {
            isOpen = false;
        }
    }
</script>

<svelte:window on:click={close} />

<div class="relative inline-block text-left" bind:this={containerRef}>
    <button 
        type="button" 
        class="text-white/70 hover:text-white p-1 rounded-full hover:bg-white/20 transition-colors"
        on:click|stopPropagation={toggleDropdown}
        title="L·ªçc ch·ªâ s·ªë hi·ªÉn th·ªã"
    >
        <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z" />
        </svg>
    </button>

    {#if isOpen}
        <div class="absolute right-0 mt-2 w-64 bg-white rounded-lg shadow-xl border border-gray-200 z-[100] animate-fade-in-fast origin-top-right">
            <div class="p-2 border-b border-gray-100 bg-gray-50 rounded-t-lg">
                <span class="text-xs font-bold text-gray-500 uppercase">Hi·ªÉn th·ªã ch·ªâ s·ªë</span>
            </div>
            <div class="p-1 max-h-60 overflow-y-auto custom-scrollbar">
                {#if items.length === 0}
                    <div class="px-3 py-2 text-xs text-gray-400 text-center">Kh√¥ng c√≥ m·ª•c n√†o.</div>
                {:else}
                    {#each items as item (item.id)}
                        <label class="flex items-center px-3 py-2 hover:bg-gray-50 cursor-pointer rounded transition-colors group">
                            <input 
                                type="checkbox" 
                                checked={item.visible !== false} 
                                on:change={() => toggleItem(item.id)}
                                class="mr-3 h-4 w-4 text-blue-600 rounded border-gray-300 focus:ring-blue-500 cursor-pointer"
                            >
                            <span class="text-sm text-gray-700 group-hover:text-blue-700 truncate select-none" title={item.label}>
                                {item.label}
                            </span>
                        </label>
                    {/each}
                {/if}
            </div>
        </div>
    {/if}
</div>

<style>
    .animate-fade-in-fast { animation: fadeIn 0.1s ease-out; }
    @keyframes fadeIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
    
    .custom-scrollbar::-webkit-scrollbar { width: 4px; }
    .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
    .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 2px; }
</style>
--- END FILE: ./src/components/health-staff/detail/CardFilter.svelte ---

--- START FILE: ./src/components/health-staff/detail/DetailHeader.svelte ---
<script>
  // Component hi·ªÉn th·ªã Header c·ªßa trang chi ti·∫øt
  export let employee;
  export let totalAbove = 0;
  export let totalCriteria = 0;
  // [M·ªöI] Prop ƒë·ªÉ ƒëi·ªÅu khi·ªÉn hi·ªÉn th·ªã d√≤ng ƒë√°nh gi√°
  export let showStats = true;
</script>

<div class="flex items-center gap-6 p-4 bg-purple-50 border border-purple-200 border-t-4 border-t-purple-500 rounded-lg shadow-sm mb-6">
    <div class="w-16 h-16 rounded-full bg-purple-200 flex items-center justify-center flex-shrink-0 text-purple-800">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-8 h-8">
            <path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/>
        </svg>
    </div>
    
    <div class="flex-grow">
        <p class="text-2xl font-extrabold text-purple-800 leading-tight">
             {employee.hoTen} <span class="text-lg font-semibold text-purple-600">- {employee.maNV}</span>
        </p>
        <p class="text-gray-700 font-medium text-base">{employee.boPhan}</p>
        
        {#if showStats}
            <p class="mt-1 text-sm font-semibold text-gray-800">
                Ch·ªâ s·ªë tr√™n TB: <span class="text-green-600 font-bold text-lg">{totalAbove}</span> 
                <span class="text-gray-400 mx-1">/</span> 
                T·ªïng: <span class="font-bold text-gray-600">{totalCriteria}</span>
            </p>
        {/if}
    </div>
</div>
--- END FILE: ./src/components/health-staff/detail/DetailHeader.svelte ---

--- START FILE: ./src/components/health-staff/detail/DetailTableCategory.svelte ---
<script>
  import { formatters } from '../../../utils/formatters.js';
  import { cleanCategoryName } from '../../../utils.js';
  import { categoryStructure, macroCategoryConfig } from '../../../stores.js'; 
  import CardFilter from './CardFilter.svelte';

  export let data = []; 
  export let rawEmployee = null; 

  const headerClass = "bg-[#7e22ce]";

  // H√†m chu·∫©n h√≥a key ƒë·ªÉ so s√°nh (vi·∫øt th∆∞·ªùng + b·ªè kho·∫£ng tr·∫Øng th·ª´a)
  const normalizeKey = (str) => {
      if (!str) return '';
      return String(str).trim().toLowerCase();
  };

  let displayData = [];
  let filterItems = [];
  
  // State hi·ªÉn th·ªã (L∆∞u danh s√°ch c√°c KEY ƒë√£ chu·∫©n h√≥a)
  let visibleKeys = new Set();
  let isInitialized = false;

  // Logic x·ª≠ l√Ω d·ªØ li·ªáu ch√≠nh
  $: {
      // 1. Thu th·∫≠p t·∫•t c·∫£ c√°c t√™n ng√†nh h√†ng t·ª´ m·ªçi ngu·ªìn
      const source1 = ($macroCategoryConfig || []).map(m => m.name);
      const source2 = ($categoryStructure || []).map(c => cleanCategoryName(c.nganhHang)).filter(Boolean);
      const source3 = data.map(i => i.name);
      
      // Danh s√°ch t√™n g·ªëc ƒë·ªÉ hi·ªÉn th·ªã
      const allRawNames = [...source1, ...source2, ...source3];

      // 2. G·ªôp d·ªØ li·ªáu v√†o Map ƒë·ªÉ kh·ª≠ tr√πng l·∫∑p d·ª±a tr√™n key chu·∫©n h√≥a
      const mergedMap = new Map();

      allRawNames.forEach(rawName => {
          const key = normalizeKey(rawName);
          if (!key) return;

          // N·∫øu ch∆∞a c√≥ trong Map, t·∫°o m·ªõi
          if (!mergedMap.has(key)) {
              // ∆Øu ti√™n l·∫•y s·ªë li·ªáu t·ª´ 'data' (ƒë√£ t√≠nh to√°n)
              let existingItem = data.find(i => normalizeKey(i.name) === key);
              
              // N·∫øu kh√¥ng c√≥, l·∫•y t·ª´ rawEmployee (tra c·ª©u an to√†n)
              if (!existingItem && rawEmployee?.doanhThuTheoNganhHang) {
                  // C·∫ßn t√¨m key g·ªëc trong object rawEmployee kh·ªõp v·ªõi key chu·∫©n h√≥a
                  const rawKey = Object.keys(rawEmployee.doanhThuTheoNganhHang).find(k => normalizeKey(k) === key);
                  if (rawKey) {
                      existingItem = rawEmployee.doanhThuTheoNganhHang[rawKey];
                  }
              }

              // T·∫°o object hi·ªÉn th·ªã
              mergedMap.set(key, {
                  id: key, // D√πng key chu·∫©n h√≥a l√†m ID duy nh·∫•t cho v√≤ng l·∫∑p
                  name: rawName, // T√™n hi·ªÉn th·ªã (l·∫•y c√°i ƒë·∫ßu ti√™n t√¨m th·∫•y)
                  quantity: existingItem ? existingItem.quantity : 0,
                  revenue: existingItem ? existingItem.revenue : 0,
                  revenueQuyDoi: existingItem ? existingItem.revenueQuyDoi : 0
              });
          }
      });

      // 3. Kh·ªüi t·∫°o tr·∫°ng th√°i filter (ch·ªâ ch·∫°y 1 l·∫ßn ƒë·∫ßu)
      if (!isInitialized && mergedMap.size > 0) {
          // M·∫∑c ƒë·ªãnh hi·ªán nh·ªØng c√°i c√≥ s·ªë li·ªáu > 0
          mergedMap.forEach((val, key) => {
              if (val.revenue > 0 || val.quantity > 0) {
                  visibleKeys.add(key);
              }
          });
          // N·∫øu nh√¢n vi√™n kh√¥ng c√≥ d·ªØ li·ªáu g√¨, hi·ªán t·∫•t c·∫£ ho·∫∑c top 10 (tu·ª≥ ch·ªçn), ·ªü ƒë√¢y ta ƒë·ªÉ tr·ªëng
          visibleKeys = new Set(visibleKeys);
          isInitialized = true;
      }

      // 4. T·∫°o danh s√°ch hi·ªÉn th·ªã cu·ªëi c√πng
      displayData = Array.from(mergedMap.values())
          .filter(item => visibleKeys.has(item.id))
          .sort((a, b) => b.revenue - a.revenue);

      // 5. T·∫°o danh s√°ch cho b·ªô l·ªçc
      // Sort b·ªô l·ªçc theo t√™n A-Z ƒë·ªÉ d·ªÖ t√¨m
      filterItems = Array.from(mergedMap.values())
          .map(item => ({
              id: item.id,
              label: item.name,
              visible: visibleKeys.has(item.id)
          }))
          .sort((a, b) => a.label.localeCompare(b.label));
  }

  function handleFilterChange(event) {
      const id = event.detail; // id nh·∫≠n ƒë∆∞·ª£c l√† key ƒë√£ chu·∫©n h√≥a
      if (visibleKeys.has(id)) {
          visibleKeys.delete(id);
      } else {
          visibleKeys.add(id);
      }
      visibleKeys = new Set(visibleKeys); // Trigger reactivity
  }
</script>

<div class="bg-white rounded-xl shadow-md border border-gray-200 overflow-hidden flex flex-col h-full">
    <div class="{headerClass} flex justify-between items-center p-3 text-white">
        <div class="flex items-center gap-2">
            <i data-feather="list" class="w-5 h-5"></i>
            <h4 class="text-lg font-bold">Doanh thu ng√†nh h√†ng</h4>
        </div>
        <CardFilter items={filterItems} on:change={handleFilterChange} />
    </div>
    
    <div class="overflow-x-auto max-h-96">
        <table class="w-full text-sm table-bordered table-striped">
            <thead class="bg-gray-50 font-bold text-gray-700 sticky top-0 z-10">
                <tr>
                    <th class="px-3 py-2 text-left">Ng√†nh h√†ng</th>
                    <th class="px-3 py-2 text-right">SL</th>
                    <th class="px-3 py-2 text-right">Doanh thu</th>
                    <th class="px-3 py-2 text-right">DTQƒê</th>
                </tr>
            </thead>
            <tbody>
                {#if displayData.length === 0}
                    <tr><td colspan="4" class="p-4 text-center text-gray-500">ƒê√£ ·∫©n h·∫øt d·ªØ li·ªáu.</td></tr>
                {:else}
                    {#each displayData as item (item.id)}
                        <tr class="border-t hover:bg-slate-50 transition-colors">
                            <td class="px-3 py-2 font-medium capitalize text-gray-800">{item.name}</td>
                            <td class="px-3 py-2 text-right font-bold text-gray-600">{formatters.formatNumber(item.quantity)}</td>
                            <td class="px-3 py-2 text-right font-bold text-gray-800">{formatters.formatRevenue(item.revenue, 0)}</td>
                            <td class="px-3 py-2 text-right font-bold text-purple-600">{formatters.formatRevenue(item.revenueQuyDoi, 0)}</td>
                        </tr>
                    {/each}
                {/if}
            </tbody>
        </table>
    </div>
</div>
--- END FILE: ./src/components/health-staff/detail/DetailTableCategory.svelte ---

--- START FILE: ./src/components/health-staff/detail/DetailTableQDC.svelte ---
<script>
  import { formatters } from '../../../utils/formatters.js';
  import { cleanCategoryName } from '../../../utils.js';
  import { categoryStructure, macroProductGroupConfig } from '../../../stores.js'; 
  import CardFilter from './CardFilter.svelte';

  export let data = []; 
  export let rawEmployee = null; 

  const headerClass = "bg-[#4f46e5]"; 

  const normalizeKey = (str) => {
      if (!str) return '';
      return String(str).trim().toLowerCase();
  };

  let displayData = [];
  let filterItems = [];
  let visibleKeys = new Set();
  let isInitialized = false;

  $: {
      const source1 = ($macroProductGroupConfig || []).map(m => m.name);
      const source2 = ($categoryStructure || []).map(c => cleanCategoryName(c.nhomHang)).filter(Boolean);
      const source3 = data.map(i => i.name);
      const allRawNames = [...source1, ...source2, ...source3];

      const mergedMap = new Map();

      allRawNames.forEach(rawName => {
          const key = normalizeKey(rawName);
          if (!key) return;

          if (!mergedMap.has(key)) {
              let existingItem = data.find(i => normalizeKey(i.name) === key);
              
              if (!existingItem) {
                  // Th·ª≠ t√¨m trong nhomHangChiTiet
                  if (rawEmployee?.doanhThuTheoNhomHang) {
                      const rawKey = Object.keys(rawEmployee.doanhThuTheoNhomHang).find(k => normalizeKey(k) === key);
                      if (rawKey) existingItem = rawEmployee.doanhThuTheoNhomHang[rawKey];
                  }
                  // N·∫øu kh√¥ng th·∫•y, th·ª≠ t√¨m trong qdc (v√¨ QƒêC c≈©ng l√† nh√≥m h√†ng)
                  if (!existingItem && rawEmployee?.qdc) {
                      const rawKey = Object.keys(rawEmployee.qdc).find(k => normalizeKey(k) === key);
                      if (rawKey) existingItem = rawEmployee.qdc[rawKey];
                  }
              }

              mergedMap.set(key, {
                  id: key,
                  name: rawName,
                  sl: existingItem ? (existingItem.sl || existingItem.quantity || 0) : 0,
                  dtqd: existingItem ? (existingItem.dtqd || existingItem.revenueQuyDoi || 0) : 0
              });
          }
      });

      if (!isInitialized && mergedMap.size > 0) {
          mergedMap.forEach((val, key) => {
              if (val.dtqd > 0 || val.sl > 0) visibleKeys.add(key);
          });
          visibleKeys = new Set(visibleKeys);
          isInitialized = true;
      }

      displayData = Array.from(mergedMap.values())
          .filter(item => visibleKeys.has(item.id))
          .sort((a, b) => b.dtqd - a.dtqd);

      filterItems = Array.from(mergedMap.values())
          .map(item => ({
              id: item.id,
              label: item.name,
              visible: visibleKeys.has(item.id)
          }))
          .sort((a, b) => a.label.localeCompare(b.label));
  }

  function handleFilterChange(event) {
      const id = event.detail;
      if (visibleKeys.has(id)) visibleKeys.delete(id);
      else visibleKeys.add(id);
      visibleKeys = new Set(visibleKeys);
  }
</script>

<div class="bg-white rounded-xl shadow-md border border-gray-200 overflow-hidden flex flex-col h-full">
    <div class="{headerClass} flex justify-between items-center p-3 text-white">
        <div class="flex items-center gap-2">
            <i data-feather="star" class="w-5 h-5"></i>
            <h4 class="text-lg font-bold">Nh√≥m h√†ng Quy ƒë·ªïi cao</h4>
        </div>
        <CardFilter items={filterItems} on:change={handleFilterChange} />
    </div>
    
    <div class="overflow-x-auto max-h-96">
        <table class="w-full text-sm table-bordered table-striped">
            <thead class="bg-gray-50 font-bold text-gray-700 sticky top-0 z-10">
                <tr>
                    <th class="px-3 py-2 text-left">Nh√≥m h√†ng</th>
                    <th class="px-3 py-2 text-right">SL</th>
                    <th class="px-3 py-2 text-right">DTQƒê (Tr)</th>
                </tr>
            </thead>
            <tbody>
                {#if displayData.length === 0}
                    <tr><td colspan="3" class="p-4 text-center text-gray-500">ƒê√£ ·∫©n h·∫øt d·ªØ li·ªáu.</td></tr>
                {:else}
                    {#each displayData as item (item.id)}
                        <tr class="border-t hover:bg-slate-50 transition-colors">
                            <td class="px-3 py-2 font-medium text-gray-800">{item.name}</td>
                            <td class="px-3 py-2 text-right font-bold text-gray-600">{formatters.formatNumber(item.sl)}</td>
                            <td class="px-3 py-2 text-right font-bold text-blue-600">{formatters.formatRevenue(item.dtqd)}</td>
                        </tr>
                    {/each}
                {/if}
            </tbody>
        </table>
    </div>
</div>
--- END FILE: ./src/components/health-staff/detail/DetailTableQDC.svelte ---

--- START FILE: ./src/components/health-staff/detail/DetailView.svelte ---
<script>
  import { afterUpdate, createEventDispatcher, onMount } from 'svelte';
  import { masterReportData, selectedWarehouse, warehouseCustomMetrics } from '../../../stores.js';
  import { sknvService } from '../../../services/sknv.service.js';
  import { datasyncService } from '../../../services/datasync.service.js';
  
  import DetailHeader from './DetailHeader.svelte';
  import MetricGrid from './MetricGrid.svelte';
  import DetailTableQDC from './DetailTableQDC.svelte';
  import DetailTableCategory from './DetailTableCategory.svelte';
  
  import AddEfficiencyColumnModal from '../../modals/AddEfficiencyColumnModal.svelte';
  import AddMetricModal from '../../modals/AddMetricModal.svelte';

  export let employeeId;

  const dispatch = createEventDispatcher();

  let employeeData = null;
  let rawEmployeeData = null;
  let detailStats = {};
  let qdcData = [];
  let nganhHangData = [];
  
  let kpiCounts = {
      'Doanh thu': { above: 0, total: 0 },
      'Hi·ªáu qu·∫£ khai th√°c': { above: 0, total: 0 },
      'NƒÉng su·∫•t': { above: 0, total: 0 },
      'ƒê∆°n gi√°': { above: 0, total: 0 }
  };
  
  // State qu·∫£n l√Ω hi·ªÉn th·ªã Modal
  let isEffModalOpen = false;
  let isMetricModalOpen = false;
  let itemToEdit = null;

  // [KH√îI PH·ª§C] Hai d√≤ng quan tr·ªçng b·ªã thi·∫øu g√¢y l·ªói ReferenceError
  $: totalAbove = Object.values(kpiCounts).reduce((sum, item) => sum + item.above, 0);
  $: totalCriteria = Object.values(kpiCounts).reduce((sum, item) => sum + item.total, 0);

  // Logic t·∫£i d·ªØ li·ªáu t·ª´ Cloud khi Warehouse thay ƒë·ªïi
  $: if ($selectedWarehouse) {
      loadMetricsFromCloud($selectedWarehouse);
  }

  async function loadMetricsFromCloud(kho) {
      const data = await datasyncService.loadCustomMetrics(kho);
      warehouseCustomMetrics.set(data);
  }

  // Reactive: T√≠nh to√°n l·∫°i khi Store metrics thay ƒë·ªïi HO·∫∂C employeeId thay ƒë·ªïi
  $: calculateEmployeeData(employeeId, $masterReportData, $warehouseCustomMetrics);

  function calculateEmployeeData(id, masterData, metrics) {
      if (!id || masterData.sknv.length === 0) return;

      const rawEmployee = masterData.sknv.find(e => String(e.maNV) === String(id));
      
      if (rawEmployee) {
          rawEmployeeData = rawEmployee;
          const deptAvg = sknvService.calculateDepartmentAverages(rawEmployee.boPhan, masterData.sknv);
          
          // T√≠nh to√°n c√°c ch·ªâ s·ªë custom (L·∫•y t·ª´ Store)
          if(metrics && metrics.length > 0) {
              const departmentEmployees = masterData.sknv.filter(e => e.boPhan === rawEmployee.boPhan);
              metrics.forEach(m => {
                  let totalVal = 0;
                  let count = 0;
                  departmentEmployees.forEach(emp => {
                      totalVal += sknvService.calculateDynamicMetricValue(emp, m);
                      count++;
                  });
                  deptAvg[`custom_${m.id}`] = count > 0 ? totalVal / count : 0;
              });
          }

          // G√°n d·ªØ li·ªáu
          employeeData = rawEmployee;
          detailStats = sknvService.getDetailStats(rawEmployee, deptAvg, metrics);

          if (rawEmployee.qdc) {
              qdcData = Object.entries(rawEmployee.qdc)
                  .map(([id, val]) => ({ id, ...val }))
                  .filter(item => (item.sl || 0) > 0)
                  .sort((a, b) => b.dtqd - a.dtqd);
          } else { qdcData = []; }

          if (rawEmployee.doanhThuTheoNganhHang) {
              nganhHangData = Object.entries(rawEmployee.doanhThuTheoNganhHang)
                  .map(([name, val]) => ({ name, ...val }))
                  .filter(item => (item.revenue || 0) > 0)
                  .sort((a, b) => b.revenue - a.revenue);
          } else { nganhHangData = []; }
      }
  }

  function handleCountUpdate(event) {
      const { title, above, total } = event.detail;
      let key = title;
      if (title === 'Hi·ªáu qu·∫£') key = 'Hi·ªáu qu·∫£ khai th√°c'; 
      if (kpiCounts[key]) {
          kpiCounts[key] = { above, total };
          kpiCounts = { ...kpiCounts };
      }
  }

  function handleEditMetric(event) {
      const metricItem = event.detail;
      if (metricItem && metricItem.rawConfig) {
          itemToEdit = metricItem.rawConfig;
          if (metricItem.rawConfig.type === 'UNIT_PRICE') {
              isMetricModalOpen = true;
          } else {
              isEffModalOpen = true;
          }
      }
  }

  async function handleDeleteMetric(event) {
      const idToDelete = event.detail;
      if (confirm("B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a ch·ªâ s·ªë n√†y kh√¥ng?")) {
          // X√≥a kh·ªèi Store v√† Cloud
          const newMetrics = $warehouseCustomMetrics.filter(m => m.id !== idToDelete);
          warehouseCustomMetrics.set(newMetrics);
          
          if ($selectedWarehouse) {
              await datasyncService.saveCustomMetrics($selectedWarehouse, newMetrics);
          }
      }
  }

  async function handleSaveMetric(event) {
      const savedMetric = event.detail;
      let currentMetrics = [...$warehouseCustomMetrics]; 
      
      const existingIndex = currentMetrics.findIndex(m => m.id === savedMetric.id);
      
      if (existingIndex >= 0) {
          currentMetrics[existingIndex] = savedMetric;
      } else {
          currentMetrics = [...currentMetrics, savedMetric];
      }
      
      // C·∫≠p nh·∫≠t Store v√† L∆∞u Cloud
      warehouseCustomMetrics.set(currentMetrics);
      if ($selectedWarehouse) {
          await datasyncService.saveCustomMetrics($selectedWarehouse, currentMetrics);
      }
      
      itemToEdit = null;
  }

  function handleCloseModal() {
      isEffModalOpen = false;
      isMetricModalOpen = false;
      itemToEdit = null;
  }

  function goBack() { dispatch('back'); }

  afterUpdate(() => { if (window.feather) window.feather.replace(); });
</script>

<div class="animate-fade-in pb-10 max-w-7xl mx-auto">
    <div class="mb-4">
        <button on:click={goBack} class="text-blue-600 hover:underline font-semibold flex items-center gap-1">
           <i data-feather="chevron-left" class="w-4 h-4"></i> Quay l·∫°i b·∫£ng t·ªïng h·ª£p
        </button>
    </div>

    {#if employeeData}
        <DetailHeader employee={employeeData} {totalAbove} {totalCriteria} showStats={true} />

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-6 items-start">
            <div class="space-y-6">
                <MetricGrid 
                    title="Doanh thu" icon="trending-up" colorClass="sknv-header-blue" 
                    data={detailStats.doanhThu || []} 
                    on:updateCount={handleCountUpdate} 
                />
                
                <MetricGrid 
                    title="Hi·ªáu qu·∫£ khai th√°c" icon="award" colorClass="sknv-header-orange" 
                    data={detailStats.hieuQua || []} 
                    allowAdd={true}
                    on:add={() => { itemToEdit = null; isEffModalOpen = true; }} 
                    on:edit={handleEditMetric}
                    on:delete={handleDeleteMetric}
                    on:updateCount={handleCountUpdate} 
                />
            </div>
            <div class="space-y-6">
                <MetricGrid 
                    title="NƒÉng su·∫•t" icon="dollar-sign" colorClass="sknv-header-green" 
                    data={detailStats.nangSuat || []} 
                    on:updateCount={handleCountUpdate} 
                />
                
                <MetricGrid 
                    title="ƒê∆°n gi√°" icon="tag" colorClass="sknv-header-yellow" 
                    data={detailStats.donGia || []}
                    allowAdd={true}
                    on:add={() => { itemToEdit = null; isMetricModalOpen = true; }} 
                    on:edit={handleEditMetric}
                    on:delete={handleDeleteMetric}
                    on:updateCount={handleCountUpdate} 
                />
            </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-6 items-start">
            <DetailTableQDC data={qdcData} rawEmployee={rawEmployeeData} />
            <DetailTableCategory data={nganhHangData} rawEmployee={rawEmployeeData} />
        </div>

    {:else}
        <div class="p-12 text-center bg-red-50 rounded-lg border border-red-200">
            <p class="text-red-600 font-semibold">Kh√¥ng t√¨m th·∫•y d·ªØ li·ªáu cho nh√¢n vi√™n n√†y.</p>
        </div>
    {/if}
</div>

<AddEfficiencyColumnModal 
    isOpen={isEffModalOpen} 
    editItem={itemToEdit} 
    on:close={handleCloseModal}
    on:save={handleSaveMetric}
/>

<AddMetricModal
    isOpen={isMetricModalOpen}
    editItem={itemToEdit}
    on:close={handleCloseModal}
    on:save={handleSaveMetric}
/>

<style>
    :global(.sknv-header-blue) { background-color: #2563eb; }
    :global(.sknv-header-green) { background-color: #16a34a; }
    :global(.sknv-header-orange) { background-color: #f97316; }
    :global(.sknv-header-yellow) { background-color: #ca8a04; }
    .animate-fade-in { animation: fadeIn 0.3s ease-out; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
</style>
--- END FILE: ./src/components/health-staff/detail/DetailView.svelte ---

--- START FILE: ./src/components/health-staff/detail/MetricGrid.svelte ---
<script>
  import { afterUpdate, createEventDispatcher } from 'svelte';
  import EvaluationBadge from '../shared/EvaluationBadge.svelte';
  import CardFilter from './CardFilter.svelte';

  export let title = '';
  export let icon = '';
  export let colorClass = 'sknv-header-blue';
  export let data = []; // Array of metrics { id, label, value, average, ... }
  export let allowAdd = false; 

  const dispatch = createEventDispatcher();

  let sortKey = 'label';
  let sortDirection = 'asc';
  
  // Tr·∫°ng th√°i hi·ªÉn th·ªã c·ª•c b·ªô
  let visibilityState = {};

  $: {
      if(data) {
          data.forEach(item => {
              if (visibilityState[item.id] === undefined) {
                  visibilityState[item.id] = true;
              }
          });
          calculateAndEmitCount();
      }
  }

  function handleSort(key) {
    if (sortKey === key) {
      sortDirection = sortDirection === 'desc' ? 'asc' : 'desc';
    } else {
      sortKey = key;
      sortDirection = 'asc';
    }
  }

  function handleFilterChange(event) {
      const id = event.detail;
      visibilityState[id] = !visibilityState[id];
      visibilityState = { ...visibilityState }; 
      calculateAndEmitCount();
  }

  function calculateAndEmitCount() {
      const visibleItems = data.filter(item => visibilityState[item.id] !== false);
      const aboveCount = visibleItems.filter(item => isAboveAverage(item.rawValue, item.rawAverage)).length;
      const totalCount = visibleItems.length;
      dispatch('updateCount', { title, above: aboveCount, total: totalCount });
  }

  function isAboveAverage(val, avg) {
      if (!isFinite(val) || avg === undefined || !isFinite(avg)) return false;
      return val >= avg;
  }

  $: sortedData = [...data]
      .filter(item => visibilityState[item.id] !== false)
      .sort((a, b) => {
          let valA, valB;
          if (sortKey === 'label') {
              valA = a.label || ''; valB = b.label || '';
              return sortDirection === 'asc' ? valA.localeCompare(valB) : valB.localeCompare(valA);
          } else if (sortKey === 'value') {
              valA = a.rawValue || 0; valB = b.rawValue || 0;
          } else {
              valA = a.rawAverage || 0; valB = b.rawAverage || 0;
          }
          return sortDirection === 'asc' ? valA - valB : valB - valA;
      });

  afterUpdate(() => {
      if (typeof feather !== 'undefined') feather.replace();
  });
</script>

<div class="bg-white rounded-xl shadow-md border border-gray-200 overflow-hidden h-full flex flex-col">
    <div class="sknv-detail-card-header {colorClass} flex justify-between items-center p-3 text-white">
        <div class="flex items-center gap-2">
            <i data-feather={icon} class="w-5 h-5"></i>
            <h4 class="text-lg font-bold">{title}</h4>
        </div>
        
        <div class="flex items-center gap-1">
            {#if allowAdd}
                <button 
                    class="text-white/80 hover:text-white hover:bg-white/20 p-1 rounded-full transition-colors"
                    title="Th√™m ch·ªâ s·ªë m·ªõi"
                    on:click={() => dispatch('add')}
                >
                    <i data-feather="plus" class="w-4 h-4"></i>
                </button>
            {/if}
            
            <CardFilter 
                items={data.map(i => ({ id: i.id, label: i.label, visible: visibilityState[i.id] !== false }))} 
                on:change={handleFilterChange} 
            />
        </div>
    </div>
    
    <div class="overflow-x-auto flex-grow">
        <table class="w-full text-sm">
            <thead class="bg-gray-50 border-b border-gray-200">
                <tr>
                    <th class="px-3 py-2 text-left font-semibold text-gray-600 cursor-pointer hover:bg-gray-100 select-none" on:click={() => handleSort('label')}>
                        Ch·ªâ s·ªë {sortKey==='label' ? (sortDirection==='asc' ? '‚ñ≤' : '‚ñº') : ''}
                    </th>
                    <th class="px-3 py-2 text-right font-semibold text-gray-600 cursor-pointer hover:bg-gray-100 select-none" on:click={() => handleSort('value')}>
                        Th·ª±c hi·ªán {sortKey==='value' ? (sortDirection==='asc' ? '‚ñ≤' : '‚ñº') : ''}
                    </th>
                    <th class="px-3 py-2 text-right font-semibold text-gray-600 cursor-pointer hover:bg-gray-100 select-none" on:click={() => handleSort('average')}>
                        Trung b√¨nh {sortKey==='average' ? (sortDirection==='asc' ? '‚ñ≤' : '‚ñº') : ''}
                    </th>
                    <th class="px-3 py-2 text-right font-semibold text-gray-600">ƒê√°nh gi√°</th>
                </tr>
            </thead>
            <tbody class="divide-y divide-gray-100">
                {#if sortedData.length === 0}
                    <tr><td colspan="4" class="p-4 text-center text-gray-400 italic text-xs">ƒê√£ ·∫©n t·∫•t c·∫£ ch·ªâ s·ªë.</td></tr>
                {:else}
                    {#each sortedData as row (row.id)}
                        <tr class="hover:bg-slate-50 transition-colors group/row">
                            <td class="px-3 py-2 font-medium text-gray-700 flex items-center gap-1">
                                {row.label}
                                {#if row.isCustom}
                                    <span class="text-[10px] px-1.5 py-0.5 rounded bg-blue-100 text-blue-700 font-bold whitespace-nowrap">M·ªõi</span>
                                    <div class="flex gap-1 ml-2 opacity-0 group-hover/row:opacity-100 transition-opacity">
                                        <button 
                                            class="p-1 text-gray-400 hover:text-blue-600 rounded hover:bg-blue-50" 
                                            title="S·ª≠a"
                                            on:click|stopPropagation={() => dispatch('edit', row)}
                                        >
                                            <i data-feather="edit-2" class="w-3 h-3"></i>
                                        </button>
                                        <button 
                                            class="p-1 text-gray-400 hover:text-red-600 rounded hover:bg-red-50" 
                                            title="X√≥a"
                                            on:click|stopPropagation={() => dispatch('delete', row.id)}
                                        >
                                            <i data-feather="trash-2" class="w-3 h-3"></i>
                                        </button>
                                    </div>
                                {/if}
                            </td>
                            <td class="px-3 py-2 text-right font-bold text-gray-900 {row.valueClass || ''}">{row.value}</td>
                            <td class="px-3 py-2 text-right text-gray-500 italic">{row.average}</td>
                            <td class="px-3 py-2 text-right">
                                <EvaluationBadge isAbove={isAboveAverage(row.rawValue, row.rawAverage)} />
                            </td>
                        </tr>
                    {/each}
                {/if}
            </tbody>
        </table>
    </div>
</div>
--- END FILE: ./src/components/health-staff/detail/MetricGrid.svelte ---

--- START FILE: ./src/components/health-staff/revenue/DailyPerfChart.svelte ---
<script>
  import { onMount, afterUpdate } from 'svelte';
  import { formatters } from '../../../utils/formatters.js';
  
  export let dailyStats = []; // D·ªØ li·ªáu: [{ date, revenue, convertedRevenue }]

  let chartInstanceDTQD;
  let chartInstanceTLQD;
  let filterDays = 7; // M·∫∑c ƒë·ªãnh 7 ng√†y

  // L·ªçc d·ªØ li·ªáu d·ª±a tr√™n s·ªë ng√†y
  $: filteredData = filterDays === 'all' 
      ? dailyStats 
      : dailyStats.slice(-filterDays);

  $: labels = filteredData.map(d => new Date(d.date).toLocaleDateString('vi-VN', { day: '2-digit', month: '2-digit' }));
  $: dtqdData = filteredData.map(d => d.convertedRevenue / 1000000);
  $: tlqdData = filteredData.map(d => (d.revenue > 0 ? (d.convertedRevenue / d.revenue) - 1 : 0));

  const chartOptions = (title, isPercent = false) => ({
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
          legend: { display: false },
          tooltip: {
              callbacks: {
                  label: (context) => {
                      const val = context.raw;
                      return isPercent ? formatters.formatPercentage(val) : `${formatters.formatRevenue(val * 1000000)} Tr`;
                  }
              }
          },
          datalabels: {
              anchor: 'end', align: 'end',
              formatter: (val) => isPercent ? formatters.formatPercentage(val) : formatters.formatRevenue(val * 1000000),
              color: '#4b5563', font: { weight: 'bold', size: 10 }
          }
      },
      scales: { y: { beginAtZero: true, grace: '10%' } }
  });

  function renderCharts() {
      if (typeof Chart === 'undefined') return;

      // 1. Bi·ªÉu ƒë·ªì DTQƒê
      const ctxDTQD = document.getElementById('daily-dtqd-chart');
      if (ctxDTQD) {
          if (chartInstanceDTQD) chartInstanceDTQD.destroy();
          chartInstanceDTQD = new Chart(ctxDTQD, {
              type: 'bar',
              data: {
                  labels: labels,
                  datasets: [{ label: 'DTQƒê', data: dtqdData, backgroundColor: '#3b82f6', borderRadius: 4 }]
              },
              options: chartOptions('Doanh thu Qƒê', false),
              plugins: [ChartDataLabels]
          });
      }

      // 2. Bi·ªÉu ƒë·ªì T·ª∑ l·ªá Qƒê
      const ctxTLQD = document.getElementById('daily-tlqd-chart');
      if (ctxTLQD) {
          if (chartInstanceTLQD) chartInstanceTLQD.destroy();
          chartInstanceTLQD = new Chart(ctxTLQD, {
              type: 'bar',
              data: {
                  labels: labels,
                  datasets: [{ label: 'T·ª∑ l·ªá', data: tlqdData, backgroundColor: '#16a34a', borderRadius: 4 }]
              },
              options: chartOptions('T·ª∑ l·ªá Qƒê', true),
              plugins: [ChartDataLabels]
          });
      }
  }

  // Render l·∫°i khi d·ªØ li·ªáu thay ƒë·ªïi
  $: if (filteredData.length > 0) {
      // D√πng setTimeout ƒë·ªÉ ƒë·ª£i DOM c·∫≠p nh·∫≠t xong canvas
      setTimeout(renderCharts, 0);
  }

  function setFilter(days) {
      filterDays = days;
  }
</script>

<div class="mb-6">
    <div class="flex items-center justify-center flex-wrap gap-2 mb-4">
        <span class="text-sm font-medium text-gray-600">Xem theo:</span>
        {#each [3, 5, 7, 10, 'all'] as days}
            <button 
                class="px-3 py-1 text-xs font-medium rounded-full transition-colors 
                       {filterDays === days ? 'bg-blue-600 text-white' : 'bg-gray-200 text-gray-700 hover:bg-gray-300'}"
                on:click={() => setFilter(days)}
            >
                {days === 'all' ? 'T·∫•t c·∫£' : `${days} ng√†y`}
            </button>
        {/each}
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <div class="bg-white p-4 rounded-lg shadow-md border h-[300px]">
            <h4 class="text-md font-bold text-gray-700 mb-2 text-center">Doanh thu Qƒê theo ng√†y (Tr)</h4>
            <div class="relative h-[240px] w-full">
                <canvas id="daily-dtqd-chart"></canvas>
            </div>
        </div>
        <div class="bg-white p-4 rounded-lg shadow-md border h-[300px]">
            <h4 class="text-md font-bold text-gray-700 mb-2 text-center">T·ª∑ l·ªá Qƒê theo ng√†y</h4>
            <div class="relative h-[240px] w-full">
                <canvas id="daily-tlqd-chart"></canvas>
            </div>
        </div>
    </div>
</div>
--- END FILE: ./src/components/health-staff/revenue/DailyPerfChart.svelte ---

--- START FILE: ./src/components/health-staff/revenue/RevenueDetailView.svelte ---
<script>
  import { createEventDispatcher } from 'svelte';
  import { masterReportData, ycxData, modalState } from '../../../stores.js'; // [FIX] Import modalState
  import { reportService } from '../../../services/reportService.js';
  import { settingsService } from '../../../services/settings.service.js';
  import { formatters } from '../../../utils/formatters.js';
  
  import DetailHeader from '../detail/DetailHeader.svelte';
  import RevenueKpiBoard from './RevenueKpiBoard.svelte';
  import DailyPerfChart from './DailyPerfChart.svelte';
  import RevenueTopGroups from './RevenueTopGroups.svelte';

  export let employeeId;
  const dispatch = createEventDispatcher();

  let detailData = null;
  let employeeData = null;
  let goals = {};

  $: if (employeeId && $ycxData.length > 0) {
      employeeData = $masterReportData.sknv.find(e => String(e.maNV) === String(employeeId));

      if (employeeData) {
          const settings = settingsService.getLuykeGoalSettings(employeeData.maKho);
          goals = settings.goals || {};
          detailData = reportService.generateLuyKeEmployeeDetailReport(employeeId, $ycxData);
      }
  }

  function goBack() { dispatch('back'); }

  // [M·ªöI] H√†m x·ª≠ l√Ω m·ªü Modal
  function openUnexportedModal() {
      if (detailData && detailData.unexportedDetails) {
          modalState.update(s => ({ 
              ...s, 
              activeModal: 'unexported-detail-modal',
              payload: { unexportedDetails: detailData.unexportedDetails }
          }));
      }
  }

  function openOrdersModal() {
      if (detailData && detailData.byCustomer) {
          modalState.update(s => ({ 
              ...s, 
              activeModal: 'customer-detail-modal',
              payload: { 
                  customers: detailData.byCustomer,
                  mucTieu: employeeData.mucTieu
              }
          }));
      }
  }
</script>

<div class="animate-fade-in pb-10 max-w-7xl mx-auto">
    <div class="mb-4 flex justify-between items-center">
        <button on:click={goBack} class="text-blue-600 hover:underline font-semibold flex items-center gap-1">
            <i data-feather="chevron-left" class="w-4 h-4"></i> Quay l·∫°i b·∫£ng t·ªïng h·ª£p
        </button>
    </div>

    {#if employeeData && detailData}
        <DetailHeader employee={employeeData} showStats={false} />
        
        <RevenueKpiBoard 
            summary={detailData.summary} 
            {goals} 
            on:viewUnexported={openUnexportedModal}
            on:viewOrders={openOrdersModal}
        />
        
        <DailyPerfChart dailyStats={detailData.dailyStats} />
        
        <RevenueTopGroups 
            topProductGroups={detailData.topProductGroups} 
            categoryChartData={detailData.categoryChartData} 
        />

    {:else}
        <div class="p-12 text-center bg-red-50 rounded-lg border border-red-200">
            <p class="text-red-600 font-semibold">Kh√¥ng t√¨m th·∫•y d·ªØ li·ªáu chi ti·∫øt cho nh√¢n vi√™n n√†y.</p>
        </div>
    {/if}
</div>

<style>
    .animate-fade-in { animation: fadeIn 0.3s ease-out; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
</style>
--- END FILE: ./src/components/health-staff/revenue/RevenueDetailView.svelte ---

--- START FILE: ./src/components/health-staff/revenue/RevenueKpiBoard.svelte ---
<script>
  import { createEventDispatcher } from 'svelte';
  import { formatters } from '../../../utils/formatters.js';

  export let summary = {};
  export let goals = {};

  const dispatch = createEventDispatcher();

  // T√≠nh to√°n target
  $: targetQD = (goals?.phanTramQD || 0);
  $: isPositive = (summary.conversionRate * 100) >= targetQD;
</script>

<div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-4 mb-6">
    <div class="bg-white p-4 rounded-lg shadow border border-gray-100 text-center">
        <div class="text-sm text-gray-500 font-medium uppercase">T·ªïng DT Th·ª±c</div>
        <div class="text-xl font-bold text-blue-600 mt-1">{formatters.formatRevenue(summary.totalRealRevenue, 1)}</div>
    </div>

    <div class="bg-white p-4 rounded-lg shadow border border-gray-100 text-center">
        <div class="text-sm text-gray-500 font-medium uppercase">T·ªïng DTQƒê</div>
        <div class="text-xl font-bold text-purple-600 mt-1">{formatters.formatRevenue(summary.totalConvertedRevenue, 1)}</div>
    </div>

    <div class="bg-white p-4 rounded-lg shadow border border-gray-100 text-center">
        <div class="text-sm text-gray-500 font-medium uppercase">T·ª∑ l·ªá Qƒê</div>
        <div class="text-xl font-bold mt-1 {isPositive ? 'text-green-600' : 'text-red-600'}">
            {formatters.formatPercentage(summary.conversionRate)}
        </div>
    </div>

    <div 
        class="bg-white p-4 rounded-lg shadow border border-gray-100 text-center cursor-pointer hover:bg-yellow-50 transition-colors hover:shadow-md"
        on:click={() => dispatch('viewUnexported')}
    >
        <div class="text-sm text-gray-500 font-medium uppercase flex items-center justify-center gap-1">
            DT Ch∆∞a Xu·∫•t <i data-feather="external-link" class="w-3 h-3"></i>
        </div>
        <div class="text-xl font-bold text-yellow-600 mt-1">{formatters.formatRevenue(summary.unexportedRevenue, 1)}</div>
    </div>

    <div 
        class="bg-white p-4 rounded-lg shadow border border-gray-100 text-center cursor-pointer hover:bg-blue-50 transition-colors hover:shadow-md"
        on:click={() => dispatch('viewOrders')}
    >
        <div class="text-sm text-gray-500 font-medium uppercase flex items-center justify-center gap-1">
            T·ªïng ƒê∆°n <i data-feather="external-link" class="w-3 h-3"></i>
        </div>
        <div class="text-xl font-bold text-gray-800 mt-1">{summary.totalOrders}</div>
    </div>

    <div class="bg-white p-4 rounded-lg shadow border border-gray-100 text-center">
        <div class="text-sm text-gray-500 font-medium uppercase">ƒê∆°n B√°n K√®m</div>
        <div class="text-xl font-bold text-gray-800 mt-1">{summary.bundledOrderCount}</div>
    </div>
</div>
--- END FILE: ./src/components/health-staff/revenue/RevenueKpiBoard.svelte ---

--- START FILE: ./src/components/health-staff/revenue/RevenueTopGroups.svelte ---
<script>
  import { onMount } from 'svelte';
  import { formatters } from '../../../utils/formatters.js';
  import { getRandomBrightColor } from '../../../utils.js';

  export let topProductGroups = [];
  export let categoryChartData = [];

  let chartInstance;

  // 1. Top 5 Nh√≥m h√†ng
  $: top5Groups = topProductGroups.slice(0, 5);
  $: maxRevenue = top5Groups.length > 0 ? top5Groups[0].realRevenue : 0;

  // 2. Bi·ªÉu ƒë·ªì
  function renderPieChart() {
      const ctx = document.getElementById('revenue-category-chart');
      if (!ctx || !categoryChartData.length) return;

      if (chartInstance) chartInstance.destroy();

      // Sort v√† l·∫•y top 10 cho bi·ªÉu ƒë·ªì
      const sortedChartData = [...categoryChartData].sort((a, b) => b.revenue - a.revenue).slice(0, 10);

      chartInstance = new Chart(ctx, {
          type: 'bar',
          data: {
              labels: sortedChartData.map(d => d.name),
              datasets: [{
                  label: 'Doanh thu',
                  data: sortedChartData.map(d => d.revenue / 1000000),
                  backgroundColor: sortedChartData.map(() => getRandomBrightColor()),
                  borderRadius: 4,
              }]
          },
          options: {
              indexAxis: 'x',
              responsive: true,
              maintainAspectRatio: false,
              plugins: {
                  legend: { display: false },
                  tooltip: {
                      callbacks: { label: ctx => `${ctx.label}: ${formatters.formatRevenue(ctx.raw * 1000000)}` }
                  },
                  datalabels: {
                      anchor: 'end', align: 'end',
                      formatter: (val) => formatters.formatRevenue(val * 1000000),
                      color: '#4b5563', font: { weight: 'bold', size: 10 }
                  }
              },
              scales: { y: { beginAtZero: true, grace: '10%' } }
          },
          plugins: [ChartDataLabels]
      });
  }

  $: if (categoryChartData.length > 0) {
      setTimeout(renderPieChart, 0);
  }
</script>

<div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
    <div class="bg-white p-4 rounded-lg shadow-md border">
        <h4 class="text-md font-bold text-gray-700 border-b pb-2 mb-3">Top 5 Nh√≥m H√†ng Doanh Thu Cao</h4>
        {#if top5Groups.length === 0}
            <p class="text-sm text-gray-500">Kh√¥ng c√≥ d·ªØ li·ªáu.</p>
        {:else}
            <div class="space-y-4">
                {#each top5Groups as group}
                    {@const percent = maxRevenue > 0 ? (group.realRevenue / maxRevenue) * 100 : 0}
                    <div>
                        <div class="flex justify-between items-end mb-1">
                            <div>
                                <span class="font-semibold text-sm block">{group.name}</span>
                                <span class="text-xs text-gray-500">SL: {formatters.formatNumber(group.quantity)} | %Qƒê: {formatters.formatPercentage(group.conversionRate)}</span>
                            </div>
                            <div class="text-right">
                                <div class="text-sm font-bold text-gray-800">{formatters.formatRevenue(group.realRevenue)}</div>
                                <div class="text-xs text-blue-600 font-medium">{formatters.formatRevenue(group.convertedRevenue)} (Qƒê)</div>
                            </div>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-2">
                            <div class="bg-blue-600 h-2 rounded-full transition-all duration-500" style="width: {percent}%"></div>
                        </div>
                    </div>
                {/each}
            </div>
        {/if}
    </div>

    <div class="bg-white p-4 rounded-lg shadow-md border">
        <h4 class="text-md font-bold text-gray-700 mb-2">T·ª∑ Tr·ªçng Doanh Thu Ng√†nh H√†ng</h4>
        <div class="relative h-[300px] w-full">
            <canvas id="revenue-category-chart"></canvas>
        </div>
    </div>
</div>
--- END FILE: ./src/components/health-staff/revenue/RevenueTopGroups.svelte ---

--- START FILE: ./src/components/health-staff/shared/EvaluationBadge.svelte ---
<script>
  export let isAbove = false;
</script>

<span class="px-2 py-0.5 rounded text-[10px] font-bold uppercase tracking-wide {isAbove ? 'bg-green-100 text-green-700' : 'bg-yellow-100 text-yellow-700'}">
  {isAbove ? 'Tr√™n TB' : 'D∆∞·ªõi TB'}
</span>
--- END FILE: ./src/components/health-staff/shared/EvaluationBadge.svelte ---

--- START FILE: ./src/components/health-staff/shared/MedalIcon.svelte ---
<script>
  export let rank = 0; // 0: Base (Index + 1)

  // Logic m√†u s·∫Øc cho Top 3
  const isGold = rank === 1;
  const isSilver = rank === 2;
  const isBronze = rank === 3;
  const isStandard = rank > 3;
</script>

<div class="relative w-12 h-12 flex-shrink-0 -ml-2 -mt-2">
  {#if isGold}
    <svg viewBox="0 0 100 100" class="w-full h-full drop-shadow-sm absolute top-0 left-0 z-10">
        <defs><linearGradient id="gold-grad" x1="0%" y1="0%" x2="0%" y2="100%"><stop offset="0%" stop-color="#FFDF00"/><stop offset="100%" stop-color="#FFB800"/></linearGradient></defs>
        <path d="M 20 75 L 35 95 L 35 75 L 50 90 L 65 75 L 65 95 L 80 75 L 50 85 Z" fill="#E53935"/>
        <circle cx="50" cy="45" r="38" fill="#BDBDBD"/><circle cx="50" cy="45" r="35" fill="url(#gold-grad)"/>
        <circle cx="50" cy="45" r="28" fill="#FFC107" stroke="#FFFFFF" stroke-width="2"/>
    </svg>
  {:else if isSilver}
    <svg viewBox="0 0 100 100" class="w-full h-full drop-shadow-sm absolute top-0 left-0 z-10">
        <defs><linearGradient id="silver-grad" x1="0%" y1="0%" x2="0%" y2="100%"><stop offset="0%" stop-color="#F5F5F5"/><stop offset="100%" stop-color="#B0BEC5"/></linearGradient></defs>
        <path d="M 20 75 L 35 95 L 35 75 L 50 90 L 65 75 L 65 95 L 80 75 L 50 85 Z" fill="#E53935"/>
        <circle cx="50" cy="45" r="38" fill="#78909C"/><circle cx="50" cy="45" r="35" fill="url(#silver-grad)"/>
        <circle cx="50" cy="45" r="28" fill="#B0BEC5" stroke="#FFFFFF" stroke-width="2"/>
    </svg>
  {:else if isBronze}
    <svg viewBox="0 0 100 100" class="w-full h-full drop-shadow-sm absolute top-0 left-0 z-10">
        <defs><linearGradient id="bronze-grad" x1="0%" y1="0%" x2="0%" y2="100%"><stop offset="0%" stop-color="#FFCC80"/><stop offset="100%" stop-color="#D84315"/></linearGradient></defs>
        <path d="M 20 75 L 35 95 L 35 75 L 50 90 L 65 75 L 65 95 L 80 75 L 50 85 Z" fill="#E53935"/>
        <circle cx="50" cy="45" r="38" fill="#A1887F"/><circle cx="50" cy="45" r="35" fill="url(#bronze-grad)"/>
        <circle cx="50" cy="45" r="28" fill="#D84315" stroke="#FFFFFF" stroke-width="2"/>
    </svg>
  {:else}
    <div class="sknv-card__avatar--standard">
        <span class="sknv-card__avatar-rank">{rank}</span>
    </div>
  {/if}
  
  {#if !isStandard}
      <div class="absolute top-0 left-0 w-full h-[90%] flex items-center justify-center z-20">
        <span class="sknv-card__avatar-rank text-white text-lg font-bold">{rank}</span>
      </div>
  {/if}
</div>
--- END FILE: ./src/components/health-staff/shared/MedalIcon.svelte ---

--- START FILE: ./src/components/health-staff/shared/UMedalIcon.svelte ---
<script>
  export let rank = 0; // 0: Base (Index + 1)

  // Logic m√†u s·∫Øc cho Top 3
  const isGold = rank === 1;
  const isSilver = rank === 2;
  const isBronze = rank === 3;
</script>

<div class="relative w-12 h-12 flex-shrink-0 -ml-2 -mt-2">
  {#if isGold}
    <svg viewBox="0 0 100 100" class="w-full h-full drop-shadow-sm">
        <defs><linearGradient id="gold-grad" x1="0%" y1="0%" x2="0%" y2="100%"><stop offset="0%" stop-color="#FFDF00"/><stop offset="100%" stop-color="#FFB800"/></linearGradient></defs>
        <path d="M 20 75 L 35 95 L 35 75 L 50 90 L 65 75 L 65 95 L 80 75 L 50 85 Z" fill="#E53935"/>
        <circle cx="50" cy="45" r="38" fill="#BDBDBD"/><circle cx="50" cy="45" r="35" fill="url(#gold-grad)"/>
        <circle cx="50" cy="45" r="28" fill="#FFC107" stroke="#FFFFFF" stroke-width="2"/>
    </svg>
  {:else if isSilver}
    <svg viewBox="0 0 100 100" class="w-full h-full drop-shadow-sm">
        <defs><linearGradient id="silver-grad" x1="0%" y1="0%" x2="0%" y2="100%"><stop offset="0%" stop-color="#F5F5F5"/><stop offset="100%" stop-color="#B0BEC5"/></linearGradient></defs>
        <path d="M 20 75 L 35 95 L 35 75 L 50 90 L 65 75 L 65 95 L 80 75 L 50 85 Z" fill="#E53935"/>
        <circle cx="50" cy="45" r="38" fill="#78909C"/><circle cx="50" cy="45" r="35" fill="url(#silver-grad)"/>
        <circle cx="50" cy="45" r="28" fill="#B0BEC5" stroke="#FFFFFF" stroke-width="2"/>
    </svg>
  {:else if isBronze}
    <svg viewBox="0 0 100 100" class="w-full h-full drop-shadow-sm">
        <defs><linearGradient id="bronze-grad" x1="0%" y1="0%" x2="0%" y2="100%"><stop offset="0%" stop-color="#FFCC80"/><stop offset="100%" stop-color="#D84315"/></linearGradient></defs>
        <path d="M 20 75 L 35 95 L 35 75 L 50 90 L 65 75 L 65 95 L 80 75 L 50 85 Z" fill="#E53935"/>
        <circle cx="50" cy="45" r="38" fill="#A1887F"/><circle cx="50" cy="45" r="35" fill="url(#bronze-grad)"/>
        <circle cx="50" cy="45" r="28" fill="#D84315" stroke="#FFFFFF" stroke-width="2"/>
    </svg>
  {:else}
    <div class="w-12 h-12 rounded-full bg-gray-200 flex items-center justify-center border-4 border-white shadow-sm">
        </div>
  {/if}
  
  <div class="absolute top-0 left-0 w-full h-[90%] flex items-center justify-center z-10">
    <span class="text-lg font-bold {rank <= 3 ? 'text-white' : 'text-gray-600'}">{rank}</span>
  </div>
</div>
--- END FILE: ./src/components/health-staff/shared/UMedalIcon.svelte ---

--- START FILE: ./src/components/health-staff/summary/DepartmentGroup.svelte ---
<script>
  import EmployeeCard from './card/EmployeeCard.svelte';
  
  export let departmentName;
  export let employees = [];
  
  // Priority styling cho "T∆∞ V·∫•n - ƒêM"
  $: isPriority = departmentName.includes('T∆∞ V·∫•n');
  $: headerClass = isPriority 
    ? 'bg-blue-50 text-blue-800 border-blue-200' 
    : 'bg-gray-50 text-gray-700 border-gray-200';
</script>

<div class="mb-8 last:mb-0">
  <div class="flex items-center gap-3 px-4 py-3 rounded-t-lg border-b-2 {headerClass}">
    <h3 class="text-lg font-bold uppercase tracking-wide">{departmentName}</h3>
    <span class="bg-white/50 px-2 py-0.5 rounded text-xs font-bold">{employees.length} NV</span>
  </div>
  
  <div class="p-4 bg-slate-50/30 border-x border-b border-gray-200 rounded-b-lg">
    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4">
      {#each employees as emp, index (emp.maNV)}
        <EmployeeCard employee={emp} rank={index + 1} on:click />
      {/each}
    </div>
  </div>
</div>
--- END FILE: ./src/components/health-staff/summary/DepartmentGroup.svelte ---

--- START FILE: ./src/components/health-staff/summary/SummaryView.svelte ---
<script>
  import DepartmentGroup from './DepartmentGroup.svelte';
  
  // [FIX L·ªñI QUAN TR·ªåNG]
  // Sai: import { utils } from '../../../utils.js';
  // ƒê√∫ng: Import t·∫•t c·∫£ h√†m (*) v√† ƒë·∫∑t t√™n l√† 'utils'
  import * as utils from '../../../utils.js'; 
  
  export let reportData = [];

  // Gom nh√≥m nh√¢n vi√™n theo b·ªô ph·∫≠n
  $: groupedData = reportData.reduce((acc, item) => {
      const dept = item.boPhan || 'Kh√°c';
      if (!acc[dept]) acc[dept] = [];
      acc[dept].push(item);
      return acc;
  }, {});

  // S·∫Øp x·∫øp th·ª© t·ª± b·ªô ph·∫≠n (∆Øu ti√™n T∆∞ V·∫•n)
  // H√†m n√†y n·∫±m trong utils.js, gi·ªù g·ªçi qua namespace 'utils' s·∫Ω ho·∫°t ƒë·ªông
  $: departmentOrder = utils.getSortedDepartmentList(reportData);
</script>

<div class="animate-fade-in pb-10">
  {#if reportData.length === 0}
    <div class="p-12 text-center bg-gray-50 rounded-lg border border-gray-200">
      <p class="text-gray-500">Kh√¥ng c√≥ d·ªØ li·ªáu hi·ªáu su·∫•t ƒë·ªÉ hi·ªÉn th·ªã.</p>
    </div>
  {:else}
    {#each departmentOrder as deptName}
      {#if groupedData[deptName]}
        {@const sortedEmployees = [...groupedData[deptName]].sort((a, b) => b.totalAbove - a.totalAbove)}
        <DepartmentGroup 
          departmentName={deptName} 
          employees={sortedEmployees} 
          on:click 
        />
      {/if}
    {/each}
  {/if}
</div>

<style>
  .animate-fade-in { animation: fadeIn 0.5s ease-out; }
  @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
</style>
--- END FILE: ./src/components/health-staff/summary/SummaryView.svelte ---

--- START FILE: ./src/components/realtime/brand/BrandTab.svelte ---
<script>
  import { onMount } from 'svelte';
  import { realtimeYCXData } from '../../../stores.js';
  import { reportService } from '../../../services/reportService.js';
  import { cleanCategoryName } from '../../../utils.js';
  import BrandTable from './BrandTable.svelte';

  export let selectedWarehouse = '';

  let viewType = 'brand'; // 'brand' | 'employee'
  let selectedCategory = '';
  let selectedBrand = '';
  
  let categories = [];
  let brands = [];
  let reportData = [];

  // 1. L·∫•y danh s√°ch Ng√†nh h√†ng t·ª´ d·ªØ li·ªáu (Reactive)
  $: {
      if ($realtimeYCXData.length > 0) {
          categories = [...new Set($realtimeYCXData
              .map(row => cleanCategoryName(row.nganhHang))
              .filter(Boolean))
          ].sort();
      }
  }

  // 2. L·∫•y danh s√°ch H√£ng d·ª±a tr√™n Ng√†nh h√†ng ƒë√£ ch·ªçn (Reactive)
  $: {
      let filteredData = $realtimeYCXData;
      if (selectedCategory) {
          filteredData = filteredData.filter(row => cleanCategoryName(row.nganhHang) === selectedCategory);
      }
      
      if (filteredData.length > 0) {
          brands = [...new Set(filteredData
              .map(row => row.nhaSanXuat || 'H√£ng kh√°c')
              .filter(Boolean))
          ].sort();
      } else {
          brands = [];
      }
      
      // Reset selectedBrand n·∫øu n√≥ kh√¥ng c√≤n trong danh s√°ch m·ªõi
      if (selectedBrand && !brands.includes(selectedBrand)) {
          selectedBrand = '';
      }
  }

  // 3. T√≠nh to√°n d·ªØ li·ªáu b√°o c√°o (Reactive)
  $: {
      // L·ªçc theo kho tr∆∞·ªõc (Logic ƒë∆°n gi·∫£n h√≥a, s·ª≠ d·ª•ng d·ªØ li·ªáu ƒë√£ t·∫£i v·ªÅ)
      // L∆∞u √Ω: N·∫øu c·∫ßn l·ªçc ch√≠nh x√°c theo kho c·ªßa user, c·∫ßn ƒë·∫£m b·∫£o realtimeYCXData ƒë√£ ƒë∆∞·ª£c l·ªçc ho·∫∑c l·ªçc l·∫°i ·ªü ƒë√¢y
      // Hi·ªán t·∫°i service s·∫Ω x·ª≠ l√Ω vi·ªác t√≠nh to√°n t·ªïng h·ª£p.
      
      const result = reportService.generateRealtimeBrandReport(
          $realtimeYCXData, 
          selectedCategory,
          selectedBrand
      );
      
      if (viewType === 'brand') {
          reportData = result.byBrand;
      } else {
          reportData = result.byEmployee;
      }
  }
</script>

<div class="animate-fade-in pb-10">
    <div class="content-card mb-6">
        <div class="flex flex-wrap items-center justify-between gap-4 mb-4 border-b pb-4">
            <h3 class="text-xl font-bold text-gray-700 uppercase">Th·ªëng k√™ theo H√£ng</h3>
            <div class="view-switcher bg-gray-200 p-1 rounded-lg flex">
                <button 
                    class="px-4 py-2 rounded-md text-sm font-medium transition-all {viewType === 'brand' ? 'bg-white text-blue-600 shadow-sm' : 'text-gray-600 hover:bg-gray-300'}"
                    on:click={() => viewType = 'brand'}
                >
                    Theo H√£ng
                </button>
                <button 
                    class="px-4 py-2 rounded-md text-sm font-medium transition-all {viewType === 'employee' ? 'bg-white text-blue-600 shadow-sm' : 'text-gray-600 hover:bg-gray-300'}"
                    on:click={() => viewType = 'employee'}
                >
                    Theo Nh√¢n vi√™n
                </button>
            </div>
        </div>
        
        <div class="flex flex-wrap items-center gap-4">
            <div class="flex flex-col">
                <label for="rt-brand-cat-select" class="text-sm font-semibold text-gray-600 mb-1">Ng√†nh h√†ng:</label>
                <select 
                    id="rt-brand-cat-select"
                    class="p-2 border rounded-lg text-sm shadow-sm bg-white min-w-[200px] focus:ring-2 focus:ring-blue-500 outline-none"
                    bind:value={selectedCategory}
                >
                    <option value="">-- T·∫•t c·∫£ ng√†nh h√†ng --</option>
                    {#each categories as cat}
                        <option value={cat}>{cat}</option>
                    {/each}
                </select>
            </div>

            <div class="flex flex-col">
                <label for="rt-brand-select" class="text-sm font-semibold text-gray-600 mb-1">H√£ng:</label>
                <select 
                    id="rt-brand-select"
                    class="p-2 border rounded-lg text-sm shadow-sm bg-white min-w-[200px] focus:ring-2 focus:ring-blue-500 outline-none"
                    bind:value={selectedBrand}
                >
                    <option value="">-- T·∫•t c·∫£ c√°c h√£ng --</option>
                    {#each brands as brand}
                        <option value={brand}>{brand}</option>
                    {/each}
                </select>
            </div>
        </div>
    </div>

    <BrandTable {viewType} {reportData} />
</div>

<style>
  .animate-fade-in { animation: fadeIn 0.3s ease-out; }
  @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
</style>
--- END FILE: ./src/components/realtime/brand/BrandTab.svelte ---

--- START FILE: ./src/components/realtime/brand/BrandTable.svelte ---
<script>
  import { formatters } from '../../../utils/formatters.js';
  // Import component m·ªõi
  import SortableTh from '../../common/SortableTh.svelte';

  export let viewType = 'brand'; // 'brand' ho·∫∑c 'employee'
  export let reportData = [];

  let sortKey = 'revenue';
  let sortDirection = 'desc';

  // Reset sort khi ƒë·ªïi ch·∫ø ƒë·ªô xem
  $: if (viewType) {
      sortKey = 'revenue';
      sortDirection = 'desc';
  }

  // H√†m x·ª≠ l√Ω s·ª± ki·ªán sort t·ª´ component con
  function handleSort(event) {
    const key = event.detail; // Nh·∫≠n key t·ª´ dispatch('sort', key)
    if (sortKey === key) {
      sortDirection = sortDirection === 'desc' ? 'asc' : 'desc';
    } else {
      sortKey = key;
      sortDirection = 'desc';
    }
  }

  // H√†m sort d·ªØ li·ªáu
  function sortData(items, key, dir) {
      return [...items].sort((a, b) => {
          // Sort ch·ªØ
          if (key === 'name') {
             const valA = a.name || '';
             const valB = b.name || '';
             return dir === 'asc' ? valA.localeCompare(valB) : valB.localeCompare(valA);
          }
          // Sort s·ªë
          let valA = Number(a[key]) || 0;
          let valB = Number(b[key]) || 0;
          return dir === 'asc' ? valA - valB : valB - valA;
      });
  }

  // C·∫•u h√¨nh c·ªôt cho t·ª´ng ch·∫ø ƒë·ªô xem
  $: columns = viewType === 'brand' 
    ? [
        { id: 'name', label: 'H√£ng', align: 'left' },
        { id: 'quantity', label: 'S·ªë l∆∞·ª£ng', align: 'right' },
        { id: 'revenue', label: 'Doanh thu', align: 'right' },
        { id: 'avgPrice', label: 'ƒê∆°n gi√° TB', align: 'right' }
      ]
    : [
        { id: 'name', label: 'Nh√¢n vi√™n', align: 'left' },
        { id: 'quantity', label: 'S·ªë l∆∞·ª£ng', align: 'right' },
        { id: 'revenue', label: 'Doanh thu', align: 'right' }
    ];
</script>

<div class="bg-white rounded-xl shadow-md border border-gray-200 overflow-hidden">
  <div class="p-4 border-b bg-gray-50 border-gray-200 flex justify-between items-center">
      <h4 class="text-lg font-bold uppercase text-gray-700">
          {viewType === 'brand' ? 'Th·ªëng k√™ theo H√£ng' : 'Th·ªëng k√™ theo Nh√¢n vi√™n'}
      </h4>
  </div>

  <div class="overflow-x-auto">
    <table class="min-w-full text-sm text-left text-gray-600 table-bordered">
      <thead class="text-xs text-slate-800 uppercase bg-slate-200 font-bold sticky top-0 z-20 shadow-sm">
        <tr>
          {#each columns as col}
            <SortableTh 
              key={col.id}
              label={col.label}
              align={col.align}
              {sortKey}
              {sortDirection}
              on:sort={handleSort} 
            />
          {/each}
        </tr>
      </thead>
      <tbody class="divide-y divide-gray-200">
        {#if reportData.length === 0}
            <tr><td colspan={columns.length} class="p-4 text-center text-gray-500 italic">Kh√¥ng c√≥ d·ªØ li·ªáu.</td></tr>
        {:else}
            {#each sortData(reportData, sortKey, sortDirection) as item}
              <tr class="hover:bg-blue-50 transition">
                <td class="px-4 py-2 font-semibold text-blue-600 {viewType === 'employee' ? 'sticky left-0 bg-white hover:bg-blue-50 z-10 border-r' : ''}">
                  {item.name}
                </td>
                <td class="px-4 py-2 text-right font-bold text-gray-900">{formatters.formatNumber(item.quantity)}</td>
                <td class="px-4 py-2 text-right font-bold text-gray-900">{formatters.formatRevenue(item.revenue)}</td>
                {#if viewType === 'brand'}
                    <td class="px-4 py-2 text-right font-bold text-green-600">{formatters.formatRevenue(item.avgPrice)}</td>
                {/if}
              </tr>
            {/each}
        {/if}
      </tbody>
    </table>
  </div>
</div>
--- END FILE: ./src/components/realtime/brand/BrandTable.svelte ---

--- START FILE: ./src/components/realtime/category/CategoryTab.svelte ---
<script>
  import { realtimeYCXData, selectedWarehouse } from '../../../stores.js';
  import { reportService } from '../../../services/reportService.js';
  import { settingsService } from '../../../services/settings.service.js';
  
  // [THAY ƒê·ªîI QUAN TR·ªåNG] Import b·∫£ng Doanh thu ƒë·ªông t·ª´ Health Staff
  // Component n√†y t·ª± ƒë·ªông ƒë·ªçc store `customRevenueTables` n√™n s·∫Ω ƒë·ªìng b·ªô c·∫•u h√¨nh b·∫£ng
  import CategoryRevenueView from '../../health-staff/CategoryRevenueView.svelte';

  export let selectedWarehouseProp = ''; // Nh·∫≠n prop t·ª´ cha n·∫øu c√≥, ho·∫∑c d√πng store

  let filteredReport = [];

  $: {
    // 1. ∆Øu ti√™n d√πng prop, n·∫øu kh√¥ng th√¨ d√πng store global
    const currentWarehouse = selectedWarehouseProp || $selectedWarehouse;
    
    // 2. L·∫•y m·ª•c ti√™u (ƒë·ªÉ t√≠nh % ƒë·∫°t n·∫øu c·∫ßn)
    const settings = settingsService.getRealtimeGoalSettings(currentWarehouse);
    const goals = settings.goals || {};

    // 3. T√≠nh to√°n Master Report t·ª´ d·ªØ li·ªáu Realtime
    // isRealtime = true ƒë·ªÉ logic t√≠nh to√°n x·ª≠ l√Ω ƒë√∫ng c√°c tr∆∞·ªùng ƒë·∫∑c th√π
    const masterReport = reportService.generateMasterReportData($realtimeYCXData, goals, true);
    
    // 4. L·ªçc theo kho
    if (currentWarehouse) {
      filteredReport = masterReport.filter(nv => nv.maKho == currentWarehouse);
    } else {
      filteredReport = masterReport;
    }
  }
</script>

<div class="animate-fade-in pb-10">
    <CategoryRevenueView reportData={filteredReport} />
</div>

<style>
  .animate-fade-in { animation: fadeIn 0.3s ease-out; }
  @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
</style>
--- END FILE: ./src/components/realtime/category/CategoryTab.svelte ---

--- START FILE: ./src/components/realtime/competition/CompetitionTab.svelte ---
<script>
  import { 
      realtimeYCXData, 
      globalSpecialPrograms, 
      globalCompetitionConfigs, 
      localCompetitionConfigs,
      selectedWarehouse // [FIX] Import store n√†y
  } from '../../../stores.js';
  import { services } from '../../../services.js'; 
  
  import SpecialProgramTable from './SpecialProgramTable.svelte';
  import FocusCompetitionTable from './FocusCompetitionTable.svelte';

  // [FIX] B·ªè export let selectedWarehouse

  let specialReportData = [];
  let competitionReportData = [];
  let hasData = false;

  $: {
      // [FIX] D√πng $selectedWarehouse
      const currentWarehouse = $selectedWarehouse;
      let filteredData = $realtimeYCXData || [];
      
      console.log(`[CompetitionTab] Recalculating... Rows: ${filteredData.length}, Warehouse: ${currentWarehouse}`);

      // 2. T√≠nh to√°n SP ƒê·∫∑c Quy·ªÅn
      const spReport = services.calculateSpecialProductReport(
          filteredData, 
          $globalSpecialPrograms || []
      );

      // 3. T√≠nh to√°n Thi ƒêua T√πy Ch·ªânh (H√£ng)
      const allConfigs = [ ...($globalCompetitionConfigs || []), ...($localCompetitionConfigs || []) ];
      const compReport = services.calculateCompetitionFocusReport(
          filteredData,
          allConfigs
      );

      // 4. L·ªçc k·∫øt qu·∫£ theo kho
      if (currentWarehouse) {
          const filterByWarehouse = (reports) => {
              return reports.map(group => ({
                  ...group,
                  employeeData: group.employeeData.filter(emp => String(emp.maKho) === String(currentWarehouse))
              })).filter(group => group.employeeData.length > 0);
          };

          specialReportData = filterByWarehouse(spReport);
          competitionReportData = filterByWarehouse(compReport);
      } else {
          specialReportData = spReport;
          competitionReportData = compReport;
      }

      hasData = specialReportData.length > 0 || competitionReportData.length > 0;
  }
</script>

<div class="animate-fade-in pb-10">
    {#if !hasData}
        <div class="p-12 text-center bg-gray-50 rounded-lg border-2 border-dashed border-gray-300">
            <p class="text-gray-500 font-medium mb-2">Ch∆∞a c√≥ d·ªØ li·ªáu thi ƒëua hi·ªÉn th·ªã.</p>
            <p class="text-xs text-gray-400">
                Vui l√≤ng ki·ªÉm tra: 
                1. ƒê√£ t·∫£i file Realtime ch∆∞a? 
                2. ƒê√£ t·∫°o ch∆∞∆°ng tr√¨nh thi ƒëua trong "Thi·∫øt l·∫≠p m·ª•c ti√™u" ch∆∞a?
                3. D·ªØ li·ªáu b√°n h√†ng c√≥ kh·ªõp v·ªõi nh√≥m h√†ng ƒë√£ ch·ªçn kh√¥ng?
            </p>
        </div>
    {:else}
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            {#each specialReportData as programResult (programResult.program.id)}
                <div class="h-full">
                    <SpecialProgramTable {programResult} />
                </div>
            {/each}

            {#each competitionReportData as competitionResult (competitionResult.competition.id)}
                <div class="h-full">
                    <FocusCompetitionTable {competitionResult} />
                </div>
            {/each}
        </div>
    {/if}
</div>

<style>
    @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
    .animate-fade-in { animation: fadeIn 0.5s ease-out; }
</style>
--- END FILE: ./src/components/realtime/competition/CompetitionTab.svelte ---

--- START FILE: ./src/components/realtime/competition/FocusCompetitionTable.svelte ---
<script>
  import { formatters } from '../../../utils/formatters.js';
  // Kh√¥ng c·∫ßn import SortableTh n·ªØa v√¨ ta s·∫Ω vi·∫øt tr·ª±c ti·∫øp ƒë·ªÉ ki·ªÉm so√°t layout t·ªët h∆°n

  export let competitionResult;

  const { competition, employeeData } = competitionResult;
  const brands = competition.brands || [];
  
  let targetDisplay = competition.target || 0;
  let sortKey = 'tyLeDT';
  let sortDirection = 'desc';

  function handleSort(key) {
    if (sortKey === key) {
      sortDirection = sortDirection === 'desc' ? 'asc' : 'desc';
    } else {
      sortKey = key;
      sortDirection = 'desc';
    }
  }

  // Helper t·∫°o class cho header
  const getHeaderClass = (key) => {
      const base = "px-2 py-2 text-center text-xs cursor-pointer hover:bg-gray-200 transition select-none";
      const active = sortKey === key ? (sortDirection === 'asc' ? 'sorted-asc bg-gray-200' : 'sorted-desc bg-gray-200') : '';
      return `${base} ${active}`;
  };

  $: sortedData = [...employeeData].sort((a, b) => {
    let valA = 0;
    let valB = 0;

    if (sortKey === 'hoTen') {
        const nameA = a.hoTen || '';
        const nameB = b.hoTen || '';
        return sortDirection === 'asc' ? nameA.localeCompare(nameB) : nameB.localeCompare(nameA);
    } 
    // Logic sort ƒë·ªông cho c√°c c·ªôt H√£ng (VD: samsung_quantity)
    else if (sortKey.includes('_quantity') || sortKey.includes('_revenue')) {
        const [brandName, type] = sortKey.split('_'); // T√°ch t√™n h√£ng v√† lo·∫°i (quantity/revenue)
        const perfA = a.performanceByBrand[brandName] || { quantity: 0, revenue: 0 };
        const perfB = b.performanceByBrand[brandName] || { quantity: 0, revenue: 0 };
        valA = perfA[type] || 0;
        valB = perfB[type] || 0;
    }
    // Logic sort cho c√°c c·ªôt T·ªïng
    else {
        valA = Number(a[sortKey]) || 0;
        valB = Number(b[sortKey]) || 0;
    }
    return sortDirection === 'asc' ? valA - valB : valB - valA;
  });

  // T√≠nh t·ªïng
  $: totals = employeeData.reduce((acc, item) => {
      acc.baseCategoryQuantity += item.baseCategoryQuantity;
      acc.baseCategoryRevenue += item.baseCategoryRevenue;
      acc.targetBrandsQuantity += item.targetBrandsQuantity;
      acc.targetBrandsRevenue += item.targetBrandsRevenue;

      for (const brandName of brands) {
          if (!acc.performanceByBrand[brandName]) {
              acc.performanceByBrand[brandName] = { quantity: 0, revenue: 0 };
          }
          const brandPerf = item.performanceByBrand[brandName];
          if (brandPerf) {
              acc.performanceByBrand[brandName].quantity += brandPerf.quantity;
              acc.performanceByBrand[brandName].revenue += brandPerf.revenue;
          }
      }
      return acc;
  }, { 
      baseCategoryQuantity: 0, baseCategoryRevenue: 0,
      targetBrandsQuantity: 0, targetBrandsRevenue: 0,
      performanceByBrand: {}
  });

  $: totalTyLeSL = totals.baseCategoryQuantity > 0 ? (totals.targetBrandsQuantity / totals.baseCategoryQuantity) : 0;
  $: totalTyLeDT = totals.baseCategoryRevenue > 0 ? (totals.targetBrandsRevenue / totals.baseCategoryRevenue) : 0;
</script>

<div class="bg-white rounded-xl shadow-md border border-gray-200 overflow-hidden flex flex-col h-full" data-capture-group="competition-focus">
    <div class="p-4 bg-gray-50 border-b-2 border-indigo-200 flex justify-between items-center">
        <div>
            <h3 class="text-lg font-bold text-indigo-800 uppercase">{competition.name}</h3>
            <p class="text-xs text-indigo-600 font-medium mt-1">H√£ng: {brands.join(', ')}</p>
        </div>
        <div class="flex items-center gap-2 bg-white px-2 py-1 rounded border border-indigo-100">
            <label for="target-{competition.id}" class="text-xs font-bold text-gray-500 uppercase">M·ª•c ti√™u %:</label>
            <input 
                type="number" 
                id="target-{competition.id}"
                class="w-16 p-1 text-sm border border-gray-300 rounded text-center focus:border-indigo-500 outline-none"
                bind:value={targetDisplay}
                placeholder="0"
            >
        </div>
    </div>

    <div class="overflow-x-auto flex-grow">
        <table class="min-w-full text-sm text-left text-gray-600 table-bordered table-striped">
            <thead class="text-xs text-slate-800 uppercase bg-slate-200 font-bold sticky top-0 z-10">
                <tr>
                    <th rowspan="2" class="px-4 py-2 bg-gray-100 border border-gray-300 cursor-pointer min-w-[150px]" on:click={() => handleSort('hoTen')}>
                        NH√ÇN VI√äN {sortKey === 'hoTen' ? (sortDirection === 'asc' ? '‚ñ≤' : '‚ñº') : ''}
                    </th>
                    {#each brands as brand}
                        <th colspan="2" class="px-4 py-2 text-center bg-purple-100 text-purple-900 border border-purple-200">{brand}</th>
                    {/each}
                    <th colspan="2" class="px-4 py-2 text-center bg-blue-100 text-blue-900 border border-blue-200">T·ªîNG NH√ìM</th>
                    <th colspan="2" class="px-4 py-2 text-center bg-orange-100 text-orange-900 border border-orange-200">T·ª∂ L·ªÜ KHAI TH√ÅC</th>
                </tr>
                
                <tr>
                    {#each brands as brand}
                        <th class="{getHeaderClass(`${brand}_quantity`)} bg-purple-50" on:click={() => handleSort(`${brand}_quantity`)}>
                            SL {sortKey === `${brand}_quantity` ? (sortDirection === 'asc' ? '‚ñ≤' : '‚ñº') : ''}
                        </th>
                        <th class="{getHeaderClass(`${brand}_revenue`)} bg-purple-50" on:click={() => handleSort(`${brand}_revenue`)}>
                            DT {sortKey === `${brand}_revenue` ? (sortDirection === 'asc' ? '‚ñ≤' : '‚ñº') : ''}
                        </th>
                    {/each}
                    
                    <th class="{getHeaderClass('baseCategoryQuantity')} bg-blue-50" on:click={() => handleSort('baseCategoryQuantity')}>
                        SL {sortKey === 'baseCategoryQuantity' ? (sortDirection === 'asc' ? '‚ñ≤' : '‚ñº') : ''}
                    </th>
                    <th class="{getHeaderClass('baseCategoryRevenue')} bg-blue-50" on:click={() => handleSort('baseCategoryRevenue')}>
                        DT {sortKey === 'baseCategoryRevenue' ? (sortDirection === 'asc' ? '‚ñ≤' : '‚ñº') : ''}
                    </th>
                    
                    <th class="{getHeaderClass('tyLeSL')} bg-orange-50" on:click={() => handleSort('tyLeSL')}>
                        % SL {sortKey === 'tyLeSL' ? (sortDirection === 'asc' ? '‚ñ≤' : '‚ñº') : ''}
                    </th>
                    <th class="{getHeaderClass('tyLeDT')} bg-orange-50" on:click={() => handleSort('tyLeDT')}>
                        % DT {sortKey === 'tyLeDT' ? (sortDirection === 'asc' ? '‚ñ≤' : '‚ñº') : ''}
                    </th>
                </tr>
            </thead>
            <tbody class="divide-y divide-gray-200">
                {#each sortedData as item (item.maNV)}
                    {@const isBelowSL = targetDisplay > 0 && (item.tyLeSL * 100) < targetDisplay}
                    {@const isBelowDT = targetDisplay > 0 && (item.tyLeDT * 100) < targetDisplay}
                    
                    <tr class="hover:bg-indigo-50 transition">
                        <td class="px-4 py-2 font-semibold text-indigo-900 sticky left-0 bg-white hover:bg-indigo-50 border-r">
                            {formatters.getShortEmployeeName(item.hoTen, item.maNV)}
                        </td>
                        {#each brands as brand}
                            {@const brandPerf = item.performanceByBrand[brand] || { quantity: 0, revenue: 0 }}
                            <td class="px-2 py-2 text-right font-medium">{formatters.formatNumber(brandPerf.quantity)}</td>
                            <td class="px-2 py-2 text-right font-medium">{formatters.formatRevenue(brandPerf.revenue)}</td>
                        {/each}
                        <td class="px-2 py-2 text-right font-bold bg-blue-50/30">{formatters.formatNumber(item.baseCategoryQuantity)}</td>
                        <td class="px-2 py-2 text-right font-bold bg-blue-50/30">{formatters.formatRevenue(item.baseCategoryRevenue)}</td>
                        
                        <td class="px-2 py-2 text-right font-bold bg-orange-50/30 {isBelowSL ? 'text-red-600' : 'text-green-600'}">
                            {formatters.formatPercentage(item.tyLeSL)}
                        </td>
                        <td class="px-2 py-2 text-right font-bold bg-orange-50/30 {isBelowDT ? 'text-red-600' : 'text-green-600'}">
                            {formatters.formatPercentage(item.tyLeDT)}
                        </td>
                    </tr>
                {/each}
            </tbody>
            <tfoot class="table-footer font-bold bg-gray-100 border-t-2 border-gray-300">
                <tr>
                    <td class="px-4 py-2">T·ªïng</td>
                    {#each brands as brand}
                        {@const brandTotals = totals.performanceByBrand[brand] || { quantity: 0, revenue: 0 }}
                        <td class="px-2 py-2 text-right">{formatters.formatNumber(brandTotals.quantity)}</td>
                        <td class="px-2 py-2 text-right">{formatters.formatRevenue(brandTotals.revenue)}</td>
                    {/each}
                    <td class="px-2 py-2 text-right">{formatters.formatNumber(totals.baseCategoryQuantity)}</td>
                    <td class="px-2 py-2 text-right">{formatters.formatRevenue(totals.baseCategoryRevenue)}</td>
                    <td class="px-2 py-2 text-right">{formatters.formatPercentage(totalTyLeSL)}</td>
                    <td class="px-2 py-2 text-right">{formatters.formatPercentage(totalTyLeDT)}</td>
                </tr>
            </tfoot>
        </table>
    </div>
</div>
--- END FILE: ./src/components/realtime/competition/FocusCompetitionTable.svelte ---

--- START FILE: ./src/components/realtime/competition/SpecialProgramTable.svelte ---
<script>
  import { formatters } from '../../../utils/formatters.js';
  import SortableTh from '../../common/SortableTh.svelte';

  // Nh·∫≠n v√†o d·ªØ li·ªáu c·ªßa M·ªòT ch∆∞∆°ng tr√¨nh SPƒêQ
  export let programResult;

  const { program, employeeData } = programResult;

  let sortKey = 'tyLeSL';
  let sortDirection = 'desc';

  function handleSort(event) {
    const key = event.detail;
    if (sortKey === key) {
      sortDirection = sortDirection === 'desc' ? 'asc' : 'desc';
    } else {
      sortKey = key;
      sortDirection = 'desc';
    }
  }

  $: sortedData = [...employeeData].sort((a, b) => {
    let valA = Number(a[sortKey]) || 0;
    let valB = Number(b[sortKey]) || 0;

    if (sortKey === 'hoTen') {
        const nameA = a.hoTen || '';
        const nameB = b.hoTen || '';
        return sortDirection === 'asc' ? nameA.localeCompare(nameB) : nameB.localeCompare(nameA);
    }
    return sortDirection === 'asc' ? valA - valB : valB - valA;
  });

  // T√≠nh t·ªïng
  $: totals = employeeData.reduce((acc, item) => {
      acc.slDacQuyen += item.slDacQuyen;
      acc.slNhomHang += item.slNhomHang;
      acc.dtDacQuyen += item.dtDacQuyen;
      acc.dtNhomHang += item.dtNhomHang;
      return acc;
  }, { slDacQuyen: 0, slNhomHang: 0, dtDacQuyen: 0, dtNhomHang: 0 });

  $: totalTyLeSL = totals.slNhomHang > 0 ? (totals.slDacQuyen / totals.slNhomHang) : 0;
  $: totalTyLeDT = totals.dtNhomHang > 0 ? (totals.dtDacQuyen / totals.dtNhomHang) : 0;
</script>

<div class="bg-white rounded-xl shadow-md border border-gray-200 overflow-hidden flex flex-col h-full" data-capture-group="special-program">
    <div class="p-4 bg-purple-50 border-b-2 border-purple-200">
        <h3 class="text-lg font-bold text-purple-800 uppercase">{program.name}</h3>
        <p class="text-xs text-purple-700 font-medium mt-1">Nh√≥m h√†ng: {program.groups.join(', ')}</p>
    </div>

    <div class="overflow-x-auto flex-grow">
        <table class="min-w-full text-sm text-left text-gray-600 table-bordered table-striped">
            <thead class="text-xs text-slate-800 uppercase bg-slate-200 font-bold sticky top-0 z-10">
                <tr>
                    <SortableTh key="hoTen" label="Nh√¢n vi√™n" className="min-w-[150px]" {sortKey} {sortDirection} on:sort={handleSort} />
                    <SortableTh key="slDacQuyen" label="SL SPƒêQ" align="right" {sortKey} {sortDirection} on:sort={handleSort} />
                    <SortableTh key="slNhomHang" label="SL Nh√≥m" align="right" {sortKey} {sortDirection} on:sort={handleSort} />
                    <SortableTh key="tyLeSL" label="% SL" align="right" className="bg-yellow-50" {sortKey} {sortDirection} on:sort={handleSort} />
                    <SortableTh key="dtDacQuyen" label="DT SPƒêQ" align="right" {sortKey} {sortDirection} on:sort={handleSort} />
                    <SortableTh key="dtNhomHang" label="DT Nh√≥m" align="right" {sortKey} {sortDirection} on:sort={handleSort} />
                    <SortableTh key="tyLeDT" label="% DT" align="right" className="bg-yellow-50" {sortKey} {sortDirection} on:sort={handleSort} />
                </tr>
            </thead>
            <tbody class="divide-y divide-gray-200">
                {#each sortedData as item (item.maNV)}
                    <tr class="hover:bg-purple-50 transition">
                        <td class="px-4 py-2 font-semibold text-purple-900 sticky left-0 bg-white hover:bg-purple-50 border-r">
                            {formatters.getShortEmployeeName(item.hoTen, item.maNV)}
                        </td>
                        <td class="px-2 py-2 text-right font-bold">{formatters.formatNumber(item.slDacQuyen)}</td>
                        <td class="px-2 py-2 text-right font-bold">{formatters.formatNumber(item.slNhomHang)}</td>
                        <td class="px-2 py-2 text-right font-bold {item.tyLeSL > 0 ? 'text-blue-600' : 'text-gray-400'} bg-yellow-50/30">
                            {formatters.formatPercentage(item.tyLeSL)}
                        </td>
                        <td class="px-2 py-2 text-right font-bold">{formatters.formatRevenue(item.dtDacQuyen)}</td>
                        <td class="px-2 py-2 text-right font-bold">{formatters.formatRevenue(item.dtNhomHang)}</td>
                        <td class="px-2 py-2 text-right font-bold {item.tyLeDT > 0 ? 'text-green-600' : 'text-gray-400'} bg-yellow-50/30">
                            {formatters.formatPercentage(item.tyLeDT)}
                        </td>
                    </tr>
                {/each}
            </tbody>
            <tfoot class="table-footer font-bold bg-gray-100 border-t-2 border-gray-300">
                <tr>
                    <td class="px-4 py-2">T·ªïng</td>
                    <td class="px-2 py-2 text-right">{formatters.formatNumber(totals.slDacQuyen)}</td>
                    <td class="px-2 py-2 text-right">{formatters.formatNumber(totals.slNhomHang)}</td>
                    <td class="px-2 py-2 text-right">{formatters.formatPercentage(totalTyLeSL)}</td>
                    <td class="px-2 py-2 text-right">{formatters.formatRevenue(totals.dtDacQuyen)}</td>
                    <td class="px-2 py-2 text-right">{formatters.formatRevenue(totals.dtNhomHang)}</td>
                    <td class="px-2 py-2 text-right">{formatters.formatPercentage(totalTyLeDT)}</td>
                </tr>
            </tfoot>
        </table>
    </div>
</div>
--- END FILE: ./src/components/realtime/competition/SpecialProgramTable.svelte ---

--- START FILE: ./src/components/realtime/efficiency/EfficiencyTab.svelte ---
<script>
  import { realtimeYCXData, selectedWarehouse } from '../../../stores.js';
  import { reportService } from '../../../services/reportService.js';
  import { settingsService } from '../../../services/settings.service.js';
  
  // [THAY ƒê·ªîI QUAN TR·ªåNG] Import b·∫£ng t·ª´ Health Staff ƒë·ªÉ ƒë·ªìng b·ªô giao di·ªán
  import EfficiencyTable from '../../health-staff/EfficiencyTable.svelte';

  // Bi·∫øn d·ªØ li·ªáu
  let filteredReport = [];

  $: {
    // 1. L·∫•y d·ªØ li·ªáu & M·ª•c ti√™u
    const currentWarehouse = $selectedWarehouse;
    const settings = settingsService.getRealtimeGoalSettings(currentWarehouse);
    const goals = settings.goals || {};

    // 2. T√≠nh to√°n Master Report (Array danh s√°ch nh√¢n vi√™n)
    const masterReport = reportService.generateMasterReportData($realtimeYCXData, goals, true);
    
    // 3. L·ªçc theo kho
    if (currentWarehouse) {
      filteredReport = masterReport.filter(nv => nv.maKho == currentWarehouse);
    } else {
      filteredReport = masterReport;
    }
  }
</script>

<div class="animate-fade-in pb-10">
    <EfficiencyTable reportData={filteredReport} />
</div>

<style>
  .animate-fade-in { animation: fadeIn 0.3s ease-out; }
  @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
</style>
--- END FILE: ./src/components/realtime/efficiency/EfficiencyTab.svelte ---

--- START FILE: ./src/components/realtime/efficiency/EfficiencyTable.svelte ---
<script>
  import { afterUpdate, createEventDispatcher, onMount } from 'svelte';
  import { formatters } from '../../../utils/formatters.js';

  export let items = []; 
  export let dynamicItems = [];
  export let supermarketData = {}; 
  export let goals = {}; // Nh·∫≠n goals t·ª´ component cha
  
  const dispatch = createEventDispatcher();

  // --- PH·∫¶N STATE X·ª¨ L√ù ·∫®N/HI·ªÜN C·ªòT (FILTER) ---
  let isSettingsOpen = false;
  let filterSearch = '';
  let hiddenIds = new Set(); 
  const STORAGE_KEY = 'realtime_efficiency_hidden_ids';

  onMount(() => {
      // Load tr·∫°ng th√°i ·∫©n hi·ªán t·ª´ localStorage
      const saved = localStorage.getItem(STORAGE_KEY);
      if (saved) { 
          try { hiddenIds = new Set(JSON.parse(saved)); } catch (e) {} 
      }
      if (typeof feather !== 'undefined') feather.replace();
  });

  afterUpdate(() => { 
      if (typeof feather !== 'undefined') feather.replace(); 
  });

  function saveHiddenState() { 
      localStorage.setItem(STORAGE_KEY, JSON.stringify([...hiddenIds])); 
  }

  // Map icon cho c√°c ch·ªâ s·ªë c·ªë ƒë·ªãnh
  const iconMap = { 
      'pctPhuKien': 'headphones', 
      'pctGiaDung': 'home', 
      'pctMLN': 'droplet', 
      'pctSim': 'cpu', 
      'pctVAS': 'layers', 
      'pctBaoHiem': 'shield', 
      'tyLeTraCham': 'credit-card' 
  };

  // Map key ƒë·ªÉ l·∫•y m·ª•c ti√™u t∆∞∆°ng ·ª©ng t·ª´ settings
  const targetMap = {
      'pctPhuKien': 'phanTramPhuKien', 
      'pctGiaDung': 'phanTramGiaDung', 
      'pctMLN': 'phanTramMLN',
      'pctSim': 'phanTramSim', 
      'pctVAS': 'phanTramVAS', 
      'pctBaoHiem': 'phanTramBaoHiem', 
      'tyLeTraCham': 'phanTramTC'
  };

  // G·ªôp items c·ªë ƒë·ªãnh v√† dynamic items l·∫°i th√†nh danh s√°ch hi·ªÉn th·ªã
  $: displayItems = [
      // C√°c ch·ªâ s·ªë c·ªë ƒë·ªãnh (Hardcoded)
      ...items.map(i => ({
          ...i,
          // L·∫•y target t·ª´ goals truy·ªÅn v√†o, n·∫øu kh√¥ng c√≥ th√¨ b·∫±ng 0
          target: goals?.[targetMap[i.id]] || 0 
      })),
      // C√°c ch·ªâ s·ªë ƒë·ªông t·ª´ Admin Config
      ...(dynamicItems || []).map(cfg => {
          const metric = supermarketData.dynamicMetrics?.[cfg.id];
          return {
              id: cfg.id,
              label: cfg.label,
              value: metric ? metric.value : 0,
              target: cfg.target,
              isDynamic: true,
              rawConfig: cfg
          };
      })
  ];

  // Logic l·ªçc danh s√°ch trong dropdown filter
  $: filterList = displayItems.filter(item => item.label.toLowerCase().includes(filterSearch.toLowerCase()));

  // Danh s√°ch c√°c item th·ª±c s·ª± ƒë∆∞·ª£c hi·ªÉn th·ªã ra ngo√†i (ƒë√£ tr·ª´ c√°c item b·ªã ·∫©n)
  $: visibleItems = displayItems.filter(item => !hiddenIds.has(item.id));

  // H√†m toggle ·∫©n/hi·ªán 1 item
  function toggleVisibility(id) {
      if (hiddenIds.has(id)) hiddenIds.delete(id); 
      else hiddenIds.add(id);
      hiddenIds = new Set(hiddenIds); // Trigger reactivity
      saveHiddenState();
  }

  // H√†m ·∫©n/hi·ªán t·∫•t c·∫£
  function toggleAllVisibility(show) {
      if (show) {
          hiddenIds = new Set();
      } else {
          hiddenIds = new Set(displayItems.map(i => i.id));
      }
      saveHiddenState();
  }

  // --- LOGIC M√ÄU S·∫ÆC & C·∫¢NH B√ÅO ---
  function getProgressColor(val, target) {
      const t = (target || 0) / 100;
      if (t <= 0) return '#3b82f6'; // Xanh d∆∞∆°ng m·∫∑c ƒë·ªãnh n·∫øu kh√¥ng c√≥ target
      return val >= t ? '#16a34a' : '#ef4444'; // ƒê·∫°t -> Xanh l√°, R·ªõt -> ƒê·ªè
  }
  
  // ƒê√≥ng dropdown khi click ra ngo√†i
  function handleWindowClick(e) { 
      if (isSettingsOpen && !e.target.closest('.filter-wrapper')) {
          isSettingsOpen = false;
      }
  }

  function handleDelete(id) { 
      if(confirm('B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a ch·ªâ s·ªë n√†y?')) {
          dispatch('delete', id);
      }
  }
</script>

<svelte:window on:click={handleWindowClick} />

<div class="luyke-widget h-full bg-white border border-gray-200 rounded-xl shadow-sm">
  <div class="luyke-widget-header">
    <div class="luyke-widget-title">
      <div class="p-1.5 bg-blue-100 rounded text-blue-600 mr-2">
          <i data-feather="bar-chart-2" class="w-4 h-4"></i>
      </div>
      <span>HI·ªÜU QU·∫¢ KHAI TH√ÅC</span>
    </div>
    
    <div class="flex items-center gap-2">
        <button class="text-blue-600 hover:bg-blue-50 p-1.5 rounded text-xs font-bold flex items-center gap-1 border border-blue-200" on:click={() => dispatch('add')}>
            <i data-feather="plus" class="w-3 h-3"></i> Th√™m
        </button>
        
        <div class="relative filter-wrapper">
            <button class="luyke-icon-btn {isSettingsOpen ? 'active' : ''}" on:click={() => isSettingsOpen = !isSettingsOpen}>
                <i data-feather="filter" class="w-4 h-4"></i>
            </button>
            
            {#if isSettingsOpen}
                <div class="filter-dropdown">
                    <div class="filter-header">
                        <input type="text" class="filter-search" placeholder="T√¨m ch·ªâ s·ªë..." bind:value={filterSearch} />
                    </div>
                    <div class="filter-body custom-scrollbar" style="max-height: 250px;">
                        {#each filterList as item (item.id)}
                            <div class="filter-item" on:click={() => toggleVisibility(item.id)}>
                                <input type="checkbox" checked={!hiddenIds.has(item.id)} /> 
                                <label>{item.label}</label>
                            </div>
                        {/each}
                    </div>
                    <div class="filter-actions">
                        <button class="filter-btn-link" on:click={() => toggleAllVisibility(true)}>Hi·ªán t·∫•t c·∫£</button>
                        <button class="filter-btn-link text-red-600" on:click={() => toggleAllVisibility(false)}>·∫®n t·∫•t c·∫£</button>
                    </div>
                </div>
            {/if}
        </div>
    </div>
  </div>

  <div class="luyke-widget-body custom-scrollbar p-0">
    {#if visibleItems.length === 0}
       <div class="flex flex-col items-center justify-center h-full text-gray-400 py-10">
           <p class="text-sm">ƒê√£ ·∫©n h·∫øt d·ªØ li·ªáu.</p>
       </div>
    {:else}
      <div class="flex flex-col gap-0">
        {#each visibleItems as item (item.id)}
          {@const targetVal = (item.target || 0) / 100}
          {@const color = getProgressColor(item.value, item.target)}
          {@const percent = Math.min((item.value * 100), 100)}
          
          <div class="eff-item-compact group relative hover:bg-gray-50 transition-colors px-4">
            <div class="eff-icon-compact">
                <i data-feather={iconMap[item.id] || 'activity'} class="w-4 h-4"></i>
            </div>
            
            <div class="eff-content-compact">
                <div class="eff-row-top">
                    <span class="eff-label-text">{item.label}</span>
                    <span class="eff-value-text" style="color: {color}">
                        {formatters.formatPercentage(item.value)}
                    </span>
                </div>
                
                <div class="eff-row-bottom">
                    <div class="eff-bar-container">
                         <div class="eff-bar-fill" style="width: {percent}%; background-color: {color};"></div>
                    </div>
                    
                    {#if item.target > 0}
                        <span class="eff-target-text {item.value < targetVal ? 'text-red-500 font-bold' : 'text-green-600'}">
                            MT: {item.target}%
                        </span>
                    {/if}
                </div>
            </div>

            {#if item.isDynamic}
                <div class="absolute right-2 top-2 hidden group-hover:flex gap-1 bg-white shadow-sm border border-gray-200 rounded p-1 z-10">
                     <button on:click|stopPropagation={() => dispatch('edit', item.rawConfig)} class="text-gray-500 hover:text-blue-600 p-1" title="S·ª≠a">
                         <i data-feather="edit-2" class="w-3 h-3"></i>
                     </button>
                    <button on:click|stopPropagation={() => handleDelete(item.id)} class="text-gray-500 hover:text-red-600 p-1" title="X√≥a">
                        <i data-feather="trash-2" class="w-3 h-3"></i>
                    </button>
                </div>
            {/if}
          </div>
        {/each}
      </div>
    {/if}
  </div>
</div>
--- END FILE: ./src/components/realtime/efficiency/EfficiencyTable.svelte ---

--- START FILE: ./src/components/realtime/employee/EmployeeDetail.svelte ---
<script>
  import { createEventDispatcher } from 'svelte';
  import { realtimeYCXData, employeeMaNVMap } from '../../../stores.js';
  import { reportService } from '../../../services/reportService.js';
  // [FIX] C·∫≠p nh·∫≠t ƒë∆∞·ªùng d·∫´n ƒë√∫ng: modules -> services
  import { settingsService } from '../../../services/settings.service.js';
  import { formatters } from '../../../utils/formatters.js';
  
  export let employeeId;

  const dispatch = createEventDispatcher();
  let detailData = null;
  let employeeName = 'N/A';
  let goals = {};

  // Reactive: T√≠nh to√°n d·ªØ li·ªáu chi ti·∫øt khi employeeId thay ƒë·ªïi
  $: {
    if (employeeId && $realtimeYCXData.length > 0) {
      const info = $employeeMaNVMap.get(String(employeeId));
      employeeName = info ? formatters.getShortEmployeeName(info.hoTen, info.maNV) : `NV ${employeeId}`;
      
      const warehouse = info ? info.maKho : '';
      const settings = settingsService.getRealtimeGoalSettings(warehouse);
      goals = settings.goals || {};
      
      detailData = reportService.generateRealtimeEmployeeDetailReport(employeeId, $realtimeYCXData);
    }
  }

  function goBack() {
      dispatch('back');
  }
</script>

<div class="max-w-4xl mx-auto animate-fade-in pb-10">
    <div class="mb-4 flex justify-between items-center">
        <button class="text-blue-600 hover:underline font-semibold flex items-center gap-1" on:click={goBack}>
            ‚Äπ Quay l·∫°i b·∫£ng t·ªïng h·ª£p
        </button>
    </div>

    {#if detailData}
        {@const summary = detailData.summary}
        {@const conversionRateTarget = (goals?.phanTramQD || 0) / 100}
        {@const isPositive = summary.conversionRate >= conversionRateTarget}

        <div class="bg-white rounded-lg shadow-md p-6 border border-gray-200 mb-6 text-center">
            <h3 class="text-2xl font-extrabold text-gray-800">{employeeName}</h3>
            <p class="text-gray-500 font-medium">Chi ti·∫øt doanh thu Realtime</p>
        </div>

        <div class="grid grid-cols-2 md:grid-cols-3 gap-4 mb-6">
             <div class="bg-white p-4 rounded-lg shadow border border-gray-100 text-center">
                 <div class="text-sm text-gray-500 font-medium uppercase">T·ªïng DT Th·ª±c</div>
                 <div class="text-2xl font-bold text-blue-600 mt-1">{formatters.formatRevenue(summary.totalRealRevenue, 1)}</div>
             </div>
             <div class="bg-white p-4 rounded-lg shadow border border-gray-100 text-center">
                 <div class="text-sm text-gray-500 font-medium uppercase">T·ªïng DTQƒê</div>
                 <div class="text-2xl font-bold text-purple-600 mt-1">{formatters.formatRevenue(summary.totalConvertedRevenue, 1)}</div>
             </div>
             <div class="bg-white p-4 rounded-lg shadow border border-gray-100 text-center">
                 <div class="text-sm text-gray-500 font-medium uppercase">T·ª∑ l·ªá Qƒê</div>
                 <div class="text-2xl font-bold mt-1 {isPositive ? 'text-green-600' : 'text-red-600'}">
                    {formatters.formatPercentage(summary.conversionRate)}
                 </div>
             </div>
             <div class="bg-white p-4 rounded-lg shadow border border-gray-100 text-center">
                <div class="text-sm text-gray-500 font-medium uppercase">DT Ch∆∞a Xu·∫•t</div>
                 <div class="text-2xl font-bold text-yellow-600 mt-1">{formatters.formatRevenue(summary.unexportedRevenue, 1)}</div>
            </div>
             <div class="bg-white p-4 rounded-lg shadow border border-gray-100 text-center">
                <div class="text-sm text-gray-500 font-medium uppercase">T·ªïng ƒê∆°n</div>
                <div class="text-2xl font-bold text-gray-800 mt-1">{summary.totalOrders}</div>
            </div>
            <div class="bg-white p-4 rounded-lg shadow border border-gray-100 text-center">
                 <div class="text-sm text-gray-500 font-medium uppercase">ƒê∆°n B√°n K√®m</div>
                <div class="text-2xl font-bold text-gray-800 mt-1">{summary.bundledOrderCount}</div>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            
            <div class="bg-white rounded-lg shadow-md border border-gray-200 p-5">
                <h4 class="text-lg font-bold text-gray-800 mb-4 border-b pb-2">T·ª∑ tr·ªçng Nh√≥m h√†ng</h4>
                <div class="space-y-4">
                    {#each detailData.byProductGroup as group}
                        {@const percent = summary.totalRealRevenue > 0 ? (group.realRevenue / summary.totalRealRevenue) * 100 : 0}
                        <div>
                             <div class="flex justify-between text-sm mb-1">
                                <span class="font-semibold">{group.name}</span>
                                <span class="font-bold text-gray-700">{formatters.formatRevenue(group.realRevenue, 0)}</span>
                             </div>
                            <div class="w-full bg-gray-200 rounded-full h-2.5">
                                <div class="bg-blue-600 h-2.5 rounded-full" style="width: {percent}%"></div>
                            </div>
                        </div>
                    {/each}
                </div>
            </div>

            <div class="bg-white rounded-lg shadow-md border border-gray-200 p-5">
                <h4 class="text-lg font-bold text-gray-800 mb-4 border-b pb-2">Chi ti·∫øt Kh√°ch h√†ng ({detailData.byCustomer.length})</h4>
                <div class="space-y-2 max-h-[500px] overflow-y-auto pr-2">
                     {#each detailData.byCustomer as customer, index}
                        <details class="group border border-gray-200 rounded-lg bg-gray-50 open:bg-white open:shadow-sm transition-all">
                            <summary class="flex justify-between items-center p-3 cursor-pointer list-none select-none">
                                <div class="flex items-center gap-2">
                                    <span class="font-bold text-gray-500 text-sm">{index + 1}.</span>
                                    <span class="font-semibold text-gray-800 text-sm">{customer.name}</span>
                                    <span class="text-xs font-bold bg-blue-100 text-blue-800 px-2 py-0.5 rounded-full">{customer.totalQuantity} SP</span>
                                </div>
                                <span class="transform group-open:rotate-180 transition-transform text-gray-400">‚ñº</span>
                            </summary>
                             <div class="p-3 border-t border-gray-100 text-sm">
                                <table class="w-full">
                                    {#each customer.products as p}
                                        <tr class="border-b last:border-0 border-gray-100">
                                            <td class="py-2 text-gray-600">{p.productName}</td>
                                            <td class="py-2 text-right font-bold text-gray-800">{formatters.formatRevenue(p.realRevenue)}</td>
                                        </tr>
                                    {/each}
                                </table>
                             </div>
                        </details>
                    {/each}
                </div>
            </div>
        </div>

    {:else}
        <div class="p-12 text-center bg-gray-50 rounded-lg border border-dashed border-gray-300">
             <p class="text-gray-500">ƒêang t·∫£i ho·∫∑c kh√¥ng c√≥ d·ªØ li·ªáu chi ti·∫øt...</p>
        </div>
    {/if}
</div>

<style>
  .animate-fade-in { animation: fadeIn 0.3s ease-out; }
  @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
</style>
--- END FILE: ./src/components/realtime/employee/EmployeeDetail.svelte ---

--- START FILE: ./src/components/realtime/employee/EmployeeList.svelte ---
<script>
  import { createEventDispatcher } from 'svelte';
  import { formatters } from '../../../utils/formatters.js';
  import { getSortedDepartmentList } from '../../../utils.js';

  export let reportData = [];
  const dispatch = createEventDispatcher();

  let sortKey = 'doanhThu';
  let sortDirection = 'desc';
  let groupedData = {};
  let departmentOrder = [];

  // Reactive statement ƒë·ªÉ nh√≥m d·ªØ li·ªáu
  $: {
      groupedData = {};
      if (reportData && reportData.length > 0) {
          reportData.forEach(item => {
            const dept = item.boPhan || 'Kh√°c';
            if (!groupedData[dept]) groupedData[dept] = [];
            groupedData[dept].push(item);
          });
          departmentOrder = getSortedDepartmentList(reportData);
      } else {
          departmentOrder = [];
      }
  }

  function handleSort(key) {
    if (sortKey === key) {
      sortDirection = sortDirection === 'desc' ? 'asc' : 'desc';
    } else {
      sortKey = key;
      sortDirection = 'desc';
    }
  }

  // S·ª¨A L·ªñI: Th√™m tham s·ªë key v√† dir v√†o h√†m ƒë·ªÉ Svelte nh·∫≠n bi·∫øt s·ª± thay ƒë·ªïi
  function sortEmployees(employees, key, dir) {
    return [...employees].sort((a, b) => {
      if (key === 'hoTen') {
        const nameA = a.hoTen || '';
        const nameB = b.hoTen || '';
        return dir === 'asc' ? nameA.localeCompare(nameB) : nameB.localeCompare(nameA);
      }
      
      // √âp ki·ªÉu s·ªë an to√†n
      let valA = Number(a[key]) || 0;
      let valB = Number(b[key]) || 0;
      
      return dir === 'asc' ? valA - valB : valB - valA;
    });
  }

  function getHeaderDeptClass(deptName) {
    if (deptName.includes('T∆∞ V·∫•n')) return 'bg-blue-100 text-blue-800 border-blue-200';
    if (deptName.includes('Kho')) return 'bg-green-100 text-green-800 border-green-200';
    if (deptName.includes('Trang Tr√≠')) return 'bg-yellow-100 text-yellow-800 border-yellow-200';
    return 'bg-gray-100 text-gray-800 border-gray-200';
  }
</script>

<div class="space-y-8">
  {#each departmentOrder as deptName}
    {#if groupedData[deptName]}
      <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
        <div class="p-4 border-b {getHeaderDeptClass(deptName)}">
          <h4 class="text-lg font-bold uppercase">{deptName}</h4>
        </div>

        <div class="overflow-x-auto">
          <table class="min-w-full text-sm text-left text-gray-600 table-bordered">
            <thead class="text-xs text-slate-800 uppercase bg-slate-200 font-bold sticky top-0 z-20 shadow-sm">
              <tr>
                <th class="px-4 py-3 cursor-pointer hover:bg-slate-300 transition sticky left-0 bg-slate-200 z-30 min-w-[180px] select-none" on:click={() => handleSort('hoTen')}>
                  <div class="flex items-center gap-1">
                    <span>Nh√¢n vi√™n</span>
                     <svg class="w-3 h-3 {sortKey === 'hoTen' ? 'text-blue-600 opacity-100' : 'text-gray-400 opacity-50'}" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="{sortKey === 'hoTen' && sortDirection === 'asc' ? 'M5 15l7-7 7 7' : 'M19 9l-7 7-7-7'}" />
                    </svg>
                  </div>
                </th>
                
                {#each [
                  { id: 'doanhThu', label: 'DT Th·ª±c', group: 'bg-blue-50 text-blue-800' },
                  { id: 'doanhThuQuyDoi', label: 'DT Qƒê', group: 'bg-blue-50 text-blue-800' },
                  { id: 'hieuQuaQuyDoi', label: '% Qƒê', group: 'bg-blue-50 text-blue-800' },
                  { id: 'doanhThuTraGop', label: 'DT Tr·∫£ ch·∫≠m', group: 'bg-green-50 text-green-800' },
                  { id: 'tyLeTraCham', label: '% Tr·∫£ ch·∫≠m', group: 'bg-green-50 text-green-800' },
                  { id: 'doanhThuChuaXuat', label: 'DT Ch∆∞a xu·∫•t', group: 'bg-yellow-50 text-yellow-800' }
                ] as col}
                  <th class="px-4 py-3 cursor-pointer hover:opacity-80 transition select-none {col.group}" on:click={() => handleSort(col.id)}>
                    <div class="flex items-center justify-end gap-1 whitespace-nowrap">
                      <span>{col.label}</span>
                      <svg class="w-3 h-3 {sortKey === col.id ? 'opacity-100' : 'opacity-40'}" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="{sortKey === col.id ? 3 : 2}" d="{sortKey === col.id && sortDirection === 'asc' ? 'M5 15l7-7 7 7' : 'M19 9l-7 7-7-7'}" />
                      </svg>
                    </div>
                  </th>
                {/each}
              </tr>
            </thead>
            <tbody class="divide-y divide-gray-200">
              {#each sortEmployees(groupedData[deptName], sortKey, sortDirection) as item (item.maNV)}
                {@const qdClass = (item.mucTieu && item.hieuQuaQuyDoi < (item.mucTieu.phanTramQD / 100)) ? 'text-red-600 bg-red-50' : 'text-green-600'}
                {@const tcClass = (item.mucTieu && item.tyLeTraCham < (item.mucTieu.phanTramTC / 100)) ? 'text-red-600 bg-red-50' : ''}
                 
                <tr class="hover:bg-blue-50 transition cursor-pointer interactive-row" on:click={() => dispatch('viewDetail', { employeeId: item.maNV })}>
                  <td class="px-4 py-2 font-semibold text-blue-600 sticky left-0 bg-white hover:bg-blue-50 z-10 border-r border-gray-200">
                    {formatters.getShortEmployeeName(item.hoTen, item.maNV)}
                  </td>
                  <td class="px-4 py-2 text-right font-bold text-gray-900">{formatters.formatRevenue(item.doanhThu)}</td>
                  <td class="px-4 py-2 text-right font-bold text-gray-900">{formatters.formatRevenue(item.doanhThuQuyDoi)}</td>
                  <td class="px-4 py-2 text-right font-bold {qdClass}">{formatters.formatPercentage(item.hieuQuaQuyDoi)}</td>
                  <td class="px-4 py-2 text-right font-bold text-gray-900">{formatters.formatRevenue(item.doanhThuTraGop)}</td>
                  <td class="px-4 py-2 text-right font-bold {tcClass}">{formatters.formatPercentage(item.tyLeTraCham)}</td>
                  <td class="px-4 py-2 text-right font-bold text-gray-500">{formatters.formatRevenue(item.doanhThuChuaXuat)}</td>
                </tr>
              {/each}
            </tbody>
          </table>
        </div>
      </div>
    {/if}
  {/each}
</div>
--- END FILE: ./src/components/realtime/employee/EmployeeList.svelte ---

--- START FILE: ./src/components/realtime/employee/EmployeeTab.svelte ---
<script>
  // [FIX] Th√™m import selectedWarehouse
  import { realtimeYCXData, selectedWarehouse } from '../../../stores.js';
  import { reportService } from '../../../services/reportService.js';
  import { settingsService } from '../../../services/settings.service.js';
  
  import EmployeeList from './EmployeeList.svelte';
  import EmployeeDetail from './EmployeeDetail.svelte';

  // [FIX] B·ªè export let selectedWarehouse
  
  let selectedEmployeeId = null;
  let filteredReport = [];

  $: {
    // [FIX] D√πng $selectedWarehouse
    const currentWarehouse = $selectedWarehouse;
    const settings = settingsService.getRealtimeGoalSettings(currentWarehouse);
    const goals = settings.goals || {};
    
    const masterReport = reportService.generateMasterReportData($realtimeYCXData, goals, true);
    
    if (currentWarehouse) {
      filteredReport = masterReport.filter(nv => nv.maKho == currentWarehouse);
    } else {
      filteredReport = masterReport;
    }
    
    console.log(`[EmployeeTab] Report generated for ${filteredReport.length} employees (Warehouse: ${currentWarehouse}).`);
  }

  function handleViewDetail(event) {
    selectedEmployeeId = event.detail.employeeId;
  }

  function handleBack() {
    selectedEmployeeId = null;
  }
</script>

<div class="animate-fade-in">
  {#if selectedEmployeeId}
    <EmployeeDetail 
      employeeId={selectedEmployeeId} 
      on:back={handleBack}
    />
  {:else}
    {#if filteredReport.length > 0}
      <EmployeeList 
        reportData={filteredReport} 
        on:viewDetail={handleViewDetail}
      />
    {:else}
      <div class="p-8 text-center bg-gray-50 rounded-lg border border-gray-200">
       <p class="text-gray-500">Kh√¥ng c√≥ d·ªØ li·ªáu nh√¢n vi√™n n√†o ph√π h·ª£p v·ªõi b·ªô l·ªçc.</p>
      </div>
    {/if}
  {/if}
</div>
--- END FILE: ./src/components/realtime/employee/EmployeeTab.svelte ---

--- START FILE: ./src/components/realtime/summary/CategoryTable.svelte ---
<script>
  import { afterUpdate, tick, onMount } from 'svelte';
  import { formatters } from '../../../utils/formatters.js';
  import { cleanCategoryName, getRandomBrightColor } from '../../../utils.js';
  // [M·ªöI] Import service ƒë·ªÉ l∆∞u cloud
  import { datasyncService } from '../../../services/datasync.service.js';
  import { selectedWarehouse } from '../../../stores.js';

  export let items = []; 
  export let unexportedItems = []; 
  export let rawSource = []; 

  // --- STATE ---
  let showUnexported = false;
  let viewMode = 'grid'; 
  let sortMode = 'revenue_desc';
  let searchText = '';
  
  // State cho b·ªô l·ªçc
  let isSettingsOpen = false;
  let filterSearch = '';
  let hiddenCategories = new Set(); 
  let isLoadingConfig = false;

  let chartInstancePie = null;
  let chartInstanceBar = null;

  // --- LOGIC TITLE & THEME ---
  $: titleText = showUnexported 
      ? "CHI TI·∫æT CH∆ØA XU·∫§T (Qƒê)" 
      : "CHI TI·∫æT NG√ÄNH H√ÄNG";
  
  $: titleIcon = showUnexported ? "alert-circle" : "layers";
  $: titleClass = showUnexported ? "text-red-700" : "text-blue-700";
  $: iconClass = showUnexported ? "text-red-600" : "text-blue-600";

  function getCategoryTheme(name) {
      const n = name.toLowerCase();
      if (n.includes('ƒëi·ªán t·ª≠') || n.includes('tivi')) return { icon: 'tv', theme: 'theme-teal' };
      if (n.includes('m√°y gi·∫∑t') || n.includes('s·∫•y')) return { icon: 'disc', theme: 'theme-blue' };
      if (n.includes('m√°y l·∫°nh') || n.includes('ƒëi·ªÅu h√≤a')) return { icon: 'wind', theme: 'theme-blue' };
      if (n.includes('t·ªß l·∫°nh') || n.includes('t·ªß ƒë√¥ng')) return { icon: 'server', theme: 'theme-blue' };
      if (n.includes('l·ªçc n∆∞·ªõc')) return { icon: 'droplet', theme: 'theme-blue' };
      if (n.includes('laptop') || n.includes('pc')) return { icon: 'monitor', theme: 'theme-teal' };
      if (n.includes('ƒëi·ªán tho·∫°i') || n.includes('smartphone')) return { icon: 'smartphone', theme: 'theme-blue' };
      if (n.includes('gia d·ª•ng') || n.includes('b·∫øp')) return { icon: 'home', theme: 'theme-orange' };
      if (n.includes('ph·ª• ki·ªán')) return { icon: 'headphones', theme: 'theme-purple' };
      if (n.includes('ƒë·ªìng h·ªì')) return { icon: 'watch', theme: 'theme-gray' };
      return { icon: 'tag', theme: 'theme-gray' };
  }

  // --- [M·ªöI] LOGIC LOAD/SAVE T·ª™ CLOUD ---
  // T·ª± ƒë·ªông t·∫£i c·∫•u h√¨nh khi ch·ªçn kho
  $: if ($selectedWarehouse) {
      loadCloudConfig($selectedWarehouse);
  }

  async function loadCloudConfig(kho) {
      isLoadingConfig = true;
      const hiddenList = await datasyncService.loadRealtimeHiddenCategories(kho);
      hiddenCategories = new Set(hiddenList);
      isLoadingConfig = false;
  }

  async function saveCloudConfig() {
      if ($selectedWarehouse) {
          await datasyncService.saveRealtimeHiddenCategories($selectedWarehouse, [...hiddenCategories]);
      }
  }

  // --- FILTER LOGIC ---
  $: allCategoryNames = items.map(i => i.name || i.nganhHang).sort();
  
  $: filterList = allCategoryNames.filter(name => 
      name.toLowerCase().includes(filterSearch.toLowerCase())
  );

  function toggleCategoryVisibility(name) {
      if (hiddenCategories.has(name)) {
          hiddenCategories.delete(name);
      } else {
          hiddenCategories.add(name);
      }
      hiddenCategories = new Set(hiddenCategories);
      saveCloudConfig(); // L∆∞u l√™n Cloud ngay l·∫≠p t·ª©c
  }

  function toggleAllVisibility(show) {
      if (show) {
          hiddenCategories = new Set();
      } else {
          hiddenCategories = new Set(allCategoryNames);
      }
      saveCloudConfig(); // L∆∞u l√™n Cloud ngay l·∫≠p t·ª©c
  }

  // --- DATA LOGIC ---
  $: sourceData = showUnexported ? unexportedItems : items;

  $: filteredItems = sourceData.filter(item => {
      const name = item.name || item.nganhHang || '';
      const matchSearch = !searchText || name.toLowerCase().includes(searchText.toLowerCase());
      const hasValue = showUnexported ? (item.doanhThuQuyDoi > 0) : (item.revenue > 0 || item.quantity > 0);
      
      // Ki·ªÉm tra ·∫©n/hi·ªán
      const isVisible = !hiddenCategories.has(name);

      return matchSearch && hasValue && isVisible;
  });

  $: sortedItems = [...filteredItems].sort((a, b) => {
      const getRev = (i) => showUnexported ? (i.doanhThuQuyDoi || 0) : (i.revenue || 0);
      const getQty = (i) => showUnexported ? (i.soLuong || 0) : (i.quantity || 0);
      
      if (sortMode === 'revenue_desc') return getRev(b) - getRev(a);
      if (sortMode === 'quantity_desc') return getQty(b) - getQty(a);
      return 0;
  });

  $: totalRevenue = sourceData.reduce((sum, item) => sum + (showUnexported ? (item.doanhThuQuyDoi || 0) : (item.revenue || 0)), 0);
  $: maxVal = Math.max(...sourceData.map(i => showUnexported ? (i.doanhThuQuyDoi || 0) : (i.revenue || 0)), 1);

  // --- CHART LOGIC ---
  // (Logic bi·ªÉu ƒë·ªì gi·ªØ nguy√™n)
  $: pieData = (() => {
      const sorted = sortedItems.slice(); 
      if (sorted.length <= 14) return sorted;
      const top13 = sorted.slice(0, 13);
      const others = sorted.slice(13);
      const otherRevenue = others.reduce((sum, item) => sum + (showUnexported ? item.doanhThuQuyDoi : item.revenue), 0);
      return [...top13, { name: 'Kh√°c', revenue: otherRevenue, doanhThuQuyDoi: otherRevenue }];
  })();

  $: barData = calculateBrandData(rawSource, filteredItems);

  function calculateBrandData(source, visibleItems) {
      if (!source || source.length === 0) return [];
      const visibleCategoryNames = new Set(visibleItems.map(i => cleanCategoryName(i.name || i.nganhHang)));
      const brands = {};

      source.forEach(row => {
          const rowCategoryName = cleanCategoryName(row.nganhHang);
          if (!visibleCategoryNames.has(rowCategoryName)) return;

          const brandName = row.nhaSanXuat || 'Kh√°c';
          const revenue = parseFloat(String(row.thanhTien || "0").replace(/,/g, '')) || 0;
          if (!brands[brandName]) brands[brandName] = { name: brandName, revenue: 0 };
          brands[brandName].revenue += revenue;
      });
      return Object.values(brands).sort((a, b) => b.revenue - a.revenue).slice(0, 15);
  }

  async function renderCharts() {
      if (typeof Chart === 'undefined') return;
      await tick();

      // Pie Chart
      const ctxPie = document.getElementById('rt-cat-chart');
      if (ctxPie) {
          if (chartInstancePie) chartInstancePie.destroy();
          const totalPieRev = pieData.reduce((sum, d) => sum + (showUnexported ? d.doanhThuQuyDoi : d.revenue), 0);

          chartInstancePie = new Chart(ctxPie, {
              type: 'doughnut',
              data: {
                  labels: pieData.map(d => d.name || d.nganhHang),
                  datasets: [{
                      data: pieData.map(d => showUnexported ? d.doanhThuQuyDoi : d.revenue),
                      backgroundColor: pieData.map(() => getRandomBrightColor()),
                      borderWidth: 1
                  }]
              },
              options: { 
                  responsive: true, maintainAspectRatio: false,
                  plugins: { 
                      legend: { position: 'right', labels: { boxWidth: 10, font: { size: 11 } } },
                      datalabels: {
                          formatter: (value) => {
                              const pct = totalPieRev > 0 ? (value / totalPieRev * 100) : 0;
                              return pct > 3 ? pct.toFixed(1) + "%" : "";
                          },
                          color: '#fff', font: { weight: 'bold', size: 10 }
                      }
                  } 
              },
              plugins: [ChartDataLabels]
          });
      }

      // Bar Chart
      const ctxBar = document.getElementById('rt-brand-chart');
      if (ctxBar) {
          if (chartInstanceBar) chartInstanceBar.destroy();
          chartInstanceBar = new Chart(ctxBar, {
              type: 'bar',
              data: {
                  labels: barData.map(d => d.name),
                  datasets: [{
                      label: 'Doanh thu (Tr)',
                      data: barData.map(d => d.revenue / 1000000),
                      backgroundColor: barData.map(() => getRandomBrightColor()),
                      borderRadius: 4
                  }]
              },
              options: {
                  indexAxis: 'y', responsive: true, maintainAspectRatio: false,
                  plugins: {
                      legend: { display: false },
                      datalabels: {
                          anchor: 'end', align: 'end',
                          formatter: (val) => formatters.formatNumber(val, 0),
                          color: '#4b5563', font: { weight: 'bold', size: 10 }
                      },
                      tooltip: {
                          callbacks: { label: (ctx) => formatters.formatRevenue(ctx.raw * 1000000) }
                      }
                  },
                  scales: { x: { beginAtZero: true } }
              },
              plugins: [ChartDataLabels]
          });
      }
  }

  $: if (viewMode === 'chart') setTimeout(renderCharts, 0);

  function handleWindowClick(e) {
      if (isSettingsOpen && !e.target.closest('.filter-wrapper')) {
          isSettingsOpen = false;
      }
  }

  afterUpdate(() => { if (typeof feather !== 'undefined') feather.replace(); });
</script>

<svelte:window on:click={handleWindowClick} />

<div class="luyke-widget h-full">
    <div class="luyke-toolbar">
        <div class="luyke-toolbar-left flex-grow min-w-0">
            <h3 class="text-base sm:text-lg font-bold uppercase flex items-center gap-2 {titleClass} truncate">
                <i data-feather={titleIcon} class="{iconClass} flex-shrink-0"></i>
                <span class="truncate">{titleText}</span>
            </h3>
        </div>

        <div class="luyke-toolbar-right flex items-center gap-2">
            <div class="flex bg-gray-100 p-0.5 rounded-lg border border-gray-200">
                <button class="view-mode-btn {viewMode === 'grid' ? 'active' : ''}" on:click={() => viewMode = 'grid'} title="Th·∫ª">
                    <i data-feather="grid" class="w-4 h-4"></i>
                </button>
                <button class="view-mode-btn {viewMode === 'table' ? 'active' : ''}" on:click={() => viewMode = 'table'} title="B·∫£ng">
                    <i data-feather="list" class="w-4 h-4"></i>
                </button>
                <button class="view-mode-btn {viewMode === 'chart' ? 'active' : ''}" on:click={() => viewMode = 'chart'} title="Bi·ªÉu ƒë·ªì">
                    <i data-feather="pie-chart" class="w-4 h-4"></i>
                </button>
            </div>

            <div 
                class="toggle-wrapper {showUnexported ? 'active' : ''}" 
                on:click={() => showUnexported = !showUnexported}
                title="Xem ƒë∆°n h√†ng ch∆∞a xu·∫•t"
                style="padding: 4px 8px;"
            >
                <div class="toggle-switch" style="width: 28px; height: 16px;"></div>
                <span class="toggle-label text-xs whitespace-nowrap">Ch∆∞a xu·∫•t</span>
            </div>

            <div class="relative filter-wrapper">
                <button 
                    class="luyke-icon-btn {isSettingsOpen ? 'active' : ''}" 
                    on:click={() => isSettingsOpen = !isSettingsOpen}
                    title="L·ªçc hi·ªÉn th·ªã ng√†nh h√†ng"
                >
                    {#if isLoadingConfig}
                        <div class="w-4 h-4 border-2 border-blue-600 border-t-transparent rounded-full animate-spin"></div>
                    {:else}
                        <i data-feather="filter" class="w-4 h-4"></i>
                    {/if}
                </button>

                {#if isSettingsOpen}
                    <div class="filter-dropdown">
                        <div class="filter-header">
                             <input type="text" class="filter-search" placeholder="T√¨m ng√†nh h√†ng..." bind:value={filterSearch} />
                        </div>
                        <div class="filter-body custom-scrollbar">
                            {#if filterList.length === 0}
                                <p class="text-xs text-gray-500 text-center p-2">Kh√¥ng t√¨m th·∫•y.</p>
                            {:else}
                                {#each filterList as name}
                                    <div class="filter-item" on:click={() => toggleCategoryVisibility(name)}>
                                        <input type="checkbox" checked={!hiddenCategories.has(name)} />
                                        <label>{name}</label>
                                    </div>
                                {/each}
                            {/if}
                        </div>
                        <div class="filter-actions">
                            <button class="filter-btn-link" on:click={() => toggleAllVisibility(true)}>Hi·ªán t·∫•t c·∫£</button>
                            <button class="filter-btn-link text-red-600" on:click={() => toggleAllVisibility(false)}>·∫®n t·∫•t c·∫£</button>
                        </div>
                    </div>
                {/if}
            </div>

            <div class="hidden sm:block">
                <input type="text" placeholder="T√¨m nhanh..." class="luyke-search-input" style="width: 120px;" bind:value={searchText} />
            </div>
        </div>
    </div>

    <div class="luyke-widget-body bg-white border-t border-gray-100 p-4">
        {#if sortedItems.length === 0}
            <div class="text-center py-10 text-gray-400 italic">Kh√¥ng c√≥ d·ªØ li·ªáu hi·ªÉn th·ªã.</div>
        
        {:else if viewMode === 'grid'}
            <div class="luyke-cat-grid">
                {#each sortedItems as item}
                    {@const name = item.name || item.nganhHang}
                    {@const revenue = showUnexported ? item.doanhThuQuyDoi : item.revenue}
                    {@const quantity = showUnexported ? item.soLuong : item.quantity}
                    {@const style = getCategoryTheme(name)}
                    {@const percent = maxVal > 0 ? (revenue / maxVal) * 100 : 0}
                    {@const finalTheme = showUnexported ? 'theme-warning' : style.theme}

                    <div class="cat-card-colorful {finalTheme}">
                        <div class="cat-top-row">
                            <div class="cat-icon-box"><i data-feather={style.icon} class="w-5 h-5"></i></div>
                            {#if !showUnexported && totalRevenue > 0}
                                <span class="cat-percent-text text-xs">{formatters.formatPercentage(revenue/totalRevenue)}</span>
                            {/if}
                        </div>
                        <h4 class="cat-name-text" title={name}>{name}</h4>
                        <div class="cat-value-text">{formatters.formatRevenue(revenue, 0)}</div>
                        <div class="cat-footer-row">
                            <span>SL: <strong>{formatters.formatNumber(quantity)}</strong></span>
                        </div>
                        <div class="cat-bar-bg"><div class="cat-bar-fill" style="width: {percent}%"></div></div>
                    </div>
                {/each}
            </div>

        {:else if viewMode === 'table'}
            <div class="overflow-x-auto">
                <table class="w-full text-sm table-bordered">
                    <thead class="bg-gray-100 font-bold text-gray-700">
                        <tr>
                            <th class="px-3 py-2 text-left">Ng√†nh h√†ng</th>
                            <th class="px-3 py-2 text-right">SL</th>
                            <th class="px-3 py-2 text-right">Doanh thu</th>
                            {#if showUnexported}<th class="px-3 py-2 text-right">DT Th·ª±c</th>{/if}
                        </tr>
                    </thead>
                    <tbody>
                        {#each sortedItems as item}
                            <tr class="hover:bg-gray-50">
                                <td class="px-3 py-2">{item.name || item.nganhHang}</td>
                                <td class="px-3 py-2 text-right font-bold">{formatters.formatNumber(showUnexported ? item.soLuong : item.quantity)}</td>
                                <td class="px-3 py-2 text-right font-bold text-blue-600">{formatters.formatRevenue(showUnexported ? item.doanhThuQuyDoi : item.revenue)}</td>
                                {#if showUnexported}
                                    <td class="px-3 py-2 text-right text-gray-500">{formatters.formatRevenue(item.doanhThuThuc)}</td>
                                {/if}
                            </tr>
                        {/each}
                    </tbody>
                </table>
            </div>

        {:else}
            <div class="luyke-charts-container p-0 border-0 rounded-none">
                <div class="chart-box">
                    <h4 class="text-sm font-bold text-gray-700 mb-2 text-center">T·ª∑ tr·ªçng Doanh Thu (Tri·ªáu)</h4>
                    <div class="relative h-full w-full"><canvas id="rt-cat-chart"></canvas></div>
                </div>
                <div class="chart-box">
                    <h4 class="text-sm font-bold text-gray-700 mb-2 text-center">Top 15 H√£ng (Tri·ªáu)</h4>
                    <div class="relative h-full w-full"><canvas id="rt-brand-chart"></canvas></div>
                </div>
            </div>
        {/if}
    </div>
</div>
--- END FILE: ./src/components/realtime/summary/CategoryTable.svelte ---

--- START FILE: ./src/components/realtime/summary/EfficiencyTable.svelte ---
<script>
  import { formatters } from '../../../utils/formatters.js';
  import SortableTh from '../../common/SortableTh.svelte';

  export let items = []; 

  let sortKey = 'label';
  let sortDirection = 'asc';

  function handleSort(event) {
    const key = event.detail;
    if (sortKey === key) {
      sortDirection = sortDirection === 'desc' ? 'asc' : 'desc';
    } else {
      sortKey = key;
      sortDirection = 'desc';
    }
  }

  $: sortedItems = [...items].sort((a, b) => {
    let valA, valB;

    if (sortKey === 'label') {
        valA = a.label || '';
        valB = b.label || '';
        return sortDirection === 'asc' ? valA.localeCompare(valB) : valB.localeCompare(valA);
    } 
    
    valA = a[sortKey] || 0;
    valB = b[sortKey] || 0;
    return sortDirection === 'asc' ? valA - valB : valB - valA;
  });
</script>

<div class="bg-white rounded-xl shadow-md p-4 border border-gray-200 h-full">
  <h3 class="text-lg font-bold text-gray-700 mb-4 uppercase border-b pb-2 bg-yellow-50 p-2 rounded">Hi·ªáu qu·∫£ khai th√°c</h3>

  {#if items.length === 0}
    <p class="text-gray-500 font-bold p-4 text-center">Vui l√≤ng t·∫£i file realtime ƒë·ªÉ xem chi ti·∫øt.</p>
  {:else}
    <div class="overflow-x-auto">
      <table class="min-w-full text-sm table-bordered">
        <thead class="text-xs text-slate-800 uppercase bg-slate-200 font-bold">
          <tr>
            <SortableTh key="label" label="Ch·ªâ s·ªë" align="left" {sortKey} {sortDirection} on:sort={handleSort} />
            <SortableTh key="value" label="Th·ª±c hi·ªán" align="right" {sortKey} {sortDirection} on:sort={handleSort} />
            <SortableTh key="target" label="M·ª•c ti√™u" align="right" {sortKey} {sortDirection} on:sort={handleSort} />
          </tr>
        </thead>
        <tbody>
          {#each sortedItems as item (item.id)}
            {@const isBelow = item.value < ((item.target || 0) / 100)}
            <tr class="border-t hover:bg-gray-50">
              <td class="px-4 py-2 font-semibold text-gray-800">{item.label}</td>
              <td class="px-4 py-2 text-right font-bold text-lg {isBelow ? 'bg-red-100 text-red-700' : 'text-blue-600'}">
                {formatters.formatPercentage(item.value)}
              </td>
              <td class="px-4 py-2 text-right text-gray-600">{item.target || 0}%</td>
            </tr>
          {/each}
        </tbody>
      </table>
    </div>
  {/if}
</div>
--- END FILE: ./src/components/realtime/summary/EfficiencyTable.svelte ---

--- START FILE: ./src/components/realtime/summary/KpiCards.svelte ---
<script>
  import { formatters } from '../../../utils/formatters.js';

  export let supermarketReport = {};
  export let goals = {};

  // Reactive variables ƒë·ªÉ hi·ªÉn th·ªã
  $: doanhThu = supermarketReport.doanhThu || 0;
  $: doanhThuQD = supermarketReport.doanhThuQuyDoi || 0;
  $: doanhThuTraGop = supermarketReport.doanhThuTraGop || 0;
  $: doanhThuChuaXuat = supermarketReport.doanhThuChuaXuat || 0;
  $: doanhThuQDChuaXuat = supermarketReport.doanhThuQuyDoiChuaXuat || 0;
  
  $: hieuQuaQuyDoi = supermarketReport.hieuQuaQuyDoi || 0;
  $: tyLeTraCham = supermarketReport.tyLeTraCham || 0;

  // M·ª•c ti√™u
  $: targetDTT = parseFloat(goals?.doanhThuThuc) || 0;
  $: targetDTQD = parseFloat(goals?.doanhThuQD) || 0;
  $: targetTLQD = parseFloat(goals?.phanTramQD) || 0;

  // T√≠nh % Ho√†n th√†nh
  $: percentDTT = targetDTT > 0 ? ((doanhThu / 1000000) / targetDTT) : 0;
  $: percentDTQD = targetDTQD > 0 ? ((doanhThuQD / 1000000) / targetDTQD) : 0;

</script>

<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
  <div class="kpi-card p-6 rounded-2xl shadow-lg bg-[#38bdf8]">
    <h4 class="kpi-card-title font-semibold uppercase tracking-wider text-white opacity-90">Doanh thu th·ª±c</h4>
    <p class="font-bold mt-2 mb-3 text-white text-4xl">
      {formatters.formatNumber(doanhThu / 1000000, 1)}
    </p>
    <div class="text-sm text-white opacity-90">
      <p>% HT: <span class="font-bold">{formatters.formatPercentage(percentDTT)}</span> / Target: {formatters.formatNumber(targetDTT)}</p>
      <p class="mt-1 text-xs border-t border-white/30 pt-1">DT Ch∆∞a xu·∫•t: <strong>{formatters.formatNumber(doanhThuChuaXuat / 1000000, 1)}</strong></p>
    </div>
  </div>

  <div class="kpi-card p-6 rounded-2xl shadow-lg bg-[#34d399]">
    <h4 class="kpi-card-title font-semibold uppercase tracking-wider text-white opacity-90">Doanh thu Quy ƒë·ªïi</h4>
    <p class="font-bold mt-2 mb-3 text-white text-4xl">
      {formatters.formatNumber(doanhThuQD / 1000000, 1)}
    </p>
    <div class="text-sm text-white opacity-90">
      <p>% HT: <span class="font-bold">{formatters.formatPercentage(percentDTQD)}</span> / Target: {formatters.formatNumber(targetDTQD)}</p>
      <p class="mt-1 text-xs border-t border-white/30 pt-1">DTQƒê Ch∆∞a xu·∫•t: <strong>{formatters.formatNumber(doanhThuQDChuaXuat / 1000000, 1)}</strong></p>
    </div>
  </div>

  <div class="kpi-card p-6 rounded-2xl shadow-lg bg-[#fbbf24]">
    <h4 class="kpi-card-title font-semibold uppercase tracking-wider text-white opacity-90">T·ª∑ l·ªá quy ƒë·ªïi</h4>
    <p class="font-bold mt-2 mb-3 text-white text-4xl">
      {formatters.formatPercentage(hieuQuaQuyDoi)}
    </p>
    <div class="text-sm text-white opacity-90">
      <p>M·ª•c ti√™u: <span class="font-bold">{formatters.formatNumber(targetTLQD)}%</span></p>
      <p class="mt-1 text-xs italic">So v·ªõi doanh thu th·ª±c</p>
    </div>
  </div>

  <div class="kpi-card p-6 rounded-2xl shadow-lg bg-[#2dd4bf]">
    <h4 class="kpi-card-title font-semibold uppercase tracking-wider text-white opacity-90">Doanh thu tr·∫£ ch·∫≠m</h4>
    <p class="font-bold mt-2 mb-3 text-white text-4xl">
      {formatters.formatNumber(doanhThuTraGop / 1000000, 1)}
    </p>
    <div class="text-sm text-white opacity-90">
      <p>% th·ª±c tr·∫£ ch·∫≠m: <span class="font-bold">{formatters.formatPercentage(tyLeTraCham)}</span></p>
      <p class="mt-1 text-xs italic">Tr√™n t·ªïng doanh thu</p>
    </div>
  </div>
</div>

<style>
  .kpi-card {
    transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
  }
  .kpi-card:hover {
    transform: translateY(-4px);
    box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
  }
</style>
--- END FILE: ./src/components/realtime/summary/KpiCards.svelte ---

--- START FILE: ./src/components/realtime/summary/QdcTable.svelte ---
<script>
  import { afterUpdate } from 'svelte';
  import { formatters } from '../../../utils/formatters.js';
  import { cleanCategoryName } from '../../../utils.js';
  import { categoryStructure, macroProductGroupConfig, selectedWarehouse } from '../../../stores.js';
  import { datasyncService } from '../../../services/datasync.service.js';

  export let items = []; 
  // Lo·∫°i b·ªè props activeConfig v√¨ ta s·∫Ω t·ª± load t·ª´ kho
  
  let isSettingsOpen = false;
  let filterSearch = '';
  let localFilter = []; 
  let saveTimer;

  // 1. Data Sources
  $: allGroupsFromStructure = [...new Set(($categoryStructure || []).map(c => cleanCategoryName(c.nhomHang)).filter(Boolean))].sort();
  $: allMacroGroups = ($macroProductGroupConfig || []).map(m => m.name);
  $: allPresentGroups = items.map(i => i.name).sort();
  $: allGroups = [...new Set([...allGroupsFromStructure, ...allMacroGroups, ...allPresentGroups])].sort();

  $: filterList = allGroups.filter(name => 
      name.toLowerCase().includes(filterSearch.toLowerCase())
  );

  // 2. Load Config
  $: if ($selectedWarehouse) {
      loadConfigForWarehouse($selectedWarehouse);
  } else {
      localFilter = [...allGroups];
  }

  async function loadConfigForWarehouse(kho) {
      console.log(`[RTQdc] Loading config for warehouse: ${kho}`);
      try {
          const savedConfig = await datasyncService.loadQdcConfig(kho);
          if (savedConfig && Array.isArray(savedConfig)) {
              localFilter = savedConfig;
          } else {
              // [QUAN TR·ªåNG] M·∫∑c ƒë·ªãnh hi·ªán t·∫•t c·∫£ n·∫øu ch∆∞a c√≥ config
              localFilter = [...allGroups];
          }
      } catch (e) {
          console.error("Error loading config:", e);
          localFilter = [...allGroups];
      }
  }

  // 3. Update & Save Config
  function toggleQdcSelection(name) {
      if (localFilter.includes(name)) {
          localFilter = localFilter.filter(n => n !== name);
      } else {
          localFilter = [...localFilter, name];
      }
      
      clearTimeout(saveTimer);
      saveTimer = setTimeout(() => {
          if ($selectedWarehouse) {
              datasyncService.saveQdcConfig($selectedWarehouse, localFilter);
          }
      }, 500);
  }

  function toggleAllVisibility(show) {
      if (show) {
          localFilter = [...allGroups];
      } else {
          localFilter = [];
      }
      if ($selectedWarehouse) {
          datasyncService.saveQdcConfig($selectedWarehouse, localFilter);
      }
  }

  // 4. Render
  $: sortedItems = (() => {
      let candidates = items.filter(item => localFilter.includes(item.name));
      return candidates.sort((a, b) => (b.dtqd || 0) - (a.dtqd || 0));
  })();

  $: maxVal = sortedItems.length > 0 ? (sortedItems[0].dtqd || 1) : 1;

  function handleWindowClick(e) {
      if (isSettingsOpen && !e.target.closest('.filter-wrapper')) {
          isSettingsOpen = false;
      }
  }

  afterUpdate(() => { if (window.feather) feather.replace(); });
</script>

<svelte:window on:click={handleWindowClick} />

<div class="luyke-widget h-full">
  <div class="luyke-widget-header">
    <div class="luyke-widget-title">
      <div class="p-1.5 bg-yellow-100 rounded text-yellow-600 mr-2">
          <i data-feather="star" class="w-4 h-4"></i>
      </div>
      <span>TOP NH√ìM H√ÄNG (REALTIME)</span>
    </div>

    <div class="relative filter-wrapper">
        <button class="luyke-icon-btn {isSettingsOpen ? 'active' : ''}" on:click={() => isSettingsOpen = !isSettingsOpen} title="Ch·ªçn nh√≥m h√†ng hi·ªÉn th·ªã">
            <i data-feather="filter" class="w-4 h-4"></i>
        </button>
         {#if isSettingsOpen}
            <div class="filter-dropdown">
                <div class="filter-header">
                     <input type="text" class="filter-search" placeholder="T√¨m nh√≥m h√†ng..." bind:value={filterSearch} />
                </div>
                <div class="filter-body custom-scrollbar" style="max-height: 250px;">
                    {#if filterList.length === 0}
                         <p class="text-xs text-gray-500 text-center p-2">Kh√¥ng t√¨m th·∫•y.</p>
                    {:else}
                        {#each filterList as name}
                            {@const isChecked = localFilter.includes(name)}
                            <div class="filter-item" on:click={() => toggleQdcSelection(name)}>
                                 <input type="checkbox" checked={isChecked} />
                                <label class="{isChecked ? 'font-bold text-blue-700' : ''}">{name}</label>
                            </div>
                        {/each}
                    {/if}
                </div>
                 <div class="filter-actions">
                    <button class="filter-btn-link" on:click={() => toggleAllVisibility(true)}>Hi·ªán t·∫•t c·∫£</button>
                    <button class="filter-btn-link text-red-600" on:click={() => toggleAllVisibility(false)}>·∫®n t·∫•t c·∫£</button>
                </div>
            </div>
        {/if}
    </div>
  </div>

  <div class="luyke-widget-body custom-scrollbar">
    {#if sortedItems.length === 0}
       <div class="flex flex-col items-center justify-center h-full text-gray-400 py-10">
           <p class="text-sm">Ch∆∞a c√≥ d·ªØ li·ªáu.</p>
           {#if items.length > 0}
             <p class="text-xs mt-1">B·∫°n ƒë√£ ·∫©n t·∫•t c·∫£.</p>
           {/if}
       </div>
    {:else}
      <div class="flex flex-col gap-0">
        {#each sortedItems as item, index (item.name)}
          {@const percent = maxVal > 0 ? (item.dtqd / maxVal) * 100 : 0}
          <div class="py-2 border-b border-dashed border-gray-100 last:border-0 hover:bg-gray-50 transition-colors px-1">
            <div class="flex items-center gap-3">
               <div class="w-6 text-center font-bold text-gray-400 text-xs">#{index + 1}</div>
               <div class="flex-grow min-w-0">
                    <div class="flex justify-between items-center mb-1">
                       <span class="text-sm font-semibold text-gray-700 truncate pr-2" title={item.name}>{item.name}</span>
                       <span class="text-sm font-bold text-blue-600 whitespace-nowrap">{formatters.formatRevenue(item.dtqd)}</span>
                   </div>
                   <div class="w-full h-1.5 bg-gray-100 rounded-full overflow-hidden mb-1">
                       <div class="h-full bg-yellow-400 rounded-full" style="width: {percent}%"></div>
                    </div>
                   <div class="flex justify-between text-[10px] text-gray-500">
                       <span>DT: <strong>{formatters.formatRevenue(item.dt || item.revenue)}</strong></span>
                       <span>SL: <strong>{formatters.formatNumber(item.sl || item.quantity)}</strong></span>
                   </div>
               </div>
            </div>
           </div>
        {/each}
      </div>
    {/if}
  </div>
</div>
--- END FILE: ./src/components/realtime/summary/QdcTable.svelte ---

--- START FILE: ./src/components/realtime/summary/SummaryTab.svelte ---
<script>
  import { 
    realtimeYCXData, 
    selectedWarehouse, 
    efficiencyConfig, 
    warehouseCustomMetrics 
  } from '../../../stores.js';
  import { reportService } from '../../../services/reportService.js';
  import { settingsService } from '../../../services/settings.service.js';
  import { formatters } from '../../../utils/formatters.js';
  import { datasyncService } from '../../../services/datasync.service.js';
  import { adminService } from '../../../services/admin.service.js';
  
  import QdcTable from './QdcTable.svelte';
  import CategoryTable from './CategoryTable.svelte';
  import EfficiencyTable from '../efficiency/EfficiencyTable.svelte';
  import { onMount } from 'svelte';

  let supermarketReport = {};
  let goals = {};
  
  let qdcItems = [];
  let categoryItems = [];
  let unexportedItems = []; 
  let rawSourceData = [];

  let combinedEfficiencyItems = [];

  onMount(async () => {
      const globalConfig = await adminService.loadEfficiencyConfig();
      efficiencyConfig.set(globalConfig);
  });

  $: if ($selectedWarehouse) {
      loadLocalMetrics($selectedWarehouse);
  }

  async function loadLocalMetrics(kho) {
      const localData = await datasyncService.loadCustomMetrics(kho);
      warehouseCustomMetrics.set(localData);
  }

  $: combinedEfficiencyItems = [
      ...($efficiencyConfig || []).map(i => ({ ...i, isSystem: true })),
      ...($warehouseCustomMetrics || []).map(i => ({ ...i, isSystem: false }))
  ];

  async function handleDeleteMetric(event) {
      const id = event.detail;
      const item = combinedEfficiencyItems.find(i => i.id === id);
      
      if (item && item.isSystem) {
          alert("ƒê√¢y l√† ch·ªâ s·ªë h·ªá th·ªëng, b·∫°n kh√¥ng th·ªÉ x√≥a. H√£y d√πng b·ªô l·ªçc ƒë·ªÉ ·∫©n n√≥ ƒëi.");
          return;
      }

      if (confirm("X√≥a ch·ªâ s·ªë c√° nh√¢n n√†y?")) {
          const newLocalMetrics = $warehouseCustomMetrics.filter(i => i.id !== id);
          warehouseCustomMetrics.set(newLocalMetrics);
          if ($selectedWarehouse) {
              await datasyncService.saveCustomMetrics($selectedWarehouse, newLocalMetrics);
          }
      }
  }

  $: {
    const currentWarehouse = $selectedWarehouse;
    const settings = settingsService.getRealtimeGoalSettings(currentWarehouse);
    goals = settings.goals || {};

    const masterReport = reportService.generateMasterReportData($realtimeYCXData, goals, true);
    
    let filteredReport = masterReport;
    let filteredRawData = $realtimeYCXData;

    if (currentWarehouse) {
      filteredReport = masterReport.filter(nv => nv.maKho == currentWarehouse);
      const visibleEmployees = new Set(filteredReport.map(nv => String(nv.maNV)));
      filteredRawData = $realtimeYCXData.filter(row => {
          const msnvMatch = String(row.nguoiTao || '').match(/(\d+)/);
          return msnvMatch && visibleEmployees.has(msnvMatch[1].trim());
      });
    }
    
    rawSourceData = filteredRawData;

    supermarketReport = reportService.aggregateReport(filteredReport, currentWarehouse);

    qdcItems = supermarketReport.nhomHangChiTiet 
        ? Object.entries(supermarketReport.nhomHangChiTiet)
            .map(([name, values]) => ({
                id: name,
                name,
                dtqd: values.revenueQuyDoi,
                sl: values.quantity,
                dt: values.revenue,
                ...values
            }))
            .filter(i => i.sl > 0 || i.dt > 0) 
        : [];

    categoryItems = supermarketReport.nganhHangChiTiet 
        ? Object.values(supermarketReport.nganhHangChiTiet).filter(i => i.revenue > 0 || i.quantity > 0)
        : [];

    unexportedItems = reportService.generateRealtimeChuaXuatReport(filteredRawData);
  }

  $: pctDTT = (parseFloat(goals?.doanhThuThuc) || 0) > 0 ? (supermarketReport.doanhThu / 1000000) / parseFloat(goals.doanhThuThuc) : 0;
  $: pctDTQD = (parseFloat(goals?.doanhThuQD) || 0) > 0 ? (supermarketReport.doanhThuQuyDoi / 1000000) / parseFloat(goals.doanhThuQD) : 0;
</script>

<div class="luyke-dashboard-container pb-10">
  
  <h2 id="realtime-supermarket-title" class="text-2xl font-bold text-gray-800 flex items-center justify-center gap-2">
    <i data-feather="zap" class="text-yellow-500 fill-current"></i>
    B√°o c√°o Realtime {$selectedWarehouse ? `- Kho ${$selectedWarehouse}` : '(To√†n b·ªô)'}
    <span class="text-sm font-normal text-gray-500 ml-2 pt-1">
      (C·∫≠p nh·∫≠t: {new Date().toLocaleTimeString('vi-VN')})
    </span>
  </h2>

  <div id="realtime-kpi-cards-container" class="kpi-grid-fixed">
      <div class="kpi-card-solid card-1">
          <div class="kpi-solid-header">Doanh Thu Th·ª±c <i data-feather="dollar-sign"></i></div>
          <div class="kpi-solid-value">{formatters.formatNumber((supermarketReport.doanhThu || 0) / 1000000, 1)}</div>
          <div class="kpi-solid-sub">
              <span>% HT: {formatters.formatPercentage(pctDTT)}</span>
              <span>MT: {formatters.formatNumber(goals?.doanhThuThuc || 0)}</span>
          </div>
          <div class="kpi-bg-icon"><i data-feather="dollar-sign"></i></div>
      </div>

      <div class="kpi-card-solid card-2">
          <div class="kpi-solid-header">DT Quy ƒê·ªïi <i data-feather="refresh-cw"></i></div>
          <div class="kpi-solid-value">{formatters.formatNumber((supermarketReport.doanhThuQuyDoi || 0) / 1000000, 1)}</div>
          <div class="kpi-solid-sub">
              <span>% HT: {formatters.formatPercentage(pctDTQD)}</span>
              <span>MT: {formatters.formatNumber(goals?.doanhThuQD || 0)}</span>
          </div>
          <div class="kpi-bg-icon"><i data-feather="refresh-cw"></i></div>
      </div>

      <div class="kpi-card-solid card-3">
          <div class="kpi-solid-header">T·ª∑ l·ªá Quy ƒê·ªïi <i data-feather="trending-up"></i></div>
          <div class="kpi-solid-value">{formatters.formatPercentage(supermarketReport.hieuQuaQuyDoi || 0)}</div>
          <div class="kpi-solid-sub">
              <span>M·ª•c ti√™u: {formatters.formatNumber(goals?.phanTramQD || 0)}%</span>
          </div>
          <div class="kpi-bg-icon"><i data-feather="trending-up"></i></div>
      </div>

      <div class="kpi-card-solid card-4">
          <div class="kpi-solid-header">Tr·∫£ Ch·∫≠m <i data-feather="credit-card"></i></div>
          <div class="kpi-solid-value">{formatters.formatPercentage(supermarketReport.tyLeTraCham || 0)}</div>
          <div class="kpi-solid-sub">
              <span>Doanh s·ªë: {formatters.formatNumber((supermarketReport.doanhThuTraGop || 0) / 1000000, 1)}</span>
          </div>
          <div class="kpi-bg-icon"><i data-feather="credit-card"></i></div>
      </div>
  </div>

  <div class="luyke-tier-1-grid">
      <EfficiencyTable 
          supermarketData={supermarketReport} 
          dynamicItems={combinedEfficiencyItems} 
          items={[]} 
          goals={goals}
          on:delete={handleDeleteMetric}
      />
      <QdcTable items={qdcItems} />
  </div>

  <div>
      <CategoryTable 
          items={categoryItems} 
          unexportedItems={unexportedItems}
          rawSource={rawSourceData}
      />
  </div>

</div>
--- END FILE: ./src/components/realtime/summary/SummaryTab.svelte ---

--- START FILE: ./src/components/realtime/summary/UnexportedTable.svelte ---
<script>
  import { formatters } from '../../../utils/formatters.js';
  import SortableTh from '../../common/SortableTh.svelte';

  export let items = [];

  // State s·∫Øp x·∫øp
  let sortKey = 'doanhThuQuyDoi';
  let sortDirection = 'desc';

  function handleSort(event) {
    const key = event.detail;
    if (sortKey === key) {
      sortDirection = sortDirection === 'desc' ? 'asc' : 'desc';
    } else {
      sortKey = key;
      sortDirection = 'desc';
    }
  }

  $: sortedItems = [...items].sort((a, b) => {
    let valA = a[sortKey] || 0;
    let valB = b[sortKey] || 0;

    if (sortKey === 'nganhHang') {
        valA = a.nganhHang || '';
        valB = b.nganhHang || '';
        return sortDirection === 'asc' ? valA.localeCompare(valB) : valB.localeCompare(valA);
    }

    return sortDirection === 'asc' ? valA - valB : valB - valA;
  });
</script>

<div class="bg-white rounded-xl shadow-md p-4 border border-gray-200 h-full flex flex-col">
  <h3 class="text-lg font-bold text-gray-700 mb-4 uppercase border-b pb-2 bg-red-50 p-2 rounded">Doanh thu ch∆∞a xu·∫•t</h3>

  {#if items.length === 0}
    <div class="flex-grow flex items-center justify-center">
       <p class="text-gray-500 font-bold p-4 text-center">Kh√¥ng c√≥ ƒë∆°n h√†ng n√†o ch∆∞a xu·∫•t trong ng√†y.</p>
    </div>
  {:else}
    <div class="overflow-x-auto flex-grow max-h-[400px]">
      <table class="min-w-full text-sm table-bordered table-striped">
        <thead class="text-xs text-slate-800 uppercase bg-slate-200 font-bold sticky top-0 z-10 shadow-sm">
          <tr>
            <SortableTh key="nganhHang" label="Ng√†nh h√†ng" {sortKey} {sortDirection} on:sort={handleSort} />
            <SortableTh key="soLuong" label="SL" align="right" {sortKey} {sortDirection} on:sort={handleSort} />
            <SortableTh key="doanhThuThuc" label="DT Th·ª±c" align="right" {sortKey} {sortDirection} on:sort={handleSort} />
            <SortableTh key="doanhThuQuyDoi" label="DTQƒê (Tr)" align="right" {sortKey} {sortDirection} on:sort={handleSort} />
          </tr>
        </thead>
        <tbody>
          {#each sortedItems as item (item.nganhHang)}
            <tr class="hover:bg-gray-50">
              <td class="px-4 py-2 font-medium">{item.nganhHang}</td>
              <td class="px-4 py-2 text-right font-bold">{formatters.formatNumber(item.soLuong)}</td>
              <td class="px-4 py-2 text-right font-bold">{formatters.formatRevenue(item.doanhThuThuc)}</td>
              <td class="px-4 py-2 text-right font-bold text-blue-600">{formatters.formatRevenue(item.doanhThuQuyDoi)}</td>
            </tr>
          {/each}
        </tbody>
      </table>
    </div>
  {/if}
</div>
--- END FILE: ./src/components/realtime/summary/UnexportedTable.svelte ---

--- START FILE: ./src/components/health-staff/summary/card/CardHeader.svelte ---
<script>
  import { formatters } from '../../../../utils/formatters.js';
  export let hoTen;
  export let maNV;
  export let boPhan;
  export let rank = 999; // [M·ªöI] Nh·∫≠n rank ƒë·ªÉ check Top 3

  // Logic m√†u t√™n: Top 3 m√†u xanh d∆∞∆°ng ƒë·∫≠m, c√≤n l·∫°i m√†u ƒëen x√°m
  $: nameColorClass = rank <= 3 ? 'text-blue-700 font-extrabold' : 'text-gray-900 font-bold';
</script>

<div class="flex-grow min-w-0 ml-3">
  <p class="{nameColorClass} text-base truncate leading-tight" title="{hoTen} - {maNV}">
    {formatters.getShortEmployeeName(hoTen, maNV)}
  </p>
  <p class="text-xs text-gray-500 truncate">{boPhan}</p>
</div>
--- END FILE: ./src/components/health-staff/summary/card/CardHeader.svelte ---

--- START FILE: ./src/components/health-staff/summary/card/CardMainKpi.svelte ---
<script>
  export let aboveCount = 0;
  export let totalCount = 0;

  $: percentage = totalCount > 0 ? aboveCount / totalCount : 0;
  $: colorClass = percentage >= 0.7 ? 'text-green-600' : percentage >= 0.4 ? 'text-yellow-500' : 'text-red-500';
  $: borderColorClass = percentage >= 0.7 ? 'border-t-green-500' : percentage >= 0.4 ? 'border-t-yellow-500' : 'border-t-red-500';
</script>

<div class="text-center py-2 border-t-4 {borderColorClass} bg-slate-50/50 mt-2">
  <div class="flex items-baseline justify-center gap-1">
    <span class="text-3xl font-extrabold {colorClass} leading-none">{aboveCount}</span>
    <span class="text-sm font-bold text-gray-400">/ {totalCount}</span>
  </div>
  <span class="text-[10px] uppercase font-bold text-gray-500 tracking-wider">Ch·ªâ s·ªë ƒë·∫°t</span>
</div>
--- END FILE: ./src/components/health-staff/summary/card/CardMainKpi.svelte ---

--- START FILE: ./src/components/health-staff/summary/card/CardSubKpiGrid.svelte ---
<script>
  export let summary; 

  // ƒê·ªãnh nghƒ©a m√†u n·ªÅn c·ªë ƒë·ªãnh cho t·ª´ng lo·∫°i th·∫ª (Style ƒë·ªìng b·ªô)
  const groups = [
    { key: 'doanhthu', label: 'Doanh Thu', icon: 'trending-up', bgClass: 'bg-blue-50 border-blue-100 text-blue-800' },
    { key: 'nangsuat', label: 'NƒÉng Su·∫•t', icon: 'dollar-sign', bgClass: 'bg-green-50 border-green-100 text-green-800' },
    { key: 'hieuqua', label: 'Hi·ªáu Qu·∫£', icon: 'award', bgClass: 'bg-orange-50 border-orange-100 text-orange-800' },
    { key: 'dongia', label: 'ƒê∆°n Gi√°', icon: 'tag', bgClass: 'bg-purple-50 border-purple-100 text-purple-800' }
  ];
</script>

<div class="grid grid-cols-2 gap-2 px-3 pb-3 pt-1 border-t border-gray-100">
  {#each groups as g}
    {@const data = summary[g.key]}
    {@const ratio = data.total > 0 ? data.above / data.total : 0}
    
    {@const valueColor = ratio > 0.5 ? 'text-blue-600' : 'text-red-600'}
    
    <div class="flex items-center justify-between p-1.5 rounded border {g.bgClass}">
      <div class="flex items-center gap-1">
        <i data-feather={g.icon} class="w-3 h-3 opacity-70"></i>
        <span class="text-[10px] font-bold uppercase opacity-90">{g.label}</span>
      </div>
      <span class="text-xs font-extrabold {valueColor}">{data.above}/{data.total}</span>
    </div>
  {/each}
</div>
--- END FILE: ./src/components/health-staff/summary/card/CardSubKpiGrid.svelte ---

--- START FILE: ./src/components/health-staff/summary/card/EmployeeCard.svelte ---
<script>
  import MedalIcon from '../../shared/MedalIcon.svelte';
  import CardHeader from './CardHeader.svelte';
  import CardMainKpi from './CardMainKpi.svelte';
  import CardSubKpiGrid from './CardSubKpiGrid.svelte';
  import { createEventDispatcher } from 'svelte';

  export let employee;
  export let rank; // 1, 2, 3...

  const dispatch = createEventDispatcher();
  
  $: summary = employee.summary;
  $: totalAbove = employee.totalAbove;
  $: totalCriteria = employee.totalCriteria;

  function handleClick() {
    dispatch('click', { employeeId: employee.maNV });
  }
</script>

<div 
  class="bg-white rounded-xl border border-gray-200 shadow-sm hover:shadow-md hover:-translate-y-1 transition-all cursor-pointer overflow-hidden relative group"
  on:click={handleClick}
  role="button"
  tabindex="0"
>
  <div class="p-3 flex items-start relative z-10">
    <MedalIcon {rank} />
    <CardHeader hoTen={employee.hoTen} maNV={employee.maNV} boPhan={employee.boPhan} {rank} />
  </div>

  <CardMainKpi aboveCount={totalAbove} totalCount={totalCriteria} />
  <CardSubKpiGrid {summary} />
</div>
--- END FILE: ./src/components/health-staff/summary/card/EmployeeCard.svelte ---

