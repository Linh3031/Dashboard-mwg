CONTEXT GROUP: SNAP_00_CORE.txt
GENERATED AT: 1/3/2026, 2:59:56 PM


>>> FILE_START: src/stores.js
// src/stores.js
import { writable } from 'svelte/store';

// QUAN TRỌNG: Phải có chữ 'export' ở đầu dòng này
export const currentCluster = writable(null);
export const activeTab = writable('data-section');
export const isAdmin = writable(false); 
export const currentUser = writable(null);
export const feedbackList = writable([]);
export const userStats = writable([]); 
export const helpContent = writable({ data: '...', luyke: '...', sknv: '...', realtime: '...' });
export const composerTemplates = writable({ luyke: '', sknv: '', realtime: '' });
export const competitionNameMappings = writable({}); 
export const homeConfig = writable({ videoUrl: '', timeline: [], sliderImages: [], changelogs: [] });
export const danhSachNhanVien = writable([]);
export const ycxData = writable([]);
export const rawGioCongData = writable([]);
export const thuongNongData = writable([]);
export const thuongERPData = writable([]);
export const pastedThiDuaReportData = writable([]);
export const realtimeYCXData = writable([]);
export const thiDuaVungChiTiet = writable([]);
export const thiDuaVungTong = writable([]);
export const ycxDataThangTruoc = writable([]);
export const thuongNongDataThangTruoc = writable([]);
export const thuongERPDataThangTruoc = writable([]);
export const masterReportData = writable({ luyke: [], sknv: [], realtime: [] });
export const competitionData = writable([]);
export const declarations = writable({ hinhThucXuat: '', hinhThucXuatGop: '', heSoQuyDoi: '' });
export const categoryStructure = writable([]); 
export const brandList = writable([]); 
export const specialProductList = writable([]);
export const macroCategoryConfig = writable([]); 
export const macroProductGroupConfig = writable([]); 
export const categoryNameMapping = writable({}); 
export const groupNameMapping = writable({});
export const brandNameMapping = writable({}); 
export const localCompetitionConfigs = writable([]); 
export const globalCompetitionConfigs = writable([]); 
export const globalSpecialPrograms = writable([]); 
export const efficiencyConfig = writable([]); 
export const qdcConfigStore = writable([]);
export const warehouseCustomMetrics = writable([]);
export const customRevenueTables = writable([]);
export const customPerformanceTables = writable([]);

// --- [LOGGING SECTION] QUẢN LÝ MỤC TIÊU (KPI) ---
let savedKpi = null;
if (typeof localStorage !== 'undefined') {
    const raw = localStorage.getItem('kpiStore_cache');
    console.log(`[STORE ${new Date().toLocaleTimeString()}] Raw LocalStorage:`, raw);
    savedKpi = raw ? JSON.parse(raw) : null;
}

export const kpiStore = writable(savedKpi || {
    targets: {}, 
    globalSettings: {} 
});

kpiStore.subscribe(value => {
    // console.log('[STORE] KPI Update:', value); // Uncomment nếu muốn log chi tiết thay đổi
    if (typeof localStorage !== 'undefined') {
        localStorage.setItem('kpiStore_cache', JSON.stringify(value));
    }
});
// -----------------------------------------------------

export const luykeGoalSettings = writable({});
export const realtimeGoalSettings = writable({});
export const highlightSettings = writable({ luyke: {}, sknv: {}, realtime: {} });
export const debugInfo = writable({});
export const employeeMaNVMap = writable(new Map());
export const employeeNameToMaNVMap = writable(new Map());
export const charts = writable({});
export const choices = writable({
    luyke_employee: null, luyke_date_picker: null, luyke_highlight_nhanhang: null, luyke_highlight_nhomhang: null, luyke_highlight_employee: null,
    sknv_employee: null, sknv_date_picker: null, sknv_highlight_nhanhang: null, sknv_highlight_nhomhang: null, sknv_highlight_employee: null,
    realtime_employee: null, realtime_highlight_nhanhang: null, realtime_highlight_nhomhang: null, realtime_highlight_employee: null,
    thiDuaVung_sieuThi: null,
    competition_group: null,
    competition_brand: null,
    special_program_group: null, 
    thidua_employee_detail: null,
    realtime_brand_category_filter: null,
    realtime_brand_filter: null,
});
export const viewingDetailFor = writable(null);
export const sortState = writable({});
export const warehouseList = writable([]);
export const selectedWarehouse = writable(null);
export const drawerState = writable({ activeDrawer: null });
export const modalState = writable({ activeModal: null });
export const notificationStore = writable({ message: '', type: 'info', visible: false });
export const interfaceSettings = writable({
    contrastLevel: '3', globalFontSize: '18', kpiFontSize: '36',
    kpiCard1Bg: '#38bdf8', kpiCard2Bg: '#34d399', kpiCard3Bg: '#fbbf24',
    kpiCard4Bg: '#2dd4bf', kpiCard5Bg: '#a78bfa', kpiCard6Bg: '#f472b6',
    kpiCard7Bg: '#818cf8', kpiCard8Bg: '#f87171',
    kpiTitleColor: '#ffffff', kpiMainColor: '#ffffff', kpiSubColor: '#ffffff'
});
export const firebaseStore = writable({ app: null, auth: null, db: null, storage: null });
export const fileSyncState = writable({});
<<< FILE_END: src/stores.js

>>> FILE_START: src/main.js
// src/main.js
// Version 5.1 - Fix Crash & Feather Fallback
import './app.css'
import App from './App.svelte'
import { mount } from 'svelte'
import { firebaseService } from './services/firebase.service.js';
import feather from 'feather-icons';
import './services/employeeService.js'; 
import { authService as auth } from './services/auth.service.js'; 
import { dataService } from './services/dataService.js'; 
import { analyticsService } from './services/analytics.service.js';

async function initializeApp() {
  try {
    // 1. Khởi tạo Firebase
    firebaseService.initCore();
    
    // 2. Setup Feather Icons (Global)
    window.feather = feather;

    // 3. Mount App
    mount(App, {
        target: document.getElementById('app'),
    });

    // [FIX] Gọi replace ngay sau khi mount để đảm bảo icon lần đầu
    setTimeout(() => {
        if (window.feather) window.feather.replace();
    }, 100);

    // 4. Bắt đầu luồng dữ liệu
    startDataFlow();

  } catch (e) {
    console.error("Lỗi khởi tạo:", e);
    // [FIX] Fallback nếu crash: Ít nhất cũng hiển thị thông báo lỗi đẹp
    document.getElementById('app').innerHTML = `<div style="padding: 20px; color: red;"><h3>Hệ thống gặp sự cố khởi động.</h3><p>${e.message}</p><button onclick="location.reload()">Tải lại trang</button></div>`;
  }
}

async function startDataFlow() {
    try {
        await auth.ensureAnonymousAuth();
        const isLoggedIn = auth.initAuth();
        
        if (isLoggedIn) {
            console.log("[Main] User logged in. Starting data load sequence...");
            await dataService.loadAllFromCache();
            
            const email = localStorage.getItem('userEmail');
            if(email) analyticsService.upsertUserRecord(email);
        } else {
            console.log("[Main] User not logged in (waiting for LoginModal). Data load deferred.");
        }

    } catch (e) {
        console.error("Lỗi luồng dữ liệu:", e);
    }
}

initializeApp();
<<< FILE_END: src/main.js

>>> FILE_START: src/App.svelte
<script>
  import { onMount, afterUpdate } from 'svelte';
  
  import { 
      activeTab, 
      modalState, 
      efficiencyConfig, 
      customRevenueTables, 
      customPerformanceTables,
      isAdmin, 
      warehouseCustomMetrics,
      selectedWarehouse,
      // [FIX] Thêm import store dữ liệu để xử lý bộ lọc kho
      danhSachNhanVien,
      warehouseList
  } from './stores.js';
  import { get } from 'svelte/store';
  import { authService } from './services/auth.service.js';
  import { adminService } from './services/admin.service.js';
  import { datasyncService } from './services/datasync.service.js';

  // --- COMPONENTS CHÍNH ---
  import Sidebar from './components/Sidebar.svelte';
  import HomeSection from './components/HomeSection.svelte';
  import DataSection from './components/DataSection.svelte';
  import HealthSection from './components/HealthSection.svelte';
  import HealthEmployeeSection from './components/HealthEmployeeSection.svelte';
  import RealtimeSection from './components/realtime/RealtimeSection.svelte';
  import DeclarationSection from './components/DeclarationSection.svelte';
  // --- COMMON UI ---
  import GlobalNotification from './components/common/GlobalNotification.svelte';
  // [MỚI] Import trình quản lý phiên bản
  import VersionManager from './components/common/VersionManager.svelte';
  // --- DRAWERS ---
  import InterfaceDrawer from './components/drawers/InterfaceDrawer.svelte';
  import GoalDrawer from './components/drawers/GoalDrawer.svelte';
  // --- MODALS ---
  import AdminModal from './components/modals/AdminModal.svelte';
  import LoginModal from './components/modals/LoginModal.svelte';
  import UserCompetitionModal from './components/modals/UserCompetitionModal.svelte';
  import UserSpecialProgramModal from './components/modals/UserSpecialProgramModal.svelte';
  import ComposerModal from './components/modals/ComposerModal.svelte';
  import AddEfficiencyColumnModal from './components/modals/AddEfficiencyColumnModal.svelte';
  import AddRevenueTableModal from './components/modals/AddRevenueTableModal.svelte';
  import AddPerformanceTableModal from './components/modals/AddPerformanceTableModal.svelte';
  // [FIX] Import 2 Modal chi tiết còn thiếu
  import UnexportedDetailModal from './components/modals/UnexportedDetailModal.svelte';
  import CustomerDetailModal from './components/modals/CustomerDetailModal.svelte';

  onMount(async () => {
    try { await authService.ensureAnonymousAuth(); } catch (e) { console.error("Firebase Auth Error:", e); }
    const isLoggedIn = authService.initAuth();
    if (!isLoggedIn) modalState.update(s => ({ ...s, activeModal: 'login-modal' }));
    
    // [FIX CRITICAL] Tải toàn bộ cấu hình hệ thống (Quy đổi, Ngành hàng) cho TẤT CẢ user
    // Điều này đảm bảo user thường cũng nhận được logic tính toán mới nhất
    await loadGlobalSystemConfig();

    // Load bảng hiệu quả khi khởi động
    loadInitialTables();
  });

  // [FIX] Hàm tải cấu hình hệ thống dùng chung
  async function loadGlobalSystemConfig() {
      try {
          console.log("[App] Đang tải cấu hình hệ thống...");
          await Promise.all([
              adminService.loadCategoryDataFromFirestore(), // Cấu trúc ngành hàng (Mới thêm)
              adminService.loadEfficiencyConfig(),          // Hệ số quy đổi & Hiệu quả
              adminService.loadSpecialProductList(),        // Sản phẩm đặc quyền
              adminService.loadHomeConfig()                 // Cấu hình trang chủ
          ]);
          console.log("[App] Đã đồng bộ cấu hình hệ thống thành công.");
      } catch (error) {
          console.error("[App] Lỗi tải cấu hình hệ thống:", error);
      }
  }

  async function loadInitialTables() {
     const sysTables = await adminService.loadSystemPerformanceTables();
     customPerformanceTables.set(sysTables);
  }

  afterUpdate(() => {
    if (window.feather) window.feather.replace();
  });
  function handleSaveEffConfig(event) {
      const newItem = { ...event.detail };
      if ($activeTab === 'declaration-section') {
          newItem.isSystem = true;
          efficiencyConfig.update(items => {
              const idx = items.findIndex(i => i.id === newItem.id);
              if (idx >= 0) { items[idx] = newItem; return [...items]; } 
              else { return [...items, newItem]; }
          });
          adminService.saveEfficiencyConfig(get(efficiencyConfig));
      } 
      else {
          newItem.isSystem = false;
          let currentLocal = get(warehouseCustomMetrics) || [];
          const idx = currentLocal.findIndex(i => i.id === newItem.id);
          if (idx >= 0) {
              currentLocal[idx] = newItem;
          } else {
              currentLocal = [...currentLocal, newItem];
          }
          warehouseCustomMetrics.set(currentLocal);
          const wh = get(selectedWarehouse);
          if(wh) {
               datasyncService.saveCustomMetrics(wh, currentLocal);
          } else {
              alert("Vui lòng chọn Kho để lưu chỉ số này.");
          }
      }
  }

  async function handleSaveCustomTable(event) {
      const newItem = event.detail;
      customRevenueTables.update(items => {
          const idx = items.findIndex(i => i.id === newItem.id);
          if (idx >= 0) { 
              items[idx] = { ...items[idx], ...newItem }; 
              return [...items]; 
          } else { 
              return [...items, newItem]; 
          }
      });
      if (newItem.isSystem) {
          const currentSystemTables = get(customRevenueTables).filter(t => t.isSystem);
          await adminService.saveSystemRevenueTables(currentSystemTables);
          console.log("Đã lưu bảng hệ thống lên Admin Cloud");
      } else {
          const currentPersonalTables = get(customRevenueTables).filter(t => !t.isSystem);
          localStorage.setItem('customRevenueTables', JSON.stringify(currentPersonalTables));
          const wh = get(selectedWarehouse);
          if (wh) {
              await datasyncService.savePersonalRevenueTables(wh, currentPersonalTables);
          }
          console.log("Đã lưu bảng cá nhân");
      }
  }

  async function handleSavePerformanceTable(event) {
      const newItem = event.detail;
      customPerformanceTables.update(items => {
          const idx = items.findIndex(i => i.id === newItem.id);
          if (idx >= 0) {
              items[idx] = { ...items[idx], ...newItem };
              return [...items];
          } else {
             return [...items, newItem];
          }
      });
      if (newItem.isSystem) {
          const systemTables = get(customPerformanceTables).filter(t => t.isSystem);
          await adminService.saveSystemPerformanceTables(systemTables);
      } else {
          const personalTables = get(customPerformanceTables).filter(t => !t.isSystem);
          const wh = get(selectedWarehouse);
          if (wh) {
              await datasyncService.savePersonalPerformanceTables(wh, personalTables);
          } else {
              alert("Vui lòng chọn Kho để lưu bảng cá nhân.");
          }
      }
  }

  // Hàm đóng modal chung
  const closeModal = () => modalState.update(s => ({ ...s, activeModal: null, payload: null }));
  // [FIX] Logic tự động cập nhật danh sách kho khi có dữ liệu nhân viên
  $: {
      if ($danhSachNhanVien && $danhSachNhanVien.length > 0) {
          // Lọc danh sách mã kho duy nhất
          const uniqueWarehouses = [...new Set($danhSachNhanVien
              .map(nv => nv.maKho)
              .filter(k => k && String(k).trim() !== '')
          )].sort();
          
          warehouseList.set(uniqueWarehouses);
          // console.log("[App] Warehouse list updated:", uniqueWarehouses);
      }
  }
</script>

<GlobalNotification />
<VersionManager />

<InterfaceDrawer />
<GoalDrawer />

<AdminModal />
<LoginModal />
<UserCompetitionModal />
<UserSpecialProgramModal />
<ComposerModal /> 

{#if $modalState.activeModal === 'unexported-detail-modal'}
    <UnexportedDetailModal 
        unexportedDetails={$modalState.payload?.unexportedDetails || []}
        on:close={closeModal}
    />
{/if}

{#if $modalState.activeModal === 'customer-detail-modal'}
    <CustomerDetailModal 
        customers={$modalState.payload?.customers || []}
        mucTieu={$modalState.payload?.mucTieu || {}}
        on:close={closeModal}
    />
{/if}

<AddRevenueTableModal 
    isOpen={$modalState.activeModal === 'add-revenue-table-modal'} 
    editItem={$modalState.payload}
    on:close={closeModal}
    on:save={handleSaveCustomTable}
/>

<AddPerformanceTableModal
    isOpen={$modalState.activeModal === 'add-performance-table-modal'}
    editItem={$modalState.payload}
    isSystem={$modalState.isSystem || false}
    on:close={closeModal}
    on:save={handleSavePerformanceTable}
/>

<AddEfficiencyColumnModal 
    isOpen={$modalState.activeModal === 'add-efficiency-modal'} 
    editItem={$modalState.payload}
    isAdmin={$activeTab === 'declaration-section'}
    on:close={closeModal}
    on:save={handleSaveEffConfig}
/>

<div class="flex min-h-screen">
  <div id="sidebar-container">
    <Sidebar />
  </div>

  <main id="main-content">
    <div class="flex-1 p-6">
      <div class="max-w-full mx-auto">
        <HomeSection activeTab={$activeTab} />
        <DataSection activeTab={$activeTab} />
        <HealthSection activeTab={$activeTab} />
        <HealthEmployeeSection activeTab={$activeTab} />
        <RealtimeSection activeTab={$activeTab} />
        <DeclarationSection activeTab={$activeTab} />
      </div>
    </div>
  </main>
</div> 

<div id="modal-force-update-container"></div>
<div id="modal-help-container"></div>
<div id="modal-chart-container"></div>
<div id="modal-preview-container"></div>
<div id="modal-selection-container"></div>
<div id="modal-customer-detail-container"></div>
<div id="modal-unexported-detail-container"></div>

<style>
  :global(#main-content) { 
    transition: margin-left 0.3s ease-in-out;
    margin-left: 68px; 
    min-width: 0;
    display: flex;
    flex-direction: column;
    flex: 1 1 0%;
  }

  :global(.page-header) { 
    display: flex; 
    flex-wrap: wrap; 
    justify-content: space-between; 
    align-items: center; 
    gap: 1rem; 
    margin-bottom: 1.5rem;
  }

  :global(.page-header__title) { 
    font-size: 1.75rem; 
    font-weight: 700; 
    color: #1f2937;
  }
</style>
<<< FILE_END: src/App.svelte

>>> FILE_START: src/config.js
// src/config.js
// Version 2.3 - Update Admin Password
// Chứa tất cả các cấu hình tĩnh của ứng dụng.

export const config = {
    ADMIN_PASSWORD: "Linh3010", // [UPDATED] Mật khẩu mới
    COLUMN_MAPPINGS: {
        danhsachnv: {
            maKho: { required: true, displayName: 'Mã Kho', aliases: ['mã kho', 'makho', 'kho'] },
            maNV: { required: true, displayName: 'Mã Nhân Viên', aliases: ['mã nv', 'msnv', 'mã nhân viên', 'manv', 'mã số nhân viên'] },
            hoTen: { required: true, displayName: 'Họ và Tên', aliases: ['họ và tên', 'tên nhân viên', 'tên nv', 'họ tên'] },
            boPhan: { required: true, displayName: 'Bộ phận', aliases: ['bộ phận'] }
        },
        ycx: {
            ngayTao: { required: true, displayName: 'Ngày tạo', aliases: ['ngày tạo'] },
            ngayHenGiao: { required: false, displayName: 'Ngày hẹn giao', aliases: ['ngày hẹn giao'] },
            nguoiTao: { required: true, displayName: 'Người tạo', aliases: ['người tạo'] },
            thanhTien: { required: true, displayName: 'Giá bán', aliases: ['giá bán_1', 'giá bán'] },
            soLuong: { required: true, displayName: 'Số lượng', aliases: ['sl bán', 'số lượng'] },
            nhomHang: { required: true, displayName: 'Nhóm hàng', aliases: ['nhóm hàng'] },
            tenSanPham: { required: true, displayName: 'Tên sản phẩm', aliases: ['tên sản phẩm'] },
            maSanPham: { required: true, displayName: 'Mã sản phẩm', aliases: ['mã sản phẩm', 'masanpham', 'mã sp', 'product code'] },
            tenKhachHang: { required: true, displayName: 'Tên khách hàng', aliases: ['tên khách hàng', 'tenkhachhang'] },
            nhaSanXuat: { required: true, displayName: 'Nhà sản xuất', aliases: ['nhà sản xuất', 'nhasanxuat'] },
            nganhHang: { required: true, displayName: 'Ngành hàng', aliases: ['ngành hàng'] },
            hinhThucXuat: { required: true, displayName: 'Hình thức xuất', aliases: ['hình thức xuất'] },
            trangThaiThuTien: { required: true, displayName: 'Trạng thái thu tiền', aliases: ['trạng thái thu tiền'] },
            trangThaiHuy: { required: true, displayName: 'Trạng thái hủy', aliases: ['trạng thái hủy'] },
            tinhTrangTra: { required: true, displayName: 'Tình trạng trả', aliases: ['tình trạng nhập trả của sản phẩm đổi với sản phẩm chính', 'tình trạng trả'] },
            trangThaiXuat: { required: true, displayName: 'Trạng thái xuất', aliases: ['trạng thái xuất'] }
        },
        giocong: {
            maNV: { required: false, displayName: 'Mã NV', aliases: ['mã nv', 'msnv'] },
            hoTen: { required: false, displayName: 'Tên NV', aliases: ['tên nv', 'tennv'] },
            tongGioCong: { required: true, displayName: 'Tổng giờ công', aliases: ['tổng giờ công (x.nhận) total', 'tổng giờ công'] }
        },
        thuongnong: {
            maNV: { required: false, displayName: 'Mã NV', aliases: ['manv', 'mã nv'] },
            hoTen: { required: false, displayName: 'Tên NV', aliases: ['tennv', 'tên nv'] },
            diemThuong: { required: true, displayName: 'Điểm thưởng', aliases: ['diemthuong', 'điểm thưởng'] }
        }
    },
    PRODUCT_GROUPS: {
        ICT: ['1491', '931', '42'],
        CE: ['1097', '1098', '1099', '1094', '894'],
        PHU_KIEN: ['16', '1394', '184', '764'],
        GIA_DUNG: ['484', '1214'],
        MAY_LOC_NUOC: ['4171', '4172'],
        PIN_SDP: '12',
        CAMERA_TRONG_NHA: '6479',
        CAMERA_NGOAI_TROi: '4219',
        TAI_NGHE_BLT: '4540',
        NOI_CHIEN: '4099',
        ROBOT_HB: '4439',
        TIVI: '1094',
        TU_LANH: '1097',
        MAY_GIAT: '1099',
        MAY_LANH: '1098',
        DIEN_THOAI: ['13', '1491', '18'],
        LAPTOP: '42',
        SIM: ['1891', '664'],
        VAS: ['164', '571'],
        BAO_HIEM_VAS: ['4479', '4499'],
        SMARTPHONE: ['1491', '18', '13'],
        BAO_HIEM_DENOMINATOR: ['1491', '1097', '894', '1099', '1098', '42', '1094', '3859', '911', '893', '3659'],
        QDC_GROUPS: {
            PIN_SDP: { codes: ['12'], name: 'Pin SDP' },
            TAI_NGHE_BLT: { codes: ['3346', '4540'], name: 'Tai nghe BLT' },
            DONG_HO: { codes: ['4059', '4060', '4061', '4062', '4063', '4064', '4070'], name: 'Đồng hồ' },
            CAMERA: { codes: ['4219', '6479'], name: 'Camera' },
            LOA: { codes: ['1031', '1351', '4779'], name: 'Loa' },
            UDDD: { codes: ['571', '611'], name: 'UDDĐ' },
            BAO_HIEM: { codes: ['4479', '4499'], name: 'Bảo hiểm' },
            NOI_COM: { codes: ['4157', '4158'], name: 'Nồi cơm điện tử + cao tần' },
            NOI_CHIEN: { codes: ['4099'], name: 'Nồi chiên' },
            MAY_LOC_NUOC: { codes: ['4171', '4172'], name: 'Máy lọc nước' },
            ROBOT_HB: { codes: ['4439'], name: 'Robot hút bụi' },
            SIM_ONLINE: { codes: ['1891'], name: 'SIM' }
        }
    },
    DEPARTMENT_GROUPS: [
        'BP Tư Vấn - ĐM',
        'BP Trang Trí kiêm Thu ngân - Sim Số - ĐM',
        'BP Kho Kiêm Hỗ Trợ Kỹ Thuật Xe Đạp - ĐM'
    ],
    DEFAULT_DATA: {
        HINH_THUC_XUAT_TINH_DOANH_THU: [
            'Xuất bán hàng tại siêu thị', 'Xuất cung ứng dịch vụ',
            'Xuất bán pre-order tại siêu thị', 'Xuất SIM trắng kèm theo SIM',
            'Xuất bán hàng ưu đãi cho nhân viên', 'Xuất bán hàng tại siêu thị (TCĐM)',
            'Xuất dịch vụ bảo hành trọn đời', 'Xuất dịch vụ bảo dưỡng trọn đời',
            'Xuất bán hàng trả góp tại siêu thị', 'Xuất bán trả góp ưu đãi cho nhân viên',
            'Xuất bán trả góp cho NV phục vụ công việc', 'Xuất bán pre-order trả góp tại siêu thị',
            'Xuất bán pre-order trả góp tại siêu thị (TCĐM)',
            'Xuất dịch vụ thu hộ bảo hiểm'
        ],
        HINH_THUC_XUAT_TRA_GOP: ['Xuất bán hàng trả góp tại siêu thị', 'Xuất bán trả góp ưu đãi cho nhân viên', 'Xuất bán trả góp cho NV phục vụ công việc', 'Xuất bán pre-order trả góp tại siêu thị', 'Xuất bán pre-order trả góp tại siêu thị (TCĐM)'],
        HE_SO_QUY_DOI: { '1098 - Máy lạnh (IMEI)': 1,'4659 - Phụ kiện tiện ích Apple': 3.37,'6400 - Phụ kiện âm thanh Apple': 3.37,'2381 - Phụ kiện trang trí Apple': 3.37,'2011 - Khuyến mãi - SP Ảo': 1, '2511 - Nạp tiền AirTime M_Service': 1, '2151 - Phiếu mua hàng/Pre Order': 1, '971 - Thẻ cào điện tử': 1, '431 - Ốp Lưng - Flip Cover': 3.37, '2571 - Thu hộ cước Viettel': 1, '4519 - Thu Hộ Tiền Trả Góp': 1, '2513 - Thu hộ Payoo': 1, '4302 - Nón bảo hiểm các loại': 1.92, '2291 - Sim trắng (Seri)': 1, '18 - Điện Thoại Di Động': 1, '4599 - Thu Hộ Tiền Mặt': 1, '12 - Pin sạc dự phòng': 3.37, '571 - UDDĐ': 1, '58 - Miếng dán mặt sau': 3.37, '1231 - Miếng dán mặt trước': 3.37, '1491 - Smartphone': 1, '1891 - Sim Online': 5.45, '4479 - Dịch Vụ Bảo Hiểm': 4.18, '3359 - Phụ kiện đồng hồ': 3, '2391 - Smartwatch': 3, '911 - Máy nước nóng': 1, '4499 - Thu Hộ Phí Bảo Hiểm': 4.18, '4142 - Bình đun siêu tốc': 1.85, '4153 - Xay Sinh tố': 1.85, '15 - Tai nghe dây': 3.37, '1412 - Dịch vụ bảo trì': 1, '3345 - Cáp': 3.37, '2312 - Mã nạp thẻ game': 1, '4900 - Bàn phím': 3.37, '4141 - Bàn ủi khô': 1.85, '4156 - Nồi cơm nắp gài/nắp rời': 1.85, '14 - Sạc/ Adapter': 3.37, '42 - Laptop': 1.2, '751 - Khuyến mãi ba lô, túi xách': 1, '1031 - Loa di động': 3.37, '4199 - Miếng Dán Kính': 3.37, '3346 - Tai Nghe Bluetooth': 3.37, '931 - Máy tính bảng': 1.2, '19 - Khuyến mãi ĐTDĐ': 1, '10 - Chuột': 3.37, '4060 - Đồng hồ Nam Dây da': 3, '880 - Loa Karaoke': 1.29, '851 - Khuyến mãi Điện Tử': 1, '4169 - Lõi lọc': 1.85, '4540 - Tai Nghe Bluetooth - imei': 3.37, '4062 - Đồng hồ Nữ Dây kim loại': 3, '2831 - Phụ kiện Apple': 3.37, '2691 - Bộ Sạc/Cáp/Adaptor (Giá Rẻ)': 3.37, '1351 - Loa vi tính (imei)': 3.37, '1094 - Tivi LED (IMEI)': 1, '4324 - Khung treo, giá đỡ': 3.37, '1099 - Máy giặt (IMEI)': 1, '1097 - Tủ lạnh (IMEI)': 1, '4099 - Nồi chiên': 1.85, '4070 - Đồng hồ Trẻ em': 3, '967 - Sấy tóc': 1.85, '957 - Lò nướng': 1.85, '958 - Lò vi sóng': 1.85, '4158 - Nồi cơm điện tử': 1.85, '3241 - Dao/Kéo/Thớt': 1.92, '3240 - Hộp/Hũ': 1.92, '3265 - Nồi': 1.92, '4139 - Đèn bàn/Đèn Sạc/Đèn bắt muỗi': 1.85, '73 - Phụ kiện điện máy': 3.37, '4171 - Lọc nước dạng tủ đứng': 1.85, '3384 - Đồ nghề sử dụng điện': 1, '4147 - Bếp điện đơn': 1.85, '4063 - Đồng hồ Nữ Dây da': 3, '3263 - Chảo': 1.92, '3185 - Vệ sinh nhà cửa': 1.92, '4143 - Bàn ủi hơi nước đứng': 1.85, '4146 - Bếp gas đôi': 1.85, '1052 - Khuyến mãi Điện Lạnh': 1, '3799 - Quạt điều hòa': 1.85, '1951 - Software (số Lượng)': 1, '6000 - Máy ép trái cây': 1.85, '4059 - Đồng hồ Nam Dây kim loại': 3, '4160 - Quạt bàn/hộp/sạc': 1.85, '4162 - Bình/Ca đựng nước': 1.92, '4660 - Quạt lửng': 1.85, '17 - Phụ kiện IT khác': 3.37, '4145 - Bếp gas đơn': 1.85, '875 - Dàn máy': 1, '1071 - Phụ kiện điện tử': 3.37, '891 - Micro': 1, '4152 - Ổ cắm điện/vợt muỗi': 1.85, '4154 - Xay ép/Khác': 1.85, '5975 - Balo Túi Chống Sốc': 3.37, '893 - Tủ đông': 1, '2531 - Thu hộ Mservice': 1, '4019 - Sim trắng điện tử': 1, '4320 - Đồng hồ - Khuyến mãi mua': 1, '3187 - Bình/Ly/Ca giữ nhiệt': 1.92, '4159 - Quạt đứng': 1.85, '4157 - Nồi cơm cao tần': 1.85, '16 - Thẻ Nhớ': 3.37, '4140 - Bàn ủi hơi nước': 1.85, '4150 - Máy nước nóng lạnh': 1.85, '591 - Thay sim': 1, '2999 - Dụng cụ nhà bếp khác': 1.92, '4779 - Loa di động - imei': 3.37, '4440 - Gói Cước Và Dịch Vụ GTGT': 1, '4121 - Máy Bơm Nước': 1, '4161 - Quạt treo': 1.85, '4961 - Quần bó & legging nữ Thể Thao': 1, '4151 - Áp suất/lẩu/chiên/nướng': 1.85, '4144 - Bếp gas âm': 1.85, '871 - USB': 3.37, '6479 - Camera IP Trong nhà': 3.37, '4219 - Camera IP Ngoài trời': 3.37, '4659 - Phụ kiện tiện ích Apple': 3.37, '531 - Pin, 4095 - Cáp (Giá Rẻ)': 3.37, '2791 - Kinh doanh mùa vụ': 3.37, '2771 - Giá treo màn hình máy tính': 3.37, '80 - Khuyến mãi Khác': 1, '1131 - Máy in, Fax': 2, '4125 - Smartband': 3, '743 - Quạt sưởi': 1.85, '4659 - Phụ kiện Apple - Imei': 3.37, '4064 - Đồng hồ Nữ Dây khác': 3, '956 - Hút bụi': 1.85, '4172 - Lọc nước âm tủ/trên bàn': 1.85, '3779 - Bếp điện âm': 1.85, '4061 - Đồng hồ Nam Dây khác': 3, '4067 - Đồng hồ Unisex Dây khác': 3, '1411 - Dịch vụ lắp đặt': 1, '4149 - Bình thủy điện': 1.85, '4148 - Bếp điện đôi': 1.85, '955 - Hút mùi/ hút khói': 1.85, '4699 - Gia dụng không điện khác': 1.92, '4859 - Xe đạp đường phố cổ điển': 1, '4759 - Phụ Kiện Xe Đạp': 1, '2471 - Thu hộ cước VinaPhone': 1, '3719 - Quần dài nữ Thể Thao': 1, '1051 - Khuyến mãi Điện gia dụng': 1, '3721 - Quần ngắn & váy nữ Thể Thao': 1, '410 - Phụ kiện TT khác': 3.37, '4155 - Hút bụi cây': 1.85, '3563 - Máy tính nguyên bộ': 1, '894 - Tủ mát': 1, '3639 - Máy lọc không khí': 1.85, '611 - Ứng dụng PC & Laptop': 1, '4089 - Đồng hồ Unisex Dây kim loại': 3, '4439 - Hút Bụi Robot': 1.85, '3740 - Áo T-shirt nam Thể Thao': 1, '4339 - Ổn Áp': 1, '4459 - Quạt Trần': 1.85, '2351 - Router - Imei': 3.37, '3159 - DV Internet và Truyền hình thu tiền': 1, '3659 - Máy sấy lồng ngang': 1, '3519 - Áo Bra Thể Thao': 1, '3479 - Thiết bị mạng khác': 3.37, '3859 - Máy rửa chén': 1 }
    }
};


<<< FILE_END: src/config.js

>>> FILE_START: src/services/action.service.js
import { get } from 'svelte/store';
import { viewingDetailFor } from '../stores.js';
import { captureService } from './capture.service.js';
import { excelService } from './excel.service.js';

export const actionService = {
    // Helper: Xác định tab đang active và container chứa nội dung
    _getActiveTabInfo(sectionId) {
        const navIdMap = {
            'luyke': 'luyke-subtabs-nav',
            'sknv': 'employee-subtabs-nav',
            'realtime': 'realtime-subtabs-nav'
        };
        const contentIdMap = {
            'luyke': 'luyke-subtabs-content',
            'sknv': 'employee-subtabs-content',
            'realtime': 'realtime-subtabs-content'
        };

        const navId = navIdMap[sectionId];
        const contentContainerId = contentIdMap[sectionId];

        if (!navId || !contentContainerId) {
            console.warn(`[ActionService] Không tìm thấy map ID cho section: ${sectionId}`);
            return null;
        }

        const navEl = document.getElementById(navId);
        if (!navEl) return null;

        const activeBtn = navEl.querySelector('.sub-tab-btn.active'); 
        if (!activeBtn) return null;

        // [SAFETY] Fallback title nếu thiếu
        const title = activeBtn.dataset.title || activeBtn.innerText.replace(/\s/g, '') || 'BaoCao';

        return {
            button: activeBtn,
            targetId: activeBtn.dataset.target,
            title: title,
            contentContainerId: contentContainerId
        };
    },

    // [FIX CRITICAL] Hàm Capture được viết lại để chống treo và xử lý logic view phức tạp
    async handleCapture(sectionId) {
        console.log(`[ActionService] ➤ Bắt đầu chụp ảnh section: ${sectionId}`);
        
        try {
            const tabInfo = this._getActiveTabInfo(sectionId);
            if (!tabInfo) {
                throw new Error('Không xác định được Tab đang mở. Vui lòng tải lại trang.');
            }

            // 1. Logic xác định phần tử cần chụp (Element Resolution)
            const currentDetail = get(viewingDetailFor);
            let elementToCapture = null;
            let title = tabInfo.title;

            if (currentDetail) {
                // Ưu tiên 1: Đang xem chi tiết nhân viên
                console.log('[ActionService] Mode: Detail View');
                elementToCapture = document.getElementById('health-staff-detail-view');
                title = `${tabInfo.title}_ChiTiet_${currentDetail.maNV}`;
            } else {
                // Ưu tiên 2: Xử lý các view đặc biệt (Ví dụ: Tab Thi Đua có view switcher)
                if (sectionId === 'sknv' && tabInfo.targetId === 'subtab-thidua') {
                    const activeViewBtn = document.querySelector('#sknv-thidua-view-selector .view-switcher__btn.active');
                    const viewType = activeViewBtn ? activeViewBtn.dataset.view : 'program';
                    
                    console.log(`[ActionService] Mode: ThiDua View (${viewType})`);
                    
                    if (viewType === 'program') {
                        elementToCapture = document.getElementById('competition-report-container-lk');
                    } else {
                        elementToCapture = document.getElementById('pasted-competition-report-container');
                    }
                } else {
                    // Ưu tiên 3: View mặc định theo tab
                    elementToCapture = document.getElementById(tabInfo.targetId);
                }
            }

            // 2. Validate Element
            if (!elementToCapture) {
                console.error(`[ActionService] Element not found. TargetID: ${tabInfo.targetId}`);
                throw new Error('Không tìm thấy bảng dữ liệu để chụp.');
            }

            // [SAFETY] Kiểm tra kích thước thật (Tránh chụp vùng trắng/ẩn)
            if (elementToCapture.offsetWidth === 0 || elementToCapture.offsetHeight === 0) {
                console.warn('[ActionService] Element kích thước 0x0. Đang bị ẩn?');
                throw new Error('Bảng dữ liệu đang bị ẩn hoặc chưa tải xong.');
            }

            // 3. Thực thi chụp (Safe Call)
            console.log(`[ActionService] Gọi service chụp cho element:`, elementToCapture);
            
            // [DEBUG & FIX] Kiểm tra method nào khả dụng trong captureService
            if (typeof captureService.captureDashboardInParts === 'function') {
                await captureService.captureDashboardInParts(elementToCapture, title);
            } 
            else if (typeof captureService.capture === 'function') {
                // Fallback nếu code cũ dùng .capture
                console.warn('[ActionService] captureDashboardInParts không tồn tại, dùng fallback .capture()');
                await captureService.capture(elementToCapture, title);
            }
            else {
                console.error('[ActionService] Available methods:', Object.keys(captureService));
                throw new Error('Service chụp ảnh lỗi: Không tìm thấy hàm captureDashboardInParts hoặc capture.');
            }
            
            console.log('[ActionService] ➤ Chụp ảnh hoàn tất.');

        } catch (error) {
            console.error('[ActionService] Lỗi chụp ảnh:', error);
            alert('Lỗi: ' + (error.message || 'Không thể chụp ảnh.'));
        } finally {
            // [QUAN TRỌNG] Đảm bảo luôn chạy để UI component tắt loading
            console.log('[ActionService] ➤ Kết thúc luồng Capture.');
            return; // Resolve promise
        }
    },

    // Hàm Export giữ nguyên logic nhưng thêm log safety
    async handleExport(sectionId) {
        console.log(`[ActionService] ➤ Bắt đầu xuất Excel section: ${sectionId}`);
        try {
            const tabInfo = this._getActiveTabInfo(sectionId);
            if (!tabInfo) return;

            let activeTabContent;
            
            // Logic tìm nội dung tương tự capture
            if (sectionId === 'sknv' && tabInfo.targetId === 'subtab-thidua') {
                 const activeViewBtn = document.querySelector('#sknv-thidua-view-selector .view-switcher__btn.active');
                 const viewType = activeViewBtn ? activeViewBtn.dataset.view : 'program';
                 activeTabContent = viewType === 'program' ? 
                    document.getElementById('competition-report-container-lk') : 
                    document.getElementById('pasted-competition-report-container');
            } else {
                // Logic cũ: tìm .sub-tab-content không hidden
                activeTabContent = document.querySelector(`#${tabInfo.contentContainerId} .sub-tab-content:not(.hidden)`);
                // Fallback nếu logic trên không tìm thấy (đôi khi active class nằm ở chỗ khác)
                if (!activeTabContent && tabInfo.targetId) {
                    activeTabContent = document.getElementById(tabInfo.targetId);
                }
            }

            if (activeTabContent) {
                const timestamp = new Date().toLocaleDateString('vi-VN').replace(/\//g, '-');
                await excelService.exportTableToExcel(activeTabContent, `${tabInfo.title}_${timestamp}`);
            } else {
                 alert('Không tìm thấy nội dung để xuất Excel.');
            }
        } catch (error) {
            console.error('[ActionService] Lỗi xuất Excel:', error);
            alert('Lỗi xuất Excel: ' + error.message);
        }
    }
};
<<< FILE_END: src/services/action.service.js

>>> FILE_START: src/services/admin.service.js
// src/services/admin.service.js
// Version 4.0 - Refactored into 'declarations' sub-services to avoid name conflict

import { configService } from './declarations/config.service.js';
import { categoryService } from './declarations/category.service.js';
import { performanceService } from './declarations/performance.service.js';

export const adminService = {
    // --- 1. HELP CONTENT ---
    saveHelpContent: configService.saveHelpContent,

    // --- 2. HOME CONFIG ---
    saveHomeConfig: configService.saveHomeConfig,
    loadHomeConfig: configService.loadHomeConfig,

    // --- 3. CATEGORY & BRAND STRUCTURE ---
    saveCategoryDataToFirestore: categoryService.saveCategoryDataToFirestore,
    loadCategoryDataFromFirestore: categoryService.loadCategoryDataFromFirestore,

    // --- 4. SYSTEM REVENUE TABLES ---
    loadSystemRevenueTables: performanceService.loadSystemRevenueTables,
    saveSystemRevenueTables: performanceService.saveSystemRevenueTables,

    // --- 4.5. SYSTEM PERFORMANCE TABLES ---
    loadSystemPerformanceTables: performanceService.loadSystemPerformanceTables,
    saveSystemPerformanceTables: performanceService.saveSystemPerformanceTables,

    // --- 5. MAPPINGS & CONFIGS GLOBAL ---
    loadMappingsGlobal: categoryService.loadMappingsGlobal,
    
    saveMacroCategoryConfig: categoryService.saveMacroCategoryConfig,
    loadMacroCategoryConfig: categoryService.loadMacroCategoryConfig,

    saveMacroProductGroupConfig: categoryService.saveMacroProductGroupConfig,
    loadMacroProductGroupConfig: categoryService.loadMacroProductGroupConfig,

    saveNameMapping: categoryService.saveNameMapping,
    saveCompetitionNameMappings: categoryService.saveCompetitionNameMappings,

    // --- 6. LOGIC & CALCULATION ---
    loadDeclarationsFromFirestore: performanceService.loadDeclarationsFromFirestore,
    saveDeclarationsToFirestore: performanceService.saveDeclarationsToFirestore,

    // --- 7. COMPETITION CONFIGS ---
    saveGlobalCompetitionConfigs: performanceService.saveGlobalCompetitionConfigs,
    loadGlobalCompetitionConfigs: performanceService.loadGlobalCompetitionConfigs,

    // --- 8. SPECIAL PRODUCTS ---
    saveSpecialProductList: categoryService.saveSpecialProductList,
    loadSpecialProductList: categoryService.loadSpecialProductList,
    loadGlobalSpecialPrograms: categoryService.loadGlobalSpecialPrograms,

    // --- 9. EFFICIENCY & QDC CONFIGS ---
    saveEfficiencyConfig: performanceService.saveEfficiencyConfig,
    loadEfficiencyConfig: performanceService.loadEfficiencyConfig,
    
    saveQdcConfig: performanceService.saveQdcConfig,
    loadQdcConfig: performanceService.loadQdcConfig,

    // --- 10. UPLOAD ---
    uploadImage: configService.uploadImage
};
<<< FILE_END: src/services/admin.service.js

>>> FILE_START: src/services/analytics.service.js
// src/services/analytics.service.js
// Version 2.2 - Full code implementation (Added getSystemStats & trackAction)
import { get } from 'svelte/store';
import { collection, getDocs, doc, setDoc, serverTimestamp, increment } from "firebase/firestore";
import { firebaseStore, isAdmin, currentUser } from '../stores.js';

const getDB = () => {
    const fb = get(firebaseStore);
    return fb.db;
};

export const analyticsService = {
    // Lấy danh sách toàn bộ user để tính toán thống kê
    async getAllUsers() {
        const db = getDB();
        // Không yêu cầu quyền Admin ở đây để Home có thể hiển thị số liệu chung
        if (!db) return [];

        try {
            const usersCollection = collection(db, "users");
            const querySnapshot = await getDocs(usersCollection);
            const users = [];
            
            querySnapshot.forEach((doc) => {
                const data = doc.data();
                users.push({
                    email: data.email,
                    loginCount: data.loginCount || 0,
                    lastLogin: data.lastLogin ? data.lastLogin.toDate() : null,
                    actionsTaken: data.actionsTaken || 0
                });
            });
            return users;
        } catch (error) {
            console.error("Lỗi khi lấy danh sách user:", error);
            return [];
        }
    },

    // Cập nhật thông tin user khi đăng nhập
    async upsertUserRecord(email) {
        const db = getDB();
        if (!db || !email) return;

        const userRef = doc(db, "users", email);
        try {
            await setDoc(userRef, {
                email: email,
                lastLogin: serverTimestamp(),
                loginCount: increment(1)
            }, { merge: true });
        } catch (error) {
            console.error("Lỗi cập nhật user record:", error);
        }
    },

    // Hàm tăng counter thủ công (Giữ lại để tương thích ngược nếu cần)
    async incrementCounter(fieldName, email = null) {
        const db = getDB();
        if (!db || !fieldName) return;

        if (!email) {
            const user = get(currentUser);
            if (user) email = user.email;
        }

        let docRef;
        const dataToUpdate = { [fieldName]: increment(1) };

        if (fieldName === 'actionsTaken' && email) {
            docRef = doc(db, "users", email);
        } else {
            docRef = doc(db, "analytics", "site_stats");
        }

        try {
            await setDoc(docRef, dataToUpdate, { merge: true });
        } catch (error) {
            console.error(`Lỗi tăng counter ${fieldName}:`, error);
        }
    },

    // [MỚI] Hàm lấy tổng hợp số liệu toàn hệ thống
    async getSystemStats() {
        const users = await this.getAllUsers();
        
        const stats = users.reduce((acc, user) => {
            acc.totalUsers += 1; // Mỗi user là 1 người dùng
            acc.totalVisits += (user.loginCount || 0); // Tổng số lần đăng nhập
            acc.totalActions += (user.actionsTaken || 0); // Tổng số lần upload/paste
            return acc;
        }, { totalUsers: 0, totalVisits: 0, totalActions: 0 });

        return stats;
    },

    // [MỚI] Hàm ghi nhận hành động (dùng cho upload/paste)
    async trackAction() {
        const user = get(currentUser);
        if (!user || !user.email) return; // Chỉ tính khi đã đăng nhập
        
        const db = getDB();
        if (!db) return;

        const userRef = doc(db, "users", user.email);
        try {
            await setDoc(userRef, {
                actionsTaken: increment(1)
            }, { merge: true });
            console.log("[Analytics] Đã ghi nhận 1 lượt sử dụng.");
        } catch (error) {
            console.error("Lỗi trackAction:", error);
        }
    }
};
<<< FILE_END: src/services/analytics.service.js

>>> FILE_START: src/services/auth.service.js
// Version 2.3 - Add Anonymous Auth to fix 403 error
import { get } from 'svelte/store';
import { currentUser, isAdmin } from '../stores.js';
import { analyticsService } from './analytics.service.js';
import { config } from '../config.js';
import { getAuth, signInAnonymously, onAuthStateChanged } from "firebase/auth";

export const authService = {
    /**
     * Kiểm tra định dạng email
     * @param {string} email 
     * @returns {boolean}
     */
    isValidEmail(email) {
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        return email && emailRegex.test(email);
    },

    /**
     * [QUAN TRỌNG] Đảm bảo người dùng đã đăng nhập vào Firebase (Ẩn danh)
     * Hàm này cần được gọi ngay khi App khởi chạy để lấy token.
     * @returns {Promise<User>} Firebase User object
     */
    async ensureAnonymousAuth() {
        const auth = getAuth();
        return new Promise((resolve, reject) => {
            // Lắng nghe trạng thái xác thực
            const unsubscribe = onAuthStateChanged(auth, (user) => {
                if (user) {
                    console.log("[AuthService] Đã xác thực Firebase (Ẩn danh):", user.uid);
                    unsubscribe(); // Hủy lắng nghe sau khi đã có user
                    resolve(user);
                } else {
                    console.log("[AuthService] Chưa có user, đang đăng nhập ẩn danh...");
                    signInAnonymously(auth)
                        .catch((error) => {
                            console.error("[AuthService] Lỗi đăng nhập ẩn danh:", error);
                            reject(error);
                        });
                }
            });
        });
    },

    /**
     * Xử lý định danh người dùng qua Email (Application Layer)
     * @param {string} email 
     * @returns {Promise<boolean>} true nếu thành công
     */
    async loginUser(email) {
        const cleanEmail = email.trim();
        if (!this.isValidEmail(cleanEmail)) {
            return false;
        }

        // 1. Lưu vào LocalStorage để nhớ cho lần sau
        localStorage.setItem('userEmail', cleanEmail);

        // 2. Cập nhật Store
        currentUser.set({ email: cleanEmail });

        // 3. Gọi Analytics (Upsert user record)
        analyticsService.upsertUserRecord(cleanEmail).catch(err => {
            console.error("[AuthService] Lỗi khi ghi nhận user vào analytics:", err);
        });

        return true;
    },

    /**
     * Kiểm tra mật khẩu Admin
     * @param {string} password 
     * @returns {boolean}
     */
    checkAdminPassword(password) {
        if (!config || !config.ADMIN_PASSWORD) {
            console.error("[AuthService] Chưa cấu hình mật khẩu Admin trong config.js");
            return false;
        }
        
        if (password === config.ADMIN_PASSWORD) {
            isAdmin.set(true);
            return true;
        }
        
        return false;
    },

    /**
     * Khởi tạo: Kiểm tra xem đã có email lưu trong localStorage chưa
     * (Chỉ kiểm tra logic Email, phần Firebase Auth sẽ chạy riêng)
     */
    initAuth() {
        const savedEmail = localStorage.getItem('userEmail');
        if (savedEmail && this.isValidEmail(savedEmail)) {
            console.log(`[AuthService] Tìm thấy email đã lưu: ${savedEmail}`);
            currentUser.set({ email: savedEmail });
            // Ghi nhận phiên truy cập
            analyticsService.upsertUserRecord(savedEmail);
            return true; // Đã có email định danh
        }
        return false; // Chưa có email
    }
};
<<< FILE_END: src/services/auth.service.js

>>> FILE_START: src/services/capture.config.js
// File: src/services/capture.config.js

// 1. Danh sách các nhóm cần TÁCH ẢNH (Mỗi bảng 1 ảnh)
export const SPLIT_GROUPS = [
    'category-revenue',         
    'competition-program',      
    'competition-program-view', 
    'efficiency-program',       
    'efficiency-program-view',
    'regional-competition',
    'efficiency-luyke'
];

// 2. Danh sách các nhóm cần GỘP DẠNG LƯỚI (Grid) - Dành cho KPI
export const KPI_GROUPS = [
    'kpi',
    'supermarket-kpi' // Dự phòng thêm tên này
];

// 3. Cấu hình mặc định: MERGE_VERTICAL (Gộp dọc)
// Dành cho: Realtime, Doanh thu NV LK, Thu nhập...
<<< FILE_END: src/services/capture.config.js

>>> FILE_START: src/services/capture.service.js
/* global Chart */
import { notificationStore, currentUser } from '../stores.js';
import { analyticsService } from './analytics.service.js';
import { get } from 'svelte/store';

// --- HELPER for Screenshot CSS Injection ---
const _injectCaptureStyles = () => {
    const styleId = 'dynamic-capture-styles';
    document.getElementById(styleId)?.remove();

    const styles = `
        /* Container gốc */
        .capture-container { 
            padding: 24px; 
            background-color: #f3f4f6; 
            box-sizing: border-box; 
            width: fit-content; 
            position: absolute;
            left: -9999px;
            top: 0;
            z-index: -1;
        }
        
        /* [UPDATED FIX] Xử lý triệt để lỗi cắt chữ (g, y, p...) ở mọi cấp độ */
        
        /* 1. Cấp độ ô bảng (TD/TH) */
        .capture-container th,
        .capture-container td {
            padding-top: 8px !important;
            padding-bottom: 8px !important;
            line-height: 1.5 !important;
            height: auto !important;      /* Bắt buộc chiều cao tự động giãn */
        }

        /* 2. Cấp độ nội dung bên trong (DIV/SPAN/P/STRONG) - Quan trọng cho Tên Nhân Viên */
        /* Nguyên nhân tên bị cắt là do thẻ bao bên trong td bị giới hạn chiều cao hoặc overflow */
        .capture-container td > div,
        .capture-container td > span,
        .capture-container td > p,
        .capture-container th > div,
        .capture-container th > span {
            overflow: visible !important;  /* Cấm ẩn nội dung thừa */
            padding-bottom: 4px !important; /* Nới đáy cho thẻ con */
            line-height: 1.5 !important;
            height: auto !important;
            white-space: normal !important; /* Cho phép xuống dòng nếu cần, tránh bị cắt ngang */
        }

        /* 3. Cấp độ Tiêu đề lớn */
        .capture-container h3, 
        .capture-container h4,
        .capture-container .font-bold {
            padding-bottom: 6px !important;
            line-height: 1.5 !important;
            overflow: visible !important;
        }

        .force-desktop-mode {
            min-width: 1600px !important;
            width: fit-content !important;
        }

        .capture-layout-container { 
            display: flex; 
            flex-direction: column; 
            gap: 24px; 
        }
        
        .capture-title { 
            font-size: 28px; 
            font-weight: bold; 
            color: #1e3a8a; 
            margin-bottom: 20px; 
            text-align: center; 
            font-family: 'Segoe UI', sans-serif;
            text-transform: uppercase;
            line-height: 1.5 !important;
            padding-bottom: 10px !important;
        }

        /* Mobile Portrait Preset */
        .preset-mobile-portrait {
            width: 450px !important;
            min-width: 450px !important;
            max-width: 450px !important;
            padding: 10px !important;
            margin: 0 auto;
            transform: scale(2) !important;
        }
        .preset-mobile-portrait .capture-title {
            font-size: 18px !important;
        }
        
        /* KPI Grid Fix */
        .prepare-for-kpi-capture {
            display: grid !important;
            grid-template-columns: repeat(2, 1fr) !important;
            gap: 16px !important;
        }
    `;

    const styleElement = document.createElement('style');
    styleElement.id = styleId;
    styleElement.textContent = styles;
    document.head.appendChild(styleElement);
    return styleElement;
};

// --- HELPER: Swap Canvas to Image (Cho Chart.js) ---
const swapCanvasToImage = (container) => {
    const canvases = container.querySelectorAll('canvas');
    canvases.forEach(canvas => {
        try {
            const img = document.createElement('img');
            img.src = canvas.toDataURL('image/png');
            img.style.width = canvas.style.width || '100%';
            img.style.height = canvas.style.height || 'auto';
            img.style.display = 'block';
            
            if (canvas.parentNode) {
                canvas.parentNode.insertBefore(img, canvas);
                canvas.style.display = 'none'; 
            }
        } catch (e) {
            console.warn('Cannot convert canvas to image:', e);
        }
    });
};

export const captureService = {
    async captureAndDownload(elementToCapture, title, presetClass = '') {
        // 1. Kiểm tra thư viện
        if (typeof window.html2canvas === 'undefined') {
            alert("Lỗi: Thư viện html2canvas chưa tải xong. Vui lòng F5 lại trang.");
            return;
        }

        const date = new Date();
        const dateString = date.toLocaleDateString('vi-VN', { day: '2-digit', month: '2-digit' });
        const timeString = date.toLocaleTimeString('vi-VN', { hour: '2-digit', minute: '2-digit' });
        const finalTitle = `${title.replace(/_/g, ' ')} - ${timeString} ${dateString}`;
    
        // 2. Tạo wrapper
        const captureWrapper = document.createElement('div');
        captureWrapper.className = 'capture-container';
    
        // 3. Thêm tiêu đề
        const titleEl = document.createElement('h2');
        titleEl.className = 'capture-title';
        titleEl.textContent = finalTitle;
        captureWrapper.appendChild(titleEl);
        
        // 4. Clone nội dung
        const contentClone = elementToCapture.cloneNode(true);
        if (presetClass) { 
            const classes = presetClass.split(' ').filter(c => c);
            contentClone.classList.add(...classes); 
        }

        captureWrapper.appendChild(contentClone);
        document.body.appendChild(captureWrapper);

        // 5. Tắt animation Chart.js
        if (typeof Chart !== 'undefined') {
            Chart.defaults.animation = false;
        }
        
        // 6. Chuyển đổi Canvas -> Ảnh
        swapCanvasToImage(contentClone);

        // 7. Đợi render 
        await new Promise(resolve => setTimeout(resolve, 300));

        try {
            // 8. Chụp bằng html2canvas
            const canvas = await window.html2canvas(captureWrapper, {
                scale: 2, 
                useCORS: true,
                backgroundColor: '#f3f4f6',
                logging: false,
                windowWidth: captureWrapper.scrollWidth, 
                windowHeight: captureWrapper.scrollHeight
            });

            // 9. Tải xuống
            const link = document.createElement('a');
            link.download = `${title}_${dateString.replace(/\//g, '-')}.png`;
            link.href = canvas.toDataURL('image/png');
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);

            notificationStore.update(s => ({ ...s, visible: true, type: 'success', message: 'Đã tải ảnh xuống thành công!' }));
            setTimeout(() => notificationStore.update(s => ({ ...s, visible: false })), 3000);

        } catch (err) {
            console.error('Lỗi captureService:', err);
            alert(`Lỗi khi chụp ảnh: ${err.message}`);
        } finally {
            // 10. Dọn dẹp
            if (document.body.contains(captureWrapper)) {
                document.body.removeChild(captureWrapper);
            }
            if (typeof Chart !== 'undefined') {
                Chart.defaults.animation = {}; 
            }
        }
    },
    
    async captureDashboardInParts(contentContainer, baseTitle) {
       if (!contentContainer) {
            alert('Lỗi: Không tìm thấy nội dung để chụp.');
            return;
        }

        const user = get(currentUser);
        analyticsService.incrementCounter('actionsTaken', user?.email);
        notificationStore.update(s => ({ ...s, visible: true, type: 'info', message: `Đang xử lý ảnh: ${baseTitle}...` }));

        // Gom nhóm các phần tử
        const captureGroups = new Map();
        contentContainer.querySelectorAll('[data-capture-group]').forEach(el => {
            if (el.offsetParent !== null) {
                const group = el.dataset.captureGroup;
                if (!captureGroups.has(group)) {
                     captureGroups.set(group, []);
                }
                captureGroups.get(group).push(el);
            }
        });

        const styleElement = _injectCaptureStyles();
        if (typeof Chart !== 'undefined') {
            Chart.defaults.animation = false;
        }
        await new Promise(resolve => setTimeout(resolve, 100));

        // --- CẤU HÌNH LOGIC CHỤP ẢNH ---
        
        const SPLIT_GROUPS = [
            'category-revenue',         
            'competition-program',      
            'competition-program-view', 
            'efficiency-program',       
            'efficiency-program-view',
            'regional-competition',
            'efficiency-luyke'
        ];

        try {
            // Case 1: Không có group
            if (captureGroups.size === 0) {
                if (contentContainer.offsetParent !== null) {
                    const preset = contentContainer.dataset.capturePreset;
                    let presetClass = preset ? `preset-${preset}` : '';
                    await this.captureAndDownload(contentContainer, baseTitle, presetClass);
                } else {
                     alert('Không có nội dung hiển thị để chụp.');
                }
                return;
            }

            // Case 2: Xử lý từng group
            for (const [group, elements] of captureGroups.entries()) {
                
                // --- A. LOGIC TÁCH ẢNH ---
                if (SPLIT_GROUPS.includes(group)) {
                    for (const targetElement of elements) {
                        let foundTitle = targetElement.querySelector('h3, h4')?.textContent?.trim() || '';
                        const captureTitle = (foundTitle || baseTitle)
                                                .replace(/[^a-zA-Z0-9\sÁ-ỹ]/g, '')
                                                .replace(/\s+/g, '_');
                        
                        const preset = targetElement.dataset.capturePreset;
                        let presetClass = (preset ? `preset-${preset}` : '');

                        await this.captureAndDownload(targetElement, captureTitle, presetClass);
                        await new Promise(resolve => setTimeout(resolve, 500));
                    }
                    continue; 
                }

                // --- B. LOGIC GỘP ---
                const targetElement = elements[0];
                let foundTitle = '';
                if (targetElement) {
                    foundTitle = targetElement.querySelector('h3, h4')?.textContent?.trim() || '';
                }
                const captureTitle = (foundTitle || baseTitle)
                                        .replace(/[^a-zA-Z0-9\sÁ-ỹ]/g, '')
                                        .replace(/\s+/g, '_');

                const preset = targetElement.dataset.capturePreset;
                const isKpiGroup = group === 'kpi';
                
                let elementToCapture;
                let presetClass = '';

                if (isKpiGroup) {
                    presetClass = 'prepare-for-kpi-capture';
                } else if (preset) {
                    presetClass = `preset-${preset}`;
                }
                
                if (elements.length > 1 && !isKpiGroup) {
                    const tempContainer = document.createElement('div');
                    tempContainer.className = 'capture-layout-container';
                    elements.forEach(el => tempContainer.appendChild(el.cloneNode(true)));
                    elementToCapture = tempContainer;
                } else {
                    elementToCapture = targetElement;
                }
    
                await this.captureAndDownload(elementToCapture, captureTitle, presetClass);
                await new Promise(resolve => setTimeout(resolve, 300));
            }
        } finally {
            styleElement.remove();
            if (typeof Chart !== 'undefined') {
                Chart.defaults.animation = {};
            }
        }

        notificationStore.update(s => ({ ...s, visible: true, type: 'success', message: 'Hoàn tất!' }));
        setTimeout(() => notificationStore.update(s => ({ ...s, visible: false })), 3000);
    },
};
<<< FILE_END: src/services/capture.service.js

>>> FILE_START: src/services/capture.strategies.js
// File: src/services/capture.strategies.js
/* global Chart */
import { notificationStore } from '../stores.js';

// --- HELPER: CSS Injection (Đã Fix lỗi mờ & Cắt chữ) ---
export const injectCaptureStyles = () => {
    const styleId = 'dynamic-capture-styles';
    document.getElementById(styleId)?.remove();

    const styles = `
        /* Container gốc */
        .capture-container { 
            padding: 24px; 
            background-color: #f3f4f6; 
            box-sizing: border-box; 
            width: fit-content; 
            position: absolute;
            left: -9999px;
            top: 0;
            z-index: -1;
        }
        
        /* Fix lỗi cắt chữ (Padding & Line-height) */
        .capture-container th, .capture-container td {
            padding-top: 8px !important;
            padding-bottom: 8px !important;
            line-height: 1.5 !important;
            height: auto !important;
        }
        .capture-container td > div, .capture-container td > span,
        .capture-container td > p, .capture-container th > div, .capture-container th > span {
            overflow: visible !important;
            padding-bottom: 4px !important;
            line-height: 1.5 !important;
            height: auto !important;
            white-space: normal !important;
        }
        .capture-container h3, .capture-container h4, .capture-container .font-bold {
            padding-bottom: 6px !important;
            line-height: 1.5 !important;
            overflow: visible !important;
        }

        /* Layout Helpers */
        .capture-layout-container { 
            display: flex; 
            flex-direction: column; 
            gap: 24px; 
        }
        .prepare-for-kpi-capture {
            display: grid !important;
            grid-template-columns: repeat(2, 1fr) !important;
            gap: 16px !important;
        }

        /* Tiêu đề */
        .capture-title { 
            font-size: 28px; 
            font-weight: bold; 
            color: #1e3a8a; 
            margin-bottom: 20px; 
            text-align: center; 
            font-family: 'Segoe UI', sans-serif;
            text-transform: uppercase;
            line-height: 1.5 !important;
            padding-bottom: 10px !important;
        }

        /* [CRITICAL FIX] Mobile Portrait Preset - Chìa khóa độ nét */
        .preset-mobile-portrait {
            width: 450px !important;
            min-width: 450px !important;
            max-width: 450px !important;
            padding: 10px !important;
            margin: 0 auto;
            transform: scale(5) !important;
            transform-origin: top center !important; /* QUAN TRỌNG: Giữ nội dung không bị trôi */
        }
        .preset-mobile-portrait .capture-title {
            font-size: 18px !important;
        }
    `;

    const styleElement = document.createElement('style');
    styleElement.id = styleId;
    styleElement.textContent = styles;
    document.head.appendChild(styleElement);
    return styleElement;
};

const swapCanvasToImage = (container) => {
    const canvases = container.querySelectorAll('canvas');
    canvases.forEach(canvas => {
        try {
            const img = document.createElement('img');
            img.src = canvas.toDataURL('image/png');
            img.style.width = canvas.style.width || '100%';
            img.style.height = canvas.style.height || 'auto';
            img.style.display = 'block';
            if (canvas.parentNode) {
                canvas.parentNode.insertBefore(img, canvas);
                canvas.style.display = 'none'; 
            }
        } catch (e) {
            console.warn('Cannot convert canvas to image:', e);
        }
    });
};

// --- CORE FUNCTION ---
const _coreCapture = async (elementToCapture, title, presetClass = '') => {
    if (typeof window.html2canvas === 'undefined') throw new Error("Thư viện html2canvas chưa tải xong.");

    const date = new Date();
    const dateString = date.toLocaleDateString('vi-VN', { day: '2-digit', month: '2-digit' });
    const timeString = date.toLocaleTimeString('vi-VN', { hour: '2-digit', minute: '2-digit' });
    const finalTitle = `${title.replace(/_/g, ' ')} - ${timeString} ${dateString}`;

    const captureWrapper = document.createElement('div');
    captureWrapper.className = 'capture-container';

    const titleEl = document.createElement('h2');
    titleEl.className = 'capture-title';
    titleEl.textContent = finalTitle;
    captureWrapper.appendChild(titleEl);
    
    const contentClone = elementToCapture.cloneNode(true);
    if (presetClass) { 
        const classes = presetClass.split(' ').filter(c => c);
        contentClone.classList.add(...classes); 
    }
    captureWrapper.appendChild(contentClone);
    document.body.appendChild(captureWrapper);

    if (typeof Chart !== 'undefined') Chart.defaults.animation = false;
    swapCanvasToImage(contentClone);
    await new Promise(resolve => setTimeout(resolve, 300)); // Đợi render ổn định

    try {
        const canvas = await window.html2canvas(captureWrapper, {
            scale: 2, // Độ phân giải cao (High Res)
            useCORS: true,
            backgroundColor: '#f3f4f6',
            logging: false,
            windowWidth: captureWrapper.scrollWidth, 
            windowHeight: captureWrapper.scrollHeight
        });

        const link = document.createElement('a');
        link.download = `${title}_${dateString.replace(/\//g, '-')}.png`;
        link.href = canvas.toDataURL('image/png');
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);

        notificationStore.update(s => ({ ...s, visible: true, type: 'success', message: 'Đã tải ảnh xuống thành công!' }));
        setTimeout(() => notificationStore.update(s => ({ ...s, visible: false })), 3000);
    } finally {
        if (document.body.contains(captureWrapper)) document.body.removeChild(captureWrapper);
        if (typeof Chart !== 'undefined') Chart.defaults.animation = {}; 
    }
};

// --- STRATEGIES ---

export const strategySingle = async (element, baseTitle) => {
    const preset = element.dataset.capturePreset;
    let presetClass = preset ? `preset-${preset}` : '';
    await _coreCapture(element, baseTitle, presetClass);
};

export const strategySplit = async (elements, baseTitle) => {
    for (const targetElement of elements) {
        let foundTitle = targetElement.querySelector('h3, h4')?.textContent?.trim() || '';
        const captureTitle = (foundTitle || baseTitle)
                                .replace(/[^a-zA-Z0-9\sÁ-ỹ]/g, '')
                                .replace(/\s+/g, '_');
        
        const preset = targetElement.dataset.capturePreset;
        let presetClass = (preset ? `preset-${preset}` : '');

        await _coreCapture(targetElement, captureTitle, presetClass);
        await new Promise(resolve => setTimeout(resolve, 500));
    }
};

export const strategyMerge = async (elements, baseTitle, isKpiMode = false) => {
    const targetElement = elements[0];
    let foundTitle = '';
    if (targetElement) {
        foundTitle = targetElement.querySelector('h3, h4')?.textContent?.trim() || '';
    }
    const captureTitle = (foundTitle || baseTitle)
                            .replace(/[^a-zA-Z0-9\sÁ-ỹ]/g, '')
                            .replace(/\s+/g, '_');

    const preset = targetElement.dataset.capturePreset;
    let presetClass = '';

    if (isKpiMode) {
        presetClass = 'prepare-for-kpi-capture';
    } else if (preset) {
        presetClass = `preset-${preset}`;
    }

    let elementToCapture;
    
    // Logic gộp
    if (elements.length > 1 || isKpiMode) {
        const tempContainer = document.createElement('div');
        tempContainer.className = 'capture-layout-container'; 
        elements.forEach(el => tempContainer.appendChild(el.cloneNode(true)));
        elementToCapture = tempContainer;
    } else {
        // Nếu chỉ có 1 phần tử (VD: Doanh thu NV LK), lấy trực tiếp để preset áp dụng đúng
        elementToCapture = targetElement;
    }

    await _coreCapture(elementToCapture, captureTitle, presetClass);
    await new Promise(resolve => setTimeout(resolve, 300));
};

export const captureAndDownload = _coreCapture;
<<< FILE_END: src/services/capture.strategies.js

>>> FILE_START: src/services/cluster.service.js
// src/services/cluster.service.js
import { writable } from 'svelte/store';
import { clusterParser } from './processing/parsers/cluster.parser.js';
import { clusterProcessor } from './processing/logic/cluster.processor.js';

// Stores để UI subscribe
export const clusterDataStore = writable({
    competition: null, // Dữ liệu thi đua
    cumulative: null,  // Dữ liệu lũy kế (General + Details)
    isClusterMode: false,
    currentClusterCode: null
});

const STORAGE_PREFIX = 'cluster_data_';

export const clusterService = {
    /**
     * Xử lý text paste từ ô "Thi đua siêu thị lũy kế"
     */
    processCompetitionInput: (text, clusterCode) => {
        const parsed = clusterParser.parseCompetitionStr(text);
        const processed = clusterProcessor.processCompetitionData(parsed);
        
        // Update Store
        clusterDataStore.update(s => ({ ...s, competition: processed }));
        
        // Save to Local
        localStorage.setItem(`${STORAGE_PREFIX}comp_${clusterCode}`, JSON.stringify(processed));
        return processed;
    },

    /**
     * Xử lý text paste từ ô "Data lũy kế" (Chế độ Cụm)
     */
    processCumulativeInput: (text, clusterCode) => {
        const parsed = clusterParser.parseCumulativeStr(text);
        const report = clusterProcessor.createClusterReport(parsed);
        
        // Update Store
        clusterDataStore.update(s => ({ ...s, cumulative: report }));
        
        // Save to Local
        localStorage.setItem(`${STORAGE_PREFIX}cumul_${clusterCode}`, JSON.stringify(report));
        return report;
    },

    /**
     * Load dữ liệu đã lưu khi người dùng chọn Kho/Cụm
     */
    loadSavedData: (clusterCode) => {
        if (!clusterCode) return;

        try {
            const savedComp = localStorage.getItem(`${STORAGE_PREFIX}comp_${clusterCode}`);
            const savedCumul = localStorage.getItem(`${STORAGE_PREFIX}cumul_${clusterCode}`);

            clusterDataStore.update(s => ({
                ...s,
                currentClusterCode: clusterCode,
                isClusterMode: true,
                competition: savedComp ? JSON.parse(savedComp) : null,
                cumulative: savedCumul ? JSON.parse(savedCumul) : null
            }));
        } catch (e) {
            console.error("Lỗi load dữ liệu cụm:", e);
        }
    },

    /**
     * Reset store khi chuyển về chế độ kho đơn
     */
    reset: () => {
        clusterDataStore.set({
            competition: null,
            cumulative: null,
            isClusterMode: false,
            currentClusterCode: null
        });
    }
};
<<< FILE_END: src/services/cluster.service.js

>>> FILE_START: src/services/composerService.js
// File: src/services/composerService.js
// MỤC ĐÍCH: Chỉ chứa logic cho Trình tạo Nhận xét.

import { get } from 'svelte/store';
import { masterReportData } from '../stores.js';
import { dataProcessing } from './dataProcessing.js';
// [FIX LỖI IMPORT] Dùng 'import * as utils' thay vì 'import { utils }'
import * as utils from '../utils.js'; 
import { formatters } from '../utils/formatters.js';

const composerServices = {
    // Logic getEmployeeRanking
    getEmployeeRanking(reportData, key, direction = 'desc', count = 3, department = 'ALL') {
        if (!reportData || reportData.length === 0) return [];
        let filteredData = reportData;
        if (department !== 'ALL') {
            filteredData = reportData.filter(e => e.boPhan === department);
        }

        return [...filteredData]
            .filter(e => e[key] > 0)
            .sort((a, b) => direction === 'desc' ? (b[key] || 0) - (a[key] || 0) : (a[key] || 0) - (b[key] || 0))
            .slice(0, count);
    },

    // Logic getEmployeesBelowTarget
    getEmployeesBelowTarget(reportData, dataKey, goalKey, department = 'ALL') {
        if (!reportData || reportData.length === 0) return [];
        let filteredData = reportData;
        if (department !== 'ALL') {
            filteredData = reportData.filter(e => e.boPhan === department);
        }

        return filteredData.filter(employee => {
            const value = employee[dataKey] || 0;
            const target = (employee.mucTieu?.[goalKey] || 0) / 100;
            return target > 0 && value < target;
        }).sort((a, b) => (b[dataKey] || 0) - (a[dataKey] || 0));
    },

    // Logic formatEmployeeList
    formatEmployeeList(employeeArray, valueKey, valueType = 'number') {
        if (!Array.isArray(employeeArray) || employeeArray.length === 0) {
            return " (không có)";
        }
        return "\n" + employeeArray.map((e, index) => {
            const value = e[valueKey];
            let formattedValue = '';
            if (valueType === 'percent') {
                formattedValue = formatters.formatPercentage(value);
            } else if (valueType === 'currency') {
                formattedValue = formatters.formatRevenue(value) + " tr";
            } else {
                formattedValue = formatters.formatNumberOrDash(value);
            }
            return `${index + 1}. ${formatters.getShortEmployeeName(e.hoTen, e.maNV)}: ${formattedValue} @${e.maNV}`;
        }).join("\n");
    },
    
    // Logic processComposerTemplate
    processComposerTemplate(template, supermarketReport, goals, rankingReportData, competitionData, sectionId) {
        if (!template || !supermarketReport || !goals) {
            return "Lỗi: Dữ liệu không đủ để tạo nhận xét.";
        }

        const tagMapping = {
            'DTQD': { key: 'doanhThuQuyDoi', format: 'currency' },
            'THUNHAP': { key: 'tongThuNhap', format: 'currency' },
            'TLQD': { key: 'hieuQuaQuyDoi', format: 'percent' },
        };

        const botTargetMapping = {
            'TLQD': { dataKey: 'hieuQuaQuyDoi', goalKey: 'phanTramQD', format: 'percent' },
            'TLTC': { dataKey: 'tyLeTraCham', goalKey: 'phanTramTC', format: 'percent' },
            'PK': { dataKey: 'pctPhuKien', goalKey: 'phanTramPhuKien', format: 'percent' },
            'GD': { dataKey: 'pctGiaDung', goalKey: 'phanTramGiaDung', format: 'percent' },
            'MLN': { dataKey: 'pctMLN', goalKey: 'phanTramMLN', format: 'percent' },
            'SIM': { dataKey: 'pctSim', goalKey: 'phanTramSim', format: 'percent' },
            'VAS': { dataKey: 'pctVAS', goalKey: 'phanTramVAS', format: 'percent' },
            'BH': { dataKey: 'pctBaoHiem', goalKey: 'phanTramBaoHiem', format: 'percent' },
        };

        return template.replace(/\[(.*?)\]/g, (match, tag) => {
            const now = new Date();
            const currentDay = now.getDate() || 1;

            let dtThuc = supermarketReport.doanhThu || 0;
            let dtQd = supermarketReport.doanhThuQuyDoi || 0;
            let phanTramHTQD = goals.doanhThuQD > 0 ? (dtQd / 1000000) / goals.doanhThuQD : 0;

            if (sectionId === 'luyke') {
                // Cần đảm bảo element tồn tại trước khi lấy value
                const pasteEl = document.getElementById('paste-luyke');
                const pastedLuyKeData = dataProcessing.parseLuyKePastedData(pasteEl?.value || '');
                
                if (pastedLuyKeData.mainKpis && pastedLuyKeData.mainKpis['Thực hiện DT thực']) {
                    dtThuc = parseFloat(pastedLuyKeData.mainKpis['Thực hiện DT thực'].replace(/,/g, '')) * 1000000;
                }
                if (pastedLuyKeData.mainKpis && pastedLuyKeData.mainKpis['Thực hiện DTQĐ']) {
                    dtQd = parseFloat(pastedLuyKeData.mainKpis['Thực hiện DTQĐ'].replace(/,/g, '')) * 1000000;
                }
                if (pastedLuyKeData.mainKpis && pastedLuyKeData.mainKpis['% HT Target Dự Kiến (QĐ)']) {
                    phanTramHTQD = (parseFloat(pastedLuyKeData.mainKpis['% HT Target Dự Kiến (QĐ)'].replace('%', '')) || 0) / 100;
                }
            }

            if (tag === 'NGAY') return now.toLocaleDateString('vi-VN');
            if (tag === 'GIO') return now.toLocaleTimeString('vi-VN', { hour: '2-digit', minute: '2-digit' });

            if (tag === 'DT_THUC') return formatters.formatNumber(dtThuc / 1000000, 0) + " tr";
            if (tag === 'DTQD') return formatters.formatNumber(dtQd / 1000000, 0) + " tr";
            if (tag === '%HT_DTQD') return formatters.formatPercentage(phanTramHTQD);

            if (tag === 'TLQD') {
                if (sectionId === 'luyke') {
                    const pasteEl = document.getElementById('paste-luyke');
                    const pastedLuyKeData = dataProcessing.parseLuyKePastedData(pasteEl?.value || '');
                    if (pastedLuyKeData.mainKpis && pastedLuyKeData.mainKpis['Thực hiện DT thực'] && pastedLuyKeData.mainKpis['Thực hiện DTQĐ']) {
                        const dtThucPasted = parseFloat(String(pastedLuyKeData.mainKpis['Thực hiện DT thực']).replace(/,/g, ''));
                        const dtQdPasted = parseFloat(String(pastedLuyKeData.mainKpis['Thực hiện DTQĐ']).replace(/,/g, ''));
                        if (dtThucPasted > 0) {
                            return formatters.formatPercentage((dtQdPasted / dtThucPasted) - 1);
                        }
                    }
                }
                return formatters.formatPercentage(supermarketReport.hieuQuaQuyDoi || 0);
            }

            if (tag === '%HT_DTT') {
                const target = parseFloat(goals.doanhThuThuc) || 0;
                const percent = target > 0 ? (dtThuc / 1000000) / target : 0;
                return formatters.formatPercentage(percent);
            }
            if (tag === 'DT_CHUAXUAT') return formatters.formatRevenue(supermarketReport.doanhThuQuyDoiChuaXuat || 0) + " tr";
            if (tag === 'SS_CUNGKY') return supermarketReport.comparisonData?.percentage || 'N/A';

            if (tag.startsWith('TD_')) {
                const total = competitionData?.length || 0;
                const dat = (competitionData || []).filter(d => parseFloat(String(d.hoanThanh).replace('%','')) >= 100).length;
                if (tag === 'TD_TONG_CT') return total;
                if (tag === 'TD_CT_DAT') return dat;
                if (tag === 'TD_CT_CHUADAT') return total - dat;
                if (tag === 'TD_TYLE_DAT') return total > 0 ? formatters.formatPercentage(dat / total) : '0%';
            }

            if (tag === 'TOP_QDC_INFO') {
                if (!supermarketReport.qdc) return " (không có)";
                const qdcArray = Object.values(supermarketReport.qdc).filter(item => item.sl > 0);
                const sortedQDC = qdcArray.sort((a,b) => b.dtqd - a.dtqd);
                return "\n" + sortedQDC.map(item => `  • ${item.name}: SL ${formatters.formatNumber(item.sl)}, TB ${formatters.formatNumber(item.sl / currentDay, 1)}/ngày`).join("\n");
            }
            if (tag === 'TOP_NGANHHANG_SL') {
                if (!supermarketReport.nganhHangChiTiet) return " (không có)";
                const nganhHangArray = Object.values(supermarketReport.nganhHangChiTiet).filter(item => item.quantity > 0);
                const topNganhHang = nganhHangArray.sort((a,b) => b.quantity - a.quantity).slice(0, 10);
                return "\n" + topNganhHang.map(item => `  • ${utils.cleanCategoryName(item.name)}: ${formatters.formatNumber(item.quantity)}`).join("\n");
            }

            const rankingRegex = /^(TOP|BOT)(\d)_(\w+)_([\s\S]+)$/;
            const rankingMatch = tag.match(rankingRegex);
            if (rankingMatch && rankingReportData) {
                const [_, type, count, metric, department] = rankingMatch;
                const cleanDepartment = department.replace(/@msnv$/, '').trim();
                const direction = type === 'TOP' ? 'desc' : 'asc';
                const metricInfo = tagMapping[metric];
                if (metricInfo) {
                    let dataForRanking = rankingReportData;
                    // Nếu là thu nhập, lấy từ masterReportData để có đủ dữ liệu
                    if (metric === 'THUNHAP') {
                         const masterData = get(masterReportData);
                         if (masterData && masterData.sknv.length > 0) {
                            dataForRanking = masterData.sknv;
                         }
                    }
                    const ranking = composerServices.getEmployeeRanking(dataForRanking, metricInfo.key, direction, parseInt(count), cleanDepartment);
                    return composerServices.formatEmployeeList(ranking, metricInfo.key, metricInfo.format);
                }
            }

            const botTargetRegex = /^BOT_TARGET_(\w+)_([\s\S]+)$/;
            const botTargetMatch = tag.match(botTargetRegex);
            if(botTargetMatch && rankingReportData) {
                let [_, metric, department] = botTargetMatch;
                department = department.replace(/@msnv$/, '').trim();
                const metricInfo = botTargetMapping[metric];
                if (metricInfo) {
                    const employeeList = composerServices.getEmployeesBelowTarget(rankingReportData, metricInfo.dataKey, metricInfo.goalKey, department);
                    return composerServices.formatEmployeeList(employeeList, metricInfo.dataKey, metricInfo.format);
                }
            }

            const qdcInfoRegex = /^QDC_INFO_(.+)$/;
            const qdcMatch = tag.match(qdcInfoRegex);
            if(qdcMatch && supermarketReport.qdc){
                const itemName = qdcMatch[1];
                const itemData = Object.values(supermarketReport.qdc).find(i => i.name === itemName);
                return itemData ? `SL ${formatters.formatNumber(itemData.sl)}, TB ${formatters.formatNumber(itemData.sl / currentDay, 1)}/ngày` : '(N/A)';
            }

            const nhInfoRegex = /^NH_INFO_(.+)$/;
            const nhMatch = tag.match(nhInfoRegex);
            if(nhMatch && supermarketReport.nganhHangChiTiet){
                const itemName = nhMatch[1];
                 const itemData = Object.values(supermarketReport.nganhHangChiTiet).find(i => utils.cleanCategoryName(i.name) === itemName);
                return itemData ? `SL ${formatters.formatNumber(itemData.quantity)}, TB ${formatters.formatNumber(itemData.quantity / currentDay, 1)}/ngày` : '(N/A)';
            }

            return match;
        });
    },
};

export const composerService = composerServices;
<<< FILE_END: src/services/composerService.js

>>> FILE_START: src/services/data/cacheHandler.js
import { get } from 'svelte/store';
import { danhSachNhanVien, competitionData, pastedThiDuaReportData, thuongERPData, thuongERPDataThangTruoc } from '../../stores.js';
import { storage } from '../storage.service.js';
import { dataProcessing } from '../dataProcessing.js';
import { adminService } from '../admin.service.js';
import { FILE_MAPPING, LOCAL_DSNV_FILENAME_KEY } from './constants.js';
import { updateSyncState } from './syncHandler.js';

export const cacheHandler = {
    async loadAllFromCache() {
        try { await storage.openDB(); } catch (err) { console.error("Lỗi DB:", err); }

        adminService.loadMappingsGlobal();

        console.log("[DataService] Bắt đầu tải DSNV từ cache...");
        const dsnvData = await storage.getItem('saved_danhsachnv');
        if (dsnvData && dsnvData.length > 0) {
            danhSachNhanVien.set(dsnvData);
            const fileName = localStorage.getItem(LOCAL_DSNV_FILENAME_KEY) || 'DSNV (Cache)';
            updateSyncState('saved_danhsachnv', 'cached', `✓ Đã tải ${dsnvData.length} dòng (Chỉ lưu máy này)`, { fileName });
        } else {
            updateSyncState('saved_danhsachnv', 'error', 'Chưa có DSNV. Vui lòng tải file.', null);
        }
        
        const otherFiles = ['saved_giocong', 'saved_ycx', 'saved_thuongnong', 'saved_ycx_thangtruoc', 'saved_thuongnong_thangtruoc'];
        await Promise.all(otherFiles.map(async (key) => {
            const data = await storage.getItem(key);
            if (data && data.length > 0) {
                FILE_MAPPING[key].store.set(data);
                updateSyncState(key, 'cached', `✓ Đã tải ${data.length} dòng (Local)`, null);
             }
        }));

        console.log("[DataService] Bắt đầu xử lý dữ liệu Paste...");
        try {
            const luykeText = localStorage.getItem('daily_paste_luyke');
            if (luykeText) {
                dataProcessing.parseLuyKePastedData(luykeText);
                dataProcessing.parseCompetitionDataFromLuyKe(luykeText);
                updateSyncState('daily_paste_luyke', 'cached', `(Local)`, null);
            }
            const erpText = localStorage.getItem('daily_paste_thuongerp');
            if (erpText) {
                const data = dataProcessing.processThuongERP(erpText);
                thuongERPData.set(data);
                updateSyncState('daily_paste_thuongerp', 'cached', `(Local)`, null);
            }
            const rawThiDua = localStorage.getItem('raw_paste_thiduanv');
            if (rawThiDua) {
                const parsedData = dataProcessing.parsePastedThiDuaTableData(rawThiDua);
                if (parsedData.success) {
                    const $competitionData = get(competitionData);
                    const processedData = dataProcessing.processThiDuaNhanVienData(parsedData, $competitionData);
                    pastedThiDuaReportData.set(processedData);
                    updateSyncState('daily_paste_thiduanv', 'cached', `(Local)`, null);
                }
            }
            const erpTTText = localStorage.getItem('saved_thuongerp_thangtruoc');
            if (erpTTText) {
                 const data = dataProcessing.processThuongERP(erpTTText);
                 thuongERPDataThangTruoc.set(data);
                 updateSyncState('saved_thuongerp_thangtruoc', 'cached', `(Local)`, null);
            }
        } catch (err) { console.error("Lỗi tải cache paste:", err); }
    }
};
<<< FILE_END: src/services/data/cacheHandler.js

>>> FILE_START: src/services/data/constants.js
import { 
    danhSachNhanVien, rawGioCongData, ycxData, thuongNongData,
    ycxDataThangTruoc, thuongNongDataThangTruoc, thuongERPData, 
    thuongERPDataThangTruoc, competitionData, pastedThiDuaReportData
} from '../../stores.js';
import { dataProcessing } from '../dataProcessing.js';

export const LOCAL_DSNV_FILENAME_KEY = '_localDsnvFilename';

export const FILE_MAPPING = {
    'saved_danhsachnv': { store: danhSachNhanVien, normalizeType: 'danhsachnv', name: 'DS Nhân viên', localOnly: true },
    'saved_giocong': { store: rawGioCongData, normalizeType: 'giocong', name: 'Giờ công' },
    'saved_ycx': { store: ycxData, normalizeType: 'ycx', name: 'YCX Lũy kế' },
    'saved_thuongnong': { store: thuongNongData, normalizeType: 'thuongnong', name: 'Thưởng nóng' },
    'saved_ycx_thangtruoc': { store: ycxDataThangTruoc, normalizeType: 'ycx', name: 'YCX Tháng trước' },
    'saved_thuongnong_thangtruoc': { store: thuongNongDataThangTruoc, normalizeType: 'thuongnong', name: 'Thưởng nóng TT' }
};

export const PASTE_MAPPING = {
    'daily_paste_luyke': { 
        processFunc: dataProcessing.parseCompetitionDataFromLuyKe, 
        store: competitionData,
        isThiDuaNV: false,
        name: 'Data Lũy Kế'
    },
    'daily_paste_thuongerp': { 
        processFunc: dataProcessing.processThuongERP, 
        store: thuongERPData,
        isThiDuaNV: false,
        name: 'Thưởng ERP'
    },
    'saved_thuongerp_thangtruoc': { 
        processFunc: dataProcessing.processThuongERP, 
        store: thuongERPDataThangTruoc,
        isThiDuaNV: false,
        name: 'Thưởng ERP (TT)'
    },
    'daily_paste_thiduanv': { 
        processFunc: dataProcessing.processThiDuaNhanVienData, 
        store: pastedThiDuaReportData,
        isThiDuaNV: true,
        name: 'Thi đua NV'
    }
};
<<< FILE_END: src/services/data/constants.js

>>> FILE_START: src/services/data/fileHandler.js
/* global XLSX */
import { get } from 'svelte/store';
import { 
    selectedWarehouse, 
    currentUser, 
    realtimeYCXData, 
    categoryStructure, 
    brandList, 
    specialProductList 
} from '../../stores.js';
import { dataProcessing } from '../dataProcessing.js';
import { storage, storageService } from '../storage.service.js';
import { datasyncService } from '../datasync.service.js';
import { analyticsService } from '../analytics.service.js';
import { FILE_MAPPING, LOCAL_DSNV_FILENAME_KEY } from './constants.js';
import { updateSyncState } from './syncHandler.js';

// Hàm đọc file Excel thành Workbook
async function _handleFileRead(fileBlob) {
    return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = (event) => {
            try {
                const data = new Uint8Array(event.target.result);
                const workbook = XLSX.read(data, { type: 'array', cellDates: true, cellText: true });
                resolve(workbook);
            } catch (err) { reject(err); }
        };
        reader.onerror = (err) => reject(new Error("Không thể đọc file."));
        reader.readAsArrayBuffer(fileBlob);
    });
}

export const fileHandler = {
    // 1. Xử lý các file dữ liệu chính (DSNV, Giờ công, YCX, Thưởng nóng...)
    async handleFileChange(file, saveKey) {
        const mapping = FILE_MAPPING[saveKey];
        if (!mapping) return { success: false, message: `Lỗi mapping: ${saveKey}` };
        
        updateSyncState(saveKey, 'uploading', 'Đang đọc & chuẩn hóa...');
        
        try {
            const workbook = await _handleFileRead(file);
            const sheetName = workbook.SheetNames[0];
            const rawData = XLSX.utils.sheet_to_json(workbook.Sheets[sheetName], { raw: false, defval: null });
            
            const { normalizedData, success, missingColumns } = dataProcessing.normalizeData(rawData, mapping.normalizeType);
            
            if (!success) {
                updateSyncState(saveKey, 'error', `Thiếu cột: ${missingColumns.join(', ')}`);
                return { success: false, message: `Thiếu cột bắt buộc: ${missingColumns.join(', ')}` };
            }

            // Lưu vào Store
            mapping.store.set(normalizedData);
            
            // Lưu vào IndexedDB (Cache Local)
            await storage.setItem(saveKey, normalizedData); 
            
            // Xử lý riêng cho DSNV (chỉ lưu local)
            if (saveKey === 'saved_danhsachnv') {
                localStorage.setItem(LOCAL_DSNV_FILENAME_KEY, file.name);
                updateSyncState(saveKey, 'cached', `✓ Đã tải ${normalizedData.length} dòng (Local)`, null);
                return { success: true, count: normalizedData.length, message: `Thành công` };
            }

            // Xử lý Upload lên Cloud (nếu đã chọn kho)
            const warehouse = get(selectedWarehouse);
            if (warehouse && !mapping.localOnly) {
                updateSyncState(saveKey, 'uploading', 'Đang tải lên Cloud...');
                try {
                    const path = `warehouse_data/${warehouse}/${saveKey}_${Date.now()}_${file.name}`;
                    const downloadUrl = await storageService.uploadFileToStorage(file, path);
                    
                    const metadata = {
                        downloadURL: downloadUrl,
                        fileName: file.name,
                        fileType: 'excel',
                        rowCount: normalizedData.length,
                        updatedAt: new Date(),
                        updatedBy: get(currentUser)?.email || 'Tôi'
                    };
                    
                    await datasyncService.saveWarehouseMetadata(warehouse, saveKey, metadata);
                    updateSyncState(saveKey, 'synced', `✓ Đã đồng bộ`, metadata);
                } catch (e) {
                    console.error("Lỗi upload cloud:", e);
                    updateSyncState(saveKey, 'error', `Lỗi lưu Cloud: ${e.message}`, null);
                    // Không return false ở đây vì dữ liệu local đã ok
                }
            } else {
                 updateSyncState(saveKey, 'synced', `✓ Đã tải ${normalizedData.length} dòng`, null);
            }
            
            analyticsService.trackAction();
            return { success: true, count: normalizedData.length, message: `Thành công` };

        } catch (err) {
            console.error(err);
            updateSyncState(saveKey, 'error', `Lỗi: ${err.message}`, null);
            return { success: false, message: `Lỗi xử lý file: ${err.message}` };
        }
    },

    // 2. Xử lý file Realtime (Tương tự YCX nhưng lưu vào store riêng)
    async handleRealtimeFileInput(event) {
        const file = event.target.files[0];
        if (!file) return;

        console.log("[FileHandler] Bắt đầu xử lý Realtime:", file.name);
        
        try {
            const workbook = await _handleFileRead(file);
            const sheetName = workbook.SheetNames[0];
            const rawData = XLSX.utils.sheet_to_json(workbook.Sheets[sheetName], { raw: false, defval: null });

            // Tái sử dụng logic chuẩn hóa của 'ycx' vì cấu trúc file giống nhau
            const { normalizedData, success, missingColumns } = dataProcessing.normalizeData(rawData, 'ycx');

            if (!success) {
                alert(`File thiếu cột: ${missingColumns.join(', ')}`);
                return;
            }

            // Cập nhật store
            realtimeYCXData.set(normalizedData);
            
            // Ghi nhận analytics
            analyticsService.trackAction();
            
            console.log(`[FileHandler] Đã nạp ${normalizedData.length} dòng realtime.`);
            // Reset input
            event.target.value = null;

        } catch (error) {
            console.error("Lỗi xử lý Realtime:", error);
            alert("Lỗi đọc file Realtime: " + error.message);
        }
    },

    // 3. Xử lý file Cấu trúc Ngành hàng (Admin)
    async handleCategoryFile(event) {
        const file = event.target.files[0];
        if (!file) return;

        try {
            const workbook = await _handleFileRead(file);
            const sheetName = workbook.SheetNames[0];
            const rawData = XLSX.utils.sheet_to_json(workbook.Sheets[sheetName], { raw: false, defval: null });

            const { success, normalizedData, error } = dataProcessing.normalizeCategoryStructureData(rawData);
            
            if (!success) {
                throw new Error(error);
            }

            // Cập nhật Store
            categoryStructure.set(normalizedData);
            
            // Tách danh sách Hãng (Brand) từ dữ liệu
            const brands = [...new Set(normalizedData.map(i => i.nhaSanXuat).filter(Boolean))].sort();
            brandList.set(brands);

            console.log(`[FileHandler] Đã nạp ${normalizedData.length} dòng cấu trúc & ${brands.length} hãng.`);
            
            // Reset input
            event.target.value = null;
            return { success: true, count: normalizedData.length };

        } catch (err) {
            console.error("Lỗi file cấu trúc:", err);
            throw err;
        }
    },

    // 4. Xử lý file Sản phẩm Đặc quyền (Admin)
    async handleSpecialProductFileUpload(event) {
        const file = event.target.files[0];
        if (!file) return;

        try {
            const workbook = await _handleFileRead(file);
            const sheetName = workbook.SheetNames[0];
            const rawData = XLSX.utils.sheet_to_json(workbook.Sheets[sheetName], { raw: false, defval: null });

            const { success, normalizedData, error } = dataProcessing.normalizeSpecialProductData(rawData);

            if (!success) {
                throw new Error(error);
            }

            specialProductList.set(normalizedData);
            console.log(`[FileHandler] Đã nạp ${normalizedData.length} SPĐQ.`);
            
            event.target.value = null;
            return { success: true, count: normalizedData.length };

        } catch (err) {
            console.error("Lỗi file SPĐQ:", err);
            throw err;
        }
    },

    // 5. Tải file mẫu
    async handleTemplateDownload() {
        try {
            const url = await storageService.getTemplateDownloadURL();
            if (url) {
                const a = document.createElement('a');
                a.href = url;
                a.target = "_blank";
                a.download = "Template_DSNV.xlsx";
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
            } else {
                alert("Không tìm thấy link tải mẫu.");
            }
        } catch (e) {
            console.error("Lỗi tải template:", e);
            alert("Lỗi khi lấy link tải mẫu: " + e.message);
        }
    }
};
<<< FILE_END: src/services/data/fileHandler.js

>>> FILE_START: src/services/data/pasteHandler.js
import { get } from 'svelte/store';
import { selectedWarehouse, currentUser, competitionData, pastedThiDuaReportData } from '../../stores.js';
import { dataProcessing } from '../dataProcessing.js';
import { storageService } from '../storage.service.js';
import { datasyncService } from '../datasync.service.js';
import { analyticsService } from '../analytics.service.js';
import { PASTE_MAPPING } from './constants.js';
import { updateSyncState } from './syncHandler.js';

export const pasteHandler = {
    async handlePasteChange(pastedText, saveKeyPaste, saveKeyRaw, saveKeyProcessed) {
        const primaryKey = saveKeyProcessed || saveKeyPaste;
        const mapping = PASTE_MAPPING[primaryKey];
        if (!mapping) return { success: false, message: `Lỗi mapping paste` };
        
        updateSyncState(saveKeyPaste, 'uploading', 'Đang xử lý...');
        try {
            let processedData;
            let processedCount = 0;
            if (mapping.isThiDuaNV) {
                const parsedData = dataProcessing.parsePastedThiDuaTableData(pastedText);
                if (!parsedData.success) throw new Error(parsedData.error);
                dataProcessing.updateCompetitionNameMappings(parsedData.mainHeaders);
                const $competitionData = get(competitionData);
                processedData = dataProcessing.processThiDuaNhanVienData(parsedData, $competitionData);
                mapping.store.set(processedData);
                localStorage.setItem(saveKeyRaw, pastedText);
                localStorage.setItem(saveKeyProcessed, JSON.stringify(processedData));
                processedCount = processedData.length;
            } else if (mapping.processFunc) {
                processedData = mapping.processFunc(pastedText);
                mapping.store.set(processedData);
                localStorage.setItem(saveKeyPaste, pastedText);
                processedCount = processedData?.length || 0;
                if (saveKeyPaste === 'daily_paste_luyke') {
                     const comps = dataProcessing.parseCompetitionDataFromLuyKe(pastedText);
                     dataProcessing.parseLuyKePastedData(pastedText);
                     processedCount = comps.length;
                }
            }
            const warehouse = get(selectedWarehouse);
            if (warehouse) {
                try {
                    updateSyncState(saveKeyPaste, 'uploading', 'Đang lưu Cloud...');
                    const blob = new Blob([pastedText], { type: 'text/plain' });
                    const path = `warehouse_data/${warehouse}/${primaryKey}_${Date.now()}.txt`;
                    const downloadUrl = await storageService.uploadFileToStorage(blob, path);
                    const metadata = {
                        downloadURL: downloadUrl,
                        fileName: 'du_lieu_dan.txt',
                        fileType: 'text',
                        rowCount: processedCount, 
                        updatedAt: new Date(),
                        updatedBy: get(currentUser)?.email || 'Tôi'
                    };
                    await datasyncService.saveWarehouseMetadata(warehouse, primaryKey, metadata);
                    updateSyncState(saveKeyPaste, 'synced', `✓ Đã đồng bộ`, metadata);
                } catch (e) {
                    console.error("Cloud paste upload error:", e);
                    updateSyncState(saveKeyPaste, 'error', `Lỗi đồng bộ Cloud: ${e.message}`);
                }
            } else {
                 updateSyncState(saveKeyPaste, 'cached', `✓ Đã xử lý (Local)`, null);
            }
            analyticsService.trackAction();
            return { success: true, message: `Thành công` };
        } catch (err) {
            updateSyncState(saveKeyPaste, 'error', `Lỗi: ${err.message}`);
            return { success: false, message: `Lỗi: ${err.message}` };
        }
    }
};
<<< FILE_END: src/services/data/pasteHandler.js

>>> FILE_START: src/services/data/syncHandler.js
/* global XLSX */
import { get } from 'svelte/store';
import { fileSyncState, selectedWarehouse, currentUser, competitionData, pastedThiDuaReportData, thuongERPData, thuongERPDataThangTruoc } from '../../stores.js';
import { datasyncService } from '../datasync.service.js';
import { storage } from '../storage.service.js';
import { dataProcessing } from '../dataProcessing.js';
import { FILE_MAPPING, PASTE_MAPPING } from './constants.js';

export function updateSyncState(key, status, message, metadata = null) {
    fileSyncState.update(s => ({
        ...s,
        [key]: { status, message, metadata, timestamp: Date.now() }
    }));
}

export function formatTimeAgo(dateInput) {
    if (!dateInput) return '';
    const date = dateInput.toDate ? dateInput.toDate() : new Date(dateInput);
    const seconds = Math.floor((new Date() - date) / 1000);
    
    let interval = seconds / 3600;
    if (interval > 1) return Math.floor(interval) + " giờ trước";
    interval = seconds / 60;
    if (interval > 1) return Math.floor(interval) + " phút trước";
    return "vừa xong";
}

export const syncHandler = {
    async syncDownFromCloud(warehouse) {
        if (!warehouse) return { success: false, message: "Chưa chọn kho." };
        console.log(`[DataService] Bắt đầu đồng bộ kho ${warehouse}...`);
        
        for (const key of Object.keys(FILE_MAPPING)) {
            if (!FILE_MAPPING[key].localOnly) updateSyncState(key, 'checking', 'Đang kiểm tra...', null);
        }
        for (const key of Object.keys(PASTE_MAPPING)) {
            updateSyncState(key, 'checking', 'Đang kiểm tra...', null);
        }

        try {
            const cloudData = await datasyncService.loadWarehouseData(warehouse);
            if (!cloudData) {
                 return { success: true, message: "Kho chưa có dữ liệu trên Cloud." };
            }
            const userEmail = get(currentUser)?.email;

            // Xử lý File Excel
            for (const [key, mapping] of Object.entries(FILE_MAPPING)) {
                if (mapping.localOnly) continue;
                const cloudMeta = cloudData[key];
                const localMetaStr = localStorage.getItem(`_meta_${warehouse}_${key}`);
                const localMeta = localMetaStr ? JSON.parse(localMetaStr) : {};
                if (!cloudMeta) continue;

                const timeAgo = formatTimeAgo(cloudMeta.updatedAt);
                const isMyUpload = cloudMeta.updatedBy === userEmail;
                const isNewer = (cloudMeta.timestamp || 0) > (localMeta.timestamp || 0);
                const currentStoreData = get(mapping.store);
                const isStoreEmpty = !currentStoreData || currentStoreData.length === 0;

                if (isNewer) {
                     const msg = isMyUpload ? `Có bản mới từ bạn ${timeAgo}` : `Có cập nhật mới từ ${cloudMeta.updatedBy} ${timeAgo}`;
                    updateSyncState(key, 'update_available', msg, cloudMeta);
                } else {
                    if (isStoreEmpty) {
                        console.log(`[Auto-Download] ${key} đã đồng bộ metadata nhưng Store rỗng. Đang tự tải về...`);
                        updateSyncState(key, 'downloading', 'Đang tự động tải về...', cloudMeta);
                        await this.downloadFileFromCloud(key);
                    } else {
                         updateSyncState(key, 'synced', `✓ Đã đồng bộ ${timeAgo} (${cloudMeta.rowCount || 0} dòng)`, cloudMeta);
                    }
                }
            }

            // Xử lý Paste Data
            for (const [key, mapping] of Object.entries(PASTE_MAPPING)) {
                const cloudMeta = cloudData[key]; 
                const localMetaStr = localStorage.getItem(`_meta_${warehouse}_${key}`);
                const localMeta = localMetaStr ? JSON.parse(localMetaStr) : {};
                if (cloudMeta) {
                    const timeAgo = formatTimeAgo(cloudMeta.updatedAt);
                    const isMyUpload = cloudMeta.updatedBy === userEmail;
                    const isNewer = (cloudMeta.timestamp || 0) > (localMeta.timestamp || 0);
                    let uiKey = key;
                    if (isNewer) {
                         const msg = isMyUpload ? `Có bản mới từ bạn ${timeAgo}` : `Có cập nhật mới từ ${cloudMeta.updatedBy} ${timeAgo}`;
                         updateSyncState(uiKey, 'update_available', msg, cloudMeta);
                    } else {
                         const currentStoreData = get(mapping.store);
                         const isStoreEmpty = !currentStoreData || currentStoreData.length === 0;
                         if (isStoreEmpty) {
                              console.log(`[Auto-Download] ${uiKey} (Paste) đã đồng bộ metadata nhưng Store rỗng. Đang tự tải...`);
                              updateSyncState(uiKey, 'downloading', 'Đang tự tải...', cloudMeta);
                              await this.downloadFileFromCloud(uiKey);
                         } else {
                              updateSyncState(uiKey, 'synced', `✓ Đã đồng bộ ${timeAgo}`, cloudMeta);
                         }
                    }
                }
            }
            return { success: true, message: `Đã kiểm tra dữ liệu kho ${warehouse}.` };
        } catch (error) {
            console.error("Sync error:", error);
            return { success: false, message: "Lỗi kết nối Cloud: " + error.message };
        }
    },

    async downloadFileFromCloud(key) {
        const state = get(fileSyncState)[key];
        const warehouse = get(selectedWarehouse);
        if (!state?.metadata?.downloadURL || !warehouse) return;
        
        updateSyncState(key, 'downloading', 'Đang tải xuống...', state.metadata);
        
        try {
            const response = await fetch(state.metadata.downloadURL);
            
            if (FILE_MAPPING[key]) {
                const blob = await response.blob();
                const workbook = await new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                         const data = new Uint8Array(e.target.result);
                         resolve(XLSX.read(data, { type: 'array', cellDates: true, cellText: true }));
                    };
                    reader.onerror = reject;
                    reader.readAsArrayBuffer(blob);
                });
                const rawData = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]], { raw: false, defval: null });
                const mapping = FILE_MAPPING[key];
                const { normalizedData } = dataProcessing.normalizeData(rawData, mapping.normalizeType);
                mapping.store.set(normalizedData);
                await storage.setItem(key, normalizedData);
                const metaToSave = { ...state.metadata, timestamp: state.metadata.timestamp || Date.now() };
                localStorage.setItem(`_meta_${warehouse}_${key}`, JSON.stringify(metaToSave));
                const timeAgo = formatTimeAgo(state.metadata.updatedAt);
                updateSyncState(key, 'synced', `✓ Đã đồng bộ ${timeAgo} (${normalizedData.length} dòng)`, state.metadata);
            
            } else if (PASTE_MAPPING[key]) {
                const textContent = await response.text();
                const mapping = PASTE_MAPPING[key];
                let processedCount = 0;
                
                if (mapping.isThiDuaNV) {
                     localStorage.setItem('raw_paste_thiduanv', textContent);
                    const parsedData = dataProcessing.parsePastedThiDuaTableData(textContent);
                    if (parsedData.success) {
                        dataProcessing.updateCompetitionNameMappings(parsedData.mainHeaders);
                        const $competitionData = get(competitionData);
                        const processedData = dataProcessing.processThiDuaNhanVienData(parsedData, $competitionData);
                        mapping.store.set(processedData);
                        processedCount = processedData.length;
                        localStorage.setItem('daily_paste_thiduanv', JSON.stringify(processedData)); 
                    }
                } else if (mapping.processFunc) {
                     const processedData = mapping.processFunc(textContent);
                    mapping.store.set(processedData);
                    processedCount = processedData?.length || 0;
                    localStorage.setItem(key, textContent);
                    if (key === 'daily_paste_luyke') {
                         const comps = dataProcessing.parseCompetitionDataFromLuyKe(textContent);
                         dataProcessing.parseLuyKePastedData(textContent);
                         processedCount = comps.length;
                    }
                }
                const metaToSave = { 
                    ...state.metadata, 
                    timestamp: state.metadata.timestamp || Date.now(),
                    rowCount: processedCount 
                };
                localStorage.setItem(`_meta_${warehouse}_${key}`, JSON.stringify(metaToSave));
                const timeAgo = formatTimeAgo(state.metadata.updatedAt);
                updateSyncState(key, 'synced', `✓ Đã đồng bộ ${timeAgo}`, metaToSave);
                window.dispatchEvent(new CustomEvent('cloud-paste-loaded', { detail: { key, text: textContent } }));
            }
            return { success: true };
        } catch (e) {
            console.error(e);
            updateSyncState(key, 'error', 'Lỗi tải file: ' + e.message, state.metadata);
            return { success: false, message: e.message };
        }
    }
};
<<< FILE_END: src/services/data/syncHandler.js

>>> FILE_START: src/services/dataProcessing.js
// src/services/dataProcessing.js
// Version 3.0 - Modular Facade
// File này đóng vai trò tập hợp các hàm từ thư mục processing/
// Giúp giữ nguyên API cũ để không làm hỏng các component đang sử dụng.

import { helpers } from './processing/helpers.js';
import { normalizers } from './processing/normalizers.js';
import { parsers } from './processing/parsers.js';
import { processors } from './processing/processors.js';

export const dataProcessing = {
    // --- Helpers ---
    findColumnName: helpers.findColumnName,
    getHinhThucXuatTinhDoanhThu: helpers.getHinhThucXuatTinhDoanhThu,
    getHinhThucXuatTraGop: helpers.getHinhThucXuatTraGop,
    getHeSoQuyDoi: helpers.getHeSoQuyDoi,
    _cleanCompetitionName: helpers.cleanCompetitionName,
    classifyInsurance: helpers.classifyInsurance,
    _findHeaderAndProcess: helpers.findHeaderAndProcess, // Public alias cho processors dùng

    // --- Normalizers ---
    normalizeData: normalizers.normalizeData,
    normalizeCategoryStructureData: normalizers.normalizeCategoryStructureData,
    normalizeSpecialProductData: normalizers.normalizeSpecialProductData,
    normalizeBrandData: normalizers.normalizeBrandData,

    // --- Parsers ---
    processThuongERP: parsers.processThuongERP,
    parseLuyKePastedData: parsers.parseLuyKePastedData,
    parseCompetitionDataFromLuyKe: parsers.parseCompetitionDataFromLuyKe,
    parsePastedThiDuaTableData: parsers.parsePastedThiDuaTableData,

    // --- Processors ---
    debugCompetitionFiltering: processors.debugCompetitionFiltering,
    updateCompetitionNameMappings: processors.updateCompetitionNameMappings,
    processThiDuaNhanVienData: processors.processThiDuaNhanVienData,
    processGioCongData: processors.processGioCongData,
    processThiDuaVungFile: processors.processThiDuaVungFile
};
<<< FILE_END: src/services/dataProcessing.js

>>> FILE_START: src/services/dataService.js
// src/services/dataService.js
import { fileHandler } from './data/fileHandler.js';
import { pasteHandler } from './data/pasteHandler.js';
import { syncHandler } from './data/syncHandler.js';
import { cacheHandler } from './data/cacheHandler.js';
// [NEW] Import thêm để xử lý load config
import { datasyncService } from './datasync.service.js';
import { localCompetitionConfigs, specialProductList } from '../stores.js';

export const dataService = {
    appController: null,
    init(controller) { this.appController = controller; },

    // --- File Handlers ---
    handleFileChange: (file, key) => fileHandler.handleFileChange(file, key),
    handleRealtimeFileInput: (event) => fileHandler.handleRealtimeFileInput(event),
    handleCategoryFile: (event) => fileHandler.handleCategoryFile(event),
    handleSpecialProductFileUpload: (event) => fileHandler.handleSpecialProductFileUpload(event),
    handleTemplateDownload: () => fileHandler.handleTemplateDownload(),

    // --- Paste Handlers ---
    handlePasteChange: (text, key1, key2, key3) => pasteHandler.handlePasteChange(text, key1, key2, key3),

    // --- Sync & Cache ---
    syncDownFromCloud: (wh) => syncHandler.syncDownFromCloud(wh),
    downloadFileFromCloud: (key) => syncHandler.downloadFileFromCloud(key),
    loadAllFromCache: () => cacheHandler.loadAllFromCache(),

    _getSavedMetadata(warehouse, dataType) { return null; },

    // [NEW] Hàm tải toàn bộ cấu hình phụ trợ của Kho (Thi đua, SPĐQ...)
    // Hàm này sẽ được gọi khi chọn Kho
    async loadWarehouseSettings(warehouse) {
        if (!warehouse) return;
        console.log(`[DataService] Loading settings for warehouse: ${warehouse}`);
        
        try {
            // 1. Tải cấu hình Thi đua (User)
            const competitions = await datasyncService.loadCompetitionConfigs(warehouse);
            if (competitions) {
                localCompetitionConfigs.set(competitions);
                console.log(`[DataService] Loaded ${competitions.length} competitions.`);
            } else {
                localCompetitionConfigs.set([]);
            }

            // 2. Tải danh sách SPĐQ (nếu có lưu theo kho - logic mở rộng)
            // const spList = await datasyncService.loadSpecialPrograms(warehouse);
            // ...

        } catch (error) {
            console.error("[DataService] Error loading warehouse settings:", error);
        }
    }
};
<<< FILE_END: src/services/dataService.js

>>> FILE_START: src/services/datasync.service.js
// src/services/datasync.service.js
import { doc, setDoc, getDoc, serverTimestamp } from "firebase/firestore"; 
import { firebaseStore, currentUser } from '../stores.js'; 
import { get } from 'svelte/store';

const getDB = () => {
    const fb = get(firebaseStore);
    return fb.db;
};

const getCurrentUserEmail = () => {
    const user = get(currentUser);
    return user ? user.email : 'unknown';
};

export const datasyncService = {
    // --- MỤC TIÊU (GOALS) ---
    // Lưu cấu hình mục tiêu (Lũy kế + Realtime) cho kho
    async saveGoalSettings(kho, type, settings) {
        const db = getDB();
        if (!db || !kho) return;

        // type: 'luyke' hoặc 'realtime'
        const fieldName = type === 'luyke' ? 'luykeGoals' : 'realtimeGoals';

        const khoRef = doc(db, "warehouseData", kho);
        try {
            await setDoc(khoRef, {
                [fieldName]: settings,
                [`${fieldName}UpdatedAt`]: serverTimestamp(),
                [`${fieldName}UpdatedBy`]: getCurrentUserEmail()
            }, { merge: true });
            console.log(`[DataSync] Đã lưu mục tiêu ${type} cho kho ${kho}`);
        } catch (error) {
            console.error(`[DataSync] Lỗi lưu mục tiêu ${type}:`, error);
        }
    },

    // Tải cấu hình mục tiêu
    async loadGoalSettings(kho) {
        const db = getDB();
        if (!db || !kho) return { luyke: {}, realtime: {} };

        const khoRef = doc(db, "warehouseData", kho);
        try {
            const docSnap = await getDoc(khoRef);
            if (docSnap.exists()) {
                const data = docSnap.data();
                return {
                    luyke: data.luykeGoals || {},
                    realtime: data.realtimeGoals || {}
                };
            }
            return { luyke: {}, realtime: {} };
        } catch (e) {
            console.error("[DataSync] Lỗi tải mục tiêu:", e);
            return { luyke: {}, realtime: {} };
        }
    },

    // --- CÁC HÀM KHÁC (GIỮ NGUYÊN) ---
    async saveQdcConfig(kho, config) {
        const db = getDB();
        if (!db || !kho) return;
        const khoRef = doc(db, "warehouseData", kho);
        try {
            await setDoc(khoRef, {
                qdcConfig: config,
                qdcConfigUpdatedAt: serverTimestamp(),
                qdcConfigUpdatedBy: getCurrentUserEmail()
            }, { merge: true });
        } catch (error) { console.error(error); }
    },

    async loadQdcConfig(kho) {
        const db = getDB();
        if (!db || !kho) return null;
        const khoRef = doc(db, "warehouseData", kho);
        try {
            const docSnap = await getDoc(khoRef);
            return (docSnap.exists() && docSnap.data().qdcConfig) ? docSnap.data().qdcConfig : null;
        } catch (e) { return null; }
    },

    async saveRealtimeHiddenCategories(kho, hiddenList) {
        const db = getDB();
        if (!db || !kho) return;
        const khoRef = doc(db, "warehouseData", kho);
        try {
            await setDoc(khoRef, {
                realtimeConfig: { hiddenCategories: hiddenList, updatedAt: serverTimestamp(), updatedBy: getCurrentUserEmail() }
            }, { merge: true });
        } catch (error) { console.error(error); }
    },

    async loadRealtimeHiddenCategories(kho) {
        const db = getDB();
        if (!db || !kho) return [];
        const khoRef = doc(db, "warehouseData", kho);
        try {
            const docSnap = await getDoc(khoRef);
            return (docSnap.exists() && docSnap.data().realtimeConfig) ? docSnap.data().realtimeConfig.hiddenCategories || [] : [];
        } catch (e) { return []; }
    },

    async savePersonalRevenueTables(kho, tables) {
        const db = getDB();
        if (!db || !kho) return;
        const personalTables = tables.filter(t => !t.isSystem);
        const khoRef = doc(db, "warehouseData", kho);
        try { await setDoc(khoRef, { personalRevenueTables: personalTables, updatedAt: serverTimestamp() }, { merge: true }); } catch (error) { throw error; }
    },

    async loadPersonalRevenueTables(kho) {
        const db = getDB();
        if (!db || !kho) return [];
        const khoRef = doc(db, "warehouseData", kho);
        try { const docSnap = await getDoc(khoRef); return docSnap.exists() ? (docSnap.data().personalRevenueTables || []) : []; } catch(e) { return []; }
    },

    // --- [NEW] BẢNG HIỆU QUẢ CÁ NHÂN ---
    async savePersonalPerformanceTables(kho, tables) {
        const db = getDB();
        if (!db || !kho) return;
        const personalTables = tables.filter(t => !t.isSystem);
        const khoRef = doc(db, "warehouseData", kho);
        try { 
            await setDoc(khoRef, { 
                personalPerformanceTables: personalTables, 
                updatedAt: serverTimestamp() 
            }, { merge: true }); 
        } catch (error) { throw error; }
    },

    async loadPersonalPerformanceTables(kho) {
        const db = getDB();
        if (!db || !kho) return [];
        const khoRef = doc(db, "warehouseData", kho);
        try { 
            const docSnap = await getDoc(khoRef); 
            return docSnap.exists() ? (docSnap.data().personalPerformanceTables || []) : []; 
        } catch(e) { 
            console.error("Lỗi tải bảng hiệu quả cá nhân:", e);
            return []; 
        }
    },
    // --- END NEW ---

    async saveCustomMetrics(kho, metrics) {
        const db = getDB();
        if (!db || !kho) return;
        const khoRef = doc(db, "warehouseData", kho);
        try { await setDoc(khoRef, { customMetrics: metrics, updatedAt: serverTimestamp() }, { merge: true }); } catch (error) { throw error; }
    },

    async loadCustomMetrics(kho) {
        const db = getDB();
        if (!db || !kho) return [];
        const khoRef = doc(db, "warehouseData", kho);
        try { const docSnap = await getDoc(khoRef); return docSnap.exists() ? (docSnap.data().customMetrics || []) : []; } catch(e) { return []; }
    },

    async saveMetadataToFirestore(kho, dataType, metadata) {
        const db = getDB();
        if (!db || !kho) throw new Error("Invalid parameters.");
        const khoRef = doc(db, "warehouseData", kho);
        const dataToSave = { [dataType]: { ...metadata, updatedAt: serverTimestamp(), updatedBy: getCurrentUserEmail() } };
        try { await setDoc(khoRef, dataToSave, { merge: true }); } catch(e) { throw e; }
    },

    async savePastedDataToFirestore(kho, dataType, content, versionInfo) {
        const db = getDB();
        if (!db || !kho) throw new Error("Invalid parameters.");
        const khoRef = doc(db, "warehouseData", kho);
        const dataToSave = { [dataType]: { content, ...versionInfo, updatedAt: serverTimestamp(), updatedBy: getCurrentUserEmail() } };
        try { await setDoc(khoRef, dataToSave, { merge: true }); } catch(e) { throw e; }
    },

    async saveCompetitionConfigs(kho, configs) {
        const db = getDB();
        if (!db || !kho) return;
        const khoRef = doc(db, "warehouseData", kho);
        try { await setDoc(khoRef, { competitionConfigs: configs, updatedAt: serverTimestamp() }, { merge: true }); } catch (error) { throw error; }
    },

    async loadCompetitionConfigs(kho) {
        const db = getDB();
        if (!db || !kho) return [];
        const khoRef = doc(db, "warehouseData", kho);
        try { const docSnap = await getDoc(khoRef); return docSnap.exists() ? (docSnap.data().competitionConfigs || []) : []; } catch(e) { return []; }
    },

    async saveSpecialPrograms(kho, programs) {
        const db = getDB();
        if (!db || !kho) return;
        const khoRef = doc(db, "warehouseData", kho);
        try { await setDoc(khoRef, { specialPrograms: programs, updatedAt: serverTimestamp() }, { merge: true }); } catch (error) { throw error; }
    },

    async saveWarehouseMetadata(kho, key, metadata) {
        const db = getDB();
        if (!db || !kho) return;
        const khoRef = doc(db, "warehouseData", kho);
        const dataToSave = { [key]: { ...metadata, updatedAt: serverTimestamp(), updatedBy: getCurrentUserEmail() } };
        try { await setDoc(khoRef, dataToSave, { merge: true }); } catch (error) { throw error; }
    },

    async loadWarehouseData(kho) {
        const db = getDB();
        if (!db || !kho) return null;
        const khoRef = doc(db, "warehouseData", kho);
        try { const docSnap = await getDoc(khoRef); return docSnap.exists() ? docSnap.data() : null; } catch (error) { throw error; }
    }
};
<<< FILE_END: src/services/datasync.service.js

>>> FILE_START: src/services/declarations/category.service.js
import { doc, setDoc, getDoc } from "firebase/firestore";
import { 
    macroCategoryConfig, 
    macroProductGroupConfig, 
    categoryNameMapping, 
    groupNameMapping,
    brandNameMapping,
    categoryStructure, 
    brandList,
    efficiencyConfig,
    qdcConfigStore,
    competitionNameMappings
} from '../../stores.js';
import { getDB, notify, sanitizeForFirestore, checkAdmin } from './utils.js';

export const categoryService = {
    // --- CATEGORY & BRAND STRUCTURE ---
    async saveCategoryDataToFirestore(data) {
        const db = getDB();
        if (!db) { notify("Lỗi kết nối CSDL!", "error"); return; }
        if (!checkAdmin()) return;
        try {
            const categoryRef = doc(db, "declarations", "categoryStructure");
            await setDoc(categoryRef, { data: sanitizeForFirestore(data.categories || []) });
            const brandRef = doc(db, "declarations", "brandList");
            await setDoc(brandRef, { data: sanitizeForFirestore(data.brands || []) });
            notify('Đồng bộ dữ liệu khai báo thành công!', 'success');
        } catch (error) { 
            console.error("Error saving category data:", error);
            notify('Lỗi khi đồng bộ dữ liệu lên cloud.', 'error'); 
        }
    },

    async loadCategoryDataFromFirestore() {
        const db = getDB();
        if (!db) return { categories: [], brands: [] };
        
        try {
            const catRef = doc(db, "declarations", "categoryStructure");
            const brandRef = doc(db, "declarations", "brandList");
            const [catSnap, brandSnap] = await Promise.all([getDoc(catRef), getDoc(brandRef)]);
            const getArray = (snap) => {
                if (!snap.exists()) return [];
                const d = snap.data();
                return d.data || d.items || d.list || [];
            };
            const categories = getArray(catSnap);
            const brands = getArray(brandSnap);
            
            categoryStructure.set(categories);
            brandList.set(brands);
            return { categories, brands };
        } catch (error) {
            console.error("Error loading category data:", error);
            return { categories: [], brands: [] };
        }
    },

    // --- MAPPINGS & CONFIGS GLOBAL (LOAD ALL) ---
    async loadMappingsGlobal() {
        const db = getDB();
        if (!db) return;
        try {
            console.log("[declarations.category] Đang tải cấu hình Mapping & Data từ Cloud...");
            const safeGet = (docSnap, defaultVal = []) => {
                if (!docSnap.exists()) return defaultVal;
                const d = docSnap.data();
                return d.data || d.items || d.mappings || d.configs || d.list || defaultVal;
            };
            const docsToLoad = [
                "macroCategoryConfig", "macroProductGroupConfig", "categoryNameMapping", 
                "groupNameMapping", "brandNameMapping", "efficiencyConfig", 
                "qdcConfig", "competitionNameMappings", "categoryStructure", "brandList"
            ];
            const promises = docsToLoad.map(id => getDoc(doc(db, "declarations", id)));
            const results = await Promise.all(promises);
            
            macroCategoryConfig.set(safeGet(results[0]));
            macroProductGroupConfig.set(safeGet(results[1]));
            categoryNameMapping.set(safeGet(results[2], {}));
            groupNameMapping.set(safeGet(results[3], {}));
            brandNameMapping.set(safeGet(results[4], {}));
            efficiencyConfig.set(safeGet(results[5])); 
            qdcConfigStore.set(safeGet(results[6]));
            competitionNameMappings.set(safeGet(results[7], {}));
            categoryStructure.set(safeGet(results[8]));
            brandList.set(safeGet(results[9]));

            console.log("[declarations.category] Đã tải xong Mapping & Configs.");
        } catch (error) {
            console.error("Error loading mappings:", error);
        }
    },

    // --- MACRO CONFIGS ---
    async saveMacroCategoryConfig(data) {
        const db = getDB();
        if (!db) { notify("Lỗi kết nối CSDL!", "error"); return; }
        if (!checkAdmin()) return;
        try {
            const docRef = doc(db, "declarations", "macroCategoryConfig");
            await setDoc(docRef, { data: sanitizeForFirestore(data) });
            notify('Đã lưu Cấu hình Nhóm Ngành Hàng lớn!', 'success');
        } catch (error) { console.error(error); notify('Lỗi lưu cấu hình: ' + error.message, 'error'); }
    },

    async loadMacroCategoryConfig() {
        const db = getDB();
        const defaultData = [
            { id: 'macro_dt', name: 'ĐIỆN TỬ', items: ['dt_tivi', 'dt_loa', 'Tivi', 'Loa', 'Dàn âm thanh', 'Tivi - Loa - Dàn máy'] },
            { id: 'macro_dl', name: 'ĐIỆN LẠNH', items: ['dl_maylanh', 'dl_tulanh', 'dl_maygiat', 'Tủ lạnh', 'Máy lạnh', 'Máy giặt', 'Tủ đông', 'Tủ mát'] },
            { id: 'macro_gd', name: 'GIA DỤNG', items: ['gd_quat', 'gd_noi', 'Gia dụng', 'Quạt', 'Nồi cơm', 'Bếp', 'Máy xay', 'Máy ép'] },
            { id: 'macro_ict', name: 'ICT', items: ['ict_laptop', 'ict_phone', 'Laptop', 'Điện thoại', 'Tablet', 'Phụ kiện', 'Máy tính bảng'] }
        ];
        if (!db) return defaultData;
        try {
            const docRef = doc(db, "declarations", "macroCategoryConfig");
            const docSnap = await getDoc(docRef);
            if (docSnap.exists()) {
                const d = docSnap.data();
                const data = d.data || d.items || d.config || [];
                if (data.length > 0) return data;
            }
            return defaultData;
        } catch (e) { console.error("Lỗi tải macroCategoryConfig:", e); return defaultData; }
    },

    async saveMacroProductGroupConfig(data) {
        const db = getDB();
        if (!db) { notify("Lỗi kết nối CSDL!", "error"); return; }
        if (!checkAdmin()) return;
        try {
            const docRef = doc(db, "declarations", "macroProductGroupConfig");
            await setDoc(docRef, { data: sanitizeForFirestore(data) });
            notify('Đã lưu Cấu hình Nhóm Hàng Lớn!', 'success');
        } catch (error) { console.error(error); notify('Lỗi lưu cấu hình: ' + error.message, 'error'); }
    },

    async loadMacroProductGroupConfig() {
        const db = getDB();
        const defaultData = [];
        if (!db) return defaultData;
        try {
            const docRef = doc(db, "declarations", "macroProductGroupConfig");
            const docSnap = await getDoc(docRef);
            if (docSnap.exists()) {
                const d = docSnap.data();
                const data = d.data || d.items || d.config || [];
                if (data.length > 0) return data;
            }
            return defaultData;
        } catch (e) { console.error("Lỗi tải macroProductGroupConfig:", e); return defaultData; }
    },

    // --- NAME MAPPINGS ---
    async saveNameMapping(type, data) {
        const db = getDB();
        if (!db) { notify("Lỗi kết nối CSDL!", "error"); return; }
        if (!checkAdmin()) return;
        let docId = '';
        if (type === 'category') docId = 'categoryNameMapping';
        else if (type === 'group') docId = 'groupNameMapping';
        else if (type === 'brand') docId = 'brandNameMapping';
        try {
            const docRef = doc(db, "declarations", docId);
            await setDoc(docRef, { data: sanitizeForFirestore(data) });
            notify(`Đã lưu Mapping tên ${type}!`, 'success');
        } catch (error) { console.error(error); notify('Lỗi lưu mapping: ' + error.message, 'error'); }
    },

    async saveCompetitionNameMappings(mappings) {
        const db = getDB();
        if (!db) { notify("Lỗi kết nối CSDL!", "error"); return; }
        if (!checkAdmin()) return;
        try {
            const docRef = doc(db, "declarations", "competitionNameMappings");
            await setDoc(docRef, { mappings: sanitizeForFirestore(mappings) });
            notify('Đã lưu Bảng Ánh Xạ Tên Thi Đua thành công!', 'success');
        } catch (error) {
            console.error("Lỗi khi lưu Bảng Ánh Xạ Tên Thi Đua:", error);
            notify('Lỗi khi lưu tên rút gọn lên cloud.', 'error');
        }
    },

    // --- SPECIAL PRODUCTS ---
    async saveSpecialProductList(products) {
        const db = getDB();
        if (!db) { notify("Lỗi kết nối CSDL!", "error"); return; }
        if (!checkAdmin()) return;
        try {
            const docRef = doc(db, "declarations", "specialProductList");
            await setDoc(docRef, { products: sanitizeForFirestore(products) });
            notify('Đã lưu Danh sách SPĐQ thành công!', 'success');
        } catch (error) { console.error("Error saving special product list:", error); notify('Lỗi khi lưu danh sách SPĐQ.', 'error'); }
    },

    async loadSpecialProductList() {
        const db = getDB();
        if (!db) return [];
        try {
            const docRef = doc(db, "declarations", "specialProductList");
            const docSnap = await getDoc(docRef);
            if (docSnap.exists()) {
                const d = docSnap.data();
                return d.products || d.data || [];
            }
            return [];
        } catch (error) { console.error("Error loading SPĐQ:", error); return []; }
    },

    async loadGlobalSpecialPrograms() {
        const db = getDB();
        if (!db) return [];
        try {
            const docRef = doc(db, "declarations", "globalSpecialPrograms");
            const docSnap = await getDoc(docRef);
            if (docSnap.exists()) {
                const d = docSnap.data();
                return d.programs || d.configs || d.data || [];
            }
            return [];
        } catch (error) { return []; }
    },
};
<<< FILE_END: src/services/declarations/category.service.js

>>> FILE_START: src/services/declarations/config.service.js
import { doc, setDoc, getDoc } from "firebase/firestore";
import { ref, uploadBytes, getDownloadURL } from "firebase/storage";
import { get } from 'svelte/store';
import { firebaseStore, homeConfig } from '../../stores.js';
import { getDB, notify, sanitizeForFirestore, checkAdmin } from './utils.js';

export const configService = {
    // --- HELP CONTENT ---
    async saveHelpContent(contents) {
        const db = getDB();
        if (!db) { notify("Lỗi kết nối CSDL!", "error"); return; }
        if (!checkAdmin()) return;

        try {
            await Promise.all([
                setDoc(doc(db, "help_content", "data"), { content: contents.data }),
                setDoc(doc(db, "help_content", "luyke"), { content: contents.luyke }),
                setDoc(doc(db, "help_content", "sknv"), { content: contents.sknv }),
                setDoc(doc(db, "help_content", "realtime"), { content: contents.realtime })
            ]);
            notify('Đã cập nhật nội dung hướng dẫn thành công!', 'success');
        } catch (error) { 
            console.error("Error saving help content:", error);
            notify('Lỗi khi lưu nội dung hướng dẫn.', 'error'); 
        }
    },

    // --- HOME CONFIG ---
    async saveHomeConfig(configData) {
        const db = getDB();
        if (!db) { notify("Lỗi kết nối CSDL!", "error"); return; }
        if (!checkAdmin()) return;

        try {
            const docRef = doc(db, "declarations", "homeConfig");
            await setDoc(docRef, { data: sanitizeForFirestore(configData) });
            homeConfig.set(configData);
            notify('Đã lưu cấu hình Trang chủ thành công!', 'success');
        } catch (error) { 
            console.error("Error saving home config:", error);
            notify('Lỗi khi lưu cấu hình trang chủ: ' + error.message, 'error');
        }
    },

    async loadHomeConfig() {
        const db = getDB();
        if (!db) return;
        try {
            const docRef = doc(db, "declarations", "homeConfig");
            const docSnap = await getDoc(docRef);
            if (docSnap.exists()) {
                const raw = docSnap.data();
                const data = raw.data || raw.config || raw;
                if (data) homeConfig.set(data);
            }
        } catch (error) { console.error("Error loading home config:", error); }
    },

    // --- UPLOAD IMAGE ---
    async uploadImage(file, folder = 'slides') {
        const fb = get(firebaseStore);
        if (!fb.storage) {
            console.warn("Firebase Storage chưa được khởi tạo trong firebaseStore.");
            return null;
        }

        try {
            const fileName = `${Date.now()}_${file.name}`;
            const storageRef = ref(fb.storage, `${folder}/${fileName}`);
            
            const snapshot = await uploadBytes(storageRef, file);
            const downloadURL = await getDownloadURL(snapshot.ref);
            return downloadURL;
        } catch (error) {
            console.error("Upload failed:", error);
            throw error;
        }
    }
};
<<< FILE_END: src/services/declarations/config.service.js

>>> FILE_START: src/services/declarations/performance.service.js
import { doc, setDoc, getDoc, serverTimestamp } from "firebase/firestore";
import { efficiencyConfig, qdcConfigStore } from '../../stores.js';
import { getDB, notify, sanitizeForFirestore, checkAdmin } from './utils.js';

export const performanceService = {
    // --- SYSTEM REVENUE TABLES ---
    async loadSystemRevenueTables() {
        const db = getDB();
        if (!db) return [];
        try {
            const docRef = doc(db, "declarations", "systemRevenueTables");
            const docSnap = await getDoc(docRef);
            if (docSnap.exists()) {
                const d = docSnap.data();
                const tables = d.tables || d.data || d.items || [];
                console.log(`[PerformanceService] Loaded ${tables.length} system revenue tables.`);
                return tables;
            }
            return [];
        } catch (e) {
            console.error("Lỗi tải bảng hệ thống:", e);
            return [];
        }
    },

    async saveSystemRevenueTables(tables) {
        const db = getDB();
        if (!db) { notify("Lỗi kết nối CSDL!", "error"); return; }
        if (!checkAdmin()) return;
        const systemTables = tables.filter(t => t.isSystem).map(t => sanitizeForFirestore(t));
        try {
            const docRef = doc(db, "declarations", "systemRevenueTables");
            await setDoc(docRef, { tables: systemTables, updatedAt: serverTimestamp() });
            notify(`Đã lưu ${systemTables.length} bảng doanh thu hệ thống lên Cloud!`, 'success');
        } catch (error) { 
            console.error("Firebase Error Full:", error);
            notify('Lỗi lưu bảng hệ thống: ' + error.message, 'error'); 
        }
    },

    // --- SYSTEM PERFORMANCE TABLES ---
    async loadSystemPerformanceTables() {
        const db = getDB();
        if (!db) return [];
        try {
            const docRef = doc(db, "declarations", "systemPerformanceTables");
            const docSnap = await getDoc(docRef);
            if (docSnap.exists()) {
                const d = docSnap.data();
                const tables = d.tables || d.data || [];
                console.log(`[PerformanceService] Loaded ${tables.length} system performance tables.`);
                return tables;
            }
            return [];
        } catch (e) {
            console.error("Lỗi tải bảng hiệu quả hệ thống:", e);
            return [];
        }
    },

    async saveSystemPerformanceTables(tables) {
        const db = getDB();
        if (!db) { notify("Lỗi kết nối CSDL!", "error"); return; }
        if (!checkAdmin()) return;
        
        const systemTables = tables.filter(t => t.isSystem).map(t => sanitizeForFirestore(t));
        try {
            const docRef = doc(db, "declarations", "systemPerformanceTables");
            await setDoc(docRef, { tables: systemTables, updatedAt: serverTimestamp() });
            notify(`Đã lưu ${systemTables.length} bảng hiệu quả hệ thống lên Cloud!`, 'success');
        } catch (error) { 
            console.error("Lỗi lưu bảng hiệu quả hệ thống:", error);
            notify('Lỗi lưu bảng hiệu quả hệ thống: ' + error.message, 'error');
        }
    },

    // --- LOGIC & CALCULATION ---
    async loadDeclarationsFromFirestore() {
        const db = getDB();
        if (!db) return {}; 
        try {
            const declarationIds = ['hinhThucXuat', 'hinhThucXuatGop', 'heSoQuyDoi'];
            const declarations = {};
            await Promise.all(declarationIds.map(async (id) => {
                const docRef = doc(db, "declarations", id);
                const docSnap = await getDoc(docRef);
                declarations[id] = docSnap.exists() ? (docSnap.data().content || '') : '';
            }));
            return declarations;
        } catch (error) { console.error("Error loading declarations:", error); return {}; }
    },

    async saveDeclarationsToFirestore(declarations) {
        const db = getDB();
        if (!db) { notify("Lỗi kết nối CSDL!", "error"); return; }
        if (!checkAdmin()) return;
        try {
            await Promise.all([
                setDoc(doc(db, "declarations", "hinhThucXuat"), { content: declarations.ycx }),
                setDoc(doc(db, "declarations", "hinhThucXuatGop"), { content: declarations.ycxGop }),
                setDoc(doc(db, "declarations", "heSoQuyDoi"), { content: declarations.heSo })
            ]);
            notify('Đồng bộ khai báo tính toán thành công!', 'success');
        } catch (error) { console.error("Error saving declarations:", error); notify('Lỗi khi đồng bộ khai báo tính toán.', 'error'); }
    },

    // --- GLOBAL COMPETITION CONFIGS ---
    async saveGlobalCompetitionConfigs(configs) {
        const db = getDB();
        if (!db) { notify("Lỗi kết nối CSDL!", "error"); return; }
        if (!checkAdmin()) return;
        try {
            const docRef = doc(db, "declarations", "globalCompetitionConfigs");
            await setDoc(docRef, { configs: sanitizeForFirestore(configs) });
        } catch (error) { console.error("Error saving global comps:", error); }
    },

    async loadGlobalCompetitionConfigs() {
        const db = getDB();
        if (!db) return [];
        try {
            const docRef = doc(db, "declarations", "globalCompetitionConfigs");
            const docSnap = await getDoc(docRef);
            if (docSnap.exists()) {
                const d = docSnap.data();
                return d.configs || d.data || [];
            }
            return [];
        } catch (error) { return []; }
    },

    // --- EFFICIENCY & QDC CONFIGS ---
    async saveEfficiencyConfig(config) {
        const db = getDB();
        if (!db) { notify("Lỗi kết nối CSDL!", "error"); return; }
        if (!checkAdmin()) return;
        try {
            const docRef = doc(db, "declarations", "efficiencyConfig");
            await setDoc(docRef, { data: sanitizeForFirestore(config), updatedAt: serverTimestamp() });
            efficiencyConfig.set(config);
            notify('Đã lưu cấu hình Bảng Hiệu quả hệ thống!', 'success');
        } catch (e) { console.error(e); notify('Lỗi lưu config: ' + e.message, 'error'); }
    },

    async loadEfficiencyConfig() {
        const db = getDB();
        if (!db) return [];
        try {
            const docRef = doc(db, "declarations", "efficiencyConfig");
            const docSnap = await getDoc(docRef);
            if (docSnap.exists()) {
                const d = docSnap.data();
                const data = d.data || d.items || d.config || [];
                // [FIX CRITICAL] Cập nhật store ngay sau khi tải về
                efficiencyConfig.set(data);
                console.log(`[PerformanceService] Đã cập nhật Store EfficiencyConfig với ${data.length} dòng.`);
                return data;
            }
            return [];
        } catch (e) { console.error("Lỗi tải efficiency config:", e); return []; }
    },
    
    async saveQdcConfig(selectedGroups) {
         const db = getDB();
        if (!db || !checkAdmin()) return;
        try {
            const docRef = doc(db, "declarations", "qdcConfig");
            await setDoc(docRef, { data: sanitizeForFirestore(selectedGroups) });
            qdcConfigStore.set(selectedGroups);
        } catch (e) { console.error(e); }
    },
    
    async loadQdcConfig() {
        const db = getDB();
        if (!db) return [];
        try {
            const docRef = doc(db, "declarations", "qdcConfig");
            const docSnap = await getDoc(docRef);
            if (docSnap.exists()) {
                const d = docSnap.data();
                return d.data || d.config || d.items || [];
            }
            return [];
        } catch (e) { return []; }
    },
};
<<< FILE_END: src/services/declarations/performance.service.js

>>> FILE_START: src/services/declarations/utils.js
import { get } from 'svelte/store';
import { firebaseStore, isAdmin } from '../../stores.js'; // Lưu ý: ../../ vì đang ở trong services/declarations

export const getDB = () => {
    const fb = get(firebaseStore);
    if (!fb.db) {
        console.warn("Firestore chưa được khởi tạo.");
        return null;
    }
    return fb.db;
};

export const notify = (msg, type='info') => {
    console.log(`[${type.toUpperCase()}] ${msg}`);
    if(type === 'success' || type === 'error') alert(msg);
};

export const sanitizeForFirestore = (obj) => {
    return JSON.parse(JSON.stringify(obj, (key, value) => {
        return value === undefined ? null : value;
    }));
};

export const checkAdmin = () => {
    if (!get(isAdmin)) {
        notify("Bạn cần quyền Admin để thực hiện thao tác này!", "error");
        return false;
    }
    return true;
};

<<< FILE_END: src/services/declarations/utils.js

>>> FILE_START: src/services/employeeService.js
import { get } from 'svelte/store';
import { currentCluster } from '../stores.js';

// ==========================================
// CONFIGURATION
// ==========================================
const API_BASE_URL = 'http://localhost:3000/api'; 
const NETWORK_DELAY = 500; // Giả lập độ trễ mạng (ms)

// ==========================================
// HELPER FUNCTIONS (Hàm hỗ trợ)
// ==========================================

// Hàm check an toàn: Luôn đảm bảo đã chọn Cluster trước khi gọi API
const getClusterIdOrThrow = () => {
    const cluster = get(currentCluster);
    if (!cluster || !cluster.id) {
        throw new Error("MISSING_CLUSTER_ID: Vui lòng chọn Cluster trước.");
    }
    return cluster.id;
};

// Hàm xử lý lỗi chung cho toàn bộ service
const handleApiError = (error, context) => {
    console.error(`[EmployeeService] Error in ${context}:`, error);
    // Có thể thêm logic gửi log lên server hoặc hiển thị Toast thông báo lỗi ở đây
    throw error;
};

// ==========================================
// MAIN SERVICE FUNCTIONS (CRUD)
// ==========================================

/**
 * 1. GET ALL: Lấy danh sách nhân viên theo Cluster hiện tại
 */
export const fetchEmployees = async () => {
    try {
        const clusterId = getClusterIdOrThrow();
        console.log(`[GET] Fetching employees for Cluster ${clusterId}...`);

        // --- REAL API CODE (Uncomment khi có Server) ---
        // const res = await fetch(`${API_BASE_URL}/clusters/${clusterId}/employees`);
        // if (!res.ok) throw new Error(`HTTP Error ${res.status}`);
        // return await res.json();

        // --- MOCK DATA (Dữ liệu giả) ---
        await new Promise(r => setTimeout(r, NETWORK_DELAY));
        return [
            { id: 1, code: 'NV001', name: 'Nguyễn Văn A', position: 'Frontend Dev', clusterId },
            { id: 2, code: 'NV002', name: 'Trần Thị B', position: 'Backend Dev', clusterId },
            { id: 3, code: 'NV003', name: 'Lê Văn C', position: 'Tester', clusterId },
            { id: 4, code: 'NV004', name: 'Phạm Thị D', position: 'Product Owner', clusterId },
            { id: 5, code: 'NV005', name: 'Hoàng Văn E', position: 'Designer', clusterId },
        ];
    } catch (error) {
        handleApiError(error, 'fetchEmployees');
        return []; // Trả về mảng rỗng để UI không bị crash
    }
};

/**
 * 2. GET DETAILS: Lấy chi tiết 1 nhân viên
 */
export const getEmployeeById = async (employeeId) => {
    try {
        const clusterId = getClusterIdOrThrow();
        console.log(`[GET] Fetching details for employee ${employeeId}...`);

        // Call API...
        await new Promise(r => setTimeout(r, NETWORK_DELAY));
        return { 
            id: employeeId, 
            name: 'Nguyễn Văn A', 
            email: 'a.nguyen@example.com', 
            phone: '0909123456',
            clusterId 
        };
    } catch (error) {
        handleApiError(error, 'getEmployeeById');
    }
};

/**
 * 3. CREATE: Thêm nhân viên mới vào Cluster hiện tại
 */
export const createEmployee = async (payload) => {
    try {
        const clusterId = getClusterIdOrThrow();
        const dataToSend = { ...payload, clusterId }; // Gắn ID cluster vào data

        console.log(`[POST] Creating employee in Cluster ${clusterId}:`, dataToSend);

        // Call API...
        // const res = await fetch(`${API_BASE_URL}/employees`, {
        //     method: 'POST',
        //     headers: { 'Content-Type': 'application/json' },
        //     body: JSON.stringify(dataToSend)
        // });
        
        await new Promise(r => setTimeout(r, NETWORK_DELAY));
        return { success: true, newId: Math.floor(Math.random() * 1000) };
    } catch (error) {
        handleApiError(error, 'createEmployee');
    }
};

/**
 * 4. UPDATE: Cập nhật thông tin nhân viên
 */
export const updateEmployee = async (id, payload) => {
    try {
        getClusterIdOrThrow(); // Vẫn check cluster cho chắc chắn
        console.log(`[PUT] Updating employee ${id}:`, payload);

        // Call API...
        await new Promise(r => setTimeout(r, NETWORK_DELAY));
        return { success: true };
    } catch (error) {
        handleApiError(error, 'updateEmployee');
    }
};

/**
 * 5. DELETE: Xóa nhân viên
 */
export const deleteEmployee = async (id) => {
    try {
        getClusterIdOrThrow();
        console.log(`[DELETE] Removing employee ${id}...`);

        // Call API...
        await new Promise(r => setTimeout(r, NETWORK_DELAY));
        return { success: true };
    } catch (error) {
        handleApiError(error, 'deleteEmployee');
    }
};
<<< FILE_END: src/services/employeeService.js

>>> FILE_START: src/services/excel.service.js
/* global XLSX */
import { notificationStore } from '../stores.js'; // [FIX] Dùng Store thay vì file lẻ

export const excelService = {
    /**
     * Xuất bảng HTML ra file Excel
     * @param {HTMLElement} tableElement - Element bảng hoặc container chứa bảng
     * @param {string} fileName - Tên file muốn lưu
     */
    exportTableToExcel(tableElement, fileName) {
        if (!tableElement) {
            notificationStore.show('Không tìm thấy nội dung để xuất.', 'error'); // [FIX]
            return;
        }

        // Tìm thẻ table bên trong nếu element truyền vào là container
        let table = tableElement.tagName === 'TABLE' 
            ? tableElement 
            : tableElement.querySelector('table');

        if (!table) {
            table = tableElement.querySelector('.department-block table, #sknv-summary-container table, #luyke-competition-content table');
        }

        if (!table) {
            notificationStore.show('Không tìm thấy bảng dữ liệu trong khu vực này để xuất.', 'error'); // [FIX]
            return;
        }

        try {
            const wb = XLSX.utils.table_to_book(table, { sheet: "Sheet1" });
            XLSX.writeFile(wb, `${fileName}.xlsx`);
            notificationStore.show(`Đã xuất file ${fileName}.xlsx thành công!`, 'success'); // [FIX]
        } catch (e) {
            console.error('[ExcelService] Lỗi xuất Excel:', e);
            notificationStore.show('Có lỗi xảy ra khi xuất file Excel.', 'error'); // [FIX]
        }
    }
};
<<< FILE_END: src/services/excel.service.js

>>> FILE_START: src/services/firebase.service.js
// src/services/firebase.service.js
// Version 3.0 - Switch to Legacy Firebase Project (qlst-9e6bd)
import { initializeApp } from "firebase/app";
import { getAuth } from "firebase/auth";
import { getFirestore } from "firebase/firestore";
import { getStorage } from "firebase/storage";
import { firebaseStore } from '../stores.js';

// Config từ dự án gốc "qlst-9e6bd"
const firebaseConfig = {
  apiKey: "AIzaSyAQ3TWcpa4AnTN-32igGseYDlXrCf1BVew",
  authDomain: "qlst-9e6bd.firebaseapp.com",
  projectId: "qlst-9e6bd",
  storageBucket: "qlst-9e6bd.firebasestorage.app",
  messagingSenderId: "2316705291",
  appId: "1:2316705291:web:ebec2963816aea7585b10e",
  measurementId: "G-M0SM0XHCEK"
};

export const firebaseService = {
    initCore() {
        try {
            console.log("[FirebaseService] Initializing Legacy Firebase (qlst-9e6bd)...");
            const app = initializeApp(firebaseConfig);
            const auth = getAuth(app);
            const db = getFirestore(app);
            const storage = getStorage(app);

            // Cập nhật store để các service khác sử dụng
            firebaseStore.set({
                app,
                auth,
                db,
                storage
            });

            console.log("[FirebaseService] Firebase initialized successfully!");
            return { app, auth, db, storage };
        } catch (error) {
            console.error("[FirebaseService] Initialization failed:", error);
            return null;
        }
    }
};
<<< FILE_END: src/services/firebase.service.js

>>> FILE_START: src/services/modal.service.js
// Version 1.0 - Initial Svelte refactor
// MODULE: UI MODAL MANAGER
// Chứa các hàm thuần túy để quản lý trạng thái hiển thị của Modals và Drawers.
// Tái cấu trúc từ file ui-modal-manager.js gốc

export const modalManager = {
    /**
     * Bật hoặc tắt một modal.
     * @param {string} modalId - ID của modal (ví dụ: 'login-modal').
     * @param {boolean} show - True để hiện, false để ẩn.
     */
    toggleModal(modalId, show) {
        const modal = document.getElementById(modalId);
        if (!modal) return;
        modal.classList.toggle('hidden', !show);
    },

    /**
     * Bật hoặc tắt một drawer (thanh cài đặt bên).
     * @param {string} drawerId - ID của drawer (ví dụ: 'interface-drawer').
     * @param {boolean} show - True để hiện, false để ẩn.
     */
    toggleDrawer(drawerId, show) {
        const drawer = document.getElementById(drawerId);
        const sidebar = document.getElementById('sidebar');
        const overlay = document.getElementById('drawer-overlay');

        if (!drawer || !sidebar || !overlay) return;
        if (show) {
            drawer.classList.remove('hidden');
            setTimeout(() => {
                drawer.classList.add('open');
                 sidebar.classList.add('menu-locked');
                 overlay.classList.remove('hidden');
            }, 10);
        } else {
            drawer.classList.remove('open');
            sidebar.classList.remove('menu-locked');
            overlay.classList.add('hidden');
            setTimeout(() => {
                 if (!drawer.classList.contains('open')) {
                     drawer.classList.add('hidden');
                 }
             }, 300);
        }
    },

    /**
     * Đóng tất cả các drawer đang mở.
     */
    closeAllDrawers() {
        // Chúng ta gọi hàm `toggleDrawer` nội bộ
        this.toggleDrawer('interface-drawer', false);
        this.toggleDrawer('goal-drawer', false);
    },
};
<<< FILE_END: src/services/modal.service.js

>>> FILE_START: src/services/processing/helpers.js
/* global XLSX */
import { get } from 'svelte/store';
import { config } from '../../config.js';
// [FIX] Import thêm efficiencyConfig
import { declarations, efficiencyConfig } from '../../stores.js';

export const helpers = {
    findColumnName(header, aliases) {
        for (const colName of header) {
            const processedColName = String(colName || '').trim().toLowerCase();
            if (aliases.includes(processedColName)) {
                return colName;
            }
        }
        return null;
    },

    getHinhThucXuatTinhDoanhThu: () => {
        const declarationData = get(declarations).hinhThucXuat;
        if (declarationData) return new Set(declarationData.split('\n').map(l => l.trim()).filter(Boolean));
        return new Set(config.DEFAULT_DATA.HINH_THUC_XUAT_TINH_DOANH_THU);
    },

    getHinhThucXuatTraGop: () => {
        const declarationData = get(declarations).hinhThucXuatGop;
        if (declarationData) return new Set(declarationData.split('\n').map(l => l.trim()).filter(Boolean));
        return new Set(config.DEFAULT_DATA.HINH_THUC_XUAT_TRA_GOP);
    },

    getHeSoQuyDoi: () => {
        const heSoMap = {};
        let sourceUsed = 'DEFAULT'; // Biến để debug xem đang lấy dữ liệu từ nguồn nào

        // ƯU TIÊN 1: Lấy từ Cấu hình Hiệu quả (Giao diện Admin mới)
        const dynamicConfig = get(efficiencyConfig);
        if (dynamicConfig && dynamicConfig.length > 0) {
            sourceUsed = 'ADMIN_CONFIG_STORE';
            dynamicConfig.forEach(item => {
                // item cấu trúc: { id: "1491 - Smartphone", heSo: 1.5, ... }
                if (item.id && item.heSo !== undefined && item.heSo !== null) {
                    heSoMap[item.id.trim()] = parseFloat(item.heSo);
                }
            });
        }

        // ƯU TIÊN 2: Lấy từ Khai báo Text (Cũ - nếu Priority 1 không đủ hoặc rỗng)
        // Logic merge: Chỉ thêm nếu chưa có trong map
        const declarationData = get(declarations).heSoQuyDoi;
        if (declarationData) {
            declarationData.split('\n').filter(l => l.trim()).forEach(line => {
                const parts = line.split(',');
                if (parts.length >= 2) {
                    const key = parts[0].trim();
                    const value = parseFloat(parts[1].trim());
                    if (key && !isNaN(value)) {
                         // Nếu chưa có thì mới thêm (Ưu tiên Config mới đè lên cũ)
                         if (heSoMap[key] === undefined) {
                             heSoMap[key] = value;
                         }
                    }
                }
            });
        }

        // ƯU TIÊN 3: Mặc định (Fallback cuối cùng)
        const defaultData = config.DEFAULT_DATA.HE_SO_QUY_DOI;
        Object.entries(defaultData).forEach(([key, value]) => {
             if (heSoMap[key] === undefined) {
                 heSoMap[key] = value;
             }
        });

        // --- [DEBUG LOG THEO YÊU CẦU] ---
        // Chỉ log khi map có dữ liệu để tránh spam
        if (Object.keys(heSoMap).length > 0) {
            // console.log(`[Helpers] Đã nạp ${Object.keys(heSoMap).length} hệ số quy đổi. Nguồn chính: ${sourceUsed}`);
            // Mở comment dòng dưới nếu muốn soi chi tiết map khi cần
            // console.log("Chi tiết Map Quy Đổi:", heSoMap);
        }
        // -------------------------------

        return heSoMap;
    },

    cleanCompetitionName(name) {
        return name.replace(/thi đua doanh thu bán hàng|thi đua doanh thu|thi đua số lượng/gi, "").trim();
    },

    classifyInsurance: (productName) => {
        if (!productName || typeof productName !== 'string') return null;
        const name = productName.trim().toLowerCase();
        if (name.includes('bảo hành mở rộng')) return 'BHMR';
        if (name.includes('1 đổi 1')) return 'BH1d1';
        if (name.includes('khoản vay')) return 'BHKV';
        if (name.includes('rơi vỡ')) return 'BHRV';
        if (name.includes('samsung care+')) return 'BHSC';
        if (name.includes('ô tô') || name.includes('vật chất ô tô')) return 'BHOTO';
        if (name.includes('xe máy') || name.includes('xe moto')) return 'BHXM';
        if (name.includes('xã hội') || name.includes('y tế')) return 'BHYT';
        return null;
    },

    findHeaderAndProcess(sheet, requiredKeywords) {
        if (!sheet) return [];
        const rows = XLSX.utils.sheet_to_json(sheet, { header: 1, defval: null });
        if (rows.length === 0) return [];

        let headerRowIndex = -1;
        let foundHeaders = [];

        for (let i = 0; i < Math.min(rows.length, 10); i++) {
            const row = rows[i];
            const lowerCaseRow = row.map(cell => String(cell || '').trim().toLowerCase());

            const allKeywordsFound = requiredKeywords.every(keyword =>
                lowerCaseRow.some(cell => cell.includes(keyword))
            );

            if (allKeywordsFound) {
                headerRowIndex = i;
                foundHeaders = rows[i].map(cell => String(cell || '').trim());
                break;
            }
        }

        if (headerRowIndex === -1) {
            throw new Error(`Không tìm thấy dòng tiêu đề chứa đủ các từ khóa: ${requiredKeywords.join(', ')}.`);
        }

        const dataRows = rows.slice(headerRowIndex + 1);
        const jsonData = dataRows.map(row => {
            const obj = {};
            foundHeaders.forEach((header, index) => {
                if (header) {
                    const value = row[index];
                    const upperKey = header.toUpperCase();
                    if (upperKey.includes('KÊNH') || upperKey.includes('SIÊU THỊ') || upperKey.includes('NGÀNH HÀNG') || upperKey.includes('TỈNH') || upperKey.includes('BOSS')) {
                        obj[header] = value;
                    } else if (typeof value === 'string' && value.includes('%')) {
                        obj[header] = parseFloat(value.replace(/%|,/g, '')) / 100 || 0;
                    } else if (value !== null && value !== undefined) {
                        obj[header] = parseFloat(String(value).replace(/,/g, '')) || 0;
                    } else {
                        obj[header] = 0;
                    }
                }
            });
            return obj;
        }).filter(obj => {
            const supermarketKey = Object.keys(obj).find(k => k.toLowerCase().includes('siêu thị'));
            return supermarketKey && obj[supermarketKey];
        });

        return jsonData;
    }
};
<<< FILE_END: src/services/processing/helpers.js

>>> FILE_START: src/services/processing/logic/cluster.processor.js
// src/services/processing/logic/cluster.processor.js

export const clusterProcessor = {
    /**
     * Chuyển đổi dữ liệu thi đua thô thành định dạng hiển thị cho Table
     */
    processCompetitionData: (parsedData) => {
        if (!parsedData) return [];
        
        // Flatten dữ liệu để hiển thị bảng: Mỗi dòng là 1 ngành hàng của 1 siêu thị?
        // Hoặc trả về cấu trúc Group để UI render (Siêu thị -> List Ngành hàng)
        
        // Ở đây tôi trả về cấu trúc nguyên bản đã sạch để UI dễ loop
        return parsedData.stores.map(store => {
            return {
                storeName: store.name,
                metrics: store.data, // [{ category, percent, revenue }]
                totalRevenue: store.data.reduce((acc, curr) => acc + curr.revenue, 0)
            };
        });
    },

    /**
     * Tạo dữ liệu báo cáo tổng hợp cho Cụm
     */
    createClusterReport: (cumulativeData) => {
        if (!cumulativeData) return null;

        const { generalStats, storeDetails } = cumulativeData;

        // Tính tổng thực tế từ các store chi tiết (để đối chiếu với generalStats nếu cần)
        const calculatedTotalDT = storeDetails.reduce((acc, s) => acc + s.dtLuyKe, 0);

        return {
            kpiCards: generalStats, // Dữ liệu cho 4 ô thẻ bài trên cùng
            detailTable: storeDetails, // Dữ liệu cho bảng chi tiết bên dưới
            debug: {
                scannedTotal: generalStats.dtThuc,
                calcTotal: calculatedTotalDT
            }
        };
    }
};
<<< FILE_END: src/services/processing/logic/cluster.processor.js

>>> FILE_START: src/services/processing/logic/competition.processor.js
// src/services/processing/logic/competition.processor.js
import { get } from 'svelte/store';
import { 
    danhSachNhanVien, 
    employeeMaNVMap, 
    competitionNameMappings, 
    debugInfo 
} from '../../../stores.js';
import { helpers } from '../helpers.js';
import { normalizers } from '../normalizers.js';

export const competitionProcessor = {
    // 1. Kiểm tra logic lọc (Debug)
    debugCompetitionFiltering(rawTestData) {
        if (!rawTestData || rawTestData.length === 0) return [];

        const { normalizedData } = normalizers.normalizeData(rawTestData, 'ycx');
        if (normalizedData.length === 0) return [];

        const hinhThucXuatTinhDoanhThu = helpers.getHinhThucXuatTinhDoanhThu();
        const debugResults = normalizedData.map(row => {
            const checks = {
                isDoanhThuHTX: hinhThucXuatTinhDoanhThu.has(row.hinhThucXuat),
                isThuTien: (row.trangThaiThuTien || "").trim() === 'Đã thu',
                isChuaHuy: (row.trangThaiHuy || "").trim() === 'Chưa hủy',
                isChuaTra: (row.tinhTrangTra || "").trim() === 'Chưa trả',
                isDaXuat: (row.trangThaiXuat || "").trim() === 'Đã xuất'
            };
            const isOverallValid = checks.isDoanhThuHTX && checks.isThuTien && checks.isChuaHuy && checks.isChuaTra && checks.isDaXuat;
            return { rowData: row, checks: checks, isOverallValid: isOverallValid };
        });
        return debugResults;
    },

    // 2. Cập nhật mapping tên thi đua
    updateCompetitionNameMappings(mainHeaders) {
        if (!mainHeaders || mainHeaders.length === 0) return;
        
        const oldMappings = get(competitionNameMappings) || {};
        const newMappings = { ...oldMappings };
        let hasChanges = false;

        mainHeaders.forEach(originalName => {
            // Chỉ thêm nếu tên này chưa tồn tại trong mapping
            if (!newMappings.hasOwnProperty(originalName)) {
                // [YÊU CẦU] Mặc định điền tên rút gọn = tên gốc
                newMappings[originalName] = originalName; 
                hasChanges = true;
            }
        });

        if (hasChanges) {
            console.log("[Processors] Phát hiện tên thi đua mới, cập nhật store mapping.");
            competitionNameMappings.set(newMappings);
        }
    },

    // 3. Xử lý dữ liệu thi đua nhân viên (Core Logic)
    processThiDuaNhanVienData(parsedData, luykeCompetitionData) {
        const { mainHeaders, subHeaders, dataRows } = parsedData;
        const newDebugInfo = { required: [], found: [], status: 'Đang xử lý...' };
        
        const $danhSachNhanVien = get(danhSachNhanVien);
        if ($danhSachNhanVien.length === 0) {
            newDebugInfo.status = 'Lỗi: Danh sách nhân viên (DSNV) chưa được tải lên.';
            debugInfo.update(current => ({ ...current, 'thiduanv-pasted': newDebugInfo }));
            return [];
        }
        if (mainHeaders.length === 0 || dataRows.length === 0 || subHeaders.length === 0) {
            newDebugInfo.status = 'Lỗi: Dữ liệu dán vào không hợp lệ.';
            debugInfo.update(current => ({ ...current, 'thiduanv-pasted': newDebugInfo }));
            return [];
        }

        // [QUAN TRỌNG] Gọi hàm cập nhật mapping ngay khi xử lý dữ liệu
        this.updateCompetitionNameMappings(mainHeaders);

        const nameMappings = get(competitionNameMappings) || {};
        const competitionTargets = (luykeCompetitionData || []).map(comp => ({
            ...comp,
            cleanedName: helpers.cleanCompetitionName(comp.name)
        }));
        
        const finalReport = [];
        const totalEmployeesInDSNV = $danhSachNhanVien.length;
        const $employeeMaNVMap = get(employeeMaNVMap);

        dataRows.forEach(row => {
            const nameParts = row.name.split(' - ');
            const msnv = nameParts.length > 1 ? nameParts[nameParts.length - 1].trim() : null;

            let employee;
            if (msnv) {
                employee = $employeeMaNVMap.get(msnv);
            }

            if (!employee) {
                employee = { hoTen: row.name, maNV: msnv || 'N/A', boPhan: 'Nhân viên không tìm thấy' };
            }

            const employeeResult = {
                maNV: employee.maNV,
                hoTen: employee.hoTen,
                boPhan: employee.boPhan,
                completedCount: 0,
                totalCompetitions: mainHeaders.length,
                competitions: []
            };

            for (let i = 0; i < mainHeaders.length; i++) {
                const originalName = mainHeaders[i];
                const loaiSoLieu = subHeaders[i];
                
                // [YÊU CẦU] Lấy tên rút gọn từ mapping, fallback về tên gốc
                const shortName = nameMappings[originalName] || originalName;
                
                const cleanedName = helpers.cleanCompetitionName(originalName);
                const matchedTarget = competitionTargets.find(t => t.cleanedName === cleanedName);
                const groupTarget = matchedTarget ? matchedTarget.target : 0;
                const individualTarget = totalEmployeesInDSNV > 0 ? groupTarget / totalEmployeesInDSNV : 0;

                const giaTri = parseFloat(String(row.values[i] || '0').replace(/,/g, '')) || 0;
                const actualSales = giaTri;
                const percentExpected = individualTarget > 0 ? actualSales / individualTarget : (actualSales > 0 ? Infinity : 0);
                
                if (percentExpected >= 1) employeeResult.completedCount++;

                employeeResult.competitions.push({
                    tenNganhHang: shortName, // Dùng tên rút gọn cho hiển thị
                    tenGoc: originalName,    // Giữ tên gốc để đối chiếu
                    loaiSoLieu: loaiSoLieu,
                    giaTri: giaTri,
                    thucHien: actualSales,
                    mucTieu: individualTarget,
                    percentExpected: percentExpected,
                });
            }

            employeeResult.completionRate = employeeResult.totalCompetitions > 0 ? employeeResult.completedCount / employeeResult.totalCompetitions : 0;
            finalReport.push(employeeResult);
        });

        newDebugInfo.status = `Thành công: Đã xử lý báo cáo cho ${finalReport.length} nhân viên.`;
        debugInfo.update(current => ({ ...current, 'thiduanv-pasted': newDebugInfo }));
        return finalReport;
    }
};
<<< FILE_END: src/services/processing/logic/competition.processor.js

>>> FILE_START: src/services/processing/logic/dynamicTable.processor.js
/* src/services/processing/logic/dynamicTable.processor.js */
import { get } from 'svelte/store';
import { formatters } from '../../../utils/formatters.js';
import { parseIdentity } from '../../../utils.js';
import { macroCategoryConfig, macroProductGroupConfig } from '../../../stores.js';

// Helper: Làm sạch và ép kiểu số an toàn
const getSafeNumber = (value) => {
    if (typeof value === 'number') return value;
    if (!value) return 0;
    if (typeof value === 'string') {
        const cleanStr = value.replace(/[^0-9.-]+/g, ""); 
        return parseFloat(cleanStr) || 0;
    }
    return 0;
};

const getValueFromMultiKeys = (obj, keys) => {
    if (!obj) return 0;
    for (const key of keys) {
        if (obj[key] !== undefined && obj[key] !== null) {
            return getSafeNumber(obj[key]);
        }
    }
    return 0;
};

export const dynamicTableProcessor = {
    findItemData(employee, targetId) {
        if (!employee || !targetId) return null;
        const parsed = parseIdentity(targetId);
        const searchKey = (parsed.id !== 'unknown' ? parsed.id : targetId).toString().trim();
        if (employee.doanhThuTheoNhomHang && employee.doanhThuTheoNhomHang[searchKey]) {
            return employee.doanhThuTheoNhomHang[searchKey];
        }
        if (employee.doanhThuTheoNganhHang && employee.doanhThuTheoNganhHang[searchKey]) {
            return employee.doanhThuTheoNganhHang[searchKey];
        }
        return null;
    },

    /**
     * Tính tổng giá trị (CÓ LOG CHI TIẾT)
     * @param logger: Mảng để lưu log truy vết
     */
    calculateGroupValue(employee, items, type = 'DT', logger = null) {
        if (!items || items.length === 0) return 0;

        const macroCats = get(macroCategoryConfig) || [];
        const macroGroups = get(macroProductGroupConfig) || [];

        let total = 0;
        const processedIds = new Set();

        const processId = (id) => {
            const safeId = id ? id.toString().trim() : '';
            if (!safeId || processedIds.has(safeId)) return;
            
            // 1. Check Macro Category
            const macroCat = macroCats.find(m => m.id == safeId || m.name === safeId);
            if (macroCat && macroCat.items) {
                processedIds.add(safeId);
                if (logger) logger.push(`   📂 [MACRO CAT] ${safeId}:`);
                macroCat.items.forEach(childId => processId(childId));
                return;
            }

            // 2. Check Macro Product Group
            const macroGroup = macroGroups.find(m => m.id == safeId || m.name === safeId);
            if (macroGroup && macroGroup.items) {
                processedIds.add(safeId);
                if (logger) logger.push(`   📂 [MACRO GROUP] ${safeId}:`);
                macroGroup.items.forEach(childId => processId(childId));
                return;
            }

            // 3. Raw ID
            const data = this.findItemData(employee, safeId);
            let val = 0;
            if (data) {
                processedIds.add(safeId);
                if (type === 'SL') {
                    val = getValueFromMultiKeys(data, ['quantity', 'soLuong', 'sl', 'count']);
                } else if (type === 'DTQD') {
                    val = getValueFromMultiKeys(data, ['revenueQuyDoi', 'doanhThuQuyDoi', 'dtqd']);
                } else {
                    val = getValueFromMultiKeys(data, ['revenue', 'doanhThu', 'thanhTien', 'totalPrice', 'dt']);
                }
                
                total += val;
                
                // Chỉ log những mục có giá trị để đỡ rối
                if (logger && val !== 0) {
                    logger.push(`      🔹 ${safeId} (${type}): ${formatters.formatNumber(val)}`);
                }
            }
        };

        items.forEach(id => processId(id));
        return total;
    },

    processTableData(reportData, config) {
        if (!reportData || !config) return { processedData: [], totals: {} };

        const mainColConfig = config.mainColumn ? { ...config.mainColumn, id: 'mainValue', isMain: true } : null;
        const subColsConfig = config.subColumns || [];
        const effectiveSubCols = config.columns || subColsConfig;
        
        const allColumnsToProcess = mainColConfig ? [mainColConfig, ...effectiveSubCols] : [...effectiveSubCols];

        const totalRow = {
            maNV: 'TOTAL',
            hoTen: 'TỔNG CỘNG',
            isTotal: true,
            cells: {} 
        };

        const processedData = reportData.map(employee => {
            const row = {
                maNV: employee.maNV,
                hoTen: employee.hoTen,
                mucTieu: employee.mucTieu || {},
                cells: {}
            };

            let hasAnyData = false;

            allColumnsToProcess.forEach(col => {
                const colId = col.id || col.header;
                const cellData = { sl: 0, dt: 0, dtqd: 0, value: 0, display: '', config: col };

                if (col.type === 'PERCENT') {
                    // Logic % (Bảng hiệu quả)
                    
                    // --- 🔍 TRACE DEBUG START ---
                    let traceLog = [];
                    // Chỉ debug cho một vài nhân viên mẫu để đỡ spam
                    const isTargetDebug = employee.hoTen.includes('Tú Phương') || employee.hoTen.includes('Tien'); 
                    
                    // [LOGIC MỚI] Lấy loại Metric từ cấu hình (Ưu tiên percentMetric -> mặc định DT)
                    const metricType = col.percentMetric || 'DT';

                    const numVal = this.calculateGroupValue(employee, col.numerator, metricType, isTargetDebug ? traceLog : null);
                    // Mẫu số dùng chung loại Metric với Tử số (trừ khi có config riêng typeB - mà hiện tại UI chưa hỗ trợ separate config nên cứ dùng chung)
                    const denVal = this.calculateGroupValue(employee, col.denominator, metricType, isTargetDebug ? traceLog : null);

                    if (isTargetDebug) { 
                         // Điều kiện lọc log: In ra nếu có mẫu số > 0 để kiểm tra
                         if (denVal > 0) {
                             console.groupCollapsed(`🕵️ [TRACE] ${employee.hoTen} - ${col.header} (% ${metricType})`);
                             console.log(`%c Tử số (${metricType}): ${formatters.formatNumber(numVal)}`, 'color: green');
                             console.log(`%c Mẫu số (${metricType}): ${formatters.formatNumber(denVal)}`, 'color: red; font-weight: bold');
                             console.log(`👇 CHI TIẾT CÁC MÓN CỘNG VÀO:`);
                             traceLog.forEach(log => console.log(log));
                             console.groupEnd();
                         }
                    }
                    // --- TRACE DEBUG END ---

                    const val = denVal > 0 ? numVal / denVal : 0;
                    cellData.value = val;
                    cellData.display = formatters.formatPercentage(val);
                    
                    if (numVal > 0 || denVal > 0) hasAnyData = true;

                    if (!totalRow.cells[colId]) totalRow.cells[colId] = { num: 0, den: 0, type: 'PERCENT' };
                    totalRow.cells[colId].num += numVal;
                    totalRow.cells[colId].den += denVal;

                } else {
                    // Logic Cột thường (DT, SL, DTQD)
                    cellData.sl = this.calculateGroupValue(employee, col.items, 'SL');
                    cellData.dt = this.calculateGroupValue(employee, col.items, 'DT');
                    cellData.dtqd = this.calculateGroupValue(employee, col.items, 'DTQD');

                    if (col.type === 'SL') {
                        cellData.value = cellData.sl;
                        cellData.display = formatters.formatNumber(cellData.sl);
                    } else if (col.type === 'DTQD') {
                        cellData.value = cellData.dtqd;
                        cellData.display = formatters.formatRevenue(cellData.dtqd);
                    } else {
                        cellData.value = cellData.dt;
                        cellData.display = formatters.formatRevenue(cellData.dt);
                    }

                    if (cellData.value > 0 || cellData.sl > 0 || cellData.dt > 0 || cellData.dtqd > 0) hasAnyData = true;

                    if (!totalRow.cells[colId]) totalRow.cells[colId] = { sl: 0, dt: 0, dtqd: 0, val: 0, type: col.type || 'DT' };
                    totalRow.cells[colId].sl += cellData.sl;
                    totalRow.cells[colId].dt += cellData.dt;
                    totalRow.cells[colId].dtqd += cellData.dtqd;
                    totalRow.cells[colId].val += cellData.value;
                }

                row.cells[colId] = cellData;
                if (col.isMain) {
                    row.mainValue = cellData.value;
                    row.mainValue_sl = cellData.sl;
                    row.mainValue_dtqd = cellData.dtqd;
                }
            });

            return hasAnyData ? row : null;
        }).filter(Boolean);

        Object.keys(totalRow.cells).forEach(key => {
            const cell = totalRow.cells[key];
            if (cell.type === 'PERCENT') {
                const val = cell.den > 0 ? cell.num / cell.den : 0;
                cell.value = val;
                cell.display = formatters.formatPercentage(val);
            } else {
                if (cell.type === 'SL') cell.display = formatters.formatNumber(cell.val);
                else cell.display = formatters.formatRevenue(cell.val);
                cell.value = cell.val;
                
                if (key === 'mainValue') {
                    totalRow.mainValue = cell.val;
                    totalRow.mainValue_sl = cell.sl;
                    totalRow.mainValue_dtqd = cell.dtqd;
                }
            }
        });

        return { processedData, totals: totalRow };
    },

    sortTableData(data, key, direction) {
        return [...data].sort((a, b) => {
            if (key === 'hoTen') {
                return direction === 'asc' ? a.hoTen.localeCompare(b.hoTen) : b.hoTen.localeCompare(a.hoTen);
            }
            const valA = a.cells[key]?.value ?? a[key] ?? 0;
            const valB = b.cells[key]?.value ?? b[key] ?? 0;
            return direction === 'asc' ? valA - valB : valB - valA;
        });
    }
};
<<< FILE_END: src/services/processing/logic/dynamicTable.processor.js

>>> FILE_START: src/services/processing/logic/regional.processor.js
// src/services/processing/logic/regional.processor.js
import { helpers } from '../helpers.js';

export const regionalProcessor = {
    // Xử lý file Excel Thi Đua Vùng
    processThiDuaVungFile(workbook) {
        const sheetNames = workbook.SheetNames;
        
        const chiTietSheetName = sheetNames.find(name => {
            const upperName = name.toUpperCase();
            return upperName.includes('CHITIET') || upperName.includes('CHI TIẾT');
        });
        
        const tongSheetName = sheetNames.find(name => {
            const upperName = name.toUpperCase();
            return upperName.includes('TONG') || upperName.includes('SIEU THI');
        });

        const chiTietSheet = chiTietSheetName ? workbook.Sheets[chiTietSheetName] : null;
        const tongSheet = tongSheetName ? workbook.Sheets[tongSheetName] : null;

        if (!chiTietSheet || !tongSheet) {
            throw new Error('File Excel phải chứa sheet (CHITIET/CHI TIẾT) và (TONG/SIEU THI).');
        }
        
        const chiTietData = helpers.findHeaderAndProcess(chiTietSheet, ['siêu thị', 'ngành hàng', 'kênh']);
        const tongData = helpers.findHeaderAndProcess(tongSheet, ['siêu thị', 'tổng thưởng']);

        return { chiTietData, tongData };
    }
};
<<< FILE_END: src/services/processing/logic/regional.processor.js

>>> FILE_START: src/services/processing/logic/timekeeping.processor.js
// src/services/processing/logic/timekeeping.processor.js
import { get } from 'svelte/store';
import { rawGioCongData, employeeNameToMaNVMap } from '../../../stores.js';

export const timekeepingProcessor = {
    // Xử lý dữ liệu giờ công
    processGioCongData() {
        const gioCongByMSNV = {};
        let currentMaNV = null;
        if (!get(rawGioCongData) || get(rawGioCongData).length === 0) return gioCongByMSNV;

        for (const row of get(rawGioCongData)) {
            const maNV = String(row.maNV || '').trim();
            const hoTen = String(row.hoTen || '').trim().replace(/\s+/g, ' ');
            
            // Tìm MSNV nếu file giờ công không có cột MSNV (dùng tên để map)
            let foundMaNV = maNV || get(employeeNameToMaNVMap).get(hoTen.toLowerCase()) || null;
            
            if (foundMaNV) currentMaNV = foundMaNV;

            if (currentMaNV && gioCongByMSNV[currentMaNV] === undefined) {
                gioCongByMSNV[currentMaNV] = 0;
            }

            const gioCongValue = parseFloat(String(row.tongGioCong || '0').replace(/,/g, '')) || 0;
            if (currentMaNV && gioCongValue > 0) {
                gioCongByMSNV[currentMaNV] += gioCongValue;
            }
        }
        return gioCongByMSNV;
    }
};
<<< FILE_END: src/services/processing/logic/timekeeping.processor.js

>>> FILE_START: src/services/processing/normalizers.js
import { config } from '../../config.js';
import { debugInfo, rawGioCongData } from '../../stores.js';
import { helpers } from './helpers.js';

export const normalizers = {
    normalizeCategoryStructureData(rawData) {
        if (!rawData || rawData.length === 0) {
            return { success: false, error: 'File rỗng.', normalizedData: [] };
        }
        const header = Object.keys(rawData[0] || {});
        
        const nganhHangCol = helpers.findColumnName(header, ['ngành hàng', 'nganh hang']);
        const nhomHangCol = helpers.findColumnName(header, ['nhóm hàng', 'nhom hang']);
        const nhaSanXuatCol = helpers.findColumnName(header, ['nhà sản xuất', 'nha san xuat', 'hãng', 'brand']);

        const missingCols = [];
        if (!nganhHangCol) missingCols.push('"Ngành hàng"');
        if (!nhomHangCol) missingCols.push('"Nhóm hàng"');
        if (!nhaSanXuatCol) missingCols.push('"Nhà sản xuất"');

        if (missingCols.length > 0) {
            return { success: false, error: `File thiếu các cột: ${missingCols.join(', ')}`, normalizedData: [] };
        }

        const normalizedData = rawData
            .map(row => ({
                nganhHang: String(row[nganhHangCol] || '').trim(),
                nhomHang: String(row[nhomHangCol] || '').trim(),
                nhaSanXuat: String(row[nhaSanXuatCol] || '').trim(),
            }))
            .filter(item => item.nganhHang && item.nhomHang);
            
        return { success: true, normalizedData };
    },
    
    normalizeSpecialProductData(rawData) {
        if (!rawData || rawData.length === 0) {
            return { success: false, error: 'File rỗng.', normalizedData: [] };
        }
        const header = Object.keys(rawData[0] || {});
        const maSpCol = helpers.findColumnName(header, ['mã sản phẩm', 'masanpham', 'mã sp', 'product code']);
        const nhomHangCol = helpers.findColumnName(header, ['nhóm hàng', 'nhom hang']);
        const tenSpCol = helpers.findColumnName(header, ['tên sản phẩm', 'tensanpham', 'tên sp']);

        const missingColumns = [];
        if (!maSpCol) missingColumns.push('Mã sản phẩm');
        if (!nhomHangCol) missingColumns.push('Nhóm hàng');
        if (!tenSpCol) missingColumns.push('Tên sản phẩm');

        if (missingColumns.length > 0) {
            return { success: false, error: `File thiếu các cột bắt buộc: ${missingColumns.join(', ')}.`, normalizedData: [] };
        }

        const normalizedData = rawData
            .map(row => ({
                maSanPham: String(row[maSpCol] || '').trim(),
                nhomHang: String(row[nhomHangCol] || '').trim(),
                tenSanPham: String(row[tenSpCol] || '').trim(),
            }))
            .filter(item => item.maSanPham && item.nhomHang && item.tenSanPham);

        return { success: true, normalizedData };
    },

    normalizeBrandData(rawData) {
        if (!rawData || rawData.length === 0) {
             return { success: false, error: 'Sheet "Hãng" rỗng.', normalizedData: [] };
        }
        const header = Object.keys(rawData[0] || {});
        const brandCol = helpers.findColumnName(header, ['hãng', 'tên hãng', 'nhà sản xuất']);
        if (!brandCol) {
            return { success: false, error: 'Sheet "Hãng" phải có cột "Hãng" hoặc "Tên Hãng".', normalizedData: [] };
        }

        const normalizedData = rawData
            .map(row => String(row[brandCol] || '').trim())
            .filter(brand => brand);
        return { success: true, normalizedData: [...new Set(normalizedData)].sort() };
    },

    normalizeData(rawData, fileType) {
        const mapping = config.COLUMN_MAPPINGS[fileType];
        if (!mapping) {
            console.error(`No column mapping found for fileType: ${fileType}`);
            return { normalizedData: [], success: false, missingColumns: ['Unknown mapping'] };
        }

        if (!rawData || rawData.length === 0) {
            return { normalizedData: [], success: true, missingColumns: [] };
        }

        const header = Object.keys(rawData[0] || {});
        const foundMapping = {};
        let allRequiredFound = true;
        const missingColumns = [];

        const newDebugInfo = { required: [], found: header, firstFiveMsnv: [] };
        for (const key in mapping) {
            const { required, displayName, aliases } = mapping[key];
            const foundName = helpers.findColumnName(header, aliases);
            foundMapping[key] = foundName;

            if (required) {
                const status = !!foundName;
                newDebugInfo.required.push({ displayName, foundName: foundName || 'Không tìm thấy', status: status });
                if (!status) {
                    allRequiredFound = false;
                    missingColumns.push(displayName);
                }
            }
        }

        if (fileType === 'giocong' || fileType === 'thuongnong') {
            if (!foundMapping.maNV && !foundMapping.hoTen) {
                 allRequiredFound = false;
                const missingMsg = 'Mã NV hoặc Tên NV';
                missingColumns.push(missingMsg);
                if (!newDebugInfo.required.some(r => r.displayName.includes('NV'))) {
                     newDebugInfo.required.push({ displayName: missingMsg, foundName: 'Không tìm thấy', status: false });
                }
            }
        }

        if (!allRequiredFound) {
            debugInfo.update(currentInfo => ({ ...currentInfo, [fileType]: newDebugInfo }));
            return { normalizedData: [], success: false, missingColumns };
        }

        // [LOGIC PREP]
        let heSoMap = {};
        if (fileType === 'ycx') {
            heSoMap = helpers.getHeSoQuyDoi(); 
        }

        const normalizedData = rawData.map((row, index) => {
            const newRow = {};
            for (const key in foundMapping) {
                if (foundMapping[key]) {
                    if (key === 'maNV' || key === 'hoTen' || key === 'maSanPham') {
                         newRow[key] = String(row[foundMapping[key]] || '').trim();
                    } else if ((key === 'ngayTao' || key === 'ngayHenGiao') && row[foundMapping[key]]) {
                        const dateValue = row[foundMapping[key]];
                        if (dateValue instanceof Date) {
                             newRow[key] = dateValue;
                        } else if (typeof dateValue === 'number') {
                            newRow[key] = new Date(Math.round((dateValue - 25569) * 86400 * 1000));
                        } else if (typeof dateValue === 'string') {
                             const parsedDate = new Date(dateValue.replace(/(\d{2})\/(\d{2})\/(\d{4})/, '$2/$1/$3'));
                            if (!isNaN(parsedDate.getTime())) newRow[key] = parsedDate;
                        }
                    } else {
                         newRow[key] = row[foundMapping[key]];
                    }
                }
            }

            // --- [NEW LOGIC FIXED] TÍNH TOÁN DOANH THU QUY ĐỔI ---
            if (fileType === 'ycx') {
                // 1. Chuẩn hóa doanh thu thực
                let revenue = 0;
                if (newRow.thanhTien) {
                    revenue = parseFloat(String(newRow.thanhTien).replace(/,/g, '')) || 0;
                }
                newRow.revenue = revenue; 

                // 2. Xác định Hệ số gốc (Base Rate)
                const productKey = String(newRow.nhomHang || '').trim();
                const baseRate = heSoMap[productKey] || 1;

                // 3. Xác định thưởng Trả Góp (Bonus Rate) - Dùng includes thay vì Set
                const exportModeRaw = String(newRow.hinhThucXuat || '');
                const exportModeLower = exportModeRaw.toLowerCase();
                
                // Logic: Chỉ cần chứa từ khóa "trả góp" hoặc "trả chậm" là dính
                const isInstallment = exportModeLower.includes('trả góp') || exportModeLower.includes('trả chậm');
                const bonusRate = isInstallment ? 0.3 : 0;

                // 4. Tính toán
                newRow.heSoQuyDoi = baseRate + bonusRate; 
                newRow.revenueQuyDoi = revenue * newRow.heSoQuyDoi;
                
                // [DEBUG LOG - CHỈ HIỆN 1 DÒNG ĐẦU TIÊN ĐỂ SOI]
                if (index === 0) {
                    console.group(`%c🔍 DEBUG LOGIC QUY ĐỔI (Dòng 1)`, "color: white; background: red; font-weight: bold; padding: 2px 5px");
                    console.log(`- Sản phẩm: ${productKey}`);
                    console.log(`- Hệ số gốc (Base): ${baseRate}`);
                    console.log(`- Hình thức xuất: "${exportModeRaw}"`);
                    console.log(`- Có phải trả góp không?: ${isInstallment ? '✅ CÓ (+30%)' : '❌ KHÔNG'}`);
                    console.log(`- Tổng hệ số: ${baseRate} + ${bonusRate} = ${newRow.heSoQuyDoi}`);
                    console.log(`- Doanh thu gốc: ${revenue.toLocaleString()}`);
                    console.log(`- Doanh thu quy đổi: ${newRow.revenueQuyDoi.toLocaleString()}`);
                    console.groupEnd();
                }
            }
            // ------------------------------------------------------------------

            return newRow;
        });

        if (fileType === 'giocong') {
            const giocongRawList = rawData.map(row => {
                const newRow = {};
                for (const key in foundMapping) {
                    if (foundMapping[key]) newRow[key] = row[foundMapping[key]];
                }
                return newRow;
            });
            rawGioCongData.set(giocongRawList);
        }

        newDebugInfo.firstFiveMsnv = normalizedData.slice(0, 5).map(r => r.maNV).filter(Boolean);
        debugInfo.update(currentInfo => ({ ...currentInfo, [fileType]: newDebugInfo }));
        
        return { normalizedData, success: true, missingColumns: [] };
    }
};
<<< FILE_END: src/services/processing/normalizers.js

>>> FILE_START: src/services/processing/parsers/cluster.parser.js
// src/services/processing/parsers/cluster.parser.js
import { formatters } from '../../../utils/formatters.js';

export const clusterParser = {
    /**
     * 1. Xử lý "Thi đua siêu thị lũy kế" (Logic 3 Tầng)
     */
    parseCompetitionStr: (text) => {
        if (!text) return null;
        const lines = text.split('\n').map(l => l.trim()).filter(l => l);
        
        // Tầng 1: Tìm danh sách Ngành hàng
        let categories = [];
        const domainIndex = lines.findIndex(l => l.toLowerCase().includes('tên miền'));
        if (domainIndex !== -1 && domainIndex + 1 < lines.length) {
            // Lấy dòng ngay sau "tên miền"
            // Tách theo tab hoặc khoảng trắng lớn (2 spaces trở lên)
            categories = lines[domainIndex + 1].split(/\t|\s{2,}/).filter(s => s.trim());
        }

        // Tầng 2: Tìm tỷ trọng % Tổng
        let totalPercents = [];
        const totalIndex = lines.findIndex(l => l.toLowerCase() === 'tổng' || l.toLowerCase().startsWith('tổng '));
        if (totalIndex !== -1 && totalIndex + 1 < lines.length) {
            totalPercents = lines[totalIndex + 1].split(/\t|\s+/).filter(s => s.includes('%'));
        }

        // Tầng 3: Tìm Siêu thị và Data chi tiết
        const stores = [];
        // Bắt đầu quét từ sau dòng Tổng + 1 (dòng chứa %)
        let startIndex = totalIndex !== -1 ? totalIndex + 2 : 0;
        
        for (let i = startIndex; i < lines.length; i++) {
            const line = lines[i];
            
            // Nhận diện Tên siêu thị: Là dòng chứa ký tự chữ, KHÔNG chứa quá nhiều số
            // Logic: Nếu dòng tiếp theo (i+1) chứa cặp giá trị (% và số) -> Dòng hiện tại là Tên Siêu Thị
            const nextLine = lines[i+1];
            if (nextLine && /[\d]+/.test(nextLine) && nextLine.includes('%')) {
                const storeName = line;
                const rawValues = nextLine.split(/\t|\s+/).filter(s => s);
                
                // Parse cặp giá trị: Xen kẽ % (Thực hiện) và Số (Doanh thu)
                // Cấu trúc mong đợi: [Val1_%, Val1_DT, Val2_%, Val2_DT...]
                const storeData = categories.map((cat, idx) => {
                    // Mỗi category chiếm 2 vị trí trong mảng rawValues
                    const pIndex = idx * 2;
                    const vIndex = idx * 2 + 1;
                    
                    return {
                        category: cat,
                        percent: rawValues[pIndex] || '0%',
                        revenue: formatters.parseNumber(rawValues[vIndex] || '0')
                    };
                });

                stores.push({
                    name: storeName,
                    data: storeData
                });
                
                i++; // Nhảy qua dòng dữ liệu để tiếp tục vòng lặp
            }
        }

        return {
            categories,
            totalPercents,
            stores
        };
    },

    /**
     * 2. Xử lý "Data lũy kế" (Tổng Cụm + Chi tiết 16 cột)
     */
    parseCumulativeStr: (text) => {
        if (!text) return null;
        const lines = text.split('\n').map(l => l.trim());
        const fullText = lines.join(' ');

        // A. Parse Tổng Cụm (KPI Cards)
        const kpiMapping = {
            'DTLK': { key: 'dtThuc', type: 'money' },
            'DT Dự Kiến': { key: 'dtThucDuKien', type: 'money' },
            'DTQĐ': { key: 'dtQuyDoi', type: 'money' },
            'DT Dự Kiến (QĐ)': { key: 'dtQuyDoiDuKien', type: 'money' },
            '% HT Target Dự Kiến (QĐ)': { key: 'percentQuyDoi', type: 'percent' },
            'DTCK Tháng': { key: 'growth', type: 'growth' }, // Lấy cả 2 giá trị
            'Tỷ Trọng Trả Góp': { key: 'traGopPercent', type: 'percent' },
            'DT Siêu thị': { key: 'traGopRevenue', type: 'money' }
        };

        const generalStats = {};

        // Helper regex tìm giá trị sau từ khóa
        const findVal = (keyword) => {
            // Regex: Tìm keyword -> bỏ qua khoảng trắng/dấu : -> lấy cụm số (có thể có dấu , . % - +)
            const escaped = keyword.replace('(', '\\(').replace(')', '\\)');
            const regex = new RegExp(`${escaped}\\s*[:]?\\s*([\\d,.]+%?)`, 'i');
            const match = fullText.match(regex);
            return match ? match[1] : '0';
        };

        Object.keys(kpiMapping).forEach(label => {
            const config = kpiMapping[label];
            if (config.key === 'growth') {
                // Xử lý riêng cho Tăng trưởng (lấy 2 giá trị: số tiền và %)
                const regex = /DTCK Tháng\s*[:]?\s*([+\-\d,.]+)\s+([+\-\d,.]+%)/i;
                const match = fullText.match(regex);
                if (match) {
                    generalStats[config.key] = {
                        value: formatters.parseNumber(match[1]),
                        percent: match[2]
                    };
                }
            } else {
                const raw = findVal(label);
                generalStats[config.key] = config.type === 'percent' ? raw : formatters.parseNumber(raw);
            }
        });

        // B. Parse Chi tiết Siêu thị (16 cột ngang)
        const storeDetails = [];
        
        // Tìm dòng chứa từ khóa "Tổng" -> Sau đó là Tên Siêu Thị -> Sau đó là Data
        // Regex: Tìm chữ "Tổng" -> (Nhóm 1: Tên siêu thị) -> (Nhóm 2: Chuỗi số liệu còn lại)
        // Giả định Tên siêu thị không chứa số, hoặc ít số. Data bắt đầu bằng số.
        lines.forEach(line => {
            if (line.includes('Tổng')) {
                // Tách phần sau chữ Tổng
                const afterTong = line.split('Tổng')[1].trim();
                
                // Tách Tên siêu thị và Dữ liệu
                // Cách tách: Tìm vị trí của con số đầu tiên
                const firstDigitIndex = afterTong.search(/[\d-]/); // Tìm số hoặc dấu âm
                
                if (firstDigitIndex !== -1) {
                    const storeName = afterTong.substring(0, firstDigitIndex).trim();
                    const dataPart = afterTong.substring(firstDigitIndex).trim();
                    
                    // Tách các cột dữ liệu (Space hoặc Tab)
                    const cols = dataPart.split(/\s+/);
                    
                    // Map 16 cột cố định
                    if (cols.length >= 15) { // Chấp nhận thiếu 1 vài cột cuối nếu data lỗi
                         storeDetails.push({
                            name: storeName,
                            dtHomQua: formatters.parseNumber(cols[0]),
                            dtLuyKe: formatters.parseNumber(cols[1]),
                            dtDuKien: formatters.parseNumber(cols[2]),
                            dtQuyDoi: formatters.parseNumber(cols[3]),
                            dtQuyDoiDuKien: formatters.parseNumber(cols[4]),
                            percentHTQuyDoi: cols[5],
                            growthNum: formatters.parseNumber(cols[6]),
                            growthPercent: cols[7], // +/- DTCK Tháng (QĐ) ??? Cần check lại thứ tự
                            laiGopQuyDoi: formatters.parseNumber(cols[8]),
                            percentLNTT: cols[9],
                            luotKhachLK: formatters.parseNumber(cols[10]),
                            growthLuotKhach: cols[11],
                            tlpvtcLK: cols[12],
                            growthTlpvtc: cols[13],
                            tyTrongTraGop: cols[14],
                            growthTraGop: cols[15] || '0%'
                        });
                    }
                }
            }
        });

        return {
            generalStats,
            storeDetails
        };
    }
};
<<< FILE_END: src/services/processing/parsers/cluster.parser.js

>>> FILE_START: src/services/processing/parsers/employee.parser.js
import readXlsxFile from 'read-excel-file';

// Cấu hình Schema để map cột từ Excel sang biến
const SCHEMA = {
  'Mã nhân viên': {
    prop: 'ma_nv',
    type: String,
    required: true
  },
  'Tên nhân viên': {
    prop: 'ten_nv',
    type: String,
    required: true
  },
  'Mã kho': {
    prop: 'ma_kho',
    type: String,
    required: true
  },
  'Mã cụm': {
    prop: 'ma_cum',
    type: String,
    // Không bắt buộc required: true nếu có nhân viên không thuộc cụm, 
    // nhưng cần định nghĩa để map đúng cột
  },
  'Vị trí': {
    prop: 'vi_tri',
    type: String
  },
  'Ngày vào làm': {
    prop: 'ngay_vao_lam',
    type: Date
  }
  // Thêm các cột khác nếu cần thiết
};

export const parseEmployeeData = async (file) => {
  try {
    const { rows, errors } = await readXlsxFile(file, { schema: SCHEMA });

    if (errors && errors.length > 0) {
      console.error('Lỗi đọc file nhân viên:', errors);
      // Có thể throw lỗi hoặc vẫn xử lý tiếp tùy logic business
    }

    // Set để lưu các mã duy nhất
    const warehouseSet = new Set();
    const clusterSet = new Set();

    // Duyệt qua từng dòng để xử lý dữ liệu và thu thập meta data
    const processedData = rows.map((row) => {
      // Chuẩn hóa dữ liệu (trim spaces, uppercase nếu cần)
      const maKho = row.ma_kho ? row.ma_kho.toString().trim().toUpperCase() : '';
      const maCum = row.ma_cum ? row.ma_cum.toString().trim().toUpperCase() : '';

      // Thêm vào Set để đếm
      if (maKho) warehouseSet.add(maKho);
      if (maCum) clusterSet.add(maCum);

      return {
        ...row,
        ma_kho: maKho,
        ma_cum: maCum,
        // Giữ lại giá trị gốc hoặc xử lý thêm các trường khác tại đây
      };
    });

    // --- LOGIC XỬ LÝ ĐA KHO & BỘ LỌC ---
    
    // Chuyển Set thành Array
    const uniqueWarehouses = Array.from(warehouseSet).sort();
    const uniqueClusters = Array.from(clusterSet).sort();

    // Logic kích hoạt chế độ đa kho: Nếu có từ 2 mã kho trở lên
    const isMultiWarehouseMode = uniqueWarehouses.length >= 2;

    // Chuẩn bị dữ liệu cho bộ lọc (Filter Options)
    // 1. Options cho Kho (giữ nguyên mã)
    const warehouseOptions = uniqueWarehouses.map(code => ({
      value: code,
      label: code,
      type: 'warehouse'
    }));

    // 2. Options cho Cụm (Thêm chữ "Cụm" vào label để phân biệt)
    const clusterOptions = uniqueClusters.map(code => ({
      value: code, // Value vẫn giữ nguyên để filter dữ liệu chính xác
      label: `Cụm ${code}`, // Label hiển thị: "Cụm AG01"
      type: 'cluster'
    }));

    // Gộp tất cả option vào một mảng filter chung (nếu UI dùng chung 1 dropdown)
    // Hoặc UI có thể dùng riêng lẻ từ meta
    const allFilterOptions = [...warehouseOptions, ...clusterOptions];

    // Trả về cấu trúc đầy đủ
    return {
      data: processedData,
      meta: {
        isMultiWarehouseMode, // Flag kích hoạt chế độ
        uniqueWarehouses,     // Danh sách mã kho thô
        uniqueClusters,       // Danh sách mã cụm thô
        warehouseOptions,     // Danh sách options kho cho dropdown
        clusterOptions,       // Danh sách options cụm cho dropdown (đã format tên)
        allFilterOptions,     // Danh sách gộp
        totalRows: processedData.length
      }
    };

  } catch (error) {
    console.error("Critical error parsing employee file:", error);
    throw error;
  }
};
<<< FILE_END: src/services/processing/parsers/employee.parser.js

>>> FILE_START: src/services/processing/parsers/erp.parser.js
// src/services/processing/parsers/erp.parser.js
export const erpParser = {
    processThuongERP: (pastedText) => {
        if (!pastedText || !pastedText.trim()) return [];
        
        // [FIX GENESIS] Thay đổi cách split để xử lý cả \r\n (Windows) và \n (Linux/Mac)
        // Thêm .map(l => l.trim()) ngay lập tức để loại bỏ ký tự rác đầu/cuối dòng
        const lines = pastedText.trim().split(/\r?\n/).map(l => l.trim());
        
        const results = [];
        // Regex giữ nguyên logic cũ
        const regex = /(ĐML_|TGD|ĐMM|ĐMS).*?(BP .*?)(?:Nhân Viên|Trưởng Ca)(.*?)([\d,]+)$/;
        
        lines.forEach(line => {
            // Vì đã trim() ở trên, dòng này sạch.
            // Replace \s+ để gộp nhiều dấu cách thành 1 (an toàn cho regex)
            const cleanLine = line.replace(/\s+/g, ' '); 
            const match = cleanLine.match(regex);
            
            if (match) {
                results.push({ 
                    name: match[3].trim(), 
                    bonus: match[4].trim() 
                });
            }
        });
        return results;
    }
};
<<< FILE_END: src/services/processing/parsers/erp.parser.js

>>> FILE_START: src/services/processing/parsers/luyke.parser.js
// src/services/processing/parsers/luyke.parser.js
import { competitionData } from '../../../stores.js';

export const luykeParser = {
    // 1. Phân tích các chỉ số KPI chính (DT, DTQĐ, %HT)
    parseLuyKePastedData: (text) => {
        const defaults = {
            mainKpis: {},
            comparisonData: { value: 0, percentage: 'N/A' },
            luotKhachData: { value: 0, percentage: 'N/A' },
            dtDuKien: 0, dtqdDuKien: 0, dtTraCham: 0, tyLeTraCham: 0 
        };
        if (!text) return defaults;

        const allLines = text.split('\n').map(line => line.trim());
        const textContent = allLines.join(' ');

        const patterns = {
            'Thực hiện DT thực': /DTLK\s+([\d,.]+)/,
            'Thực hiện DTQĐ': /DTQĐ\s+([\d,.]+)/,
            '% HT Target Dự Kiến (QĐ)': /% HT Target Dự Kiến \(QĐ\)\s+([\d.]+%?)/,
        };

        for (const [key, regex] of Object.entries(patterns)) {
            const match = textContent.match(regex);
            if (match && match[1]) {
                defaults.mainKpis[key] = match[1];
            }
        }

        const findValueAfterKeyword = (lines, keyword, isQd = false) => {
            let keywordRegex;
            if (isQd) {
                keywordRegex = new RegExp(keyword.replace('(', '\\(').replace(')', '\\)'));
            } else {
                keywordRegex = new RegExp(`^${keyword}$`);
            }

            const index = lines.findIndex(line => keywordRegex.test(line) && !/lượt khách/i.test(line));
            if (index !== -1 && index + 1 < lines.length) {
                return parseFloat(lines[index + 1].replace(/,/g, '').replace(/%/g, '')) || 0;
            }
            return 0;
        };

        defaults.dtDuKien = findValueAfterKeyword(allLines, "DT Dự Kiến");
        defaults.dtqdDuKien = findValueAfterKeyword(allLines, "DT Dự Kiến (QĐ)", true);
        defaults.dtTraCham = findValueAfterKeyword(allLines, "DT Siêu thị");
        defaults.tyLeTraCham = findValueAfterKeyword(allLines, "Tỷ Trọng Trả Góp");

        // Tìm tăng trưởng cùng kỳ
        const dtckIndex = allLines.findIndex(line => line.includes('DTCK Tháng'));
        if (dtckIndex !== -1 && dtckIndex + 1 < allLines.length) {
            const valueLine = allLines[dtckIndex + 1];
            const values = valueLine.split(/\s+/);
            if (values.length >= 2) {
                defaults.comparisonData = {
                    value: parseFloat(values[0].replace(/,/g, '')) || 0,
                    percentage: values[1] || 'N/A'
                };
            }
        }

        // Tìm lượt khách
        const luotKhachIndex = allLines.findIndex(line => line.includes('Lượt Khách CK Tháng'));
        if (luotKhachIndex !== -1 && luotKhachIndex + 1 < allLines.length) {
            const valueLine = allLines[luotKhachIndex + 1];
            const values = valueLine.split(/\s+/);
            if (values.length >= 2) {
                defaults.luotKhachData = {
                    value: parseFloat(values[0].replace(/,/g, '')) || 0,
                    percentage: values[1] || 'N/A'
                };
            }
        }

        return defaults;
    },

    // 2. Phân tích danh sách các chương trình thi đua (Tổng hợp)
    parseCompetitionDataFromLuyKe: (text) => {
        if (!text || !text.trim()) return [];
        const lines = text.split('\n').map(l => l.trim());
        const results = [];
        let currentCompetition = null;

        for (let i = 0; i < lines.length; i++) {
            const line = lines[i];
            if (line.toLowerCase().startsWith('thi đua')) {
                if (currentCompetition) results.push(currentCompetition);
                currentCompetition = {
                    name: line.replace("Thi đua doanh thu", "DT").replace("Thi đua số lượng", "SL"),
                    type: line.toLowerCase().includes('doanh thu') ? 'doanhThu' : 'soLuong',
                    luyKe: 0, target: 0, hoanThanh: '0%'
                };
            } else if (currentCompetition) {
                if (line.startsWith('DTLK') || line.startsWith('SLLK') || line.startsWith('DTQĐ')) {
                     if (i + 1 < lines.length) {
                         currentCompetition.luyKe = parseFloat(lines[i + 1].replace(/,/g, '')) || 0;
                    }
                } else if (line.startsWith('Target')) {
                    if (i + 1 < lines.length) {
                        currentCompetition.target = parseFloat(lines[i + 1].replace(/,/g, '')) || 0;
                    }
                } else if (line.startsWith('% HT Dự Kiến')) {
                    if (i + 1 < lines.length) {
                         currentCompetition.hoanThanh = lines[i + 1] || '0%';
                    }
                }
            }
        }
        if (currentCompetition) results.push(currentCompetition);

        competitionData.set(results);
        return results;
    }
};
<<< FILE_END: src/services/processing/parsers/luyke.parser.js

>>> FILE_START: src/services/processing/parsers/thidua.parser.js
// src/services/processing/parsers/thidua.parser.js
import { debugInfo } from '../../../stores.js';

export const thiduaParser = {
    parsePastedThiDuaTableData(rawText) {
        const newDebugInfo = { required: [], found: [], status: 'Bắt đầu phân tích...' };

        if (!rawText || !rawText.trim()) {
            newDebugInfo.status = 'Lỗi: Dữ liệu dán vào rỗng.';
            debugInfo.update(current => ({ ...current, 'thiduanv-pasted': newDebugInfo }));
            return { success: false, error: newDebugInfo.status, mainHeaders: [], subHeaders: [], dataRows: [] };
        }

        const lines = rawText.split('\n').map(line => line.trim()).filter(line => line.length > 0);
        const splitRegex = /\s{2,}|\t/; 
        const numberCheckRegex = /^-?[\d,.]+$/;

        const mainHeaderStartIndex = lines.findIndex(line => line.includes('Phòng ban'));
        const subHeaderStartIndex = lines.findIndex(line => line.startsWith('DTLK') || line.startsWith('SLLK') || line.startsWith('DTQĐ'));
        
        let dataEndIndex = lines.findIndex(line => line.includes('Hỗ trợ BI'));
        if (dataEndIndex === -1) {
            dataEndIndex = lines.length;
        }

        const dataRowsStartIndex = lines.findIndex((line, index) => {
            if (index <= subHeaderStartIndex) return false;
            const parts = line.split(splitRegex).map(p => p.trim());
            const firstPart = parts[0] || "";

            if (firstPart.startsWith('Tổng') || firstPart.startsWith('BP ') || firstPart.startsWith('DTLK') || firstPart.startsWith('SLLK') || firstPart.startsWith('DTQĐ')) {
               return false;
            }
            return parts.length > 1 && numberCheckRegex.test(parts[1]);
        });

        if (mainHeaderStartIndex === -1 || subHeaderStartIndex === -1 || dataRowsStartIndex === -1) {
            let error = "Dữ liệu không hợp lệ thi đua ngành hàng theo nhân viên, vui lòng kiểm tra lại";
            newDebugInfo.status = error;
            debugInfo.update(current => ({ ...current, 'thiduanv-pasted': newDebugInfo }));
            return { success: false, error: error, mainHeaders: [], subHeaders: [], dataRows: [] };
        }
        
        const mainHeaderLines = lines.slice(mainHeaderStartIndex + 1, subHeaderStartIndex);
        const mainHeaderString = mainHeaderLines.join('\t');
        const mainHeaders = mainHeaderString.split(splitRegex).filter(Boolean);
        newDebugInfo.found.push({ name: 'Tiêu đề chính (Ngành hàng)', value: `${mainHeaders.length} mục`, status: mainHeaders.length > 0 });

        const subHeaderLines = lines.slice(subHeaderStartIndex, dataRowsStartIndex);
        const subHeaderString = subHeaderLines.join('\t');
        const subHeaders = subHeaderString.split(/\s+/).filter(Boolean);
        newDebugInfo.found.push({ name: 'Tiêu đề phụ (SLLK/DTQĐ)', value: `${subHeaders.length} mục`, status: subHeaders.length > 0 });

        const potentialDataLines = lines.slice(dataRowsStartIndex, dataEndIndex);
        const dataRows = [];
        
        for (const line of potentialDataLines) {
            const parts = line.split(splitRegex).map(p => p.trim());
            const firstPart = parts[0] || "";

            if (firstPart.startsWith('Tổng') || firstPart.startsWith('BP ')) {
                continue;
            }

            if (parts.length > 1 && numberCheckRegex.test(parts[1])) {
                dataRows.push({
                    name: firstPart,
                    values: parts.slice(1)
                });
            }
        }
        newDebugInfo.found.push({ name: 'Dòng dữ liệu nhân viên', value: `${dataRows.length} dòng`, status: dataRows.length > 0 });

        if (mainHeaders.length === 0 || subHeaders.length === 0 || dataRows.length === 0) {
            newDebugInfo.status = 'Lỗi: Không thể phân tích dữ liệu. Thiếu Tiêu đề chính, Tiêu đề phụ, hoặc Dòng dữ liệu (sau khi lọc).';
            debugInfo.update(current => ({ ...current, 'thiduanv-pasted': newDebugInfo }));
            return { success: false, error: newDebugInfo.status, mainHeaders, subHeaders, dataRows };
        }
        
        const expectedDataCols = subHeaders.length;
        if (dataRows.length > 0 && dataRows[0].values.length !== expectedDataCols) {
             newDebugInfo.status = `Cảnh báo: Số cột không khớp! Tiêu đề phụ (${expectedDataCols}) vs Dữ liệu (${dataRows[0].values.length}).`;
        } else {
           newDebugInfo.status = `Phân tích thành công.`;
        }
        
        debugInfo.update(current => ({ ...current, 'thiduanv-pasted': newDebugInfo }));
        return { success: true, mainHeaders, subHeaders, dataRows };
    }
};
<<< FILE_END: src/services/processing/parsers/thidua.parser.js

>>> FILE_START: src/services/processing/parsers.js
// src/services/processing/parsers.js
import { erpParser } from './parsers/erp.parser.js';
import { luykeParser } from './parsers/luyke.parser.js';
import { thiduaParser } from './parsers/thidua.parser.js';

export const parsers = {
    // --- ERP Logic ---
    processThuongERP: erpParser.processThuongERP,

    // --- Luy Ke Logic ---
    parseLuyKePastedData: luykeParser.parseLuyKePastedData,
    parseCompetitionDataFromLuyKe: luykeParser.parseCompetitionDataFromLuyKe,

    // --- Thi Dua Nhan Vien Logic ---
    parsePastedThiDuaTableData: thiduaParser.parsePastedThiDuaTableData
};
<<< FILE_END: src/services/processing/parsers.js

>>> FILE_START: src/services/processing/processors.js
// src/services/processing/processors.js
import { competitionProcessor } from './logic/competition.processor.js';
import { timekeepingProcessor } from './logic/timekeeping.processor.js';
import { regionalProcessor } from './logic/regional.processor.js';

export const processors = {
    // --- COMPETITION LOGIC ---
    debugCompetitionFiltering: competitionProcessor.debugCompetitionFiltering,
    updateCompetitionNameMappings: competitionProcessor.updateCompetitionNameMappings,
    processThiDuaNhanVienData: competitionProcessor.processThiDuaNhanVienData,

    // --- TIMEKEEPING LOGIC ---
    processGioCongData: timekeepingProcessor.processGioCongData,

    // --- REGIONAL LOGIC ---
    processThiDuaVungFile: regionalProcessor.processThiDuaVungFile
};
<<< FILE_END: src/services/processing/processors.js

>>> FILE_START: src/services/reportService.js
// src/services/reportService.js
// Version 3.0 - Modular Facade
// File này chỉ đóng vai trò điều phối, logic đã được tách ra thư mục reports/

import { masterReportLogic } from './reports/master.report.js';
import { competitionReportLogic } from './reports/competition.report.js';
import { detailReportLogic } from './reports/detail.report.js';
import { generalReportLogic } from './reports/general.report.js';

export const reportService = {
    ...masterReportLogic,
    ...competitionReportLogic,
    ...detailReportLogic,
    ...generalReportLogic
};
<<< FILE_END: src/services/reportService.js

>>> FILE_START: src/services/reports/competition.report.js
// src/services/reports/competition.report.js
// Version 1.1 - Fix: Include maKho in result for Realtime filtering
import { get } from 'svelte/store';
import * as utils from '../../utils.js';
import { dataProcessing } from '../dataProcessing.js';
import {
    danhSachNhanVien,
    specialProductList,
    thiDuaVungChiTiet,
    thiDuaVungTong
} from '../../stores.js';

export const competitionReportLogic = {
    calculateSpecialProductReport(sourceYcxData, specialProgramConfigs) {
        const $specialProductList = get(specialProductList);
        if (!sourceYcxData || sourceYcxData.length === 0 ||
            !specialProgramConfigs || specialProgramConfigs.length === 0 ||
            !$specialProductList || $specialProductList.length === 0) {
            return [];
        }

        const hinhThucXuatTinhDoanhThu = dataProcessing.getHinhThucXuatTinhDoanhThu();
        const validSalesData = sourceYcxData.filter(row => {
            const isDoanhThuHTX = hinhThucXuatTinhDoanhThu.has(row.hinhThucXuat);
            const isBaseValid = (row.trangThaiThuTien || "").trim() === 'Đã thu' &&
                                (row.trangThaiHuy || "").trim() === 'Chưa hủy' &&
                                (row.tinhTrangTra || "").trim() === 'Chưa trả' &&
                                (row.trangThaiXuat || "").trim() === 'Đã xuất';
            return isBaseValid && isDoanhThuHTX;
        });
        if (validSalesData.length === 0) return [];

        const $danhSachNhanVien = get(danhSachNhanVien);
        const report = specialProgramConfigs.map(program => {
            const programGroups = new Set((program.groups || []).map(g => String(g).trim()));
            if (programGroups.size === 0) return null;

            const specialProductSet = new Set(
                $specialProductList
                    .filter(sp => programGroups.has(String(sp.nhomHang).trim()))
                    .map(sp => String(sp.maSanPham).trim())
            );

            const totalGroupSales = validSalesData.filter(row => 
                programGroups.has(String(row.nhomHang).trim())
            );
    
            if (totalGroupSales.length === 0) return null;

            const employeeResults = $danhSachNhanVien.map(employee => {
                const stats = { slDacQuyen: 0, slNhomHang: 0, dtDacQuyen: 0, dtNhomHang: 0 };
                const employeeSales = totalGroupSales.filter(row => {
                    const msnvMatch = String(row.nguoiTao || '').match(/(\d+)/);
                    return msnvMatch && msnvMatch[1].trim() === employee.maNV;
                });
                if (employeeSales.length === 0) {
                    return { 
                        ...employee, 
                        maKho: employee.maKho, // [FIX] Ensure maKho is preserved
                        ...stats, 
                        tyLeSL: 0, 
                        tyLeDT: 0 
                    };
                }

                employeeSales.forEach(row => {
                    const maSanPham = String(row.maSanPham || '').trim();
                    const thanhTien = parseFloat(String(row.thanhTien || "0").replace(/,/g, '')) || 0;
                    const soLuong = parseInt(String(row.soLuong || "0"), 10) || 0;

                    stats.slNhomHang += soLuong;
                    stats.dtNhomHang += thanhTien;

                    if (specialProductSet.has(maSanPham)) {
                        stats.slDacQuyen += soLuong;
                        stats.dtDacQuyen += thanhTien;
                    }
                });
                const tyLeSL = stats.slNhomHang > 0 ? (stats.slDacQuyen / stats.slNhomHang) : 0;
                const tyLeDT = stats.dtNhomHang > 0 ? (stats.dtDacQuyen / stats.dtNhomHang) : 0;

                return {
                    maNV: employee.maNV,
                    hoTen: employee.hoTen,
                    boPhan: employee.boPhan,
                    maKho: employee.maKho, // [FIX] Add maKho here
                    ...stats,
                    tyLeSL,
                    tyLeDT
                };
            }).filter(e => e.slNhomHang > 0); 

            return {
                program: program,
                employeeData: employeeResults,
            };
        }).filter(Boolean); 

        return report;
    },

    calculateCompetitionFocusReport(sourceYcxData, competitionConfigs) {
        if (!sourceYcxData || sourceYcxData.length === 0 || !competitionConfigs || competitionConfigs.length === 0) {
            return [];
        }

        const hinhThucXuatTinhDoanhThu = dataProcessing.getHinhThucXuatTinhDoanhThu();
        const validSalesData = sourceYcxData.filter(row => {
            const isDoanhThuHTX = hinhThucXuatTinhDoanhThu.has(row.hinhThucXuat);
            const isBaseValid = (row.trangThaiThuTien || "").trim() === 'Đã thu' &&
                                 (row.trangThaiHuy || "").trim() === 'Chưa hủy' &&
                                (row.tinhTrangTra || "").trim() === 'Chưa trả' &&
                                (row.trangThaiXuat || "").trim() === 'Đã xuất';
            return isBaseValid && isDoanhThuHTX;
        });
        const $danhSachNhanVien = get(danhSachNhanVien);

        const report = competitionConfigs.map(config => {
            const cleanedConfigGroups = new Set((config.groups || []).map(g => utils.cleanCategoryName(g)));

            let baseSalesData = validSalesData.filter(row => {
                const cleanNhomHangFromYCX = utils.cleanCategoryName(row.nhomHang);
                const isInGroup = cleanedConfigGroups.has(cleanNhomHangFromYCX);
                
                if (!isInGroup) return false;

                if (config.type === 'soluong' && (config.minPrice > 0 || config.maxPrice > 0)) {
                    const price = (parseFloat(String(row.thanhTien || "0").replace(/,/g, '')) || 0) / (parseInt(String(row.soLuong || "1"), 10) || 1);
                    const minPrice = config.minPrice || 0;
                    const maxPrice = config.maxPrice || Infinity;
                    if (price < minPrice || price > maxPrice) return false;
                }
                return true;
            });

            if (config.excludeApple) {
                baseSalesData = baseSalesData.filter(row => row.nhaSanXuat !== 'Apple');
            }

            const employeeResults = $danhSachNhanVien.map(employee => {
                let performanceByBrand = {};
                let totalTargetRevenue = 0;
                let totalTargetQuantity = 0;
                let baseCategoryRevenue = 0;
                let baseCategoryQuantity = 0;

                baseSalesData.forEach(row => {
                     const msnvMatch = String(row.nguoiTao || '').match(/(\d+)/);
                     if (msnvMatch && msnvMatch[1].trim() === employee.maNV) {
                        const revenueValue = (parseFloat(String(row.thanhTien || "0").replace(/,/g, '')) || 0);
                        const quantityValue = (parseInt(String(row.soLuong || "0"), 10) || 0);

                        baseCategoryRevenue += revenueValue;
                        baseCategoryQuantity += quantityValue;

                        const brand = row.nhaSanXuat;
                        if ((config.brands || []).includes(brand)) {
                            if (!performanceByBrand[brand]) {
                                performanceByBrand[brand] = { revenue: 0, quantity: 0 };
                            }
                            performanceByBrand[brand].revenue += revenueValue;
                            performanceByBrand[brand].quantity += quantityValue;

                            totalTargetRevenue += revenueValue;
                            totalTargetQuantity += quantityValue;
                        }
                    }
                });
                return {
                    maNV: employee.maNV,
                    hoTen: employee.hoTen,
                    boPhan: employee.boPhan,
                    maKho: employee.maKho, // [FIX] Add maKho here so filter works
                    performanceByBrand,
                    targetBrandsRevenue: totalTargetRevenue,
                    targetBrandsQuantity: totalTargetQuantity,
                    baseCategoryRevenue,
                    baseCategoryQuantity,
                    tyLeDT: baseCategoryRevenue > 0 ? (totalTargetRevenue / baseCategoryRevenue) : 0,
                    tyLeSL: baseCategoryQuantity > 0 ? (totalTargetQuantity / baseCategoryQuantity) : 0,
                };
            }).filter(e => e.baseCategoryRevenue > 0 || e.baseCategoryQuantity > 0);

            return {
                competition: config,
                employeeData: employeeResults,
            };
        }).filter(r => r.employeeData.length > 0);

        return report;
    },

    generateThiDuaVungReport(selectedSupermarket) {
        const $thiDuaVungChiTiet = get(thiDuaVungChiTiet);
        const $thiDuaVungTong = get(thiDuaVungTong);

        if (!selectedSupermarket || !$thiDuaVungChiTiet || $thiDuaVungChiTiet.length === 0 || !$thiDuaVungTong || $thiDuaVungTong.length === 0) {
            return null;
        }

        const findKey = (data, keyword) => {
            if (!data || data.length === 0) return null;
            return Object.keys(data[0]).find(k => k.trim().toLowerCase().includes(keyword.toLowerCase())) || keyword;
        };
        const supermarketKeyTong = findKey($thiDuaVungTong, 'siêu thị');
        const supermarketKeyChiTiet = findKey($thiDuaVungChiTiet, 'siêu thị');
        const tongThuongKey = findKey($thiDuaVungChiTiet, 'tổng thưởng');
        const hangVuotTroiKey = findKey($thiDuaVungChiTiet, 'hạng vượt trội');
        const hangTargetKey = findKey($thiDuaVungChiTiet, 'hạng % target');
        const layTopKey = findKey($thiDuaVungChiTiet, 'lấy top');
        const kenhKey = findKey($thiDuaVungChiTiet, 'kênh');
        const nganhHangKey = findKey($thiDuaVungChiTiet, 'ngành hàng');

        if (!supermarketKeyTong || !supermarketKeyChiTiet) {
            console.error("Không thể tìm thấy cột 'siêu thị' trong dữ liệu.");
            return null;
        }

        const summary = $thiDuaVungTong.find(row => row[supermarketKeyTong] === selectedSupermarket);
        if (!summary) return null;

        const chiTiet = $thiDuaVungChiTiet.filter(row => row[supermarketKeyChiTiet] === selectedSupermarket);

        if (chiTiet.length > 0 && layTopKey) {
            summary.hangCoGiaiKenh = chiTiet[0][layTopKey];
        } else {
            summary.hangCoGiaiKenh = 'N/A';
        }

        const report = { summary, coGiai: [], sapCoGiai: [], tiemNang: [], canCoGangNhieu: [] };

        const getPotentialPrize = (kenh, nganhHang) => {
            const winningSupermarkets = $thiDuaVungChiTiet.filter(sm =>
                sm[kenhKey] === kenh && sm[nganhHangKey] === nganhHang && sm[tongThuongKey] > 0
            );
            if (winningSupermarkets.length === 0) return 0;
            return Math.min(...winningSupermarkets.map(s => s[tongThuongKey]));
        };

        chiTiet.forEach(nganhHang => {
            if (nganhHang[tongThuongKey] > 0) {
                report.coGiai.push(nganhHang);
            } else {
                const hangVuotTroi = nganhHang[hangVuotTroiKey] || Infinity;
                const hangTarget = nganhHang[hangTargetKey] || Infinity;
                const hangCoGiai = nganhHang[layTopKey] || 0;

                const khoangCach = Math.min(
                    (hangVuotTroi > 0 && hangVuotTroi > hangCoGiai) ? hangVuotTroi - hangCoGiai : Infinity,
                    (hangTarget > 0 && hangTarget > hangCoGiai) ? hangTarget - hangCoGiai : Infinity
                );
                nganhHang.khoangCach = khoangCach;

                if (hangCoGiai > 0 && khoangCach <= 20) {
                    nganhHang.thuongTiemNang = getPotentialPrize(nganhHang[kenhKey], nganhHang[nganhHangKey]);
                    report.sapCoGiai.push(nganhHang);
                } else if (hangCoGiai > 0 && khoangCach > 20 && khoangCach <= 40) {
                    report.tiemNang.push(nganhHang);
                } else {
                    report.canCoGangNhieu.push(nganhHang);
                }
            }
        });

        report.coGiai.sort((a, b) => b[tongThuongKey] - a[tongThuongKey]);
        report.sapCoGiai.sort((a, b) => a.khoangCach - b.khoangCach);
        report.tiemNang.sort((a, b) => a.khoangCach - b.khoangCach);

        return report;
    }
};
<<< FILE_END: src/services/reports/competition.report.js

>>> FILE_START: src/services/reports/detail.report.js
// src/services/reports/detail.report.js
// Version 1.0 - Detail views logic
import { get } from 'svelte/store';
import * as utils from '../../utils.js';
import { formatters } from '../../utils/formatters.js';
import { dataProcessing } from '../dataProcessing.js';
import { masterReportData } from '../../stores.js';

export const detailReportLogic = {
    generateRealtimeEmployeeDetailReport(employeeMaNV, realtimeYCXData) {
        if (!employeeMaNV || !realtimeYCXData || realtimeYCXData.length === 0) return null;

        const employeeData = realtimeYCXData.filter(row => {
            const msnvMatch = String(row.nguoiTao || '').match(/(\d+)/);
            return msnvMatch && msnvMatch[1].trim() === String(employeeMaNV);
        });

        if (employeeData.length === 0) return null;

        const hinhThucXuatTinhDoanhThu = dataProcessing.getHinhThucXuatTinhDoanhThu();
        const heSoQuyDoi = dataProcessing.getHeSoQuyDoi();

        const summary = {
            totalRealRevenue: 0,
            totalConvertedRevenue: 0,
            unexportedRevenue: 0
        };
        const byProductGroup = {};
        const byCustomer = {};

        employeeData.forEach(row => {
            const isDoanhThuHTX = hinhThucXuatTinhDoanhThu.has(row.hinhThucXuat);
            const isBaseValid = (row.trangThaiThuTien || "").trim() === 'Đã thu' && (row.trangThaiHuy || "").trim() === 'Chưa hủy' && (row.tinhTrangTra || "").trim() === 'Chưa trả';

            if (isDoanhThuHTX && isBaseValid) {
                const realRevenue = parseFloat(String(row.thanhTien || "0").replace(/,/g, '')) || 0;
                const quantity = parseInt(String(row.soLuong || "0"), 10) || 0;
                const heSo = heSoQuyDoi[row.nhomHang] || 1;
                
                // [FIX] Dùng revenueQuyDoi từ normalizer
                const convertedRevenue = row.revenueQuyDoi !== undefined ? row.revenueQuyDoi : (realRevenue * heSo);
                
                const groupName = utils.cleanCategoryName(row.nhomHang || 'Khác');
                const customerName = row.tenKhachHang || 'Khách lẻ';

                if ((row.trangThaiXuat || "").trim() === 'Đã xuất') {
                    summary.totalRealRevenue += realRevenue;
                    summary.totalConvertedRevenue += convertedRevenue;

                    if (!byProductGroup[groupName]) {
                        byProductGroup[groupName] = { name: groupName, quantity: 0, realRevenue: 0, convertedRevenue: 0 };
                    }
                    byProductGroup[groupName].quantity += quantity;
                    byProductGroup[groupName].realRevenue += realRevenue;
                    byProductGroup[groupName].convertedRevenue += convertedRevenue;

                    if (!byCustomer[customerName]) {
                        byCustomer[customerName] = { name: customerName, products: [], totalQuantity: 0 };
                    }
                    byCustomer[customerName].products.push({
                        productName: row.tenSanPham,
                        quantity: quantity,
                        realRevenue: realRevenue,
                        convertedRevenue: convertedRevenue,
                    });
                    byCustomer[customerName].totalQuantity += quantity;
                } else if ((row.trangThaiXuat || "").trim() === 'Chưa xuất') {
                    summary.unexportedRevenue += convertedRevenue;
                }
            }
        });

        summary.totalOrders = Object.keys(byCustomer).length;
        summary.bundledOrderCount = Object.values(byCustomer).filter(c => c.totalQuantity > 1).length;
        summary.conversionRate = summary.totalRealRevenue > 0 ? (summary.totalConvertedRevenue / summary.totalRealRevenue) - 1 : 0;

        return {
            summary,
            byProductGroup: Object.values(byProductGroup).sort((a, b) => b.realRevenue - a.realRevenue),
            byCustomer: Object.values(byCustomer)
        };
    },

    generateLuyKeEmployeeDetailReport(employeeMaNV, luykeYCXData) {
        if (!employeeMaNV || !luykeYCXData || luykeYCXData.length === 0) {
            return null;
        }

        const employeeData = luykeYCXData.filter(row => {
            const msnvMatch = String(row.nguoiTao || '').match(/(\d+)/);
            return msnvMatch && msnvMatch[1].trim() === String(employeeMaNV);
        });

        if (employeeData.length === 0) {
             return null;
        }

        const hinhThucXuatTinhDoanhThu = dataProcessing.getHinhThucXuatTinhDoanhThu();
        const heSoQuyDoi = dataProcessing.getHeSoQuyDoi();

        const summary = {
            totalRealRevenue: 0,
            totalConvertedRevenue: 0,
            unexportedRevenue: 0, 
        };
        const byProductGroup = {};
        const byCustomer = {};
        const categoryChartDataMap = {};
        const dailyStats = {}; 
        const unexportedDetails = {};
        
        employeeData.forEach(row => {
            const isDoanhThuHTX = hinhThucXuatTinhDoanhThu.has(row.hinhThucXuat);
            
            const isBaseValid = (row.trangThaiThuTien || "").trim() === 'Đã thu' &&
                                (row.trangThaiHuy || "").trim() === 'Chưa hủy' &&
                                (row.tinhTrangTra || "").trim() === 'Chưa trả';

            if (isDoanhThuHTX && isBaseValid) {
                const realRevenue = parseFloat(String(row.thanhTien || "0").replace(/,/g, '')) || 0;
                const quantity = parseInt(String(row.soLuong || "0"), 10) || 0;
                if(isNaN(realRevenue) || isNaN(quantity)) return;

                const heSo = heSoQuyDoi[row.nhomHang] || 1;
                
                // [FIX] Dùng revenueQuyDoi từ normalizer
                const convertedRevenue = row.revenueQuyDoi !== undefined ? row.revenueQuyDoi : (realRevenue * heSo);
                
                const groupName = utils.cleanCategoryName(row.nhomHang || 'Khác');
                const customerName = row.tenKhachHang || 'Khách Lẻ';
                const categoryName = utils.cleanCategoryName(row.nganhHang || 'Khác');
                const productName = row.tenSanPham || 'Không rõ';
                
                if ((row.trangThaiXuat || "").trim() === 'Đã xuất') {
                    summary.totalRealRevenue += realRevenue;
                    summary.totalConvertedRevenue += convertedRevenue;

                    if (!byProductGroup[groupName]) {
                        byProductGroup[groupName] = { name: groupName, quantity: 0, realRevenue: 0, convertedRevenue: 0 };
                    }
                    byProductGroup[groupName].quantity += quantity;
                    byProductGroup[groupName].realRevenue += realRevenue;
                    byProductGroup[groupName].convertedRevenue += convertedRevenue;

                    if (!categoryChartDataMap[categoryName]) {
                        categoryChartDataMap[categoryName] = { name: categoryName, revenue: 0 };
                    }
                    categoryChartDataMap[categoryName].revenue += realRevenue;
                    if (!byCustomer[customerName]) {
                        byCustomer[customerName] = { name: customerName, products: [], totalQuantity: 0, totalRealRevenue: 0, totalConvertedRevenue: 0 };
                    }
                    byCustomer[customerName].products.push({
                        productName: row.tenSanPham,
                        quantity: quantity,
                        realRevenue: realRevenue,
                        convertedRevenue: convertedRevenue,
                    });
                    byCustomer[customerName].totalQuantity += quantity;
                    byCustomer[customerName].totalRealRevenue += realRevenue;
                    byCustomer[customerName].totalConvertedRevenue += convertedRevenue;
                    
                    const ngayTao = row.ngayTao;
                    if (ngayTao instanceof Date) {
                        const dateString = ngayTao.toISOString().split('T')[0];
                        if (!dailyStats[dateString]) {
                            dailyStats[dateString] = { date: ngayTao, revenue: 0, convertedRevenue: 0 };
                        }
                        dailyStats[dateString].revenue += realRevenue;
                        dailyStats[dateString].convertedRevenue += convertedRevenue;
                    }

                } else if ((row.trangThaiXuat || "").trim() === 'Chưa xuất') {
                    summary.unexportedRevenue += convertedRevenue;

                    if (!unexportedDetails[groupName]) {
                        unexportedDetails[groupName] = { name: groupName, totalSL: 0, totalDTQD: 0, products: {} };
                    }
                    if (!unexportedDetails[groupName].products[productName]) {
                        unexportedDetails[groupName].products[productName] = { name: productName, sl: 0, dtqd: 0 };
                    }
                    unexportedDetails[groupName].products[productName].sl += quantity;
                    unexportedDetails[groupName].products[productName].dtqd += convertedRevenue;
                    unexportedDetails[groupName].totalSL += quantity;
                    unexportedDetails[groupName].totalDTQD += convertedRevenue;
                }
            }
        });

        summary.totalOrders = Object.keys(byCustomer).length;
        summary.bundledOrderCount = Object.values(byCustomer).filter(c => c.products.length > 1).length;
        summary.conversionRate = summary.totalRealRevenue > 0 ? (summary.totalConvertedRevenue / summary.totalRealRevenue) - 1 : 0;

        for (const customerName in byCustomer) {
            const customer = byCustomer[customerName];
            customer.conversionRate = customer.totalRealRevenue > 0 ? (customer.totalConvertedRevenue / customer.totalRealRevenue) - 1 : 0;
        }
        for (const groupName in byProductGroup) {
            const group = byProductGroup[groupName];
            group.conversionRate = group.realRevenue > 0 ? (group.convertedRevenue / group.realRevenue) - 1 : 0;
        }

        const finalDailyStats = Object.values(dailyStats).sort((a, b) => a.date - b.date);
        const finalUnexportedDetails = Object.values(unexportedDetails)
            .map(group => ({
                ...group,
                products: Object.values(group.products).sort((a, b) => b.dtqd - a.dtqd)
            }))
            .sort((a, b) => b.totalDTQD - a.totalDTQD);

        return {
            summary,
            topProductGroups: Object.values(byProductGroup)
                .sort((a, b) => b.realRevenue - a.realRevenue)
                .slice(0, 8),
            categoryChartData: Object.values(categoryChartDataMap),
            byCustomer: Object.values(byCustomer)
                .sort((a,b) => b.totalRealRevenue - a.totalRealRevenue),
            dailyStats: finalDailyStats, 
            unexportedDetails: finalUnexportedDetails 
        };
    }
};
<<< FILE_END: src/services/reports/detail.report.js

>>> FILE_START: src/services/reports/general.report.js
// src/services/reports/general.report.js
// Version 1.0 - General reports (Brand, Unexported)
import { get } from 'svelte/store';
import * as utils from '../../utils.js';
import { dataProcessing } from '../dataProcessing.js';
import { employeeMaNVMap } from '../../stores.js';

export const generalReportLogic = {
    generateRealtimeBrandReport(realtimeYCXData, selectedCategory, selectedBrand) {
        if (!realtimeYCXData || realtimeYCXData.length === 0) return { byBrand: [], byEmployee: [] };
        
        const $employeeMaNVMap = get(employeeMaNVMap);

        const filteredData = realtimeYCXData.filter(row => {
            const categoryMatch = !selectedCategory || utils.cleanCategoryName(row.nganhHang) === selectedCategory;
            const brandMatch = !selectedBrand || (row.nhaSanXuat || 'Hãng khác') === selectedBrand;
            const isDoanhThuHTX = dataProcessing.getHinhThucXuatTinhDoanhThu().has(row.hinhThucXuat);
            const isBaseValid = (row.trangThaiThuTien || "").trim() === 'Đã thu' && (row.trangThaiHuy || "").trim() === 'Chưa hủy' && (row.tinhTrangTra || "").trim() === 'Chưa trả' && (row.trangThaiXuat || "").trim() === 'Đã xuất';

            return categoryMatch && brandMatch && isDoanhThuHTX && isBaseValid;
        });

        const byBrand = {};
        const byEmployee = {};

        filteredData.forEach(row => {
            const brand = row.nhaSanXuat || 'Hãng khác';
            const msnvMatch = String(row.nguoiTao || '').match(/(\d+)/);
            const employeeId = msnvMatch ? msnvMatch[1].trim() : 'Unknown';
            const realRevenue = parseFloat(String(row.thanhTien || "0").replace(/,/g, '')) || 0;
            const quantity = parseInt(String(row.soLuong || "0"), 10) || 0;

            if (!byBrand[brand]) {
                byBrand[brand] = { name: brand, quantity: 0, revenue: 0 };
            }
            byBrand[brand].quantity += quantity;
            byBrand[brand].revenue += realRevenue;

            if (!byEmployee[employeeId]) {
                const employeeInfo = $employeeMaNVMap.get(employeeId);
                byEmployee[employeeId] = { id: employeeId, name: employeeInfo ? employeeInfo.hoTen : `NV ${employeeId}`, quantity: 0, revenue: 0 };
            }
            byEmployee[employeeId].quantity += quantity;
            byEmployee[employeeId].revenue += realRevenue;
        });

        const brandArray = Object.values(byBrand).map(b => ({...b, avgPrice: b.quantity > 0 ? b.revenue / b.quantity : 0})).sort((a,b) => b.revenue - a.revenue);
        const employeeArray = Object.values(byEmployee).sort((a,b) => b.revenue - a.revenue);

        return { byBrand: brandArray, byEmployee: employeeArray };
    },

    generateLuyKeChuaXuatReport(sourceYcxData) {
        if (!sourceYcxData || sourceYcxData.length === 0) return [];

        const hinhThucXuatTinhDoanhThu = dataProcessing.getHinhThucXuatTinhDoanhThu();
        const heSoQuyDoi = dataProcessing.getHeSoQuyDoi();
        const report = {};

        sourceYcxData.forEach(row => {
            const isDoanhThuHTX = hinhThucXuatTinhDoanhThu.has(row.hinhThucXuat);
            const isBaseValid = (row.trangThaiThuTien || "").trim() === 'Đã thu' &&
                                (row.trangThaiHuy || "").trim() === 'Chưa hủy' &&
                                (row.tinhTrangTra || "").trim() === 'Chưa trả' &&
                                (row.trangThaiXuat || "").trim() === 'Chưa xuất';

            if (isBaseValid && isDoanhThuHTX) {
                const thanhTien = parseFloat(String(row.thanhTien || "0").replace(/,/g, '')) || 0;
                const soLuong = parseInt(String(row.soLuong || "0"), 10) || 0;
                if (isNaN(thanhTien) || isNaN(soLuong)) return;

                const nganhHangName = utils.cleanCategoryName(row.nganhHang);
                const heSo = heSoQuyDoi[row.nhomHang] || 1;
                // [FIX] Dùng revenueQuyDoi từ normalizer
                const revenueQuyDoi = row.revenueQuyDoi !== undefined ? row.revenueQuyDoi : (thanhTien * heSo);

                if (!report[nganhHangName]) {
                    report[nganhHangName] = {
                        nganhHang: nganhHangName,
                        soLuong: 0,
                        doanhThuThuc: 0,
                        doanhThuQuyDoi: 0
                    };
                }

                report[nganhHangName].soLuong += soLuong;
                report[nganhHangName].doanhThuThuc += thanhTien;
                report[nganhHangName].doanhThuQuyDoi += revenueQuyDoi; // [UPDATED]
            }
        });

        return Object.values(report);
    },

    generateRealtimeChuaXuatReport(sourceRealtimeYcxData) {
        if (!sourceRealtimeYcxData || sourceRealtimeYcxData.length === 0) return [];

        const hinhThucXuatTinhDoanhThu = dataProcessing.getHinhThucXuatTinhDoanhThu();
        const heSoQuyDoi = dataProcessing.getHeSoQuyDoi();
        const report = {};

        sourceRealtimeYcxData.forEach(row => {
            const isDoanhThuHTX = hinhThucXuatTinhDoanhThu.has(row.hinhThucXuat);
            const isBaseValid = (row.trangThaiThuTien || "").trim() === 'Đã thu' &&
                                (row.trangThaiHuy || "").trim() === 'Chưa hủy' &&
                                (row.tinhTrangTra || "").trim() === 'Chưa trả' &&
                                (row.trangThaiXuat || "").trim() === 'Chưa xuất';

            if (isBaseValid && isDoanhThuHTX) {
                const thanhTien = parseFloat(String(row.thanhTien || "0").replace(/,/g, '')) || 0;
                const soLuong = parseInt(String(row.soLuong || "0"), 10) || 0;
                if (isNaN(thanhTien) || isNaN(soLuong)) return;

                const nganhHangName = utils.cleanCategoryName(row.nganhHang);
                const heSo = heSoQuyDoi[row.nhomHang] || 1;
                // [FIX] Dùng revenueQuyDoi từ normalizer
                const revenueQuyDoi = row.revenueQuyDoi !== undefined ? row.revenueQuyDoi : (thanhTien * heSo);

                if (!report[nganhHangName]) {
                    report[nganhHangName] = {
                        nganhHang: nganhHangName,
                        soLuong: 0,
                        doanhThuThuc: 0,
                        doanhThuQuyDoi: 0
                    };
                }

                report[nganhHangName].soLuong += soLuong;
                report[nganhHangName].doanhThuThuc += thanhTien;
                report[nganhHangName].doanhThuQuyDoi += revenueQuyDoi; // [UPDATED]
            }
        });

        return Object.values(report);
    }
};
<<< FILE_END: src/services/reports/general.report.js

>>> FILE_START: src/services/reports/master/aggregator.js
// src/services/reports/master/aggregator.js
import { get } from 'svelte/store';
import { efficiencyConfig, warehouseCustomMetrics } from '../../../stores.js';
import { normalize } from './utils.js';

export const aggregator = {
    aggregateReport(reportData) {
        if (!reportData || reportData.length === 0) return {};

        // Tính tổng hợp cho toàn siêu thị
        const supermarketReport = reportData.reduce((acc, curr) => {
            // Cộng dồn tất cả các trường số
            for (const key in curr) {
                if (typeof curr[key] === 'number') {
                    acc[key] = (acc[key] || 0) + curr[key];
                }
            }
            
            // Merge chi tiết Ngành hàng / Nhóm hàng
            ['doanhThuTheoNganhHang', 'doanhThuTheoNhomHang'].forEach(dictKey => {
                if(curr[dictKey]) {
                    if(!acc[dictKey]) acc[dictKey] = {};
                    Object.entries(curr[dictKey]).forEach(([k, v]) => {
                        if(!acc[dictKey][k]) acc[dictKey][k] = { ...v };
                        else {
                            acc[dictKey][k].revenue += v.revenue;
                            acc[dictKey][k].quantity += v.quantity;
                            acc[dictKey][k].revenueQuyDoi += v.revenueQuyDoi;
                        }
                    });
                }
            });

            return acc;
        }, { doanhThu: 0, dynamicMetrics: {} });

        supermarketReport.nganhHangChiTiet = supermarketReport.doanhThuTheoNganhHang;
        supermarketReport.nhomHangChiTiet = supermarketReport.doanhThuTheoNhomHang;

        // Tính lại % Tổng hợp Siêu thị
        const totalRevenue = supermarketReport.doanhThu || 1;
        supermarketReport.pctPhuKien = (supermarketReport.dtPhuKien || 0) / totalRevenue;
        supermarketReport.pctGiaDung = (supermarketReport.dtGiaDung || 0) / totalRevenue;
        supermarketReport.pctMLN = (supermarketReport.dtMLN || 0) / totalRevenue;
        supermarketReport.pctSim = (supermarketReport.dtSim || 0) / totalRevenue;
        supermarketReport.pctVAS = (supermarketReport.dtVAS || 0) / totalRevenue;
        supermarketReport.pctBaoHiem = (supermarketReport.dtBaoHiem || 0) / totalRevenue;
        supermarketReport.hieuQuaQuyDoi = (supermarketReport.doanhThuQuyDoi || 0) / totalRevenue - 1;
        supermarketReport.tyLeTraCham = (supermarketReport.doanhThuTraGop || 0) / totalRevenue;
        supermarketReport.comparisonData = { value: 0, percentage: 'N/A' }; 

        if (supermarketReport.qdc) {
            for (const key in supermarketReport.qdc) {
                const group = supermarketReport.qdc[key];
                group.donGia = group.sl > 0 ? group.dt / group.sl : 0;
            }
        }

        // --- Tính lại Dynamic Metrics cho cấp Siêu thị ---
        const $efficiencyConfig = get(efficiencyConfig) || [];
        const $warehouseCustomMetrics = get(warehouseCustomMetrics) || [];
        const allMetricsConfig = [...$efficiencyConfig, ...$warehouseCustomMetrics];

        supermarketReport.dynamicMetrics = {};
        
        if (allMetricsConfig.length > 0) {
            allMetricsConfig.forEach(cfg => {
                try {
                    if (!cfg.id || !cfg.groupA || !cfg.groupB) return;

                    const numType = cfg.typeA || 'DTTL';
                    const denType = cfg.typeB || 'DTTL'; 

                    const calcGroupValue = (groupList, valueType) => {
                        let total = 0;
                        if (!Array.isArray(groupList) || groupList.length === 0) return 0;
                        
                        groupList.forEach(rawName => {
                            if(!rawName) return;
                            const cleanCfgName = normalize(rawName);
                             const scanBucket = (bucket) => {
                                for (const [k, v] of Object.entries(bucket)) {
                                    if (normalize(k).includes(cleanCfgName)) {
                                        if(valueType==='SL') total+=v.quantity;
                                        else if(valueType==='DTQD') total+=v.revenueQuyDoi;
                                        else total+=v.revenue;
                                    }
                                }
                            };
                            scanBucket(supermarketReport.doanhThuTheoNganhHang);
                            scanBucket(supermarketReport.doanhThuTheoNhomHang);
                        });
                        return total;
                    };

                    const numVal = calcGroupValue(cfg.groupA, numType);
                    const denVal = calcGroupValue(cfg.groupB, denType);
                    
                    supermarketReport.dynamicMetrics[cfg.id] = {
                        value: denVal > 0 ? numVal / denVal : 0,
                        target: cfg.target, 
                        label: cfg.label
                    };
                } catch(e) {}
            });
        }

        return supermarketReport;
    }
};
<<< FILE_END: src/services/reports/master/aggregator.js

>>> FILE_START: src/services/reports/master/configLoader.js
import { get } from 'svelte/store';
import { 
    macroCategoryConfig, 
    macroProductGroupConfig 
} from '../../../stores.js';
import { normalize } from './utils.js';
import { parseIdentity } from '../../../utils.js';

export const configLoader = {
    loadUiKeywords() {
        // Lấy config từ Store Svelte
        const $macroProductGroupConfig = get(macroProductGroupConfig) || [];
        const $macroCategoryConfig = get(macroCategoryConfig) || [];

        // Khởi tạo bộ chứa keywords cho các nhóm UI cố định
        const uiKeywords = {
            dtICT: [], dtCE: [], dtPhuKien: [], dtGiaDung: [],
            dtMLN: [], dtSim: [], dtVAS: [], dtBaoHiem: []
        };

        // Mapping định danh: Nhóm UI nào ứng với từ khóa cấu hình nào
        // Ví dụ: Nếu admin đặt tên nhóm là "Nhóm Phụ Kiện Đặc Biệt", nó sẽ match vào 'dtPhuKien'
        const uiIdentity = {
            dtICT: ['ict', 'điện thoại', 'laptop', 'tablet', 'mobile'],
            dtCE: ['ce', 'điện tử', 'tivi', 'loa', 'âm thanh', 'tv'],
            dtPhuKien: ['phụ kiện', 'pk', 'accessories'],
            dtGiaDung: ['gia dụng', 'gd', 'household'],
            dtMLN: ['máy lọc nước', 'mln', 'lọc nước'],
            dtSim: ['sim', 'thẻ cào', 'card'],
            dtVAS: ['vas', 'dịch vụ'],
            dtBaoHiem: ['bảo hiểm', 'rơi vỡ', 'insurance']
        };

        const loadKeywords = (configs) => {
            if (!Array.isArray(configs)) return;
            
            configs.forEach(group => {
                const groupName = normalize(group.name);
                
                // Duyệt qua các nhóm UI định sẵn
                for (const [uiKey, identityTags] of Object.entries(uiIdentity)) {
                    // Nếu tên nhóm trong config (VD: "Phụ kiện 2024") chứa identity (VD: "phụ kiện")
                    if (identityTags.some(tag => groupName.includes(tag))) {
                         
                         // Thì lấy tất cả items bên trong nhóm đó đưa vào keywords của UI Key tương ứng
                         if (group.items && Array.isArray(group.items)) {
                             group.items.forEach(i => {
                                 // 1. Push tên gốc đã chuẩn hóa
                                 uiKeywords[uiKey].push(normalize(i)); 
                                 
                                 // 2. Push ID nếu có (Quan trọng: Xử lý chuỗi "1394 - Cáp sạc")
                                 const parsed = parseIdentity(i);
                                 if (parsed.id && parsed.id !== 'unknown') {
                                     uiKeywords[uiKey].push(normalize(parsed.id));
                                 }
                             });
                         }
                    }
                }
            });
        };

        // Load từ cả 2 nguồn config
        loadKeywords($macroProductGroupConfig);
        loadKeywords($macroCategoryConfig);

        return uiKeywords;
    }
};
<<< FILE_END: src/services/reports/master/configLoader.js

>>> FILE_START: src/services/reports/master/metricsProcessor.js
// src/services/reports/master/metricsProcessor.js
import { get } from 'svelte/store';
import { efficiencyConfig, warehouseCustomMetrics } from '../../../stores.js';
import { normalize } from './utils.js';

export const metricsProcessor = {
    calculateDynamicMetrics(data, goalSettings) {
        const $efficiencyConfig = get(efficiencyConfig) || [];
        const $warehouseCustomMetrics = get(warehouseCustomMetrics) || [];
        
        // Gộp cấu hình
        const allMetricsConfig = [...$efficiencyConfig, ...$warehouseCustomMetrics];
        
        const dynamicMetrics = {};

        if (allMetricsConfig && Array.isArray(allMetricsConfig)) {
            allMetricsConfig.forEach(cfg => {
                try {
                    if (!cfg.id || !cfg.groupA || !cfg.groupB) return;

                    // [LOGIC FIX] Ưu tiên lấy percentMetric (từ Modal mới) -> typeA -> type -> mặc định DTTL
                    // Điều này đảm bảo khi bạn chọn "Số lượng" ở Modal, code sẽ tính theo SL
                    const metricType = cfg.percentMetric || cfg.typeA || cfg.type || 'DTTL';
                    
                    const numType = metricType; 
                    const denType = cfg.typeB || metricType; // Nếu mẫu số không cấu hình riêng thì dùng chung loại

                    const modeA = cfg.modeA || 'group';
                    const modeB = cfg.modeB || (cfg.modeA === 'category' ? 'category' : 'group'); 

                    const calcValue = (groupList, type, mode) => {
                        let total = 0;
                        if (!Array.isArray(groupList)) return 0;
                        
                        groupList.forEach(targetId => {
                            if (!targetId) return;
                            const cleanTargetId = normalize(targetId); 

                            // Chọn thùng dữ liệu
                            const bucketToScan = (mode === 'category') 
                                ? data.doanhThuTheoNganhHang 
                                : data.doanhThuTheoNhomHang;

                            // Quét dữ liệu
                            for (const [key, val] of Object.entries(bucketToScan)) {
                                const cleanKey = normalize(key);
                                
                                if (cleanKey === cleanTargetId) {
                                    let valueToAdd = 0;
                                    // Logic lấy giá trị chính xác theo type
                                    if (type === 'SL') valueToAdd = val.quantity || 0;
                                    else if (type === 'DTQD') valueToAdd = val.revenueQuyDoi || 0;
                                    else valueToAdd = val.revenue || 0; // Mặc định là DTTL

                                    total += valueToAdd;
                                }
                            }
                        });

                        return total;
                    };

                    // Tính toán
                    const num = calcValue(cfg.groupA, numType, modeA);
                    const den = calcValue(cfg.groupB, denType, modeB);

                    dynamicMetrics[cfg.id] = {
                        value: den > 0 ? num / den : 0, // Lưu dạng decimal (0.5) để component UI format sau
                        target: goalSettings && goalSettings[cfg.id] ? parseFloat(goalSettings[cfg.id]) : (cfg.target || 0),
                        label: cfg.label
                    };
                } catch (e) {
                    console.error("Metric Calc Error:", e);
                }
            });
        }
        return dynamicMetrics;
    }
};
<<< FILE_END: src/services/reports/master/metricsProcessor.js

>>> FILE_START: src/services/reports/master/salaryProcessor.js
// src/services/reports/master/salaryProcessor.js
import { get } from 'svelte/store';
import {
    thuongNongData,
    thuongERPData,
    thuongNongDataThangTruoc,
    thuongERPDataThangTruoc,
    employeeNameToMaNVMap
} from '../../../stores.js';
import { dataProcessing } from '../../dataProcessing.js';

export const salaryProcessor = {
    prepareSalaryData() {
        const $thuongNongData = get(thuongNongData) || [];
        const $employeeNameToMaNVMap = get(employeeNameToMaNVMap);
        const $thuongERPData = get(thuongERPData) || [];
        const $thuongNongDataThangTruoc = get(thuongNongDataThangTruoc) || [];
        const $thuongERPDataThangTruoc = get(thuongERPDataThangTruoc) || [];

        const thuongNongByMSNV = {};
        $thuongNongData.forEach(row => {
            const msnv = String(row.maNV || '').trim() || $employeeNameToMaNVMap.get(String(row.hoTen).toLowerCase());
            if(msnv) thuongNongByMSNV[msnv] = (thuongNongByMSNV[msnv]||0) + (parseFloat(String(row.diemThuong||0).replace(/,/g,''))||0);
        });

        const thuongNongThangTruocByMSNV = {};
        $thuongNongDataThangTruoc.forEach(row => {
            const msnv = String(row.maNV || '').trim() || $employeeNameToMaNVMap.get(String(row.hoTen).toLowerCase());
            if(msnv) thuongNongThangTruocByMSNV[msnv] = (thuongNongThangTruocByMSNV[msnv]||0) + (parseFloat(String(row.diemThuong||0).replace(/,/g,''))||0);
        });

        const gioCongByMSNV = dataProcessing.processGioCongData();

        return {
            thuongNongByMSNV,
            thuongNongThangTruocByMSNV,
            gioCongByMSNV,
            $thuongERPData,
            $thuongERPDataThangTruoc
        };
    },

    calculateEmployeeSalary(employee, salaryData) {
        const { 
            thuongNongByMSNV, thuongNongThangTruocByMSNV, gioCongByMSNV, 
            $thuongERPData, $thuongERPDataThangTruoc 
        } = salaryData;

        const gioCong = gioCongByMSNV[employee.maNV] || 0;
        const thuongNong = thuongNongByMSNV[employee.maNV] || 0;
        
        const erpEntry = $thuongERPData.find(e => e.name.includes(employee.hoTen));
        const thuongERP = erpEntry ? parseFloat(erpEntry.bonus.replace(/,/g, '')) : 0;
        const tongThuNhap = thuongNong + thuongERP;

        const today = new Date();
        const daysInMonth = new Date(today.getFullYear(), today.getMonth() + 1, 0).getDate();
        let thuNhapDuKien = 0;
        if (today.getDate() > 1) {
            thuNhapDuKien = (tongThuNhap / (today.getDate() - 1)) * daysInMonth;
        } else {
            thuNhapDuKien = tongThuNhap * daysInMonth;
        }

        const thuongNongThangTruoc = thuongNongThangTruocByMSNV[employee.maNV] || 0;
        const erpEntryThangTruoc = $thuongERPDataThangTruoc.find(e => e.name.includes(employee.hoTen));
        const thuongERPThangTruoc = erpEntryThangTruoc ? parseFloat(erpEntryThangTruoc.bonus.replace(/,/g, '')) : 0;
        const thuNhapThangTruoc = (thuongNongThangTruoc || 0) + thuongERPThangTruoc;
        const chenhLechThuNhap = thuNhapDuKien - thuNhapThangTruoc;

        return {
            gioCong, thuongNong, thuongERP, tongThuNhap, 
            thuNhapDuKien, thuNhapThangTruoc, chenhLechThuNhap
        };
    }
};
<<< FILE_END: src/services/reports/master/salaryProcessor.js

>>> FILE_START: src/services/reports/master/salesProcessor.js
import { config } from '../../../config.js';
import * as utils from '../../../utils.js';
import { normalize } from './utils.js';
import { dataProcessing } from '../../dataProcessing.js';
import { parseIdentity } from '../../../utils.js';

// [FIX] Hàm xử lý số an toàn
const parseMoney = (value) => {
    if (typeof value === 'number') return value;
    if (!value) return 0;
    return parseFloat(String(value).replace(/,/g, '')) || 0;
};

// [HELPER] Hàm chuẩn hóa chuỗi
const normalizeStr = (val) => (val || "").trim();

export const salesProcessor = {
    // --- KHỞI TẠO DỮ LIỆU RỖNG ---
    createEmptySalesData() {
        const PG = config.PRODUCT_GROUPS;
        let data = {
            // Tổng hợp chung
            doanhThu: 0, 
            doanhThuQuyDoi: 0, 
            doanhThuTraGop: 0,
            doanhThuChuaXuat: 0, 
            doanhThuQuyDoiChuaXuat: 0,
            doanhThuGiaoXa: 0, 
            doanhThuQuyDoiGiaoXa: 0,
            
            // Map chi tiết
            doanhThuTheoNganhHang: {}, 
            doanhThuTheoNhomHang: {}, 
            
            // Quy đổi chuẩn (QDC)
            qdc: {},

            // [HARDCODED METRICS]
            dtICT: 0, dtCE: 0, dtPhuKien: 0, dtGiaDung: 0, 
            dtSim: 0, dtVAS: 0, dtBaoHiem: 0, dtMLN: 0,
            
            // Chi tiết sản phẩm
            dtTivi: 0, slTivi: 0, 
            dtTuLanh: 0, slTuLanh: 0,
            dtMayGiat: 0, slMayGiat: 0, 
            dtMayLanh: 0, slMayLanh: 0,
            dtDienThoai: 0, slDienThoai: 0, 
            dtLaptop: 0, slLaptop: 0
        };

        // Init QDC Groups
        for (const key in PG.QDC_GROUPS) {
            data.qdc[key] = { sl: 0, dt: 0, dtqd: 0, name: PG.QDC_GROUPS[key].name };
        }
        return data;
    },

    // --- XỬ LÝ DOANH THU NHÂN VIÊN ---
    processEmployeeSales(employee, sourceData, uiKeywords) {
        const data = this.createEmptySalesData();
        const PG = config.PRODUCT_GROUPS;
        
        const hinhThucXuatTinhDoanhThu = dataProcessing.getHinhThucXuatTinhDoanhThu();
        const hinhThucXuatTraGop = dataProcessing.getHinhThucXuatTraGop();
        const heSoQuyDoi = dataProcessing.getHeSoQuyDoi();

        if (sourceData && Array.isArray(sourceData)) {
            sourceData.forEach(row => {
                const msnvMatch = String(row.nguoiTao || '').match(/(\d+)/);
                if (msnvMatch && msnvMatch[1].trim() === employee.maNV) {
                    
                    const hinhThucXuat = row.hinhThucXuat;
                    const trangThaiXuat = normalizeStr(row.trangThaiXuat);
                    
                    // [STRICT] Bắt buộc phải có HTX trong danh sách
                    const isDoanhThuHTX = hinhThucXuatTinhDoanhThu.has(hinhThucXuat);
                    
                    // --- LOGIC ĐÃ XUẤT ---
                    const isDaXuat = !trangThaiXuat || trangThaiXuat === 'Đã xuất' || trangThaiXuat === 'Đã giao';

                    if (isDoanhThuHTX && isDaXuat) {
                        const thanhTien = parseMoney(row.thanhTien);
                        const soLuong = parseInt(String(row.soLuong || "0"), 10) || 0;
                        const heSo = heSoQuyDoi[row.nhomHang] || 1;
                        
                        // [FIX] Lấy doanh thu quy đổi chính xác từ Normalizer (đã tính trả góp)
                        // Fallback về cách tính cũ nếu row.revenueQuyDoi chưa tồn tại
                        const revenueQuyDoi = row.revenueQuyDoi !== undefined ? row.revenueQuyDoi : (thanhTien * heSo);
                        
                        const nhomIdObj = row.maNhomHang 
                            ? { id: row.maNhomHang, name: parseIdentity(row.nhomHang).name } 
                            : parseIdentity(row.nhomHang);
                        const nganhIdObj = row.maNganhHang 
                            ? { id: row.maNganhHang, name: parseIdentity(row.nganhHang).name } 
                            : parseIdentity(row.nganhHang);

                        // A. Map chi tiết
                        const trackMetric = (container, idObj, rawString) => {
                            if (!idObj.id || idObj.id === 'unknown') return;
                            const key = String(idObj.id).trim();
                            if (!container[key]) {
                                container[key] = { 
                                    id: key, 
                                    name: idObj.name || rawString, 
                                    revenue: 0, quantity: 0, revenueQuyDoi: 0 
                                };
                            }
                            container[key].revenue += thanhTien;
                            container[key].quantity += soLuong;
                            container[key].revenueQuyDoi += revenueQuyDoi; // [UPDATED]
                        }

                        trackMetric(data.doanhThuTheoNganhHang, nganhIdObj, row.nganhHang);
                        trackMetric(data.doanhThuTheoNhomHang, nhomIdObj, row.nhomHang);

                        data.doanhThu += thanhTien;
                        data.doanhThuQuyDoi += revenueQuyDoi; // [UPDATED]

                        if (hinhThucXuat && hinhThucXuatTraGop.has(hinhThucXuat)) {
                            data.doanhThuTraGop += thanhTien;
                        }

                        // C. Phân loại nhóm
                        const nhomHangCode = String(nhomIdObj.id).trim();
                        
                        if (PG.DIEN_THOAI.includes(nhomHangCode) || PG.LAPTOP.includes(nhomHangCode) || (PG.TABLET && PG.TABLET.includes(nhomHangCode))) { data.dtICT += thanhTien; }
                        if (PG.TIVI.includes(nhomHangCode) || PG.TU_LANH.includes(nhomHangCode) || PG.MAY_GIAT.includes(nhomHangCode) || PG.MAY_LANH.includes(nhomHangCode) || (PG.DONG_HO && PG.DONG_HO.includes(nhomHangCode))) { data.dtCE += thanhTien; }
                        if (PG.PHU_KIEN && PG.PHU_KIEN.includes(nhomHangCode)) { data.dtPhuKien += thanhTien; }
                        if (PG.GIA_DUNG && PG.GIA_DUNG.includes(nhomHangCode)) { data.dtGiaDung += thanhTien; }
                        if (PG.MAY_LOC_NUOC && PG.MAY_LOC_NUOC.includes(nhomHangCode)) { data.dtMLN += thanhTien; }
                        if (PG.SIM && PG.SIM.includes(nhomHangCode)) { data.dtSim += thanhTien; }
                        if (PG.VAS && PG.VAS.includes(nhomHangCode)) { data.dtVAS += thanhTien; }
                        if (PG.BAO_HIEM_VAS && PG.BAO_HIEM_VAS.includes(nhomHangCode)) { data.dtBaoHiem += thanhTien; }

                        // Dynamic Keyword Logic
                        const rawNhomHang = normalize(row.nhomHang);
                        const rawNganhHang = normalize(row.nganhHang);
                        const cleanNhomId = normalize(nhomHangCode);
                        const cleanNganhId = normalize(nganhIdObj.id);

                        const checkDynamic = (uiKey, hardcodeList = []) => {
                            const keywords = uiKeywords[uiKey];
                            if (!keywords || keywords.length === 0) return;
                            const isMatch = keywords.some(k => rawNhomHang.includes(k) || rawNganhHang.includes(k) || cleanNhomId === k || cleanNganhId === k);
                            if (isMatch && !hardcodeList.includes(nhomHangCode)) {
                                data[uiKey] += thanhTien;
                            }
                        };
                        
                        checkDynamic('dtICT', [...PG.DIEN_THOAI, ...PG.LAPTOP, ...(PG.TABLET || [])]); 
                        checkDynamic('dtCE', [...PG.TIVI, ...PG.TU_LANH, ...PG.MAY_GIAT, ...PG.MAY_LANH, ...(PG.DONG_HO || [])]); 
                        checkDynamic('dtPhuKien', PG.PHU_KIEN || []);
                        checkDynamic('dtGiaDung', PG.GIA_DUNG || []);
                        checkDynamic('dtMLN', PG.MAY_LOC_NUOC || []); 
                        checkDynamic('dtSim', PG.SIM || []);
                        checkDynamic('dtVAS', PG.VAS || []); 
                        checkDynamic('dtBaoHiem', PG.BAO_HIEM_VAS || []);

                        if (PG.DIEN_THOAI.includes(nhomHangCode)) { data.dtDienThoai += thanhTien; data.slDienThoai += soLuong; }
                        if (PG.LAPTOP.includes(nhomHangCode)) { data.dtLaptop += thanhTien; data.slLaptop += soLuong; }
                        if (PG.TIVI.includes(nhomHangCode)) { data.dtTivi += thanhTien; data.slTivi += soLuong; }
                        if (PG.TU_LANH.includes(nhomHangCode)) { data.dtTuLanh += thanhTien; data.slTuLanh += soLuong; }
                        if (PG.MAY_GIAT.includes(nhomHangCode)) { data.dtMayGiat += thanhTien; data.slMayGiat += soLuong; }
                        if (PG.MAY_LANH.includes(nhomHangCode)) { data.dtMayLanh += thanhTien; data.slMayLanh += soLuong; }

                        for (const key in PG.QDC_GROUPS) {
                            if (PG.QDC_GROUPS[key].codes.includes(nhomHangCode)) {
                                data.qdc[key].sl += soLuong; 
                                data.qdc[key].dt += thanhTien; 
                                data.qdc[key].dtqd += revenueQuyDoi; // [UPDATED]
                            }
                        }
                    } 
                    
                    // --- LOGIC CHƯA XUẤT ---
                    else if (isDoanhThuHTX && trangThaiXuat === 'Chưa xuất') {
                        
                        const valThuTien = normalizeStr(row.trangThaiThuTien);
                        const valHuy = normalizeStr(row.trangThaiHuy);
                        const valTra = normalizeStr(row.tinhTrangTra);

                        const isThuTien = valThuTien === 'Đã thu';
                        const isChuaHuy = valHuy === 'Chưa hủy';
                        const isChuaTra = valTra === 'Chưa trả';

                        if (isThuTien && isChuaHuy && isChuaTra) {
                            const thanhTien = parseMoney(row.thanhTien);
                            const heSo = heSoQuyDoi[row.nhomHang] || 1;
                            // [FIX] Lấy doanh thu quy đổi chính xác (Chưa xuất)
                            const revenueQuyDoi = row.revenueQuyDoi !== undefined ? row.revenueQuyDoi : (thanhTien * heSo);
                            
                            data.doanhThuChuaXuat += thanhTien;
                            data.doanhThuQuyDoiChuaXuat += revenueQuyDoi; // [UPDATED]
                        } 
                    }
                }
            });
        }
        return data;
    },

    // --- TÍNH TỶ LỆ PHẦN TRĂM ---
    calculateStaticRatios(data) {
        const totalRevenue = data.doanhThu > 0 ? data.doanhThu : 1;
        return {
            pctPhuKien: data.dtPhuKien / totalRevenue,
            pctGiaDung: data.dtGiaDung / totalRevenue,
            pctMLN: data.dtMLN / totalRevenue,
            pctSim: data.dtSim / totalRevenue,
            pctVAS: data.dtVAS / totalRevenue,
            pctBaoHiem: data.dtBaoHiem / totalRevenue,
            hieuQuaQuyDoi: data.doanhThu > 0 ? (data.doanhThuQuyDoi / data.doanhThu) - 1 : 0,
            tyLeTraCham: data.doanhThu > 0 ? data.doanhThuTraGop / data.doanhThu : 0
        };
    }
};
<<< FILE_END: src/services/reports/master/salesProcessor.js

>>> FILE_START: src/services/reports/master/utils.js
// src/services/reports/master/utils.js
export const normalize = (str) => {
    if (!str) return '';
    return str.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "").trim();
};
<<< FILE_END: src/services/reports/master/utils.js

>>> FILE_START: src/services/reports/master.report.js
// src/services/reports/master.report.js
// Version 6.0 - Modularized Architecture
import { get } from 'svelte/store';
import { danhSachNhanVien } from '../../stores.js';

// Import sub-modules
import { configLoader } from './master/configLoader.js';
import { salaryProcessor } from './master/salaryProcessor.js';
import { salesProcessor } from './master/salesProcessor.js';
import { metricsProcessor } from './master/metricsProcessor.js';
import { aggregator } from './master/aggregator.js';

export const masterReportLogic = {
    generateMasterReportData: (sourceData, goalSettings, isRealtime = false) => {
        const $danhSachNhanVien = get(danhSachNhanVien);
        if (!$danhSachNhanVien || $danhSachNhanVien.length === 0) return [];

        // 1. Load Configurations & Keywords
        const uiKeywords = configLoader.loadUiKeywords();

        // 2. Prepare Salary Data
        const salaryData = salaryProcessor.prepareSalaryData();

        // 3. Main Loop: Process each employee
        return $danhSachNhanVien.map((employee) => {
            // A. Calculate Sales (Core Logic)
            const salesData = salesProcessor.processEmployeeSales(employee, sourceData, uiKeywords);
            
            // B. Calculate Dynamic Metrics (Admin + User)
            salesData.dynamicMetrics = metricsProcessor.calculateDynamicMetrics(salesData, goalSettings);
            
            // C. Calculate Static Ratios
            const staticRatios = salesProcessor.calculateStaticRatios(salesData);

            // D. Calculate Salary
            const salaryInfo = salaryProcessor.calculateEmployeeSalary(employee, salaryData);

            // E. Calculate Average Price
            const totalQuantity = Object.values(salesData.doanhThuTheoNganhHang).reduce((sum, c) => sum + c.quantity, 0);
            const donGiaTrungBinh = totalQuantity > 0 ? salesData.doanhThu / totalQuantity : 0;

            // F. Combine Everything
            return { 
                ...employee, 
                ...salesData, 
                ...staticRatios,
                ...salaryInfo,
                donGiaTrungBinh,
                mucTieu: goalSettings 
            };
        });
    },

    aggregateReport: (reportData, selectedWarehouse = null) => {
        return aggregator.aggregateReport(reportData);
    }
};
<<< FILE_END: src/services/reports/master.report.js

>>> FILE_START: src/services/settings.service.js
// src/services/settings.service.js
import { get } from 'svelte/store';
import { 
    luykeGoalSettings, 
    realtimeGoalSettings, 
    interfaceSettings,
    pastedThiDuaReportData
} from '../stores.js';
import { datasyncService } from './datasync.service.js'; // [MỚI] Import

// ... (Giữ nguyên các hằng số ALL_EFFICIENCY_ITEMS, PASTED_COMPETITION_SETTINGS_KEY) ...
const ALL_EFFICIENCY_ITEMS = [
    { id: 'dtICT', label: 'DT ICT' },
    { id: 'dtPhuKien', label: 'DT Phụ kiện' },
    { id: 'pctPhuKien', label: '% Phụ kiện' },
    { id: 'dtCE', label: 'DT CE' },
    { id: 'dtGiaDung', label: 'DT Gia dụng' },
    { id: 'pctGiaDung', label: '% Gia dụng' },
    { id: 'pctMLN',    label: '% Máy lọc nước' }, 
    { id: 'pctSim',    label: '% Sim' },
    { id: 'pctVAS',    label: '% VAS' },
    { id: 'pctBaoHiem', label: '% Bảo hiểm' }
];
const PASTED_COMPETITION_SETTINGS_KEY = 'pastedCompetitionViewSettings';

export const settingsService = {
    // --- INTERFACE SETTINGS ---
    loadInterfaceSettings() {
        try {
            const saved = localStorage.getItem('interfaceSettings');
            if (saved) {
                const parsed = JSON.parse(saved);
                interfaceSettings.set({ ...get(interfaceSettings), ...parsed });
            }
            this.applyInterfaceStyles(get(interfaceSettings));
            const contrast = localStorage.getItem('contrastLevel') || '3';
            this.updateContrast(contrast);
        } catch (e) { console.error(e); }
    },

    updateInterface(newSettings) {
        interfaceSettings.set(newSettings);
        localStorage.setItem('interfaceSettings', JSON.stringify(newSettings));
        this.applyInterfaceStyles(newSettings);
    },

    updateContrast(level) {
        document.documentElement.dataset.contrast = level;
        localStorage.setItem('contrastLevel', level);
        interfaceSettings.update(s => ({ ...s, contrastLevel: level }));
    },

    applyInterfaceStyles(settings) {
        const root = document.documentElement;
        if (!settings) return;
        if (settings.globalFontSize) root.style.fontSize = `${settings.globalFontSize}px`;
        for (let i = 1; i <= 8; i++) {
            const key = `kpiCard${i}Bg`;
            if (settings[key]) root.style.setProperty(`--kpi-card-${i}-bg`, settings[key]);
        }
        if (settings.kpiTitleColor) root.style.setProperty('--kpi-title-color', settings.kpiTitleColor);
        if (settings.kpiMainColor) root.style.setProperty('--kpi-main-color', settings.kpiMainColor);
        if (settings.kpiSubColor) root.style.setProperty('--kpi-sub-color', settings.kpiSubColor);
        if (settings.kpiFontSize) root.style.setProperty('--kpi-main-font-size', `${settings.kpiFontSize}px`);
    },

    // --- GOAL SETTINGS (MỤC TIÊU) - CẬP NHẬT ĐỂ SYNC CLOUD ---
    
    // [MỚI] Tải mục tiêu từ Cloud
    async loadGoalsFromCloud(warehouse) {
        if (!warehouse) return;
        const data = await datasyncService.loadGoalSettings(warehouse);
        
        // Cập nhật store Lũy kế
        luykeGoalSettings.update(current => ({
            ...current,
            [warehouse]: data.luyke || {}
        }));

        // Cập nhật store Realtime
        realtimeGoalSettings.update(current => ({
            ...current,
            [warehouse]: data.realtime || { goals: {}, timing: {} }
        }));
    },

    saveLuykeGoalForWarehouse(warehouse, goals) {
        luykeGoalSettings.update(current => {
            const updated = { ...current, [warehouse]: goals };
            // Vẫn lưu local để backup
            localStorage.setItem('luykeGoalSettings', JSON.stringify(updated)); 
            return updated;
        });
        // [MỚI] Lưu lên Cloud
        datasyncService.saveGoalSettings(warehouse, 'luyke', goals);
    },

    getLuykeGoalSettings(selectedWarehouse = null) {
        const $luykeGoalSettings = get(luykeGoalSettings);
        const settings = { goals: {} };
        const goalKeys = ['doanhThuThuc', 'doanhThuQD', 'phanTramQD', 'phanTramTC', 'phanTramGiaDung', 'phanTramMLN', 'phanTramPhuKien', 'phanTramBaoHiem', 'phanTramSim', 'phanTramVAS'];

        if (selectedWarehouse && $luykeGoalSettings[selectedWarehouse]) {
             const source = $luykeGoalSettings[selectedWarehouse];
             // [FIX] Copy động tất cả các key (để hỗ trợ Dynamic Metrics từ Admin)
             Object.assign(settings.goals, source);
        } else if (!selectedWarehouse) {
             // Logic trung bình (giữ nguyên nếu cần, hoặc đơn giản hóa)
             return settings;
        }
        return settings;
    },

    saveRealtimeGoalForWarehouse(warehouse, settings) {
        realtimeGoalSettings.update(current => {
            const updated = { ...current, [warehouse]: settings };
            localStorage.setItem('realtimeGoalSettings', JSON.stringify(updated));
            return updated;
        });
        // [MỚI] Lưu lên Cloud
        datasyncService.saveGoalSettings(warehouse, 'realtime', settings);
    },

    getRealtimeGoalSettings(selectedWarehouse = null) {
        const $realtimeGoalSettings = get(realtimeGoalSettings);
        if (selectedWarehouse && $realtimeGoalSettings && $realtimeGoalSettings[selectedWarehouse]) {
            return $realtimeGoalSettings[selectedWarehouse];
        }
        return { goals: {}, timing: {} };
    },

    // --- VIEW SETTINGS (GIỮ NGUYÊN) ---
    saveEfficiencyViewSettings(settings) {
        if (!Array.isArray(settings)) return;
        try { localStorage.setItem('efficiencyViewSettings', JSON.stringify(settings)); } catch (e) {}
    },
    loadEfficiencyViewSettings() {
        try {
            const savedSettingsJSON = localStorage.getItem('efficiencyViewSettings');
            if (savedSettingsJSON) {
                const savedItems = JSON.parse(savedSettingsJSON);
                if (Array.isArray(savedItems) && savedItems.length > 0) {
                    const savedIds = new Set(savedItems.map(s => s.id));
                    const newItems = ALL_EFFICIENCY_ITEMS
                        .filter(item => !savedIds.has(item.id))
                        .map(item => ({ ...item, visible: true }));
                    
                    const currentItems = savedItems
                        .filter(item => ALL_EFFICIENCY_ITEMS.some(config => config.id === item.id))
                        .map(item => {
                            const defaultItem = ALL_EFFICIENCY_ITEMS.find(d => d.id === item.id);
                             return defaultItem ? { ...item, label: defaultItem.label } : item;
                        });
                    return [...currentItems, ...newItems];
                }
            }
        } catch (e) {}
        return ALL_EFFICIENCY_ITEMS.map(item => ({ ...item, visible: true }));
    },
    saveQdcViewSettings(settings) {
        if (!Array.isArray(settings)) return;
        try { localStorage.setItem('qdcViewSettings', JSON.stringify(settings)); } catch (e) {}
    },
    saveCategoryViewSettings(settings) {
        if (!Array.isArray(settings)) return;
        try { localStorage.setItem('categoryViewSettings', JSON.stringify(settings)); } catch (e) {}
    },
    loadQdcViewSettings(allItems) {
        try {
            const saved = localStorage.getItem('qdcViewSettings');
            if (saved) return JSON.parse(saved);
        } catch (e) {}
        return allItems;
    },
    loadCategoryViewSettings(allItems) {
        try {
            const saved = localStorage.getItem('categoryViewSettings');
            if (saved) return JSON.parse(saved);
        } catch (e) {}
        return allItems;
    },
    savePastedCompetitionViewSettings(settings) {
        try { localStorage.setItem(PASTED_COMPETITION_SETTINGS_KEY, JSON.stringify(settings)); } catch (e) {}
    },
    loadPastedCompetitionViewSettings() {
        const pastedDataStoreValue = get(pastedThiDuaReportData);
        if (!pastedDataStoreValue || pastedDataStoreValue.length === 0) return [];
        
        const masterColumns = pastedDataStoreValue[0].competitions.map((comp, index) => ({
            id: `comp_${index}`,
            label: comp.tenNganhHang,
            tenGoc: comp.tenGoc,
            loaiSoLieu: comp.loaiSoLieu,
            visible: true
        }));
        const masterMap = new Map(masterColumns.map(item => [item.tenGoc, item]));

        let savedItems = [];
        try {
            savedItems = JSON.parse(localStorage.getItem(PASTED_COMPETITION_SETTINGS_KEY) || '[]');
        } catch (e) { savedItems = []; }

        const savedMap = new Map(savedItems.map(item => [item.tenGoc, item]));
        const finalSettings = [];
        
        savedItems.forEach(savedItem => {
            if (masterMap.has(savedItem.tenGoc)) {
                const masterItem = masterMap.get(savedItem.tenGoc);
                finalSettings.push({ ...savedItem, id: masterItem.id, label: masterItem.label });
            }
        });
        masterColumns.forEach(masterItem => {
            if (!savedMap.has(masterItem.tenGoc)) finalSettings.push(masterItem);
        });
        return finalSettings;
    }
};
<<< FILE_END: src/services/settings.service.js

>>> FILE_START: src/services/sknv.service.js
import { formatters } from '../utils/formatters.js';
import { cleanCategoryName } from '../utils.js';

export const sknvService = {
    calculateDepartmentAverages(departmentName, reportData) {
        const departmentEmployees = reportData.filter(e => e.boPhan === departmentName);
        if (departmentEmployees.length === 0) return {};

        const totals = departmentEmployees.reduce((acc, curr) => {
            Object.keys(curr).forEach(key => {
                if (typeof curr[key] === 'number') acc[key] = (acc[key] || 0) + curr[key];
            });
            if (curr.qdc) {
                if (!acc.qdc) acc.qdc = {};
                for (const k in curr.qdc) {
                    if (!acc.qdc[k]) acc.qdc[k] = { sl: 0, dt: 0, dtqd: 0 };
                    acc.qdc[k].sl += curr.qdc[k].sl;
                    acc.qdc[k].dt += curr.qdc[k].dt;
                    acc.qdc[k].dtqd += curr.qdc[k].dtqd;
                }
            }
            return acc;
        }, {});

        const averages = {};
        for (const key in totals) {
            if (key !== 'qdc') averages[key] = totals[key] / departmentEmployees.length;
            else {
                averages.qdc = {};
                for (const qdcKey in totals.qdc) averages.qdc[qdcKey] = {
                    sl: totals.qdc[qdcKey].sl / departmentEmployees.length,
                    dt: totals.qdc[qdcKey].dt / departmentEmployees.length,
                    dtqd: totals.qdc[qdcKey].dtqd / departmentEmployees.length
                };
            }
        }
        return averages;
    },

    evaluateEmployee(employee, departmentAverages) {
        const counts = {
            doanhthu: { above: 0, total: 7 },
            nangsuat: { above: 0, total: 7 },
            hieuqua: { above: 0, total: 6 },
            dongia: { above: 0, total: 7 }
        };

        const check = (group, value, avg, higherIsBetter = true) => {
            if (!isFinite(value) || avg === undefined || !isFinite(avg)) return;
            if (higherIsBetter ? (value >= avg) : (value <= avg)) 
                counts[group].above++;
        };

        check('doanhthu', employee.doanhThu, departmentAverages.doanhThu);
        check('doanhthu', employee.doanhThuQuyDoi, departmentAverages.doanhThuQuyDoi);
        check('doanhthu', employee.hieuQuaQuyDoi, departmentAverages.hieuQuaQuyDoi);
        check('doanhthu', employee.dtCE, departmentAverages.dtCE);
        check('doanhthu', employee.dtICT, departmentAverages.dtICT);
        check('doanhthu', employee.doanhThuTraGop, departmentAverages.doanhThuTraGop);
        check('doanhthu', employee.tyLeTraCham, departmentAverages.tyLeTraCham);
        
        check('nangsuat', employee.tongThuNhap, departmentAverages.tongThuNhap);
        check('nangsuat', employee.thuNhapDuKien, departmentAverages.thuNhapDuKien);
        check('nangsuat', employee.gioCong, departmentAverages.gioCong);
        const tnTrenGc = employee.gioCong > 0 ? employee.tongThuNhap / employee.gioCong : 0;
        const avgTnTrenGc = departmentAverages.gioCong > 0 ? departmentAverages.tongThuNhap / departmentAverages.gioCong : 0;
        check('nangsuat', tnTrenGc, avgTnTrenGc);
        const dtqdTrenGc = employee.gioCong > 0 ? employee.doanhThuQuyDoi / employee.gioCong : 0;
        const avgDtqdTrenGc = departmentAverages.gioCong > 0 ? departmentAverages.doanhThuQuyDoi / departmentAverages.gioCong : 0;
        check('nangsuat', dtqdTrenGc, avgDtqdTrenGc);
        check('nangsuat', employee.thuongNong, departmentAverages.thuongNong);
        check('nangsuat', employee.thuongERP, departmentAverages.thuongERP);

        check('hieuqua', employee.pctPhuKien, departmentAverages.pctPhuKien);
        check('hieuqua', employee.pctGiaDung, departmentAverages.pctGiaDung);
        check('hieuqua', employee.pctMLN, departmentAverages.pctMLN);
        check('hieuqua', employee.pctSim, departmentAverages.pctSim);
        check('hieuqua', employee.pctVAS, departmentAverages.pctVAS);
        check('hieuqua', employee.pctBaoHiem, departmentAverages.pctBaoHiem);

        check('dongia', employee.donGiaTrungBinh, departmentAverages.donGiaTrungBinh);
        check('dongia', employee.donGiaTivi, departmentAverages.donGiaTivi);
        check('dongia', employee.donGiaTuLanh, departmentAverages.donGiaTuLanh);
        check('dongia', employee.donGiaMayGiat, departmentAverages.donGiaMayGiat);
        check('dongia', employee.donGiaMayLanh, departmentAverages.donGiaMayLanh);
        check('dongia', employee.donGiaDienThoai, departmentAverages.donGiaDienThoai);
        check('dongia', employee.donGiaLaptop, departmentAverages.donGiaLaptop);

        const totalAbove = Object.values(counts).reduce((sum, grp) => sum + grp.above, 0);
        const totalCriteria = Object.values(counts).reduce((sum, grp) => sum + grp.total, 0);

        return { ...employee, summary: counts, totalAbove, totalCriteria };
    },

    processReportData(rawReportData) {
        if (!rawReportData || rawReportData.length === 0) return [];
        return rawReportData.map(emp => {
            const deptAvg = this.calculateDepartmentAverages(emp.boPhan, rawReportData);
            return this.evaluateEmployee(emp, deptAvg);
        });
    },

    getDetailStats(employeeData, departmentAverages, customMetrics = []) {
        if (!employeeData || !departmentAverages) return {};

        const { mucTieu } = employeeData;
        const fmtRev = (val) => formatters.formatRevenue(val);
        const fmtNum = (val) => formatters.formatNumberOrDash(val);
        const fmtPct = (val) => formatters.formatPercentage(val);

        const doanhThu = [
            { id: 'dtThuc', label: 'Doanh thu thực', value: fmtRev(employeeData.doanhThu), average: fmtRev(departmentAverages.doanhThu), rawValue: employeeData.doanhThu, rawAverage: departmentAverages.doanhThu },
            { id: 'dtQD', label: 'Doanh thu QĐ', value: fmtRev(employeeData.doanhThuQuyDoi), average: fmtRev(departmentAverages.doanhThuQuyDoi), rawValue: employeeData.doanhThuQuyDoi, rawAverage: departmentAverages.doanhThuQuyDoi },
            { id: 'pctQD', label: '% Quy đổi', value: fmtPct(employeeData.hieuQuaQuyDoi), valueClass: (mucTieu && employeeData.hieuQuaQuyDoi < (mucTieu.phanTramQD / 100)) ? 'text-red-600 bg-red-50' : '', average: fmtPct(departmentAverages.hieuQuaQuyDoi), rawValue: employeeData.hieuQuaQuyDoi, rawAverage: departmentAverages.hieuQuaQuyDoi },
            { id: 'dtCE', label: 'DT CE', value: fmtRev(employeeData.dtCE), average: fmtRev(departmentAverages.dtCE), rawValue: employeeData.dtCE, rawAverage: departmentAverages.dtCE },
            { id: 'dtICT', label: 'DT ICT', value: fmtRev(employeeData.dtICT), average: fmtRev(departmentAverages.dtICT), rawValue: employeeData.dtICT, rawAverage: departmentAverages.dtICT },
            { id: 'dtTraCham', label: 'DT Trả chậm', value: fmtRev(employeeData.doanhThuTraGop), average: fmtRev(departmentAverages.doanhThuTraGop), rawValue: employeeData.doanhThuTraGop, rawAverage: departmentAverages.doanhThuTraGop },
            { id: 'pctTraCham', label: '% Trả chậm', value: fmtPct(employeeData.tyLeTraCham), valueClass: (mucTieu && employeeData.tyLeTraCham < (mucTieu.phanTramTC / 100)) ? 'text-red-600 bg-red-50' : '', average: fmtPct(departmentAverages.tyLeTraCham), rawValue: employeeData.tyLeTraCham, rawAverage: departmentAverages.tyLeTraCham }
        ];

        const nangSuat = [
            { id: 'thuongNong', label: 'Thưởng nóng', value: fmtRev(employeeData.thuongNong), average: fmtRev(departmentAverages.thuongNong), rawValue: employeeData.thuongNong, rawAverage: departmentAverages.thuongNong },
            { id: 'thuongERP', label: 'Thưởng ERP', value: fmtRev(employeeData.thuongERP), average: fmtRev(departmentAverages.thuongERP), rawValue: employeeData.thuongERP, rawAverage: departmentAverages.thuongERP },
            { id: 'thuNhapLK', label: 'Thu nhập LK', value: fmtRev(employeeData.tongThuNhap), average: fmtRev(departmentAverages.tongThuNhap), rawValue: employeeData.tongThuNhap, rawAverage: departmentAverages.tongThuNhap },
            { id: 'thuNhapDK', label: 'Thu nhập DK', value: fmtRev(employeeData.thuNhapDuKien), average: fmtRev(departmentAverages.thuNhapDuKien), rawValue: employeeData.thuNhapDuKien, rawAverage: departmentAverages.thuNhapDuKien },
            { id: 'gioCong', label: 'Giờ công', value: fmtNum(employeeData.gioCong), average: fmtNum(departmentAverages.gioCong), rawValue: employeeData.gioCong, rawAverage: departmentAverages.gioCong },
            { id: 'tnTrenGc', label: 'TN/Giờ công', value: fmtNum(employeeData.gioCong > 0 ? employeeData.tongThuNhap / employeeData.gioCong : 0), average: fmtNum((departmentAverages.gioCong || 0) > 0 ? (departmentAverages.tongThuNhap || 0) / departmentAverages.gioCong : 0), rawValue: employeeData.gioCong > 0 ? employeeData.tongThuNhap / employeeData.gioCong : 0, rawAverage: (departmentAverages.gioCong || 0) > 0 ? (departmentAverages.tongThuNhap || 0) / departmentAverages.gioCong : 0 },
            { id: 'dtqdTrenGc', label: 'DTQĐ/Giờ công', value: fmtRev(employeeData.gioCong > 0 ? employeeData.doanhThuQuyDoi / employeeData.gioCong : 0), average: fmtRev((departmentAverages.gioCong || 0) > 0 ? (departmentAverages.doanhThuQuyDoi || 0) / departmentAverages.gioCong : 0), rawValue: employeeData.gioCong > 0 ? employeeData.doanhThuQuyDoi / employeeData.gioCong : 0, rawAverage: (departmentAverages.gioCong || 0) > 0 ? (departmentAverages.doanhThuQuyDoi || 0) / departmentAverages.gioCong : 0 }
        ];

        const hieuQua = [
            { id: 'pctPhuKien', label: '% PK', value: fmtPct(employeeData.pctPhuKien), valueClass: (mucTieu && employeeData.pctPhuKien < (mucTieu.phanTramPhuKien / 100)) ? 'text-red-600 bg-red-50' : '', average: fmtPct(departmentAverages.pctPhuKien), rawValue: employeeData.pctPhuKien, rawAverage: departmentAverages.pctPhuKien },
            { id: 'pctGiaDung', label: '% Gia dụng', value: fmtPct(employeeData.pctGiaDung), valueClass: (mucTieu && employeeData.pctGiaDung < (mucTieu.phanTramGiaDung / 100)) ? 'text-red-600 bg-red-50' : '', average: fmtPct(departmentAverages.pctGiaDung), rawValue: employeeData.pctGiaDung, rawAverage: departmentAverages.pctGiaDung },
            { id: 'pctMLN', label: '% MLN', value: fmtPct(employeeData.pctMLN), valueClass: (mucTieu && employeeData.pctMLN < (mucTieu.phanTramMLN / 100)) ? 'text-red-600 bg-red-50' : '', average: fmtPct(departmentAverages.pctMLN), rawValue: employeeData.pctMLN, rawAverage: departmentAverages.pctMLN },
            { id: 'pctSim', label: '% Sim', value: fmtPct(employeeData.pctSim), valueClass: (mucTieu && employeeData.pctSim < (mucTieu.phanTramSim / 100)) ? 'text-red-600 bg-red-50' : '', average: fmtPct(departmentAverages.pctSim), rawValue: employeeData.pctSim, rawAverage: departmentAverages.pctSim },
            { id: 'pctVAS', label: '% VAS', value: fmtPct(employeeData.pctVAS), valueClass: (mucTieu && employeeData.pctVAS < (mucTieu.phanTramVAS / 100)) ? 'text-red-600 bg-red-50' : '', average: fmtPct(departmentAverages.pctVAS), rawValue: employeeData.pctVAS, rawAverage: departmentAverages.pctVAS },
            { id: 'pctBaoHiem', label: '% Bảo hiểm', value: fmtPct(employeeData.pctBaoHiem), valueClass: (mucTieu && employeeData.pctBaoHiem < (mucTieu.phanTramBaoHiem / 100)) ? 'text-red-600 bg-red-50' : '', average: fmtPct(departmentAverages.pctBaoHiem), rawValue: employeeData.pctBaoHiem, rawAverage: departmentAverages.pctBaoHiem },
        ];

        const donGia = [
            { id: 'dgTB', label: 'Đơn giá TB', value: fmtRev(employeeData.donGiaTrungBinh), average: fmtRev(departmentAverages.donGiaTrungBinh), rawValue: employeeData.donGiaTrungBinh, rawAverage: departmentAverages.donGiaTrungBinh },
            { id: 'dgTivi', label: 'Đơn giá Tivi', value: fmtRev(employeeData.donGiaTivi), average: fmtRev(departmentAverages.donGiaTivi), rawValue: employeeData.donGiaTivi, rawAverage: departmentAverages.donGiaTivi },
            { id: 'dgTuLanh', label: 'Đơn giá Tủ lạnh', value: fmtRev(employeeData.donGiaTuLanh), average: fmtRev(departmentAverages.donGiaTuLanh), rawValue: employeeData.donGiaTuLanh, rawAverage: departmentAverages.donGiaTuLanh },
            { id: 'dgMayGiat', label: 'Đơn giá Máy giặt', value: fmtRev(employeeData.donGiaMayGiat), average: fmtRev(departmentAverages.donGiaMayGiat), rawValue: employeeData.donGiaMayGiat, rawAverage: departmentAverages.donGiaMayGiat },
            { id: 'dgMayLanh', label: 'Đơn giá Máy lạnh', value: fmtRev(employeeData.donGiaMayLanh), average: fmtRev(departmentAverages.donGiaMayLanh), rawValue: employeeData.donGiaMayLanh, rawAverage: departmentAverages.donGiaMayLanh },
            { id: 'dgDienThoai', label: 'Đơn giá Điện thoại', value: fmtRev(employeeData.donGiaDienThoai), average: fmtRev(departmentAverages.donGiaDienThoai), rawValue: employeeData.donGiaDienThoai, rawAverage: departmentAverages.donGiaDienThoai },
            { id: 'dgLaptop', label: 'Đơn giá Laptop', value: fmtRev(employeeData.donGiaLaptop), average: fmtRev(departmentAverages.donGiaLaptop), rawValue: employeeData.donGiaLaptop, rawAverage: departmentAverages.donGiaLaptop },
        ];

        if (customMetrics && customMetrics.length > 0) {
            customMetrics.forEach(metric => {
                const empVal = this.calculateDynamicMetricValue(employeeData, metric);
                const avgVal = departmentAverages[`custom_${metric.id}`] || 0; 

                const newItem = {
                    id: metric.id,
                    label: metric.label,
                    rawValue: empVal,
                    rawAverage: avgVal,
                    isCustom: true,
                    rawConfig: metric // [MỚI] Lưu config gốc để có thể sửa/xóa
                };

                if (metric.type === 'UNIT_PRICE') {
                    newItem.value = fmtRev(empVal);
                    newItem.average = fmtRev(avgVal);
                    donGia.push(newItem);
                } else {
                    newItem.value = fmtPct(empVal);
                    newItem.average = fmtPct(avgVal);
                    newItem.valueClass = (metric.target && empVal < (metric.target / 100)) ? 'text-red-600 bg-red-50' : '';
                    hieuQua.push(newItem);
                }
            });
        }

        return { doanhThu, nangSuat, hieuQua, donGia };
    },

    calculateDynamicMetricValue(data, metricConfig) {
        const sumValues = (listNames, metricType) => {
            let total = 0;
            if(!listNames || listNames.length === 0) return 0;

            listNames.forEach(name => {
                const cleanName = cleanCategoryName(name);
                let item = data.doanhThuTheoNganhHang?.[cleanName];
                if (!item && data.doanhThuTheoNhomHang) {
                    item = data.doanhThuTheoNhomHang[cleanName];
                }

                if (item) {
                    if (metricType === 'SL') total += item.quantity;
                    else if (metricType === 'DTQD') total += item.revenueQuyDoi;
                    else total += item.revenue; 
                }
            });
            return total;
        };

        const numVal = sumValues(metricConfig.groupA, metricConfig.typeA);
        const denVal = sumValues(metricConfig.groupB, metricConfig.typeB);

        return denVal > 0 ? numVal / denVal : 0;
    }
};
<<< FILE_END: src/services/sknv.service.js

>>> FILE_START: src/services/storage.service.js
// src/services/storage.service.js
// Version 3.1 - Fixed: Export both 'storage' (IndexedDB) and 'storageService' (Firebase)
// MODULE: STORAGE SERVICE
import { getStorage, ref, uploadBytesResumable, getDownloadURL } from "firebase/storage";
import { get } from 'svelte/store';
import { firebaseStore, notificationStore } from '../stores.js';

// --- PHẦN 1: FIREBASE STORAGE (Mới) ---

const getStorageInstance = () => {
    const fb = get(firebaseStore);
    if (!fb || !fb.storage) {
        try { return getStorage(); } catch (e) { return null; }
    }
    return fb.storage;
};

const showNotification = (message, type = 'info') => {
    notificationStore.set({ message, type, visible: true });
    setTimeout(() => notificationStore.update(s => ({ ...s, visible: false })), 3000);
};

export const storageService = {
    async getTemplateDownloadURL() {
        const storage = getStorageInstance();
        if (!storage) throw new Error("Firebase Storage chưa được khởi tạo.");
        const filePath = 'templates/danh_sach_nhan_vien_mau.xlsx';
        const storageRef = ref(storage, filePath);
        return await getDownloadURL(storageRef);
    },

    async getBookmarkDownloadURL() {
        const storage = getStorageInstance();
        if (!storage) throw new Error("Firebase Storage chưa được khởi tạo.");
        const filePath = 'templates/Share_QLST.zip';
        const storageRef = ref(storage, filePath);
        return await getDownloadURL(storageRef);
    },

    async getQrCodeDownloadURL() {
        const storage = getStorageInstance();
        if (!storage) throw new Error("Firebase Storage chưa được khởi tạo.");
        const filePath = 'qrcodes/main-qr.jpg';
        const storageRef = ref(storage, filePath);
        return await getDownloadURL(storageRef);
    },

    async uploadFileToStorage(file, storagePath, onProgress) {
        const storage = getStorageInstance();
        if (!storage) throw new Error("Firebase Storage chưa khởi tạo.");
        
        const storageRef = ref(storage, storagePath);
        const uploadTask = uploadBytesResumable(storageRef, file);

        return new Promise((resolve, reject) => {
            uploadTask.on('state_changed',
                (snapshot) => {
                    const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                    console.log(`Upload ${storagePath}: ${Math.round(progress)}%`);
                    if (onProgress) onProgress(progress);
                },
                (error) => {
                    console.error(`Upload lỗi:`, error);
                    showNotification(`Lỗi upload: ${error.code}`, 'error');
                    reject(error);
                },
                async () => {
                    try {
                        const downloadURL = await getDownloadURL(uploadTask.snapshot.ref);
                        console.log('File available at', downloadURL);
                        resolve(downloadURL);
                    } catch (err) {
                        reject(err);
                    }
                }
            );
        });
    },
};

// --- PHẦN 2: INDEXEDDB (Cũ - Khôi phục lại) ---

export const storage = {
    db: null,
    dbName: 'AppStorageDB',
    storeName: 'fileStore',

    openDB() {
        // console.log("[IndexedDB] Opening...");
        return new Promise((resolve, reject) => {
            if (this.db) return resolve(this.db);
            const request = indexedDB.open(this.dbName, 1);
            request.onupgradeneeded = (event) => {
                const db = event.target.result;
                if (!db.objectStoreNames.contains(this.storeName)) {
                    db.createObjectStore(this.storeName, { keyPath: 'id' });
                }
            };
            request.onsuccess = (event) => {
                this.db = event.target.result;
                resolve(this.db);
            };
            request.onerror = (event) => reject(event.target.error);
        });
    },

    async setItem(id, value) {
        try {
            const db = await this.openDB();
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([this.storeName], 'readwrite');
                const store = transaction.objectStore(this.storeName);
                const request = store.put({ id, value });
                request.onsuccess = () => resolve();
                request.onerror = (e) => reject(e.target.error);
            });
        } catch (error) {
            console.error(`[IndexedDB] Error saving ${id}:`, error);
            throw error;
        }
    },

    async getItem(id) {
        try {
            const db = await this.openDB();
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([this.storeName], 'readonly');
                const store = transaction.objectStore(this.storeName);
                const request = store.get(id);
                request.onsuccess = (e) => resolve(e.target.result ? e.target.result.value : null);
                request.onerror = (e) => reject(e.target.error);
            });
        } catch (error) {
            console.error(`[IndexedDB] Error getting ${id}:`, error);
            throw error;
        }
    }
};
<<< FILE_END: src/services/storage.service.js

>>> FILE_START: src/utils/capture.utils.js
// Version 2.0 - Restore Logic from Legacy Project (Fix Blank Image)
import { get } from 'svelte/store';
import { charts } from '../stores.js'; // Store chứa instance biểu đồ

/**
 * Chèn CSS styles động để định dạng ảnh chụp (Giống hệt file gốc)
 */
export const injectCaptureStyles = () => {
    const styleId = 'dynamic-capture-styles';
    document.getElementById(styleId)?.remove();

    const styles = `
        .capture-container { 
            padding: 24px; 
            background-color: #f3f4f6; 
            box-sizing: border-box; 
            width: fit-content; 
            position: absolute;
            /* QUAN TRỌNG: Dùng left -9999px thay vì opacity/display none để đảm bảo render */
            left: -9999px;
            top: 0;
            z-index: -1;
        }
        .capture-layout-container { 
            display: flex; 
            flex-direction: column; 
            gap: 24px; 
        }
        .capture-title { 
            font-size: 28px; 
            font-weight: 700; 
            text-align: center; 
            color: #1f2937; 
            margin-bottom: 24px; 
            padding: 12px; 
            background-color: #ffffff; 
            border-radius: 0.75rem; 
            box-shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1), 0 1px 2px -1px rgb(0 0 0 / 0.1); 
        }
        /* --- VIRTUAL STAGES / PRESETS --- */
        .prepare-for-kpi-capture {
            display: grid !important;
            grid-template-columns: repeat(2, 1fr) !important;
            gap: 24px !important;
            width: 900px !important;
        }
        .preset-mobile-portrait {
            width: 550px !important; 
        }
        .preset-landscape-table {
            width: fit-content !important;
        }
        .preset-landscape-table table {
            table-layout: fixed !important;
        }
        .preset-landscape-table th, 
        .preset-landscape-table td {
            width: 95px !important;
            word-wrap: break-word;
        }
        .preset-landscape-table th:first-child,
        .preset-landscape-table td:first-child {
            width: 180px !important;
        }
        .preset-large-font-report {
            width: 800px !important;
        }
        .preset-large-font-report table th {
            white-space: normal !important;
            vertical-align: middle;
        }
        .preset-large-font-report table td {
            font-size: 22px !important;
            vertical-align: middle;
        }
        .preset-infographic-wide {
            width: 1100px !important;
        }
    `;

    const styleElement = document.createElement('style');
    styleElement.id = styleId;
    styleElement.innerHTML = styles;
    document.head.appendChild(styleElement);
    return styleElement;
};

/**
 * Tìm và thay thế tất cả <canvas> của Chart.js bằng <img> tĩnh.
 * Logic này khắc phục lỗi ảnh trắng ở biểu đồ.
 * @param {HTMLElement} element - Vùng DOM (clone) sắp được chụp.
 */
export const swapCanvasToImage = (element) => {
    console.log("[CaptureUtils] Bắt đầu chuyển đổi Canvas sang Ảnh...");
    const canvasElements = element.querySelectorAll('canvas');
    let replacedCount = 0;
    
    // Lấy danh sách chart instance từ store Svelte
    const $charts = get(charts);

    canvasElements.forEach(canvas => {
        const chartId = canvas.id;
        
        // Cách 1: Thử lấy từ Store (nếu Chart Component đã đăng ký)
        if (chartId && $charts[chartId]) {
            try {
                const chart = $charts[chartId];
                const base64Image = chart.toBase64Image(); // Lấy ảnh tĩnh từ Chart.js
                
                if (base64Image) {
                    replaceCanvasWithImg(canvas, base64Image);
                    replacedCount++;
                    return;
                }
            } catch (e) {
                console.error(`[CaptureUtils] Lỗi khi lấy ảnh từ chart '${chartId}':`, e);
            }
        }

        // Cách 2: Fallback - Thử lấy trực tiếp từ canvas element (nếu không có trong store)
        // Cách này hoạt động nếu canvas gốc đã được render xong
        try {
            // Tìm canvas gốc trong DOM thật (không phải bản clone)
            const originalCanvas = document.getElementById(chartId);
            if (originalCanvas) {
                const base64Image = originalCanvas.toDataURL('image/png');
                if (base64Image && base64Image !== 'data:,') {
                    replaceCanvasWithImg(canvas, base64Image);
                    replacedCount++;
                }
            }
        } catch (e) {
            console.warn(`[CaptureUtils] Không thể fallback toDataURL cho ${chartId}`);
        }
    });
    console.log(`[CaptureUtils] Đã hoán đổi thành công ${replacedCount} biểu đồ.`);
};

// Helper thay thế node
function replaceCanvasWithImg(canvasNode, src) {
    const img = document.createElement('img');
    img.src = src;
    // Giữ nguyên kích thước để tránh vỡ layout
    img.style.width = canvasNode.style.width || `${canvasNode.width}px`;
    img.style.height = canvasNode.style.height || `${canvasNode.height}px`;
    img.style.display = 'block';
    
    // Copy các class cũ sang
    img.className = canvasNode.className;
    
    // Thay thế canvas bằng img
    if (canvasNode.parentNode) {
        canvasNode.parentNode.replaceChild(img, canvasNode);
    }
}
<<< FILE_END: src/utils/capture.utils.js

>>> FILE_START: src/utils/formatters.js
// src/utils/formatters.js
// Version 4.0 - Format 0 as "-"
export const formatters = {
    /**
     * Định dạng số lượng. 0 -> "-"
     */
    formatNumber: (value, decimals = 0) => {
        if (!isFinite(value) || value === null || value === 0) return '-';
        return new Intl.NumberFormat('vi-VN', { minimumFractionDigits: decimals, maximumFractionDigits: decimals }).format(value);
    },

    /**
     * Định dạng doanh thu (chia cho 1 triệu). 0 -> "-"
     */
    formatRevenue(value, decimals = 1) {
         if (!isFinite(value) || value === null) return '-';
         
         // Nếu giá trị quá nhỏ (gần bằng 0) -> trả về "-"
         if (Math.abs(value) < 1000) return '-'; 

         const millions = value / 1000000;
         return new Intl.NumberFormat('vi-VN', {
             minimumFractionDigits: 0,
             maximumFractionDigits: decimals
         }).format(millions);
     },

     /**
      * Định dạng số thường (giữ nguyên logic cũ cho các trường hợp khác)
      */
     formatNumberOrDash: (value, decimals = 1) => {
          if (!isFinite(value) || value === null || Math.abs(value) < 0.01) return '-';
          return new Intl.NumberFormat('vi-VN', {
              minimumFractionDigits: 0,
              maximumFractionDigits: decimals
          }).format(value);
      },

      /**
       * Định dạng phần trăm. 0 -> "-"
       */
     formatPercentage: (value, decimals = 0) => {
          if (!isFinite(value) || value === null) return '-';
          
          // Kiểm tra số 0 tuyệt đối hoặc rất nhỏ
          if (Math.abs(value) < 0.0001) return '-';

          const percentageValue = value * 100;
          return new Intl.NumberFormat('vi-VN', {
             minimumFractionDigits: decimals,
             maximumFractionDigits: decimals
          }).format(percentageValue) + '%';
      },

    getShortEmployeeName(hoTen, maNV) {
        if (!hoTen) return maNV || '';
        const nameParts = hoTen.split(' ').filter(p => p);
        let displayName = hoTen;
        if (nameParts.length > 2) {
            displayName = nameParts.slice(-2).join(' ');
        }
        return `${displayName} - ${maNV}`;
    },
};
<<< FILE_END: src/utils/formatters.js

>>> FILE_START: src/utils/kpi.utils.js
// File: src/utils/kpi.utils.js

/**
 * Hàm thuần túy: Tính màu sắc dựa trên % hoàn thành
 * @param {number} actual - Số thực đạt
 * @param {number} target - Mục tiêu
 * @returns {string} - Class Tailwind tương ứng
 */
export const getCompletionColor = (actual, target) => {
    // 1. Bảo vệ: Nếu không có mục tiêu, hoặc mục tiêu = 0 -> Không tô màu
    if (!target || target === 0) return '';

    // 2. Tính toán % hoàn thành
    const percent = (actual / target) * 100;

    // 3. Logic Mới (Theo yêu cầu):
    // - Dưới mục tiêu (< 100%) -> Tô Đỏ
    // - Đạt trở lên (>= 100%) -> Không tô màu
    if (percent < 100) {
        return 'bg-red-50 text-red-600 font-bold'; 
    }
    
    // Đạt mục tiêu trở lên -> Trả về rỗng (giữ nguyên màu chữ mặc định của bảng)
    return '';
};

/**
 * Hàm định dạng tiền tệ VNĐ (Tiện ích đi kèm thường dùng)
 */
export const formatCurrency = (amount) => {
    return new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(amount);
};
<<< FILE_END: src/utils/kpi.utils.js

>>> FILE_START: src/styles/base.css
/* Version 1.0 - Base styles (Refactored from v6.19) */
/* Chứa các thiết lập nền tảng: fonts, :root variables, body, scrollbar */

@import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');

:root {
    --global-font-size: 18px;
    --kpi-main-font-size: 36px;
    --bg-lightness-1: 98%; --header-lightness-1: 96%; --header-text-lightness-1: 25%; --special-header-lightness-1: 92%; --below-target-lightness-1: 96%;
    --bg-lightness-2: 96%; --header-lightness-2: 94%; --header-text-lightness-2: 22%; --special-header-lightness-2: 88%; --below-target-lightness-2: 94%;
    --bg-lightness-3: 94%; --header-lightness-3: 92%; --header-text-lightness-3: 18%; --special-header-lightness-3: 85%; --below-target-lightness-3: 92%; /* Normal */
    --bg-lightness-4: 92%; --header-lightness-4: 88%; --header-text-lightness-4: 15%; --special-header-lightness-4: 80%; --below-target-lightness-4: 88%;
    --bg-lightness-5: 90%; --header-lightness-5: 84%; --header-text-lightness-5: 12%; --special-header-lightness-5: 75%; --below-target-lightness-5: 84%;
    --bg-lightness-6: 88%; --header-lightness-6: 80%; --header-text-lightness-6: 10%; --special-header-lightness-6: 70%; --below-target-lightness-6: 80%;
    --kpi-card-1-bg: #38bdf8;
    --kpi-card-2-bg: #34d399; --kpi-card-3-bg: #fbbf24;
    --kpi-card-4-bg: #2dd4bf;
    --kpi-card-5-bg: #a78bfa; --kpi-card-6-bg: #f472b6;
    --kpi-card-7-bg: #818cf8;
    --kpi-card-8-bg: #f87171;
    --kpi-title-color: #ffffff;
    --kpi-main-color: #ffffff;
    --kpi-sub-color: #ffffff;
}

body {
    font-family: 'Inter', sans-serif;
    background-color: #f3f4f6;
    font-size: var(--global-font-size);
}

html[data-contrast="1"] { --bg-lightness: var(--bg-lightness-1); --header-lightness: var(--header-lightness-1); --header-text-lightness: var(--header-text-lightness-1); --special-header-lightness: var(--special-header-lightness-1); --below-target-lightness: var(--below-target-lightness-1); }
html[data-contrast="2"] { --bg-lightness: var(--bg-lightness-2); --header-lightness: var(--header-lightness-2); --header-text-lightness: var(--header-text-lightness-2); --special-header-lightness: var(--special-header-lightness-2); --below-target-lightness: var(--below-target-lightness-2); }
html[data-contrast="3"] { --bg-lightness: var(--bg-lightness-3); --header-lightness: var(--header-lightness-3); --header-text-lightness: var(--header-text-lightness-3);
--below-target-lightness: var(--below-target-lightness-3); }
html[data-contrast="4"] { --bg-lightness: var(--bg-lightness-4); --header-lightness: var(--header-lightness-4); --header-text-lightness: var(--header-text-lightness-4); --special-header-lightness: var(--special-header-lightness-4); --below-target-lightness: var(--below-target-lightness-4); }
html[data-contrast="5"] { --bg-lightness: var(--bg-lightness-5); --header-lightness: var(--header-lightness-5); --header-text-lightness: var(--header-text-lightness-5); --special-header-lightness: var(--special-header-lightness-5); --below-target-lightness: var(--below-target-lightness-5); }
html[data-contrast="6"] { --bg-lightness: var(--bg-lightness-6); --header-lightness: var(--header-lightness-6); --header-text-lightness: var(--header-text-lightness-6); --special-header-lightness: var(--special-header-lightness-6); --below-target-lightness: var(--below-target-lightness-6); }


::-webkit-scrollbar { width: 8px; }
::-webkit-scrollbar-track { background: #f1f1f1; }
::-webkit-scrollbar-thumb { background: #888; border-radius: 10px; }
::-webkit-scrollbar-thumb:hover { background: #555; }

.feather {
    width: 1.1rem;
    height: 1.1rem;
    stroke-width: 1.5;
    flex-shrink: 0;
}
<<< FILE_END: src/styles/base.css

>>> FILE_START: src/styles/components.css
/* Version 3.1 - FIX LAYOUT REGRESSION & RESIZE SUB-TABS */
/* Chứa toàn bộ style cho components: Header mới, Tabs mới, và các thành phần cũ được khôi phục */

/* =========================================
   1. MODERN HEADER & TABS (NEW)
   ========================================= */

/* Header hiện đại cho 3 tab chính */
.modern-page-header {
    background: linear-gradient(to right, #f0f9ff, #ffffff);
    padding: 1rem 1.5rem; /* Giảm padding dọc một chút cho gọn */
    border-bottom: 1px solid #e5e7eb;
    border-radius: 0.75rem 0.75rem 0 0;
    
    display: flex;
    flex-wrap: wrap;
    align-items: center;
    justify-content: space-between;
    gap: 1rem;
    margin-bottom: 0;
}

.modern-page-header .title-wrapper {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    flex-wrap: wrap;
}

.modern-page-header .main-icon {
    width: 2.25rem; /* Thu nhỏ icon chính một chút cho cân đối */
    height: 2.25rem;
    color: #2563eb;
    stroke-width: 1.5;
    padding: 5px;
    background-color: white;
    border-radius: 8px;
    box-shadow: 0 1px 2px rgba(0,0,0,0.05);
    border: 1px solid #dbeafe;
    flex-shrink: 0;
}

.modern-page-header .page-title {
    font-size: 1.25rem; /* Giảm size tiêu đề cho cân đối hơn (20px) */
    font-weight: 800;
    color: #1e40af;
    letter-spacing: -0.01em;
    margin: 0;
    line-height: 1.2;
    text-transform: uppercase; /* Thêm uppercase cho mạnh mẽ */
}

/* === [FIX] SUB-TAB BUTTON: THU NHỎ KÍCH THƯỚC === */
.sub-tab-btn {
    border-bottom: 2px solid transparent;
    padding: 0.5rem 0.75rem; /* Giảm padding để nút gọn hơn */
    transition: all 0.2s ease-in-out;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 0.4rem; /* Giảm khoảng cách giữa icon và chữ */
    color: #6b7280;
    font-weight: 600; /* Tăng độ đậm một chút để dễ đọc ở size nhỏ */
    font-size: 0.8125rem; /* ~13px: Nhỏ hơn tiêu đề, cân đối */
    background: transparent;
    border: none;
    cursor: pointer;
    white-space: nowrap;
}

.sub-tab-btn:hover {
    color: #111827;
    background-color: #f3f4f6;
    border-radius: 4px 4px 0 0;
}

.sub-tab-btn .feather {
    width: 1rem; /* Icon nhỏ lại (16px) */
    height: 1rem;
    stroke-width: 1.5;
    transition: color 0.2s;
}

/* Active State */
.sub-tab-btn.active {
    border-bottom: 2px solid #2563eb;
    color: #2563eb;
    background-color: #eff6ff;
}

.sub-tab-btn.active .feather {
    color: #2563eb;
    stroke-width: 2;
}

/* =========================================
   2. GENERAL COMPONENTS & TRANSITIONS
   ========================================= */

.nav-link,
.action-btn,
.kpi-card,
.content-card,
.tdv-item-card,
.data-input-group,
.toggle-filters-btn,
.page-header__help-btn,
.column-toggle-btn,
.rt-infographic-summary-card {
    transition: all 0.2s ease-in-out;
}

.nav-link:hover,
.action-btn:hover,
.kpi-card:hover,
.content-card:hover,
.data-input-group:hover,
.toggle-filters-btn:hover,
.rt-infographic-summary-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
}

.tdv-item-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
}

.page-header__help-btn {
    background-color: #fee2e2;
    color: #991b1b;
    border-radius: 9999px;
    width: 2rem;
    height: 2rem;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    border: none;
    cursor: pointer;
}

.page-header__help-btn:hover {
    transform: scale(1.1) translateY(-1px);
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
}

input[type="range"] {
    -webkit-appearance: none;
    appearance: none;
    width: 100%;
    height: 8px;
    background: #e5e7eb;
    border-radius: 5px;
    outline: none;
    transition: background 0.2s;
}

input[type="range"]::-webkit-slider-thumb {
    -webkit-appearance: none;
    appearance: none;
    width: 20px;
    height: 20px;
    background: #3b82f6;
    border-radius: 50%;
    cursor: pointer;
    border: 2px solid white;
    box-shadow: 0 0 5px rgba(0,0,0,0.2);
}

input[type="range"]::-moz-range-thumb {
    width: 20px;
    height: 20px;
    background: #3b82f6;
    border-radius: 50%;
    cursor: pointer;
    border: 2px solid white;
    box-shadow: 0 0 5px rgba(0,0,0,0.2);
}

/* =========================================
   3. CARDS & LAYOUT (KHẮC PHỤC LỖI DATA SECTION)
   ========================================= */

.content-card {
    background-color: white;
    border-radius: 0.75rem;
    box-shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1), 0 1px 2px -1px rgb(0 0 0 / 0.1);
    
    /* [FIX QUAN TRỌNG] Khôi phục padding mặc định để Tab Data không bị dính lề */
    padding: 1.5rem; 
    
    margin-bottom: 2rem;
    border: 1px solid #e5e7eb;
    overflow: hidden;
}

/* Class hỗ trợ cho các card sử dụng Modern Header (để header tràn viền) */
/* Lưu ý: Các file .svelte của 3 tab kia đã có class "!p-0", class đó sẽ ghi đè padding trên */
.content-card__body {
    padding: 1.5rem;
}

/* Header cũ (dùng cho DataSection - Khôi phục hiển thị đúng) */
.content-card__header { 
    display: flex; 
    align-items: center; 
    justify-content: flex-start;
    gap: 0.5rem;
    font-size: 1.125rem; 
    font-weight: 700; /* Tăng độ đậm */
    color: #374151; 
    margin-bottom: 1rem;
    margin-top: -0.5rem; /* Kéo lên một chút để cân đối với padding card */ 
    padding-bottom: 0.75rem; 
    border-bottom: 1px solid #e5e7eb; 
}

/* Notifications */
#notification { position: fixed; bottom: 20px; right: 20px; padding: 1rem 1.5rem; border-radius: 0.5rem; color: white; z-index: 1200; opacity: 0; transition: opacity 0.5s, transform 0.5s; transform: translateY(100px); }
#notification.show { opacity: 1; transform: translateY(0); }
.notification-success { background-color: #28a745; }
.notification-error { background-color: #dc3545; }

.placeholder-message { 
    border: 2px dashed #f59e0b; 
    background-color: #fffbeb; 
    color: #b45309; 
    padding: 2rem;
    border-radius: 0.75rem; 
    text-align: center; 
    font-weight: 600; 
}

[id$='-subtabs-nav'] { flex-wrap: wrap; }

/* =========================================
   4. DATA INPUT GROUPS (THEMES)
   ========================================= */

.data-input-group {
    border: 1px solid #e5e7eb;
    border-radius: 0.5rem;
    padding: 1rem; /* Tăng padding nhẹ cho input group */
    background-color: #ffffff; /* Đổi nền thành trắng cho sạch */
    display: flex;
    flex-direction: column;
    border-top: 4px solid #9ca3af;
    box-shadow: 0 1px 2px rgba(0,0,0,0.05);
}

.data-card--blue { background-color: #f0f9ff; border-color: #bae6fd; }
.data-card--green { background-color: #f0fdf4; border-color: #bbf7d0; }
.data-card--yellow { background-color: #fefce8; border-color: #fef08a; }

/* Fix màu header trong Data Section */
.data-header--blue { color: #0369a1; border-bottom-color: #7dd3fc; }
.data-header--green { color: #15803d; border-bottom-color: #86efac; }
.data-header--yellow { color: #854d0e; border-bottom-color: #fde047; }

.input-group--blue { border-top-color: #3b82f6; border-color: #dbeafe; }
.input-group--green { border-top-color: #22c55e; border-color: #dcfce7; }
.input-group--yellow { border-top-color: #f59e0b; border-color: #fef3c7; }

.input-group--blue .data-input-group__label { color: #1d4ed8; }
.input-group--green .data-input-group__label { color: #166534; }
.input-group--yellow .data-input-group__label { color: #92400e; }

.data-input-group__label { 
    font-weight: 700; 
    margin-bottom: 0.75rem; 
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-size: 1rem;
}
.data-input-group__label .feather {
    width: 1.25rem;
    height: 1.25rem;
    flex-shrink: 0;
}
.data-input-group__label--link { text-decoration: none; display: inline-flex; }
.data-input-group__label--link:hover { text-decoration: underline; }
.data-input-group__label--link > .font-normal { font-weight: 400; }

.data-input-group__content { display: flex; flex-direction: column; gap: 0.5rem; flex-grow: 1; }
.data-input-group__file-trigger { cursor: pointer; background-color: #e5e7eb; color: #374151; padding: 0.5rem 1rem; border-radius: 0.375rem; font-size: 0.875em; font-weight: 600; white-space: nowrap; }
.data-input-group__file-trigger:hover { background-color: #d1d5db; }
.data-input-group__file-name { font-size: 0.875em; color: #6b7280; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; font-style: italic; }
.data-input-group__link { color: #2563eb; text-decoration: none; font-size: 0.875em; display: inline-flex; }
.data-input-group__link:hover { text-decoration: underline; }
.data-input-group__status-wrapper { min-height: 1rem; margin-top: 0.25rem; }
.data-input-group__status-text { font-size: 0.8rem; font-weight: 600; }
.data-input-group__status-text--default { color: #6b7280; }
.data-input-group__status-text--success { color: #16a34a; }
.data-input-group__status-text--error { color: #dc2626; }

.data-textarea { width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 0.375rem; font-size: 0.875em; font-family: 'Inter', sans-serif; line-height: 1.5; }
.data-textarea:focus { outline: 2px solid transparent; outline-offset: 2px; border-color: #3b82f6; box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.2); }

.progress-bar-container { overflow: hidden; height: 4px; border-radius: 2px; background-color: #e5e7eb; margin-top: 4px; }
.progress-bar { background-image: linear-gradient(45deg, rgba(255, 255, 255, .15) 25%, transparent 25%, transparent 50%, rgba(255, 255, 255, .15) 50%, rgba(255, 255, 255, .15) 75%, transparent 75%, transparent); background-size: 1rem 1rem; animation: progress-bar-stripes 1s linear infinite; background-color: #3b82f6; height: 100%; transition: width 0.3s; }
@keyframes progress-bar-stripes { from { background-position: 1rem 0; } to { background-position: 0 0; } }

/* =========================================
   5. INTERACTIVE TABLES
   ========================================= */

.interactive-row {
    transition: transform 0.2s ease-out, box-shadow 0.2s ease-out;
    cursor: pointer;
}
.interactive-row:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
    background-color: #eff6ff;
}
.interactive-row .employee-name-cell {
    cursor: pointer;
    color: #2563eb;
    transition: color 0.2s ease-out;
}
.interactive-row:hover .employee-name-cell {
    text-decoration: underline;
    color: #1d4ed8;
}

.income-positive { color: #16a34a; }
.income-negative { color: #dc2626; }
.line-clamp-2 { display: -webkit-box; -webkit-line-clamp: 2; line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }

/* =========================================
   6. KPI CARDS
   ========================================= */

.kpi-card { background-color: white; border-radius: 0.75rem; padding: 1rem; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
.kpi-card-title { color: var(--kpi-title-color); opacity: 0.9; font-size: 0.9em; font-weight: 600; text-transform: uppercase; }
.kpi-card p[id$="-main"] { color: var(--kpi-main-color); font-size: var(--kpi-main-font-size); transition: font-size 0.2s ease-in-out; }
.kpi-card p[id$="-sub"], .kpi-card p[id$="-sub1"], .kpi-card p[id$="-sub2"] { color: var(--kpi-sub-color); font-size: 0.95em; }

.kpi-percentage, .kpi-percentage-value { font-weight: 700; }
.kpi-sub-value { opacity: 0.9; }

/* KPI Card Colors */
#luyke-kpi-cards-container .kpi-card:nth-child(1), #realtime-kpi-cards-container .kpi-card:nth-child(1) { background-color: var(--kpi-card-1-bg); }
#luyke-kpi-cards-container .kpi-card:nth-child(2), #realtime-kpi-cards-container .kpi-card:nth-child(2) { background-color: var(--kpi-card-2-bg); }
#luyke-kpi-cards-container .kpi-card:nth-child(3), #realtime-kpi-cards-container .kpi-card:nth-child(3) { background-color: var(--kpi-card-3-bg); }
#luyke-kpi-cards-container .kpi-card:nth-child(4), #realtime-kpi-cards-container .kpi-card:nth-child(4) { background-color: var(--kpi-card-4-bg); }
#luyke-kpi-cards-container .kpi-card:nth-child(5) { background-color: var(--kpi-card-5-bg); }
#luyke-kpi-cards-container .kpi-card:nth-child(6) { background-color: var(--kpi-card-6-bg); }
#luyke-kpi-cards-container .kpi-card:nth-child(7) { background-color: var(--kpi-card-7-bg); }
#luyke-kpi-cards-container .kpi-card:nth-child(8) { background-color: var(--kpi-card-8-bg); }

/* =========================================
   7. BUTTONS & ACTIONS
   ========================================= */

.toggle-filters-btn { display: inline-flex; align-items: center; gap: 0.5rem; padding: 0.5rem 1rem; border-radius: 0.5rem; background-color: #f3f4f6; color: #4b5563; font-weight: 500; font-size: 0.875em; cursor: pointer; margin-bottom: 1rem; border: 1px solid #e5e7eb; }
.toggle-filters-btn .icon { width: 1rem; height: 1rem; transition: transform 0.3s ease-in-out; }
.toggle-filters-btn.active .icon { transform: rotate(180deg); }

.highlight-trigger { background: none; border: none; cursor: pointer; color: #6b7280; }
.highlight-trigger:hover { color: #1d4ed8; }
.highlighted-row td { animation: pulse-bg 2s infinite; }
@keyframes pulse-bg { 0% { background-color: var(--highlight-color, #ffff99); } 50% { background-color: var(--highlight-color-light, #ffffcc); } 100% { background-color: var(--highlight-color, #ffff99); } }

.action-btn {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
    padding: 0.5rem 1rem;
    border-radius: 0.5rem;
    font-weight: 600;
    font-size: 0.8125rem; /* Đồng bộ size với Sub-tab */
    cursor: pointer;
    border: 1px solid transparent;
    transition: all 0.2s;
    box-shadow: 0 1px 2px rgba(0,0,0,0.05);
}
.action-btn--composer { background-color: #ede9fe; color: #5b21b6; border-color: #c4b5fd; }
.action-btn--composer:hover { background-color: #d8b4fe; }
.action-btn--export { background-color: #dcfce7; color: #166534; border-color: #86efac; }
.action-btn--export:hover { background-color: #bbf7d0; }
.action-btn--capture { background-color: #dbeafe; color: #1e40af; border-color: #93c5fd; }
.action-btn--capture:hover { background-color: #bfdbfe; }
.action-btn--save { background-color: #16a34a; color: white; }
.action-btn--save:hover { background-color: #15803d; }
.action-btn--copy { background-color: #2563eb; color: white; }
.action-btn--copy:hover { background-color: #1d4ed8; }

/* =========================================
   8. MODALS
   ========================================= */

.modal { position: fixed; inset: 0; z-index: 1000; display: flex; align-items: center; justify-content: center; }
.modal.hidden { display: none; }
.modal__overlay { position: absolute; inset: 0; background-color: rgba(17, 24, 39, 0.6); backdrop-filter: blur(4px); cursor: pointer; }
.modal__container { position: relative; z-index: 1001; background-color: white; border-radius: 0.75rem; box-shadow: 0 20px 25px -5px rgb(0 0 0 / 0.1), 0 8px 10px -6px rgb(0 0 0 / 0.1); width: 90%; max-width: 600px; max-height: 90vh; display: flex; flex-direction: column; }

#force-update-modal .modal__overlay { cursor: not-allowed; }

.modal__container--large { max-width: 900px; }
.modal__header { padding: 1rem 1.5rem; border-bottom: 1px solid #e5e7eb; display: flex; justify-content: space-between; align-items: center; flex-shrink: 0; }
.modal__title { font-size: 1.25rem; font-weight: 600; color: #1f2937; }
.modal__close-btn { font-size: 1.75rem; line-height: 1; color: #6b7280; background: none; border: none; cursor: pointer; }
.modal__close-btn:hover { color: #111827; }
.modal__content { padding: 1.5rem; overflow-y: auto; flex-grow: 1; }
.modal__content h4 { font-size: 1.125rem; font-weight: 600; color: #1e3a8a; margin-bottom: 0.75rem; }
.modal__content p { margin-bottom: 0.75rem; color: #374151; line-height: 1.6; }
.modal__content ul { list-style-type: disc; list-style-position: inside; margin-left: 0.5rem; }
.modal__content ul > * + * { margin-top: 0.5rem; }
.modal__footer { padding: 1rem 1.5rem; border-top: 1px solid #e5e7eb; background-color: #f9fafb; display: flex; justify-content: flex-end; gap: 0.75rem; flex-shrink: 0; }

#login-modal .modal__overlay { cursor: not-allowed; }
#login-modal .modal__container { box-shadow: 0 25px 50px -12px rgb(0 0 0 / 0.25); }
#login-modal input[type="email"]:focus { border-color: #3b82f6; box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.4); outline: none; }

/* =========================================
   9. INFOGRAPHIC & REALTIME STYLES
   ========================================= */

.view-switcher { display: flex; align-items: center; padding: 0.25rem; background-color: #e5e7eb; border-radius: 0.5rem; }
.view-switcher__btn { padding: 0.5rem 1rem; border: none; background-color: transparent; border-radius: 0.375rem; font-weight: 500; color: #4b5563; cursor: pointer; }
.view-switcher__btn.active { background-color: white; color: #3b82f6; box-shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1); }

.infographic-card { border: 1px solid #e5e7eb; border-radius: 0.5rem; overflow: hidden; }
.infographic-card__header { padding: 0.75rem 1rem; font-weight: 700; }
.infographic-card__header--completed { background-color: #dcfce7; color: #166534; }
.infographic-card__header--pending { background-color: #fee2e2; color: #991b1b; }
.infographic-card__body { padding: 1rem; background-color: #f9fafb; }
.infographic-card__item { border-bottom: 1px dashed #d1d5db; padding: 0.75rem 0; }
.infographic-card__item:last-child { border-bottom: none; }
.infographic-card__title { font-weight: 600; color: #1f2937; margin-bottom: 0.5rem; }
.infographic-card__metrics { display: grid; grid-template-columns: repeat(2, minmax(0, 1fr)); gap: 0.5rem 1rem; font-size: 0.875em; }
.metric-label { color: #6b7280; }
.metric-value { font-weight: 600; color: #111827; text-align: right; }
.metric-value.is-negative { color: #ef4444; }
.metric-value.is-positive { color: #22c55e; }

/* RT Infographic */
.rt-infographic-container { background-color: #f9fafb; border-radius: 0.75rem; border: 1px solid #e5e7eb; padding: 1.5rem; }
.rt-infographic-header .employee-name { font-size: 1.5rem; font-weight: 800; color: #111827; }
.rt-infographic-header .employee-title { font-size: 1rem; font-weight: 500; color: #6b7280; }
.rt-infographic-summary { display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 1rem; margin-top: 1.5rem; }
.rt-infographic-summary-card { background-color: white; border-radius: 0.5rem; padding: 1rem; text-align: center; border: 1px solid #e5e7eb; }
.rt-infographic-summary-card .label { font-size: 0.875em; color: #4b5563; font-weight: 500; display: flex; align-items: center; justify-content: center; gap: 0.25rem; }
.rt-infographic-summary-card .label .feather { width: 1em; height: 1em; }
.rt-infographic-summary-card .value { font-size: 1.75rem; font-weight: 700; color: #3b82f6; margin-top: 0.25rem; }
.rt-infographic-summary-card .value.is-positive { color: #2563eb; }
.rt-infographic-summary-card .value.is-negative { color: #dc2626; }
.rt-infographic-summary-card .value.is-dat { color: #16a34a !important; }
.rt-infographic-summary-card .value.is-gan-dat { color: #f59e0b !important; }
.rt-infographic-summary-card .value.is-can-co-gang { color: #dc2626 !important; }

.rt-infographic-grid { display: grid; grid-template-columns: repeat(1, minmax(0, 1fr)); gap: 1.5rem; margin-top: 1.5rem; }
@media (min-width: 1024px) { .rt-infographic-grid { grid-template-columns: repeat(2, minmax(0, 1fr)); } }
.rt-infographic-section h4 { font-size: 1.125rem; font-weight: 700; color: #1f2937; margin-bottom: 1rem; }
.rt-progress-bar-item { margin-bottom: 0.75rem; }
.rt-progress-bar-label { display: flex; justify-content: space-between; font-size: 0.875em; font-weight: 500; margin-bottom: 0.25rem; }
.rt-progress-bar-container { background-color: #e5e7eb; border-radius: 9999px; height: 0.75rem; overflow: hidden; }
.rt-progress-bar { background-color: #22c55e; height: 100%; border-radius: 9999px; transition: width 0.5s ease-in-out; }

/* RT Customer Accordion */
.rt-customer-accordion { max-height: 400px; overflow-y: auto; border: 1px solid #e5e7eb; border-radius: 0.5rem; }
.rt-customer-header { background-color: white; padding: 0.75rem 1rem; border-bottom: 1px solid #e5e7eb; cursor: pointer; display: flex; justify-content: space-between; align-items: center; font-weight: 600; list-style: none; }
.rt-customer-header::-webkit-details-marker { display: none; }
.rt-customer-header:hover { background-color: #f9fafb; }
.rt-customer-header .arrow { transition: transform 0.3s; }
.rt-customer-header .product-count { color: #dc2626; font-weight: bold; }
details[open] > summary .arrow { transform: rotate(180deg); }
.rt-customer-details { background-color: #f9fafb; padding: 1rem; }
.rt-customer-details table { font-size: 0.8rem; }

/* =========================================
   10. MISCELLANEOUS COMPONENTS
   ========================================= */

.preview-content { background-color: #f3f4f6; padding: 1rem; border-radius: 0.5rem; white-space: pre-wrap; word-wrap: break-word; font-size: 0.875em; line-height: 1.6; color: #1f2937; font-family: 'Inter', sans-serif; }

.header-qr-container { display: flex; flex-direction: column; align-items: center; gap: 4px; border: 2px solid #ef4444; padding: 4px; border-radius: 8px; background-color: white; }
.header-qr-container span { font-size: 0.75rem; font-weight: 600; color: #b91c1c; }
.header-qr-image { width: 50px; height: 50px; background-color: #f3f4f6; border-radius: 4px; }

.selection-item { display: flex; align-items: center; padding: 0.5rem; border-radius: 0.375rem; cursor: pointer; transition: background-color 0.2s ease-in-out; }
.selection-item:hover { background-color: #f3f4f6; }
.selection-item input[type="checkbox"] { width: 1rem; height: 1rem; margin-right: 0.75rem; }
.selection-item label { flex-grow: 1; cursor: pointer; }

.settings-trigger-btn { background: none; border: none; cursor: pointer; color: #9ca3af; transition: color 0.2s ease-in-out, transform 0.2s ease-in-out; padding: 2px; }
.settings-trigger-btn:hover { color: #3b82f6; transform: rotate(45deg); }
.settings-trigger-btn svg { width: 18px; height: 18px; display: block; }

#version-marquee-container { flex-grow: 1; margin: 0 1.5rem; overflow: hidden; position: relative; background-color: #eef2ff; border: 1px solid #c7d2fe; border-radius: 9999px; cursor: pointer; height: 38px; }
#version-marquee-container:hover .marquee-text { animation-play-state: paused; color: #312e81; }
.marquee-text { position: absolute; white-space: nowrap; will-change: transform; animation: marquee-scroll 25s linear infinite; font-weight: 600; color: #4338ca; line-height: 36px; }
@keyframes marquee-scroll { from { transform: translateX(100%); } to { transform: translateX(-100%); } }

.competition-summary-counter strong { font-size: 1.15rem !important; font-weight: 800 !important; white-space: nowrap; }
.competition-summary-counter .text-blue-600 { color: #2563eb !important; }
.competition-summary-counter .text-red-600 { color: #dc2626 !important; }

/* Column Toggle Button */
.column-toggle-btn { padding: 4px 12px; font-size: 12px; font-weight: 500; border: 1px solid; border-radius: 9999px; cursor: pointer; transition: all 0.2s ease-in-out; user-select: none; }
.column-toggle-btn.active { background-color: #3b82f6; color: white; border-color: #3b82f6; }
.column-toggle-btn:not(.active) { background-color: #e5e7eb; color: #374151; border-color: #d1d5db; }
.column-toggle-btn:not(.active):hover { background-color: #d1d5db; }
.column-toggle-btn.draggable-tag { cursor: grab; }
.column-toggle-btn.draggable-tag:active { cursor: grabbing; }
.column-toggle-btn.draggable-tag:hover { transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
.drag-handle-icon { color: #6b7280; transition: color 0.2s ease-in-out; cursor: grab; }
.drag-handle-icon:active { cursor: grabbing; }
.column-toggle-btn.draggable-tag:hover .drag-handle-icon { color: #1f2937; }

/* Draggable & Sortable */
.draggable-header { cursor: move; cursor: grab; }
.draggable-header:active { cursor: grabbing; }
.sortable-ghost { opacity: 0.4; background-color: #c7d2fe; }
.sortable-drag { opacity: 0.95; transform: rotate(-2deg); box-shadow: 0 8px 16px rgba(0,0,0,0.2); }

#sidebar .feather { width: 1.5rem; height: 1.5rem; stroke-width: 2; }
.page-header__help-btn .feather { width: 1.25rem; height: 1.25rem; }

/* LUY KE DETAIL */
.luyke-detail-header h3 { font-size: 1.75rem; font-weight: 800; color: #111827; text-align: center; }
.luyke-detail-progress-item { display: flex; flex-direction: column; gap: 4px; }
.luyke-detail-progress-label { display: flex; justify-content: space-between; align-items: baseline; font-size: 0.875rem; }
.luyke-detail-progress-values { display: flex; justify-content: space-between; font-size: 0.75rem; color: #4b5563; }
.luyke-detail-chart-container { position: relative; height: 350px; width: 100%; }

/* CUSTOMER ACCORDION (LUYKE) */
.customer-accordion-luyke summary { display: flex; flex-wrap: wrap; align-items: center; gap: 1rem; padding: 0.5rem 1rem; cursor: pointer; list-style: none; font-weight: 400; color: #4b5563; }
.customer-accordion-luyke summary:hover { background-color: #f9fafb; }
.customer-accordion-luyke .customer-name-small { font-weight: 500; font-size: 0.9rem; color: #2563eb; flex-grow: 1; min-width: 120px; }
.customer-accordion-luyke .order-metrics { display: flex; align-items: center; gap: 1rem; flex-shrink: 0; font-size: 0.75rem; }
.customer-accordion-luyke .order-metrics span { white-space: nowrap; }
.customer-accordion-luyke .order-metrics strong { font-weight: 500; color: #1f2937; }
.customer-accordion-luyke .order-metrics .text-gray-900 { color: #1f2937 !important; }
.customer-accordion-luyke .order-metrics .text-blue-600 { color: #2563eb !important; }
.customer-accordion-luyke .accordion-arrow { margin-left: auto; color: #9ca3af; transition: transform 0.2s ease-in-out; }
.customer-accordion-luyke details[open] > summary .accordion-arrow { transform: rotate(180deg); }
.customer-accordion-luyke .product-list-scrollable { display: block; max-height: 200px; overflow-y: auto; }
.customer-accordion-luyke .product-list-table { width: 100%; }
.customer-accordion-luyke .qd-below-target { color: #b91c1c; }
.customer-accordion-luyke .qd-above-target { color: #1d4ed8; }

/* CAPTURE PRESETS */
.capture-container.preset-mobile-portrait .preset-mobile-capture-area { box-sizing: border-box; }
.capture-container.preset-mobile-portrait #customer-detail-list-container,
.capture-container.preset-mobile-portrait #unexported-detail-list-container { width: 100% !important; max-width: 100% !important; box-sizing: border-box; }
<<< FILE_END: src/styles/components.css

>>> FILE_START: src/styles/dashboard-luyke.css
/* src/styles/dashboard-luyke.css */
/* Version 3.3 - Add CSS Variables support for KPI Cards */

/* =========================================
   1. LAYOUT & SCROLLING
   ========================================= */
.luyke-dashboard-container {
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
}

.luyke-tier-1-grid {
    display: grid;
    grid-template-columns: 1fr;
    gap: 1.5rem;
    height: auto;
}

@media (min-width: 1024px) {
    .luyke-tier-1-grid {
        grid-template-columns: repeat(2, 1fr);
        height: 480px;
    }
}

.luyke-widget {
    background-color: #ffffff;
    border: 1px solid #e5e7eb;
    border-radius: 0.75rem;
    box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.05);
    display: flex;
    flex-direction: column;
    height: 100%;
    overflow: hidden;
}

.luyke-widget-body {
    padding: 0.75rem;
    flex-grow: 1;
    overflow-y: auto;
    min-height: 0;
}

.luyke-widget-header {
    padding: 0.75rem 1rem;
    border-bottom: 1px solid #f3f4f6;
    display: flex;
    justify-content: space-between;
    align-items: center;
    background-color: #ffffff;
    flex-shrink: 0;
}

.luyke-widget-title {
    font-size: 0.95rem;
    font-weight: 700;
    color: #374151;
    text-transform: uppercase;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

/* =========================================
   2. KPI CARDS (SOLID STYLE - CSS VARIABLES)
   ========================================= */
.kpi-grid-fixed {
    display: grid;
    grid-template-columns: repeat(1, 1fr);
    gap: 1rem;
}
@media (min-width: 768px) { .kpi-grid-fixed { grid-template-columns: repeat(2, 1fr); } }
@media (min-width: 1280px) { .kpi-grid-fixed { grid-template-columns: repeat(4, 1fr); } }

.kpi-card-solid {
    border-radius: 1rem;
    padding: 1.25rem;
    color: white;
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
    display: flex;
    flex-direction: column;
    justify-content: space-between;
    transition: transform 0.2s, box-shadow 0.2s, background-color 0.3s; /* Thêm transition bg */
    min-height: 140px;
    position: relative;
    overflow: hidden;
}

/* [MỚI] Mapping biến CSS cho các thẻ KPI */
.kpi-card-solid.card-1 { background-color: var(--kpi-card-1-bg, #38bdf8); }
.kpi-card-solid.card-2 { background-color: var(--kpi-card-2-bg, #34d399); }
.kpi-card-solid.card-3 { background-color: var(--kpi-card-3-bg, #fbbf24); }
.kpi-card-solid.card-4 { background-color: var(--kpi-card-4-bg, #2dd4bf); }
.kpi-card-solid.card-5 { background-color: var(--kpi-card-5-bg, #a78bfa); }
.kpi-card-solid.card-6 { background-color: var(--kpi-card-6-bg, #f472b6); }
.kpi-card-solid.card-7 { background-color: var(--kpi-card-7-bg, #818cf8); }
.kpi-card-solid.card-8 { background-color: var(--kpi-card-8-bg, #f87171); }

.kpi-card-solid:hover {
    transform: translateY(-2px);
    box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.2);
}

.kpi-bg-icon {
    position: absolute;
    right: -10px;
    bottom: -10px;
    opacity: 0.15;
    transform: rotate(-15deg);
    pointer-events: none;
}
.kpi-bg-icon svg { width: 5rem; height: 5rem; }

.kpi-solid-header {
    font-size: 0.75rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    opacity: 0.9;
    margin-bottom: 0.5rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
    color: var(--kpi-title-color, #ffffff); /* Dùng biến */
}

.kpi-solid-value {
    font-size: var(--kpi-main-font-size, 2rem); /* Dùng biến */
    font-weight: 800;
    line-height: 1;
    margin-bottom: 0.75rem;
    text-shadow: 0 1px 2px rgba(0,0,0,0.1);
    color: var(--kpi-main-color, #ffffff); /* Dùng biến */
}

.kpi-solid-sub {
    font-size: 0.8rem;
    font-weight: 500;
    border-top: 1px solid rgba(255,255,255,0.3);
    padding-top: 0.5rem;
    display: flex;
    justify-content: space-between;
    color: var(--kpi-sub-color, #ffffff); /* Dùng biến */
}

/* ... (Phần còn lại của file giữ nguyên: EFFICIENCY LIST, CATEGORY CARDS, TOOLBAR, FILTER DROPDOWN) ... */
.eff-item-compact {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    padding: 0.75rem 0;
    border-bottom: 1px dashed #f3f4f6;
    width: 100%;
}
.eff-item-compact:last-child { border-bottom: none; }
.eff-icon-compact {
    width: 2.5rem;
    height: 2.5rem;
    border-radius: 0.5rem;
    background-color: #f3f4f6;
    color: #6b7280;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
}
.eff-content-compact {
    flex-grow: 1;
    min-width: 0;
    display: flex;
    flex-direction: column;
    justify-content: center;
}
.eff-row-top {
    display: flex;
    justify-content: space-between;
    align-items: baseline;
    margin-bottom: 4px;
    width: 100%;
}
.eff-label-text { font-size: 0.9rem; font-weight: 600; color: #374151; }
.eff-value-text { font-size: 1rem; font-weight: 800; }
.eff-row-bottom { display: flex; align-items: center; gap: 0.75rem; width: 100%; }
.eff-bar-container { flex-grow: 1; height: 8px; background-color: #e5e7eb; border-radius: 4px; overflow: hidden; }
.eff-bar-fill { height: 100%; border-radius: 4px; transition: width 0.6s ease-out; }
.eff-target-text { font-size: 0.75rem; color: #6b7280; font-weight: 500; white-space: nowrap; min-width: 65px; text-align: right; }
.luyke-cat-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 0.75rem; }
.cat-card-colorful { border-radius: 0.75rem; padding: 0.75rem; transition: all 0.2s; border: 1px solid transparent; display: flex; flex-direction: column; justify-content: space-between; min-height: 110px; }
.cat-card-colorful:hover { transform: translateY(-3px); box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }
.theme-blue { background-color: #eff6ff; border-color: #bfdbfe; }
.theme-blue .cat-icon-box { background-color: #dbeafe; color: #2563eb; }
.theme-blue .cat-value-text { color: #1e40af; }
.theme-green { background-color: #ecfdf5; border-color: #a7f3d0; }
.theme-green .cat-icon-box { background-color: #d1fae5; color: #059669; }
.theme-green .cat-value-text { color: #065f46; }
.theme-orange { background-color: #fff7ed; border-color: #fed7aa; }
.theme-orange .cat-icon-box { background-color: #ffedd5; color: #ea580c; }
.theme-orange .cat-value-text { color: #9a3412; }
.theme-purple { background-color: #f5f3ff; border-color: #ddd6fe; }
.theme-purple .cat-icon-box { background-color: #ede9fe; color: #7c3aed; }
.theme-purple .cat-value-text { color: #5b21b6; }
.theme-teal { background-color: #f0fdfa; border-color: #99f6e4; }
.theme-teal .cat-icon-box { background-color: #ccfbf1; color: #0f766e; }
.theme-teal .cat-value-text { color: #115e59; }
.theme-gray { background-color: #f9fafb; border-color: #e5e7eb; }
.theme-gray .cat-icon-box { background-color: #f3f4f6; color: #4b5563; }
.theme-gray .cat-value-text { color: #1f2937; }
.theme-warning { background-color: #fffbeb; border-color: #fde047; background-image: repeating-linear-gradient(45deg, #fffbeb, #fffbeb 10px, #fef3c7 10px, #fef3c7 20px); }
.theme-warning .cat-icon-box { background-color: #fff7ed; color: #d97706; }
.theme-warning .cat-value-text { color: #b45309; }
.cat-top-row { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 0.5rem; }
.cat-icon-box { width: 2rem; height: 2rem; border-radius: 0.5rem; display: flex; align-items: center; justify-content: center; }
.cat-name-text { font-size: 0.85rem; font-weight: 700; color: #374151; margin-bottom: 0.25rem; line-height: 1.2; min-height: 2.4em; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
.cat-value-text { font-size: 1.25rem; font-weight: 800; line-height: 1; margin-bottom: 0.5rem; }
.cat-footer-row { display: flex; justify-content: space-between; align-items: center; font-size: 0.7rem; color: #6b7280; padding-top: 0.5rem; border-top: 1px solid rgba(0,0,0,0.05); }
.cat-percent-text { font-weight: 600; opacity: 0.8; }
.luyke-toolbar { background-color: #ffffff; padding: 0.5rem 1rem; border-bottom: 1px solid #e5e7eb; border-radius: 0.75rem 0.75rem 0 0; display: flex; flex-wrap: wrap; justify-content: space-between; align-items: center; gap: 1rem; }
.luyke-toolbar + .luyke-cat-grid, .luyke-toolbar + .luyke-charts-container { background-color: white; padding: 1rem; border: 1px solid #e5e7eb; border-top: none; border-radius: 0 0 0.75rem 0.75rem; }
.toggle-wrapper { display: inline-flex; align-items: center; gap: 8px; cursor: pointer; user-select: none; padding: 6px 12px; border-radius: 999px; background-color: #f3f4f6; border: 1px solid #e5e7eb; transition: all 0.2s; }
.toggle-wrapper:hover { background-color: #e5e7eb; }
.toggle-wrapper.active { background-color: #fff7ed; border-color: #fdba74; }
.toggle-switch { position: relative; width: 36px; height: 20px; background-color: #d1d5db; border-radius: 9999px; transition: background-color 0.3s; flex-shrink: 0; }
.toggle-switch::after { content: ''; position: absolute; top: 2px; left: 2px; width: 16px; height: 16px; background-color: white; border-radius: 50%; transition: transform 0.3s; box-shadow: 0 1px 2px rgba(0,0,0,0.2); }
.toggle-wrapper.active .toggle-switch { background-color: #f97316; }
.toggle-wrapper.active .toggle-switch::after { transform: translateX(16px); }
.toggle-label { font-size: 0.8rem; font-weight: 600; color: #4b5563; }
.toggle-wrapper.active .toggle-label { color: #c2410c; }
.view-mode-btn { display: inline-flex; align-items: center; gap: 4px; padding: 6px 12px; border-radius: 6px; font-size: 0.8rem; font-weight: 600; color: #6b7280; background-color: transparent; border: 1px solid transparent; transition: all 0.2s; }
.view-mode-btn:hover { background-color: #f3f4f6; }
.view-mode-btn.active { background-color: #eff6ff; color: #2563eb; border-color: #bfdbfe; }
.luyke-charts-container { display: grid; grid-template-columns: 1fr; gap: 1.5rem; }
@media (min-width: 1024px) { .luyke-charts-container { grid-template-columns: 4fr 6fr; } }
.chart-box { display: flex; flex-direction: column; height: 350px; position: relative; }
.filter-dropdown { position: absolute; top: 100%; right: 0; margin-top: 0.5rem; width: 280px; background-color: white; border: 1px solid #e5e7eb; border-radius: 0.5rem; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); z-index: 50; display: flex; flex-direction: column; max-height: 400px; }
.filter-header { padding: 0.75rem; border-bottom: 1px solid #f3f4f6; background-color: #f9fafb; border-radius: 0.5rem 0.5rem 0 0; }
.filter-search { width: 100%; padding: 0.5rem; font-size: 0.85rem; border: 1px solid #d1d5db; border-radius: 0.375rem; outline: none; }
.filter-search:focus { border-color: #3b82f6; }
.filter-body { overflow-y: auto; padding: 0.5rem; }
.filter-item { display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem; cursor: pointer; border-radius: 0.25rem; transition: background-color 0.1s; }
.filter-item:hover { background-color: #f3f4f6; }
.filter-item input[type="checkbox"] { width: 1rem; height: 1rem; border-radius: 0.25rem; cursor: pointer; accent-color: #3b82f6; }
.filter-item label { flex-grow: 1; font-size: 0.85rem; color: #374151; cursor: pointer; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.filter-actions { padding: 0.5rem; border-top: 1px solid #f3f4f6; display: flex; justify-content: space-between; background-color: #f9fafb; border-radius: 0 0 0.5rem 0.5rem; }
.filter-btn-link { font-size: 0.75rem; color: #2563eb; background: none; border: none; cursor: pointer; font-weight: 600; }
.filter-btn-link:hover { text-decoration: underline; }
.luyke-icon-btn { padding: 0.4rem; border-radius: 0.375rem; color: #6b7280; background-color: white; border: 1px solid #d1d5db; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; justify-content: center; }
.luyke-icon-btn:hover { color: #3b82f6; border-color: #3b82f6; background-color: #eff6ff; }
.luyke-icon-btn.active { background-color: #dbeafe; color: #1e40af; border-color: #93c5fd; }
.luyke-search-input { padding: 0.4rem 0.75rem; border: 1px solid #d1d5db; border-radius: 0.375rem; font-size: 0.875rem; outline: none; transition: border-color 0.2s; width: 200px; }
.luyke-search-input:focus { border-color: #3b82f6; box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.1); }
<<< FILE_END: src/styles/dashboard-luyke.css

>>> FILE_START: src/styles/layout.css
/* Version 1.0 - Layout styles (Refactored from v6.19) */
/* Chứa các ID và class định hình bố cục chính: sidebar, main-content, drawers, page-header */

#sidebar { 
    width: 68px; 
    transition: width 0.3s ease-in-out; 
    overflow-x: hidden; 
}
#sidebar:hover { 
    width: 256px; 
}
#sidebar.menu-locked:hover { 
    width: 68px; 
}

#sidebar .nav-link, #sidebar button {
    white-space: nowrap;
    gap: 1rem;
    justify-content: flex-start; /* FIX: Canh lề trái cho icon và text */
}

.menu-text {
    transition: opacity 0.2s ease-in-out, width 0.3s ease-in-out;
    opacity: 0;
    white-space: nowrap;
    width: 0;
    overflow: hidden;
}
#sidebar:hover .menu-text {
    opacity: 1;
    transition-delay: 0.1s;
    width: auto;
}
#sidebar.menu-locked:hover .menu-text {
    opacity: 0;
    width: 0;
}

/* === START: SỬA LỖI (v6.14) === */
#main-content { 
    transition: margin-left 0.3s ease-in-out; 
    margin-left: 68px; 
    min-width: 0; /* Ngăn flex item co giãn theo nội dung con (cái bảng rộng) */
}
/* === END: SỬA LỖI (v6.14) === */

.settings-drawer { 
    width: 400px; 
    max-width: 90vw; 
    transform: translateX(-100%); 
    transition: transform 0.3s ease-in-out; 
}
.settings-drawer.open { 
    transform: translateX(0); 
}
.close-drawer-btn { 
    font-size: 2rem; 
    line-height: 1; 
}

.page-header { 
    display: flex; 
    flex-wrap: wrap; 
    justify-content: space-between; 
    align-items: center; 
    gap: 1rem; 
    margin-bottom: 1.5rem; 
}
.page-header__title { 
    font-size: 1.75rem; 
    font-weight: 700; 
    color: #1f2937; 
}
<<< FILE_END: src/styles/layout.css

>>> FILE_START: src/styles/specific-composer.css
/* Version 1.0 - Specific: Composer (Refactored from v6.19) */
/* Chứa các style CHỈ dành riêng cho modal Trình tạo Nhận xét & Xem trước */

.composer { 
    display: flex; 
    flex-direction: column; 
    gap: 1.5rem; 
}
.composer__editor { 
    flex-grow: 1; 
}
.composer__tags { 
    width: 100%; 
}
.composer__label { 
    display: block; 
    font-weight: 500; 
    color: #374151; 
    margin-bottom: 0.5rem; 
}
.composer__textarea { 
    width: 100%; 
    border: 1px solid #d1d5db; 
    border-radius: 0.5rem; 
    padding: 0.75rem; 
    font-size: 0.875em; 
    resize: vertical; 
}
.composer__textarea:focus { 
    border-color: #3b82f6; 
    box-shadow: 0 0 0 1px #3b82f6; 
    outline: none; 
}
.composer__nav { 
    display: flex; 
    border-bottom: 1px solid #e5e7eb; 
    margin-bottom: 1rem; 
}
.composer__tab-btn { 
    padding: 0.5rem 1rem; 
    border: none; 
    background-color: transparent; 
    cursor: pointer; 
    font-weight: 500; 
    color: #6b7280; 
    border-bottom: 2px solid transparent; 
    margin-bottom: -1px; 
    font-size: 0.875em; 
}
.composer__tab-btn.active { 
    color: #3b82f6; 
    border-bottom-color: #3b82f6; 
}
.composer__tab-pane {
    display: none; 
}
.composer__tab-pane.active { 
    display: block; 
}
.composer__tag-group { 
    margin-bottom: 1rem; 
}
.composer__tag-group:last-child { 
    margin-bottom: 0; 
}
.composer__tag-group-title { 
    font-weight: 600; 
    font-size: 0.875em; 
    color: #4b5563; 
    margin-bottom: 0.75rem; 
    border-bottom: 1px solid #e5e7eb; 
    padding-bottom: 0.5rem; 
}
.composer__tag-btn { 
    background-color: #e0e7ff; 
    color: #3730a3; 
    border: 1px solid #c7d2fe; 
    border-radius: 9999px; 
    padding: 0.25rem 0.75rem; 
    font-size: 0.8rem; 
    font-weight: 500; 
    cursor: pointer; 
    margin: 0.25rem; 
}
.composer__icon-btn { 
    background-color: #f3f4f6; 
    color: #1f2937; 
    border: 1px solid #d1d5db; 
    border-radius: 9999px; 
    padding: 0.25rem 0.75rem; 
    font-size: 1.1rem; 
    font-weight: 500; 
    cursor: pointer; 
    margin: 0.25rem; 
    line-height: 1; 
}
.composer__filter-group { 
    margin-bottom: 1rem;
    padding-bottom: 1rem; 
    border-bottom: 1px solid #e5e7eb; 
}
.composer__select { 
    width: 100%; 
    padding: 0.5rem; 
    border: 1px solid #d1d5db; 
    border-radius: 0.375rem; 
    background-color: white; 
}
@media (min-width: 768px) { 
    .composer { 
        flex-direction: row; 
    } 
    .composer__tags { 
        width: 350px; 
        flex-shrink: 0; 
        border-left: 1px solid #e5e7eb; 
        padding-left: 1.5rem; 
    } 
}

.preview-content { 
    background-color: #f3f4f6; 
    padding: 1rem; 
    border-radius: 0.5rem; 
    white-space: pre-wrap; 
    word-wrap: break-word; 
    font-size: 0.875em; 
    line-height: 1.6; 
    color: #1f2937; 
    font-family: 'Inter', sans-serif; 
}
<<< FILE_END: src/styles/specific-composer.css

>>> FILE_START: src/styles/specific-realtime.css
/* Version 1.0 - Specific: Realtime (Refactored from v6.19) */
/* Chứa các style CHỈ dành riêng cho tab Realtime */

#video-container iframe {
    aspect-ratio: 16 / 9;
    width: 100%;
    height: auto;
    border-radius: 0.5rem;
}

.rt-customer-details table { 
    font-size: 0.8rem; 
}
<<< FILE_END: src/styles/specific-realtime.css

>>> FILE_START: src/styles/specific-sknv.css
/* Version 1.8 - No changes for this refactor
/* Version 1.7 - (YC 1) Change competition detail employee name color to dark green
/* Version 1.6 - Adjust detail view layout, colors, and KPI styling
/* Version 1.5 - Add standard 'line-clamp' property for compatibility
/* Version 1.4 - Implement "Multi-lane" layout & fix text wrap for competition detail
/* Version 1.3 - Add 3-column infographic styles and fix capture scroll
/* Version 1.2 - Fix drag-drop cursor for pasted competition toggles
/* Version 1.1 - Add sticky column styles for pasted competition table */
/* Chứa các style CHỈ dành riêng cho tab Sức Khỏe Nhân Viên (SKNV) */

#sknv-details-container .sknv-subtable-header th { 
    font-size: 0.875em; 
    font-weight: 600; 
    background-color: #f3f4f6; 
}

/* === START: SKNV INFOGRAPHIC CARD STYLES (V6.0) === */
.sknv-summary-grid {
    display: grid;
    grid-template-columns: 1fr; /* Default to 1 column for mobile */
    gap: 1.5rem;
}

@media (min-width: 768px) { /* 2 columns for tablets */
    .sknv-summary-grid {
        grid-template-columns: repeat(2, 1fr);
    }
}

@media (min-width: 1280px) { /* 4 columns for large desktops */
    .sknv-summary-grid {
        grid-template-columns: repeat(4, 1fr);
    }
}

.sknv-card {
    background-color: #ffffff;
    border: 1px solid #e5e7eb;
    border-radius: 0.75rem;
    padding: 1rem; /* UPDATED: Compact padding */
    box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05); /* UPDATED: Softer shadow */
    display: flex;
    flex-direction: column;
    gap: 0.75rem; /* UPDATED: Reduced gap */
    transition: transform 0.2s ease-out, box-shadow 0.2s ease-out;
    cursor: pointer;
    position: relative; /* Added for medal positioning */
}
.sknv-card:hover {
    transform: translateY(-4px);
    box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.08), 0 4px 6px -2px rgba(0, 0, 0, 0.04);
}

.sknv-card__header {
    display: flex;
    align-items: center;
    gap: 1rem;
}

.sknv-card__avatar {
    width: 48px;
    height: 48px;
    border-radius: 9999px;
    background-color: #eef2ff;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
    /* (v6.18) Thêm position relative để canh số Top 3 */
    position: relative;
}

.sknv-card__avatar svg {
    width: 24px;
    height: 24px;
    color: #4338ca;
}

.sknv-card__info {
    flex-grow: 1;
    min-width: 0;
}
.sknv-card__info .name {
    font-weight: 700;
    color: #111827;
    line-height: 1.25;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    display: flex;
    align-items: center;
}

.sknv-card__info .id {
    font-size: 0.875rem;
    color: #6b7280;
}

.sknv-card__main-kpi {
    text-align: center;
    margin: 0.25rem 0; /* UPDATED: Reduced margin */
}

.sknv-card__main-kpi .value {
    font-size: 2.5rem; /* UPDATED: Reduced font size */
    font-weight: 800;
    line-height: 1;
    color: #4b5563;
}

.sknv-card__main-kpi .total {
    font-size: 1.25rem; /* UPDATED */
    font-weight: 600;
    color: #9ca3af;
}

.sknv-card__main-kpi .label {
    display: block;
    font-size: 0.875rem;
    color: #6b7280;
    margin-top: 0.25rem;
    font-weight: 500;
}

.sknv-card-kpi-strong { border-top: 4px solid #16a34a; } /* UPDATED: Added top border */
.sknv-card-kpi-medium { border-top: 4px solid #f59e0b; } /* UPDATED: Added top border */
.sknv-card-kpi-weak { border-top: 4px solid #ef4444; } /* UPDATED: Added top border */
.sknv-card-kpi-strong .value { color: #16a34a; }
.sknv-card-kpi-medium .value { color: #f59e0b; }
.sknv-card-kpi-weak .value { color: #ef4444; }

.sknv-card__sub-kpi-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 0.5rem; /* UPDATED: Reduced gap */
    border-top: 1px solid #f3f4f6;
    padding-top: 0.75rem; /* UPDATED: Reduced padding */
}

.sknv-card__sub-kpi-item {
    background-color: #f9fafb;
    border-radius: 0.5rem;
    padding: 0.5rem; /* UPDATED: Reduced padding */
    text-align: center;
    transition: background-color 0.2s ease-in-out;
}

/* === START: NEW SUB-KPI LAYOUT === */
.sknv-card__sub-kpi-header {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.25rem;
}
.sknv-card__sub-kpi-header .feather {
    width: 1rem;
    height: 1rem;
    stroke-width: 2;
    color: #6b7280;
}
.sknv-card__sub-kpi-header .label {
    font-size: 0.7rem;
    font-weight: 600;
    color: #4b5563;
}
.sknv-card__sub-kpi-item .value {
    font-size: 0.875rem;
    font-weight: 700;
    margin-top: 2px;
    display: block; /* Ensures it's on a new line */
}
/* === END: NEW SUB-KPI LAYOUT === */

.sknv-card__sub-kpi-item.strong { border-bottom: 3px solid #22c55e; }
.sknv-card__sub-kpi-item.medium { border-bottom: 3px solid #f59e0b; }
.sknv-card__sub-kpi-item.weak { border-bottom: 3px solid #ef4444; }
/* === END: SKNV INFOGRAPHIC CARD STYLES === */

/* === START: SKNV Department Grouping Styles (V6.1) === */
.sknv-department-group {
    margin-bottom: 2.5rem; /* Space between department groups */
}

.sknv-department-group:last-child {
    margin-bottom: 1rem; /* Less space for the last group */
}

.sknv-department-header {
    font-size: 1.6rem;
    font-weight: 700;
    color: #1f2937; /* Dark gray for general headers */
    padding-bottom: 0.75rem;
    margin-bottom: 1.5rem;
    border-bottom: 3px solid #d1d5db; /* Light gray border */
    position: relative;
    padding-left: 0.5rem;
    /* (v6.18) Thêm flex để icon canh giữa */
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

/* (v6.18) Định dạng cho icon (nếu có) */
.sknv-department-header .header-icon {
    width: 1.4rem;
    height: 1.4rem;
}

.sknv-department-header--priority {
    color: #2563eb; /* Blue for priority department */
    border-bottom-color: #3b82f6; /* Matching blue border */
    background-color: #e0f2fe; /* Light blue background */
    padding: 0.75rem 1rem;
    border-radius: 0.5rem 0.5rem 0 0;
    margin-bottom: 0; /* Remove bottom margin to connect with cards */
    display: flex;
    align-items: center;
    gap: 0.75rem;
}

/* (v6.18) Bỏ icon FontAwesome cũ */
.sknv-department-header--priority::before {
    content: none;
}

/* Adjust grid gap and padding for priority department to integrate better */
.sknv-department-header--priority + .sknv-summary-grid {
    border-top-left-radius: 0;
    border-top-right-radius: 0;
    margin-top: 0; /* Remove top margin */
    padding-top: 1.5rem; /* Add padding inside grid */
    border: 1px solid #c7d2fe;
    background-color: #f3f4f6; /* Slightly different background */
    padding-left: 1rem;
    padding-right: 1rem;
    padding-bottom: 1rem;
    border-top: none;
}
/* === END: SKNV Department Grouping Styles === */

/* === START: SKNV DETAIL VIEW & MEDALS (V6.4) === */
/* NEW: Wrapper for compact detail view */
#sknv-detail-capture-area {
    max-width: 1100px;
    margin: 0 auto;
}
.sknv-detail-header-card {
    display: flex;
    align-items: center;
    gap: 1.5rem;
    padding: 1rem; /* UPDATED: Compact padding */
    background-color: #eff6ff; /* blue-50 */
    border: 1px solid #dbeafe; /* blue-200 */
    border-top: 4px solid #3b82f6; /* blue-500 */
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03);
}
.sknv-detail-avatar {
    width: 64px;
    height: 64px;
    border-radius: 9999px;
    background-color: #dbeafe; /* blue-200 */
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
}
.sknv-detail-avatar svg {
    width: 32px;
    height: 32px;
    color: #1e40af; /* blue-800 */
}
.sknv-detail-info .name {
    color: #1e40af; /* UPDATED: Dark blue color */
}
.sknv-detail-info .department,
.sknv-detail-info .kpi-summary {
    color: #1f2937; /* dark text */
}
.sknv-detail-info .kpi-summary .font-bold {
    color: #1d4ed8; /* darker blue */
}
.sknv-detail-info .name {
    font-size: 1.5rem;
    font-weight: 800;
    line-height: 1.2;
}
.sknv-detail-info .department {
    font-size: 1rem;
    font-weight: 500;
}
.sknv-detail-info .kpi-summary {
    margin-top: 0.5rem;
    font-weight: 600;
}

.sknv-detail-card-header {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    padding: 0.75rem 1rem; /* UPDATED: Compact padding */
    color: #ffffff;
}
.sknv-detail-card-header .header-icon {
    width: 20px;
    height: 20px;
}
.sknv-header-blue { background-color: #2563eb; }
.sknv-header-green { background-color: #16a34a; }
.sknv-header-orange { background-color: #f97316; }
.sknv-header-yellow { background-color: #ca8a04; }
.sknv-header-indigo { background-color: #4f46e5; }
.sknv-header-purple { background-color: #7e22ce; }

.sknv-detail-grid-body {
    padding: 0.75rem 1rem; /* UPDATED: Compact padding */
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); /* UPDATED */
    gap: 0.75rem; /* UPDATED */
}
.sknv-detail-metric-card {
    display: flex;
    flex-direction: column;
    align-items: center;
    text-align: center;
    padding: 0.5rem; /* UPDATED: Compact padding */
    background-color: #f9fafb;
    border-radius: 0.5rem;
    border: 1px solid #f3f4f6;
    transition: all 0.2s ease-in-out;
}
.sknv-detail-metric-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
}
.sknv-detail-metric-card .label {
    font-weight: 600;
    font-size: 0.8rem; /* UPDATED */
    color: #374151;
}
.sknv-detail-metric-card .value {
    font-weight: 700; /* UPDATED */
    font-size: 1.375rem; /* UPDATED: Reduced font size */
    line-height: 1.2;
    color: #111827;
    margin: 0.25rem 0;
}
.sknv-detail-metric-card .average {
    font-size: 0.7rem; /* UPDATED */
    color: #6b7280;
    font-style: italic;
}
.sknv-detail-metric-card .evaluation-badge {
    margin-top: 0.5rem;
    font-weight: 700;
    padding: 2px 8px;
    border-radius: 9999px;
    font-size: 0.7rem; /* UPDATED */
}
.evaluation-badge.text-green-600 { background-color: #dcfce7; }
.evaluation-badge.text-yellow-600 { background-color: #fef9c3; }

.medal-container {
    position: absolute; /* Changed for positioning */
    /* (v6.19) YC: Tăng size + điều chỉnh vị trí */
    top: -10px;
    left: 10px;
    width: 48px;
    height: 48px;
    flex-shrink: 0;
}
.medal-container svg {
    width: 100%;
    height: 100%;
    display: block;
    filter: drop-shadow(0 2px 2px rgba(0,0,0,0.3)); /* Add a nice shadow */
}

/* NEW: Compact tables in detail view */
#sknv-details-container .sknv-subtable-header {
    font-size: 0.8rem;
}
#sknv-details-container .table-bordered td,
#sknv-details-container .table-bordered th {
    padding: 0.5rem;
}
/* === END: SKNV DETAIL VIEW & MEDALS === */

/* === START: SKNV Rank Number Styles (v6.21 - Soft Blue 3D) === */

/* 1. Số thứ tự cho Top 3 (Đè lên huy chương) - Giữ nguyên */
.sknv-card__avatar-rank {
    font-size: 1.75rem; 
    font-weight: 700; 
    line-height: 1;
    display: flex;
    align-items: center;
    justify-content: center;
    width: 100%;
    height: 100%;
    position: absolute;
    top: 0;
    left: 0;
    z-index: 12; 
    color: #ffffff; 
    text-shadow: 0 1px 2px rgba(0,0,0,0.3);
}

/* 2. Ẩn nền avatar mặc định khi có huy chương - Giữ nguyên */
.sknv-card:has(.medal-container) .sknv-card__avatar {
    background-color: transparent;
}

/* 3. [DESIGN MỚI] Định dạng cho Vòng tròn hạng 4+ (Soft Blue) */
.sknv-card__avatar--standard {
    /* Nền Gradient: Từ xanh nhạt sang xanh đậm hơn xíu để tạo khối cầu */
    background: linear-gradient(145deg, #eff6ff, #dbeafe); 
    
    /* Viền: Màu xanh dương rõ nét */
    border: 2px solid #93c5fd; 
    
    /* Đổ bóng: 
       - Bóng dưới: Màu xanh đậm mờ để tạo độ nổi.
       - Bóng trên: Màu trắng để tạo độ bóng sáng (highlight).
    */
    box-shadow: 
        3px 3px 6px rgba(37, 99, 235, 0.15), 
        -3px -3px 6px rgba(255, 255, 255, 0.8);
    
    width: 44px; /* Fix size */
    height: 44px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    margin-top: 2px;
    margin-left: 2px;
}

/* 4. [DESIGN MỚI] Định dạng cho SỐ hạng 4+ */
.sknv-card__avatar--standard .sknv-card__avatar-rank {
    color: #1e40af; /* Màu chữ: Xanh dương đậm (Blue 800) thay vì màu đen/xám */
    position: static; 
    font-size: 1.25rem;
    font-weight: 800; 
    text-shadow: none; /* Bỏ bóng chữ của Top 3 */
    font-family: 'Inter', sans-serif;
}

/* 5. Bỏ SVG cũ */
.sknv-card__avatar-medal {
    display: none;
}
/* === END: SKNV Rank Number Styles === */

/* === START: Declaration Accordion Styles (v6.11) === */
.declaration-group {
    border-bottom: 1px solid #e5e7eb; /* gray-200 */
}
.declaration-group:last-child {
    border-bottom: none;
}
.declaration-group summary {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 1rem 0.5rem;
    cursor: pointer;
    font-size: 1.125rem; /* text-lg */
    font-weight: 700; /* font-bold */
    color: #374151; /* gray-700 */
    list-style: none; /* Hide default marker */
}
.declaration-group summary::-webkit-details-marker {
    display: none; /* Hide default marker for Chrome */
}
.declaration-group summary:hover {
    background-color: #f9fafb; /* gray-50 */
}
.declaration-group summary::after {
    content: '+';
    font-size: 1.5rem;
    font-weight: 500;
    color: #6b7280; /* gray-500 */
    transition: transform 0.2s ease-in-out;
}
.declaration-group[open] > summary::after {
    transform: rotate(45deg);
    content: '×';
}
.declaration-content {
    padding: 1rem 0.5rem 1.5rem 0.5rem;
}
/* === END: Declaration Accordion Styles === */

/* === START: Pasted Competition Column Toggles & Header Wrap (v6.15) === */

/* Container for the toggle buttons */
#pasted-competition-column-toggles {
    padding: 0.75rem;
    border-bottom: 1px solid #e5e7eb;
    display: flex;
    flex-wrap: wrap;
    align-items: center;
    gap: 0.5rem 0.25rem;
    background-color: #f9fafb; /* gray-50 */
}

/* Label for the toggles */
#pasted-competition-column-toggles .non-draggable {
    font-size: 0.875rem; /* text-sm */
    font-weight: 600; /* font-semibold */
    margin-right: 0.5rem; /* mr-2 */
    color: #374151; /* gray-700 */
}

/* Styles for the table headers to allow wrapping */
#pasted-competition-report-container table th {
    white-space: normal; /* Allow text wrapping */
    vertical-align: middle;
    line-height: 1.3;
    max-width: 150px; /* Set a max-width */
    width: 120px; /* Set a base width */
}

/* Keep employee name header slightly wider and no-wrap */
#pasted-competition-report-container table th[data-sort="hoTen"] {
    white-space: nowrap;
    width: 150px;
    min-width: 150px;
}
/* === END: Pasted Competition Styles === */

/* === START: LOGIN MODAL STYLES (V6.7) === */
#login-modal .modal__overlay {
    cursor: not-allowed;
}

#login-modal .modal__container {
    box-shadow: 0 25px 50px -12px rgb(0 0 0 / 0.25);
}

#login-modal input[type="email"]:focus {
    border-color: #3b82f6;
    box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.4);
    outline: none;
}
/* === END: LOGIN MODAL STYLES === */

/* === START: Sticky Columns for Pasted Competition Table (v1.1) === */

/* 1. Container: Phải bật 'overflow-x-auto' (đã có) và 'position: relative' (quan trọng) */
.sknv-pasted-competition-scroller {
    position: relative; /* Bắt buộc để z-index của sticky hoạt động */
}

/* 2. Các ô tiêu đề (th) cần "đóng băng" */
#pasted-competition-report-container table th.sticky-col {
    position: -webkit-sticky; /* cho Safari */
    position: sticky;
    z-index: 2; /* Phải cao hơn z-index của các ô (td) */
    background-color: #e5e7eb; /* gray-200 (màu nền thead) - Rất quan trọng */
}

/* 3. Các ô dữ liệu (td) cần "đóng băng" */
#pasted-competition-report-container table td.sticky-col {
    position: -webkit-sticky; /* cho Safari */
    position: sticky;
    z-index: 1; /* Phải cao hơn các ô td khác, nhưng thấp hơn th */
    background-color: #ffffff; /* Màu nền của dòng (trắng) */
}

/* 4. Đảm bảo dòng chẵn/lẻ cũng được ghi đè màu nền */
#pasted-competition-report-container table tr:nth-child(even) td.sticky-col {
    background-color: #f9fafb; /* gray-50 (màu dòng chẵn) */
}

/* 5. Định vị cho từng cột */
.sticky-col.sticky-col-1 {
    left: 0; /* Cột đầu tiên */
}

.sticky-col.sticky-col-2 {
    left: 150px; /* Cột thứ 2 - Phải bằng độ rộng của cột 1 (min-width: 150px từ CSS cũ) */
}

/* 6. (An toàn) Đảm bảo footer cũng được "đóng băng" */
#pasted-competition-report-container table tfoot td.sticky-col {
    background-color: hsl(210, 20%, var(--header-lightness)); /* Màu footer */
    z-index: 3; /* Nằm trên cả tiêu đề và nội dung */
}
/* === END: Sticky Columns (v1.1) === */

/* === START: YÊU CẦU 2 (v1.2) - Sửa lỗi con trỏ kéo thả === */
.column-toggle-btn {
    /* Mặc định là pointer để người dùng biết có thể click bật/tắt */
    cursor: pointer;
}

.column-toggle-btn .drag-handle-icon {
    /* Chỉ riêng icon kéo mới có cursor grab */
    cursor: grab;
}

.column-toggle-btn .drag-handle-icon:active {
    /* Khi đang kéo icon */
    cursor: grabbing;
}
/* === END: YÊU CẦU 2 (v1.2) === */

/* === START: UPDATED STYLES (v1.4) - "Multi-lane" Layout & Text Wrap === */

/* Container cho mỗi "làn đường" (Đạt, Gần Đạt, Cần Cố Gắng) */
.sknv-thidua-lane {
    display: flex;
    flex-direction: column;
}

/* Container chứa các thẻ card, cho phép xếp hàng ngang và xuống dòng */
.sknv-thidua-horizontal-content {
    padding: 0.75rem; /* p-3 */
    display: flex;
    flex-direction: row; /* Xếp hàng ngang */
    flex-wrap: wrap;     /* Tự động xuống dòng */
    gap: 0.75rem;        /* Khoảng cách giữa các thẻ */
}

/* Thông báo khi làn đường trống */
.sknv-thidua-horizontal-content .empty-col-msg {
    font-size: 0.875rem; /* text-sm */
    color: #6b7280; /* gray-500 */
    text-align: center;
    padding: 1rem 0;
    font-style: italic;
    width: 100%; /* Chiếm toàn bộ chiều rộng của làn đường */
}

/* Thẻ chi tiết từng ngành hàng (Yêu cầu 3 - Layout) */
.sknv-thidua-item-card {
    background-color: #ffffff; /* bg-white */
    border-radius: 0.5rem; /* rounded-lg */
    border: 1px solid #e5e7eb; /* border */
    padding: 0.75rem; /* p-3 */
    box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05); /* shadow-sm */
    transition: all 0.2s ease-in-out;
    
    /* Logic xếp hàng ngang: */
    /* === START: YÊU CẦU 3 (v1.6) === */
    flex: 1 1 180px; /* Thẻ có thể co giãn, cơ sở là 180px (thay vì 220px) */
    min-width: 180px; /* Chiều rộng tối thiểu 180px (thay vì 220px) */
    /* === END: YÊU CẦU 3 (v1.6) === */
} 
.sknv-thidua-item-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1); /* shadow-md */
}

/* Tiêu đề ngành hàng (Yêu cầu 1 - Text Wrap) */
.item-card-title {
    font-weight: 600; /* font-semibold */
    color: #1f2937; /* gray-800 */
    margin-bottom: 0.5rem; /* mb-2 */
    
    /* Bắt đầu sửa lỗi wrap text */
    white-space: normal; /* Cho phép xuống dòng */
    display: -webkit-box;
    -webkit-line-clamp: 2; /* Giới hạn 2 dòng */
    line-clamp: 2; /* === THÊM MỚI (v1.5) - Sửa lỗi tương thích === */
    -webkit-box-orient: vertical;
    overflow: hidden;
    text-overflow: ellipsis;
    min-height: 2.5em; /* Đảm bảo đủ chiều cao cho 2 dòng (line-height 1.25) */
    line-height: 1.25;
    /* Kết thúc sửa lỗi wrap text */
}

/* Các style còn lại của thẻ được giữ nguyên */
.item-card-progress-bar-container {
    width: 100%;
    background-color: #e5e7eb; /* gray-200 */
    border-radius: 9999px; /* rounded-full */
    height: 0.75rem; /* h-3 */
    overflow: hidden;
    margin-bottom: 0.5rem; /* mb-2 */
}
.item-card-progress-bar {
    height: 100%;
    border-radius: 9999px;
    transition: width 0.5s ease-in-out;
}
.item-card-metrics {
    font-size: 0.75rem; /* text-xs */
    color: #4b5563; /* gray-600 */
    display: flex;
    justify-content: space-between;
    flex-wrap: wrap;
    gap: 0.25rem 0.5rem; /* gap-x-2 gap-y-1 */
}
.item-card-metrics strong {
    font-weight: 600;
    color: #111827; /* gray-900 */
}
.item-card-metrics .text-green-600 { color: #16a34a; }
.item-card-metrics .text-red-600 { color: #dc2626; }

/* === END: UPDATED STYLES (v1.4) === */


/* === START: SỬA LỖI (v1.3) - Căn chỉnh icon cho thẻ KPI === */
.rt-infographic-summary-card .label {
    font-size: 0.875em;
    color: #4b5563;
    font-weight: 500;
    /* Thêm các thuộc tính flex để căn chỉnh icon */
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.25rem; /* 4px */
}
.rt-infographic-summary-card .label .feather {
    width: 1em;
    height: 1em;
}
/* === END: SỬA LỖI (v1.3) === */

/* === START: YÊU CẦU 5 (v1.6) - Làm dịu màu header === */
.sknv-thidua-column-header {
    display: flex;
    align-items: center;
    gap: 0.5rem; /* gap-2 */
    padding: 0.75rem 1rem; /* p-3 */
    border-bottom: 1px solid; /* Cập nhật border color bên dưới */
} 
.sknv-thidua-column-header .feather {
    width: 1.25rem; /* h-5 w-5 */
    height: 1.25rem;
    stroke-width: 2.5;
}
.sknv-thidua-column-header h4 {
    font-size: 1.125rem; /* text-lg */
    font-weight: 700; /* font-bold */
}
.sknv-thidua-column-header.header-blue {
    background-color: #dbeafe; /* blue-100 */
    color: #1e40af; /* blue-800 */
    border-color: #bfdbfe; /* blue-200 */
} 
.sknv-thidua-column-header.header-yellow {
    background-color: #fef9c3; /* yellow-100 */
    color: #854d0e; /* yellow-800 */
    border-color: #fde68a; /* yellow-200 */
} 
.sknv-thidua-column-header.header-red {
    background-color: #fee2e2; /* red-100 */
    color: #991b1b; /* red-800 */
    border-color: #fecaca; /* red-200 */
} 
/* === END: YÊU CẦU 5 (v1.6) === */


/* === START: (v1.6) Yêu cầu tùy chỉnh cho chi tiết thi đua (Yêu cầu 1 & 4) === */

/* Yêu cầu 1: Ghi đè header nhân viên (loại bỏ màu tím) */
#sknv-thidua-detail-capture-area .sknv-detail-header-card {
    background-color: #ffffff !important;
    border-color: #e5e7eb !important;
    border-top-width: 4px !important;
    border-top-color: #6b7280 !important; /* gray-500 */
} 
/* === START: THAY ĐỔI (v1.7) === */
#sknv-thidua-detail-capture-area .sknv-detail-header-card .name {
    color: #166534 !important; /* YC 1 (v1.7): Đổi sang xanh lá cây đậm (green-800) */
} 
/* === END: THAY ĐỔI (v1.7) === */
#sknv-thidua-detail-capture-area .sknv-detail-header-card .department {
    color: #374151 !important; /* gray-700 */
} 
#sknv-thidua-detail-capture-area .sknv-detail-header-card .sknv-card__avatar {
    background-color: #e5e7eb !important; /* gray-200 */
} 
#sknv-thidua-detail-capture-area .sknv-detail-header-card .sknv-card__avatar svg {
    color: #374151 !important; /* gray-700 */
} 

/* Yêu cầu 4: Thêm màu cho các thẻ KPI */
.rt-infographic-summary-card .value.is-dat {
    color: #16a34a !important; /* green-600 */
} 
.rt-infographic-summary-card .value.is-positive {
    color: #2563eb !important; /* blue-600 */
} 
.rt-infographic-summary-card .value.is-gan-dat {
    color: #f59e0b !important; /* amber-500 */
} 
.rt-infographic-summary-card .value.is-can-co-gang,
.rt-infographic-summary-card .value.is-negative {
    color: #dc2626 !important; /* red-600 */
} 
/* === START: SKNV Rank Number Styles (Design Soft Blue) === */

/* Top 3 Rank Style */
.sknv-card__avatar-rank {
    /* Style mặc định cho số của Top 3 (được override bởi inline class trong MedalIcon cho màu trắng) */
    text-shadow: 0 1px 2px rgba(0,0,0,0.3);
}

/* Rank 4+ Circle Style */
.sknv-card__avatar--standard {
    /* Nền Gradient Xanh dương phấn */
    background: linear-gradient(145deg, #eff6ff, #dbeafe) !important;
    
    /* Viền Xanh dương sáng */
    border: 2px solid #93c5fd !important;
    
    /* Đổ bóng nổi khối 3D */
    box-shadow: 
        3px 3px 6px rgba(37, 99, 235, 0.15), 
        -3px -3px 6px rgba(255, 255, 255, 0.8) !important;
    
    /* Kích thước */
    width: 44px;
    height: 44px;
    border-radius: 50%;
    
    /* Căn giữa số */
    display: flex;
    align-items: center;
    justify-content: center;
    
    /* Căn vị trí so với Card */
    margin-top: 2px;
    margin-left: 2px;
}

/* Rank 4+ Text Style */
.sknv-card__avatar--standard .sknv-card__avatar-rank {
    color: #1e40af !important; /* Xanh dương đậm */
    font-size: 1.25rem;
    font-weight: 800;
    text-shadow: none; /* Bỏ bóng của Top 3 */
    font-family: 'Inter', sans-serif;
}
/* === END: SKNV Rank Number Styles === */

<<< FILE_END: src/styles/specific-sknv.css

>>> FILE_START: src/styles/specific-tdv.css
/* Version 1.0 - Specific: TDV (Refactored from v6.19) */
/* Chứa các style CHỈ dành riêng cho tab Thi Đua Vùng (TDV) */

/* === BẮT ĐẦU: BỐ CỤC CHO THI ĐUA VÙNG & THI ĐUA LŨY KẾ (V5.9) === */
.tdv-rows-container { 
    display: flex; 
    flex-direction: column; 
    gap: 1.5rem; 
}
#subtab-luyke-thi-dua .tdv-row-body {
    display: grid;
    grid-template-columns: 1fr; /* Mặc định 1 cột cho mobile */
    gap: 1rem;
}
@media (min-width: 768px) { /* 2 cột cho tablet trở lên */
    #subtab-luyke-thi-dua .tdv-row-body {
        grid-template-columns: repeat(2, 1fr);
    }
}
/* === END: BỐ CỤC MỚI === */

.tdv-infographic-card {
    background-color: transparent;
    border: none;
    box-shadow: none;
    padding: 0;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
}
.tdv-header { 
    text-align: center; 
    margin-bottom: 2rem; 
}
.tdv-supermarket-name { 
    font-size: 2em; 
    font-weight: bold; 
    color: #005f73; 
}
.tdv-total-prize-container { 
    margin-top: 0.5rem; 
    font-size: 1.5em; 
    font-weight: bold; 
}
.tdv-total-prize-label { 
    color: #6b7280; 
    font-weight: normal; 
}
.tdv-total-prize-value { 
    color: #d90429; 
    margin-left: 0.5rem; 
}

.tdv-summary-grid { 
    display: grid; 
    grid-template-columns: repeat(2, 1fr); 
    gap: 1rem; 
    margin-top: 1.5rem; 
    margin-bottom: 2rem; 
}
@media (min-width: 768px) { 
    .tdv-summary-grid { 
        grid-template-columns: repeat(5, 1fr); 
    } 
}
.tdv-summary-item { 
    background-color: #ffffff; 
    border-radius: 8px;
    padding: 1rem; 
    text-align: center; 
    box-shadow: 0 2px 4px rgba(0,0,0,0.05); 
    border: 1px solid #e5e7eb;
}
/* === START: Sửa màu và font-weight cho .tdv-summary-value === */
.tdv-summary-value {
    display: block;
    font-size: 1.75em;
    font-weight: 800; /* Tăng độ đậm */
    color: #005f73; /* Đổi màu xanh đậm hơn */
}
/* === END: Sửa màu === */
.tdv-summary-label { 
    display: block; 
    font-size: 0.9em; 
    color: #4a5568; 
    margin-top: 0.25rem; 
}
/* === START: Thêm class màu cho tỷ lệ đạt === */
.tdv-tyledat-high { 
    color: #2563eb !important; /* blue-600 */
} 
.tdv-tyledat-low { 
    color: #dc2626 !important; /* red-600 */
} 
/* === END: Thêm class màu === */

.tdv-row { 
    background-color: #fdfdfd; 
    border-radius: 8px; 
    padding: 1rem; 
    border: 1px solid #dee2e6; 
}
.tdv-row-title { 
    font-size: 1.2em; 
    font-weight: bold;
    padding-bottom: 0.75rem; 
    margin-bottom: 1rem; 
    border-bottom: 2px solid; 
    line-height: 1.3; 
}
.tdv-row-title--prize { 
    border-color: #0d6efd; 
    color: #0d6efd; 
}
.tdv-row-title--soon-prize { 
    border-color: #e9c46a; 
    color: #e9c46a; 
}
.tdv-row-title--effort { 
    border-color: #6c757d; 
    color: #6c757d; 
}
.tdv-row-subtitle { 
    font-size: 0.8em; 
    font-weight: normal; 
    color: #d90429; 
}

/* === START: Sửa layout 4 cột cho Thi đua vùng (SỬA LẠI SELECTOR) === */
/* *** FIX: Corrected CSS selector to use #subtab-luyke-thidua-vung *** */
#subtab-luyke-thidua-vung .tdv-row-body {
    display: grid;
    grid-template-columns: repeat(1, 1fr); /* 1 cột cho mobile */
    gap: 1rem;
}
@media (min-width: 768px) { /* 2 cột cho tablet */
    #subtab-luyke-thidua-vung .tdv-row-body {
        grid-template-columns: repeat(2, 1fr);
    }
}
@media (min-width: 1280px) { /* 4 cột cho desktop lớn */
    #subtab-luyke-thidua-vung .tdv-row-body {
        grid-template-columns: repeat(4, 1fr);
    }
}
/* === END: Sửa layout === */
.tdv-row-body--effort { 
    display: block; 
}

.tdv-item-card { 
    background: #fff; 
    border: 1px solid #e0e0e0; 
    border-radius: 6px;
    padding: 12px; 
    box-shadow: 0 1px 3px rgba(0,0,0,0.05); 
    overflow: hidden; 
}
.tdv-item-card__title { 
    font-weight: bold;
    margin: 0 0 10px 0; 
    color: #333; 
}
.tdv-progress-bar-container {
    width: 100%;
    background-color: #e9ecef;
    border-radius: 20px;
    height: 28px;
    position: relative;
    font-size: 0.85em;
    font-weight: bold;
    overflow: hidden;
    display: flex;
    align-items: center;
    justify-content: center;
}
.tdv-progress-bar { 
    height: 100%; 
    transition: width 0.5s ease; 
    position: absolute; 
    top: 0; 
    left: 0; 
}
.tdv-progress-bar--blue { 
    background-color: #0d6efd; 
}
.tdv-progress-bar--yellow { 
    background-color: #e9c46a; 
}
.tdv-progress-bar__text {
    position: relative;
    z-index: 1;
    text-shadow: 1px 1px 2px rgba(0,0,0,0.4);
    color: white;
}
.tdv-item-card__details { 
    font-size: 0.85em; 
    color: #555; 
    margin-top: 8px; 
    display: grid; 
    grid-template-columns: repeat(3, 1fr); 
    gap: 5px; 
}
.tdv-item-card__details span { 
    display: block; 
}
.tdv-item-card__details strong { 
    color: #000; 
}
.tdv-item-card__prize { 
    grid-column: 1 / -1; 
    font-weight: bold !important; 
    color: #d90429; 
    margin-top: 4px; 
}

.tdv-effort-subgroup { 
    margin-bottom: 1rem; 
}
.tdv-effort-subgroup:last-child { 
    margin-bottom: 0; 
}
.tdv-effort-subgroup__title { 
    font-weight: bold; 
    margin: 0 0 10px 0; 
    padding-bottom: 5px; 
    border-bottom: 1px solid #dee2e6; 
}
.tdv-effort-subgroup__title--potential { 
    color: #fd7e14; 
}
.tdv-effort-subgroup__title--major { 
    color: #6c757d; 
}
.tdv-effort-list { 
    display: flex; 
    flex-wrap: wrap; 
    gap: 8px; 
}
.tdv-effort-item { 
    background-color: #f1f3f5; 
    color: #495057; 
    padding: 5px 10px; 
    border-radius: 15px; 
    font-size: 0.9em; 
}
<<< FILE_END: src/styles/specific-tdv.css

>>> FILE_START: src/styles/tables.css
/* Version 1.0 - Tables styles (Refactored from v6.19) */
/* Chứa các class chung cho bảng biểu: borders, striping, header colors, sort indicators */

.table-bordered { 
    border-collapse: collapse; 
}
.table-bordered th, .table-bordered td { 
    border: 1px solid #e5e7eb; 
}
.table-striped tbody tr:nth-child(even) { 
    background-color: #f9fafb; 
}
.table-footer { 
    background-color: hsl(210, 20%, var(--header-lightness));
    border-top: 2px solid #9ca3af; 
}
.cell-performance.is-below { 
    background-color: hsl(0, 80%, var(--below-target-lightness)) !important; 
}

/* === Sort Indicators === */
.sortable { 
    cursor: pointer; 
    position: relative; 
    user-select: none; 
}
.sort-indicator { 
    display: inline-flex; 
    flex-direction: column; 
    align-items: center; 
    justify-content: center; 
    width: 1em; 
    height: 1em; 
    margin-left: 4px; 
    vertical-align: middle; 
    color: #9ca3af; 
    transition: color 0.2s ease-in-out; 
}
.sortable .sort-indicator::before { 
    content: '▲'; 
    font-size: 0.8em; 
    line-height: 0.5; 
    opacity: 0.4; 
}
.sortable .sort-indicator::after { 
    content: '▼'; 
    font-size: 0.8em; 
    line-height: 0.5; 
    opacity: 0.4; 
}
.sortable:hover .sort-indicator { 
    color: #374151; 
}
.sortable.sorted-asc .sort-indicator::before { 
    opacity: 1; 
    color: #3b82f6; 
}
.sortable.sorted-asc .sort-indicator::after { 
    opacity: 0.4; 
}
.sortable.sorted-desc .sort-indicator::after { 
    opacity: 1; 
    color: #3b82f6; 
}
.sortable.sorted-desc .sort-indicator::before { 
    opacity: 0.4;
}

/* === Draggable Headers === */
.draggable-header {
    cursor: move;
    cursor: grab;
}
.draggable-header:active {
    cursor: grabbing;
}
.sortable-ghost {
    opacity: 0.4;
    background-color: #c7d2fe; /* indigo-200 */
}
.sortable-drag {
    opacity: 0.95;
    transform: rotate(-2deg);
    box-shadow: 0 8px 16px rgba(0,0,0,0.2);
}


/* === Table Header Colors === */
.header-bg-blue { background-color: hsl(217, 95%, var(--special-header-lightness)) !important; color: hsl(217, 80%, var(--header-text-lightness)) !important; }
.header-bg-green { background-color: hsl(145, 80%, var(--special-header-lightness)) !important; color: hsl(145, 70%, var(--header-text-lightness)) !important; }
.header-bg-yellow { background-color: hsl(45, 95%, var(--special-header-lightness)) !important; color: hsl(45, 80%, var(--header-text-lightness)) !important; }

.header-group-1 { background-color: hsl(30, 90%, var(--header-lightness)); }
.header-group-2 { background-color: hsl(90, 90%, var(--header-lightness)); }
.header-group-3 { background-color: hsl(180, 90%, var(--header-lightness)); }
.header-group-4 { background-color: hsl(240, 90%, var(--header-lightness)); }
.header-group-5 { background-color: hsl(300, 90%, var(--header-lightness)); }
.header-group-6 { background-color: hsl(0, 90%, var(--header-lightness)); }
.header-group-7 { background-color: hsl(160, 80%, var(--header-lightness)) !important; }
.header-group-8 { background-color: hsl(280, 80%, var(--header-lightness)) !important; }
.header-group-9 { background-color: hsl(70, 80%, var(--header-lightness)) !important; }
.header-group-10 { background-color: hsl(190, 80%, var(--header-lightness)) !important; }
.header-group-11 { background-color: hsl(340, 80%, var(--header-lightness)) !important; }
.header-group-12 { background-color: hsl(20, 80%, var(--header-lightness)) !important; }

.department-header-tv { background-color: #e0e7ff; color: #3730a3; }
.department-header-kho { background-color: #d1fae5; color: #065f46; }
.department-header-tt { background-color: #fef3c7; color: #92400e; }
.category-header-ict { background-color: #dbeafe; color: #1e40af; }
.category-header-phukien { background-color: #fee2e2; color: #991b1b; }
.category-header-giadung { background-color: #fef9c3; color: #854d0e; }
.category-header-ce { background-color: #e0f2fe; color: #0c4a6e; }
.category-header-baohiem { background-color: #f3e8ff; color: #6b21a8; }
.header-bg-indigo { background-color: #e0e7ff; color: #3730a3; }
.header-bg-purple { background-color: #f3e8ff; color: #6b21a8; }

.qdc-group-title { font-weight: 600; }
.qdc-group-ict { background-color: hsl(190, 80%, var(--special-header-lightness)); }
.qdc-group-vas { background-color: hsl(140, 80%, var(--special-header-lightness)); }
.qdc-group-giadung { background-color: hsl(0, 80%, var(--special-header-lightness)); }
.qdc-group-sim { background-color: hsl(40, 80%, var(--special-header-lightness)); }

.competition-header-doanhthu { border-color: #a78bfa; background-color: hsl(260, 90%, var(--bg-lightness)); }
.competition-header-soluong { border-color: #facc15; background-color: hsl(50, 90%, var(--bg-lightness)); }
.header-highlight-special { background-color: hsl(25, 90%, var(--header-lightness)) !important; }
.competition-row-below-100 td { background-color: #fee2e2; color: #991b1b; }

.header-highlight { background-color: hsl(50, 95%, var(--special-header-lightness)) !important; }
<<< FILE_END: src/styles/tables.css

>>> FILE_START: src/styles/vendor.css
/* Version 1.0 - Vendor overrides (Refactored from v6.19) */
/* Chứa các style ghi đè lên thư viện bên thứ ba, ví dụ: Choices.js */

#dtnv-realtime-employee-selector-container .choices__inner { 
    min-width: 300px; 
}
#dtnv-realtime-employee-selector-container .choices__list--single { 
    min-width: 300px; 
}

.choices__inner { 
    min-height: 42px; 
}
.choices__list--multiple .choices__item { 
    background-color: #3b82f6; 
    border-color: #2563eb; 
}

#goal-drawer .choices__inner {
    min-width: 250px;
}

#goal-drawer .choices__list--dropdown,
#goal-drawer .choices__list[aria-expanded] {
    min-width: 100%;
    width: auto;
    word-break: normal;
}

#goal-drawer .choices__list--multiple .choices__item {
    display: inline-flex;
    align-items: center;
    background-color: #3b82f6;
    border: 1px solid #2563eb;
    color: white;
    border-radius: 9999px;
    padding: 2px 8px;
    font-size: 0.8em;
    font-weight: 500;
    margin: 2px 4px 2px 0;
}
#goal-drawer .choices__inner {
    height: auto !important;
    min-height: 42px !important;
    display: flex !important;
    flex-wrap: wrap !important;
}
<<< FILE_END: src/styles/vendor.css
