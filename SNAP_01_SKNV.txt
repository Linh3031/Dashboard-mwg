CONTEXT GROUP: SNAP_01_SKNV.txt
GENERATED AT: 1/31/2026, 6:17:34 PM


>>> FILE_START: src/components/health-staff/CategoryRevenueView.svelte
<script>
  import { onMount } from 'svelte';
  import { customRevenueTables, modalState, isAdmin, selectedWarehouse } from '../../stores.js';
  import { adminService } from '../../services/admin.service.js';
  import { datasyncService } from '../../services/datasync.service.js';
  import DynamicRevenueTable from './DynamicRevenueTable.svelte';

  export let reportData = [];

  let isLoading = false;
  // Bi·∫øn tƒ©nh (module-level) ƒë·ªÉ ghi nh·ªõ kho ƒë√£ t·∫£i l·∫ßn cu·ªëi c√πng component n√†y ƒë∆∞·ª£c mount
  let lastLoadedWarehouse = '';

  // [FIX CRASH] Logic t√≠nh to√°n visibleTables an to√†n tuy·ªát ƒë·ªëi
  $: visibleTables = ($customRevenueTables || []).reduce((acc, table, index) => {
      // Ch·ªâ l·∫•y b·∫£ng ch∆∞a b·ªã ·∫©n
      if (table.isVisible !== false) {
          acc.push({
              ...table,
              // N·∫øu id null/undefined, t·∫°o id t·∫°m d·ª±a tr√™n index ƒë·ªÉ Svelte kh√¥ng b√°o duplicate key
              id: table.id ? table.id : `fallback_render_id_${index}` 
          });
      }
      return acc;
  }, []);

  // [LOGIC M·ªöI] Khi Kho thay ƒë·ªïi -> T·∫£i l·∫°i d·ªØ li·ªáu (C√≥ ki·ªÉm tra Cache)
  $: if ($selectedWarehouse) {
      handleWarehouseDataLoad($selectedWarehouse);
  }

  async function handleWarehouseDataLoad(kho) {
      // CASE 1: D·ªØ li·ªáu ƒë√£ c√≥ trong Store v√† ƒë√∫ng l√† c·ªßa kho hi·ªán t·∫°i (ho·∫∑c ch∆∞a ch·ªçn kho specific)
      // -> KH√îNG T·∫¢I L·∫†I (Instant load)
      if ($customRevenueTables.length > 0 && lastLoadedWarehouse === kho) {
          console.log(`[CategoryView] D√πng Cache Store cho kho: ${kho}`);
          return;
      }

      // CASE 2: Ch∆∞a c√≥ d·ªØ li·ªáu ho·∫∑c ƒë·ªïi kho -> Ti·∫øn h√†nh t·∫£i
      await loadData(kho);
  }

  async function loadData(kho) {
      console.log(`[CategoryView] Loading tables for warehouse: ${kho}`);
      
      // Ch·ªâ hi·ªán loading n·∫øu Store ƒëang r·ªóng (tr√°nh ch·ªõp nh√°y khi refresh ng·∫ßm)
      if ($customRevenueTables.length === 0) {
          isLoading = true;
      }
      
      try {
          // 1. T·∫£i b·∫£ng H·ªá th·ªëng (Global)
          const systemTables = await adminService.loadSystemRevenueTables();
          
          // 2. T·∫£i b·∫£ng C√° nh√¢n (Warehouse Cloud)
          const personalTables = await datasyncService.loadPersonalRevenueTables(kho);

          // 3. T·∫£i Preferences ·∫©n/hi·ªán (Local)
          const hiddenSystemIds = JSON.parse(localStorage.getItem('hiddenSystemTableIds') || '[]');

          // 4. Merge & Sanitize (L√†m s·∫°ch d·ªØ li·ªáu)
          const finalSystemTables = (systemTables || []).map((t, index) => ({
              ...t,
              id: t.id || `sys_gen_${index}_${Date.now()}`, 
              isSystem: true,
              isVisible: !hiddenSystemIds.includes(t.id)
          }));

          const safePersonalTables = (personalTables || []).map((t, index) => ({
              ...t,
              id: t.id || `per_gen_${index}_${Date.now()}` 
          }));

          // C·∫≠p nh·∫≠t Store
          customRevenueTables.set([...finalSystemTables, ...safePersonalTables]);
          
          // Ghi nh·ªõ kho ƒë√£ t·∫£i th√†nh c√¥ng
          lastLoadedWarehouse = kho;

      } catch (e) {
          console.error("[CategoryView] L·ªói t·∫£i d·ªØ li·ªáu b·∫£ng:", e);
      } finally {
          isLoading = false;
      }
  }

  // --- C√ÅC H√ÄM X·ª¨ L√ù S·ª∞ KI·ªÜN ---
  async function savePersonalTables() {
      if (!$selectedWarehouse) return;
      const personalTables = $customRevenueTables.filter(t => !t.isSystem);
      await datasyncService.savePersonalRevenueTables($selectedWarehouse, personalTables);
  }

  function saveHiddenPreferences() {
      const hiddenIds = $customRevenueTables
          .filter(t => t.isSystem && t.isVisible === false)
          .map(t => t.id);
      localStorage.setItem('hiddenSystemTableIds', JSON.stringify(hiddenIds));
  }

  function toggleTableVisibility(id) {
      if (!id || String(id).startsWith('fallback_render_id_')) return;
      customRevenueTables.update(items => items.map(t => t.id === id ? { ...t, isVisible: !t.isVisible } : t));
      savePersonalTables();
      saveHiddenPreferences();
  }

  function editTable(table) {
      if (String(table.id).startsWith('fallback_render_id_')) {
          alert("B·∫£ng n√†y ƒëang b·ªã l·ªói d·ªØ li·ªáu, kh√¥ng th·ªÉ s·ª≠a.");
          return;
      }
      if (table.isSystem && !$isAdmin) {
          alert("B·∫°n kh√¥ng c√≥ quy·ªÅn ch·ªânh s·ª≠a B·∫£ng h·ªá th·ªëng.");
          return;
      }
      modalState.update(s => ({ ...s, activeModal: 'add-revenue-table-modal', payload: table }));
  }

  async function deleteTable(id) {
      if (!id || String(id).startsWith('fallback_render_id_')) {
          customRevenueTables.update(items => items.filter(t => t.id)); 
          return;
      }

      const targetTable = $customRevenueTables.find(t => t.id === id);
      if (!targetTable) return;

      if (targetTable.isSystem) {
          if ($isAdmin) {
               if (!confirm("C·∫¢NH B√ÅO ADMIN: X√≥a b·∫£ng H·ªÜ TH·ªêNG n√†y vƒ©nh vi·ªÖn?")) return;
              const newTables = $customRevenueTables.filter(t => t.id !== id);
              customRevenueTables.set(newTables);
              await adminService.saveSystemRevenueTables(newTables);
          } else {
              if (!confirm("·∫®n b·∫£ng n√†y kh·ªèi m√†n h√¨nh c·ªßa b·∫°n?")) return;
              customRevenueTables.update(items => items.map(t => t.id === id ? { ...t, isVisible: false } : t));
              saveHiddenPreferences();
          }
      } else {
          if (!confirm("B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a b·∫£ng n√†y? H√†nh ƒë·ªông n√†y s·∫Ω x√≥a tr√™n Cloud c·ªßa kho hi·ªán t·∫°i.")) return;
          customRevenueTables.update(items => items.filter(t => t.id !== id));
          await savePersonalTables();
      }
  }

  function openAddModal() {
      if (!$selectedWarehouse) {
          alert("Vui l√≤ng ch·ªçn Kho tr∆∞·ªõc khi t·∫°o b·∫£ng m·ªõi.");
          return;
      }
     modalState.update(s => ({ ...s, activeModal: 'add-revenue-table-modal', payload: null }));
  }

  $: hasAnyData = reportData.length > 0;
  const colors = ['blue', 'green', 'orange', 'purple', 'teal', 'indigo', 'rose'];
  const getColor = (index) => colors[index % colors.length];
</script>

{#if isLoading}
    <div class="flex flex-col items-center justify-center p-12 text-blue-500">
        <svg class="animate-spin h-8 w-8 mb-3" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
        </svg>
        <p class="text-sm font-semibold">ƒêang t·∫£i c·∫•u h√¨nh b·∫£ng...</p>
    </div>
{:else}

    {#if $customRevenueTables.length > 0}
    <div class="mb-6 flex flex-wrap items-center gap-2 bg-white p-3 rounded-xl border border-gray-200 shadow-sm">
        <div class="text-xs font-bold uppercase text-gray-500 mr-2 flex items-center gap-1">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z" /></svg>
            B·∫£ng hi·ªÉn th·ªã:
        </div>
        {#each $customRevenueTables as table, index}
            <button 
                class="px-3 py-1.5 rounded-full text-xs font-medium border transition-all 
                    duration-200 flex items-center gap-1.5 select-none
                    {table.isVisible !== false ? 'bg-blue-600 text-white border-blue-600 shadow-md transform -translate-y-0.5' : 'bg-gray-100 text-gray-500 border-gray-200 hover:bg-gray-200'}
                    {table.isSystem ? 'border-dashed' : ''}"
                on:click={() => toggleTableVisibility(table.id || `fallback_render_id_${index}`)}
                title={table.isSystem ? "B·∫£ng h·ªá th·ªëng" : "B·∫£ng c√° nh√¢n"}
            >
                {#if table.isSystem}<span class="text-[10px] mr-0.5 opacity-70">üåê</span>{/if}
                {table.title || '(Kh√¥ng t√™n)'}
            </button>
        {/each}
        <button class="px-3 py-1.5 rounded-full text-xs font-bold border 
    border-dashed border-gray-300 text-gray-500 hover:text-blue-600 hover:border-blue-400 hover:bg-blue-50 transition-colors ml-auto flex items-center gap-1" on:click={openAddModal}>
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" /></svg>
            T·∫°o m·ªõi
        </button>
    </div>
    {/if}

    {#if !hasAnyData}
        <div class="p-12 text-center bg-gray-50 rounded-xl border border-gray-200 border-dashed">
            <p class="text-gray-500 font-medium">Ch∆∞a c√≥ d·ªØ li·ªáu b√°o c√°o nh√¢n vi√™n.</p>
        </div>
    {:else if $customRevenueTables.length === 0}
        <div class="p-12 text-center bg-white rounded-xl border border-blue-100 shadow-sm flex flex-col items-center">
            <div class="w-16 h-16 bg-blue-50 rounded-full flex items-center justify-center mb-4 text-blue-500">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 
    0 01.293.707V19a2 2 0 01-2 2z" /></svg>
            </div>
            <h4 class="text-lg font-bold text-gray-800 mb-2">Ch∆∞a c√≥ B·∫£ng b√°o c√°o n√†o</h4>
            <p class="text-gray-500 mb-6 max-w-md">B·∫°n ch∆∞a t·∫°o b·∫£ng theo d√µi n√†o.</p>
            <button class="px-6 py-2.5 bg-blue-600 text-white rounded-lg font-bold hover:bg-blue-700 shadow-md flex items-center gap-2" on:click={openAddModal}>
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" /></svg>
                T·∫°o b·∫£ng ngay
            </button>
        </div>
    {:else if visibleTables.length === 0}
        <div class="p-12 text-center bg-gray-50 rounded-xl border border-gray-200">
            <p class="text-gray-500 font-medium">B·∫°n ƒë√£ ·∫©n t·∫•t c·∫£ c√°c b·∫£ng. Vui 
    l√≤ng b·∫≠t l·∫°i tr√™n thanh c√¥ng c·ª•.</p>
        </div>
    {:else}
        <div class="grid grid-cols-1 xl:grid-cols-2 gap-6 pb-10">
            {#each visibleTables as table, index (table.id)}
                <div data-capture-group="category-revenue">
                    <DynamicRevenueTable 
                        config={table}
                        {reportData}
                        colorTheme={getColor(index)}
                        on:edit={() => editTable(table)}
                        on:delete={() => deleteTable(table.id)}
                    />
                </div>
            {/each}
        </div>
    {/if}

{/if}
<<< FILE_END: src/components/health-staff/CategoryRevenueView.svelte

>>> FILE_START: src/components/health-staff/CompetitionTab.svelte
<script>
  import { onMount } from 'svelte';
  import { 
      ycxData, 
      globalCompetitionConfigs, 
      localCompetitionConfigs,
      pastedThiDuaReportData 
  } from '../../stores.js';
  import { services } from '../../services.js';

  import CompetitionModeSelector from './competition/CompetitionModeSelector.svelte';
  import ProgramView from './competition/ProgramView.svelte';
  import EmployeeView from './competition/EmployeeView.svelte';
  // [NEW] Import view chi ti·∫øt m·ªõi
  import CompetitionDetailView from './competition/CompetitionDetailView.svelte';

  // [Y√äU C·∫¶U] M·∫∑c ƒë·ªãnh v√†o l√† xem theo nh√¢n vi√™n
  let activeView = 'employee'; 
  let programReportData = [];
  
  // [NEW] State cho view chi ti·∫øt
  let isDetailView = false;
  let selectedEmployeeId = null;

  // Logic t√≠nh to√°n cho Program View (T·ª± ƒë·ªông khi YCX ho·∫∑c Config thay ƒë·ªïi)
  $: {
      if ($ycxData.length > 0) {
          const allConfigs = [...$globalCompetitionConfigs, ...$localCompetitionConfigs];
          programReportData = services.calculateCompetitionFocusReport($ycxData, allConfigs);
      } else {
          programReportData = [];
      }
  }

  function handleViewChange(event) {
      activeView = event.detail;
      // Reset v·ªÅ list khi ƒë·ªïi tab con
      isDetailView = false;
      selectedEmployeeId = null;
  }

  // [NEW] X·ª≠ l√Ω khi click v√†o nh√¢n vi√™n
  function handleViewDetail(event) {
      selectedEmployeeId = event.detail.employeeId;
      isDetailView = true;
  }

  // [NEW] X·ª≠ l√Ω quay l·∫°i
  function handleBackToList() {
      isDetailView = false;
      selectedEmployeeId = null;
  }
</script>

<div class="space-y-6">
    <div class="flex flex-wrap items-center justify-between gap-4 bg-white p-4 rounded-xl border border-gray-200 shadow-sm">
        <div class="flex items-center gap-3">
            <div class="p-2 bg-purple-100 rounded-lg text-purple-600">
                <i data-feather="award" class="w-5 h-5"></i>
            </div>
            <div>
                <h3 class="text-lg font-bold text-gray-800 uppercase leading-tight">Thi ƒêua L≈©y K·∫ø</h3>
                <p class="text-xs text-gray-500">Theo d√µi ti·∫øn ƒë·ªô c√°c ch∆∞∆°ng tr√¨nh thi ƒëua</p>
            </div>
        </div>
        
        <CompetitionModeSelector {activeView} on:change={handleViewChange} />
    </div>

    <div class="min-h-[400px]">
        {#if activeView === 'program'}
            <ProgramView reportData={programReportData} />
        {:else}
            {#if isDetailView && selectedEmployeeId}
                <CompetitionDetailView 
                    employeeId={selectedEmployeeId}
                    allReportData={$pastedThiDuaReportData}
                    on:back={handleBackToList}
                />
            {:else}
                <EmployeeView 
                    reportData={$pastedThiDuaReportData} 
                    on:viewChange={(e) => activeView = e.detail}
                    on:viewDetail={handleViewDetail} 
                />
            {/if}
        {/if}
    </div>
</div>
<<< FILE_END: src/components/health-staff/CompetitionTab.svelte

>>> FILE_START: src/components/health-staff/DynamicRevenueTable.svelte
<script>
  import { createEventDispatcher, onMount } from 'svelte';
  
  // [FIX IMPORT] ƒê∆∞·ªùng d·∫´n t∆∞∆°ng ƒë·ªëi
  import { formatters } from '../../utils/formatters.js';
  import { isAdmin } from '../../stores.js';
  import { dynamicTableProcessor } from '../../services/processing/logic/dynamicTable.processor.js';
  
  import DynamicTableHeader from './revenue/DynamicTableHeader.svelte';
  import DynamicTableRow from './revenue/DynamicTableRow.svelte';
  
  export let config;
  export let reportData = []; 
  export let colorTheme = 'blue'; 

  const dispatch = createEventDispatcher();

  let sortKey = 'mainValue';
  let sortDirection = 'desc';

  $: tableMetrics = config.mainColumn?.metrics || config.tableMetrics || { sl: false, dt: true, dtqd: false };

  // X·ª≠ l√Ω d·ªØ li·ªáu
  $: processedResult = dynamicTableProcessor.processTableData(reportData, config);
  $: processedData = processedResult.processedData;
  $: totals = processedResult.totals;

  // [FIX CRITICAL] H√†m l·∫•y gi√° tr·ªã sort th√¥ng minh
  function getSortValue(item, key) {
      let val;

      // 1. X·ª≠ l√Ω c√°c tr∆∞·ªùng c∆° b·∫£n
      if (key === 'hoTen') return item.hoTen;
      if (key === 'mainValue') val = item.mainValue;
      else if (key === 'totalSL') val = item.mainValue_sl;
      else if (key === 'totalDTQD') val = item.mainValue_dtqd;
      else {
          // 2. X·ª≠ l√Ω c·ªôt ƒë·ªông (Dynamic Columns)
          // Tr∆∞·ªùng h·ª£p key c√≥ d·∫°ng "ColID|Metric" (VD: Laptop|sl)
          if (key.includes('|')) {
              const [colId, metric] = key.split('|');
              if (item.cells && item.cells[colId]) {
                  // Map metric sang t√™n tr∆∞·ªùng d·ªØ li·ªáu th·ª±c t·∫ø
                  if (metric === 'sl') val = item.cells[colId].value_sl || item.cells[colId].sl;
                  else if (metric === 'dt') val = item.cells[colId].value || item.cells[colId].dt;
                  else if (metric === 'dtqd') val = item.cells[colId].value_dtqd || item.cells[colId].dtqd;
                  else val = item.cells[colId].value; // M·∫∑c ƒë·ªãnh l·∫•y DT
              }
          } 
          // Tr∆∞·ªùng h·ª£p key l√† ID c·ªôt ƒë∆°n thu·∫ßn
          else if (item.cells && item.cells[key]) {
              val = item.cells[key].value; 
          } else {
              val = 0;
          }
      }

      // 3. √âp ki·ªÉu s·ªë an to√†n (Ch·ªëng l·ªói NaN)
      let finalVal = 0;
      if (typeof val === 'string') {
          // X√≥a t·∫•t c·∫£ k√Ω t·ª± kh√¥ng ph·∫£i s·ªë/d·∫•u ch·∫•m/d·∫•u tr·ª´ (VD: "1,200" -> 1200)
          const cleanStr = val.replace(/[^\d.-]/g, '');
          finalVal = parseFloat(cleanStr);
      } else {
          finalVal = Number(val);
      }
      
      return isNaN(finalVal) ? 0 : finalVal;
  }

  // Logic Sort
  $: sortedData = [...processedData].sort((a, b) => {
      let valA = getSortValue(a, sortKey);
      let valB = getSortValue(b, sortKey);

      if (sortKey === 'hoTen') {
          return sortDirection === 'asc' ? String(valA).localeCompare(String(valB)) : String(valB).localeCompare(String(valA));
      } else {
          return sortDirection === 'asc' ? valA - valB : valB - valA;
      }
  });

  function handleSort(event) {
      const key = event.detail;
      // ƒê·ªïi h∆∞·ªõng n·∫øu sort l·∫°i c√πng 1 c·ªôt
      if (sortKey === key) sortDirection = sortDirection === 'desc' ? 'asc' : 'desc';
      else { sortKey = key; sortDirection = 'desc'; }
  }
  
  function handleManualSort(event) {
      const key = event.detail;
      if (sortKey === key) sortDirection = sortDirection === 'desc' ? 'asc' : 'desc';
      else { sortKey = key; sortDirection = 'asc'; }
  }

  const themeMap = {
      blue: { header: 'bg-blue-50 border-blue-200', title: 'text-blue-800' },
      green: { header: 'bg-green-50 border-green-200', title: 'text-green-800' },
      orange: { header: 'bg-orange-50 border-orange-200', title: 'text-orange-800' },
      purple: { header: 'bg-purple-50 border-purple-200', title: 'text-purple-800' },
      teal: { header: 'bg-teal-50 border-teal-200', title: 'text-teal-800' },
      indigo: { header: 'bg-indigo-50 border-indigo-200', title: 'text-indigo-800' },
      rose: { header: 'bg-rose-50 border-rose-200', title: 'text-rose-800' },
  };
  $: theme = themeMap[colorTheme] || themeMap.blue;
  $: totalColSpan = (tableMetrics.sl ? 1 : 0) + (tableMetrics.dt ? 1 : 0) + (tableMetrics.dtqd ? 1 : 0);
</script>

<div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden h-full flex flex-col transition-all hover:shadow-md relative group/card" 
     data-capture-table="true"
     data-table-debug={config.title}>
    
    {#if $isAdmin || !config.isSystem}
        <div class="absolute top-3 right-3 opacity-0 group-hover/card:opacity-100 transition-opacity flex gap-1 z-10 bg-white/80 backdrop-blur rounded-lg p-1 shadow-sm border border-gray-100">
             {#if !config.isSystem}<button class="p-1.5 text-gray-400 hover:text-blue-600 rounded hover:bg-blue-50" on:click|stopPropagation={() => dispatch('edit')}><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" /></svg></button>{/if}
            <button class="p-1.5 text-gray-400 hover:text-red-600 rounded hover:bg-red-50" on:click|stopPropagation={() => dispatch('delete')}><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg></button>
        </div>
    {/if}

    <div class="px-5 py-4 border-b {theme.header} flex justify-between items-center">
        <div class="flex items-center gap-3 w-full">
            <h4 class="text-lg font-bold uppercase {theme.title} truncate" title={config.title}>{config.title}</h4>
        </div>
    </div>
    
    {#if sortedData.length === 0}
        <div class="flex-grow flex items-center justify-center p-8 bg-slate-50/30">
             <p class="text-gray-400 italic text-sm">Ch∆∞a c√≥ ph√°t sinh d·ªØ li·ªáu.</p>
        </div>
    {:else}
        <div class="overflow-x-auto flex-grow custom-scrollbar relative">
            <table class="min-w-full text-sm border-collapse border-0">
                <DynamicTableHeader 
                    {config} {tableMetrics} {totalColSpan} {sortKey} {sortDirection}
                    on:sort={handleSort}
                    on:manualSort={handleManualSort}
                 />

                <tbody class="divide-y divide-gray-100">
                    {#each sortedData as item (item.maNV)}
                        <DynamicTableRow {item} {config} {tableMetrics} />
                    {/each}
                </tbody>

                <tfoot class="bg-gray-100 font-bold text-gray-800 border-t border-gray-300 sticky bottom-0 z-20">
                    <tr>
                        <td class="px-5 py-2 sticky left-0 bg-gray-200 z-30 border-r border-gray-300 shadow-[2px_0_5px_-2px_rgba(0,0,0,0.1)]">T·ªîNG</td>
                        {#if tableMetrics.sl}
                              <td class="px-2 py-2 text-right border-r border-gray-300 bg-gray-200">
                                 {formatters.formatNumber(totals.cells?.mainValue?.value_sl || totals.mainValue_sl)}
                              </td>
                        {/if}
                        {#if tableMetrics.dt}
                             <td class="px-2 py-2 text-right border-r border-gray-300 bg-gray-200 text-blue-800">
                                 {formatters.formatRevenue(totals.cells?.mainValue?.value || totals.mainValue)}
                             </td>
                        {/if}
                        {#if tableMetrics.dtqd}
                            <td class="px-2 py-2 text-right border-r border-gray-300 bg-gray-200 text-purple-800">
                                {formatters.formatRevenue(totals.cells?.mainValue?.value_dtqd || totals.mainValue_dtqd)}
                            </td>
                        {/if}

                        {#each config.subColumns as col}
                            {@const total = totals.cells ? (totals.cells[col.id] || totals.cells[col.header]) : null}
                            {@const metrics = col.metrics || { sl: false, dt: true, dtqd: false }}
                            
                            {#if metrics.sl}
                                <td class="px-2 py-2 text-right border-r border-gray-300">{formatters.formatNumber(total?.value_sl || total?.sl)}</td>
                            {/if}
                            {#if metrics.dt}
                                <td class="px-2 py-2 text-right border-r border-gray-300 text-blue-700">{formatters.formatRevenue(total?.value || total?.dt)}</td>
                            {/if}
                            {#if metrics.dtqd}
                                <td class="px-2 py-2 text-right border-r border-gray-300 text-purple-700">{formatters.formatRevenue(total?.value_dtqd || total?.dtqd)}</td>
                            {/if}
                        {/each}
                    </tr>
                </tfoot>
            </table>
        </div>
    {/if}
</div>

<style>
    .custom-scrollbar::-webkit-scrollbar { width: 6px; height: 6px; }
    .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
    .custom-scrollbar::-webkit-scrollbar-thumb { background: #e5e7eb; border-radius: 3px; }
    .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #d1d5db; }
</style>
<<< FILE_END: src/components/health-staff/DynamicRevenueTable.svelte

>>> FILE_START: src/components/health-staff/EfficiencyTable.svelte
<script>
    import { createEventDispatcher } from 'svelte';
    import { fly } from 'svelte/transition';
    import { formatters } from '../../utils/formatters.js';
    import { efficiencyConfig } from '../../stores.js';
    
    export let data = [];
    export let isLoading = false;
    
    const dispatch = createEventDispatcher();
    
    // --- STATE ---
    let sortKey = 'doanhThu';
    let sortDirection = 'desc';
    let currentPage = 1;
    let itemsPerPage = 10;
    
    // --- CONFIG COLUMNS ---
    // [FIX] ƒê√£ x√≥a { id: 'pctPhuKien', ... } kh·ªèi danh s√°ch c·ª©ng ƒë·ªÉ tr√°nh tr√πng l·∫∑p
    const FIXED_COLUMNS = [
        { id: 'dtICT', label: 'DT ICT', isRate: false, headerClass: 'bg-blue-100 text-blue-900', format: 'revenue' },
        { id: 'dtPhuKien', label: 'DT Ph·ª• ki·ªán', isRate: false, headerClass: 'bg-blue-100 text-blue-900', format: 'revenue' },
        
        { id: 'dtCE', label: 'DT CE', isRate: false, headerClass: 'bg-green-100 text-green-900', format: 'revenue' },
        { id: 'dtGiaDung', label: 'DT Gia d·ª•ng', isRate: false, headerClass: 'bg-green-100 text-green-900', format: 'revenue' },
        
        { id: 'pctMLN', label: '% MLN', isRate: true, targetKey: 'phanTramMLN', headerClass: 'bg-green-100 text-green-900', format: 'percent' },
        { id: 'pctSim', label: '% Sim', isRate: true, targetKey: 'phanTramSim', headerClass: 'bg-yellow-100 text-yellow-900', format: 'percent' },
        { id: 'pctVAS', label: '% VAS', isRate: true, targetKey: 'phanTramVAS', headerClass: 'bg-yellow-100 text-yellow-900', format: 'percent' },
        { id: 'pctBaoHiem', label: '% B·∫£o hi·ªÉm', isRate: true, targetKey: 'phanTramBaoHiem', headerClass: 'bg-yellow-100 text-yellow-900', format: 'percent' }
    ];

    // K·∫øt h·ª£p c·ªôt c·ª©ng v√† c·ªôt ƒë·ªông t·ª´ c·∫•u h√¨nh Admin ($efficiencyConfig)
    $: columns = [
        ...FIXED_COLUMNS,
        ...($efficiencyConfig || []).map(conf => ({
            id: conf.id,
            label: conf.name,
            isRate: conf.type === 'percent',
            targetKey: conf.targetKey, // Key ch·ª©a m·ª•c ti√™u (n·∫øu c√≥) ƒë·ªÉ so s√°nh m√†u s·∫Øc
            headerClass: 'bg-indigo-50 text-indigo-900',
            format: conf.type === 'percent' ? 'percent' : 'revenue',
            isDynamic: true
        }))
    ];

    // --- SORTING ---
    function handleSort(key) {
        if (sortKey === key) {
            sortDirection = sortDirection === 'desc' ? 'asc' : 'desc';
        } else {
            sortKey = key;
            sortDirection = 'desc';
        }
    }

    $: sortedData = [...data].sort((a, b) => {
        let valA = a[sortKey] || 0;
        let valB = b[sortKey] || 0;
        return sortDirection === 'asc' ? valA - valB : valB - valA;
    });

    // --- PAGINATION ---
    $: totalPages = Math.ceil(sortedData.length / itemsPerPage);
    $: paginatedData = sortedData.slice((currentPage - 1) * itemsPerPage, currentPage * itemsPerPage);

    function goToPage(page) {
        if (page >= 1 && page <= totalPages) {
            currentPage = page;
        }
    }
    
    // --- HELPER: COLOR LOGIC ---
    function getCellColor(value, target, isRate) {
        if (!isRate || target === undefined || target === null) return 'text-gray-700';
        return value >= target ? 'text-green-600 font-bold' : 'text-red-500';
    }

    // --- HELPER: FORMAT ---
    function formatValue(value, type) {
        if (type === 'percent') return formatters.formatPercent(value);
        if (type === 'revenue') return formatters.formatRevenue(value);
        return value;
    }
</script>

<div class="bg-white border border-gray-200 rounded-xl shadow-sm overflow-hidden flex flex-col h-full">
    <div class="p-4 border-b border-gray-200 flex justify-between items-center bg-gray-50">
        <h3 class="font-bold text-gray-800 uppercase text-sm">B·∫£ng Hi·ªáu Qu·∫£ Chi Ti·∫øt</h3>
        <div class="flex gap-2 text-xs">
            <span class="px-2 py-1 bg-green-100 text-green-700 rounded">ƒê·∫°t ch·ªâ ti√™u</span>
            <span class="px-2 py-1 bg-red-100 text-red-700 rounded">Ch∆∞a ƒë·∫°t</span>
        </div>
    </div>

    <div class="overflow-x-auto flex-1 custom-scrollbar relative">
        {#if isLoading}
            <div class="absolute inset-0 bg-white/80 z-10 flex items-center justify-center">
                <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"></div>
            </div>
        {/if}

        <table class="min-w-full text-xs text-left border-collapse">
            <thead class="bg-gray-100 text-gray-600 font-bold sticky top-0 z-20 shadow-sm">
                <tr>
                    <th class="p-3 border-b border-r border-gray-200 min-w-[50px] text-center sticky left-0 bg-gray-100 z-30">#</th>
                    <th 
                        class="p-3 border-b border-r border-gray-200 min-w-[180px] cursor-pointer hover:bg-gray-200 sticky left-[50px] bg-gray-100 z-30 transition-colors"
                        on:click={() => handleSort('hoTen')}
                    >
                        <div class="flex items-center justify-between">
                            NH√ÇN VI√äN
                            {#if sortKey === 'hoTen'}
                                <span>{sortDirection === 'asc' ? '‚ñ≤' : '‚ñº'}</span>
                            {/if}
                        </div>
                    </th>
                    <th 
                        class="p-3 border-b border-r border-gray-200 min-w-[120px] cursor-pointer hover:bg-gray-200 text-right"
                        on:click={() => handleSort('doanhThu')}
                    >
                         <div class="flex items-center justify-end gap-1">
                            T·ªîNG DT
                            {#if sortKey === 'doanhThu'}
                                <span>{sortDirection === 'asc' ? '‚ñ≤' : '‚ñº'}</span>
                            {/if}
                        </div>
                    </th>
                    
                    {#each columns as col}
                        <th 
                            class="p-3 border-b border-r border-gray-200 min-w-[100px] cursor-pointer hover:brightness-95 transition-colors text-right whitespace-nowrap {col.headerClass}"
                            on:click={() => handleSort(col.id)}
                            title={col.label}
                        >
                            <div class="flex items-center justify-end gap-1">
                                {col.label}
                                {#if sortKey === col.id}
                                    <span>{sortDirection === 'asc' ? '‚ñ≤' : '‚ñº'}</span>
                                {/if}
                            </div>
                        </th>
                    {/each}
                </tr>
            </thead>
            
            <tbody class="divide-y divide-gray-100">
                {#each paginatedData as row, index (row.maNV)}
                    <tr class="hover:bg-blue-50 transition-colors group">
                        <td class="p-3 border-r border-gray-200 text-center text-gray-500 sticky left-0 bg-white group-hover:bg-blue-50 z-10">
                            {(currentPage - 1) * itemsPerPage + index + 1}
                        </td>
                        <td class="p-3 border-r border-gray-200 font-medium text-gray-800 sticky left-[50px] bg-white group-hover:bg-blue-50 z-10 shadow-[2px_0_5px_-2px_rgba(0,0,0,0.05)]">
                            <div class="flex flex-col">
                                <span class="truncate max-w-[160px]" title={row.hoTen}>{row.hoTen}</span>
                                <span class="text-[10px] text-gray-400 font-mono">{row.maNV}</span>
                            </div>
                        </td>
                        <td class="p-3 border-r border-gray-200 text-right font-bold text-gray-800">
                            {formatters.formatRevenue(row.doanhThu)}
                        </td>

                        {#each columns as col}
                            {@const val = row[col.id]}
                            {@const target = col.isRate && col.targetKey ? row.targets?.[col.targetKey] : undefined}
                            <td class="p-3 border-r border-gray-200 text-right {getCellColor(val, target, col.isRate)}">
                                {formatValue(val, col.format)}
                            </td>
                        {/each}
                    </tr>
                {:else}
                    <tr>
                        <td colspan={columns.length + 3} class="p-8 text-center text-gray-400 italic">
                            Kh√¥ng c√≥ d·ªØ li·ªáu hi·ªÉn th·ªã.
                        </td>
                    </tr>
                {/each}
            </tbody>
        </table>
    </div>

    {#if totalPages > 1}
    <div class="p-3 border-t border-gray-200 flex justify-between items-center bg-gray-50">
        <span class="text-xs text-gray-500">
            Hi·ªÉn th·ªã {(currentPage - 1) * itemsPerPage + 1}-{Math.min(currentPage * itemsPerPage, sortedData.length)} / {sortedData.length}
        </span>
        <div class="flex gap-1">
            <button 
                class="px-3 py-1 border rounded bg-white hover:bg-gray-100 disabled:opacity-50 text-xs font-medium"
                disabled={currentPage === 1}
                on:click={() => goToPage(currentPage - 1)}
            >
                Tr∆∞·ªõc
            </button>
            {#each Array(totalPages) as _, i}
                {#if i + 1 === currentPage || i + 1 === 1 || i + 1 === totalPages || (i + 1 >= currentPage - 1 && i + 1 <= currentPage + 1)}
                    <button 
                        class="px-3 py-1 border rounded text-xs font-medium {currentPage === i + 1 ? 'bg-blue-600 text-white border-blue-600' : 'bg-white hover:bg-gray-100'}"
                        on:click={() => goToPage(i + 1)}
                    >
                        {i + 1}
                    </button>
                {:else if i + 1 === currentPage - 2 || i + 1 === currentPage + 2}
                    <span class="px-2 py-1 text-gray-400">...</span>
                {/if}
            {/each}
            <button 
                class="px-3 py-1 border rounded bg-white hover:bg-gray-100 disabled:opacity-50 text-xs font-medium"
                disabled={currentPage === totalPages}
                on:click={() => goToPage(currentPage + 1)}
            >
                Sau
            </button>
        </div>
    </div>
    {/if}
</div>

<style>
    .custom-scrollbar::-webkit-scrollbar { height: 8px; width: 8px; }
    .custom-scrollbar::-webkit-scrollbar-track { background: #f1f1f1; }
    .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
    .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
</style>
<<< FILE_END: src/components/health-staff/EfficiencyTable.svelte

>>> FILE_START: src/components/health-staff/EmployeeDetailModal.svelte
<script>
    import { createEventDispatcher } from 'svelte';
    // ƒê·∫£m b·∫£o ƒë∆∞·ªùng d·∫´n import ƒë√∫ng c·∫•p
    import { ycxData } from '../../stores.js';

    // Props nh·∫≠n v√†o t·ª´ cha
    export let isOpen = false;
    export let employeeCode = '';
    export let employeeName = '';
    export let employeeDept = '';
    export let rawData = [];

    const dispatch = createEventDispatcher();
    
    // Bi·∫øn n·ªôi b·ªô
    let history = [];
    let summary = {
        totalErrors: 0,
        totalDeducted: 0,
        totalBonus: 0,
        finalScore: 100 
    };

    let displayInfo = {
        name: '',
        dept: ''
    };

    // Reactive: Ch·∫°y khi m·ªü modal
    $: if (isOpen && employeeCode) {
        debugGenesis(); // G·ªçi h√†m debug t√°ch bi·ªát cho g·ªçn
        
        const cleanCode = String(employeeCode).trim();
        let found = false;

        // 1. LOGIC TRA C·ª®U
        if ($ycxData && $ycxData.length) {
             const emp = $ycxData.find(e => {
                // Check k·ªπ c·∫£ String/Number
                const codeInDb = String(e.ma_nv || e.maNV || '').trim();
                const codeInCreator = e.nguoiTao ? String(e.nguoiTao) : '';
                return codeInDb === cleanCode || codeInCreator.includes(cleanCode);
             });
             
             if (emp) {
                 const fullName = emp.ten_nv || emp.hoTen || employeeName;
                 const dept = emp.ma_kho || emp.boPhan || emp.vi_tri || employeeDept;
                 
                 displayInfo.name = fullName;
                 displayInfo.dept = dept;
                 found = true;
                 console.log('[GENESIS] -> T√¨m th·∫•y trong DB:', { fullName, dept });
             } 
        } 
        
        if (!found) {
             displayInfo.name = employeeName || '';
             displayInfo.dept = employeeDept || '';
             console.log('[GENESIS] -> Kh√¥ng t√¨m th·∫•y, d√πng Fallback:', displayInfo);
        }

        // 2. LOGIC L√ÄM S·∫†CH (C·∫£i ti·∫øn)
        if (displayInfo.name && cleanCode) {
             let rawName = displayInfo.name;
             
             // Log tr∆∞·ªõc khi clean
             console.log(`[GENESIS] -> Tr∆∞·ªõc khi Clean: "${rawName}" (Code: "${cleanCode}")`);

             // Thay th·∫ø Code b·∫±ng r·ªóng
             if (rawName.includes(cleanCode)) {
                 rawName = rawName.replace(cleanCode, '');
             }
             
             // X√≥a d·∫•u g·∫°ch ngang ·ªü cu·ªëi chu·ªói (l·∫∑p l·∫°i nhi·ªÅu l·∫ßn ƒë·ªÉ ch·∫Øc ƒÉn)
             // VD: "T√™n - - " -> "T√™n"
             rawName = rawName.replace(/[-‚Äì‚Äî\s]+$/, '');

             displayInfo.name = rawName.trim();
             console.log(`[GENESIS] -> Sau khi Clean: "${displayInfo.name}"`);
        }
        
        if (displayInfo.dept === 'Nh√¢n vi√™n kh√¥ng t√¨m th·∫•y') {
            displayInfo.dept = '';
        }

        if (rawData.length > 0) {
            analyzeEmployeeData();
        } else {
            history = [];
            summary = { totalErrors: 0, totalDeducted: 0, totalBonus: 0, finalScore: 100 };
        }
    }
    
    // H√†m Debug ri√™ng ƒë·ªÉ in log
    function debugGenesis() {
        console.log("=== üîç DEBUG MODAL GENESIS ===");
        console.log("1. Props ƒë·∫ßu v√†o:", { employeeCode, employeeName, employeeDept });
        console.log("2. Store ycxData:", { 
            exists: !!$ycxData, 
            length: $ycxData ? $ycxData.length : 0,
            sample: $ycxData && $ycxData.length > 0 ? $ycxData[0] : 'Empty'
        });
    }

    function analyzeEmployeeData() {
        const records = rawData.filter(item => item.maNV === employeeCode);
        history = records.sort((a, b) => {
            const dateA = new Date(a.ngayViPham.split('/').reverse().join('-'));
            const dateB = new Date(b.ngayViPham.split('/').reverse().join('-'));
            return dateB - dateA;
        });
        
        let errors = 0;
        let deducted = 0;
        let bonus = 0;

        history.forEach(item => {
            const point = parseFloat(item.diemTru) || 0;
            if (item.loaiViPham === 'ƒêi·ªÉm c·ªông' || (item.ghiChu && item.ghiChu.includes('ƒêi·ªÉm c·ªông'))) {
                 bonus += Math.abs(point);
            } else {
                 errors++;
                 deducted += Math.abs(point);
            }
        });
        summary = {
            totalErrors: errors,
            totalDeducted: deducted,
            totalBonus: bonus,
            finalScore: 100 - deducted + bonus 
        };
    }

    function close() {
        dispatch('close');
    }
</script>

{#if isOpen}
<div class="fixed top-0 left-0 z-[9999] bg-red-600 text-white p-5 text-2xl font-bold">
        CODE M·ªöI ƒê√É CH·∫†Y!
    </div>
    <div class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4" on:click={close}>
        <div class="bg-white rounded-lg shadow-xl w-full max-w-4xl max-h-[90vh] flex flex-col overflow-hidden" on:click|stopPropagation>
            
            <div class="bg-blue-600 text-white p-4 flex justify-between items-center">
                <div>
                    <h3 class="text-xl font-bold uppercase">{displayInfo.name} - {employeeCode}</h3>
                    {#if displayInfo.dept}
                        <p class="text-sm opacity-90">{displayInfo.dept}</p>
                    {/if}
                </div>
                <button on:click={close} class="text-white hover:text-gray-200">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>

            <div class="p-4 bg-gray-50 border-b flex flex-wrap gap-4 justify-around text-center">
                <div class="bg-white p-3 rounded shadow-sm border border-gray-200 min-w-[150px]">
                    <span class="block text-gray-500 text-xs uppercase">S·ªë l·ªói vi ph·∫°m</span>
                    <span class="block text-2xl font-bold text-red-500">{summary.totalErrors}</span>
                </div>
                <div class="bg-white p-3 rounded shadow-sm border border-gray-200 min-w-[150px]">
                    <span class="block text-gray-500 text-xs uppercase">T·ªïng ƒëi·ªÉm tr·ª´</span>
                    <span class="block text-2xl font-bold text-red-600">-{summary.totalDeducted}</span>
                </div>
                <div class="bg-white p-3 rounded shadow-sm border border-gray-200 min-w-[150px]">
                    <span class="block text-gray-500 text-xs uppercase">T·ªïng ƒëi·ªÉm c·ªông</span>
                    <span class="block text-2xl font-bold text-green-600">+{summary.totalBonus}</span>
                </div>
                 </div>

            <div class="flex-1 overflow-y-auto p-4">
                {#if history.length === 0}
                    <div class="text-center text-gray-500 py-10">Nh√¢n vi√™n n√†y ch∆∞a c√≥ ghi nh·∫≠n thi ƒëua n√†o.</div>
                {:else}
                    <table class="min-w-full text-sm border-collapse border border-gray-200">
                        <thead class="bg-gray-100 sticky top-0 shadow-sm">
                            <tr>
                                <th class="border p-2 text-left">Ng√†y</th>
                                <th class="border p-2 text-left">Lo·∫°i/Vi ph·∫°m</th>
                                <th class="border p-2 text-left">N·ªôi dung chi ti·∫øt</th>
                                <th class="border p-2 text-center text-nowrap">ƒêi·ªÉm</th>
                            </tr>
                        </thead>
                        <tbody>
                            {#each history as item}
                                <tr class="hover:bg-gray-50">
                                    <td class="border p-2 whitespace-nowrap">{item.ngayViPham}</td>
                                    <td class="border p-2 font-medium">
                                        {#if item.loaiViPham === 'ƒêi·ªÉm c·ªông'}
                                            <span class="text-green-600">ƒêi·ªÉm c·ªông</span>
                                        {:else}
                                            <span class="text-red-600">{item.loaiViPham || 'Vi ph·∫°m'}</span>
                                        {/if}
                                    </td>
                                    <td class="border p-2">{item.noiDung || item.tenLoi}</td>
                                    <td class="border p-2 text-center font-bold" 
                                        class:text-red-600={parseFloat(item.diemTru) < 0 || (item.loaiViPham !== 'ƒêi·ªÉm c·ªông')}
                                        class:text-green-600={item.loaiViPham === 'ƒêi·ªÉm c·ªông'}
                                    >
                                        {item.diemTru}
                                    </td>
                                </tr>
                            {/each}
                        </tbody>
                    </table>
                {/if}
            </div>

            <div class="p-4 border-t bg-gray-50 text-right">
                <button on:click={close} class="px-4 py-2 bg-gray-200 hover:bg-gray-300 rounded text-gray-700 font-medium">
                    ƒê√≥ng
                </button>
            </div>
        </div>
    </div>
{/if}
<<< FILE_END: src/components/health-staff/EmployeeDetailModal.svelte

>>> FILE_START: src/components/health-staff/IncomeTable.svelte
<script>
  import { formatters } from '../../utils/formatters.js';
  export let reportData = [];

  let sortKey = 'tongThuNhap';
  let sortDirection = 'desc';
  // C·∫•u h√¨nh c·ªôt
  const columns = [
      { key: 'hoTen', label: 'Nh√¢n vi√™n', align: 'left' },
      { key: 'gioCong', label: 'Gi·ªù c√¥ng', align: 'right' },
      { key: 'tongThuNhap', label: 'T·ªïng Thu Nh·∫≠p', align: 'right' },
      { key: 'thuNhapDuKien', label: 'Thu nh·∫≠p DK', align: 'right' },
      { key: 'thuNhapThangTruoc', label: 'Th√°ng tr∆∞·ªõc', align: 'right' },
      { key: 'chenhLechThuNhap', label: '+/- Th√°ng tr∆∞·ªõc', align: 'right' }
  ];
  function handleSort(key) {
      if (sortKey === key) {
          sortDirection = sortDirection === 'desc' ?
'asc' : 'desc';
      } else {
          sortKey = key;
sortDirection = 'desc';
      }
  }

  // Logic s·∫Øp x·∫øp
  $: sortedData = [...reportData].sort((a, b) => {
      let valA = a[sortKey];
      let valB = b[sortKey];

      if (sortKey === 'hoTen') {
          return sortDirection === 'asc' ? String(valA).localeCompare(String(valB)) : String(valB).localeCompare(String(valA));
      }
      // X·ª≠ l√Ω s·ªë
      return sortDirection === 'asc' ? (Number(valA)||0) - (Number(valB)||0) : (Number(valB)||0) - (Number(valA)||0);
  });
  // T√≠nh t·ªïng
  $: totals = reportData.reduce((acc, item) => {
      acc.gioCong += item.gioCong || 0;
      acc.tongThuNhap += item.tongThuNhap || 0;
      acc.thuNhapDuKien += item.thuNhapDuKien || 0;
      acc.thuNhapThangTruoc += item.thuNhapThangTruoc || 0;
      acc.chenhLechThuNhap += item.chenhLechThuNhap || 0;
      return acc;
  }, { gioCong: 0, tongThuNhap: 0, thuNhapDuKien: 0, thuNhapThangTruoc: 0, chenhLechThuNhap: 0 });
  // T√≠nh trung b√¨nh Thu nh·∫≠p d·ª± ki·∫øn ƒë·ªÉ so s√°nh
  $: avgIncome = reportData.length > 0 ?
totals.thuNhapDuKien / reportData.length : 0;

  // H√†m style cho √¥ d·ªØ li·ªáu
  function getCellClass(item, colKey) {
      if (colKey === 'tongThuNhap') return 'font-bold text-blue-700';
      if (colKey === 'thuNhapDuKien') {
          // D∆∞·ªõi trung b√¨nh th√¨ m√†u ƒë·ªè, tr√™n th√¨ xanh
          return item.thuNhapDuKien < avgIncome 
              ?
'font-bold text-red-600 bg-red-50' 
              : 'font-bold text-green-700 bg-green-50';
      }

      if (colKey === 'chenhLechThuNhap') {
          return item.chenhLechThuNhap >= 0 
              ?
'font-bold text-green-600' 
              : 'font-bold text-red-600';
      }

      return 'text-gray-700';
  }
</script>

<div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden mt-4 animate-fade-in" data-capture-group="income-table">
    <div class="px-6 py-4 border-b border-gray-200 flex justify-between items-center bg-orange-50">
        <div class="flex items-center gap-2">
            <div class="p-2 bg-orange-100 rounded-lg text-orange-600">
                <i data-feather="briefcase" class="w-5 h-5"></i>
            </div>
            <div>
  
              <h3 class="font-bold text-gray-800 text-lg uppercase">B·∫£ng L∆∞∆°ng & Thu Nh·∫≠p</h3>
                <p class="text-xs text-gray-500">
                    Thu nh·∫≠p DK TB: <span class="font-bold text-orange-600">{formatters.formatRevenue(avgIncome)}</span>
                </p>
            </div>
      
  </div>
        <span class="text-xs font-bold bg-orange-100 text-orange-700 px-3 py-1 rounded-full shadow-sm">ƒê∆°n v·ªã: VNƒê</span>
    </div>

    <div class="overflow-x-auto">
        <table class="min-w-full text-sm text-left border-collapse">
            <thead class="bg-gray-100 text-xs uppercase text-gray-500 font-bold sticky top-0 z-10 shadow-sm">
                <tr>
                    {#each columns 
as col}
                        <th 
                            class="px-4 py-3 cursor-pointer hover:bg-gray-200 transition select-none whitespace-nowrap {col.align === 'right' ?
'text-right' : 'text-left'}"
                            on:click={() => handleSort(col.key)}
                        >
                            <div class="flex items-center gap-1 {col.align === 'right' ?
'justify-end' : ''}">
                                {col.label}
                                {#if sortKey === col.key}
                               
     <span class="ml-1 text-orange-600">{sortDirection === 'asc' ? '‚ñ≤' : '‚ñº'}</span>
                                {/if}
                            </div>
                        </th>
   
                 {/each}
                </tr>
            </thead>
            <tbody class="divide-y divide-gray-100">
                {#if sortedData.length === 0}
                    <tr><td colspan={columns.length} 
class="p-12 text-center text-gray-400 italic bg-gray-50">Ch∆∞a c√≥ d·ªØ li·ªáu. Vui l√≤ng t·∫£i file Th∆∞·ªüng/Gi·ªù c√¥ng.</td></tr>
                {:else}
                    {#each sortedData as item, index (item.maNV)}
                        <tr class="hover:bg-orange-50 transition-colors duration-150 group {index % 2 === 0 ?
'bg-white' : 'bg-slate-50/50'}">
                            <td class="px-4 py-3 font-semibold text-gray-700 whitespace-nowrap border-r border-gray-100 group-hover:text-orange-800">
                                {formatters.getShortEmployeeName(item.hoTen, item.maNV)}
                            </td>
 
                           <td class="px-4 py-3 text-right border-r border-gray-100 font-medium">
                                {formatters.formatNumberOrDash(item.gioCong)}
                            </td>
       
                     <td class="px-4 py-3 text-right {getCellClass(item, 'tongThuNhap')}">
                                {formatters.formatRevenue(item.tongThuNhap)}
                            </td>
              
              <td class="px-4 py-3 text-right {getCellClass(item, 'thuNhapDuKien')}">
                                {formatters.formatRevenue(item.thuNhapDuKien)}
                            </td>
                     
       <td class="px-4 py-3 text-right text-gray-600 font-medium">
                                {formatters.formatRevenue(item.thuNhapThangTruoc)}
                            </td>
                            
<td class="px-4 py-3 text-right border-l border-gray-100 {getCellClass(item, 'chenhLechThuNhap')}">
                                {formatters.formatRevenue(item.chenhLechThuNhap)}
                            </td>
                        </tr>
         
           {/each}
                {/if}
            </tbody>
            <tfoot class="bg-gray-100 font-bold text-gray-900 border-t-2 border-gray-300 text-xs uppercase">
                <tr>
                    <td class="px-4 py-3">T·ªîNG C·ªòNG</td>
   
                 <td class="px-4 py-3 text-right">{formatters.formatNumberOrDash(totals.gioCong)}</td>
                    <td class="px-4 py-3 text-right text-blue-700">{formatters.formatRevenue(totals.tongThuNhap)}</td>
                    <td class="px-4 py-3 text-right text-green-700">{formatters.formatRevenue(totals.thuNhapDuKien)}</td>
                    <td class="px-4 py-3 text-right">{formatters.formatRevenue(totals.thuNhapThangTruoc)}</td>
         
           <td class="px-4 py-3 text-right">{formatters.formatRevenue(totals.chenhLechThuNhap)}</td>
                </tr>
            </tfoot>
        </table>
    </div>
</div>

<style>
    .animate-fade-in { animation: fadeIn 0.4s ease-out;
}
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0);
} }
</style>
<<< FILE_END: src/components/health-staff/IncomeTable.svelte

>>> FILE_START: src/components/health-staff/ProgramGoalTables.svelte
<script>
  import { createEventDispatcher } from 'svelte';
  
  export let programTables = [];
  const dispatch = createEventDispatcher();
  let localTables = [];

  // Logic ƒë·ªìng b·ªô: Store -> Bi·∫øn c·ª•c b·ªô
  $: if (programTables) {
      const isDiff = JSON.stringify(programTables.map(t => t.id)) !== JSON.stringify(localTables.map(t => t.id));
      if (localTables.length === 0 || isDiff) {
          localTables = JSON.parse(JSON.stringify(programTables));
      }
  }

  function syncToStore() {
      dispatch('update', localTables);
  }
</script>

<div class="w-full space-y-6">
  {#if localTables && localTables.length > 0}
    {#each localTables as table, index (index)}
      <div class="bg-white border border-gray-200 rounded-lg shadow-sm overflow-hidden">
        
        <div class="bg-gray-50 px-4 py-3 border-b border-gray-200 flex items-center justify-between gap-4">
          
          <h3 class="font-bold text-blue-700 text-sm uppercase tracking-wide border-l-4 border-blue-600 pl-2 truncate">
            {table.name || table.programName || `Ch∆∞∆°ng tr√¨nh ${index + 1}`}
          </h3>

          <div class="flex items-center gap-2 flex-shrink-0">
             <label class="text-xs font-bold text-gray-600 whitespace-nowrap cursor-pointer">
                M·ª•c ti√™u:
             </label>
             
             <div class="relative"> 
                <input 
                  type="number" 
                  bind:value={table.target} 
                  on:input={syncToStore}
                  class="block w-32 rounded border border-gray-300 bg-white text-right font-bold text-red-600 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-sm py-1 px-2 shadow-sm"
                  placeholder="0"
                />
                <span class="absolute right-0 top-0 text-[10px] text-gray-400 pointer-events-none mr-1 mt-1.5">ƒë</span>
             </div>
          </div>

        </div>

        <div class="p-4 grid grid-cols-1 md:grid-cols-2 gap-4">
          <div class="space-y-1">
            <label class="block text-xs font-medium text-gray-500 uppercase">Th·ª±c ƒë·∫°t (Actual)</label>
            <div class="relative">
                <input 
                    type="number" 
                    bind:value={table.actual} 
                    on:input={syncToStore}
                    class="block w-full rounded-md border-gray-300 shadow-sm focus:border-green-500 focus:ring-green-500 sm:text-sm py-2 px-3 border font-bold text-gray-700"
                />
                <span class="absolute right-0 top-0 text-[10px] text-gray-400 pointer-events-none mr-2 mt-2.5">ƒë</span>
            </div>
          </div>

          <div class="space-y-1">
            <label class="block text-xs font-medium text-gray-500 uppercase">Ghi ch√∫</label>
            <textarea 
              bind:value={table.note} 
              on:input={syncToStore}
              rows="1"
              class="block w-full rounded-md border-gray-300 shadow-sm sm:text-sm py-2 px-3 border resize-none"
            ></textarea>
          </div>
        </div>
        
        <div class="bg-gray-50 px-4 py-2 border-t border-gray-200 flex justify-end items-center gap-3">
             <span class="text-xs text-gray-500">Ti·∫øn ƒë·ªô:</span>
             <div class="w-24 h-2 bg-gray-200 rounded-full overflow-hidden">
                <div class="h-full {table.actual >= table.target ? 'bg-green-500' : 'bg-orange-400'}" style="width: {Math.min((table.actual / (table.target || 1)) * 100, 100)}%"></div>
             </div>
             <span class="font-bold text-base {table.actual >= table.target ? 'text-green-600' : 'text-orange-600'}">
                {table.target > 0 ? ((table.actual / table.target) * 100).toFixed(1) : 0}%
             </span>
        </div>

      </div>
    {/each}
  {/if}
</div>
<<< FILE_END: src/components/health-staff/ProgramGoalTables.svelte

>>> FILE_START: src/components/health-staff/RevenueTable.svelte
<script>
  import { createEventDispatcher, onMount } from 'svelte';
  import { formatters } from '../../utils/formatters.js';
  import { kpiStore } from '../../stores.js';
  import { getCompletionColor } from '../../utils/kpi.utils.js';
  
  export let reportData = [];

  // [LOGGER] Theo d√µi d·ªØ li·ªáu ƒë·∫ßu v√†o
  $: {
      console.log(`[RevenueTable ${new Date().toLocaleTimeString()}] Store Value:`, $kpiStore);
      console.log(`[RevenueTable] Report Data Length:`, reportData.length);
  }

  const dispatch = createEventDispatcher();
  let sortKey = 'doanhThu';
  let sortDirection = 'desc';

  // [C·∫§U H√åNH] C·∫≠p nh·∫≠t c·ªôt cu·ªëi c√πng th√†nh DTQƒê Ch∆∞a Xu·∫•t
  const columns = [
      { key: 'hoTen', label: 'Nh√¢n vi√™n', align: 'left', headerClass: 'bg-gray-100 text-gray-700' },
      // [STYLE FIX] ƒê·ªïi border-blue-200 ƒë·ªÉ kh·ªõp t√¥ng m√†u header xanh
      { key: 'doanhThu', label: 'DT Th·ª±c', align: 'right', headerClass: 'bg-blue-100 text-blue-800 border-l border-blue-200' },
      { key: 'doanhThuQuyDoi', label: 'DT Quy ƒê·ªïi', align: 'right', headerClass: 'bg-blue-100 text-blue-800' },
      { key: 'hieuQuaQuyDoi', label: '% Qƒê', align: 'right', headerClass: 'bg-blue-100 text-blue-800' },
      // [STYLE FIX] ƒê·ªïi border-green-200
      { key: 'doanhThuTraGop', label: 'DT Tr·∫£ ch·∫≠m', align: 'right', headerClass: 'bg-green-100 text-green-800 border-l border-green-200' },
      { key: 'tyLeTraCham', label: '% Tr·∫£ ch·∫≠m', align: 'right', headerClass: 'bg-green-100 text-green-800' },
      // [FIX] Hi·ªÉn th·ªã DTQƒê Ch∆∞a Xu·∫•t thay v√¨ DT Th·ª±c
      { key: 'doanhThuQuyDoiChuaXuat', label: 'DTQƒê Ch∆∞a Xu·∫•t', align: 'right', headerClass: 'bg-yellow-50 text-yellow-800 border-l border-yellow-200' }
  ];

  function handleSort(key) {
      if (sortKey === key) sortDirection = sortDirection === 'desc' ? 'asc' : 'desc';
      else { sortKey = key; sortDirection = 'desc'; }
  }

  $: sortedData = [...reportData].sort((a, b) => {
      let valA = a[sortKey];
      let valB = b[sortKey];
      if (sortKey === 'hoTen') return sortDirection === 'asc' ? String(valA).localeCompare(String(valB)) : String(valB).localeCompare(String(valA));
      return sortDirection === 'asc' ? (Number(valA)||0) - (Number(valB)||0) : (Number(valB)||0) - (Number(valA)||0);
  });

  // [FIX] C·∫≠p nh·∫≠t logic t√≠nh t·ªïng cho c·ªôt m·ªõi
  $: totals = reportData.reduce((acc, item) => {
      acc.doanhThu += item.doanhThu || 0;
      acc.doanhThuQuyDoi += item.doanhThuQuyDoi || 0;
      acc.doanhThuTraGop += item.doanhThuTraGop || 0;
      acc.doanhThuQuyDoiChuaXuat += item.doanhThuQuyDoiChuaXuat || 0;
      return acc;
  }, { doanhThu: 0, doanhThuQuyDoi: 0, doanhThuTraGop: 0, doanhThuQuyDoiChuaXuat: 0 });

  $: totalPctQD = totals.doanhThu > 0 ? (totals.doanhThuQuyDoi / totals.doanhThu) - 1 : 0;
  $: totalPctTC = totals.doanhThu > 0 ? totals.doanhThuTraGop / totals.doanhThu : 0;

  function getCellClass(item, colKey) {
      // [FIX] Th√™m key m·ªõi v√†o danh s√°ch in ƒë·∫≠m
      const isBoldCol = ['doanhThu', 'doanhThuQuyDoi', 'doanhThuTraGop', 'doanhThuQuyDoiChuaXuat', 'hieuQuaQuyDoi', 'tyLeTraCham'].includes(colKey);
      let baseClass = isBoldCol ? 'font-bold text-gray-800' : 'text-gray-600';

      const userTarget = $kpiStore.targets[item.maNV];
      const targetSettings = userTarget || $kpiStore.globalSettings;

      if (!targetSettings || Object.keys(targetSettings).length === 0) {
          return baseClass;
      }

      if (colKey === 'hieuQuaQuyDoi') {
          const actual = item.hieuQuaQuyDoi;
          const target = (targetSettings.phanTramQD || 0) / 100; 
          const colorClass = getCompletionColor(actual, target);
          return colorClass ? `${colorClass} font-bold` : baseClass;
      }
      
      if (colKey === 'tyLeTraCham') {
          const actual = item.tyLeTraCham;
          const target = (targetSettings.phanTramTC || 0) / 100;
          const colorClass = getCompletionColor(actual, target);
          return colorClass ? `${colorClass} font-bold` : baseClass;
      }

      return baseClass;
  }

  function handleRowClick(employeeId) {
      dispatch('viewDetail', { employeeId });
  }
</script>

<div class="bg-white rounded-xl shadow-md border border-gray-200 overflow-hidden mt-6 animate-fade-in" data-capture-group="revenue-table">
    <div class="px-6 py-4 border-b border-gray-200 flex justify-between items-center bg-gray-50">
        <div class="flex items-center gap-2">
            <div class="p-2 bg-blue-100 rounded-lg text-blue-600"><i data-feather="dollar-sign" class="w-5 h-5"></i></div>
            <div>
                <h3 class="font-bold text-gray-800 text-lg uppercase">Chi ti·∫øt Doanh Thu L≈©y K·∫ø</h3>
                <p class="text-xs text-gray-500">D·ªØ li·ªáu ƒë∆∞·ª£c c·∫≠p nh·∫≠t t·ª´ file YCX m·ªõi nh·∫•t</p>
            </div>
        </div>
        <span class="text-xs font-bold bg-blue-100 text-blue-700 px-3 py-1 rounded-full shadow-sm">ƒê∆°n v·ªã: Tri·ªáu</span>
    </div>

    <div class="overflow-x-auto">
        <table class="min-w-full text-sm text-left border-collapse">
            <thead class="uppercase text-xs font-bold sticky top-0 z-10 shadow-sm">
                <tr>
                    {#each columns as col}
                        <th class="px-4 py-3 cursor-pointer transition select-none whitespace-nowrap {col.headerClass} {col.align === 'right' ? 'text-right' : 'text-left'}" on:click={() => handleSort(col.key)}>
                            <div class="flex items-center gap-1 {col.align === 'right' ? 'justify-end' : ''}">
                                {col.label}
                                {#if sortKey === col.key}<span class="ml-1 text-blue-600">{sortDirection === 'asc' ? '‚ñ≤' : '‚ñº'}</span>{/if}
                            </div>
                        </th>
                    {/each}
                </tr>
            </thead>
            <tbody class="divide-y divide-gray-200">
                {#if sortedData.length === 0}
                    <tr><td colspan={columns.length} class="p-12 text-center text-gray-400 italic bg-gray-50">Ch∆∞a c√≥ d·ªØ li·ªáu hi·ªÉn th·ªã.</td></tr>
                {:else}
                    {#each sortedData as item, index (item.maNV)}
                        <tr class="hover:bg-blue-50 transition-colors duration-150 group cursor-pointer {index % 2 === 0 ? 'bg-white' : 'bg-slate-50/50'}" on:click={() => handleRowClick(item.maNV)}>
                            <td class="px-4 py-3 font-semibold text-blue-700 whitespace-nowrap border-r border-gray-200 group-hover:text-blue-800 group-hover:underline">
                                {formatters.getShortEmployeeName(item.hoTen, item.maNV)}
                            </td>
                            <td class="px-4 py-3 text-right border-r border-gray-200 {getCellClass(item, 'doanhThu')}">{formatters.formatRevenue(item.doanhThu)}</td>
                            <td class="px-4 py-3 text-right {getCellClass(item, 'doanhThuQuyDoi')}">{formatters.formatRevenue(item.doanhThuQuyDoi)}</td>
                            <td class="px-4 py-3 text-right {getCellClass(item, 'hieuQuaQuyDoi')}">{formatters.formatPercentage(item.hieuQuaQuyDoi)}</td>
                            <td class="px-4 py-3 text-right border-l border-gray-200 {getCellClass(item, 'doanhThuTraGop')}">{formatters.formatRevenue(item.doanhThuTraGop)}</td>
                            <td class="px-4 py-3 text-right {getCellClass(item, 'tyLeTraCham')}">{formatters.formatPercentage(item.tyLeTraCham)}</td>
                            
                            <td class="px-4 py-3 text-right border-l border-gray-200 {getCellClass(item, 'doanhThuQuyDoiChuaXuat')}">{formatters.formatRevenue(item.doanhThuQuyDoiChuaXuat)}</td>
                        </tr>
                    {/each}
                {/if}
            </tbody>
            <tfoot class="bg-gray-100 font-bold text-gray-900 border-t-2 border-gray-300 text-xs uppercase">
                <tr>
                    <td class="px-4 py-3">T·ªîNG C·ªòNG</td>
                    <td class="px-4 py-3 text-right text-base">{formatters.formatRevenue(totals.doanhThu)}</td>
                    <td class="px-4 py-3 text-right text-base text-blue-700">{formatters.formatRevenue(totals.doanhThuQuyDoi)}</td>
                    <td class="px-4 py-3 text-right text-base text-blue-700">{formatters.formatPercentage(totalPctQD)}</td>
                    <td class="px-4 py-3 text-right text-base">{formatters.formatRevenue(totals.doanhThuTraGop)}</td>
                    <td class="px-4 py-3 text-right text-base">{formatters.formatPercentage(totalPctTC)}</td>
                    <td class="px-4 py-3 text-right text-base text-gray-600">{formatters.formatRevenue(totals.doanhThuQuyDoiChuaXuat)}</td>
                </tr>
            </tfoot>
        </table>
    </div>
</div>
<style>.animate-fade-in { animation: fadeIn 0.4s ease-out; } @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }</style>
<<< FILE_END: src/components/health-staff/RevenueTable.svelte

>>> FILE_START: src/components/health-staff/competition/CompetitionCard.svelte
<script>
  import { formatters } from '../../../utils/formatters.js';
  
  export let item; // D·ªØ li·ªáu c·ªßa 1 ch∆∞∆°ng tr√¨nh
  
  // T√≠nh to√°n logic hi·ªÉn th·ªã
  $: hoanThanhValue = item.hoanThanhValue || 0;
  $: isCompleted = hoanThanhValue >= 100;
  $: progressColor = isCompleted ? 'bg-blue-600' : 'bg-yellow-400';
  
  // T√≠nh m·ª•c ti√™u ng√†y (n·∫øu ch∆∞a ƒë·∫°t)
  $: targetRemaining = (item.target || 0) - (item.luyKe || 0);
  $: daysLeft = Math.max(30 - (new Date().getDate()), 1);
  $: dailyTarget = (item.target > 0 && targetRemaining > 0) ? (targetRemaining / daysLeft) : 0;
</script>

<div class="bg-white border border-gray-200 rounded-lg p-3 shadow-sm hover:shadow-md transition-all hover:-translate-y-0.5">
    <p class="font-semibold text-gray-800 mb-2 text-sm line-clamp-2 h-10" title={item.name}>
        {item.name}
    </p>
    
    <div class="w-full bg-gray-200 rounded-full h-3 overflow-hidden mb-2 relative">
        <div 
            class="h-full rounded-full transition-all duration-500 {progressColor}" 
            style="width: {Math.min(hoanThanhValue, 100)}%;"
        ></div>
        <span class="absolute inset-0 flex items-center justify-center text-[10px] font-bold text-gray-700 drop-shadow-md">
            {formatters.formatPercentage(hoanThanhValue / 100)}
        </span>
    </div>

    <div class="flex justify-between items-end text-xs text-gray-600">
        <div>
            <div class="flex flex-col">
                <span>L≈©y k·∫ø: <strong>{formatters.formatNumberOrDash(item.luyKe)}</strong></span>
                <span>Target: <strong>{formatters.formatNumberOrDash(item.target)}</strong></span>
            </div>
        </div>
        
        {#if isCompleted}
            <span class="font-bold text-green-600 bg-green-50 px-2 py-1 rounded">ƒê·∫°t</span>
        {:else}
            <div class="text-right">
                <span class="block text-gray-400">C·∫ßn/ng√†y:</span>
                <strong class="text-red-600">{formatters.formatNumberOrDash(dailyTarget)}</strong>
            </div>
        {/if}
    </div>
</div>
<<< FILE_END: src/components/health-staff/competition/CompetitionCard.svelte

>>> FILE_START: src/components/health-staff/competition/CompetitionDetailView.svelte
<script>
    import { createEventDispatcher, afterUpdate } from 'svelte';
    import { formatters } from '../../../utils/formatters.js';
    // [FIX GENESIS] Import ycxData ƒë·ªÉ tra c·ª©u th√¥ng tin chu·∫©n
    import { competitionNameMappings, ycxData } from '../../../stores.js';
    import { settingsService } from '../../../services/settings.service.js';

    export let employeeId;
    export let allReportData = []; 

    const dispatch = createEventDispatcher();

    // --- LOGIC T√çNH TO√ÅN ---
    let employee = null;
    // [FIX GENESIS] Bi·∫øn hi·ªÉn th·ªã ƒë√£ ƒë∆∞·ª£c l√†m s·∫°ch
    let displayInfo = {
        name: '',
        code: '',
        dept: ''
    };

    let stats = {
        dat: [],
        ganDat: [],
        canCoGang: [],
        summary: { total: 0, dat: 0, rate: 0, ganDat: 0, canCoGang: 0 }
    };

    // [FIX GENESIS] Th√™m $ycxData v√†o dependency
    $: {
        if (employeeId && allReportData.length > 0) {
            let rawEmp = allReportData.find(e => e.maNV === employeeId);

            if (rawEmp) {
                // Clone object ƒë·ªÉ x·ª≠ l√Ω hi·ªÉn th·ªã
                employee = { ...rawEmp };
                
                // --- LOGIC FIX T√äN & B·ªò PH·∫¨N ---
                const cleanCode = String(employeeId).trim();
                let realName = employee.hoTen || employee.name || '';
                let realDept = employee.boPhan || '';

                // 1. Tra c·ª©u ng∆∞·ª£c trong danh s√°ch nh√¢n vi√™n chu·∫©n (ycxData)
                if ($ycxData && $ycxData.length) {
                    const dbEmp = $ycxData.find(e => 
                        String(e.ma_nv || e.maNV || '').trim() === cleanCode ||
                        (e.nguoiTao && String(e.nguoiTao).includes(cleanCode))
                    );
                    if (dbEmp) {
                        realName = dbEmp.ten_nv || dbEmp.hoTen || realName;
                        // ∆Øu ti√™n l·∫•y b·ªô ph·∫≠n t·ª´ DB n·∫øu b√°o c√°o b·ªã thi·∫øu ho·∫∑c l·ªói
                        if (!realDept || realDept === 'Ch∆∞a ph√¢n lo·∫°i' || realDept === 'Nh√¢n vi√™n kh√¥ng t√¨m th·∫•y') {
                            realDept = dbEmp.ma_kho || dbEmp.boPhan || dbEmp.vi_tri || '';
                        }
                    }
                }

                // 2. L√†m s·∫°ch t√™n (Lo·∫°i b·ªè m√£ nh√¢n vi√™n th·ª´a trong t√™n)
                // VD: "Phan Mai Th·ªã √Åi Tr√¢m - 12277" -> X√≥a "12277"
                if (realName.includes(cleanCode)) {
                    realName = realName.replace(cleanCode, '');
                }
                // X√≥a d·∫•u g·∫°ch ngang/kho·∫£ng tr·∫Øng th·ª´a ·ªü cu·ªëi chu·ªói
                realName = realName.replace(/[-‚Äì‚Äî\s]+$/, '').trim();

                // C·∫≠p nh·∫≠t bi·∫øn hi·ªÉn th·ªã
                displayInfo = {
                    name: realName,
                    code: cleanCode,
                    dept: realDept
                };
                // -------------------------------

                // L·∫•y c·∫•u h√¨nh t√™n c·ªôt hi·ªÉn th·ªã
                let columnSettings = settingsService.loadPastedCompetitionViewSettings();
                if (!columnSettings || columnSettings.length === 0) {
                     columnSettings = settingsService.loadPastedCompetitionViewSettings(); 
                }
                
                const activeColumns = columnSettings
                    .filter(col => col.visible)
                    .map(col => ({
                        ...col,
                        label: $competitionNameMappings[col.tenGoc] || col.label || col.tenGoc
                    }));

                // T√≠nh Trung b√¨nh b·ªô ph·∫≠n
                const deptEmployees = allReportData.filter(e => e.boPhan === rawEmp.boPhan);
                const deptAvgs = {};
                
                activeColumns.forEach(col => {
                    let sum = 0;
                    let count = 0;
                    deptEmployees.forEach(e => {
                        const comp = e.competitions.find(c => c.tenGoc === col.tenGoc);
                        if (comp && comp.giaTri > 0) {
                            sum += comp.giaTri;
                            count++;
                        }
                    });
                    deptAvgs[col.tenGoc] = count > 0 ? sum / count : 0;
                });

                // Ph√¢n lo·∫°i ch·ªâ s·ªë
                let datList = [], ganDatList = [], canCoGangList = [];
                activeColumns.forEach(col => {
                    const compData = employee.competitions.find(c => c.tenGoc === col.tenGoc);
                    const val = compData ? compData.giaTri : 0;
                    const avg = deptAvgs[col.tenGoc] || 0;
                    
                    if (avg > 0 || val > 0) {
                        const item = {
                            name: col.label,
                            value: val,
                            avg: avg,
                            diff: val - avg,
                            percentOfAvg: avg > 0 ? (val / avg) * 100 : 0
                        };

                        if (val >= avg) {
                            datList.push(item);
                        } else if (item.percentOfAvg >= 70) {
                            ganDatList.push(item);
                        } else {
                            canCoGangList.push(item);
                        }
                    }
                });

                stats = {
                    dat: datList.sort((a,b) => b.percentOfAvg - a.percentOfAvg),
                    ganDat: ganDatList.sort((a,b) => b.percentOfAvg - a.percentOfAvg),
                    canCoGang: canCoGangList.sort((a,b) => a.percentOfAvg - b.percentOfAvg),
                    summary: {
                        total: datList.length + ganDatList.length + canCoGangList.length,
                        dat: datList.length,
                        ganDat: ganDatList.length,
                        canCoGang: canCoGangList.length,
                        rate: 0
                    }
                };
                stats.summary.rate = stats.summary.total > 0 
                    ? (stats.summary.dat / stats.summary.total) * 100 
                    : 0;
            }
        }
    }

    function goBack() {
        dispatch('back');
    }

    // [QUAN TR·ªåNG] K√≠ch ho·∫°t icon sau khi render
    afterUpdate(() => {
        if (typeof feather !== 'undefined') feather.replace();
    });
</script>

<div class="animate-fade-in pb-10 bg-gray-50 min-h-screen p-4 sm:p-6">
  
    <button on:click={goBack} class="mb-4 flex items-center gap-2 text-gray-500 hover:text-blue-600 transition-colors font-semibold">
        <i data-feather="arrow-left" class="w-5 h-5"></i> Quay l·∫°i b·∫£ng t·ªïng h·ª£p
    </button>

    {#if employee}
        <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-5 mb-6 flex items-center gap-5">
            <div class="w-16 h-16 rounded-full bg-gray-100 flex items-center justify-center text-gray-500 border border-gray-200 shadow-inner">
                <i data-feather="user" class="w-8 h-8"></i>
            </div>
            <div>
                <h2 class="text-2xl font-bold text-gray-800">{displayInfo.name} <span class="text-gray-400 font-medium text-lg">- {displayInfo.code}</span></h2>
                
                {#if displayInfo.dept}
                    <span class="inline-block mt-1 px-3 py-1 rounded-full bg-blue-50 text-blue-700 text-xs font-bold border border-blue-100">
                        {displayInfo.dept}
                    </span>
                {/if}
            </div>
        </div>

        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 mb-8">
            <div class="bg-white p-4 rounded-xl border border-gray-200 shadow-sm text-center">
                <p class="text-xs font-bold text-gray-500 uppercase mb-1">Ng√†nh h√†ng ƒê·∫°t</p>
                <p class="text-3xl font-extrabold text-gray-800">
                    <span class="text-blue-600">{stats.summary.dat}</span>
                    <span class="text-gray-300 text-xl">/ {stats.summary.total}</span>
                </p>
            </div>

            <div class="bg-white p-4 rounded-xl border border-gray-200 shadow-sm text-center">
                <p class="text-xs font-bold text-gray-500 uppercase mb-1">T·ª∑ l·ªá ƒë·∫°t (tr√™n nh√≥m c√≥ TB)</p>
                <p class="text-3xl font-extrabold text-red-500">
                    {formatters.formatNumber(stats.summary.rate, 0)}%
                </p>
            </div>

            <div class="bg-white p-4 rounded-xl border border-gray-200 shadow-sm text-center">
                <p class="text-xs font-bold text-gray-500 uppercase mb-1">G·∫ßn ƒê·∫°t (>=70%)</p>
                <p class="text-3xl font-extrabold text-yellow-500">{stats.summary.ganDat}</p>
            </div>

            <div class="bg-white p-4 rounded-xl border border-gray-200 shadow-sm text-center">
                <p class="text-xs font-bold text-gray-500 uppercase mb-1">C·∫ßn C·ªë G·∫Øng</p>
                <p class="text-3xl font-extrabold text-red-600">{stats.summary.canCoGang}</p>
            </div>
        </div>

        <div class="space-y-8">
            
            <div class="bg-blue-50/50 rounded-xl border border-blue-100 overflow-hidden">
                <div class="px-5 py-3 bg-blue-100/50 border-b border-blue-200 flex items-center gap-2">
                    <i data-feather="check-circle" class="w-5 h-5 text-blue-600"></i>
                    <h3 class="font-bold text-blue-800 uppercase text-lg">Nh√≥m ƒê·∫°t ({stats.dat.length})</h3>
                </div>
                <div class="p-5 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                    {#each stats.dat as item}
                        <div class="bg-white p-4 rounded-lg border border-blue-100 shadow-sm hover:shadow-md transition-shadow">
                            <h4 class="font-bold text-gray-800 mb-2 truncate" title={item.name}>{item.name}</h4>
                            <div class="w-full bg-gray-100 rounded-full h-2 mb-3">
                                <div class="bg-blue-500 h-2 rounded-full" style="width: 100%"></div>
                            </div>
                            <div class="text-xs space-y-1">
                                <div class="flex justify-between">
                                    <span class="text-gray-500">Th·ª±c hi·ªán:</span>
                                    <span class="font-bold text-gray-800">{formatters.formatNumber(item.value)}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-500">TB B·ªô ph·∫≠n:</span>
                                    <span class="font-bold text-gray-800">{formatters.formatNumber(item.avg)}</span>
                                </div>
                                <div class="flex justify-between border-t border-dashed border-gray-200 pt-1 mt-1">
                                    <span class="text-gray-500">Ch√™nh l·ªách:</span>
                                    <span class="font-bold text-green-600">+{formatters.formatNumber(item.diff)}</span>
                                </div>
                            </div>
                        </div>
                    {/each}
                    {#if stats.dat.length === 0}
                        <p class="text-sm text-gray-400 italic col-span-full text-center py-4">Kh√¥ng c√≥ ng√†nh h√†ng n√†o ƒë·∫°t.</p>
                    {/if}
                </div>
            </div>

            <div class="bg-yellow-50/50 rounded-xl border border-yellow-100 overflow-hidden">
                <div class="px-5 py-3 bg-yellow-100/50 border-b border-yellow-200 flex items-center gap-2">
                    <i data-feather="trending-up" class="w-5 h-5 text-yellow-600"></i>
                    <h3 class="font-bold text-yellow-800 uppercase text-lg">Nh√≥m G·∫ßn ƒê·∫°t ({stats.ganDat.length})</h3>
                </div>
                <div class="p-5 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                    {#each stats.ganDat as item}
                        <div class="bg-white p-4 rounded-lg border border-yellow-100 shadow-sm hover:shadow-md transition-shadow">
                            <h4 class="font-bold text-gray-800 mb-2 truncate" title={item.name}>{item.name}</h4>
                            <div class="w-full bg-gray-100 rounded-full h-2 mb-3">
                                <div class="bg-yellow-400 h-2 rounded-full" style="width: {item.percentOfAvg}%"></div>
                            </div>
                            <div class="text-xs space-y-1">
                                <div class="flex justify-between">
                                    <span class="text-gray-500">Th·ª±c hi·ªán:</span>
                                    <span class="font-bold text-gray-800">{formatters.formatNumber(item.value)}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-500">TB B·ªô ph·∫≠n:</span>
                                    <span class="font-bold text-gray-800">{formatters.formatNumber(item.avg)}</span>
                                </div>
                                <div class="flex justify-between border-t border-dashed border-gray-200 pt-1 mt-1">
                                    <span class="text-gray-500">Ch√™nh l·ªách:</span>
                                    <span class="font-bold text-red-500">{formatters.formatNumber(item.diff)}</span>
                                </div>
                            </div>
                        </div>
                    {/each}
                    {#if stats.ganDat.length === 0}
                        <p class="text-sm text-gray-400 italic col-span-full text-center py-4">Kh√¥ng c√≥ ng√†nh h√†ng n√†o.</p>
                    {/if}
                </div>
            </div>

            <div class="bg-red-50/50 rounded-xl border border-red-100 overflow-hidden">
                <div class="px-5 py-3 bg-red-100/50 border-b border-red-200 flex items-center gap-2">
                    <i data-feather="alert-circle" class="w-5 h-5 text-red-600"></i>
                    <h3 class="font-bold text-red-800 uppercase text-lg">Nh√≥m C·∫ßn C·ªë G·∫Øng ({stats.canCoGang.length})</h3>
                </div>
                <div class="p-5 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                    {#each stats.canCoGang as item}
                        <div class="bg-white p-4 rounded-lg border border-red-100 shadow-sm hover:shadow-md transition-shadow">
                            <h4 class="font-bold text-gray-800 mb-2 truncate" title={item.name}>{item.name}</h4>
                            <div class="w-full bg-gray-100 rounded-full h-2 mb-3">
                                <div class="bg-red-400 h-2 rounded-full" style="width: {Math.max(item.percentOfAvg, 5)}%"></div>
                            </div>
                            <div class="text-xs space-y-1">
                                <div class="flex justify-between">
                                    <span class="text-gray-500">Th·ª±c hi·ªán:</span>
                                    <span class="font-bold text-gray-800">{formatters.formatNumber(item.value)}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-500">TB B·ªô ph·∫≠n:</span>
                                    <span class="font-bold text-gray-800">{formatters.formatNumber(item.avg)}</span>
                                </div>
                                <div class="flex justify-between border-t border-dashed border-gray-200 pt-1 mt-1">
                                    <span class="text-gray-500">Ch√™nh l·ªách:</span>
                                    <span class="font-bold text-red-600">{formatters.formatNumber(item.diff)}</span>
                                </div>
                            </div>
                        </div>
                    {/each}
                    {#if stats.canCoGang.length === 0}
                        <p class="text-sm text-gray-400 italic col-span-full text-center py-4">Tuy·ªát v·ªùi! Kh√¥ng c√≥ ng√†nh h√†ng y·∫øu k√©m.</p>
                    {/if}
                </div>
            </div>

        </div>

    {:else}
        <div class="p-10 text-center">
            <p class="text-gray-500">ƒêang t·∫£i d·ªØ li·ªáu chi ti·∫øt...</p>
        </div>
    {/if}
</div>

<style>
    .animate-fade-in { animation: fadeIn 0.3s ease-out; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
</style>
<<< FILE_END: src/components/health-staff/competition/CompetitionDetailView.svelte

>>> FILE_START: src/components/health-staff/competition/CompetitionModeSelector.svelte
<script>
  import { createEventDispatcher } from 'svelte';
  export let activeView = 'employee'; // 'program' | 'employee'

  const dispatch = createEventDispatcher();

  function setView(view) {
      dispatch('change', view);
  }
</script>

<div class="flex justify-start items-center">
    <div class="flex bg-gray-200 p-1 rounded-lg shadow-inner">
        <button 
            class="px-4 py-1.5 rounded-md text-sm font-medium transition-all duration-200 {activeView === 'employee' ? 'bg-white text-blue-600 shadow-sm' : 'text-gray-500 hover:text-gray-700'}"
            on:click={() => setView('employee')}
        >
            Theo Nh√¢n Vi√™n
        </button>
        <button 
            class="px-4 py-1.5 rounded-md text-sm font-medium transition-all duration-200 {activeView === 'program' ? 'bg-white text-blue-600 shadow-sm' : 'text-gray-500 hover:text-gray-700'}"
            on:click={() => setView('program')}
        >
            Theo Ch∆∞∆°ng Tr√¨nh
        </button>
    </div>
</div>
<<< FILE_END: src/components/health-staff/competition/CompetitionModeSelector.svelte

>>> FILE_START: src/components/health-staff/competition/EmployeeView.svelte
<script>
  import { createEventDispatcher, afterUpdate } from 'svelte';
  // Import ycxData ƒë·ªÉ map t√™n nh√¢n vi√™n chu·∫©n x√°c
  import { pastedThiDuaReportData, competitionNameMappings, ycxData } from '../../../stores.js';
  import { settingsService } from '../../../services/settings.service.js';
  import { formatters } from '../../../utils/formatters.js';
  
  export let reportData = [];
  const dispatch = createEventDispatcher();

  // --- H√ÄM T√åM MAPPING TH√îNG MINH (B·ªè qua l·ªói d·∫•u c√°ch) ---
  function findSmartMapping(tenGoc, mappings) {
      if (!mappings) return tenGoc;
      // 1. T√¨m ch√≠nh x√°c 100% (Nhanh nh·∫•t)
      if (mappings[tenGoc]) return mappings[tenGoc];
      // 2. T√¨m ki·ªÉu "l√†m s·∫°ch" (X√≥a kho·∫£ng tr·∫Øng th·ª´a 2 ƒë·∫ßu ƒë·ªÉ so s√°nh)
      const cleanName = String(tenGoc).trim();
      // Qu√©t to√†n b·ªô danh s√°ch key trong Admin ƒë·ªÉ t√¨m c√°i n√†o gi·ªëng
      const allKeys = Object.keys(mappings);
      const matchedKey = allKeys.find(k => String(k).trim() === cleanName);
      
      if (matchedKey) return mappings[matchedKey];
      // 3. Kh√¥ng t√¨m th·∫•y th√¨ tr·∫£ v·ªÅ t√™n g·ªëc
      return tenGoc;
  }

  // --- STATE ---
  let columnSettings = [];
  let sortKey = 'hoTen';
  let sortDirection = 'asc';
  // D·ªØ li·ªáu ph·∫≥ng
  let allEmployees = [];
  let deptAverages = {};
  // Palette m√†u cho header
  const headerColors = [
      'bg-red-100 text-red-900 border-red-200',
      'bg-orange-100 text-orange-900 border-orange-200',
      'bg-amber-100 text-amber-900 border-amber-200',
      'bg-lime-100 text-lime-900 border-lime-200',
      'bg-teal-100 text-teal-900 border-teal-200',
      'bg-cyan-100 text-cyan-900 border-cyan-200',
      'bg-sky-100 text-sky-900 border-sky-200',
      'bg-indigo-100 text-indigo-900 border-indigo-200',
      'bg-fuchsia-100 text-fuchsia-900 border-fuchsia-200',
      'bg-rose-100 text-rose-900 border-rose-200'
  ];
  function getHeaderColor(index) {
      return headerColors[index % headerColors.length];
  }

  // --- REACTIVE PROCESSING ---
  $: {
      if (reportData && reportData.length > 0) {
          
          // --- [LOGIC 1] MAP T√äN NH√ÇN VI√äN T·ª™ DANH S√ÅCH G·ªêC (FIX GENESIS) --- 
          // T·∫°o map ch·ª©a c·∫£ T√™n v√† B·ªô ph·∫≠n (Kho)
          const infoMap = {};
          if ($ycxData && $ycxData.length) {
              $ycxData.forEach(nv => {
                  // X·ª≠ l√Ω linh ho·∫°t c√°c tr∆∞·ªùng d·ªØ li·ªáu (ma_nv/maNV, ten_nv/hoTen, ma_kho/boPhan)
                  const code = String(nv.ma_nv || nv.maNV || '').trim();
                  const name = nv.ten_nv || nv.hoTen || '';
                  const dept = nv.ma_kho || nv.boPhan || nv.vi_tri || '';

                  if (code) {
                      infoMap[code] = { name, dept };
                  }
                  
                  // Fallback: map theo t√™n ng∆∞·ªùi t·∫°o n·∫øu c√≥ d·∫°ng "T√™n - M√£"
                  if (nv.nguoiTao) {
                      const msnvMatch = String(nv.nguoiTao).match(/(\d+)/);
                      if (msnvMatch) {
                          const extractedCode = msnvMatch[1].trim();
                          if (!infoMap[extractedCode]) {
                               infoMap[extractedCode] = { 
                                   name: nv.hoTen || nv.nguoiTao, 
                                   dept: dept 
                               };
                          }
                      }
                  }
              });
          }

          const mappedReportData = reportData.map(item => {
             // ∆Øu ti√™n l·∫•y maNV n·∫øu c√≥, ho·∫∑c l·∫•y t·ª´ name n·∫øu name l√† s·ªë
             let rawCode = item.maNV;
             if (!rawCode && item.name && /^\d+$/.test(item.name)) {
                 rawCode = item.name;
             }
             
             // Chu·∫©n h√≥a m√£ nh√¢n vi√™n ƒë·ªÉ tra c·ª©u
             const lookupCode = String(rawCode || '').trim();
             const info = infoMap[lookupCode];

             // Tra c·ª©u t√™n th·∫≠t v√† b·ªô ph·∫≠n
             let realName = item.hoTen || item.name;
             let realDept = item.boPhan; // Gi·ªØ b·ªô ph·∫≠n g·ªëc n·∫øu c√≥

             if (info) {
                 if (info.name) realName = info.name;
                 // N·∫øu d·ªØ li·ªáu g·ªëc ch∆∞a c√≥ b·ªô ph·∫≠n ho·∫∑c b·ªô ph·∫≠n b·ªã r·ªóng, l·∫•y t·ª´ danh s√°ch nh√¢n vi√™n (ma_kho)
                 if (!realDept || realDept === 'Ch∆∞a ph√¢n lo·∫°i' || realDept === lookupCode) {
                     realDept = info.dept;
                 }
             }
             
             // L√†m s·∫°ch t√™n: N·∫øu t√™n l√† d·∫°ng "T√™n - M√£", c·∫Øt b·ªè ph·∫ßn m√£
             if (realName && realName.includes('-')) {
                  const parts = realName.split('-');
                  // N·∫øu ph·∫ßn sau l√† s·ªë (MSNV), l·∫•y ph·∫ßn ƒë·∫ßu
                  if (parts.length > 1 && /\d/.test(parts[parts.length-1])) {
                       realName = parts[0].trim();
                  }
             }

             return {
                 ...item,
                 maNV: rawCode || item.maNV, 
                 hoTen: realName,
                 boPhan: realDept || 'Ch∆∞a ph√¢n lo·∫°i'
             };
          });

          // --- [LOGIC 2] C·∫§U H√åNH C·ªòT & MAPPING T√äN C·ªòT ---
          let savedSettings = settingsService.loadPastedCompetitionViewSettings();
          if (!savedSettings || savedSettings.length === 0) {
              savedSettings = settingsService.loadPastedCompetitionViewSettings();
          }
          columnSettings = savedSettings;
          // √Åp d·ª•ng h√†m mapping th√¥ng minh t·∫°i ƒë√¢y
          columnSettings = columnSettings.map(col => ({
              ...col,
              label: findSmartMapping(col.tenGoc, $competitionNameMappings) || col.label || col.tenGoc
          }));

          const groups = {};
          mappedReportData.forEach(item => {
              const dept = item.boPhan || 'Ch∆∞a ph√¢n lo·∫°i';
              if (!groups[dept]) groups[dept] = [];
              groups[dept].push(item);
          });

          const avgs = {};
          Object.keys(groups).forEach(deptName => {
              const deptData = groups[deptName];
              const deptAvg = {};
              columnSettings.forEach(col => {
                  let total = 0;
                  let count = 0;
                  deptData.forEach(emp => {
                      const compData = emp.competitions.find(c => c.tenGoc === col.tenGoc);
                      const giaTri = compData?.giaTri || 0;
                      if (giaTri > 0) { 
                          total += giaTri;
                          count++;
                      }
                  });
                  deptAvg[col.tenGoc] = count > 0 ? total / count : 0;
              });
              avgs[deptName] = deptAvg;
          });
          deptAverages = avgs;
          
          allEmployees = [...mappedReportData];
      } else {
          allEmployees = [];
      }
  }

  $: visibleColumns = columnSettings.filter(col => col.visible);

  // --- SORT LOGIC ---
  function handleSort(key) {
      if (sortKey === key) {
          sortDirection = sortDirection === 'desc' ? 'asc' : 'desc';
      } else {
          sortKey = key;
          sortDirection = key.startsWith('comp_') || key === 'totalScore' ? 'desc' : 'asc';
      }
  }

  $: sortedEmployees = [...allEmployees].sort((a, b) => {
      let valA, valB;
      
      if (sortKey.startsWith('comp_')) {
            const sortCol = columnSettings.find(c => c.id === sortKey);
            if (!sortCol) return 0;
            valA = a.competitions.find(c => c.tenGoc === sortCol.tenGoc)?.giaTri || 0;
            valB = b.competitions.find(c => c.tenGoc === sortCol.tenGoc)?.giaTri || 0;
            return sortDirection === 'asc' ? valA - valB : valB - valA;

      } else if (sortKey === 'totalScore') {
            const getScore = (emp) => {
                const deptAvg = deptAverages[emp.boPhan] || {};
                let score = 0;
                emp.competitions.forEach(comp => {
                    if (deptAvg[comp.tenGoc] > 0 && comp.giaTri >= deptAvg[comp.tenGoc]) score++;
                });
                return score;
            };
            valA = getScore(a);
            valB = getScore(b);
            return sortDirection === 'asc' ? valA - valB : valB - valA;
      } else {
            valA = a[sortKey] || '';
            valB = b[sortKey] || '';
            return sortDirection === 'asc' ? valA.localeCompare(valB) : valB.localeCompare(valA);
      }
  });

  // --- TOGGLE LOGIC ---
  function toggleColumn(col) {
      const newSettings = columnSettings.map(c => 
          c.tenGoc === col.tenGoc ? { ...c, visible: !c.visible } : c
      );
      columnSettings = newSettings;
      settingsService.savePastedCompetitionViewSettings(newSettings);
  }

  // --- FOOTER CALCULATION ---
  function calculateTotal(col) {
      return allEmployees.reduce((sum, emp) => {
          const comp = emp.competitions.find(c => c.tenGoc === col.tenGoc);
          return sum + (comp?.giaTri || 0);
      }, 0);
  }

  function calculateTotalScore() {
      return allEmployees.reduce((total, item) => {
          const avgScores = deptAverages[item.boPhan] || {};
          const score = item.competitions.reduce((acc, c) => (avgScores[c.tenGoc] > 0 && c.giaTri >= avgScores[c.tenGoc]) ? acc + 1 : acc, 0);
          return total + score;
      }, 0);
  }

  // --- VIEW SWITCHING ---
  function switchToProgram() {
      dispatch('viewChange', 'program');
  }

  afterUpdate(() => {
    if (typeof feather !== 'undefined') feather.replace();
  });
</script>

<div class="space-y-4 animate-fade-in">
    {#if reportData.length === 0}
        <div class="p-8 text-center bg-gray-50 border-2 border-dashed border-gray-300 rounded-lg">
            <p class="text-gray-500">Vui l√≤ng d√°n d·ªØ li·ªáu "Thi ƒëua nh√¢n vi√™n" ·ªü tab "C·∫≠p nh·∫≠t d·ªØ li·ªáu".</p>
        </div>
    {:else}
        
        <div class="bg-slate-50 p-3 rounded-lg border border-slate-200">
            <p class="text-xs font-bold text-gray-500 uppercase mb-2">Hi·ªÉn th·ªã c·ªôt:</p>
            <div class="flex flex-wrap gap-2">
                {#each columnSettings as col}
                    <button 
                        type="button"
                        class="px-3 py-1 rounded-full text-xs font-medium border transition-all select-none
                                {col.visible ? 'bg-blue-600 text-white border-blue-600' : 'bg-white text-gray-500 border-gray-300 hover:bg-gray-50'}"
                        on:click={() => toggleColumn(col)}
                        title={col.loaiSoLieu}
                    >
                        {col.label}
                    </button>
                {/each}
            </div>
        </div>

        <div class="bg-white rounded-xl shadow-md border border-gray-200 overflow-hidden" data-capture-group="pasted-competition">
            
            <div class="p-4 bg-white border-b border-gray-200 flex justify-between items-center">
                <div>
                    <h3 class="text-lg font-bold text-purple-800 uppercase flex items-center gap-2">
                        <i data-feather="award" class="w-5 h-5"></i>
                        Thi ƒêua L≈©y K·∫ø
                    </h3>
                    <p class="text-xs text-gray-500 mt-0.5 ml-7">Theo d√µi ti·∫øn ƒë·ªô c√°c ch∆∞∆°ng tr√¨nh thi ƒëua</p>
                </div>

                <div class="flex items-center bg-gray-100 rounded-lg p-1 border border-gray-200 shadow-inner">
                    <button 
                        type="button"
                        class="px-4 py-1.5 rounded-md text-xs font-bold transition-all shadow-sm bg-white text-blue-700 cursor-default"
                    >
                        Nh√¢n vi√™n
                    </button>
                    <button 
                        type="button"
                        class="px-4 py-1.5 rounded-md text-xs font-medium text-gray-500 hover:text-gray-900 hover:bg-gray-200 transition-colors cursor-pointer"
                        on:click={switchToProgram}
                    >
                        Ch∆∞∆°ng tr√¨nh
                    </button>
                </div>
            </div>
            
            <div class="overflow-x-auto sknv-pasted-competition-scroller relative" style="max-height: 700px;">
                <table class="w-full text-sm text-left border-separate border-spacing-0">
                    <thead class="text-xs uppercase font-bold text-gray-700 sticky top-0 z-20 shadow-sm">
                        <tr>
                            <th class="bg-gray-100 border-b border-r border-gray-200 min-w-[150px] w-[150px] sticky left-0 z-30 px-2 py-2 cursor-pointer hover:bg-gray-200 transition select-none align-middle text-sm" on:click={() => handleSort('hoTen')}>
                                Nh√¢n vi√™n
                            </th>
                            
                            <th class="bg-gray-100 border-b border-r border-gray-200 w-[100px] min-w-[100px] sticky left-[150px] z-30 px-1 py-2 text-center cursor-pointer hover:bg-gray-200 transition select-none align-middle" on:click={() => handleSort('totalScore')}>
                                ƒê·∫°t
                            </th>

                            {#each visibleColumns as col, index}
                                <th 
                                    class="px-1 py-1 w-auto min-w-[60px] max-w-[90px] whitespace-normal break-words border-b border-r border-gray-200 {getHeaderColor(index)} align-middle cursor-pointer hover:opacity-80 transition select-none"
                                    on:click={() => handleSort(col.id)}
                                    title="{col.label} (B·∫•m ƒë·ªÉ s·∫Øp x·∫øp)"
                                >
                                    <div class="text-[10px] font-bold leading-3 text-center whitespace-normal break-words min-h-[32px] flex items-center justify-center">
                                        {col.label}
                                    </div>
                                </th>
                            {/each}
                        </tr>
                    </thead>
                    
                    <tbody class="divide-y divide-gray-100">
                        {#each sortedEmployees as item (item.maNV)}
                            {@const avgScores = deptAverages[item.boPhan] || {}}
                            {@const score = item.competitions.reduce((acc, c) => (avgScores[c.tenGoc] > 0 && c.giaTri >= avgScores[c.tenGoc]) ? acc + 1 : acc, 0)}
                            
                            <tr 
                                class="hover:bg-blue-50 transition-colors group cursor-pointer"
                                on:click={() => dispatch('viewDetail', { employeeId: item.maNV })}
                            >
                                <td class="px-2 py-1.5 font-semibold text-blue-700 bg-white group-hover:bg-blue-50 sticky left-0 z-10 border-r border-gray-200 whitespace-nowrap text-[13px] truncate max-w-[150px]" title="{item.hoTen} - {item.maNV}">
                                    {formatters.getShortEmployeeName(item.hoTen, item.maNV)}
                                </td>
                                
                                <td class="px-1 py-1.5 w-[100px] min-w-[100px] text-center font-bold text-green-600 bg-white group-hover:bg-blue-50 border-r border-gray-200 text-[14px] sticky left-[150px] z-10">
                                    {score}
                                </td>

                                {#each visibleColumns as col}
                                    {@const comp = item.competitions.find(c => c.tenGoc === col.tenGoc)}
                                    {@const val = comp?.giaTri || 0}
                                    {@const avg = avgScores[col.tenGoc] || 0}
                                    {@const isBelow = avg > 0 && val < avg}
                                    {@const isRevenue = col.loaiSoLieu && col.loaiSoLieu.includes('DT')}
                                    {@const textColorClass = isRevenue ? 'text-blue-700' : 'text-gray-900'}
                                    
                                    <td class="px-1 py-1.5 text-right border-r border-gray-100 font-bold text-[13px] {isBelow ? 'bg-red-50' : ''} {textColorClass} whitespace-nowrap overflow-hidden">
                                        {#if val === 0}
                                            <span class="text-gray-300 font-normal">-</span>
                                        {:else}
                                            {formatters.formatNumber(val)}
                                        {/if}
                                    </td>
                                {/each}
                            </tr>
                        {/each}
                    </tbody>
                    
                    <tfoot class="text-xs uppercase sticky bottom-0 z-20 shadow-[0_-1px_2px_rgba(0,0,0,0.1)]">
                        <tr class="bg-yellow-50 text-yellow-800 font-semibold border-t-2 border-gray-300">
                            <td class="px-2 py-2 sticky left-0 bg-yellow-100 border-r border-gray-300 z-30 text-center text-[13px]">
                                TRUNG B√åNH
                            </td>
                            <td class="px-2 py-2 border-r border-gray-300 bg-yellow-100 sticky left-[150px] z-30 text-center text-[13px] font-bold text-green-700">
                                {allEmployees.length > 0 ? formatters.formatNumber(calculateTotalScore() / allEmployees.length, 1) : 0}
                            </td>
                            {#each visibleColumns as col}
                                <td class="px-1 py-2 text-right border-r border-gray-300 text-[13px]">
                                    {allEmployees.length > 0 ? formatters.formatNumber(calculateTotal(col) / allEmployees.length, 0) : 0}
                                </td>
                            {/each}
                        </tr>

                        <tr class="bg-gray-200 text-gray-900 font-bold border-t border-gray-300">
                            <td class="px-2 py-2 sticky left-0 bg-gray-300 border-r border-gray-300 z-30 text-center text-[13px]">
                                T·ªîNG
                            </td>
                            <td class="px-2 py-2 border-r border-gray-300 bg-gray-300 sticky left-[150px] z-30 text-center text-[13px]">
                                {calculateTotalScore()}
                            </td>
                            {#each visibleColumns as col}
                                <td class="px-1 py-2 text-right border-r border-gray-300 text-[13px]">
                                    {formatters.formatNumber(calculateTotal(col))}
                                </td>
                            {/each}
                        </tr>
                    </tfoot>
                </table>
            </div>
        </div>
    {/if}
</div>

<style>
    .animate-fade-in { animation: fadeIn 0.4s ease-out; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    .sticky { position: sticky; }
    
    .custom-scrollbar::-webkit-scrollbar { width: 4px; height: 4px; }
    .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
    .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 2px; }

    table { border-spacing: 0; }
    /* CSS cho Line Clamp 2 d√≤ng */
    .line-clamp-2 {
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
    }
</style>
<<< FILE_END: src/components/health-staff/competition/EmployeeView.svelte

>>> FILE_START: src/components/health-staff/competition/FocusCompetitionTable.svelte
<script>
    import { formatters } from '../../../utils/formatters.js';
    import { datasyncService } from '../../../services/datasync.service.js';
    import { selectedWarehouse, localCompetitionConfigs } from '../../../stores.js';
  
    // Nh·∫≠n d·ªØ li·ªáu t·ª´ component cha
    export let competitionResult;
  
    // Destructure d·ªØ li·ªáu ƒë·ªÉ d·ªÖ d√πng
    $: competition = competitionResult.competition;
    $: employeeData = competitionResult.employeeData;
    $: brands = competition.brands || [];
  
    // --- [1] LOGIC M·ª§C TI√äU & T√î M√ÄU (NEW) ---
    
    // Bi·∫øn l∆∞u m·ª•c ti√™u ng∆∞·ªùi d√πng nh·∫≠p (M·∫∑c ƒë·ªãnh 0)
    let localTarget = 0;
    let isSaving = false;
  
    // T·ª± ƒë·ªông load m·ª•c ti√™u c≈© ƒë√£ l∆∞u (n·∫øu c√≥) khi m·ªü trang
    $: if ($localCompetitionConfigs && competition) {
        const savedConfig = $localCompetitionConfigs.find(c => c.id === competition.id);
        if (savedConfig && !isSaving) {
            localTarget = savedConfig.target || 0;
        }
    }
  
    // X·ª≠ l√Ω d·ªØ li·ªáu hi·ªÉn th·ªã & T√≠nh m√†u s·∫Øc
    $: processedData = sortedData.map(item => {
        // Quy ƒë·ªïi m·ª•c ti√™u t·ª´ % (VD: 80) sang s·ªë th·∫≠p ph√¢n (0.8) ƒë·ªÉ so s√°nh
        const targetDecimal = localTarget > 0 ? localTarget / 100 : 0;
        const hasTarget = localTarget > 0;
  
        // Logic ki·ªÉm tra: Ch·ªâ so s√°nh n·∫øu c√≥ ƒë·∫∑t m·ª•c ti√™u
        const isLowSL = hasTarget && item.tyLeSL < targetDecimal;
        const isLowDT = hasTarget && item.tyLeDT < targetDecimal;
  
        return {
            ...item,
            // N·∫øu d∆∞·ªõi m·ª•c ti√™u -> T√¥ ƒë·ªè & In ƒë·∫≠m. Ng∆∞·ª£c l·∫°i -> M√†u x√°m th∆∞·ªùng
            classSL: isLowSL ? 'text-red-600 font-bold bg-red-50' : 'text-gray-600',
            classDT: isLowDT ? 'text-red-600 font-bold bg-red-50' : 'text-gray-900 font-medium'
        };
    });
  
    // --- [2] LOGIC L∆ØU TR·ªÆ ---
    let saveTimer;
    let saveStatus = '';
  
    function handleInput() {
        isSaving = true;
        saveStatus = 'saving';
        
        // Debounce: Ch·ªù ng∆∞·ªùi d√πng g√µ xong 0.8s m·ªõi l∆∞u
        if (saveTimer) clearTimeout(saveTimer);
        
        saveTimer = setTimeout(async () => {
            try {
                if (!$selectedWarehouse) return;
  
                // C·∫≠p nh·∫≠t Store (ƒë·ªÉ c√°c tab kh√°c th·∫•y ngay)
                let currentConfigs = $localCompetitionConfigs ? [...$localCompetitionConfigs] : [];
                const idx = currentConfigs.findIndex(c => c.id === competition.id);
                
                if (idx >= 0) {
                    currentConfigs[idx] = { ...currentConfigs[idx], target: localTarget };
                } else {
                    currentConfigs.push({ id: competition.id, target: localTarget });
                }
                localCompetitionConfigs.set(currentConfigs);
  
                // L∆∞u xu·ªëng Database
                await datasyncService.saveCompetitionConfigs($selectedWarehouse, currentConfigs);
                
                saveStatus = 'success';
                setTimeout(() => { saveStatus = ''; isSaving = false; }, 2000);
            } catch (error) {
                console.error(error);
                saveStatus = 'error';
                isSaving = false;
            }
        }, 800);
    }
  
    // --- [3] LOGIC S·∫ÆP X·∫æP & UI KH√ÅC (GI·ªÆ NGUY√äN) ---
    let sortKey = 'tyLeDT';
    let sortDirection = 'desc';
  
    function handleSort(key) {
        if (sortKey === key) {
            sortDirection = sortDirection === 'desc' ? 'asc' : 'desc';
        } else {
            sortKey = key;
            sortDirection = 'desc';
        }
    }
  
    $: sortedData = [...employeeData].sort((a, b) => {
        let valA = 0, valB = 0;
        // Logic l·∫•y gi√° tr·ªã s·∫Øp x·∫øp
        if (sortKey === 'hoTen') {
            return sortDirection === 'asc' ? a.hoTen.localeCompare(b.hoTen) : b.hoTen.localeCompare(a.hoTen);
        } else if (sortKey.includes('_quantity') || sortKey.includes('_revenue')) {
            const [brandName, type] = sortKey.split('_');
            valA = (a.performanceByBrand[brandName] || {})[type] || 0;
            valB = (b.performanceByBrand[brandName] || {})[type] || 0;
        } else {
            valA = Number(a[sortKey]) || 0;
            valB = Number(b[sortKey]) || 0;
        }
        return sortDirection === 'asc' ? valA - valB : valB - valA;
    });
  
    // T√≠nh t·ªïng ch√¢n trang
    $: totals = employeeData.reduce((acc, item) => {
        acc.baseCategoryQuantity += item.baseCategoryQuantity;
        acc.baseCategoryRevenue += item.baseCategoryRevenue;
        brands.forEach(brand => {
            if (!acc.performanceByBrand[brand]) acc.performanceByBrand[brand] = { quantity: 0, revenue: 0 };
            acc.performanceByBrand[brand].quantity += item.performanceByBrand[brand]?.quantity || 0;
            acc.performanceByBrand[brand].revenue += item.performanceByBrand[brand]?.revenue || 0;
        });
        return acc;
    }, { baseCategoryQuantity: 0, baseCategoryRevenue: 0, performanceByBrand: {} });
  
    $: totalTyLeDT = totals.baseCategoryRevenue > 0 ? 
        Object.values(totals.performanceByBrand).reduce((sum, b) => sum + b.revenue, 0) / totals.baseCategoryRevenue : 0;
  
    const headerClass = (key) => `px-2 py-3 cursor-pointer select-none transition text-xs font-bold uppercase ${sortKey === key ? 'bg-indigo-100 text-indigo-800' : 'hover:bg-gray-200'}`;
  </script>
  
  <div class="bg-white rounded-lg shadow border border-gray-200 overflow-hidden flex flex-col h-full">
      <div class="p-3 bg-gray-50 border-b border-gray-200 flex justify-between items-center">
          <div>
              <h3 class="text-base font-bold text-gray-800 uppercase">{competition.name}</h3>
              <p class="text-[11px] text-gray-500 mt-0.5">
                  Ph·∫°m vi: <span class="font-semibold text-indigo-600">{brands.join(', ')}</span>
              </p>
          </div>
          
          <div class="flex items-center gap-2 bg-white px-2 py-1 rounded border border-gray-300 shadow-sm relative">
              <span class="text-xs font-semibold text-gray-600">M·ª•c ti√™u:</span>
              <input 
                  type="number" 
                  bind:value={localTarget}
                  on:input={handleInput}
                  on:focus={(e) => e.target.select()}
                  class="w-10 text-center font-bold text-indigo-700 border-b border-gray-300 focus:border-indigo-500 outline-none text-sm p-0"
                  placeholder="0"
              />
              <span class="text-xs font-bold text-gray-500">%</span>
  
              {#if saveStatus === 'saving'}
                  <span class="absolute -bottom-4 right-0 text-[9px] text-orange-500 animate-pulse">L∆∞u...</span>
              {:else if saveStatus === 'success'}
                  <span class="absolute -bottom-4 right-0 text-[9px] text-green-600">ƒê√£ l∆∞u</span>
              {/if}
          </div>
      </div>
  
      <div class="overflow-x-auto flex-grow">
          <table class="min-w-full text-sm text-left border-collapse">
              <thead class="text-xs text-slate-700 bg-slate-100 sticky top-0 z-10 shadow-sm">
                  <tr>
                      <th rowspan="2" class="{headerClass('hoTen')} bg-gray-200 min-w-[160px] border-r border-gray-300" on:click={() => handleSort('hoTen')}>
                          Nh√¢n vi√™n {sortKey === 'hoTen' ? (sortDirection === 'asc' ? '‚ñ≤' : '‚ñº') : ''}
                      </th>
                      {#each brands as brand}
                          <th colspan="2" class="px-2 py-1 text-center border-l border-gray-300 bg-purple-50 text-purple-900 font-bold">{brand}</th>
                      {/each}
                      <th colspan="2" class="px-2 py-1 text-center border-l border-gray-300 bg-blue-50 text-blue-900 font-bold">T·ªïng Nh√≥m</th>
                      <th colspan="2" class="px-2 py-1 text-center border-l border-gray-300 bg-orange-50 text-orange-900 font-bold">T·ª∑ l·ªá</th>
                  </tr>
                  <tr>
                      {#each brands as brand}
                          <th class="{headerClass(`${brand}_quantity`)} text-right border-l border-gray-200" on:click={() => handleSort(`${brand}_quantity`)}>SL</th>
                          <th class="{headerClass(`${brand}_revenue`)} text-right" on:click={() => handleSort(`${brand}_revenue`)}>DT</th>
                      {/each}
                      
                      <th class="{headerClass('baseCategoryQuantity')} text-right border-l border-gray-200" on:click={() => handleSort('baseCategoryQuantity')}>SL</th>
                      <th class="{headerClass('baseCategoryRevenue')} text-right" on:click={() => handleSort('baseCategoryRevenue')}>DT</th>
                      
                      <th class="{headerClass('tyLeSL')} text-right border-l border-gray-200 text-orange-800" on:click={() => handleSort('tyLeSL')}>% SL</th>
                      <th class="{headerClass('tyLeDT')} text-right text-orange-800" on:click={() => handleSort('tyLeDT')}>% DT</th>
                  </tr>
              </thead>
              
              <tbody class="divide-y divide-gray-100">
                  {#each processedData as item}
                      <tr class="hover:bg-indigo-50/50 transition-colors">
                          <td class="px-3 py-2 font-semibold text-indigo-900 whitespace-nowrap sticky left-0 bg-white hover:bg-indigo-50 border-r border-gray-200 shadow-[2px_0_5px_-2px_rgba(0,0,0,0.1)]">
                              {formatters.getShortEmployeeName(item.hoTen, item.maNV)}
                          </td>
                          
                          {#each brands as brand}
                              {@const perf = item.performanceByBrand[brand] || {quantity: 0, revenue: 0}}
                              <td class="px-2 py-2 text-right border-l border-gray-100 text-gray-500">{formatters.formatNumberOrDash(perf.quantity)}</td>
                              <td class="px-2 py-2 text-right text-gray-700">{formatters.formatRevenue(perf.revenue)}</td>
                          {/each}
  
                          <td class="px-2 py-2 text-right border-l border-gray-200 font-medium bg-blue-50/20">{formatters.formatNumberOrDash(item.baseCategoryQuantity)}</td>
                          <td class="px-2 py-2 text-right font-medium bg-blue-50/20">{formatters.formatRevenue(item.baseCategoryRevenue)}</td>
                          
                          <td class="px-2 py-2 text-right border-l border-gray-200 {item.classSL}">
                              {formatters.formatPercentage(item.tyLeSL)}
                          </td>
  
                          <td class="px-2 py-2 text-right {item.classDT}">
                              {formatters.formatPercentage(item.tyLeDT)}
                          </td>
                      </tr>
                  {/each}
              </tbody>
              
              <tfoot class="bg-gray-100 font-bold text-gray-800 border-t-2 border-gray-300 text-xs">
                  <tr>
                      <td class="px-3 py-2 sticky left-0 bg-gray-100 border-r border-gray-300">T·ªïng C·ªông</td>
                      {#each brands as brand}
                          {@const perf = totals.performanceByBrand[brand] || {quantity: 0, revenue: 0}}
                          <td class="px-2 py-2 text-right border-l border-gray-200">{formatters.formatNumberOrDash(perf.quantity)}</td>
                          <td class="px-2 py-2 text-right">{formatters.formatRevenue(perf.revenue)}</td>
                      {/each}
                      <td class="px-2 py-2 text-right border-l border-gray-200">{formatters.formatNumberOrDash(totals.baseCategoryQuantity)}</td>
                      <td class="px-2 py-2 text-right">{formatters.formatRevenue(totals.baseCategoryRevenue)}</td>
                      <td class="px-2 py-2 text-right border-l border-gray-200">-</td>
                      <td class="px-2 py-2 text-right text-blue-700">{formatters.formatPercentage(totalTyLeDT)}</td>
                  </tr>
              </tfoot>
          </table>
      </div>
  </div>
<<< FILE_END: src/components/health-staff/competition/FocusCompetitionTable.svelte

>>> FILE_START: src/components/health-staff/competition/ProgramView.svelte
<script>
  import FocusCompetitionTable from './FocusCompetitionTable.svelte';

  export let reportData = []; // M·∫£ng k·∫øt qu·∫£ t√≠nh to√°n t·ª´ service
</script>

{#if reportData.length === 0}
    <div class="p-12 text-center bg-white border-2 border-dashed border-gray-300 rounded-xl">
        <p class="text-gray-500 font-medium">Kh√¥ng c√≥ d·ªØ li·ªáu ch∆∞∆°ng tr√¨nh thi ƒëua.</p>
        <p class="text-sm text-gray-400 mt-2">
            Vui l√≤ng ki·ªÉm tra:
            1. ƒê√£ t·∫°o ch∆∞∆°ng tr√¨nh trong "Thi·∫øt l·∫≠p m·ª•c ti√™u"?
            2. ƒê√£ t·∫£i file YCX?
            3. C√≥ ph√°t sinh doanh thu cho c√°c nh√≥m h√†ng ƒë√£ ch·ªçn?
        </p>
    </div>
{:else}
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 pb-10">
        {#each reportData as result (result.competition.id)}
            <div class="h-full">
                <FocusCompetitionTable competitionResult={result} />
            </div>
        {/each}
    </div>
{/if}
<<< FILE_END: src/components/health-staff/competition/ProgramView.svelte

>>> FILE_START: src/components/health-staff/detail/CardFilter.svelte
<script>
    import { createEventDispatcher } from 'svelte';
    
    export let items = []; // Array { id, label, visible }

    const dispatch = createEventDispatcher();
    let isOpen = false;
    let containerRef; 

    function toggleDropdown() {
        isOpen = !isOpen;
    }

    function toggleItem(id) {
        dispatch('change', id);
    }

    // ƒê√≥ng dropdown khi click ra ngo√†i container c·ªßa ch√≠nh component n√†y
    function close(e) {
        if (isOpen && containerRef && !containerRef.contains(e.target)) {
            isOpen = false;
        }
    }
</script>

<svelte:window on:click={close} />

<div class="relative inline-block text-left" bind:this={containerRef}>
    <button 
        type="button" 
        class="text-white/70 hover:text-white p-1 rounded-full hover:bg-white/20 transition-colors"
        on:click|stopPropagation={toggleDropdown}
        title="L·ªçc ch·ªâ s·ªë hi·ªÉn th·ªã"
    >
        <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z" />
        </svg>
    </button>

    {#if isOpen}
        <div class="absolute right-0 mt-2 w-64 bg-white rounded-lg shadow-xl border border-gray-200 z-[100] animate-fade-in-fast origin-top-right">
            <div class="p-2 border-b border-gray-100 bg-gray-50 rounded-t-lg">
                <span class="text-xs font-bold text-gray-500 uppercase">Hi·ªÉn th·ªã ch·ªâ s·ªë</span>
            </div>
            <div class="p-1 max-h-60 overflow-y-auto custom-scrollbar">
                {#if items.length === 0}
                    <div class="px-3 py-2 text-xs text-gray-400 text-center">Kh√¥ng c√≥ m·ª•c n√†o.</div>
                {:else}
                    {#each items as item (item.id)}
                        <label class="flex items-center px-3 py-2 hover:bg-gray-50 cursor-pointer rounded transition-colors group">
                            <input 
                                type="checkbox" 
                                checked={item.visible !== false} 
                                on:change={() => toggleItem(item.id)}
                                class="mr-3 h-4 w-4 text-blue-600 rounded border-gray-300 focus:ring-blue-500 cursor-pointer"
                            >
                            <span class="text-sm text-gray-700 group-hover:text-blue-700 truncate select-none" title={item.label}>
                                {item.label}
                            </span>
                        </label>
                    {/each}
                {/if}
            </div>
        </div>
    {/if}
</div>

<style>
    .animate-fade-in-fast { animation: fadeIn 0.1s ease-out; }
    @keyframes fadeIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
    
    .custom-scrollbar::-webkit-scrollbar { width: 4px; }
    .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
    .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 2px; }
</style>
<<< FILE_END: src/components/health-staff/detail/CardFilter.svelte

>>> FILE_START: src/components/health-staff/detail/DetailHeader.svelte
<script>
  // Component hi·ªÉn th·ªã Header c·ªßa trang chi ti·∫øt
  export let employee;
  export let totalAbove = 0;
  export let totalCriteria = 0;
  // [M·ªöI] Prop ƒë·ªÉ ƒëi·ªÅu khi·ªÉn hi·ªÉn th·ªã d√≤ng ƒë√°nh gi√°
  export let showStats = true;
</script>

<div class="flex items-center gap-6 p-4 bg-purple-50 border border-purple-200 border-t-4 border-t-purple-500 rounded-lg shadow-sm mb-6">
    <div class="w-16 h-16 rounded-full bg-purple-200 flex items-center justify-center flex-shrink-0 text-purple-800">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-8 h-8">
            <path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/>
        </svg>
    </div>
    
    <div class="flex-grow">
        <p class="text-2xl font-extrabold text-purple-800 leading-tight">
             {employee.hoTen} <span class="text-lg font-semibold text-purple-600">- {employee.maNV}</span>
        </p>
        <p class="text-gray-700 font-medium text-base">{employee.boPhan}</p>
        
        {#if showStats}
            <p class="mt-1 text-sm font-semibold text-gray-800">
                Ch·ªâ s·ªë tr√™n TB: <span class="text-green-600 font-bold text-lg">{totalAbove}</span> 
                <span class="text-gray-400 mx-1">/</span> 
                T·ªïng: <span class="font-bold text-gray-600">{totalCriteria}</span>
            </p>
        {/if}
    </div>
</div>
<<< FILE_END: src/components/health-staff/detail/DetailHeader.svelte

>>> FILE_START: src/components/health-staff/detail/DetailTableCategory.svelte
<script>
  import { formatters } from '../../../utils/formatters.js';
  import { cleanCategoryName } from '../../../utils.js';
  import { categoryStructure, macroCategoryConfig } from '../../../stores.js'; 
  import CardFilter from './CardFilter.svelte';

  export let data = []; 
  export let rawEmployee = null; 

  const headerClass = "bg-[#7e22ce]";

  // H√†m chu·∫©n h√≥a key ƒë·ªÉ so s√°nh (vi·∫øt th∆∞·ªùng + b·ªè kho·∫£ng tr·∫Øng th·ª´a)
  const normalizeKey = (str) => {
      if (!str) return '';
      return String(str).trim().toLowerCase();
  };

  let displayData = [];
  let filterItems = [];
  
  // State hi·ªÉn th·ªã (L∆∞u danh s√°ch c√°c KEY ƒë√£ chu·∫©n h√≥a)
  let visibleKeys = new Set();
  let isInitialized = false;

  // Logic x·ª≠ l√Ω d·ªØ li·ªáu ch√≠nh
  $: {
      // 1. Thu th·∫≠p t·∫•t c·∫£ c√°c t√™n ng√†nh h√†ng t·ª´ m·ªçi ngu·ªìn
      const source1 = ($macroCategoryConfig || []).map(m => m.name);
      const source2 = ($categoryStructure || []).map(c => cleanCategoryName(c.nganhHang)).filter(Boolean);
      const source3 = data.map(i => i.name);
      
      // Danh s√°ch t√™n g·ªëc ƒë·ªÉ hi·ªÉn th·ªã
      const allRawNames = [...source1, ...source2, ...source3];

      // 2. G·ªôp d·ªØ li·ªáu v√†o Map ƒë·ªÉ kh·ª≠ tr√πng l·∫∑p d·ª±a tr√™n key chu·∫©n h√≥a
      const mergedMap = new Map();

      allRawNames.forEach(rawName => {
          const key = normalizeKey(rawName);
          if (!key) return;

          // N·∫øu ch∆∞a c√≥ trong Map, t·∫°o m·ªõi
          if (!mergedMap.has(key)) {
              // ∆Øu ti√™n l·∫•y s·ªë li·ªáu t·ª´ 'data' (ƒë√£ t√≠nh to√°n)
              let existingItem = data.find(i => normalizeKey(i.name) === key);
              
              // N·∫øu kh√¥ng c√≥, l·∫•y t·ª´ rawEmployee (tra c·ª©u an to√†n)
              if (!existingItem && rawEmployee?.doanhThuTheoNganhHang) {
                  // C·∫ßn t√¨m key g·ªëc trong object rawEmployee kh·ªõp v·ªõi key chu·∫©n h√≥a
                  const rawKey = Object.keys(rawEmployee.doanhThuTheoNganhHang).find(k => normalizeKey(k) === key);
                  if (rawKey) {
                      existingItem = rawEmployee.doanhThuTheoNganhHang[rawKey];
                  }
              }

              // T·∫°o object hi·ªÉn th·ªã
              mergedMap.set(key, {
                  id: key, // D√πng key chu·∫©n h√≥a l√†m ID duy nh·∫•t cho v√≤ng l·∫∑p
                  name: rawName, // T√™n hi·ªÉn th·ªã (l·∫•y c√°i ƒë·∫ßu ti√™n t√¨m th·∫•y)
                  quantity: existingItem ? existingItem.quantity : 0,
                  revenue: existingItem ? existingItem.revenue : 0,
                  revenueQuyDoi: existingItem ? existingItem.revenueQuyDoi : 0
              });
          }
      });

      // 3. Kh·ªüi t·∫°o tr·∫°ng th√°i filter (ch·ªâ ch·∫°y 1 l·∫ßn ƒë·∫ßu)
      if (!isInitialized && mergedMap.size > 0) {
          // M·∫∑c ƒë·ªãnh hi·ªán nh·ªØng c√°i c√≥ s·ªë li·ªáu > 0
          mergedMap.forEach((val, key) => {
              if (val.revenue > 0 || val.quantity > 0) {
                  visibleKeys.add(key);
              }
          });
          // N·∫øu nh√¢n vi√™n kh√¥ng c√≥ d·ªØ li·ªáu g√¨, hi·ªán t·∫•t c·∫£ ho·∫∑c top 10 (tu·ª≥ ch·ªçn), ·ªü ƒë√¢y ta ƒë·ªÉ tr·ªëng
          visibleKeys = new Set(visibleKeys);
          isInitialized = true;
      }

      // 4. T·∫°o danh s√°ch hi·ªÉn th·ªã cu·ªëi c√πng
      displayData = Array.from(mergedMap.values())
          .filter(item => visibleKeys.has(item.id))
          .sort((a, b) => b.revenue - a.revenue);

      // 5. T·∫°o danh s√°ch cho b·ªô l·ªçc
      // Sort b·ªô l·ªçc theo t√™n A-Z ƒë·ªÉ d·ªÖ t√¨m
      filterItems = Array.from(mergedMap.values())
          .map(item => ({
              id: item.id,
              label: item.name,
              visible: visibleKeys.has(item.id)
          }))
          .sort((a, b) => a.label.localeCompare(b.label));
  }

  function handleFilterChange(event) {
      const id = event.detail; // id nh·∫≠n ƒë∆∞·ª£c l√† key ƒë√£ chu·∫©n h√≥a
      if (visibleKeys.has(id)) {
          visibleKeys.delete(id);
      } else {
          visibleKeys.add(id);
      }
      visibleKeys = new Set(visibleKeys); // Trigger reactivity
  }
</script>

<div class="bg-white rounded-xl shadow-md border border-gray-200 overflow-hidden flex flex-col h-full">
    <div class="{headerClass} flex justify-between items-center p-3 text-white">
        <div class="flex items-center gap-2">
            <i data-feather="list" class="w-5 h-5"></i>
            <h4 class="text-lg font-bold">Doanh thu ng√†nh h√†ng</h4>
        </div>
        <CardFilter items={filterItems} on:change={handleFilterChange} />
    </div>
    
    <div class="overflow-x-auto max-h-96">
        <table class="w-full text-sm table-bordered table-striped">
            <thead class="bg-gray-50 font-bold text-gray-700 sticky top-0 z-10">
                <tr>
                    <th class="px-3 py-2 text-left">Ng√†nh h√†ng</th>
                    <th class="px-3 py-2 text-right">SL</th>
                    <th class="px-3 py-2 text-right">Doanh thu</th>
                    <th class="px-3 py-2 text-right">DTQƒê</th>
                </tr>
            </thead>
            <tbody>
                {#if displayData.length === 0}
                    <tr><td colspan="4" class="p-4 text-center text-gray-500">ƒê√£ ·∫©n h·∫øt d·ªØ li·ªáu.</td></tr>
                {:else}
                    {#each displayData as item (item.id)}
                        <tr class="border-t hover:bg-slate-50 transition-colors">
                            <td class="px-3 py-2 font-medium capitalize text-gray-800">{item.name}</td>
                            <td class="px-3 py-2 text-right font-bold text-gray-600">{formatters.formatNumber(item.quantity)}</td>
                            <td class="px-3 py-2 text-right font-bold text-gray-800">{formatters.formatRevenue(item.revenue, 0)}</td>
                            <td class="px-3 py-2 text-right font-bold text-purple-600">{formatters.formatRevenue(item.revenueQuyDoi, 0)}</td>
                        </tr>
                    {/each}
                {/if}
            </tbody>
        </table>
    </div>
</div>
<<< FILE_END: src/components/health-staff/detail/DetailTableCategory.svelte

>>> FILE_START: src/components/health-staff/detail/DetailTableQDC.svelte
<script>
  import { formatters } from '../../../utils/formatters.js';
  import { cleanCategoryName } from '../../../utils.js';
  import { categoryStructure, macroProductGroupConfig } from '../../../stores.js'; 
  import CardFilter from './CardFilter.svelte';

  export let data = []; 
  export let rawEmployee = null; 

  const headerClass = "bg-[#4f46e5]"; 

  const normalizeKey = (str) => {
      if (!str) return '';
      return String(str).trim().toLowerCase();
  };

  let displayData = [];
  let filterItems = [];
  let visibleKeys = new Set();
  let isInitialized = false;

  $: {
      const source1 = ($macroProductGroupConfig || []).map(m => m.name);
      const source2 = ($categoryStructure || []).map(c => cleanCategoryName(c.nhomHang)).filter(Boolean);
      const source3 = data.map(i => i.name);
      const allRawNames = [...source1, ...source2, ...source3];

      const mergedMap = new Map();

      allRawNames.forEach(rawName => {
          const key = normalizeKey(rawName);
          if (!key) return;

          if (!mergedMap.has(key)) {
              let existingItem = data.find(i => normalizeKey(i.name) === key);
              
              if (!existingItem) {
                  // Th·ª≠ t√¨m trong nhomHangChiTiet
                  if (rawEmployee?.doanhThuTheoNhomHang) {
                      const rawKey = Object.keys(rawEmployee.doanhThuTheoNhomHang).find(k => normalizeKey(k) === key);
                      if (rawKey) existingItem = rawEmployee.doanhThuTheoNhomHang[rawKey];
                  }
                  // N·∫øu kh√¥ng th·∫•y, th·ª≠ t√¨m trong qdc (v√¨ QƒêC c≈©ng l√† nh√≥m h√†ng)
                  if (!existingItem && rawEmployee?.qdc) {
                      const rawKey = Object.keys(rawEmployee.qdc).find(k => normalizeKey(k) === key);
                      if (rawKey) existingItem = rawEmployee.qdc[rawKey];
                  }
              }

              mergedMap.set(key, {
                  id: key,
                  name: rawName,
                  sl: existingItem ? (existingItem.sl || existingItem.quantity || 0) : 0,
                  dtqd: existingItem ? (existingItem.dtqd || existingItem.revenueQuyDoi || 0) : 0
              });
          }
      });

      if (!isInitialized && mergedMap.size > 0) {
          mergedMap.forEach((val, key) => {
              if (val.dtqd > 0 || val.sl > 0) visibleKeys.add(key);
          });
          visibleKeys = new Set(visibleKeys);
          isInitialized = true;
      }

      displayData = Array.from(mergedMap.values())
          .filter(item => visibleKeys.has(item.id))
          .sort((a, b) => b.dtqd - a.dtqd);

      filterItems = Array.from(mergedMap.values())
          .map(item => ({
              id: item.id,
              label: item.name,
              visible: visibleKeys.has(item.id)
          }))
          .sort((a, b) => a.label.localeCompare(b.label));
  }

  function handleFilterChange(event) {
      const id = event.detail;
      if (visibleKeys.has(id)) visibleKeys.delete(id);
      else visibleKeys.add(id);
      visibleKeys = new Set(visibleKeys);
  }
</script>

<div class="bg-white rounded-xl shadow-md border border-gray-200 overflow-hidden flex flex-col h-full">
    <div class="{headerClass} flex justify-between items-center p-3 text-white">
        <div class="flex items-center gap-2">
            <i data-feather="star" class="w-5 h-5"></i>
            <h4 class="text-lg font-bold">Nh√≥m h√†ng Quy ƒë·ªïi cao</h4>
        </div>
        <CardFilter items={filterItems} on:change={handleFilterChange} />
    </div>
    
    <div class="overflow-x-auto max-h-96">
        <table class="w-full text-sm table-bordered table-striped">
            <thead class="bg-gray-50 font-bold text-gray-700 sticky top-0 z-10">
                <tr>
                    <th class="px-3 py-2 text-left">Nh√≥m h√†ng</th>
                    <th class="px-3 py-2 text-right">SL</th>
                    <th class="px-3 py-2 text-right">DTQƒê (Tr)</th>
                </tr>
            </thead>
            <tbody>
                {#if displayData.length === 0}
                    <tr><td colspan="3" class="p-4 text-center text-gray-500">ƒê√£ ·∫©n h·∫øt d·ªØ li·ªáu.</td></tr>
                {:else}
                    {#each displayData as item (item.id)}
                        <tr class="border-t hover:bg-slate-50 transition-colors">
                            <td class="px-3 py-2 font-medium text-gray-800">{item.name}</td>
                            <td class="px-3 py-2 text-right font-bold text-gray-600">{formatters.formatNumber(item.sl)}</td>
                            <td class="px-3 py-2 text-right font-bold text-blue-600">{formatters.formatRevenue(item.dtqd)}</td>
                        </tr>
                    {/each}
                {/if}
            </tbody>
        </table>
    </div>
</div>
<<< FILE_END: src/components/health-staff/detail/DetailTableQDC.svelte

>>> FILE_START: src/components/health-staff/detail/DetailView.svelte
<script>
  import { afterUpdate, createEventDispatcher, onMount } from 'svelte';
  import { masterReportData, selectedWarehouse, warehouseCustomMetrics } from '../../../stores.js';
  import { sknvService } from '../../../services/sknv.service.js';
  import { datasyncService } from '../../../services/datasync.service.js';
  
  import DetailHeader from './DetailHeader.svelte';
  import MetricGrid from './MetricGrid.svelte';
  import DetailTableQDC from './DetailTableQDC.svelte';
  import DetailTableCategory from './DetailTableCategory.svelte';
  
  import AddEfficiencyColumnModal from '../../modals/AddEfficiencyColumnModal.svelte';
  import AddMetricModal from '../../modals/AddMetricModal.svelte';

  export let employeeId;

  const dispatch = createEventDispatcher();

  let employeeData = null;
  let rawEmployeeData = null;
  let detailStats = {};
  let qdcData = [];
  let nganhHangData = [];
  
  let kpiCounts = {
      'Doanh thu': { above: 0, total: 0 },
      'Hi·ªáu qu·∫£ khai th√°c': { above: 0, total: 0 },
      'NƒÉng su·∫•t': { above: 0, total: 0 },
      'ƒê∆°n gi√°': { above: 0, total: 0 }
  };
  
  // State qu·∫£n l√Ω hi·ªÉn th·ªã Modal
  let isEffModalOpen = false;
  let isMetricModalOpen = false;
  let itemToEdit = null;

  // [KH√îI PH·ª§C] Hai d√≤ng quan tr·ªçng b·ªã thi·∫øu g√¢y l·ªói ReferenceError
  $: totalAbove = Object.values(kpiCounts).reduce((sum, item) => sum + item.above, 0);
  $: totalCriteria = Object.values(kpiCounts).reduce((sum, item) => sum + item.total, 0);

  // Logic t·∫£i d·ªØ li·ªáu t·ª´ Cloud khi Warehouse thay ƒë·ªïi
  $: if ($selectedWarehouse) {
      loadMetricsFromCloud($selectedWarehouse);
  }

  async function loadMetricsFromCloud(kho) {
      const data = await datasyncService.loadCustomMetrics(kho);
      warehouseCustomMetrics.set(data);
  }

  // Reactive: T√≠nh to√°n l·∫°i khi Store metrics thay ƒë·ªïi HO·∫∂C employeeId thay ƒë·ªïi
  $: calculateEmployeeData(employeeId, $masterReportData, $warehouseCustomMetrics);

  function calculateEmployeeData(id, masterData, metrics) {
      if (!id || masterData.sknv.length === 0) return;

      const rawEmployee = masterData.sknv.find(e => String(e.maNV) === String(id));
      
      if (rawEmployee) {
          rawEmployeeData = rawEmployee;
          const deptAvg = sknvService.calculateDepartmentAverages(rawEmployee.boPhan, masterData.sknv);
          
          // T√≠nh to√°n c√°c ch·ªâ s·ªë custom (L·∫•y t·ª´ Store)
          if(metrics && metrics.length > 0) {
              const departmentEmployees = masterData.sknv.filter(e => e.boPhan === rawEmployee.boPhan);
              metrics.forEach(m => {
                  let totalVal = 0;
                  let count = 0;
                  departmentEmployees.forEach(emp => {
                      totalVal += sknvService.calculateDynamicMetricValue(emp, m);
                      count++;
                  });
                  deptAvg[`custom_${m.id}`] = count > 0 ? totalVal / count : 0;
              });
          }

          // G√°n d·ªØ li·ªáu
          employeeData = rawEmployee;
          detailStats = sknvService.getDetailStats(rawEmployee, deptAvg, metrics);

          if (rawEmployee.qdc) {
              qdcData = Object.entries(rawEmployee.qdc)
                  .map(([id, val]) => ({ id, ...val }))
                  .filter(item => (item.sl || 0) > 0)
                  .sort((a, b) => b.dtqd - a.dtqd);
          } else { qdcData = []; }

          if (rawEmployee.doanhThuTheoNganhHang) {
              nganhHangData = Object.entries(rawEmployee.doanhThuTheoNganhHang)
                  .map(([name, val]) => ({ name, ...val }))
                  .filter(item => (item.revenue || 0) > 0)
                  .sort((a, b) => b.revenue - a.revenue);
          } else { nganhHangData = []; }
      }
  }

  function handleCountUpdate(event) {
      const { title, above, total } = event.detail;
      let key = title;
      if (title === 'Hi·ªáu qu·∫£') key = 'Hi·ªáu qu·∫£ khai th√°c'; 
      if (kpiCounts[key]) {
          kpiCounts[key] = { above, total };
          kpiCounts = { ...kpiCounts };
      }
  }

  function handleEditMetric(event) {
      const metricItem = event.detail;
      if (metricItem && metricItem.rawConfig) {
          itemToEdit = metricItem.rawConfig;
          if (metricItem.rawConfig.type === 'UNIT_PRICE') {
              isMetricModalOpen = true;
          } else {
              isEffModalOpen = true;
          }
      }
  }

  async function handleDeleteMetric(event) {
      const idToDelete = event.detail;
      if (confirm("B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a ch·ªâ s·ªë n√†y kh√¥ng?")) {
          // X√≥a kh·ªèi Store v√† Cloud
          const newMetrics = $warehouseCustomMetrics.filter(m => m.id !== idToDelete);
          warehouseCustomMetrics.set(newMetrics);
          
          if ($selectedWarehouse) {
              await datasyncService.saveCustomMetrics($selectedWarehouse, newMetrics);
          }
      }
  }

  async function handleSaveMetric(event) {
      const savedMetric = event.detail;
      let currentMetrics = [...$warehouseCustomMetrics]; 
      
      const existingIndex = currentMetrics.findIndex(m => m.id === savedMetric.id);
      
      if (existingIndex >= 0) {
          currentMetrics[existingIndex] = savedMetric;
      } else {
          currentMetrics = [...currentMetrics, savedMetric];
      }
      
      // C·∫≠p nh·∫≠t Store v√† L∆∞u Cloud
      warehouseCustomMetrics.set(currentMetrics);
      if ($selectedWarehouse) {
          await datasyncService.saveCustomMetrics($selectedWarehouse, currentMetrics);
      }
      
      itemToEdit = null;
  }

  function handleCloseModal() {
      isEffModalOpen = false;
      isMetricModalOpen = false;
      itemToEdit = null;
  }

  function goBack() { dispatch('back'); }

  afterUpdate(() => { if (window.feather) window.feather.replace(); });
</script>

<div class="animate-fade-in pb-10 max-w-7xl mx-auto">
    <div class="mb-4">
        <button on:click={goBack} class="text-blue-600 hover:underline font-semibold flex items-center gap-1">
           <i data-feather="chevron-left" class="w-4 h-4"></i> Quay l·∫°i b·∫£ng t·ªïng h·ª£p
        </button>
    </div>

    {#if employeeData}
        <DetailHeader employee={employeeData} {totalAbove} {totalCriteria} showStats={true} />

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-6 items-start">
            <div class="space-y-6">
                <MetricGrid 
                    title="Doanh thu" icon="trending-up" colorClass="sknv-header-blue" 
                    data={detailStats.doanhThu || []} 
                    on:updateCount={handleCountUpdate} 
                />
                
                <MetricGrid 
                    title="Hi·ªáu qu·∫£ khai th√°c" icon="award" colorClass="sknv-header-orange" 
                    data={detailStats.hieuQua || []} 
                    allowAdd={true}
                    on:add={() => { itemToEdit = null; isEffModalOpen = true; }} 
                    on:edit={handleEditMetric}
                    on:delete={handleDeleteMetric}
                    on:updateCount={handleCountUpdate} 
                />
            </div>
            <div class="space-y-6">
                <MetricGrid 
                    title="NƒÉng su·∫•t" icon="dollar-sign" colorClass="sknv-header-green" 
                    data={detailStats.nangSuat || []} 
                    on:updateCount={handleCountUpdate} 
                />
                
                <MetricGrid 
                    title="ƒê∆°n gi√°" icon="tag" colorClass="sknv-header-yellow" 
                    data={detailStats.donGia || []}
                    allowAdd={true}
                    on:add={() => { itemToEdit = null; isMetricModalOpen = true; }} 
                    on:edit={handleEditMetric}
                    on:delete={handleDeleteMetric}
                    on:updateCount={handleCountUpdate} 
                />
            </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-6 items-start">
            <DetailTableQDC data={qdcData} rawEmployee={rawEmployeeData} />
            <DetailTableCategory data={nganhHangData} rawEmployee={rawEmployeeData} />
        </div>

    {:else}
        <div class="p-12 text-center bg-red-50 rounded-lg border border-red-200">
            <p class="text-red-600 font-semibold">Kh√¥ng t√¨m th·∫•y d·ªØ li·ªáu cho nh√¢n vi√™n n√†y.</p>
        </div>
    {/if}
</div>

<AddEfficiencyColumnModal 
    isOpen={isEffModalOpen} 
    editItem={itemToEdit} 
    on:close={handleCloseModal}
    on:save={handleSaveMetric}
/>

<AddMetricModal
    isOpen={isMetricModalOpen}
    editItem={itemToEdit}
    on:close={handleCloseModal}
    on:save={handleSaveMetric}
/>

<style>
    :global(.sknv-header-blue) { background-color: #2563eb; }
    :global(.sknv-header-green) { background-color: #16a34a; }
    :global(.sknv-header-orange) { background-color: #f97316; }
    :global(.sknv-header-yellow) { background-color: #ca8a04; }
    .animate-fade-in { animation: fadeIn 0.3s ease-out; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
</style>
<<< FILE_END: src/components/health-staff/detail/DetailView.svelte

>>> FILE_START: src/components/health-staff/detail/MetricGrid.svelte
<script>
  import { afterUpdate, createEventDispatcher } from 'svelte';
  import EvaluationBadge from '../shared/EvaluationBadge.svelte';
  import CardFilter from './CardFilter.svelte';

  export let title = '';
  export let icon = '';
  export let colorClass = 'sknv-header-blue';
  export let data = []; // Array of metrics { id, label, value, average, ... }
  export let allowAdd = false; 

  const dispatch = createEventDispatcher();

  let sortKey = 'label';
  let sortDirection = 'asc';
  
  // Tr·∫°ng th√°i hi·ªÉn th·ªã c·ª•c b·ªô
  let visibilityState = {};

  $: {
      if(data) {
          data.forEach(item => {
              if (visibilityState[item.id] === undefined) {
                  visibilityState[item.id] = true;
              }
          });
          calculateAndEmitCount();
      }
  }

  function handleSort(key) {
    if (sortKey === key) {
      sortDirection = sortDirection === 'desc' ? 'asc' : 'desc';
    } else {
      sortKey = key;
      sortDirection = 'asc';
    }
  }

  function handleFilterChange(event) {
      const id = event.detail;
      visibilityState[id] = !visibilityState[id];
      visibilityState = { ...visibilityState }; 
      calculateAndEmitCount();
  }

  function calculateAndEmitCount() {
      const visibleItems = data.filter(item => visibilityState[item.id] !== false);
      const aboveCount = visibleItems.filter(item => isAboveAverage(item.rawValue, item.rawAverage)).length;
      const totalCount = visibleItems.length;
      dispatch('updateCount', { title, above: aboveCount, total: totalCount });
  }

  function isAboveAverage(val, avg) {
      if (!isFinite(val) || avg === undefined || !isFinite(avg)) return false;
      return val >= avg;
  }

  $: sortedData = [...data]
      .filter(item => visibilityState[item.id] !== false)
      .sort((a, b) => {
          let valA, valB;
          if (sortKey === 'label') {
              valA = a.label || ''; valB = b.label || '';
              return sortDirection === 'asc' ? valA.localeCompare(valB) : valB.localeCompare(valA);
          } else if (sortKey === 'value') {
              valA = a.rawValue || 0; valB = b.rawValue || 0;
          } else {
              valA = a.rawAverage || 0; valB = b.rawAverage || 0;
          }
          return sortDirection === 'asc' ? valA - valB : valB - valA;
      });

  afterUpdate(() => {
      if (typeof feather !== 'undefined') feather.replace();
  });
</script>

<div class="bg-white rounded-xl shadow-md border border-gray-200 overflow-hidden h-full flex flex-col">
    <div class="sknv-detail-card-header {colorClass} flex justify-between items-center p-3 text-white">
        <div class="flex items-center gap-2">
            <i data-feather={icon} class="w-5 h-5"></i>
            <h4 class="text-lg font-bold">{title}</h4>
        </div>
        
        <div class="flex items-center gap-1">
            {#if allowAdd}
                <button 
                    class="text-white/80 hover:text-white hover:bg-white/20 p-1 rounded-full transition-colors"
                    title="Th√™m ch·ªâ s·ªë m·ªõi"
                    on:click={() => dispatch('add')}
                >
                    <i data-feather="plus" class="w-4 h-4"></i>
                </button>
            {/if}
            
            <CardFilter 
                items={data.map(i => ({ id: i.id, label: i.label, visible: visibilityState[i.id] !== false }))} 
                on:change={handleFilterChange} 
            />
        </div>
    </div>
    
    <div class="overflow-x-auto flex-grow">
        <table class="w-full text-sm">
            <thead class="bg-gray-50 border-b border-gray-200">
                <tr>
                    <th class="px-3 py-2 text-left font-semibold text-gray-600 cursor-pointer hover:bg-gray-100 select-none" on:click={() => handleSort('label')}>
                        Ch·ªâ s·ªë {sortKey==='label' ? (sortDirection==='asc' ? '‚ñ≤' : '‚ñº') : ''}
                    </th>
                    <th class="px-3 py-2 text-right font-semibold text-gray-600 cursor-pointer hover:bg-gray-100 select-none" on:click={() => handleSort('value')}>
                        Th·ª±c hi·ªán {sortKey==='value' ? (sortDirection==='asc' ? '‚ñ≤' : '‚ñº') : ''}
                    </th>
                    <th class="px-3 py-2 text-right font-semibold text-gray-600 cursor-pointer hover:bg-gray-100 select-none" on:click={() => handleSort('average')}>
                        Trung b√¨nh {sortKey==='average' ? (sortDirection==='asc' ? '‚ñ≤' : '‚ñº') : ''}
                    </th>
                    <th class="px-3 py-2 text-right font-semibold text-gray-600">ƒê√°nh gi√°</th>
                </tr>
            </thead>
            <tbody class="divide-y divide-gray-100">
                {#if sortedData.length === 0}
                    <tr><td colspan="4" class="p-4 text-center text-gray-400 italic text-xs">ƒê√£ ·∫©n t·∫•t c·∫£ ch·ªâ s·ªë.</td></tr>
                {:else}
                    {#each sortedData as row (row.id)}
                        <tr class="hover:bg-slate-50 transition-colors group/row">
                            <td class="px-3 py-2 font-medium text-gray-700 flex items-center gap-1">
                                {row.label}
                                {#if row.isCustom}
                                    <span class="text-[10px] px-1.5 py-0.5 rounded bg-blue-100 text-blue-700 font-bold whitespace-nowrap">M·ªõi</span>
                                    <div class="flex gap-1 ml-2 opacity-0 group-hover/row:opacity-100 transition-opacity">
                                        <button 
                                            class="p-1 text-gray-400 hover:text-blue-600 rounded hover:bg-blue-50" 
                                            title="S·ª≠a"
                                            on:click|stopPropagation={() => dispatch('edit', row)}
                                        >
                                            <i data-feather="edit-2" class="w-3 h-3"></i>
                                        </button>
                                        <button 
                                            class="p-1 text-gray-400 hover:text-red-600 rounded hover:bg-red-50" 
                                            title="X√≥a"
                                            on:click|stopPropagation={() => dispatch('delete', row.id)}
                                        >
                                            <i data-feather="trash-2" class="w-3 h-3"></i>
                                        </button>
                                    </div>
                                {/if}
                            </td>
                            <td class="px-3 py-2 text-right font-bold text-gray-900 {row.valueClass || ''}">{row.value}</td>
                            <td class="px-3 py-2 text-right text-gray-500 italic">{row.average}</td>
                            <td class="px-3 py-2 text-right">
                                <EvaluationBadge isAbove={isAboveAverage(row.rawValue, row.rawAverage)} />
                            </td>
                        </tr>
                    {/each}
                {/if}
            </tbody>
        </table>
    </div>
</div>
<<< FILE_END: src/components/health-staff/detail/MetricGrid.svelte

>>> FILE_START: src/components/health-staff/installment/InstallmentDetailModal.svelte
<script>
    import { createEventDispatcher } from 'svelte';
    import { fade, fly } from 'svelte/transition';

    export let isOpen = false;
    export let employee = null;

    const dispatch = createEventDispatcher();

    let searchTerm = '';
    let sortMode = 'installment'; // 'installment' | 'revenue' | 'name'

    function close() {
        dispatch('close');
    }

    const formatRevenue = (amount) => {
        if (!amount) return '0';
        const val = amount / 1000000;
        return val.toLocaleString('vi-VN', { maximumFractionDigits: 6 });
    };

    $: totalOrders = employee?.processedCustomers 
        ? employee.processedCustomers.reduce((sum, c) => sum + c.totalOrders, 0) 
        : 0;
    
    $: installmentCount = employee?.stats?.installmentTotal || 0;
    $: approvalRate = employee?.stats?.approvalRate || 0;

    // Helper check ƒëi·ªÅu ki·ªán ghi nh·∫≠n doanh thu
    const isValidRevenue = (order) => {
        const statusHuy = order.trangThaiHuy ? order.trangThaiHuy.toString().trim().toLowerCase() : '';
        const statusThu = order.trangThaiThuTien ? order.trangThaiThuTien.toString().trim().toLowerCase() : '';
        return statusThu === 'ƒë√£ thu' && statusHuy !== 'ƒë√£ h·ªßy';
    };

    // Helper check h·ªßy ƒë·ªÉ hi·ªÉn th·ªã UI
    const isCancelled = (order) => {
        const status = order.trangThaiHuy ? order.trangThaiHuy.toString().trim().toLowerCase() : '';
        return status === 'ƒë√£ h·ªßy';
    };

    // H√†m s·∫Øp x·∫øp
    $: sortedCustomers = employee?.processedCustomers 
        ? [...employee.processedCustomers].filter(c => 
            c.name.toLowerCase().includes(searchTerm.toLowerCase())
          ).sort((a, b) => {
            if (sortMode === 'installment') {
                return b.installmentCount - a.installmentCount || b.totalOrders - a.totalOrders;
            } else if (sortMode === 'revenue') {
                const revA = a.orders.reduce((sum, o) => sum + (isValidRevenue(o) ? (parseInt(o.thanhTien) || 0) : 0), 0);
                const revB = b.orders.reduce((sum, o) => sum + (isValidRevenue(o) ? (parseInt(o.thanhTien) || 0) : 0), 0);
                return revB - revA;
            } else {
                return a.name.localeCompare(b.name);
            }
        })
        : [];

    const getCustomerRevenue = (orders) => {
        return orders.reduce((sum, o) => sum + (isValidRevenue(o) ? (parseInt(o.thanhTien) || 0) : 0), 0);
    };

    const getOrderSummary = (cust) => {
        const cash = cust.totalOrders - cust.installmentCount;
        let parts = [];
        if (cash > 0) parts.push(`${cash} Ti·ªÅn m·∫∑t`);
        if (cust.installmentCount > 0) parts.push(`${cust.installmentCount} Tr·∫£ ch·∫≠m`);
        return parts.join(', ');
    };
</script>

{#if isOpen && employee}
    <div class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50" transition:fade>
        <div 
            class="bg-white rounded-lg shadow-xl w-full max-w-5xl h-[90vh] flex flex-col"
            transition:fly={{ y: 50, duration: 300 }}
        >
            <div class="p-4 border-b flex justify-between items-center bg-gray-50 rounded-t-lg">
                <div>
                    <h3 class="text-lg font-bold text-gray-800">
                        Chi ti·∫øt: {employee.name}
                    </h3>
                    <div class="text-sm text-gray-500 mt-1 flex gap-4">
                        <span>T·ªïng ƒë∆°n: <strong class="text-blue-600">{totalOrders}</strong></span>
                        <span>Tr·∫£ ch·∫≠m: <strong class="text-purple-600">{installmentCount}</strong></span>
                        <span>T·ª∑ l·ªá duy·ªát: 
                            <span class="{parseFloat(approvalRate) >= 50 ? 'text-green-600' : 'text-red-600'} font-bold">
                                {approvalRate}%
                            </span>
                        </span>
                    </div>
                </div>
                <button on:click={close} class="text-gray-400 hover:text-red-500 text-2xl">&times;</button>
            </div>

            <div class="p-4 border-b bg-white flex flex-col md:flex-row gap-3 items-center justify-between">
                <div class="relative w-full md:w-1/3">
                    <input 
                        type="text" 
                        bind:value={searchTerm}
                        placeholder="T√¨m t√™n kh√°ch h√†ng..." 
                        class="w-full pl-3 pr-10 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm"
                    />
                </div>
                
                <div class="flex gap-2">
                    <button 
                        class="px-3 py-2 text-sm rounded border {sortMode === 'installment' ? 'bg-purple-100 text-purple-700 border-purple-300 font-bold' : 'bg-gray-100 text-gray-600'}"
                        on:click={() => sortMode = 'installment'}
                    >
                        Sort: Tr·∫£ ch·∫≠m (H·ªì s∆°)
                    </button>
                    <button 
                        class="px-3 py-2 text-sm rounded border {sortMode === 'revenue' ? 'bg-green-100 text-green-700 border-green-300 font-bold' : 'bg-gray-100 text-gray-600'}"
                        on:click={() => sortMode = 'revenue'}
                    >
                        Sort: Doanh thu
                    </button>
                </div>
            </div>

            <div class="flex-1 overflow-auto p-4 bg-gray-50">
                <div class="bg-white rounded shadow border">
                    <table class="w-full text-sm text-left">
                        <thead class="bg-gray-100 text-gray-600 font-semibold sticky top-0 shadow-sm z-10">
                            <tr>
                                <th class="p-3 border-b">Kh√°ch h√†ng</th>
                                <th class="p-3 border-b text-center">Ph√¢n lo·∫°i ƒë∆°n</th>
                                <th class="p-3 border-b text-center">H·ªì s∆° Tr·∫£ ch·∫≠m</th>
                                <th class="p-3 border-b text-right">Doanh thu th·ª±c</th>
                                <th class="p-3 border-b">Chi ti·∫øt tr·∫°ng th√°i</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y">
                            {#each sortedCustomers as cust}
                                <tr class="hover:bg-gray-50">
                                    <td class="p-3 font-medium text-gray-800">
                                        {cust.name}
                                        <div class="text-xs text-gray-400 font-normal">{cust.orders.length} ƒë∆°n h√†ng</div>
                                    </td>
                                    
                                    <td class="p-3 text-center">
                                        <span class="px-2 py-1 bg-gray-100 rounded text-xs">
                                            {getOrderSummary(cust)}
                                        </span>
                                    </td>

                                    <td class="p-3 text-center">
                                        {#if cust.installmentCount > 0}
                                            <div class="inline-flex flex-col items-center">
                                                <span class="font-bold text-lg text-purple-600">{cust.installmentCount}</span>
                                                <span class="text-[10px] text-gray-500">l·∫ßn l√™n h·ªì s∆°</span>
                                                {#if cust.installmentCount > 1}
                                                    <span class="text-[10px] text-orange-500 font-semibold">(C√≥ tr√πng l·∫∑p)</span>
                                                {/if}
                                            </div>
                                        {:else}
                                            <span class="text-gray-300">-</span>
                                        {/if}
                                    </td>

                                    <td class="p-3 text-right font-medium text-gray-700">
                                        {formatRevenue(getCustomerRevenue(cust.orders))}
                                    </td>

                                    <td class="p-3 text-xs">
                                        <div class="flex flex-col gap-1">
                                            {#each cust.orders as order}
                                                <div class="flex items-center gap-2 border-b border-dashed border-gray-100 pb-1 last:border-0 last:pb-0">
                                                    {#if order._isInstallment}
                                                        <span class="w-16 flex-shrink-0 px-1 py-0.5 rounded text-[10px] text-center {order._isSuccess ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'}">
                                                            {order._isSuccess ? 'ƒê·∫¨U' : 'R·ªöT/H·ª¶Y'}
                                                        </span>
                                                    {:else}
                                                        <span class="w-16 flex-shrink-0 px-1 py-0.5 rounded text-[10px] text-center bg-blue-100 text-blue-700">
                                                            Ti·ªÅn m·∫∑t
                                                        </span>
                                                    {/if}
                                                    <span class="truncate max-w-[150px]" title={order.tenSanPham}>{order.tenSanPham}</span>
                                                </div>
                                            {/each}
                                        </div>
                                    </td>
                                </tr>
                            {/each}
                            
                            {#if sortedCustomers.length === 0}
                                <tr>
                                    <td colspan="5" class="p-8 text-center text-gray-400">Kh√¥ng t√¨m th·∫•y d·ªØ li·ªáu</td>
                                </tr>
                            {/if}
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="p-4 border-t bg-gray-50 flex justify-end rounded-b-lg">
                <button 
                    on:click={close}
                    class="px-6 py-2 bg-white border border-gray-300 text-gray-700 rounded hover:bg-gray-100 font-medium"
                >
                    ƒê√≥ng
                </button>
            </div>
        </div>
    </div>
{/if}
<<< FILE_END: src/components/health-staff/installment/InstallmentDetailModal.svelte

>>> FILE_START: src/components/health-staff/installment/InstallmentView.svelte
<script>
    import { ycxData, selectedWarehouse, danhSachNhanVien } from '../../../stores.js';
    import { processInstallmentReport } from '../../../services/reports/installment.report.js';
    import { formatters } from '../../../utils/formatters.js';
    import InstallmentDetailModal from './InstallmentDetailModal.svelte';

    export let reportData = [];
    export let inputData = undefined; // Input cho Realtime

    let viewData = {
        kpi: { totalOrders: 0, totalInstallment: 0, totalSuccess: 0, approvalRate: 0 },
        employees: []
    };
    let isModalOpen = false;
    let selectedEmployee = null;
    let sortKey = 'installmentTotal';
    let sortDirection = 'desc';

    const smartMapOrders = (rawOrders, employees) => {
        const empMap = {};
        employees.forEach(e => {
            const empObj = {
                ...e,
                orders: [],
                stats: { 
                    ...e.stats, 
                    totalRevenue: 0,
                    installmentTotal: 0, installmentSuccess: 0, installmentFail: 0, 
                    installmentRevenueRaw: 0, installmentRevenueWeighted: 0 
                }
            };
            
            if (e.maNV) {
                const key = e.maNV.toString().trim();
                empMap[key] = empObj;
            }
        });

        rawOrders.forEach(order => {
            const creator = order.nguoiTao || '';
            let foundEmp = null;
            const matchId = creator.match(/(\d+)/); 
            if (matchId && matchId[1]) {
                const extractedId = matchId[1];
                if (empMap[extractedId]) foundEmp = empMap[extractedId];
            }
            if (foundEmp) {
                foundEmp.orders.push(order);
            }
        });

        return Object.values(empMap).filter(e => e.orders.length > 0);
    };

    function handleSort(key) {
        if (sortKey === key) {
            sortDirection = sortDirection === 'desc' ? 'asc' : 'desc';
        } else {
            sortKey = key;
            sortDirection = 'desc';
        }
    }

    // Reactive Logic
    $: {
        const sourceData = inputData !== undefined ? inputData : $ycxData;
        if (sourceData.length > 0 && $danhSachNhanVien.length > 0) {
            let targetEmployees = $danhSachNhanVien;
            if ($selectedWarehouse) {
                targetEmployees = targetEmployees.filter(e => (e.maKho || e.boPhan || '') == $selectedWarehouse);
            }
            const employeesWithOrders = smartMapOrders(sourceData, targetEmployees);
            viewData = processInstallmentReport(employeesWithOrders);
        } else {
            viewData = { kpi: { totalOrders: 0, totalInstallment: 0, totalSuccess: 0, approvalRate: 0 }, employees: [] };
        }
    }

    const calcInstallmentPercent = (emp) => {
        if (!emp.stats.totalRevenue || emp.stats.totalRevenue === 0) return 0;
        return (emp.stats.installmentRevenueRaw / emp.stats.totalRevenue) * 100;
    };

    $: sortedEmployees = [...viewData.employees].sort((a, b) => {
        let valA, valB;
        switch (sortKey) {
            case 'hoTen': 
                valA = a.hoTen || ''; valB = b.hoTen || ''; break;
            case 'totalOrders':
                valA = a.processedCustomers.reduce((sum, c) => sum + c.totalOrders, 0); 
                valB = b.processedCustomers.reduce((sum, c) => sum + c.totalOrders, 0); break;
            case 'totalRevenue': 
                valA = a.stats.totalRevenue; valB = b.stats.totalRevenue; break;
            case 'installmentRevenueWeighted': 
                valA = a.stats.installmentRevenueWeighted; valB = b.stats.installmentRevenueWeighted; break;
            case 'installmentPercent': 
                valA = calcInstallmentPercent(a); valB = calcInstallmentPercent(b); break;
            case 'approvalRate':
                valA = parseFloat(a.stats.approvalRate); valB = parseFloat(b.stats.approvalRate); break;
            default:
                valA = a.stats[sortKey] || 0; valB = b.stats[sortKey] || 0;
        }
        if (valA < valB) return sortDirection === 'asc' ? -1 : 1;
        if (valA > valB) return sortDirection === 'asc' ? 1 : -1;
        return 0;
    });

    function openDetail(employee) {
        selectedEmployee = {
            ...employee,
            name: formatters.getShortEmployeeName(employee.hoTen, employee.maNV)
        };
        isModalOpen = true;
    }
    function closeDetail() { isModalOpen = false; selectedEmployee = null; }
</script>

<div class="space-y-6" data-capture-preset="mobile-portrait">
    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
        <div class="bg-white p-4 rounded-lg shadow border-l-4 border-blue-500">
            <div class="text-gray-500 text-sm font-medium uppercase">T·ªïng ƒë∆°n h√†ng</div>
            <div class="mt-2 text-3xl font-bold text-gray-800">{viewData.kpi.totalOrders}</div>
        </div>
        <div class="bg-white p-4 rounded-lg shadow border-l-4 border-purple-500">
            <div class="text-gray-500 text-sm font-medium uppercase">H·ªì s∆° Tr·∫£ ch·∫≠m</div>
            <div class="mt-2 text-3xl font-bold text-purple-600">{viewData.kpi.totalInstallment}</div>
        </div>
        <div class="bg-white p-4 rounded-lg shadow border-l-4 border-green-500">
            <div class="text-gray-500 text-sm font-medium uppercase">ƒê·∫≠u / ƒê√£ thu</div>
            <div class="mt-2 text-3xl font-bold text-green-600">{viewData.kpi.totalSuccess}</div>
            <div class="text-xs text-gray-400 mt-1">ƒê√£ tr·ª´ ƒë∆°n h·ªßy</div>
        </div>
        <div class="bg-white p-4 rounded-lg shadow border-l-4 {parseFloat(viewData.kpi.approvalRate) >= 50 ? 'border-teal-500' : 'border-red-500'}">
            <div class="text-gray-500 text-sm font-medium uppercase">T·ª∑ l·ªá duy·ªát</div>
            <div class="mt-2 flex items-baseline gap-2">
                <span class="text-3xl font-bold {parseFloat(viewData.kpi.approvalRate) >= 50 ? 'text-teal-600' : 'text-red-600'}">
                    {viewData.kpi.approvalRate}%
                </span>
            </div>
            <div class="text-xs text-gray-400 mt-1">tr√™n t·ªïng h·ªì s∆° tr·∫£ ch·∫≠m</div>
        </div>
    </div>

    <div class="bg-white rounded-lg shadow overflow-hidden border border-gray-200">
        <div class="p-4 border-b bg-gray-50 flex justify-between items-center">
            <h3 class="font-bold text-gray-700">Chi ti·∫øt theo nh√¢n vi√™n</h3>
            <span class="text-xs text-gray-500 italic">* Click ti√™u ƒë·ªÅ ƒë·ªÉ s·∫Øp x·∫øp</span>
        </div>
        <div class="overflow-x-auto">
            <table class="w-full text-sm text-left border-collapse">
                <thead class="bg-gray-100 text-gray-600 font-semibold uppercase text-xs sticky top-0">
                    <tr>
                        <th class="p-3 border-b border-r border-gray-200 cursor-pointer hover:bg-gray-200 transition select-none" on:click={() => handleSort('hoTen')}>
                            Nh√¢n vi√™n {sortKey === 'hoTen' ? (sortDirection === 'asc' ? '‚Üë' : '‚Üì') : ''}
                        </th>
                        <th class="p-3 border-b border-r border-gray-200 text-center cursor-pointer hover:bg-gray-200 transition select-none" on:click={() => handleSort('totalOrders')}>
                            T·ªïng ƒë∆°n {sortKey === 'totalOrders' ? (sortDirection === 'asc' ? '‚Üë' : '‚Üì') : ''}
                        </th>
                        <th class="p-3 border-b border-r border-gray-200 text-center bg-purple-50 cursor-pointer hover:bg-purple-100 transition select-none" on:click={() => handleSort('installmentTotal')}>
                            SL Tr·∫£ ch·∫≠m {sortKey === 'installmentTotal' ? (sortDirection === 'asc' ? '‚Üë' : '‚Üì') : ''}
                        </th>
                        <th class="p-3 border-b border-r border-gray-200 text-center cursor-pointer hover:bg-gray-200 transition select-none" on:click={() => handleSort('installmentSuccess')}>
                            SL ƒê·∫≠u {sortKey === 'installmentSuccess' ? (sortDirection === 'asc' ? '‚Üë' : '‚Üì') : ''}
                        </th>
                        <th class="p-3 border-b border-r border-gray-200 text-center cursor-pointer hover:bg-gray-200 transition select-none" on:click={() => handleSort('installmentFail')}>
                            R·ªõt/H·ªßy {sortKey === 'installmentFail' ? (sortDirection === 'asc' ? '‚Üë' : '‚Üì') : ''}
                        </th>
                        <th class="p-3 border-b border-r border-gray-200 text-center cursor-pointer hover:bg-gray-200 transition select-none" on:click={() => handleSort('approvalRate')}>
                            T·ª∑ l·ªá duy·ªát {sortKey === 'approvalRate' ? (sortDirection === 'asc' ? '‚Üë' : '‚Üì') : ''}
                        </th>
                        <th class="p-3 border-b border-r border-gray-200 text-right cursor-pointer hover:bg-gray-200 transition select-none" on:click={() => handleSort('totalRevenue')}>
                            DT Th·ª±c {sortKey === 'totalRevenue' ? (sortDirection === 'asc' ? '‚Üë' : '‚Üì') : ''}
                        </th>
                        <th class="p-3 border-b border-r border-gray-200 text-right cursor-pointer hover:bg-gray-200 transition select-none" on:click={() => handleSort('installmentRevenueWeighted')}>
                            DT Tr·∫£ ch·∫≠m (30%) {sortKey === 'installmentRevenueWeighted' ? (sortDirection === 'asc' ? '‚Üë' : '‚Üì') : ''}
                        </th>
                        <th class="p-3 border-b border-gray-200 text-center cursor-pointer hover:bg-gray-200 transition select-none" on:click={() => handleSort('installmentPercent')}>
                            % Tr·∫£ ch·∫≠m {sortKey === 'installmentPercent' ? (sortDirection === 'asc' ? '‚Üë' : '‚Üì') : ''}
                        </th>
                    </tr>
                </thead>
                <tbody class="divide-y">
                    {#each sortedEmployees as emp}
                        <tr class="hover:bg-blue-50 transition-colors group">
                            <td class="p-3 font-medium text-blue-700 cursor-pointer border-r border-gray-200" on:click={() => openDetail(emp)}>
                                {formatters.getShortEmployeeName(emp.hoTen, emp.maNV)}
                            </td>
                            <td class="p-3 text-center text-gray-600 border-r border-gray-200">
                                {emp.processedCustomers.reduce((sum, c) => sum + c.totalOrders, 0)}
                            </td>
                            <td class="p-3 text-center bg-purple-50 font-bold text-purple-700 border-r border-gray-200">{emp.stats.installmentTotal}</td>
                            <td class="p-3 text-center text-green-600 font-bold border-r border-gray-200">{emp.stats.installmentSuccess}</td>
                            <td class="p-3 text-center text-red-500 border-r border-gray-200">{emp.stats.installmentFail}</td>
                            <td class="p-3 text-center border-r border-gray-200">
                                <span class="px-2 py-1 rounded text-xs font-bold {parseFloat(emp.stats.approvalRate) >= 50 ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'}">
                                    {emp.stats.approvalRate}%
                                </span>
                            </td>
                            <td class="p-3 text-right text-gray-800 font-medium border-r border-gray-200">
                                {Math.round(emp.stats.totalRevenue / 1000000)}
                            </td>
                            <td class="p-3 text-right font-medium text-gray-800 border-r border-gray-200">
                                {Math.round(emp.stats.installmentRevenueWeighted / 1000000)}
                            </td>
                            <td class="p-3 text-center font-bold text-blue-600">
                                {calcInstallmentPercent(emp).toFixed(1)}%
                            </td>
                        </tr>
                    {/each}
                    {#if sortedEmployees.length === 0}
                    <tr><td colspan="9" class="p-8 text-center text-gray-400">Kh√¥ng c√≥ d·ªØ li·ªáu</td></tr>
                    {/if}
                </tbody>
            </table>
        </div>
    </div>
</div>

<InstallmentDetailModal isOpen={isModalOpen} employee={selectedEmployee} on:close={closeDetail} />
<<< FILE_END: src/components/health-staff/installment/InstallmentView.svelte

>>> FILE_START: src/components/health-staff/performance/DynamicPerformanceTable.svelte
<script>
    import { createEventDispatcher } from 'svelte';
    import { formatters } from '../../../utils/formatters.js';
    import { dynamicTableProcessor } from '../../../services/processing/logic/dynamicTable.processor.js';
    import { isAdmin } from '../../../stores.js';
    
    // Components
    import SortableTh from '../../common/SortableTh.svelte';

    export let config = {};      // C·∫•u h√¨nh b·∫£ng (t·ª´ Admin/User)
    export let reportData = [];  // D·ªØ li·ªáu nh√¢n vi√™n (Master Data)
    export let colorTheme = 'blue';

    const dispatch = createEventDispatcher();

    // --- STATE ---
    let sortKey = 'hoTen';
    let sortDirection = 'asc';

    // --- PROCESSING ---
    // 1. Bi·∫øn ƒë·ªïi d·ªØ li·ªáu th√¥ -> D·ªØ li·ªáu hi·ªÉn th·ªã (k√®m logic t√≠nh %)
    $: processedResult = dynamicTableProcessor.processTableData(reportData, config);
    $: tableData = processedResult.processedData;
    $: totals = processedResult.totals;

    // 2. S·∫Øp x·∫øp
    $: sortedData = dynamicTableProcessor.sortTableData(tableData, sortKey, sortDirection);

    // --- HANDLERS ---
    function handleSort(event) {
        const key = event.detail;
        if (sortKey === key) sortDirection = sortDirection === 'desc' ? 'asc' : 'desc';
        else { sortKey = key; sortDirection = 'desc'; }
    }

    // --- STYLING HELPERS ---
    const themeMap = {
        blue: { header: 'bg-blue-50 border-blue-200', title: 'text-blue-800' },
        green: { header: 'bg-green-50 border-green-200', title: 'text-green-800' },
        orange: { header: 'bg-orange-50 border-orange-200', title: 'text-orange-800' },
        purple: { header: 'bg-purple-50 border-purple-200', title: 'text-purple-800' },
        teal: { header: 'bg-teal-50 border-teal-200', title: 'text-teal-800' },
    };
    $: theme = themeMap[colorTheme] || themeMap.blue;

    // H√†m l·∫•y m√†u s·∫Øc cho gi√° tr·ªã (So s√°nh v·ªõi Target n·∫øu l√† %)
    function getValueColor(cell, targetObj) {
        if (cell.config.type === 'PERCENT') {
            // L·∫•y target t·ª´ config b·∫£ng ho·∫∑c goal settings (n·∫øu c√≥ logic override)
            // ·ªû ƒë√¢y ta d√πng targetId ƒë·ªÉ map v√†o object mucTieu c·ªßa nh√¢n vi√™n
            const targetId = cell.config.targetId;
            const targetVal = targetId && targetObj && targetObj[targetId] 
                ? parseFloat(targetObj[targetId]) 
                : 0;

            const currentVal = cell.value * 100; // ƒê∆∞a v·ªÅ thang 100
            
            if (targetVal > 0) {
                return currentVal >= targetVal ? 'text-blue-600 font-bold' : 'text-red-600 font-bold bg-red-50';
            }
            return 'text-red-600'; // M·∫∑c ƒë·ªãnh % l√† m√†u ƒë·ªè (ho·∫∑c cam)
        }
        if (cell.config.type === 'SL') return 'text-gray-800';
        return 'text-blue-700 font-semibold'; // DT, DTQD
    }
</script>

<div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden h-full flex flex-col transition-all hover:shadow-md relative group/card">
    
    <div class="absolute top-3 right-3 opacity-0 group-hover/card:opacity-100 transition-opacity flex gap-1 z-20 bg-white/90 backdrop-blur rounded-lg p-1 shadow-sm border border-gray-100">
        {#if !config.isSystem || $isAdmin}
            <button class="p-1.5 text-gray-400 hover:text-blue-600 rounded hover:bg-blue-50" title="S·ª≠a" on:click|stopPropagation={() => dispatch('edit', config)}>
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" /></svg>
            </button>
            <button class="p-1.5 text-gray-400 hover:text-red-600 rounded hover:bg-red-50" title="X√≥a" on:click|stopPropagation={() => dispatch('delete', config.id)}>
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
            </button>
        {/if}
    </div>

    <div class="px-5 py-3 border-b {theme.header} flex justify-between items-center">
        <h4 class="text-base font-bold uppercase {theme.title} truncate flex items-center gap-2" title={config.title}>
            <i data-feather="bar-chart-2" class="w-4 h-4"></i> {config.title}
        </h4>
    </div>

    {#if sortedData.length === 0}
        <div class="flex-grow flex items-center justify-center p-8 bg-slate-50/30">
             <p class="text-gray-400 italic text-sm">Ch∆∞a c√≥ ph√°t sinh d·ªØ li·ªáu.</p>
        </div>
    {:else}
        <div class="overflow-x-auto flex-grow custom-scrollbar relative">
            <table class="min-w-full text-sm border-collapse border-0">
                <thead class="bg-gray-50 text-xs uppercase text-gray-600 font-bold sticky top-0 z-20 shadow-sm">
                    <tr>
                        <SortableTh 
                            key="hoTen" 
                            label="Nh√¢n vi√™n" 
                            className="sticky left-0 z-30 bg-gray-100 border-r border-b border-gray-300 min-w-[150px]" 
                            {sortKey} {sortDirection} 
                            on:sort={handleSort} 
                        />
                        
                        {#each config.columns as col (col.id)}
                            {@const bgClass = col.color ? `bg-${col.color}-50` : 'bg-gray-50'}
                            {@const textClass = col.color ? `text-${col.color}-800` : 'text-gray-700'}
                            <SortableTh 
                                key={col.id} 
                                label={col.header} 
                                align="right" 
                                className="{bgClass} {textClass} border-r border-b border-gray-200 min-w-[100px]" 
                                {sortKey} {sortDirection} 
                                on:sort={handleSort} 
                            />
                        {/each}
                    </tr>
                </thead>

                <tbody class="divide-y divide-gray-100">
                    {#each sortedData as row (row.maNV)}
                        <tr class="hover:bg-blue-50/50 transition-colors group">
                            <td class="px-3 py-2 font-semibold text-gray-700 border-r border-b border-gray-300 bg-white group-hover:bg-blue-50/50 sticky left-0 z-10 whitespace-nowrap shadow-[2px_0_5px_-2px_rgba(0,0,0,0.05)]">
                                <span class="text-blue-700 text-sm block truncate" title="{row.hoTen} - {row.maNV}">
                                    {formatters.getShortEmployeeName(row.hoTen, row.maNV)}
                                </span>
                            </td>

                            {#each config.columns as col (col.id)}
                                {@const cell = row.cells[col.id]}
                                <td class="px-2 py-2 text-right border-r border-gray-200 border-b {getValueColor(cell, row.mucTieu)}">
                                    {cell ? cell.display : '-'}
                                </td>
                            {/each}
                        </tr>
                    {/each}
                </tbody>

                <tfoot class="bg-gray-100 font-bold text-gray-800 border-t-2 border-gray-300 sticky bottom-0 z-20">
                    <tr>
                        <td class="px-3 py-2 sticky left-0 bg-gray-200 z-30 border-r border-gray-300">T·ªîNG</td>
                        {#each config.columns as col (col.id)}
                            <td class="px-2 py-2 text-right border-r border-gray-300 bg-gray-100">
                                {totals.cells[col.id]?.display || '-'}
                            </td>
                        {/each}
                    </tr>
                </tfoot>
            </table>
        </div>
    {/if}
</div>

<style>
    .custom-scrollbar::-webkit-scrollbar { width: 6px; height: 6px; }
    .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
    .custom-scrollbar::-webkit-scrollbar-thumb { background: #e5e7eb; border-radius: 3px; }
    .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #d1d5db; }
</style>
<<< FILE_END: src/components/health-staff/performance/DynamicPerformanceTable.svelte

>>> FILE_START: src/components/health-staff/performance/PerformanceView.svelte
<script>
    import { onMount } from 'svelte';
    import { customPerformanceTables, isAdmin, modalState, selectedWarehouse } from '../../../stores.js';
    import { adminService } from '../../../services/admin.service.js';
    import { datasyncService } from '../../../services/datasync.service.js';
    
    import DynamicPerformanceTable from './DynamicPerformanceTable.svelte';

    export let reportData = [];

    // [FIX 1] M·∫∑c ƒë·ªãnh l√† ƒëang t·∫£i ƒë·ªÉ tr√°nh hi·ªán th√¥ng b√°o l·ªói ngay khi m·ªü
    let isLoading = true;
    let lastLoadedWarehouse = '';

    // --- LOGIC LOAD D·ªÆ LI·ªÜU ---
    $: if ($selectedWarehouse) {
        handleWarehouseDataLoad($selectedWarehouse);
    }

    async function handleWarehouseDataLoad(kho) {
        // CASE 1: Store First - N·∫øu ƒë√£ c√≥ data ƒë√∫ng kho, kh√¥ng t·∫£i l·∫°i
        if ($customPerformanceTables.length > 0 && lastLoadedWarehouse === kho) {
             console.log(`[PerformanceView] D√πng Cache Store cho kho: ${kho}`);
             isLoading = false; // [FIX] T·∫Øt loading n·∫øu d√πng cache
             return;
        }
        // CASE 2: Fetch
        await loadData(kho);
    }

    async function loadData(kho) {
        isLoading = true; // [FIX] Lu√¥n b·∫≠t loading khi b·∫Øt ƒë·∫ßu t·∫£i
        try {
            // 1. Load System Tables (Admin)
            const sysTables = await adminService.loadSystemPerformanceTables();
            // 2. Load Personal Tables (User)
            const perTables = await datasyncService.loadPersonalPerformanceTables(kho);
            // 3. Load tr·∫°ng th√°i ·∫©n/hi·ªán local
            const hiddenIds = JSON.parse(localStorage.getItem('hiddenPerformanceTableIds') || '[]');
            // 4. Merge
            const merged = [
                ...sysTables.map(t => ({ ...t, isSystem: true, isVisible: !hiddenIds.includes(t.id) })),
                ...perTables.map(t => ({ ...t, isSystem: false, isVisible: true }))
            ];
            customPerformanceTables.set(merged);
            lastLoadedWarehouse = kho;

        } catch (e) {
            console.error("[PerformanceView] L·ªói t·∫£i d·ªØ li·ªáu:", e);
        } finally {
            isLoading = false; // [FIX] ƒê·∫£m b·∫£o lu√¥n t·∫Øt loading khi xong
        }
    }

    // --- VISIBILITY LOGIC ---
    function toggleTableVisibility(tableId) {
        customPerformanceTables.update(items => {
            const newItems = items.map(t => t.id === tableId ? { ...t, isVisible: !t.isVisible } : t);
            
            // Save preference for System tables
            const hiddenIds = newItems.filter(t => t.isSystem && !t.isVisible).map(t => t.id);
            localStorage.setItem('hiddenPerformanceTableIds', JSON.stringify(hiddenIds));
            
            return newItems;
        });
    }

    // --- CRUD ACTIONS ---
    function openAddModal() {
        if (!$selectedWarehouse) return alert("Vui l√≤ng ch·ªçn Kho tr∆∞·ªõc.");
        // M·ªü modal t·∫°o m·ªõi (User context)
        modalState.update(s => ({ ...s, activeModal: 'add-performance-table-modal', payload: null, isSystem: false }));
    }

    function editTable(table) {
        // Check quy·ªÅn
        if (table.isSystem && !$isAdmin) return alert("B·∫°n kh√¥ng c√≥ quy·ªÅn s·ª≠a b·∫£ng h·ªá th·ªëng.");
        modalState.update(s => ({ 
            ...s, 
            activeModal: 'add-performance-table-modal', 
            payload: table,
            isSystem: table.isSystem 
        }));
    }

    async function deleteTable(id) {
        const table = $customPerformanceTables.find(t => t.id === id);
        if (!table) return;

        if (table.isSystem) {
            if (!$isAdmin) return alert("B·∫°n kh√¥ng c√≥ quy·ªÅn x√≥a b·∫£ng h·ªá th·ªëng.");
            if (!confirm("X√≥a vƒ©nh vi·ªÖn b·∫£ng h·ªá th·ªëng n√†y?")) return;
            const newTables = $customPerformanceTables.filter(t => t.id !== id && t.isSystem);
            await adminService.saveSystemPerformanceTables(newTables);
        } else {
            if (!confirm("X√≥a b·∫£ng c√° nh√¢n n√†y?")) return;
            const newTables = $customPerformanceTables.filter(t => t.id !== id && !t.isSystem);
            await datasyncService.savePersonalPerformanceTables($selectedWarehouse, newTables);
        }
        // Reload local store
        customPerformanceTables.update(items => items.filter(t => t.id !== id));
    }

    $: visibleTables = $customPerformanceTables.filter(t => t.isVisible);
    const colors = ['blue', 'green', 'orange', 'purple', 'teal'];
</script>

{#if isLoading}
    <div class="flex flex-col items-center justify-center p-12 text-teal-600">
        <svg class="animate-spin h-8 w-8 mb-3" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
        </svg>
        <p class="text-sm font-semibold">ƒêang t·∫£i b·∫£ng hi·ªáu qu·∫£...</p>
    </div>
{:else}

    {#if $customPerformanceTables.length > 0}
        <div class="mb-6 flex flex-wrap items-center gap-2 bg-white p-3 rounded-xl border border-gray-200 shadow-sm">
            <div class="text-xs font-bold uppercase text-gray-500 mr-2 flex items-center gap-1">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01" /></svg>
                B·∫£ng hi·ªÉn th·ªã:
            </div>
            
            {#each $customPerformanceTables as table}
                <button 
                    class="px-3 py-1.5 rounded-full text-xs font-medium border transition-all duration-200 flex items-center gap-1.5 select-none
                    {table.isVisible ?
                        'bg-blue-600 text-white border-blue-600 shadow-md transform -translate-y-0.5' : 'bg-gray-100 text-gray-500 border-gray-200 hover:bg-gray-200'}
                    {table.isSystem ?
                        'border-dashed' : ''}"
                    on:click={() => toggleTableVisibility(table.id)}
                    title={table.isSystem ? "B·∫£ng h·ªá th·ªëng" : "B·∫£ng c√° nh√¢n"}
                >
                    {#if table.isSystem}<span class="text-[10px] opacity-70">üåê</span>{/if}
                    {table.title}
                </button>
            {/each}

            <button 
                class="px-3 py-1.5 rounded-full text-xs font-bold border border-dashed border-gray-300 text-gray-500 hover:text-blue-600 hover:border-blue-400 hover:bg-blue-50 transition-colors ml-auto flex items-center gap-1"
                on:click={openAddModal}
            >
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" /></svg>
                T·∫°o b·∫£ng m·ªõi
            </button>
        </div>
    {/if}

    {#if $customPerformanceTables.length === 0}
        <div class="p-12 text-center bg-white rounded-xl border border-blue-100 shadow-sm flex flex-col items-center">
            <div class="w-16 h-16 bg-blue-50 rounded-full flex items-center justify-center mb-4 text-blue-500">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" /></svg>
            </div>
            <h4 class="text-lg font-bold text-gray-800 mb-2">Ch∆∞a c√≥ B·∫£ng hi·ªáu qu·∫£ n√†o</h4>
            <p class="text-gray-500 mb-6 max-w-md">B·∫°n ch∆∞a t·∫°o b·∫£ng theo d√µi n√†o.</p>
            <button class="px-6 py-2.5 bg-blue-600 text-white rounded-lg font-bold hover:bg-blue-700 shadow-md flex items-center gap-2" on:click={openAddModal}>
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" /></svg>
                T·∫°o b·∫£ng ngay
            </button>
        </div>
    {:else if visibleTables.length === 0}
        <div class="p-12 text-center bg-gray-50 rounded-xl border border-gray-200 border-dashed">
             <p class="text-gray-500 font-medium">B·∫°n ƒë√£ ·∫©n t·∫•t c·∫£ c√°c b·∫£ng. Vui l√≤ng b·∫≠t l·∫°i tr√™n thanh c√¥ng c·ª•.</p>
        </div>
    {:else}
        <div class="grid grid-cols-1 xl:grid-cols-2 gap-6 pb-10">
            {#each visibleTables as table, index (table.id)}
                <div data-capture-group="performance-table">
                    <DynamicPerformanceTable 
                        config={table} 
                        {reportData} 
                        colorTheme={colors[index % colors.length]}
                        on:edit={() => editTable(table)}
                        on:delete={() => deleteTable(table.id)}
                    />
                </div>
            {/each}
        </div>
    {/if}

{/if}
<<< FILE_END: src/components/health-staff/performance/PerformanceView.svelte

>>> FILE_START: src/components/health-staff/revenue/DailyPerfChart.svelte
<script>
  import { onMount, afterUpdate } from 'svelte';
  import { formatters } from '../../../utils/formatters.js';
  
  export let dailyStats = []; // D·ªØ li·ªáu: [{ date, revenue, convertedRevenue }]

  let chartInstanceDTQD;
  let chartInstanceTLQD;
  let filterDays = 7; // M·∫∑c ƒë·ªãnh 7 ng√†y

  // L·ªçc d·ªØ li·ªáu d·ª±a tr√™n s·ªë ng√†y
  $: filteredData = filterDays === 'all' 
      ? dailyStats 
      : dailyStats.slice(-filterDays);

  $: labels = filteredData.map(d => new Date(d.date).toLocaleDateString('vi-VN', { day: '2-digit', month: '2-digit' }));
  $: dtqdData = filteredData.map(d => d.convertedRevenue / 1000000);
  $: tlqdData = filteredData.map(d => (d.revenue > 0 ? (d.convertedRevenue / d.revenue) - 1 : 0));

  const chartOptions = (title, isPercent = false) => ({
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
          legend: { display: false },
          tooltip: {
              callbacks: {
                  label: (context) => {
                      const val = context.raw;
                      return isPercent ? formatters.formatPercentage(val) : `${formatters.formatRevenue(val * 1000000)} Tr`;
                  }
              }
          },
          datalabels: {
              anchor: 'end', align: 'end',
              formatter: (val) => isPercent ? formatters.formatPercentage(val) : formatters.formatRevenue(val * 1000000),
              color: '#4b5563', font: { weight: 'bold', size: 10 }
          }
      },
      scales: { y: { beginAtZero: true, grace: '10%' } }
  });

  function renderCharts() {
      if (typeof Chart === 'undefined') return;

      // 1. Bi·ªÉu ƒë·ªì DTQƒê
      const ctxDTQD = document.getElementById('daily-dtqd-chart');
      if (ctxDTQD) {
          if (chartInstanceDTQD) chartInstanceDTQD.destroy();
          chartInstanceDTQD = new Chart(ctxDTQD, {
              type: 'bar',
              data: {
                  labels: labels,
                  datasets: [{ label: 'DTQƒê', data: dtqdData, backgroundColor: '#3b82f6', borderRadius: 4 }]
              },
              options: chartOptions('Doanh thu Qƒê', false),
              plugins: [ChartDataLabels]
          });
      }

      // 2. Bi·ªÉu ƒë·ªì T·ª∑ l·ªá Qƒê
      const ctxTLQD = document.getElementById('daily-tlqd-chart');
      if (ctxTLQD) {
          if (chartInstanceTLQD) chartInstanceTLQD.destroy();
          chartInstanceTLQD = new Chart(ctxTLQD, {
              type: 'bar',
              data: {
                  labels: labels,
                  datasets: [{ label: 'T·ª∑ l·ªá', data: tlqdData, backgroundColor: '#16a34a', borderRadius: 4 }]
              },
              options: chartOptions('T·ª∑ l·ªá Qƒê', true),
              plugins: [ChartDataLabels]
          });
      }
  }

  // Render l·∫°i khi d·ªØ li·ªáu thay ƒë·ªïi
  $: if (filteredData.length > 0) {
      // D√πng setTimeout ƒë·ªÉ ƒë·ª£i DOM c·∫≠p nh·∫≠t xong canvas
      setTimeout(renderCharts, 0);
  }

  function setFilter(days) {
      filterDays = days;
  }
</script>

<div class="mb-6">
    <div class="flex items-center justify-center flex-wrap gap-2 mb-4">
        <span class="text-sm font-medium text-gray-600">Xem theo:</span>
        {#each [3, 5, 7, 10, 'all'] as days}
            <button 
                class="px-3 py-1 text-xs font-medium rounded-full transition-colors 
                       {filterDays === days ? 'bg-blue-600 text-white' : 'bg-gray-200 text-gray-700 hover:bg-gray-300'}"
                on:click={() => setFilter(days)}
            >
                {days === 'all' ? 'T·∫•t c·∫£' : `${days} ng√†y`}
            </button>
        {/each}
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <div class="bg-white p-4 rounded-lg shadow-md border h-[300px]">
            <h4 class="text-md font-bold text-gray-700 mb-2 text-center">Doanh thu Qƒê theo ng√†y (Tr)</h4>
            <div class="relative h-[240px] w-full">
                <canvas id="daily-dtqd-chart"></canvas>
            </div>
        </div>
        <div class="bg-white p-4 rounded-lg shadow-md border h-[300px]">
            <h4 class="text-md font-bold text-gray-700 mb-2 text-center">T·ª∑ l·ªá Qƒê theo ng√†y</h4>
            <div class="relative h-[240px] w-full">
                <canvas id="daily-tlqd-chart"></canvas>
            </div>
        </div>
    </div>
</div>
<<< FILE_END: src/components/health-staff/revenue/DailyPerfChart.svelte

>>> FILE_START: src/components/health-staff/revenue/DynamicTableHeader.svelte
<script>
    import { createEventDispatcher } from 'svelte';
    import SortableTh from '../../common/SortableTh.svelte';

    export let config = {};
    export let tableMetrics = {};
    export let totalColSpan = 0;
    export let sortKey = '';
    export let sortDirection = 'desc';

    const dispatch = createEventDispatcher();

    // Helper m√†u s·∫Øc header ph·ª•
    const getSubHeaderColor = (index) => {
        const colors = [
            'bg-indigo-100 text-indigo-900 border-indigo-200', 
            'bg-emerald-100 text-emerald-900 border-emerald-200', 
            'bg-amber-100 text-amber-900 border-amber-200', 
            'bg-rose-100 text-rose-900 border-rose-200', 
            'bg-cyan-100 text-cyan-900 border-cyan-200'
        ];
        return colors[index % colors.length];
    };

    function handleSort(event) {
        dispatch('sort', event.detail);
    }

    function handleManualSort(key) {
        dispatch('manualSort', key);
    }
</script>

<thead class="bg-gray-50 text-xs uppercase text-gray-600 font-bold sticky top-0 z-20 shadow-sm">
    <tr>
        <th 
            class="px-4 py-2 pl-5 min-w-[180px] sticky left-0 z-30 bg-gray-100 border-r border-b border-gray-300 shadow-[2px_0_5px_-2px_rgba(0,0,0,0.1)] cursor-pointer hover:bg-gray-200 transition select-none text-left"
            rowspan="2"
            on:click={() => handleManualSort('hoTen')}
        >
            <div class="flex items-center gap-1 justify-start">
                <span class="font-bold uppercase text-xs {sortKey === 'hoTen' ? 'text-blue-800' : 'text-slate-700'}">Nh√¢n vi√™n</span>
                <span class="flex flex-col items-center justify-center w-4 h-4">
                    {#if sortKey !== 'hoTen'}
                        <svg xmlns="http://www.w3.org/2000/svg" class="w-3 h-3 text-gray-400 opacity-50" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M7 16V4m0 0L3 8m4-4l4 4m6 0v12m0 0l4-4m-4 4l-4-4" /></svg>
                    {:else if sortDirection === 'asc'}
                        <svg xmlns="http://www.w3.org/2000/svg" class="w-3.5 h-3.5 text-blue-700" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="3"><path stroke-linecap="round" stroke-linejoin="round" d="M5 15l7-7 7 7" /></svg>
                    {:else}
                        <svg xmlns="http://www.w3.org/2000/svg" class="w-3.5 h-3.5 text-blue-700" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="3"><path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7" /></svg>
                    {/if}
                </span>
            </div>
        </th>
        
        {#if totalColSpan > 0}
            <th colspan={totalColSpan} class="px-2 py-2 text-center border-b border-r border-gray-300 text-gray-900 bg-gray-200">
                T·ªîNG H·ª¢P
            </th>
        {/if}

        {#each config.subColumns as col, index}
            {@const metrics = col.metrics || { sl: false, dt: true, dtqd: false }}
            {@const colSpan = (metrics.sl ? 1 : 0) + (metrics.dt ? 1 : 0) + (metrics.dtqd ? 1 : 0)}
            {#if colSpan > 0}
                <th colspan={colSpan} class="px-2 py-2 text-center border-b border-r border-gray-200 {getSubHeaderColor(index)}">
                    {col.header}
                </th>
            {/if}
        {/each}
    </tr>

    <tr>
        {#if tableMetrics.sl}
            <SortableTh key="totalSL" label="SL" align="right" className="min-w-[60px] text-gray-700 bg-gray-100 border-r border-gray-300 border-b" {sortKey} {sortDirection} on:sort={handleSort} />
        {/if}
        {#if tableMetrics.dt}
                <SortableTh key="mainValue" label="DT" align="right" className="min-w-[80px] text-blue-800 bg-gray-100 border-r border-gray-300 border-b" {sortKey} {sortDirection} on:sort={handleSort} />
        {/if}
        {#if tableMetrics.dtqd}
                <SortableTh key="totalDTQD" label="Qƒê" align="right" className="min-w-[80px] text-purple-800 bg-gray-100 border-r border-gray-300 border-b" {sortKey} {sortDirection} on:sort={handleSort} />
        {/if}

        {#each config.subColumns as col}
            {@const metrics = col.metrics || { sl: false, dt: true, dtqd: false }}
            {#if metrics.sl}
                <SortableTh key={`${col.header}|sl`} label="SL" align="right" className="min-w-[60px] text-gray-500 bg-white border-r border-gray-200 border-b" {sortKey} {sortDirection} on:sort={handleSort} />
            {/if}
            {#if metrics.dt}
                <SortableTh key={`${col.header}|dt`} label="DT" align="right" className="min-w-[80px] text-blue-600 bg-white border-r border-gray-200 border-b" {sortKey} {sortDirection} on:sort={handleSort} />
            {/if}
            {#if metrics.dtqd}
                <SortableTh key={`${col.header}|dtqd`} label="Qƒê" align="right" className="min-w-[80px] text-purple-600 bg-white border-r border-gray-200 border-b" {sortKey} {sortDirection} on:sort={handleSort} />
            {/if}
        {/each}
    </tr>
</thead>
<<< FILE_END: src/components/health-staff/revenue/DynamicTableHeader.svelte

>>> FILE_START: src/components/health-staff/revenue/DynamicTableRow.svelte
<script>
    import { formatters } from '../../../utils/formatters.js';

    export let item = {}; // D·ªØ li·ªáu 1 d√≤ng (ƒë√£ processed)
    export let config = {};
    export let tableMetrics = {}; // { sl, dt, dtqd }

    // T√≠nh to√°n tr∆∞·ªõc ƒë·ªÉ tr√°nh logic trong template
    $: columns = config.subColumns || [];
</script>

<tr class="hover:bg-blue-50/50 transition-colors group">
    <td class="px-5 py-2 font-semibold text-gray-700 border-r border-b border-gray-300 bg-white group-hover:bg-blue-50/50 sticky left-0 z-10 whitespace-nowrap shadow-[2px_0_5px_-2px_rgba(0,0,0,0.05)]">
        <span class="text-blue-700">{formatters.getShortEmployeeName(item.hoTen, item.maNV)}</span>
    </td>
    
    {#if tableMetrics.sl}
        <td class="px-2 py-2 text-right font-bold text-gray-800 bg-gray-50/50 border-r border-gray-300 border-b">
            {formatters.formatNumber(item.cells?.mainValue?.value_sl || item.mainValue_sl)}
        </td>
    {/if}
    {#if tableMetrics.dt}
        <td class="px-2 py-2 text-right font-bold text-blue-800 bg-gray-50/50 border-r border-gray-300 border-b">
            {formatters.formatRevenue(item.cells?.mainValue?.value || item.mainValue)}
        </td>
    {/if}
    {#if tableMetrics.dtqd}
        <td class="px-2 py-2 text-right font-bold text-purple-800 bg-gray-50/50 border-r border-gray-300 border-b">
            {formatters.formatRevenue(item.cells?.mainValue?.value_dtqd || item.mainValue_dtqd)}
        </td>
    {/if}

    {#each columns as col}
        {@const cell = item.cells ? (item.cells[col.id] || item.cells[col.header]) : null}
        {@const metrics = col.metrics || { sl: false, dt: true, dtqd: false }}
        
        {#if metrics.sl}
            <td class="px-2 py-2 text-right border-r border-gray-200 border-b text-gray-600" title={cell?.tooltip}>
                {formatters.formatNumber(cell?.value_sl || cell?.sl)}
            </td>
        {/if}
        {#if metrics.dt}
            <td class="px-2 py-2 text-right border-r border-gray-200 border-b font-medium text-gray-800" title={cell?.tooltip}>
                {formatters.formatRevenue(cell?.value || cell?.dt)}
            </td>
        {/if}
        {#if metrics.dtqd}
            <td class="px-2 py-2 text-right border-r border-gray-200 border-b font-medium text-purple-600" title={cell?.tooltip}>
                {formatters.formatRevenue(cell?.value_dtqd || cell?.dtqd)}
            </td>
        {/if}
    {/each}
</tr>
<<< FILE_END: src/components/health-staff/revenue/DynamicTableRow.svelte

>>> FILE_START: src/components/health-staff/revenue/RevenueDetailView.svelte
<script>
  import { createEventDispatcher } from 'svelte';
  import { masterReportData, ycxData, modalState } from '../../../stores.js';
  import { reportService } from '../../../services/reportService.js';
  import { settingsService } from '../../../services/settings.service.js';
  import { formatters } from '../../../utils/formatters.js';
  
  import DetailHeader from '../detail/DetailHeader.svelte';
  import RevenueKpiBoard from './RevenueKpiBoard.svelte';
  import DailyPerfChart from './DailyPerfChart.svelte';
  import RevenueTopGroups from './RevenueTopGroups.svelte';

  export let employeeId;
  const dispatch = createEventDispatcher();

  let detailData = null;
  let employeeData = null;
  let goals = {};

  $: if (employeeId && $ycxData.length > 0) {
      employeeData = $masterReportData.sknv.find(e => String(e.maNV) === String(employeeId));
      if (employeeData) {
          const settings = settingsService.getLuykeGoalSettings(employeeData.maKho);
          goals = settings.goals || {};
          detailData = reportService.generateLuyKeEmployeeDetailReport(employeeId, $ycxData);
      }
  }

  function goBack() { 
      dispatch('back');
  }

  // [ƒê√É S·ª¨A] B·ªè ƒëi·ªÅu ki·ªán ki·ªÉm tra s√¢u, ƒë·∫£m b·∫£o l·ªánh m·ªü Modal lu√¥n ƒë∆∞·ª£c th·ª±c thi
  function openUnexportedModal() {
      if (detailData) {
          modalState.update(s => ({ 
              ...s, 
              activeModal: 'unexported-detail-modal',
              payload: { unexportedDetails: detailData.unexportedDetails || [] }
          }));
      }
  }

  function openOrdersModal() {
      if (detailData) {
          modalState.update(s => ({ 
              ...s, 
              activeModal: 'customer-detail-modal',
              payload: { 
                  customers: detailData.byCustomer || [],
                  mucTieu: employeeData ? employeeData.mucTieu : {}
              }
          }));
      }
  }
</script>

<div class="animate-fade-in pb-10 max-w-7xl mx-auto">
    <div class="mb-4 flex justify-between items-center">
        <button on:click={goBack} class="text-blue-600 hover:underline font-semibold flex items-center gap-1">
            <i data-feather="chevron-left" class="w-4 h-4"></i> Quay l·∫°i b·∫£ng t·ªïng h·ª£p
        </button>
    </div>

    {#if employeeData && detailData}
        <DetailHeader employee={employeeData} showStats={false} />
        
        <RevenueKpiBoard 
            summary={detailData.summary} 
            {goals} 
            on:viewUnexported={openUnexportedModal}
            on:viewOrders={openOrdersModal}
        />
        
        <DailyPerfChart dailyStats={detailData.dailyStats} />
        
        <RevenueTopGroups 
            topProductGroups={detailData.topProductGroups} 
            categoryChartData={detailData.categoryChartData} 
        />

    {:else}
        <div class="p-12 text-center bg-red-50 rounded-lg border border-red-200">
            <p class="text-red-600 font-semibold">Kh√¥ng t√¨m th·∫•y d·ªØ li·ªáu chi ti·∫øt cho nh√¢n vi√™n n√†y.</p>
        </div>
    {/if}
</div>

<style>
    .animate-fade-in { animation: fadeIn 0.3s ease-out; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
</style>
<<< FILE_END: src/components/health-staff/revenue/RevenueDetailView.svelte

>>> FILE_START: src/components/health-staff/revenue/RevenueKpiBoard.svelte
<script>
  import { createEventDispatcher } from 'svelte';
  import { formatters } from '../../../utils/formatters.js';

  export let summary = {};
  export let goals = {};

  const dispatch = createEventDispatcher();

  // T√≠nh to√°n target
  $: targetQD = (goals?.phanTramQD || 0);
  $: isPositive = (summary.conversionRate * 100) >= targetQD;
</script>

<div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-4 mb-6">
    <div class="bg-white p-4 rounded-lg shadow border border-gray-100 text-center">
        <div class="text-sm text-gray-500 font-medium uppercase">T·ªïng DT Th·ª±c</div>
        <div class="text-xl font-bold text-blue-600 mt-1">{formatters.formatRevenue(summary.totalRealRevenue, 1)}</div>
    </div>

    <div class="bg-white p-4 rounded-lg shadow border border-gray-100 text-center">
        <div class="text-sm text-gray-500 font-medium uppercase">T·ªïng DTQƒê</div>
        <div class="text-xl font-bold text-purple-600 mt-1">{formatters.formatRevenue(summary.totalConvertedRevenue, 1)}</div>
    </div>

    <div class="bg-white p-4 rounded-lg shadow border border-gray-100 text-center">
        <div class="text-sm text-gray-500 font-medium uppercase">T·ª∑ l·ªá Qƒê</div>
        <div class="text-xl font-bold mt-1 {isPositive ? 'text-green-600' : 'text-red-600'}">
            {formatters.formatPercentage(summary.conversionRate)}
        </div>
    </div>

    <div 
        class="bg-white p-4 rounded-lg shadow border border-gray-100 text-center cursor-pointer hover:bg-yellow-50 transition-colors hover:shadow-md"
        on:click={() => dispatch('viewUnexported')}
    >
        <div class="text-sm text-gray-500 font-medium uppercase flex items-center justify-center gap-1">
            DT Ch∆∞a Xu·∫•t <i data-feather="external-link" class="w-3 h-3"></i>
        </div>
        <div class="text-xl font-bold text-yellow-600 mt-1">{formatters.formatRevenue(summary.unexportedRevenue, 1)}</div>
    </div>

    <div 
        class="bg-white p-4 rounded-lg shadow border border-gray-100 text-center cursor-pointer hover:bg-blue-50 transition-colors hover:shadow-md"
        on:click={() => dispatch('viewOrders')}
    >
        <div class="text-sm text-gray-500 font-medium uppercase flex items-center justify-center gap-1">
            T·ªïng ƒê∆°n <i data-feather="external-link" class="w-3 h-3"></i>
        </div>
        <div class="text-xl font-bold text-gray-800 mt-1">{summary.totalOrders}</div>
    </div>

    <div class="bg-white p-4 rounded-lg shadow border border-gray-100 text-center">
        <div class="text-sm text-gray-500 font-medium uppercase">ƒê∆°n B√°n K√®m</div>
        <div class="text-xl font-bold text-gray-800 mt-1">{summary.bundledOrderCount}</div>
    </div>
</div>
<<< FILE_END: src/components/health-staff/revenue/RevenueKpiBoard.svelte

>>> FILE_START: src/components/health-staff/revenue/RevenueTopGroups.svelte
<script>
  import { onMount } from 'svelte';
  import { formatters } from '../../../utils/formatters.js';
  import { getRandomBrightColor } from '../../../utils.js';

  export let topProductGroups = [];
  export let categoryChartData = [];

  let chartInstance;

  // 1. Top 5 Nh√≥m h√†ng
  $: top5Groups = topProductGroups.slice(0, 5);
  $: maxRevenue = top5Groups.length > 0 ? top5Groups[0].realRevenue : 0;

  // 2. Bi·ªÉu ƒë·ªì
  function renderPieChart() {
      const ctx = document.getElementById('revenue-category-chart');
      if (!ctx || !categoryChartData.length) return;

      if (chartInstance) chartInstance.destroy();

      // Sort v√† l·∫•y top 10 cho bi·ªÉu ƒë·ªì
      const sortedChartData = [...categoryChartData].sort((a, b) => b.revenue - a.revenue).slice(0, 10);

      chartInstance = new Chart(ctx, {
          type: 'bar',
          data: {
              labels: sortedChartData.map(d => d.name),
              datasets: [{
                  label: 'Doanh thu',
                  data: sortedChartData.map(d => d.revenue / 1000000),
                  backgroundColor: sortedChartData.map(() => getRandomBrightColor()),
                  borderRadius: 4,
              }]
          },
          options: {
              indexAxis: 'x',
              responsive: true,
              maintainAspectRatio: false,
              plugins: {
                  legend: { display: false },
                  tooltip: {
                      callbacks: { label: ctx => `${ctx.label}: ${formatters.formatRevenue(ctx.raw * 1000000)}` }
                  },
                  datalabels: {
                      anchor: 'end', align: 'end',
                      formatter: (val) => formatters.formatRevenue(val * 1000000),
                      color: '#4b5563', font: { weight: 'bold', size: 10 }
                  }
              },
              scales: { y: { beginAtZero: true, grace: '10%' } }
          },
          plugins: [ChartDataLabels]
      });
  }

  $: if (categoryChartData.length > 0) {
      setTimeout(renderPieChart, 0);
  }
</script>

<div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
    <div class="bg-white p-4 rounded-lg shadow-md border">
        <h4 class="text-md font-bold text-gray-700 border-b pb-2 mb-3">Top 5 Nh√≥m H√†ng Doanh Thu Cao</h4>
        {#if top5Groups.length === 0}
            <p class="text-sm text-gray-500">Kh√¥ng c√≥ d·ªØ li·ªáu.</p>
        {:else}
            <div class="space-y-4">
                {#each top5Groups as group}
                    {@const percent = maxRevenue > 0 ? (group.realRevenue / maxRevenue) * 100 : 0}
                    <div>
                        <div class="flex justify-between items-end mb-1">
                            <div>
                                <span class="font-semibold text-sm block">{group.name}</span>
                                <span class="text-xs text-gray-500">SL: {formatters.formatNumber(group.quantity)} | %Qƒê: {formatters.formatPercentage(group.conversionRate)}</span>
                            </div>
                            <div class="text-right">
                                <div class="text-sm font-bold text-gray-800">{formatters.formatRevenue(group.realRevenue)}</div>
                                <div class="text-xs text-blue-600 font-medium">{formatters.formatRevenue(group.convertedRevenue)} (Qƒê)</div>
                            </div>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-2">
                            <div class="bg-blue-600 h-2 rounded-full transition-all duration-500" style="width: {percent}%"></div>
                        </div>
                    </div>
                {/each}
            </div>
        {/if}
    </div>

    <div class="bg-white p-4 rounded-lg shadow-md border">
        <h4 class="text-md font-bold text-gray-700 mb-2">T·ª∑ Tr·ªçng Doanh Thu Ng√†nh H√†ng</h4>
        <div class="relative h-[300px] w-full">
            <canvas id="revenue-category-chart"></canvas>
        </div>
    </div>
</div>
<<< FILE_END: src/components/health-staff/revenue/RevenueTopGroups.svelte

>>> FILE_START: src/components/health-staff/shared/EvaluationBadge.svelte
<script>
  export let isAbove = false;
</script>

<span class="px-2 py-0.5 rounded text-[10px] font-bold uppercase tracking-wide {isAbove ? 'bg-green-100 text-green-700' : 'bg-yellow-100 text-yellow-700'}">
  {isAbove ? 'Tr√™n TB' : 'D∆∞·ªõi TB'}
</span>
<<< FILE_END: src/components/health-staff/shared/EvaluationBadge.svelte

>>> FILE_START: src/components/health-staff/shared/MedalIcon.svelte
<script>
  export let rank = 0; // 0: Base (Index + 1)

  // Logic m√†u s·∫Øc cho Top 3
  const isGold = rank === 1;
  const isSilver = rank === 2;
  const isBronze = rank === 3;
  const isStandard = rank > 3;
</script>

<div class="relative w-12 h-12 flex-shrink-0 -ml-2 -mt-2">
  {#if isGold}
    <svg viewBox="0 0 100 100" class="w-full h-full drop-shadow-sm absolute top-0 left-0 z-10">
        <defs><linearGradient id="gold-grad" x1="0%" y1="0%" x2="0%" y2="100%"><stop offset="0%" stop-color="#FFDF00"/><stop offset="100%" stop-color="#FFB800"/></linearGradient></defs>
        <path d="M 20 75 L 35 95 L 35 75 L 50 90 L 65 75 L 65 95 L 80 75 L 50 85 Z" fill="#E53935"/>
        <circle cx="50" cy="45" r="38" fill="#BDBDBD"/><circle cx="50" cy="45" r="35" fill="url(#gold-grad)"/>
        <circle cx="50" cy="45" r="28" fill="#FFC107" stroke="#FFFFFF" stroke-width="2"/>
    </svg>
  {:else if isSilver}
    <svg viewBox="0 0 100 100" class="w-full h-full drop-shadow-sm absolute top-0 left-0 z-10">
        <defs><linearGradient id="silver-grad" x1="0%" y1="0%" x2="0%" y2="100%"><stop offset="0%" stop-color="#F5F5F5"/><stop offset="100%" stop-color="#B0BEC5"/></linearGradient></defs>
        <path d="M 20 75 L 35 95 L 35 75 L 50 90 L 65 75 L 65 95 L 80 75 L 50 85 Z" fill="#E53935"/>
        <circle cx="50" cy="45" r="38" fill="#78909C"/><circle cx="50" cy="45" r="35" fill="url(#silver-grad)"/>
        <circle cx="50" cy="45" r="28" fill="#B0BEC5" stroke="#FFFFFF" stroke-width="2"/>
    </svg>
  {:else if isBronze}
    <svg viewBox="0 0 100 100" class="w-full h-full drop-shadow-sm absolute top-0 left-0 z-10">
        <defs><linearGradient id="bronze-grad" x1="0%" y1="0%" x2="0%" y2="100%"><stop offset="0%" stop-color="#FFCC80"/><stop offset="100%" stop-color="#D84315"/></linearGradient></defs>
        <path d="M 20 75 L 35 95 L 35 75 L 50 90 L 65 75 L 65 95 L 80 75 L 50 85 Z" fill="#E53935"/>
        <circle cx="50" cy="45" r="38" fill="#A1887F"/><circle cx="50" cy="45" r="35" fill="url(#bronze-grad)"/>
        <circle cx="50" cy="45" r="28" fill="#D84315" stroke="#FFFFFF" stroke-width="2"/>
    </svg>
  {:else}
    <div class="sknv-card__avatar--standard">
        <span class="sknv-card__avatar-rank">{rank}</span>
    </div>
  {/if}
  
  {#if !isStandard}
      <div class="absolute top-0 left-0 w-full h-[90%] flex items-center justify-center z-20">
        <span class="sknv-card__avatar-rank text-white text-lg font-bold">{rank}</span>
      </div>
  {/if}
</div>
<<< FILE_END: src/components/health-staff/shared/MedalIcon.svelte

>>> FILE_START: src/components/health-staff/shared/UMedalIcon.svelte
<script>
  export let rank = 0; // 0: Base (Index + 1)

  // Logic m√†u s·∫Øc cho Top 3
  const isGold = rank === 1;
  const isSilver = rank === 2;
  const isBronze = rank === 3;
</script>

<div class="relative w-12 h-12 flex-shrink-0 -ml-2 -mt-2">
  {#if isGold}
    <svg viewBox="0 0 100 100" class="w-full h-full drop-shadow-sm">
        <defs><linearGradient id="gold-grad" x1="0%" y1="0%" x2="0%" y2="100%"><stop offset="0%" stop-color="#FFDF00"/><stop offset="100%" stop-color="#FFB800"/></linearGradient></defs>
        <path d="M 20 75 L 35 95 L 35 75 L 50 90 L 65 75 L 65 95 L 80 75 L 50 85 Z" fill="#E53935"/>
        <circle cx="50" cy="45" r="38" fill="#BDBDBD"/><circle cx="50" cy="45" r="35" fill="url(#gold-grad)"/>
        <circle cx="50" cy="45" r="28" fill="#FFC107" stroke="#FFFFFF" stroke-width="2"/>
    </svg>
  {:else if isSilver}
    <svg viewBox="0 0 100 100" class="w-full h-full drop-shadow-sm">
        <defs><linearGradient id="silver-grad" x1="0%" y1="0%" x2="0%" y2="100%"><stop offset="0%" stop-color="#F5F5F5"/><stop offset="100%" stop-color="#B0BEC5"/></linearGradient></defs>
        <path d="M 20 75 L 35 95 L 35 75 L 50 90 L 65 75 L 65 95 L 80 75 L 50 85 Z" fill="#E53935"/>
        <circle cx="50" cy="45" r="38" fill="#78909C"/><circle cx="50" cy="45" r="35" fill="url(#silver-grad)"/>
        <circle cx="50" cy="45" r="28" fill="#B0BEC5" stroke="#FFFFFF" stroke-width="2"/>
    </svg>
  {:else if isBronze}
    <svg viewBox="0 0 100 100" class="w-full h-full drop-shadow-sm">
        <defs><linearGradient id="bronze-grad" x1="0%" y1="0%" x2="0%" y2="100%"><stop offset="0%" stop-color="#FFCC80"/><stop offset="100%" stop-color="#D84315"/></linearGradient></defs>
        <path d="M 20 75 L 35 95 L 35 75 L 50 90 L 65 75 L 65 95 L 80 75 L 50 85 Z" fill="#E53935"/>
        <circle cx="50" cy="45" r="38" fill="#A1887F"/><circle cx="50" cy="45" r="35" fill="url(#bronze-grad)"/>
        <circle cx="50" cy="45" r="28" fill="#D84315" stroke="#FFFFFF" stroke-width="2"/>
    </svg>
  {:else}
    <div class="w-12 h-12 rounded-full bg-gray-200 flex items-center justify-center border-4 border-white shadow-sm">
        </div>
  {/if}
  
  <div class="absolute top-0 left-0 w-full h-[90%] flex items-center justify-center z-10">
    <span class="text-lg font-bold {rank <= 3 ? 'text-white' : 'text-gray-600'}">{rank}</span>
  </div>
</div>
<<< FILE_END: src/components/health-staff/shared/UMedalIcon.svelte

>>> FILE_START: src/components/health-staff/summary/DepartmentGroup.svelte
<script>
  import EmployeeCard from './card/EmployeeCard.svelte';
  
  export let departmentName;
  export let employees = [];
  
  // Priority styling cho "T∆∞ V·∫•n - ƒêM"
  $: isPriority = departmentName.includes('T∆∞ V·∫•n');
  $: headerClass = isPriority 
    ? 'bg-blue-50 text-blue-800 border-blue-200' 
    : 'bg-gray-50 text-gray-700 border-gray-200';
</script>

<div class="mb-8 last:mb-0">
  <div class="flex items-center gap-3 px-4 py-3 rounded-t-lg border-b-2 {headerClass}">
    <h3 class="text-lg font-bold uppercase tracking-wide">{departmentName}</h3>
    <span class="bg-white/50 px-2 py-0.5 rounded text-xs font-bold">{employees.length} NV</span>
  </div>
  
  <div class="p-4 bg-slate-50/30 border-x border-b border-gray-200 rounded-b-lg">
    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4">
      {#each employees as emp, index (emp.maNV)}
        <EmployeeCard employee={emp} rank={index + 1} on:click />
      {/each}
    </div>
  </div>
</div>
<<< FILE_END: src/components/health-staff/summary/DepartmentGroup.svelte

>>> FILE_START: src/components/health-staff/summary/SummaryView.svelte
<script>
  import DepartmentGroup from './DepartmentGroup.svelte';
  
  // [FIX L·ªñI QUAN TR·ªåNG]
  // Sai: import { utils } from '../../../utils.js';
  // ƒê√∫ng: Import t·∫•t c·∫£ h√†m (*) v√† ƒë·∫∑t t√™n l√† 'utils'
  import * as utils from '../../../utils.js'; 
  
  export let reportData = [];

  // Gom nh√≥m nh√¢n vi√™n theo b·ªô ph·∫≠n
  $: groupedData = reportData.reduce((acc, item) => {
      const dept = item.boPhan || 'Kh√°c';
      if (!acc[dept]) acc[dept] = [];
      acc[dept].push(item);
      return acc;
  }, {});

  // S·∫Øp x·∫øp th·ª© t·ª± b·ªô ph·∫≠n (∆Øu ti√™n T∆∞ V·∫•n)
  // H√†m n√†y n·∫±m trong utils.js, gi·ªù g·ªçi qua namespace 'utils' s·∫Ω ho·∫°t ƒë·ªông
  $: departmentOrder = utils.getSortedDepartmentList(reportData);
</script>

<div class="animate-fade-in pb-10">
  {#if reportData.length === 0}
    <div class="p-12 text-center bg-gray-50 rounded-lg border border-gray-200">
      <p class="text-gray-500">Kh√¥ng c√≥ d·ªØ li·ªáu hi·ªáu su·∫•t ƒë·ªÉ hi·ªÉn th·ªã.</p>
    </div>
  {:else}
    {#each departmentOrder as deptName}
      {#if groupedData[deptName]}
        {@const sortedEmployees = [...groupedData[deptName]].sort((a, b) => b.totalAbove - a.totalAbove)}
        <DepartmentGroup 
          departmentName={deptName} 
          employees={sortedEmployees} 
          on:click 
        />
      {/if}
    {/each}
  {/if}
</div>

<style>
  .animate-fade-in { animation: fadeIn 0.5s ease-out; }
  @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
</style>
<<< FILE_END: src/components/health-staff/summary/SummaryView.svelte

>>> FILE_START: src/components/health-staff/summary/card/CardHeader.svelte
<script>
  import { formatters } from '../../../../utils/formatters.js';
  export let hoTen;
  export let maNV;
  export let boPhan;
  export let rank = 999; // [M·ªöI] Nh·∫≠n rank ƒë·ªÉ check Top 3

  // Logic m√†u t√™n: Top 3 m√†u xanh d∆∞∆°ng ƒë·∫≠m, c√≤n l·∫°i m√†u ƒëen x√°m
  $: nameColorClass = rank <= 3 ? 'text-blue-700 font-extrabold' : 'text-gray-900 font-bold';
</script>

<div class="flex-grow min-w-0 ml-3">
  <p class="{nameColorClass} text-base truncate leading-tight" title="{hoTen} - {maNV}">
    {formatters.getShortEmployeeName(hoTen, maNV)}
  </p>
  <p class="text-xs text-gray-500 truncate">{boPhan}</p>
</div>
<<< FILE_END: src/components/health-staff/summary/card/CardHeader.svelte

>>> FILE_START: src/components/health-staff/summary/card/CardMainKpi.svelte
<script>
  export let aboveCount = 0;
  export let totalCount = 0;

  $: percentage = totalCount > 0 ? aboveCount / totalCount : 0;
  $: colorClass = percentage >= 0.7 ? 'text-green-600' : percentage >= 0.4 ? 'text-yellow-500' : 'text-red-500';
  $: borderColorClass = percentage >= 0.7 ? 'border-t-green-500' : percentage >= 0.4 ? 'border-t-yellow-500' : 'border-t-red-500';
</script>

<div class="text-center py-2 border-t-4 {borderColorClass} bg-slate-50/50 mt-2">
  <div class="flex items-baseline justify-center gap-1">
    <span class="text-3xl font-extrabold {colorClass} leading-none">{aboveCount}</span>
    <span class="text-sm font-bold text-gray-400">/ {totalCount}</span>
  </div>
  <span class="text-[10px] uppercase font-bold text-gray-500 tracking-wider">Ch·ªâ s·ªë ƒë·∫°t</span>
</div>
<<< FILE_END: src/components/health-staff/summary/card/CardMainKpi.svelte

>>> FILE_START: src/components/health-staff/summary/card/CardSubKpiGrid.svelte
<script>
  export let summary; 

  // ƒê·ªãnh nghƒ©a m√†u n·ªÅn c·ªë ƒë·ªãnh cho t·ª´ng lo·∫°i th·∫ª (Style ƒë·ªìng b·ªô)
  const groups = [
    { key: 'doanhthu', label: 'Doanh Thu', icon: 'trending-up', bgClass: 'bg-blue-50 border-blue-100 text-blue-800' },
    { key: 'nangsuat', label: 'NƒÉng Su·∫•t', icon: 'dollar-sign', bgClass: 'bg-green-50 border-green-100 text-green-800' },
    { key: 'hieuqua', label: 'Hi·ªáu Qu·∫£', icon: 'award', bgClass: 'bg-orange-50 border-orange-100 text-orange-800' },
    { key: 'dongia', label: 'ƒê∆°n Gi√°', icon: 'tag', bgClass: 'bg-purple-50 border-purple-100 text-purple-800' }
  ];
</script>

<div class="grid grid-cols-2 gap-2 px-3 pb-3 pt-1 border-t border-gray-100">
  {#each groups as g}
    {@const data = summary[g.key]}
    {@const ratio = data.total > 0 ? data.above / data.total : 0}
    
    {@const valueColor = ratio > 0.5 ? 'text-blue-600' : 'text-red-600'}
    
    <div class="flex items-center justify-between p-1.5 rounded border {g.bgClass}">
      <div class="flex items-center gap-1">
        <i data-feather={g.icon} class="w-3 h-3 opacity-70"></i>
        <span class="text-[10px] font-bold uppercase opacity-90">{g.label}</span>
      </div>
      <span class="text-xs font-extrabold {valueColor}">{data.above}/{data.total}</span>
    </div>
  {/each}
</div>
<<< FILE_END: src/components/health-staff/summary/card/CardSubKpiGrid.svelte

>>> FILE_START: src/components/health-staff/summary/card/EmployeeCard.svelte
<script>
  import MedalIcon from '../../shared/MedalIcon.svelte';
  import CardHeader from './CardHeader.svelte';
  import CardMainKpi from './CardMainKpi.svelte';
  import CardSubKpiGrid from './CardSubKpiGrid.svelte';
  import { createEventDispatcher } from 'svelte';

  export let employee;
  export let rank; // 1, 2, 3...

  const dispatch = createEventDispatcher();
  
  $: summary = employee.summary;
  $: totalAbove = employee.totalAbove;
  $: totalCriteria = employee.totalCriteria;

  function handleClick() {
    dispatch('click', { employeeId: employee.maNV });
  }
</script>

<div 
  class="bg-white rounded-xl border border-gray-200 shadow-sm hover:shadow-md hover:-translate-y-1 transition-all cursor-pointer overflow-hidden relative group"
  on:click={handleClick}
  role="button"
  tabindex="0"
>
  <div class="p-3 flex items-start relative z-10">
    <MedalIcon {rank} />
    <CardHeader hoTen={employee.hoTen} maNV={employee.maNV} boPhan={employee.boPhan} {rank} />
  </div>

  <CardMainKpi aboveCount={totalAbove} totalCount={totalCriteria} />
  <CardSubKpiGrid {summary} />
</div>
<<< FILE_END: src/components/health-staff/summary/card/EmployeeCard.svelte

>>> FILE_START: src/components/HealthSection.svelte
<script>
  /* global feather */
  import { onMount, afterUpdate } from 'svelte';
  import {
      danhSachNhanVien,
      ycxData,
      masterReportData,
      selectedWarehouse,
      warehouseList,
      luykeGoalSettings,
      modalState,
      categoryNameMapping,
      macroCategoryConfig
  } from '../stores.js';
  import { reportService } from '../services/reportService.js';
  import { actionService } from '../services/action.service.js';
  // [CODEGENESIS] Import settingsService ƒë·ªÉ t·∫£i goal
  import { settingsService } from '../services/settings.service.js';
  
  import LuykeSieuThi from './luyke/LuykeSieuThi.svelte';
  import LuykeThiDua from './luyke/LuykeThiDua.svelte';
  import LuykeThiDuaVung from './luyke/LuykeThiDuaVung.svelte';

  export let activeTab;
  let activeSubTabId = 'subtab-luyke-sieu-thi';

  let showPlaceholder = true;
  $: showPlaceholder = ($danhSachNhanVien.length === 0);

  let selectedDept = '';
  let selectedDates = [];
  let goals = {};
  $: goals = ($luykeGoalSettings && $selectedWarehouse) 
      ? $luykeGoalSettings[$selectedWarehouse] || {} 
      : {};

  // [CODEGENESIS] T·ª± ƒë·ªông t·∫£i Goal t·ª´ Cloud khi ch·ªçn kho
  $: if ($selectedWarehouse) {
      // G·ªçi h√†m load ng·∫ßm, kh√¥ng c·∫ßn await ƒë·ªÉ tr√°nh ch·∫∑n UI
      settingsService.loadGoalsFromCloud($selectedWarehouse);
  }

  let filteredYCXData = [];
  $: {
      if (selectedDates && selectedDates.length > 0) {
          const startOfDay = (date) => new Date(date.getFullYear(), date.getMonth(), date.getDate()).getTime();
          const selectedDateSet = new Set(selectedDates.map(d => startOfDay(d)));
          filteredYCXData = $ycxData.filter(row => row.ngayTao instanceof Date && !isNaN(row.ngayTao) && selectedDateSet.has(startOfDay(row.ngayTao)));
      } else {
          filteredYCXData = $ycxData;
      }
  }

  $: {
      const _mappingTrigger = $categoryNameMapping;
      const _macroTrigger = $macroCategoryConfig;
      if (!showPlaceholder) {
          const newMasterReport = reportService.generateMasterReportData(
              filteredYCXData, 
              goals, 
              false 
          );
          masterReportData.update(current => ({ ...current, luyke: newMasterReport }));
      }
  }

  let filteredReport = [];
  $: filteredReport = ($masterReportData.luyke || []).filter(nv => {
      const whMatch = !$selectedWarehouse || nv.maKho == $selectedWarehouse;
      const deptMatch = !selectedDept || nv.boPhan === selectedDept;
      return whMatch && deptMatch;
  });
  let supermarketReport = {};
  $: supermarketReport = reportService.aggregateReport(filteredReport, $selectedWarehouse);

  let numDays = 1;
  $: numDays = selectedDates.length > 0 
      ? selectedDates.length 
      : (new Set($ycxData.map(row => row.ngayTao instanceof Date ? new Date(row.ngayTao).toDateString() : null).filter(Boolean)).size || 1);
  function handleSubTabClick(event) {
      const button = event.currentTarget;
      activeSubTabId = button.dataset.target;
  }

  function handleWarehouseChange(event) {
      selectedWarehouse.set(event.target.value);
  }

  function handleCompose() {
      modalState.update(s => ({ ...s, activeModal: 'composer-modal', context: 'luyke' }));
  }

  function handleExport() {
      actionService.handleExport('luyke');
  }

  function handleCapture() {
      actionService.handleCapture('luyke');
  }

  $: if (activeTab === 'health-section') {
    Promise.resolve().then(() => {
      if (typeof window.feather !== 'undefined') {
        window.feather.replace();
      }
    });
  }
</script>

<section id="health-section" class="page-section {activeTab === 'health-section' ? '' : 'hidden'}">
    <div id="health-section-placeholder" class="placeholder-message" class:hidden={!showPlaceholder}>
        Vui l√≤ng c·∫≠p nh·∫≠t danh s√°ch nh√¢n vi√™n ƒë·ªÉ xem k·∫øt qu·∫£.
    </div> 
    
    <div id="health-section-content" class:hidden={showPlaceholder}> 
        <div class="content-card mb-6 !p-0"> 
            <div class="modern-page-header flex flex-wrap justify-between items-center"> 
                <div class="title-wrapper flex items-center gap-4 flex-wrap">
                    <i data-feather="activity" class="main-icon hidden sm:block"></i>
                    
                    <div class="flex items-center gap-2">
                        <h2 class="page-title text-xl sm:text-2xl font-bold text-blue-800">S·ª©c Kh·ªèe Si√™u Th·ªã</h2> 
                        <button class="page-header__help-btn" data-help-id="luyke" title="Xem h∆∞·ªõng d·∫´n"> 
                              <i data-feather="help-circle"></i> 
                        </button>
                    </div>

                    <div class="flex items-center gap-2 pl-4 border-l-2 border-blue-100 ml-2">
                        <label for="luyke-warehouse-selector" class="text-sm font-semibold text-gray-600 whitespace-nowrap">Kho:</label>
                        <select 
                            id="luyke-warehouse-selector" 
                            class="p-2 border rounded-lg text-sm shadow-sm min-w-[120px] font-bold text-blue-700 bg-white border-blue-200 focus:ring-2 focus:ring-blue-500 outline-none cursor-pointer hover:bg-blue-50 transition" 
                            value={$selectedWarehouse}
                            on:change={handleWarehouseChange}
                        >
                            <option value="">-- To√†n b·ªô --</option>
                             {#each $warehouseList as kho}
                                <option value={kho}>{kho}</option>
                            {/each}
                        </select>
                    </div>
                </div>

                <div class="flex items-center gap-2 ml-auto mt-2 sm:mt-0"> 
                    <button id="compose-luyke-notification-btn" class="action-btn action-btn--composer" title="Nh·∫≠n x√©t" on:click={handleCompose}> 
                        <i data-feather="pen-tool" class="w-4 h-4"></i> 
                        <span class="hidden lg:inline">Nh·∫≠n x√©t</span> 
                    </button> 
                    <button id="export-luyke-btn" class="action-btn action-btn--export" title="Xu·∫•t Excel tab hi·ªán t·∫°i" on:click={handleExport}> 
                        <i data-feather="download" class="w-4 h-4"></i> 
                        <span class="hidden lg:inline">Xu·∫•t Excel</span> 
                    </button>
                    <button id="capture-luyke-btn" class="action-btn action-btn--capture" title="Ch·ª•p ·∫£nh tab hi·ªán t·∫°i" on:click={handleCapture}> 
                        <i data-feather="camera" class="w-4 h-4"></i> 
                        <span class="hidden lg:inline">Ch·ª•p ·∫£nh</span> 
                    </button> 
                </div>
            </div> 
            
            <div class="content-card__body p-4">
                <div class="mb-6 overflow-x-auto pb-2">
                    <nav id="luyke-subtabs-nav" class="flex space-x-2 border-b border-gray-100 pb-1 w-full min-w-max" aria-label="Tabs">
                        <button 
                            class="sub-tab-btn {activeSubTabId === 'subtab-luyke-sieu-thi' ? 'active' : ''}" 
                            data-target="subtab-luyke-sieu-thi" 
                            data-title="SieuThiLuyKe"
                            on:click={handleSubTabClick}
                        > 
                            <i data-feather="home"></i> 
                             <span>Si√™u th·ªã L≈©y k·∫ø</span> 
                        </button>
                        <button 
                            class="sub-tab-btn {activeSubTabId === 'subtab-luyke-thi-dua' ? 'active' : ''}" 
                            data-target="subtab-luyke-thi-dua" 
                            data-title="ThiDuaLuyKe"
                            on:click={handleSubTabClick}
                        > 
                            <i data-feather="award"></i> 
                            <span>Thi ƒëua ST L≈©y k·∫ø</span> 
                        </button>
                        <button 
                            class="sub-tab-btn {activeSubTabId === 'subtab-luyke-thidua-vung' ? 'active' : ''}" 
                            data-target="subtab-luyke-thidua-vung" 
                            data-title="ThiDuaVung"
                            on:click={handleSubTabClick}
                        > 
                            <i data-feather="map"></i> 
                            <span>Thi ƒêua V√πng TNB</span> 
                        </button>
                    </nav>
                </div>

                <div id="luyke-subtabs-content"> 
                    {#if activeSubTabId === 'subtab-luyke-sieu-thi'}
                        
                        <div id="subtab-luyke-sieu-thi" class="sub-tab-content">
                            <LuykeSieuThi 
                                supermarketReport={supermarketReport} 
                                filteredYCXData={filteredYCXData} 
                                goals={goals} 
                                numDays={numDays}
                            />
                        </div>
                    
                    {:else if activeSubTabId === 'subtab-luyke-thi-dua'}
                        <div id="subtab-luyke-thi-dua" class="sub-tab-content">
                            <div id="luyke-competition-content">
                                <LuykeThiDua />
                            </div>
                        </div>
                    
                    {:else if activeSubTabId === 'subtab-luyke-thidua-vung'}
                        <div id="subtab-luyke-thidua-vung" class="sub-tab-content">
                             <LuykeThiDuaVung />
                        </div>
                    {/if}
                </div>
            </div>
         </div>
    </div>
</section>
<<< FILE_END: src/components/HealthSection.svelte

>>> FILE_START: src/components/HealthEmployeeSection.svelte
<script>
  import { onMount, afterUpdate } from 'svelte';
  import { 
    masterReportData, 
    ycxData, 
    danhSachNhanVien, 
    luykeGoalSettings, 
    selectedWarehouse,
    warehouseList,
    modalState
  } from '../stores.js';
  import { sknvService } from '../services/sknv.service.js';
  import { reportService } from '../services/reportService.js';
  import { actionService } from '../services/action.service.js';
  import * as XLSX from 'xlsx';

  import SummaryView from './health-staff/summary/SummaryView.svelte';
  import DetailView from './health-staff/detail/DetailView.svelte';
  import RevenueTable from './health-staff/RevenueTable.svelte';
  import RevenueDetailView from './health-staff/revenue/RevenueDetailView.svelte';
  import IncomeTable from './health-staff/IncomeTable.svelte';
  import PerformanceView from './health-staff/performance/PerformanceView.svelte';
  import CategoryRevenueView from './health-staff/CategoryRevenueView.svelte';
  import CompetitionTab from './health-staff/CompetitionTab.svelte';
  import ProgramGoalTables from './health-staff/ProgramGoalTables.svelte';
  
  // [CODEGENESIS] Import Component Tr·∫£ G√≥p m·ªõi
  import InstallmentView from './health-staff/installment/InstallmentView.svelte';

  export let activeTab;

  let activeSubTab = 'sknv';
  let viewingDetailId = null;
  let processedReport = [];
  
  // [CODEGENESIS] C·∫≠p nh·∫≠t danh s√°ch Tab
  const tabs = [
      { id: 'sknv', label: 'SKNV', icon: 'users', title: 'SucKhoeNhanVien' },
      { id: 'doanhthu', label: 'Doanh thu LK', icon: 'dollar-sign', title: 'DoanhThuLuyKe' },
      { id: 'thunhap', label: 'Thu nh·∫≠p', icon: 'briefcase', title: 'ThuNhapNhanVien' },
      { id: 'hieuqua', label: 'Hi·ªáu qu·∫£ NV LK', icon: 'bar-chart-2', title: 'HieuQuaKhaiThac' },
      { id: 'nganhhang', label: 'DT ng√†nh h√†ng', icon: 'layers', title: 'DoanhThuNganhHang' },
      { id: 'thidua', label: 'Thi ƒëua NV LK', icon: 'award', title: 'ThiDuaNhanVien' },
      { id: 'tragop', label: 'Tr·∫£ ch·∫≠m', icon: 'credit-card', title: 'ThongKeTraCham' } // Tab M·ªõi
  ];

  let lastDataHash = '';
  $: {
      if ($danhSachNhanVien.length > 0 && $ycxData.length > 0) {
          const currentHash = `${$danhSachNhanVien.length}-${$ycxData.length}-${$selectedWarehouse}`;
          if (currentHash !== lastDataHash) {
              lastDataHash = currentHash;
              const goals = ($luykeGoalSettings && $selectedWarehouse) ? $luykeGoalSettings[$selectedWarehouse] || {} : {};
              const newMasterReport = reportService.generateMasterReportData($ycxData, goals, false);
              masterReportData.update(current => ({ ...current, sknv: newMasterReport }));
          }
      }
  }

  // ƒê√¢y l√† bi·∫øn quan tr·ªçng nh·∫•t: processedReport ch·ª©a danh s√°ch nh√¢n vi√™n ƒê√É C√ì orders
  $: {
      let rawData = $masterReportData.sknv || [];
      if ($selectedWarehouse) rawData = rawData.filter(nv => nv.maKho === $selectedWarehouse);
      processedReport = sknvService.processReportData(rawData);
  }

  function switchSubTab(tabId) { activeSubTab = tabId; viewingDetailId = null; }
  function handleEmployeeClick(event) { viewingDetailId = event.detail.employeeId; }
  function handleBackToSummary() { viewingDetailId = null; }
  
  function handleWarehouseChange(event) {
      selectedWarehouse.set(event.target.value);
  }

  function handleCompose() { 
      modalState.update(s => ({ ...s, activeModal: 'composer-modal', context: 'sknv' }));
  }
  function handleExport() { 
      actionService.handleExport('sknv');
  }
  function handleCapture() { 
      actionService.handleCapture('sknv');
  }

  afterUpdate(() => { if (typeof feather !== 'undefined') feather.replace(); });
</script>

<section id="health-employee-section" class="page-section {activeTab === 'health-employee-section' ? '' : 'hidden'}">
    
    <div class="content-card mb-6 !p-0">
        <div class="modern-page-header flex flex-wrap justify-between items-center">
            
            <div class="title-wrapper flex items-center gap-4 flex-wrap">
                <i data-feather="users" class="main-icon hidden sm:block"></i>
                
                <div class="flex items-center gap-2">
                    <h2 class="page-title text-xl sm:text-2xl font-bold text-blue-800">S·ª©c Kh·ªèe Nh√¢n Vi√™n</h2>
                    <button class="page-header__help-btn" data-help-id="sknv" title="Xem h∆∞·ªõng d·∫´n">
                        <i data-feather="help-circle"></i>
                    </button>
                </div>

                <div class="flex items-center gap-2 pl-4 border-l-2 border-blue-100 ml-2">
                    <label for="sknv-warehouse-selector" class="text-sm font-semibold text-gray-600 whitespace-nowrap">Kho:</label>
                    <select 
                        id="sknv-warehouse-selector" 
                        class="p-2 border rounded-lg text-sm shadow-sm min-w-[120px] font-bold text-blue-700 bg-white border-blue-200 focus:ring-2 focus:ring-blue-500 outline-none cursor-pointer hover:bg-blue-50 transition" 
                        value={$selectedWarehouse}
                        on:change={handleWarehouseChange}
                    >
                        <option value="">-- To√†n b·ªô --</option>
                        {#each $warehouseList as kho}
                            <option value={kho}>{kho}</option>
                        {/each}
                    </select>
                </div>
            </div>

            <div class="flex items-center gap-2 ml-auto mt-2 sm:mt-0">
                <button id="compose-sknv-notification-btn" class="action-btn action-btn--composer" title="Nh·∫≠n x√©t" on:click={handleCompose}>
                    <i data-feather="pen-tool" class="w-4 h-4"></i>
                    <span class="hidden lg:inline">Nh·∫≠n x√©t</span>
                </button>
                <button id="export-sknv-btn" class="action-btn action-btn--export" title="Xu·∫•t Excel" on:click={handleExport}>
                    <i data-feather="download" class="w-4 h-4"></i>
                    <span class="hidden lg:inline">Xu·∫•t Excel</span>
                </button>
                <button id="capture-sknv-btn" class="action-btn action-btn--capture" title="Ch·ª•p ·∫£nh" on:click={handleCapture}>
                    <i data-feather="camera" class="w-4 h-4"></i>
                    <span class="hidden lg:inline">Ch·ª•p</span>
                </button>
            </div>
        </div>
        
        <div class="content-card__body p-4">
            <div class="mb-6 overflow-x-auto pb-2">
                <nav id="employee-subtabs-nav" class="flex space-x-2 border-b border-gray-100 pb-1 w-full min-w-max" aria-label="Tabs">
                    {#each tabs as tab}
                        <button 
                            class="sub-tab-btn {activeSubTab === tab.id ? 'active' : ''}"
                            data-target="subtab-{tab.id}" 
                            data-title={tab.title} 
                            on:click={() => switchSubTab(tab.id)}
                        >
                            <i data-feather={tab.icon}></i>
                            <span>{tab.label}</span>
                        </button>
                    {/each}
                </nav>
            </div>

            <div id="employee-subtabs-content" class="min-h-[500px]">
                {#if activeSubTab === 'sknv'}
                    <div id="subtab-sknv" class="sub-tab-content">
                        {#if !viewingDetailId}
                            <div id="sknv-summary-container">
                                <SummaryView reportData={processedReport} on:click={handleEmployeeClick} />
                            </div>
                        {:else}
                            <div id="sknv-detail-capture-area">
                                <DetailView employeeId={viewingDetailId} on:back={handleBackToSummary} />
                            </div>
                        {/if}
                    </div>

                {:else if activeSubTab === 'doanhthu'}
                    <div id="subtab-doanhthu" class="sub-tab-content">
                        {#if !viewingDetailId}
                            <div id="revenue-report-container-lk">
                                <RevenueTable reportData={processedReport} on:viewDetail={handleEmployeeClick} />
                            </div>
                        {:else}
                            <div id="dtnv-lk-capture-area">
                                <RevenueDetailView employeeId={viewingDetailId} on:back={handleBackToSummary} />
                            </div>
                        {/if}
                    </div>

                {:else if activeSubTab === 'thunhap'}
                    <div id="subtab-thunhap" class="sub-tab-content">
                        <div id="income-report-container">
                            <IncomeTable reportData={processedReport} />
                        </div>
                    </div>

                {:else if activeSubTab === 'hieuqua'}
                    <div id="subtab-hieuqua" class="sub-tab-content" data-capture-preset="landscape-table">
                        <div id="efficiency-report-container">
                            <PerformanceView reportData={processedReport} />
                        </div>
                    </div>

                {:else if activeSubTab === 'nganhhang'}
                    <div id="subtab-nganhhang" class="sub-tab-content" data-capture-preset="mobile-portrait">
                        <div id="category-revenue-report-container">
                            <CategoryRevenueView reportData={processedReport} />
                        </div>
                    </div>
                
                {:else if activeSubTab === 'thidua'}
                    <div id="subtab-thidua" class="sub-tab-content">
                        <div id="competition-report-container-lk">
                            <CompetitionTab />
                        </div>
                        
                        <div class="mt-8">
                             {#if $luykeGoalSettings && $luykeGoalSettings.programTables}
                                <ProgramGoalTables 
                                    programTables={$luykeGoalSettings.programTables} 
                                    on:update={(e) => {
                                        luykeGoalSettings.update(s => ({ ...s, programTables: e.detail }));
                                    }}
                                />
                             {/if}
                        </div>
                        
                        <div id="pasted-competition-report-container" class="hidden"></div>
                    </div>

                {:else if activeSubTab === 'tragop'}
                    <div id="subtab-tragop" class="sub-tab-content">
                        <InstallmentView reportData={processedReport} />
                    </div>

                {:else}
                    <div class="p-12 text-center bg-white rounded-xl shadow-sm border border-gray-200">
                        <p class="text-gray-500">N·ªôi dung ƒëang c·∫≠p nh·∫≠t.</p>
                    </div>
                {/if}
            </div>
        </div>
    </div>
</section>
<<< FILE_END: src/components/HealthEmployeeSection.svelte
