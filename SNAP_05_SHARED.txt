CONTEXT GROUP: SNAP_05_SHARED.txt
GENERATED AT: 2/22/2026, 4:12:10 PM


>>> FILE_START: src/components/modals/AddEfficiencyColumnModal.svelte
<script>
    import { createEventDispatcher } from 'svelte';
    import { categoryStructure } from '../../stores.js';
    import { parseIdentity } from '../../utils.js';

    export let isOpen = false;
    export let editItem = null; // N·∫øu null l√† th√™m m·ªõi, c√≥ data l√† s·ª≠a
    export let isAdmin = false; // Bi·∫øn c·ªù x√°c ƒë·ªãnh Admin/User

    const dispatch = createEventDispatcher();

    // --- FORM DATA ---
    let label = '';
    let groupA = []; // L∆∞u danh s√°ch ID
    let groupB = []; // L∆∞u danh s√°ch ID
    let target = 80;
    let type = 'DTTL'; // 'SL', 'DTTL', 'DTQD'
    let searchA = '';
    let searchB = '';
    let modeA = 'group'; // 'group' | 'category'
    let modeB = 'category'; // 'group' | 'category'

    // --- DATA PREPARATION ---
    // 1. Danh s√°ch Ng√†nh h√†ng (Unique by ID)
    $: uniqueCategories = (() => {
        const map = new Map();
        ($categoryStructure || []).forEach(c => {
            if(!c.nganhHang) return;
            const parsed = parseIdentity(c.nganhHang);
            if (parsed.id && parsed.id !== 'unknown') {
                map.set(parsed.id, { 
                    id: parsed.id, 
                    display: `${parsed.id} - ${parsed.name}` 
                });
            }
        });
        return Array.from(map.values()).sort((a,b) => a.display.localeCompare(b.display));
    })();

    // 2. Danh s√°ch Nh√≥m h√†ng (Unique by ID)
    $: uniqueGroups = (() => {
        const map = new Map();
        ($categoryStructure || []).forEach(c => {
            if(!c.nhomHang) return;
            const parsed = parseIdentity(c.nhomHang);
            if (parsed.id && parsed.id !== 'unknown') {
                map.set(parsed.id, { 
                    id: parsed.id, 
                    display: `${parsed.id} - ${parsed.name}` 
                });
            }
        });
        return Array.from(map.values()).sort((a,b) => a.display.localeCompare(b.display));
    })();
    
    // --- LIST SOURCE ---
    $: listSourceA = modeA === 'group' ? uniqueGroups : uniqueCategories;
    $: listSourceB = modeB === 'group' ? uniqueGroups : uniqueCategories;

    // --- SORTING LOGIC: SELECTED FIRST ---
    // L·ªçc theo search -> S·∫Øp x·∫øp (ƒê√£ ch·ªçn l√™n ƒë·∫ßu -> Alpha)
    $: visibleListA = listSourceA
        .filter(i => i.display.toLowerCase().includes(searchA.toLowerCase()))
        .sort((a, b) => {
            const aSel = groupA.includes(a.id);
            const bSel = groupA.includes(b.id);
            if (aSel && !bSel) return -1;
            if (!aSel && bSel) return 1;
            return 0; // Gi·ªØ nguy√™n th·ª© t·ª± alpha n·∫øu c√πng tr·∫°ng th√°i
        });

    $: visibleListB = listSourceB
        .filter(i => i.display.toLowerCase().includes(searchB.toLowerCase()))
        .sort((a, b) => {
            const aSel = groupB.includes(b.id);
            const bSel = groupB.includes(a.id);
            if (aSel && !bSel) return -1; // Fix logic sort chi·ªÅu B
            if (!aSel && bSel) return 1;
            
            // Logic chu·∫©n: Selected A l√™n ƒë·∫ßu
            const isASel = groupB.includes(a.id);
            const isBSel = groupB.includes(b.id);
            if (isASel && !isBSel) return -1;
            if (!isASel && isBSel) return 1;
            return 0;
        });

    // --- INIT ---
    $: if (isOpen) {
        if (editItem) {
            label = editItem.label;
            groupA = [...(editItem.groupA || [])];
            groupB = [...(editItem.groupB || [])];
            target = editItem.target;
            type = editItem.type || 'DTTL';
            modeA = editItem.modeA || 'group';
            modeB = editItem.modeB || 'category';
        } else {
            label = '';
            groupA = [];
            groupB = [];
            target = 80;
            type = 'DTTL';
            modeA = 'group';
            modeB = 'category';
            searchA = '';
            searchB = '';
        }
    }

    // --- HANDLERS ---
    function toggleSelection(isA, id) {
        if (isA) {
            if (groupA.includes(id)) groupA = groupA.filter(i => i !== id);
            else groupA = [...groupA, id];
        } else {
            if (groupB.includes(id)) groupB = groupB.filter(i => i !== id);
            else groupB = [...groupB, id];
        }
    }

    function toggleAll(isA, sourceList) {
        // Ch·ªâ toggle nh·ªØng item ƒëang hi·ªÉn th·ªã (theo search)
        const visibleIds = sourceList.map(i => i.id);
        if (isA) {
            const allSelected = visibleIds.every(id => groupA.includes(id));
            if (allSelected) {
                // B·ªè ch·ªçn t·∫•t c·∫£ visible
                groupA = groupA.filter(id => !visibleIds.includes(id));
            } else {
                // Ch·ªçn t·∫•t c·∫£ visible (merge unique)
                groupA = [...new Set([...groupA, ...visibleIds])];
            }
        } else {
            const allSelected = visibleIds.every(id => groupB.includes(id));
            if (allSelected) {
                groupB = groupB.filter(id => !visibleIds.includes(id));
            } else {
                groupB = [...new Set([...groupB, ...visibleIds])];
            }
        }
    }

    function handleSave() {
        if (!label.trim()) return alert("Vui l√≤ng nh·∫≠p T√™n c·ªôt.");
        if (groupA.length === 0) return alert("Vui l√≤ng ch·ªçn √≠t nh·∫•t 1 m·ª•c cho T·ª≠ s·ªë (Nh√≥m A).");
        if (groupB.length === 0) return alert("Vui l√≤ng ch·ªçn √≠t nh·∫•t 1 m·ª•c cho M·∫´u s·ªë (Nh√≥m B).");

        dispatch('save', {
            id: editItem ? editItem.id : `eff_${Date.now()}`,
            label, 
            groupA, 
            groupB, 
            target: isAdmin ? 0 : target, 
            type, 
            modeA, 
            modeB
        });
        close();
    }

    function close() {
        dispatch('close');
    }
</script>

{#if isOpen}
<div class="fixed inset-0 bg-gray-900 bg-opacity-50 z-[1300] flex items-center justify-center p-4 backdrop-blur-sm" on:click={close} role="button" tabindex="0">
    <div class="bg-white rounded-xl shadow-2xl w-full max-w-5xl max-h-[90vh] flex flex-col overflow-hidden" on:click|stopPropagation>
        
        <div class="p-5 border-b border-gray-200 flex justify-between items-center bg-gray-50">
            <div>
                <h3 class="text-xl font-bold text-gray-800 flex items-center gap-2">
                    {editItem ? 'Ch·ªânh s·ª≠a' : 'Th√™m'} Ch·ªâ s·ªë Hi·ªáu qu·∫£
                    {#if isAdmin}
                        <span class="text-xs bg-orange-100 text-orange-700 px-2 py-0.5 rounded border border-orange-200 uppercase">System Config</span>
                    {/if}
                </h3>
                <p class="text-sm text-gray-500 mt-1">C√¥ng th·ª©c: (T·ªïng Nh√≥m A / T·ªïng Nh√≥m B) * 100%</p>
            </div>
            <button on:click={close} class="text-gray-400 hover:text-red-500 transition-colors text-3xl leading-none">&times;</button>
        </div>

        <div class="p-6 overflow-y-auto flex-1 custom-scrollbar bg-white">
            
            <div class="bg-slate-50 p-4 rounded-xl border border-slate-200 mb-6 grid grid-cols-1 md:grid-cols-3 gap-4 shadow-sm">
                <div>
                    <label for="col-label" class="block text-xs font-bold text-gray-500 uppercase mb-1">T√™n hi·ªÉn th·ªã</label>
                    <input id="col-label" type="text" bind:value={label} class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none text-sm font-semibold" placeholder="VD: % Gia d·ª•ng...">
                </div>

                <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Lo·∫°i d·ªØ li·ªáu</label>
                    <div class="flex gap-4 mt-2">
                        <label class="flex items-center text-sm cursor-pointer"><input type="radio" bind:group={type} value="DTTL" class="mr-1.5 accent-blue-600"> DT Th·ª±c</label>
                        <label class="flex items-center text-sm cursor-pointer"><input type="radio" bind:group={type} value="DTQD" class="mr-1.5 accent-purple-600"> DT Qƒê</label>
                        <label class="flex items-center text-sm cursor-pointer"><input type="radio" bind:group={type} value="SL" class="mr-1.5 accent-green-600"> S·ªë l∆∞·ª£ng</label>
                    </div>
                </div>

                {#if !isAdmin}
                    <div>
                        <label for="col-target" class="block text-xs font-bold text-gray-500 uppercase mb-1">M·ª•c ti√™u (%)</label>
                        <input id="col-target" type="number" bind:value={target} class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none text-sm" placeholder="80">
                    </div>
                {/if}
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 h-[500px]">
                
                <div class="flex flex-col border rounded-xl overflow-hidden border-blue-200 shadow-sm">
                    <div class="p-3 bg-blue-50 border-b border-blue-200 flex justify-between items-center">
                        <div>
                            <h4 class="font-bold text-blue-800 text-sm uppercase">T·ª≠ s·ªë (Nh√≥m A)</h4>
                            <span class="text-xs text-blue-600 font-medium">{groupA.length} ƒë√£ ch·ªçn</span>
                        </div>
                        <div class="flex bg-white rounded p-0.5 border border-blue-100">
                            <label class="cursor-pointer px-2 py-0.5 text-xs rounded transition-colors {modeA === 'group' ? 'bg-blue-100 text-blue-700 font-bold' : 'text-gray-500'}">
                                <input type="radio" bind:group={modeA} value="group" class="hidden"> Nh√≥m
                            </label>
                            <label class="cursor-pointer px-2 py-0.5 text-xs rounded transition-colors {modeA === 'category' ? 'bg-blue-100 text-blue-700 font-bold' : 'text-gray-500'}">
                                <input type="radio" bind:group={modeA} value="category" class="hidden"> Ng√†nh
                            </label>
                        </div>
                    </div>
                    
                    <div class="p-2 border-b border-blue-100 bg-white relative">
                        <input type="text" bind:value={searchA} class="w-full pl-8 p-2 border border-gray-200 rounded text-sm focus:border-blue-500 outline-none" placeholder="T√¨m ki·∫øm...">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 absolute left-4 top-3.5 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" /></svg>
                    </div>

                    <div class="flex-grow overflow-y-auto p-2 bg-slate-50 custom-scrollbar">
                        <div class="flex justify-end mb-2 px-1">
                            <button class="text-xs text-blue-600 hover:underline font-bold" on:click={() => toggleAll(true, visibleListA)}>
                                {groupA.length > 0 && visibleListA.every(i => groupA.includes(i.id)) ? 'B·ªè ch·ªçn hi·ªÉn th·ªã' : 'Ch·ªçn hi·ªÉn th·ªã'}
                            </button>
                        </div>
                        <div class="space-y-1">
                            {#each visibleListA as item (item.id)}
                                {@const isChecked = groupA.includes(item.id)}
                                <label 
                                    class="flex items-center p-2 rounded cursor-pointer transition-all select-none border
                                    {isChecked ? 'bg-blue-100 border-blue-300 shadow-sm' : 'bg-white border-transparent hover:bg-white hover:border-gray-200'}"
                                >
                                    <input type="checkbox" checked={isChecked} on:change={() => toggleSelection(true, item.id)} class="mr-3 w-4 h-4 accent-blue-600 rounded border-gray-300">
                                    <span class="text-sm {isChecked ? 'font-bold text-blue-800' : 'text-gray-700'} truncate" title={item.display}>
                                        {item.display}
                                    </span>
                                    {#if isChecked}
                                        <span class="ml-auto text-xs bg-blue-200 text-blue-800 px-1.5 rounded">‚úî</span>
                                    {/if}
                                </label>
                            {/each}
                            {#if visibleListA.length === 0}
                                <p class="text-center text-gray-400 text-xs py-4">Kh√¥ng t√¨m th·∫•y d·ªØ li·ªáu.</p>
                            {/if}
                        </div>
                    </div>
                </div>

                <div class="flex flex-col border rounded-xl overflow-hidden border-green-200 shadow-sm">
                    <div class="p-3 bg-green-50 border-b border-green-200 flex justify-between items-center">
                        <div>
                            <h4 class="font-bold text-green-800 text-sm uppercase">M·∫´u s·ªë (Nh√≥m B)</h4>
                            <span class="text-xs text-green-600 font-medium">{groupB.length} ƒë√£ ch·ªçn</span>
                        </div>
                        <div class="flex bg-white rounded p-0.5 border border-green-100">
                            <label class="cursor-pointer px-2 py-0.5 text-xs rounded transition-colors {modeB === 'group' ? 'bg-green-100 text-green-700 font-bold' : 'text-gray-500'}">
                                <input type="radio" bind:group={modeB} value="group" class="hidden"> Nh√≥m
                            </label>
                            <label class="cursor-pointer px-2 py-0.5 text-xs rounded transition-colors {modeB === 'category' ? 'bg-green-100 text-green-700 font-bold' : 'text-gray-500'}">
                                <input type="radio" bind:group={modeB} value="category" class="hidden"> Ng√†nh
                            </label>
                        </div>
                    </div>
                    
                    <div class="p-2 border-b border-green-100 bg-white relative">
                        <input type="text" bind:value={searchB} class="w-full pl-8 p-2 border border-gray-200 rounded text-sm focus:border-green-500 outline-none" placeholder="T√¨m ki·∫øm...">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 absolute left-4 top-3.5 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" /></svg>
                    </div>

                    <div class="flex-grow overflow-y-auto p-2 bg-slate-50 custom-scrollbar">
                        <div class="flex justify-end mb-2 px-1">
                            <button class="text-xs text-green-600 hover:underline font-bold" on:click={() => toggleAll(false, visibleListB)}>
                                {groupB.length > 0 && visibleListB.every(i => groupB.includes(i.id)) ? 'B·ªè ch·ªçn hi·ªÉn th·ªã' : 'Ch·ªçn hi·ªÉn th·ªã'}
                            </button>
                        </div>
                        <div class="space-y-1">
                            {#each visibleListB as item (item.id)}
                                {@const isChecked = groupB.includes(item.id)}
                                <label 
                                    class="flex items-center p-2 rounded cursor-pointer transition-all select-none border
                                    {isChecked ? 'bg-green-100 border-green-300 shadow-sm' : 'bg-white border-transparent hover:bg-white hover:border-gray-200'}"
                                >
                                    <input type="checkbox" checked={isChecked} on:change={() => toggleSelection(false, item.id)} class="mr-3 w-4 h-4 accent-green-600 rounded border-gray-300">
                                    <span class="text-sm {isChecked ? 'font-bold text-green-800' : 'text-gray-700'} truncate" title={item.display}>
                                        {item.display}
                                    </span>
                                    {#if isChecked}
                                        <span class="ml-auto text-xs bg-green-200 text-green-800 px-1.5 rounded">‚úî</span>
                                    {/if}
                                </label>
                            {/each}
                            {#if visibleListB.length === 0}
                                <p class="text-center text-gray-400 text-xs py-4">Kh√¥ng t√¨m th·∫•y d·ªØ li·ªáu.</p>
                            {/if}
                        </div>
                    </div>
                </div>

            </div>
        </div>

        <div class="p-4 border-t border-gray-200 bg-gray-50 flex justify-end gap-3">
            <button on:click={close} class="px-5 py-2.5 bg-white border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-100 font-medium transition-colors shadow-sm">H·ªßy</button>
            <button on:click={handleSave} class="px-6 py-2.5 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-bold shadow-md transition-colors flex items-center gap-2">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" />
                </svg>
                L∆∞u
            </button>
        </div>
    </div>
</div>
{/if}

<style>
    .custom-scrollbar::-webkit-scrollbar { width: 6px; }
    .custom-scrollbar::-webkit-scrollbar-track { background: #f1f1f1; }
    .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
    .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
</style>
<<< FILE_END: src/components/modals/AddEfficiencyColumnModal.svelte

>>> FILE_START: src/components/modals/AddMetricModal.svelte
<script>
    import { createEventDispatcher } from 'svelte';
    import { categoryStructure, macroCategoryConfig, macroProductGroupConfig } from '../../stores.js';
    import { cleanCategoryName } from '../../utils.js';

    export let isOpen = false;
    export let editItem = null; // [M·ªöI] Nh·∫≠n item c·∫ßn s·ª≠a

    const dispatch = createEventDispatcher();

    // Form data
    let label = '';
    let selectedGroups = [];
    let revenueType = 'REAL';
    let search = '';

    // Data Source
    $: allItems = [
        ...($macroCategoryConfig || []).map(m => m.name),
        ...($macroProductGroupConfig || []).map(m => m.name),
        ...[...new Set(($categoryStructure || []).map(c => cleanCategoryName(c.nganhHang)).filter(Boolean))],
        ...[...new Set(($categoryStructure || []).map(c => cleanCategoryName(c.nhomHang)).filter(Boolean))]
    ].sort();

    $: filteredList = allItems.filter(i => i.toLowerCase().includes(search.toLowerCase()));

    // [M·ªöI] Logic Reset / Load Data khi m·ªü modal
    $: if (isOpen) {
        if (editItem) {
            // Ch·∫ø ƒë·ªô S·ª≠a: Load d·ªØ li·ªáu t·ª´ item c≈©
            label = editItem.label;
            // V·ªõi ƒë∆°n gi√°, groupA v√† groupB gi·ªëng nhau, l·∫•y groupA l√† ƒë·ªß
            selectedGroups = [...(editItem.groupA || [])];
            // X√°c ƒë·ªãnh lo·∫°i doanh thu: N·∫øu typeA l√† DTQD -> CONVERTED, ng∆∞·ª£c l·∫°i REAL
            revenueType = editItem.typeA === 'DTQD' ? 'CONVERTED' : 'REAL';
            search = '';
        } else {
            // Ch·∫ø ƒë·ªô Th√™m m·ªõi: Reset tr·∫Øng
            label = '';
            selectedGroups = [];
            revenueType = 'REAL';
            search = '';
        }
    }

    function toggleItem(item) {
        if (selectedGroups.includes(item)) {
            selectedGroups = selectedGroups.filter(i => i !== item);
        } else {
            selectedGroups = [...selectedGroups, item];
        }
    }

    function handleSelectAll(isSelect) {
        selectedGroups = isSelect ? [...filteredList] : [];
    }

    function handleSave() {
        if (!label.trim()) return alert("Vui l√≤ng nh·∫≠p T√™n ƒê∆°n gi√°.");
        if (selectedGroups.length === 0) return alert("Vui l√≤ng ch·ªçn √≠t nh·∫•t 1 nh√≥m h√†ng.");

        const payload = {
            id: editItem ? editItem.id : `custom_price_${Date.now()}`, // Gi·ªØ ID c≈© n·∫øu s·ª≠a
            label: label,
            groupA: selectedGroups,
            groupB: selectedGroups,
            type: 'UNIT_PRICE',
            typeA: revenueType === 'REAL' ? 'DTTL' : 'DTQD',
            typeB: 'SL'
        };

        dispatch('save', payload);
        dispatch('close');
    }

    function close() {
        dispatch('close');
    }
</script>

{#if isOpen}
<div class="fixed inset-0 bg-gray-900 bg-opacity-60 z-[1300] flex items-center justify-center p-4 backdrop-blur-sm animate-fade-in" on:click={close} role="button" tabindex="0">
    <div class="bg-white rounded-xl shadow-2xl w-full max-w-lg flex flex-col max-h-[90vh] overflow-hidden" on:click|stopPropagation>
        
        <div class="p-5 border-b border-gray-200 flex justify-between items-center bg-gray-50">
            <div>
                <h3 class="text-lg font-bold text-gray-800 uppercase">
                    {editItem ? 'Ch·ªânh S·ª≠a ƒê∆°n Gi√°' : 'Th√™m ƒê∆°n Gi√° M·ªõi'}
                </h3>
                <p class="text-xs text-gray-500 mt-1">C√¥ng th·ª©c: T·ªïng Doanh thu / T·ªïng S·ªë l∆∞·ª£ng</p>
            </div>
            <button on:click={close} class="text-gray-400 hover:text-red-500 transition-colors text-2xl leading-none">&times;</button>
        </div>

        <div class="p-6 overflow-y-auto flex-1 bg-white custom-scrollbar">
            <div class="space-y-6">
                <div>
                    <label class="block text-sm font-bold text-gray-700 mb-2">1. ƒê·∫∑t t√™n ƒê∆°n gi√° <span class="text-red-500">*</span></label>
                    <input type="text" bind:value={label} class="w-full p-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none text-sm font-semibold" placeholder="VD: ƒêG Tivi, ƒêG Gia d·ª•ng..." autoFocus>
                </div>

                <div class="flex flex-col h-[300px] border border-gray-200 rounded-lg p-3 shadow-sm bg-gray-50">
                    <label class="block text-sm font-bold text-gray-700 mb-2">2. Ch·ªçn Nh√≥m h√†ng t√≠nh to√°n</label>
                    <div class="mb-2 relative">
                        <input type="text" bind:value={search} class="w-full p-2 pl-8 border border-gray-300 rounded text-xs focus:border-blue-500 outline-none bg-white" placeholder="T√¨m ki·∫øm nh√≥m h√†ng...">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 absolute left-2.5 top-2 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" /></svg>
                    </div>
                    <div class="flex justify-between items-center mb-2 px-1">
                        <span class="text-xs font-bold text-blue-600">ƒê√£ ch·ªçn: {selectedGroups.length}</span>
                        <div class="space-x-2">
                            <button on:click={() => handleSelectAll(true)} class="text-xs text-gray-500 hover:text-blue-600 underline">Ch·ªçn h·∫øt</button>
                            <button on:click={() => handleSelectAll(false)} class="text-xs text-gray-500 hover:text-red-600 underline">B·ªè ch·ªçn</button>
                        </div>
                    </div>
                    <div class="flex-grow overflow-y-auto custom-scrollbar bg-white border border-gray-200 rounded">
                        {#each filteredList as item}
                            <label class="flex items-center p-2 hover:bg-blue-50 cursor-pointer transition-colors border-b border-gray-100 last:border-0">
                                <input type="checkbox" checked={selectedGroups.includes(item)} on:change={() => toggleItem(item)} class="mr-3 w-4 h-4 accent-blue-600 rounded border-gray-300">
                                <span class="text-sm text-gray-700">{item}</span>
                            </label>
                        {/each}
                    </div>
                </div>

                <div class="bg-blue-50 p-4 rounded-lg border border-blue-100">
                    <label class="block text-sm font-bold text-blue-800 mb-2">3. Ch·ªçn lo·∫°i Doanh thu (T·ª≠ s·ªë)</label>
                    <div class="flex gap-6">
                        <label class="inline-flex items-center cursor-pointer">
                            <input type="radio" bind:group={revenueType} value="REAL" class="w-4 h-4 text-blue-600 border-gray-300 focus:ring-blue-500">
                            <span class="ml-2 text-sm text-gray-700 font-medium">Doanh thu Th·ª±c (DTLK)</span>
                        </label>
                        <label class="inline-flex items-center cursor-pointer">
                            <input type="radio" bind:group={revenueType} value="CONVERTED" class="w-4 h-4 text-purple-600 border-gray-300 focus:ring-purple-500">
                            <span class="ml-2 text-sm text-gray-700 font-medium">Doanh thu Quy ƒë·ªïi (DTQƒê)</span>
                        </label>
                    </div>
                </div>
            </div>
        </div>

        <div class="p-4 border-t border-gray-200 bg-gray-50 flex justify-end gap-3">
            <button on:click={close} class="px-5 py-2.5 bg-white border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-100 font-medium text-sm transition-colors shadow-sm">Hu·ª∑ b·ªè</button>
            <button on:click={handleSave} class="px-6 py-2.5 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-bold text-sm shadow-md transition-colors flex items-center gap-2">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" /></svg>
                L∆∞u ƒê∆°n Gi√°
            </button>
        </div>
    </div>
</div>
{/if}

<style>
    .custom-scrollbar::-webkit-scrollbar { width: 6px; }
    .custom-scrollbar::-webkit-scrollbar-track { background: #f1f1f1; }
    .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
    .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
    .animate-fade-in { animation: fadeIn 0.2s ease-out; }
    @keyframes fadeIn { from { opacity: 0; transform: scale(0.98); } to { opacity: 1; transform: scale(1); } }
</style>
<<< FILE_END: src/components/modals/AddMetricModal.svelte

>>> FILE_START: src/components/modals/AddPerformanceTableModal.svelte
<script>
    import { createEventDispatcher } from 'svelte';
    import { 
        categoryStructure, 
        macroCategoryConfig, 
        macroProductGroupConfig,
        efficiencyConfig,
        warehouseCustomMetrics
    } from '../../stores.js';
    import { parseIdentity } from '../../utils.js';

    export let isOpen = false;
    export let editItem = null;
    // null = t·∫°o m·ªõi, object = s·ª≠a
    export let isSystem = false;
    // true = Admin t·∫°o, false = User t·∫°o

    const dispatch = createEventDispatcher();
    // --- C·∫§U H√åNH UI ---
    const COLORS = [
        { id: 'blue',   bg: 'bg-blue-500',   class: 'bg-blue-100 text-blue-900 border-blue-200', label: 'Xanh d∆∞∆°ng' },
        { id: 'green',  bg: 'bg-green-500',  class: 'bg-green-100 text-green-900 border-green-200', label: 'Xanh l√°' },
        { id: 'orange', bg: 'bg-orange-500', class: 'bg-orange-100 text-orange-900 border-orange-200', label: 'Cam' },
        { id: 'purple', bg: 'bg-purple-500', class: 'bg-purple-100 text-purple-900 border-purple-200', label: 'T√≠m' },
    
        { id: 'teal',   bg: 'bg-teal-500',   class: 'bg-teal-100 text-teal-900 border-teal-200', label: 'Xanh c·ªï v·ªãt' },
        { id: 'red',    bg: 'bg-red-500',    class: 'bg-red-100 text-red-900 border-red-200', label: 'ƒê·ªè' },
        { id: 'gray',   bg: 'bg-gray-500',   class: 'bg-gray-100 text-gray-900 border-gray-200', label: 'X√°m' }
    ];
    const DATA_TYPES = [
        { id: 'DT', label: 'Doanh thu', icon: 'dollar-sign' },
        { id: 'DTQD', label: 'DTQƒê', icon: 'refresh-cw' },
        { id: 'SL', label: 'S·ªë l∆∞·ª£ng', icon: 'hash' },
        { id: 'PERCENT', label: 'T·ª∑ l·ªá %', icon: 'percent' }
    ];
    
    // [M·ªöI] C·∫•u h√¨nh l·ª±a ch·ªçn metric cho c·ªôt T·ª∑ l·ªá
    const PERCENT_METRICS = [
        { id: 'DT', label: 'Doanh thu' },
        { id: 'SL', label: 'S·ªë l∆∞·ª£ng' },
        { id: 'DTQD', label: 'DTQƒê' }
    ];

    // --- DATA SOURCES ---
    let sourceList = []; 
    let searchFilter = '';
    let sourceTypeFilter = 'ALL';
    // 'ALL' | 'GROUP' | 'CATEGORY'

    // --- STATE ---
    let tableId = '';
    let tableName = '';
    let columns = [];
    let activeColIndex = 0;
    let wasOpen = false;
    $: activeColumn = columns[activeColIndex] || null;

    // --- INITIALIZATION ---
    $: if (isOpen) {
        if (!wasOpen) {
            initDataSource();
            if (editItem) {
                tableId = editItem.id;
                tableName = editItem.title;
                // [M·ªöI] Map th√™m percentMetric n·∫øu d·ªØ li·ªáu c≈© ch∆∞a c√≥
                columns = JSON.parse(JSON.stringify(editItem.columns || [])).map(col => ({
                    ...col,
                    percentMetric: col.percentMetric || 'DT'
                }));
            } else {
                resetForm();
            }
            if (columns.length === 0) addColumn();
            activeColIndex = 0;
            searchFilter = ''; // Reset khi m·ªü
            wasOpen = true;
        }
    } else {
        wasOpen = false;
        searchFilter = '';
        sourceTypeFilter = 'ALL';
    }

    function resetForm() {
        tableId = `perf_table_${Date.now()}`;
        tableName = '';
        columns = [];
    }

    function initDataSource() {
        const uniqueMap = new Map();
        // 1. MACRO CONFIG -> Type: MACRO_GROUP
        ($macroCategoryConfig || []).forEach(m => {
            const id = (m.id || m.name).trim();
            if (!uniqueMap.has(id)) uniqueMap.set(id, { id, name: m.name, type: 'MACRO_CAT' });
        });
        ($macroProductGroupConfig || []).forEach(m => {
            const id = (m.id || m.name).trim();
            if (!uniqueMap.has(id)) uniqueMap.set(id, { id, name: m.name, type: 'MACRO_GROUP' });
        });
        // 2. DATA STRUCTURE
        const processItem = (rawString, type) => {
            if (!rawString) return;
            const { identity } = parseIdentity(rawString);
            const key = identity || rawString.trim(); 
            const displayName = rawString.trim();
            if (!uniqueMap.has(key)) {
                uniqueMap.set(key, { id: key, name: displayName, type });
            }
        };

        ($categoryStructure || []).forEach(c => {
            if (c.nhomHang) processItem(c.nhomHang, 'GROUP');
            if (c.nganhHang) processItem(c.nganhHang, 'CATEGORY');
        });
        sourceList = Array.from(uniqueMap.values()).sort((a, b) => a.name.localeCompare(b.name));
    }

    // --- COLUMN ACTIONS ---
    function addColumn() {
        columns = [...columns, {
            id: `col_${Date.now()}`,
            header: `C·ªôt ${columns.length + 1}`,
            type: 'DT',
            color: 'blue',
            items: [],
            numerator: [],
            denominator: [],
            targetId: null,
            percentMetric: 'DT' // [M·ªöI] M·∫∑c ƒë·ªãnh t√≠nh theo Doanh thu
        }];
        activeColIndex = columns.length - 1;
        searchFilter = ''; // [M·ªöI] Reset t√¨m ki·∫øm khi th√™m c·ªôt
    }

    function selectColumn(index) {
        activeColIndex = index;
        searchFilter = ''; // [M·ªöI] Reset t√¨m ki·∫øm khi chuy·ªÉn c·ªôt
    }

    function removeColumn(index) {
        if (columns.length <= 1) return alert("B·∫£ng c·∫ßn √≠t nh·∫•t 1 c·ªôt.");
        if (confirm("X√≥a c·ªôt n√†y?")) {
            columns = columns.filter((_, i) => i !== index);
            if (activeColIndex >= columns.length) {
                activeColIndex = columns.length - 1;
                searchFilter = ''; // Reset khi x√≥a v√† chuy·ªÉn c·ªôt
            }
        }
    }

    function updateActiveColumn(key, value) {
        if (!activeColumn) return;
        columns[activeColIndex][key] = value;
    }

    // --- SELECTION LOGIC ---
    function toggleSelection(item, targetArrayName) {
        if (!activeColumn) return;
        const currentArr = activeColumn[targetArrayName] || [];
        const idx = currentArr.indexOf(item.id);
        
        let newArr;
        if (idx >= 0) {
            newArr = currentArr.filter(i => i !== item.id);
        } else {
            newArr = [...currentArr, item.id];
        }
        
        columns[activeColIndex][targetArrayName] = newArr;
        if (activeColumn.type === 'PERCENT') detectExistingIndicator();
    }

    function clearAllSelection(targetArrayName) {
        if (!activeColumn) return;
        const currentArr = activeColumn[targetArrayName] || [];
        if (currentArr.length === 0) return;
        if (confirm(`B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a t·∫•t c·∫£ ${currentArr.length} m·ª•c ƒë√£ ch·ªçn?`)) {
            columns[activeColIndex][targetArrayName] = [];
            if (activeColumn.type === 'PERCENT') detectExistingIndicator();
        }
    }

    function toggleAll(targetArrayName, select) {
        if (!activeColumn) return;
        // L·∫•y danh s√°ch ƒëang hi·ªÉn th·ªã (sau khi l·ªçc)
        const visibleItems = getProcessedItems(sourceList, activeColumn[targetArrayName] || [], searchFilter, sourceTypeFilter).map(i => i.id);
        let newArr;
        if (select) {
            const currentSet = new Set(activeColumn[targetArrayName] || []);
            visibleItems.forEach(id => currentSet.add(id));
            newArr = [...currentSet];
        } else {
            const visibleSet = new Set(visibleItems);
            newArr = (activeColumn[targetArrayName] || []).filter(id => !visibleSet.has(id));
        }
        columns[activeColIndex][targetArrayName] = newArr;
    }

    function copyFromColumn(targetSide, sourceColIndex) {
        if (sourceColIndex === '' || sourceColIndex === undefined) return;
        const sourceCol = columns[sourceColIndex];
        if (!sourceCol) return;

        let sourceItems = [];
        if (sourceCol.type === 'PERCENT') {
            sourceItems = sourceCol.numerator || [];
        } else {
            sourceItems = sourceCol.items || [];
        }

        const targetKey = targetSide === 'TOP' ? 'numerator' : 'denominator';
        columns[activeColIndex][targetKey] = [...sourceItems];
        
        if (activeColumn.type === 'PERCENT') detectExistingIndicator();
    }

    function detectExistingIndicator() {
        if (!activeColumn || activeColumn.type !== 'PERCENT') return;
        const num = new Set(activeColumn.numerator || []);
        const den = new Set(activeColumn.denominator || []);

        const allConfigs = [...$efficiencyConfig, ...$warehouseCustomMetrics];
        const match = allConfigs.find(cfg => {
            const cfgNum = new Set(cfg.groupA || []);
            const cfgDen = new Set(cfg.groupB || []);
            const eq = (s1, s2) => s1.size === s2.size && [...s1].every(x => s2.has(x));
            return eq(num, cfgNum) && eq(den, cfgDen);
        });
        if (match) {
            columns[activeColIndex].targetId = match.id;
        } else {
            columns[activeColIndex].targetId = null;
        }
    }

    // --- [M·ªöI] H√ÄM X·ª¨ L√ù DANH S√ÅCH (FILTER + SORT) ---
    function getProcessedItems(items, selectedIds, filter, sourceType) {
        // 1. L·ªçc (Filter)
        const filtered = items.filter(i => {
            const matchesSearch = i.name.toLowerCase().includes(filter.toLowerCase());
            
            // Logic l·ªçc ngu·ªìn: GROUP bao g·ªìm c·∫£ Macro v√† Raw Group
            const matchesType = sourceType === 'ALL' ? true : 
                                (sourceType === 'GROUP' ? ['MACRO_CAT', 'MACRO_GROUP', 'GROUP'].includes(i.type) : i.type === 'CATEGORY');
            
            return matchesSearch && matchesType;
        
        });

        // 2. S·∫Øp x·∫øp (Sort): ƒê√£ ch·ªçn l√™n ƒë·∫ßu
        return filtered.sort((a, b) => {
            const isA = selectedIds.includes(a.id);
            const isB = selectedIds.includes(b.id);
            
            // N·∫øu tr·∫°ng th√°i ch·ªçn kh√°c nhau: ƒê√£ ch·ªçn (true) l√™n tr∆∞·ªõc
            if (isA && !isB) return -1;
            if (!isA && isB) return 1;
            
            // N·∫øu c√πng tr·∫°ng th√°i: Gi·ªØ nguy√™n th·ª© t·ª± Alpha ban ƒë·∫ßu
            return 0; 
        });
    }

    function handleSave() {
        if (!tableName.trim()) return alert("Vui l√≤ng nh·∫≠p T√™n b·∫£ng.");
        if (columns.length === 0) return alert("Vui l√≤ng th√™m √≠t nh·∫•t 1 c·ªôt.");
        for (let i = 0; i < columns.length; i++) {
            const col = columns[i];
            if (!col.header.trim()) return alert(`C·ªôt s·ªë ${i+1} ch∆∞a c√≥ t√™n.`);
            
            if (col.type === 'PERCENT') {
                if (col.numerator.length === 0) return alert(`C·ªôt "${col.header}": Ch∆∞a ch·ªçn T·ª≠ s·ªë.`);
                if (col.denominator.length === 0) return alert(`C·ªôt "${col.header}": Ch∆∞a ch·ªçn M·∫´u s·ªë.`);
                if (!col.targetId) {
                    col.targetId = `eff_custom_${Date.now()}_${i}`;
                }
            } else {
                if (col.items.length === 0) return alert(`C·ªôt "${col.header}": Ch∆∞a ch·ªçn ngu·ªìn d·ªØ li·ªáu.`);
            }
        }

        dispatch('save', {
            id: tableId,
            title: tableName,
            isSystem: isSystem,
            columns: columns
        });
        close();
    }

    function close() { dispatch('close'); }
</script>

{#if isOpen}
<div class="fixed inset-0 bg-gray-900/60 z-[1300] flex items-center justify-center p-4 backdrop-blur-sm" on:click={close} role="button" tabindex="0">
    <div class="bg-white rounded-xl shadow-2xl w-full max-w-[1300px] h-[95vh] flex flex-col overflow-hidden animate-scale-in" on:click|stopPropagation role="document" tabindex="0">
        
        <div class="p-4 border-b border-gray-200 flex justify-between items-center bg-gray-50">
            <div>
                <h3 class="text-xl font-bold text-gray-800 flex items-center gap-2">
    
                    <i data-feather="layout" class="w-5 h-5 text-blue-600"></i>
                    {editItem ? 'Ch·ªânh s·ª≠a' : 'Th√™m m·ªõi'} B·∫£ng Hi·ªáu Qu·∫£
                    {#if isSystem}
                        <span class="text-xs bg-purple-100 text-purple-700 px-2 py-0.5 rounded border border-purple-200 uppercase font-bold">System</span>
                    {/if}
                </h3>
  
                <p class="text-xs text-gray-500 mt-1">T·∫°o b·∫£ng b√°o c√°o tu·ª≥ ch·ªânh v·ªõi ƒëa d·∫°ng lo·∫°i d·ªØ li·ªáu (SL, DT, %)</p>
            </div>
            <button on:click={close} class="text-gray-400 hover:text-red-500 text-3xl leading-none transition-colors">&times;</button>
        </div>

        <div class="flex-1 overflow-hidden flex flex-col lg:flex-row">
            
      
            <div class="w-full lg:w-2/12 border-r border-gray-200 bg-white flex flex-col z-10 shadow-[2px_0_10px_rgba(0,0,0,0.05)]">
                <div class="p-3 border-b border-gray-100 bg-slate-50">
                    <label class="block text-[10px] font-bold text-gray-500 uppercase mb-1">T√™n B·∫£ng Hi·ªÉn Th·ªã</label>
                    <input 
               
                        type="text" 
                        bind:value={tableName} 
                        class="w-full p-2 border border-gray-300 rounded text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none font-bold text-gray-800 shadow-sm"
                        placeholder="VD: Hi·ªáu qu·∫£ Ph·ª• Ki·ªán..."
 
                    >
                </div>

                <div class="flex-1 overflow-y-auto p-2 space-y-2 custom-scrollbar bg-gray-50/50">
                    {#each columns as col, index}
                   
                        <div 
                            class="bg-white border rounded-lg p-3 cursor-pointer transition-all relative group
                            {activeColIndex === index ? 'border-blue-500 ring-1 ring-blue-100 shadow-md' : 'border-gray-200 hover:border-blue-300 shadow-sm'}"
                            on:click={() => selectColumn(index)}
                            role="button" tabindex="0"
                        >
          
                            <div class="flex justify-between items-center mb-1">
                                <span class="text-[10px] font-bold uppercase text-gray-400 bg-gray-100 px-1.5 py-0.5 rounded">
                                    C·ªôt {index + 1}
                                </span>
                                <button 
                                  
                                    class="text-gray-300 hover:text-red-500 p-1 rounded-md hover:bg-red-50 transition-colors"
                                    on:click|stopPropagation={() => removeColumn(index)}
                                    title="X√≥a c·ªôt"
                  
                                >
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
                 
                                </button>
                            </div>
                            <div class="text-sm font-bold text-gray-700 truncate">{col.header}</div>
                         
                            <div class="text-[10px] text-gray-500 mt-1 flex items-center gap-1">
                                <span class="w-2 h-2 rounded-full {COLORS.find(c=>c.id===col.color)?.bg || 'bg-blue-500'}"></span>
                                {DATA_TYPES.find(t=>t.id===col.type)?.label}
                            </div>
                        </div>
                
                    {/each}

                    <button 
                        class="w-full py-2 border-2 border-dashed border-gray-300 text-gray-500 rounded-lg hover:border-blue-500 hover:text-blue-600 hover:bg-blue-50 transition-all font-bold text-xs flex items-center justify-center gap-2 group"
                        on:click={addColumn}
          
                    >
                        <span class="bg-gray-200 group-hover:bg-blue-200 rounded-full p-0.5"><svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 5a1 1 0 011 1v3h3a1 1 0 110 2h-3v3a1 1 0 11-2 0v-3H6a1 1 0 110-2h3V6a1 1 0 011-1z" clip-rule="evenodd" /></svg></span>
                        Th√™m c·ªôt m·ªõi
     
                    </button>
                </div>
            </div>

            <div class="w-full lg:w-10/12 flex flex-col bg-slate-50 h-full">
                
                {#if activeColumn}
      
                    <div class="p-3 border-b border-gray-200 bg-white shadow-sm z-20 space-y-3">
                        
                        <div class="flex flex-wrap items-end gap-6">
                           
                            <div class="flex-1 min-w-[200px]">
                                <label class="block text-[10px] font-bold text-gray-400 uppercase mb-1">Ti√™u ƒë·ªÅ c·ªôt</label>
                                <input 
                        
                                    type="text" 
                                    value={activeColumn.header} 
                                    on:input={(e) => updateActiveColumn('header', e.target.value)}
           
                                    class="w-full p-2 border border-gray-300 rounded text-sm font-bold text-gray-800 focus:border-blue-500 outline-none bg-gray-50 focus:bg-white"
                                    placeholder="Nh·∫≠p t√™n c·ªôt..."
                          
                                >
                            </div>

                            <div class="flex-shrink-0">
                                <label class="block text-[10px] font-bold text-gray-400 uppercase mb-1">Lo·∫°i d·ªØ li·ªáu</label>
                                <div class="inline-flex bg-gray-100 p-1 rounded-lg">
                                    {#each DATA_TYPES as type}
                      
                                        <button 
                                            class="px-4 py-1.5 rounded-md text-xs font-bold transition-all
                                
                                            {activeColumn.type === type.id ? 'bg-white text-blue-700 shadow-sm ring-1 ring-black/5' : 'text-gray-500 hover:text-gray-700'}"
                                            on:click={() => updateActiveColumn('type', type.id)}
                                        >
      
                                            {#if type.icon === 'percent'}%{:else if type.icon === 'hash'}#{:else}${/if} {type.label}
                                        </button>
              
                                    {/each}
                                </div>
                            </div>

                  
                            <div class="flex-shrink-0">
                                <label class="block text-[10px] font-bold text-gray-400 uppercase mb-1">M√†u s·∫Øc</label>
                                <div class="flex gap-1">
                
                                    {#each COLORS as color}
                                        <button 
                                    
                                            class="w-6 h-6 rounded-full border-2 transition-transform hover:scale-110 {color.bg}
                                            {activeColumn.color === color.id ? 'border-gray-800 scale-110 shadow-sm ring-2 ring-white' : 'border-transparent opacity-70 hover:opacity-100'}"
                                            on:click={() => updateActiveColumn('color', color.id)}
                                            title={color.label}
 
                                        ></button>
                                    {/each}
                         
                                </div>
                            </div>
                        </div>

                        <div class="flex items-center gap-4 bg-blue-50/50 p-2 rounded-lg border border-blue-100">
         
                            <div class="flex items-center gap-3 border-r border-blue-200 pr-4">
                                <span class="text-[10px] font-bold uppercase text-blue-400">L·ªçc ngu·ªìn:</span>
                                <label class="flex items-center text-xs font-bold cursor-pointer hover:text-blue-700 transition-colors">
                                    <input type="radio" bind:group={sourceTypeFilter} value="ALL" class="mr-1.5 accent-blue-600"> T·∫•t c·∫£
                                </label>
                        
                                <label class="flex items-center text-xs font-bold cursor-pointer hover:text-blue-700 transition-colors">
                                    <input type="radio" bind:group={sourceTypeFilter} value="GROUP" class="mr-1.5 accent-blue-600"> Nh√≥m H√†ng (G·ªôp)
                                </label>
         
                                <label class="flex items-center text-xs font-bold cursor-pointer hover:text-blue-700 transition-colors">
                                    <input type="radio" bind:group={sourceTypeFilter} value="CATEGORY" class="mr-1.5 accent-blue-600"> Ng√†nh H√†ng (L·∫ª)
                          
                                </label>
                            </div>

                            <div class="flex-1 relative">
                                <input 
   
                                    type="text" 
                                    bind:value={searchFilter}
                              
                                    class="w-full pl-8 pr-4 py-1.5 bg-white border border-blue-200 rounded-md focus:ring-1 focus:ring-blue-500 outline-none text-sm placeholder-gray-400"
                                    placeholder="üîç T√¨m ki·∫øm nh√≥m h√†ng..."
                                >
          
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 absolute left-2.5 top-2 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" /></svg>
                            </div>
                      
                        </div>
                    </div>

                    <div class="flex-1 overflow-hidden p-4 bg-slate-100 relative">
                        {#if activeColumn.type === 'PERCENT'}
                          
                            <div class="flex flex-col items-center justify-center mb-4 gap-2">
                                
                                <div class="flex items-center gap-2">
                                    <span class="text-[10px] font-bold text-gray-400 uppercase">T√≠nh theo:</span>
                                    <div class="inline-flex bg-white border border-gray-200 p-0.5 rounded-lg shadow-sm">
                                        {#each PERCENT_METRICS as metric}
                                            <button 
                                                class="px-3 py-1 rounded-md text-[10px] font-bold transition-all
                                                {activeColumn.percentMetric === metric.id ? 'bg-blue-100 text-blue-700 shadow-sm' : 'text-gray-500 hover:bg-gray-50'}"
                                                on:click={() => updateActiveColumn('percentMetric', metric.id)}
                                            >
                                                {metric.label}
                                            </button>
                                        {/each}
                                    </div>
                                </div>

                                <div class="bg-white border border-gray-200 shadow-sm px-6 py-2 rounded-full flex items-center gap-3">
                                    <span class="text-xs font-bold text-gray-500 uppercase">C√¥ng th·ª©c:</span>
                                    <div class="flex items-center gap-2 font-mono text-sm font-bold text-gray-700">
                                        
                                        <span class="bg-blue-100 text-blue-700 px-2 py-0.5 rounded border border-blue-200">( A ) T·ª≠ s·ªë</span>
                                        <span class="text-gray-400">/</span>
                                        <span class="bg-orange-100 text-orange-700 px-2 py-0.5 rounded border border-orange-200">( B ) M·∫´u s·ªë</span>
                                        <span class="text-gray-400">x</span>
                                        <span class="text-green-600">100%</span>
               
                                    </div>
                                </div>
                            </div>

                   
                            <div class="flex h-[calc(100%-85px)] gap-4">
                                
                                <div class="flex-1 flex flex-col border border-blue-200 rounded-xl overflow-hidden shadow-sm bg-white">
               
                                    <div class="bg-blue-50 p-3 border-b border-blue-100">
                                        <div class="flex justify-between items-center mb-2">
                               
                                            <div class="flex items-center gap-2">
                                                <span class="bg-blue-600 text-white w-6 h-6 flex items-center justify-center rounded-full text-xs font-bold shadow-sm">A</span>
                         
                                                <span class="font-bold text-blue-800 text-sm uppercase">T·ª≠ S·ªë</span>
                                            </div>
                            
                                            <div class="flex gap-2 text-[10px]">
                                                <button class="text-blue-600 font-bold hover:underline" on:click={() => toggleAll('numerator', true)}>Ch·ªçn h·∫øt</button>
                         
                                                <button class="text-red-500 font-bold hover:underline" on:click={() => clearAllSelection('numerator')}>X√≥a t·∫•t c·∫£</button>
                                            </div>
                         
                                        </div>
                                        <div class="relative">
                                            
                                            <select 
                                                class="w-full text-xs border border-blue-200 rounded-lg px-2 py-1.5 text-blue-700 bg-white focus:outline-none focus:ring-1 focus:ring-blue-400 cursor-pointer"
                                       
                                                on:change={(e) => { copyFromColumn('TOP', e.target.value); e.target.value = ''; }}
                                            >
                                                <option value="">‚ö° N·∫°p nhanh t·ª´ c·ªôt kh√°c...</option>
  
                                                {#each columns.slice(0, activeColIndex) as prevCol, idx}
                                                 
                                                    <option value={idx}>L·∫•y t·ª´: {prevCol.header}</option>
                                                {/each}
                                            </select>
  
                                        </div>
                                    </div>
                          
           
                                    <div class="flex-1 overflow-y-auto p-2 custom-scrollbar">
                                        {@render DataSourceList({ 
        
                                            items: getProcessedItems(sourceList, activeColumn.numerator, searchFilter, sourceTypeFilter), 
                                            selectedIds: activeColumn.numerator, 
             
                                            onToggle: (item) => toggleSelection(item, 'numerator'),
                                            selectedColor: "bg-blue-50 border-blue-300 text-blue-800 shadow-sm"
                 
                                        })}
                                    </div>
                                    <div class="bg-gray-50 px-3 py-1.5 text-xs text-gray-500 text-center border-t border-gray-100 font-bold">
                                        ƒê√£ ch·ªçn: <span class="text-blue-600">{activeColumn.numerator.length}</span>
                                    </div>
                 
                                </div>

                                <div class="flex-1 flex flex-col border border-orange-200 rounded-xl overflow-hidden shadow-sm bg-white">
                                    <div class="bg-orange-50 p-3 border-b border-orange-100">
    
                                        <div class="flex justify-between items-center mb-2">
                                            <div class="flex items-center gap-2">
             
                                                <span class="bg-orange-500 text-white w-6 h-6 flex items-center justify-center rounded-full text-xs font-bold shadow-sm">B</span>
                                                <span class="font-bold text-orange-800 text-sm uppercase">M·∫´u S·ªë</span>
 
                                            </div>
                                            <div class="flex gap-2 text-[10px]">
          
                                                <button class="text-orange-600 font-bold hover:underline" on:click={() => toggleAll('denominator', true)}>Ch·ªçn h·∫øt</button>
                                                <button class="text-red-500 font-bold hover:underline" on:click={() => clearAllSelection('denominator')}>X√≥a t·∫•t c·∫£</button>
                                            </div>
                                        </div>
              
                                        <div class="relative">
                                            <select 
                            
                                                class="w-full text-xs border border-orange-200 rounded-lg px-2 py-1.5 text-orange-700 bg-white focus:outline-none focus:ring-1 focus:ring-orange-400 cursor-pointer"
                                                on:change={(e) => { copyFromColumn('BOTTOM', e.target.value); e.target.value = ''; }}
                                            >
                                                <option value="">‚ö° N·∫°p nhanh t·ª´ c·ªôt kh√°c...</option>
                                                {#each columns.slice(0, activeColIndex) as prevCol, idx}
                                              
                                                    <option value={idx}>L·∫•y t·ª´: {prevCol.header}</option>
                                                {/each}
                                           
                                            </select>
                                        </div>
                                    </div>

                       
                                    <div class="flex-1 overflow-y-auto p-2 custom-scrollbar">
                                        {@render DataSourceList({ 
                                         
                                            items: getProcessedItems(sourceList, activeColumn.denominator, searchFilter, sourceTypeFilter), 
                                            selectedIds: activeColumn.denominator, 
                                            onToggle: (item) => toggleSelection(item, 'denominator'),
                                            selectedColor: "bg-orange-50 border-orange-300 text-orange-800 shadow-sm"
                                        })}
          
                                    </div>
                                    <div class="bg-gray-50 px-3 py-1.5 text-xs text-gray-500 text-center border-t border-gray-100 font-bold">
                             
                                        ƒê√£ ch·ªçn: <span class="text-orange-600">{activeColumn.denominator.length}</span>
                                    </div>
                                </div>
                  
                            </div>

                        {:else}
                            <div class="h-full flex flex-col border border-gray-200 rounded-xl overflow-hidden shadow-sm bg-white">
                             
                                <div class="bg-gray-50 p-2 border-b border-gray-200 flex justify-between items-center">
                                    <span class="font-bold text-gray-700 text-xs uppercase px-2">Danh s√°ch Ngu·ªìn d·ªØ li·ªáu</span>
                                    <div class="flex gap-3 text-xs px-2">
     
                                        <button class="text-blue-600 font-bold hover:underline" on:click={() => toggleAll('items', true)}>Ch·ªçn hi·ªÉn th·ªã</button>
                                        <button class="text-red-500 font-bold hover:underline" on:click={() => clearAllSelection('items')}>X√≥a t·∫•t c·∫£</button>
        
                                    </div>
                                </div>
                                <div class="flex-1 overflow-y-auto p-4 custom-scrollbar">
    
                                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-2">
                                        {@render DataSourceList({ 
                     
                                            items: getProcessedItems(sourceList, activeColumn.items, searchFilter, sourceTypeFilter), 
                                            selectedIds: activeColumn.items, 
                          
                                            onToggle: (item) => toggleSelection(item, 'items'),
                                            selectedColor: "bg-blue-50 border-blue-300 text-blue-800 ring-1 ring-blue-200 shadow-sm",
                            
                                            gridLayout: true
                                        })}
                                    </div>
       
                                </div>
                                <div class="bg-gray-50 p-2 text-xs text-gray-500 border-t border-gray-200 flex justify-between px-4">
                                  
                                    <span>T·ªïng ngu·ªìn: {sourceList.length}</span>
                                    <span>ƒê√£ ch·ªçn: <strong>{activeColumn.items.length}</strong></span>
                                </div>
                          
                            </div>
                        {/if}
                    </div>

                {:else}
                    <div class="h-full flex items-center justify-center text-gray-400 bg-gray-50">
            
                        <div class="text-center">
                            <i data-feather="arrow-left" class="w-8 h-8 mx-auto mb-2 opacity-50"></i>
                            <p>Vui l√≤ng ch·ªçn ho·∫∑c th√™m m·ªôt c·ªôt ƒë·ªÉ c·∫•u h√¨nh.</p>
                
                        </div>
                    </div>
                {/if}
            </div>
        </div>

        <div class="p-4 border-t border-gray-200 bg-white flex justify-end gap-3 z-30">
            <button on:click={close} class="px-6 py-2.5 bg-white border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-100 font-medium transition-colors shadow-sm">H·ªßy</button>
            <button on:click={handleSave} class="px-8 py-2.5 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-bold shadow-md transition-colors flex items-center gap-2">
                <i data-feather="save" class="w-4 h-4"></i> L∆∞u B·∫£ng
            </button>
        </div>
    </div>
</div>
{/if}

{#snippet DataSourceList({ items, selectedIds, onToggle, selectedColor, gridLayout = false })}
    {#each items as item (item.id)}
        {@const isSelected = selectedIds.includes(item.id)}
        <div 
            class="flex items-center p-2 rounded cursor-pointer border transition-all select-none
            {isSelected ? selectedColor : 'bg-white border-transparent hover:bg-gray-50 hover:border-gray-200'}"
            on:click={() => onToggle(item)}
            role="button" tabindex="0"
        >
            <div class="mr-2 flex-shrink-0 flex items-center justify-center w-4 h-4 border rounded 
                {isSelected ? 'bg-blue-600 border-transparent' : 'border-gray-300 bg-white'}">
                {#if isSelected}
                    <svg xmlns="http://www.w3.org/2000/svg" class="w-3 h-3 text-white" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" />
    
                    </svg>
                {/if}
            </div>
            <span class="text-xs truncate flex-1 {isSelected ? 'font-bold' : 'text-gray-600'}">
                {item.name}
            </span>
            {#if item.type.includes('MACRO')}
                <span class="text-[9px] px-1 bg-gray-200 text-gray-500 rounded ml-1 font-bold">G·ªòP</span>
            {/if}
        </div>
    {/each}
{/snippet}

<style>
    .animate-scale-in { animation: scaleIn 0.2s ease-out; }
    @keyframes scaleIn { from { opacity: 0; transform: scale(0.98); } to { opacity: 1; transform: scale(1); } }
    
    .custom-scrollbar::-webkit-scrollbar { width: 6px; }
    .custom-scrollbar::-webkit-scrollbar-track { background: #f8fafc; }
    .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
    .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
</style>
<<< FILE_END: src/components/modals/AddPerformanceTableModal.svelte

>>> FILE_START: src/components/modals/AddRevenueTableModal.svelte
<script>
    import { createEventDispatcher } from 'svelte';
    import { categoryStructure } from '../../stores.js';
    import { parseIdentity } from '../../utils.js';

    export let isOpen = false;
    export let editItem = null;

    const dispatch = createEventDispatcher();

    // --- D·ªÆ LI·ªÜU ---
    let tableName = '';
    let tableId = '';
    let isSystem = false; // [FIX] Bi·∫øn c·ªù x√°c ƒë·ªãnh b·∫£ng h·ªá th·ªëng
    
    // C·∫•u h√¨nh C·ªôt T·ªïng (Main Column)
    let mainColumn = {
        header: 'T·ªïng c·ªông',
        type: 'group', // 'group' | 'category'
        items: [],     // Danh s√°ch ID ƒë√£ ch·ªçn
        metrics: { sl: false, dt: true, dtqd: false }
    };

    // Danh s√°ch C·ªôt Ph·ª•
    let subColumns = [];
    
    // --- UI STATE ---
    let activeContext = 'main'; // 'main' | 'sub'
    let activeSubIndex = 0;     // Index n·∫øu ƒëang s·ª≠a sub column
    let searchText = '';
    let showSelectedOnly = false;

    // --- HELPER: L·∫•y c·ªôt ƒëang Active ---
    $: activeColumn = activeContext === 'main' ? mainColumn : subColumns[activeSubIndex];

    // 1. Chu·∫©n h√≥a Ng√†nh h√†ng (L·∫•y ID)
    $: uniqueCategories = (() => {
        const map = new Map();
        ($categoryStructure || []).forEach(c => {
            if(!c.nganhHang) return;
            const parsed = parseIdentity(c.nganhHang);
            map.set(parsed.id, { 
                id: parsed.id, 
                name: parsed.name, 
                display: parsed.name.includes(parsed.id) ? parsed.name : `${parsed.id} - ${parsed.name}`
            });
        });
        return Array.from(map.values()).sort((a,b) => a.name.localeCompare(b.name));
    })();

    // 2. Chu·∫©n h√≥a Nh√≥m h√†ng (L·∫•y ID)
    $: uniqueGroups = (() => {
        const map = new Map();
        ($categoryStructure || []).forEach(c => {
            if(!c.nhomHang) return;
            const id = c.maNhomHang || parseIdentity(c.nhomHang).id;
            const name = c.nhomHang;
            map.set(id, { 
                id: id, 
                name: name, 
                display: name.includes(id) ? name : `${id} - ${name}`
            });
        });
        return Array.from(map.values()).sort((a,b) => a.name.localeCompare(b.name));
    })();

    // --- INIT ---
    $: if (isOpen) {
        if (editItem) {
            tableId = editItem.id;
            tableName = editItem.title;
            // [FIX] L·∫•y tr·∫°ng th√°i isSystem t·ª´ item s·ª≠a ho·∫∑c payload
            isSystem = !!editItem.isSystem; 
            
            mainColumn = editItem.mainColumn ? JSON.parse(JSON.stringify(editItem.mainColumn)) : { 
                header: 'T·ªïng c·ªông', type: 'group', items: [], metrics: { sl: false, dt: true, dtqd: false } 
            };
            subColumns = JSON.parse(JSON.stringify(editItem.subColumns || []));
        } else {
            // [FIX] Reset form v√† ki·ªÉm tra payload (Admin truy·ªÅn { isSystem: true })
            isSystem = editItem?.isSystem || false;

            tableId = `tbl_${Date.now()}`;
            tableName = '';
            mainColumn = { 
                header: 'T·ªïng c·ªông', type: 'group', items: [], metrics: { sl: false, dt: true, dtqd: false } 
            };
            subColumns = [];
            addSubColumn();
        }
        selectMain();
    }

    // --- NAVIGATION ---
    function selectMain() {
        activeContext = 'main';
        resetFilter();
    }

    function selectSub(index) {
        activeContext = 'sub';
        activeSubIndex = index;
        resetFilter();
    }

    function resetFilter() {
        searchText = '';
        showSelectedOnly = false;
    }

    // --- COLUMN ACTIONS ---
    function addSubColumn() {
        subColumns = [
            ...subColumns, 
            { 
                header: `C·ªôt ${subColumns.length + 1}`, 
                type: 'group', 
                items: [], 
                metrics: { sl: false, dt: true, dtqd: false } 
            }
        ];
        selectSub(subColumns.length - 1);
    }

    function removeSubColumn(index) {
        if(subColumns.length <= 1) return alert("C·∫ßn √≠t nh·∫•t 1 c·ªôt ph·ª•.");
        if(!confirm("X√≥a c·ªôt n√†y?")) return;
        
        subColumns = subColumns.filter((_, i) => i !== index);
        if (activeSubIndex >= subColumns.length) {
            activeSubIndex = subColumns.length - 1;
        }
    }

    // --- ITEM SELECTION LOGIC ---
    function toggleItem(itemId) {
        const currentItems = new Set(activeColumn.items || []);
        if (currentItems.has(itemId)) currentItems.delete(itemId);
        else currentItems.add(itemId);
        activeColumn.items = [...currentItems];
    }

    function toggleAll(listSource) {
        const allIds = listSource.map(i => i.id);
        const currentLen = activeColumn.items.length;
        
        if (currentLen > 0 && currentLen >= allIds.length) {
            activeColumn.items = [];
        } else {
            activeColumn.items = [...allIds];
        }
    }

    function clearSelection() {
        if(!confirm("X√≥a s·∫°ch danh s√°ch ƒë√£ ch·ªçn c·ªßa c·ªôt n√†y?")) return;
        activeColumn.items = [];
    }

    function handleTypeChange(newType) {
        activeColumn.type = newType;
    }

    // --- SAVE ---
    function handleSave() {
        if (!tableName.trim()) return alert("Vui l√≤ng nh·∫≠p T√™n b·∫£ng.");
        if (!mainColumn.header.trim()) return alert("Vui l√≤ng nh·∫≠p t√™n C·ªôt T·ªïng.");
        
        if (subColumns.length === 0) return alert("Vui l√≤ng th√™m √≠t nh·∫•t 1 c·ªôt ph·ª•.");
        
        for (let i = 0; i < subColumns.length; i++) {
            const col = subColumns[i];
            if (!col.header.trim()) return alert(`C·ªôt ph·ª• s·ªë ${i+1} ch∆∞a c√≥ t√™n.`);
            if (!col.items || col.items.length === 0) return alert(`C·ªôt "${col.header}" ch∆∞a ch·ªçn d·ªØ li·ªáu.`);
        }

        dispatch('save', {
            id: tableId,
            title: tableName,
            isSystem: isSystem, // [FIX] Quan tr·ªçng: G·ª≠i c·ªù h·ªá th·ªëng v·ªÅ App
            mainColumn: mainColumn, 
            subColumns: subColumns
        });
        close();
    }

    function close() { dispatch('close'); }

    // --- FILTER LOGIC ---
    $: currentListSource = (activeColumn.type === 'category') ? uniqueCategories : uniqueGroups;
    
    $: filteredList = currentListSource.filter(item => {
        const matchesSearch = item.display.toLowerCase().includes(searchText.toLowerCase());
        const isSelected = activeColumn.items?.includes(item.id);
        if (showSelectedOnly) return matchesSearch && isSelected;
        return matchesSearch;
    });

</script>

{#if isOpen}
<div class="fixed inset-0 bg-gray-900 bg-opacity-50 z-[1300] flex items-center justify-center p-4 backdrop-blur-sm" on:click={close} role="button" tabindex="0">
    <div class="bg-white rounded-xl shadow-2xl w-full max-w-6xl max-h-[95vh] flex flex-col overflow-hidden" on:click|stopPropagation role="document" tabindex="0">
        
        <div class="p-4 border-b border-gray-200 flex justify-between items-center bg-gray-50">
            <div>
                <h3 class="text-lg font-bold text-gray-800">
                    {editItem ? 'Ch·ªânh s·ª≠a' : 'Th√™m m·ªõi'} B·∫£ng Doanh Thu 
                    {#if isSystem}
                        <span class="ml-2 text-xs bg-indigo-100 text-indigo-700 px-2 py-1 rounded border border-indigo-200 uppercase">H·ªá th·ªëng</span>
                    {/if}
                </h3>
                <p class="text-xs text-gray-500">C·∫•u h√¨nh ngu·ªìn d·ªØ li·ªáu theo ID cho t·ª´ng c·ªôt.</p>
            </div>
            <button on:click={close} class="text-gray-400 hover:text-red-500 text-2xl leading-none">&times;</button>
        </div>

        <div class="flex-1 overflow-hidden flex flex-col lg:flex-row bg-gray-50">
            
            <div class="w-full lg:w-1/3 border-r border-gray-200 bg-white flex flex-col">
                <div class="p-4 border-b border-gray-100 bg-slate-50">
                    <label class="block text-[10px] font-bold text-gray-500 uppercase mb-1">T√™n B·∫£ng</label>
                    <input 
                        type="text" 
                        bind:value={tableName} 
                        class="w-full p-2 border border-gray-300 rounded text-sm focus:ring-1 focus:ring-blue-500 outline-none font-bold text-gray-800"
                        placeholder="VD: B√°o c√°o Apple..."
                    >
                </div>

                <div class="flex-1 overflow-y-auto p-3 space-y-3 custom-scrollbar">
                    
                    <div 
                        class="border-2 rounded-lg p-3 cursor-pointer transition-all relative
                        {activeContext === 'main' ? 'border-orange-400 bg-orange-50 shadow-md ring-1 ring-orange-300' : 'border-gray-200 bg-white hover:border-orange-200'}"
                        on:click={selectMain}
                        role="button" tabindex="0"
                    >
                        <div class="flex items-center justify-between mb-2">
                            <div class="flex items-center gap-2">
                                <span class="bg-orange-500 text-white text-[10px] font-bold px-2 py-0.5 rounded uppercase">Main</span>
                                <span class="text-xs font-bold text-gray-700 uppercase">C·ªôt T·ªïng</span>
                            </div>
                            <span class="text-[10px] bg-white border border-gray-200 text-gray-500 px-1.5 py-0.5 rounded">
                                {mainColumn.items.length} m·ª•c
                            </span>
                        </div>
                        
                        <div class="space-y-2">
                            <input 
                                type="text" 
                                bind:value={mainColumn.header} 
                                class="w-full bg-transparent border-b border-gray-300 focus:border-orange-500 outline-none text-sm font-bold text-gray-800 pb-1"
                                placeholder="T√™n c·ªôt t·ªïng..."
                            >
                            <div class="flex gap-2">
                                <label class="flex items-center text-[10px] text-gray-600 cursor-pointer"><input type="checkbox" bind:checked={mainColumn.metrics.sl} class="mr-1 accent-orange-600"> SL</label>
                                <label class="flex items-center text-[10px] text-gray-600 cursor-pointer"><input type="checkbox" bind:checked={mainColumn.metrics.dt} class="mr-1 accent-orange-600"> DT</label>
                                <label class="flex items-center text-[10px] text-gray-600 cursor-pointer"><input type="checkbox" bind:checked={mainColumn.metrics.dtqd} class="mr-1 accent-orange-600"> DTQƒê</label>
                            </div>
                        </div>
                    </div>

                    <div class="flex items-center gap-2 text-[10px] text-gray-400 uppercase font-bold px-1">
                        <div class="flex-1 h-px bg-gray-200"></div>
                        C√°c c·ªôt ph·ª•
                        <div class="flex-1 h-px bg-gray-200"></div>
                    </div>

                    {#each subColumns as col, index}
                        <div 
                            class="border rounded p-3 cursor-pointer transition-all relative group
                            {activeContext === 'sub' && activeSubIndex === index ? 'border-blue-500 bg-blue-50 shadow-sm ring-1 ring-blue-500' : 'border-gray-200 bg-white hover:border-blue-300'}"
                            on:click={() => selectSub(index)}
                            role="button" tabindex="0"
                        >
                            <button 
                                class="absolute top-2 right-2 text-gray-300 hover:text-red-500 opacity-0 group-hover:opacity-100 transition-opacity"
                                on:click|stopPropagation={() => removeSubColumn(index)}
                                title="X√≥a c·ªôt n√†y"
                            >
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
                            </button>

                            <div class="space-y-2 pr-4">
                                <div class="flex justify-between items-center">
                                    <label class="text-[10px] text-gray-400 font-bold uppercase">C·ªôt {index + 1}</label>
                                    <span class="text-[10px] bg-gray-100 text-gray-500 px-1.5 py-0.5 rounded">
                                        {col.items.length} m·ª•c
                                    </span>
                                </div>
                                <input 
                                    type="text" 
                                    bind:value={col.header} 
                                    class="w-full bg-transparent border-b border-gray-300 focus:border-blue-500 outline-none text-sm font-semibold text-gray-700 pb-1"
                                    placeholder="Nh·∫≠p t√™n c·ªôt..."
                                >
                                <div class="flex gap-2">
                                    <label class="flex items-center text-[10px] text-gray-600 cursor-pointer"><input type="checkbox" bind:checked={col.metrics.sl} class="mr-1 rounded text-blue-600"> SL</label>
                                    <label class="flex items-center text-[10px] text-gray-600 cursor-pointer"><input type="checkbox" bind:checked={col.metrics.dt} class="mr-1 rounded text-blue-600"> DT</label>
                                    <label class="flex items-center text-[10px] text-gray-600 cursor-pointer"><input type="checkbox" bind:checked={col.metrics.dtqd} class="mr-1 rounded text-blue-600"> DTQƒê</label>
                                </div>
                            </div>
                        </div>
                    {/each}
                </div>

                <div class="p-3 border-t border-gray-200">
                    <button 
                        class="w-full py-2 border-2 border-dashed border-gray-300 text-gray-500 rounded hover:border-blue-500 hover:text-blue-500 transition font-bold text-sm flex items-center justify-center gap-2"
                        on:click={addSubColumn}
                    >
                        + Th√™m c·ªôt ph·ª•
                    </button>
                </div>
            </div>

            <div class="w-full lg:w-2/3 flex flex-col bg-slate-50">
                <div class="p-3 border-b border-gray-200 bg-white shadow-sm z-10 space-y-3">
                    <div class="flex justify-between items-start">
                        <div>
                            <h4 class="font-bold text-slate-800 text-sm">
                                C·∫•u h√¨nh: <span class="{activeContext === 'main' ? 'text-orange-600' : 'text-blue-600'}">"{activeColumn.header}"</span>
                            </h4>
                            <div class="flex gap-4 mt-2 text-xs font-medium text-gray-600">
                                <label class="flex items-center cursor-pointer hover:text-black">
                                    <input 
                                        type="radio" 
                                        name="colType"
                                        checked={activeColumn.type === 'group'} 
                                        on:change={() => handleTypeChange('group')}
                                        class="mr-1.5 w-4 h-4 {activeContext === 'main' ? 'accent-orange-600' : 'accent-blue-600'}"
                                    > 
                                    Nh√≥m H√†ng
                                </label>
                                <label class="flex items-center cursor-pointer hover:text-black">
                                    <input 
                                        type="radio" 
                                        name="colType"
                                        checked={activeColumn.type === 'category'} 
                                        on:change={() => handleTypeChange('category')}
                                        class="mr-1.5 w-4 h-4 {activeContext === 'main' ? 'accent-orange-600' : 'accent-blue-600'}"
                                    > 
                                    Ng√†nh H√†ng
                                </label>
                            </div>
                        </div>
                        
                        <div class="flex gap-2">
                            <button 
                                class="px-2 py-1 text-xs font-medium rounded border transition-colors {showSelectedOnly ? (activeContext === 'main' ? 'bg-orange-100 text-orange-700 border-orange-200' : 'bg-blue-100 text-blue-700 border-blue-200') : 'bg-white text-gray-600 border-gray-300 hover:bg-gray-50'}"
                                on:click={() => showSelectedOnly = !showSelectedOnly}
                            >
                                {showSelectedOnly ? 'Hi·ªán t·∫•t c·∫£' : `ƒê√£ ch·ªçn (${activeColumn.items.length})`}
                            </button>
                            
                            <button 
                                class="px-2 py-1 text-xs font-bold text-red-600 bg-red-50 border border-red-200 rounded hover:bg-red-100 transition flex items-center gap-1"
                                on:click={clearSelection}
                                title="X√≥a s·∫°ch d·ªØ li·ªáu ƒë√£ ch·ªçn"
                            >
                                X√≥a ch·ªçn üßπ
                            </button>
                        </div>
                    </div>
                    
                    <div class="relative">
                        <input 
                            type="text" 
                            bind:value={searchText}
                            class="w-full pl-9 pr-4 py-2 border border-gray-300 rounded focus:ring-1 {activeContext === 'main' ? 'focus:ring-orange-500' : 'focus:ring-blue-500'} outline-none text-sm"
                            placeholder="T√¨m ki·∫øm t√™n ho·∫∑c m√£..."
                        >
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 absolute left-3 top-3 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" /></svg>
                    </div>
                </div>

                <div class="flex-1 overflow-y-auto p-4 custom-scrollbar">
                     <div class="mb-3 flex justify-between items-center px-1">
                        <span class="text-xs text-gray-500 italic">T√¨m th·∫•y {filteredList.length} m·ª•c</span>
                        <button 
                            class="text-xs font-bold hover:underline {activeContext === 'main' ? 'text-orange-600' : 'text-blue-600'}"
                            on:click={() => toggleAll(filteredList)}
                        >
                            {activeColumn.items.length >= filteredList.length && filteredList.length > 0 ? 'B·ªè ch·ªçn t·∫•t c·∫£' : 'Ch·ªçn t·∫•t c·∫£'}
                        </button>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-2">
                        {#each filteredList as item (item.id)}
                            {@const isChecked = activeColumn.items.includes(item.id)}
                            <label 
                                class="flex items-start p-2 rounded border cursor-pointer transition-all select-none
                                {isChecked 
                                    ? (activeContext === 'main' ? 'bg-orange-50 border-orange-300 ring-1 ring-orange-300' : 'bg-blue-50 border-blue-300 ring-1 ring-blue-300') 
                                    : 'bg-white border-gray-200 hover:border-gray-300 hover:shadow-sm'}"
                            >
                                <input 
                                    type="checkbox" 
                                    checked={isChecked} 
                                    on:change={() => toggleItem(item.id)}
                                    class="mt-1 mr-3 w-4 h-4 rounded border-gray-300 {activeContext === 'main' ? 'accent-orange-600' : 'accent-blue-600'}"
                                >
                                <div class="flex flex-col overflow-hidden">
                                    <span class="text-sm font-medium text-gray-800 truncate" title={item.display}>{item.display}</span>
                                    <span class="text-[10px] text-gray-500 font-mono mt-0.5">ID: {item.id}</span>
                                </div>
                            </label>
                        {:else}
                            <div class="col-span-full py-10 text-center">
                                <div class="text-gray-300 mb-2 text-4xl">üì≠</div>
                                <p class="text-gray-500 text-sm">Kh√¥ng t√¨m th·∫•y d·ªØ li·ªáu.</p>
                            </div>
                        {/each}
                    </div>
                </div>
            </div>
        </div>

        <div class="p-4 border-t border-gray-200 bg-white flex justify-end gap-3 z-20">
            <button on:click={close} class="px-6 py-2 bg-white border border-gray-300 text-gray-700 rounded hover:bg-gray-100 font-medium transition-colors shadow-sm">H·ªßy</button>
            <button on:click={handleSave} class="px-8 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 font-bold shadow-md transition-colors flex items-center gap-2">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" /></svg>
                L∆∞u B·∫£ng
            </button>
        </div>
    </div>
</div>
{/if}

<style>
    .custom-scrollbar::-webkit-scrollbar { width: 6px; }
    .custom-scrollbar::-webkit-scrollbar-track { background: #f1f1f1; }
    .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
    .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
</style>
<<< FILE_END: src/components/modals/AddRevenueTableModal.svelte

>>> FILE_START: src/components/modals/AdminModal.svelte
<script>
    import { modalState, activeTab } from '../../stores.js';
    import { authService } from '../../services/auth.service.js';
    import { tick } from 'svelte';

    let password = '';
    let showError = false;
    let passwordInput;
    let isBackdropMouseDown = false; // [FIX] Bi·∫øn c·ªù ki·ªÉm tra

    // Reactive: Ki·ªÉm tra modal
    $: isOpen = $modalState.activeModal === 'admin-modal';

    // Reactive: Khi m·ªü modal, reset form v√† focus input
    $: if (isOpen) {
        resetForm();
        focusInput();
    }

    async function focusInput() {
        await tick();
        if (passwordInput) passwordInput.focus();
    }

    function resetForm() {
        password = '';
        showError = false;
    }

    function close() {
        modalState.update(s => ({ ...s, activeModal: null }));
    }

    function submit() {
        const isValid = authService.checkAdminPassword(password);
        if (isValid) {
            activeTab.set('declaration-section');
            close();
        } else {
            showError = true;
            password = '';
            focusInput();
        }
    }

    function handleKeydown(event) {
        if (event.key === 'Enter') submit();
        else if (event.key === 'Escape') close();
    }

    // [FIX] Logic x·ª≠ l√Ω click backdrop an to√†n
    function handleBackdropMouseDown(e) {
        if (e.target === e.currentTarget) {
            isBackdropMouseDown = true;
        }
    }

    function handleBackdropClick(e) {
        if (e.target === e.currentTarget && isBackdropMouseDown) {
            close();
        }
        isBackdropMouseDown = false; // Reset sau m·ªói l·∫ßn click
    }
</script>

{#if isOpen}
    <div 
        class="fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center z-[1050] transition-opacity backdrop-blur-sm"
        on:mousedown={handleBackdropMouseDown}
        on:click={handleBackdropClick}
        role="button"
        tabindex="0"
    >
        <div 
            class="bg-white p-6 rounded-xl shadow-xl w-full max-w-sm mx-4 transform transition-all scale-100"
            on:click|stopPropagation
            on:mousedown|stopPropagation={() => isBackdropMouseDown = false} 
        >
            <div class="mb-4">
                <h3 class="text-lg font-bold text-gray-900">Truy c·∫≠p khu v·ª±c Admin</h3>
            </div>
            
            <p class="text-sm text-gray-600 mb-4">
                 Vui l√≤ng nh·∫≠p m·∫≠t kh·∫©u ƒë·ªÉ xem v√† ch·ªânh s·ª≠a ph·∫ßn Khai b√°o.
            </p>

            <div class="mb-6">
                <input 
                    bind:this={passwordInput}
                    type="password" 
                    class="w-full p-2.5 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition-colors 
                           {showError ? 'border-red-500 bg-red-50' : 'border-gray-300'}" 
                    placeholder="Nh·∫≠p m·∫≠t kh·∫©u..."
                    bind:value={password}
                    on:keydown={handleKeydown}
                >
                {#if showError}
                    <p class="text-red-500 text-sm mt-2 animate-pulse flex items-center">
                         <span class="mr-1">üö´</span> M·∫≠t kh·∫©u kh√¥ng ƒë√∫ng. Vui l√≤ng th·ª≠ l·∫°i.
                    </p>
                {/if}
            </div>

            <div class="flex justify-end space-x-3 border-t pt-4">
                <button 
                    class="px-4 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 transition-colors font-medium text-sm"
                    on:click={close}
                >
                    H·ªßy
                </button>
                <button 
                    class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors font-bold text-sm shadow-sm"
                    on:click={submit}
                >
                    X√°c nh·∫≠n
                </button>
            </div>
        </div>
    </div>
{/if}
<<< FILE_END: src/components/modals/AdminModal.svelte

>>> FILE_START: src/components/modals/CustomerDetailModal.svelte
<script>
    import { modalState } from '../../stores.js';
    import { formatters } from '../../utils/formatters.js';

    // L·∫•y d·ªØ li·ªáu t·ª´ store modalState
    $: isOpen = $modalState.activeModal === 'customer-detail-modal';
    $: customerData = $modalState.payload?.customers || [];
    $: mucTieu = $modalState.payload?.mucTieu || {};

    $: conversionRateTarget = (mucTieu?.phanTramQD || 0) / 100;

    function close() {
        modalState.update(s => ({ ...s, activeModal: null, payload: null }));
    }

    // S·∫Øp x·∫øp local trong modal
    let sortKey = 'totalRealRevenue';
    let sortDirection = 'desc';

    function handleSort(key) {
        if (sortKey === key) {
            sortDirection = sortDirection === 'desc' ? 'asc' : 'desc';
        } else {
            sortKey = key;
            sortDirection = 'desc';
        }
    }

    $: sortedCustomers = [...customerData].sort((a, b) => {
        let valA = a[sortKey];
        let valB = b[sortKey];
        return sortDirection === 'desc' ? valB - valA : valA - valB;
    });
</script>

{#if isOpen}
    <div class="fixed inset-0 bg-gray-900/50 z-[1200] flex items-center justify-center backdrop-blur-sm" on:click={close} role="button" tabindex="0">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-3xl mx-4 flex flex-col max-h-[90vh]" on:click|stopPropagation>
            
            <div class="p-4 border-b flex justify-between items-center bg-blue-50 rounded-t-xl">
                <h3 class="text-lg font-bold text-blue-900">Chi ti·∫øt ƒê∆°n h√†ng theo Kh√°ch h√†ng</h3>
                <button class="text-gray-500 hover:text-gray-800 text-2xl leading-none" on:click={close}>&times;</button>
            </div>

            <div class="p-3 bg-gray-50 border-b flex gap-2 items-center">
                <span class="text-xs font-bold text-gray-500 uppercase">S·∫Øp x·∫øp:</span>
                <button 
                    class="px-3 py-1 rounded-full text-xs font-medium border transition-colors {sortKey === 'totalRealRevenue' ? 'bg-blue-600 text-white' : 'bg-white text-gray-600 hover:bg-gray-100'}"
                    on:click={() => handleSort('totalRealRevenue')}
                >
                    Doanh thu {sortKey === 'totalRealRevenue' ? (sortDirection === 'desc' ? '‚Üì' : '‚Üë') : ''}
                </button>
                <button 
                    class="px-3 py-1 rounded-full text-xs font-medium border transition-colors {sortKey === 'conversionRate' ? 'bg-blue-600 text-white' : 'bg-white text-gray-600 hover:bg-gray-100'}"
                    on:click={() => handleSort('conversionRate')}
                >
                    % Quy ƒë·ªïi {sortKey === 'conversionRate' ? (sortDirection === 'desc' ? '‚Üì' : '‚Üë') : ''}
                </button>
            </div>

            <div class="overflow-y-auto p-4 space-y-3 bg-slate-50/30 flex-grow">
                {#if sortedCustomers.length === 0}
                    <p class="text-center text-gray-500 py-8">Kh√¥ng c√≥ d·ªØ li·ªáu.</p>
                {:else}
                    {#each sortedCustomers as customer, index}
                        <details class="bg-white rounded-lg shadow-sm border border-gray-200 group">
                            <summary class="flex flex-wrap items-center gap-3 p-3 cursor-pointer list-none select-none hover:bg-gray-50 transition-colors">
                                <div class="flex items-center gap-2 flex-grow min-w-[200px]">
                                    <span class="text-xs font-bold text-gray-400 w-5">{index + 1}.</span>
                                    <span class="text-sm font-semibold text-blue-700">{customer.name}</span>
                                </div>
                                
                                <div class="flex items-center gap-3 text-xs text-gray-600">
                                    <span>SL: <strong>{customer.totalQuantity}</strong></span>
                                    <span>DT: <strong>{formatters.formatRevenue(customer.totalRealRevenue, 1)}</strong></span>
                                    <span>DTQƒê: <strong class="text-blue-600">{formatters.formatRevenue(customer.totalConvertedRevenue, 1)}</strong></span>
                                    <span class="font-bold {customer.conversionRate >= conversionRateTarget ? 'text-green-600' : 'text-red-600'}">
                                        {formatters.formatPercentage(customer.conversionRate)}
                                    </span>
                                </div>
                                <span class="text-gray-400 transform group-open:rotate-180 transition-transform ml-auto">‚ñº</span>
                            </summary>
                            
                            <div class="p-3 border-t border-gray-100 bg-slate-50/50 text-xs">
                                <table class="w-full">
                                    <tbody>
                                        {#each customer.products as p}
                                            <tr class="border-b last:border-0 border-gray-200/50">
                                                <td class="py-1.5 pr-2 text-gray-700">{p.productName}</td>
                                                <td class="py-1.5 px-2 text-right whitespace-nowrap">SL: <strong>{p.quantity}</strong></td>
                                                <td class="py-1.5 px-2 text-right whitespace-nowrap">DT: <strong>{formatters.formatRevenue(p.realRevenue, 1)}</strong></td>
                                                <td class="py-1.5 pl-2 text-right whitespace-nowrap">Qƒê: <strong class="text-blue-600">{formatters.formatRevenue(p.convertedRevenue, 1)}</strong></td>
                                            </tr>
                                        {/each}
                                    </tbody>
                                </table>
                            </div>
                        </details>
                    {/each}
                {/if}
            </div>

            <div class="p-4 border-t bg-white rounded-b-xl flex justify-end">
                <button class="px-4 py-2 bg-gray-100 hover:bg-gray-200 text-gray-700 rounded-lg text-sm font-medium" on:click={close}>ƒê√≥ng</button>
            </div>
        </div>
    </div>
{/if}
<<< FILE_END: src/components/modals/CustomerDetailModal.svelte

>>> FILE_START: src/components/modals/DemoWelcomeModal.svelte
<script>
  import { onMount } from 'svelte';
  // Kh√¥ng c·∫ßn import store hay service ph·ª©c t·∫°p n·ªØa
  
  let showModal = false;

  onMount(() => {
    const hasData = localStorage.getItem('danhSachNhanVien'); 
    const isDemo = localStorage.getItem('isDemoMode') === 'true';
    
    // N·∫øu ch∆∞a c√≥ d·ªØ li·ªáu v√† ch∆∞a ph·∫£i demo th√¨ hi·ªán modal
    if (!hasData && !isDemo) {
      showModal = true;
    }
  });

  function startDemo() {
    // 1. B·∫≠t c·ªù Demo l∆∞u v√†o LocalStorage
    localStorage.setItem('isDemoMode', 'true');

    // 2. [QUAN TR·ªåNG] Reload trang ngay l·∫≠p t·ª©c
    // Vi·ªác n√†y bu·ªôc App.svelte ch·∫°y l·∫°i t·ª´ ƒë·∫ßu (Cold Start)
    // Gi√∫p tr√°nh l·ªói treo m√°y v√† ƒë·∫£m b·∫£o d·ªØ li·ªáu ƒë∆∞·ª£c n·∫°p s·∫°ch s·∫Ω
    window.location.reload();
  }

  function skipDemo() {
    showModal = false;
    localStorage.setItem('hasSkippedDemo', 'true');
  }
</script>

{#if showModal}
<div class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-60 backdrop-blur-sm">
  <div class="bg-white rounded-2xl shadow-2xl p-8 max-w-md w-full text-center border border-gray-100">
    <div class="mb-6 flex justify-center">
       <div class="p-4 bg-blue-50 rounded-full">
         <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 text-blue-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19.428 15.428a2 2 0 00-1.022-.547l-2.384-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z" />
          </svg>
       </div>
    </div>
    
    <h2 class="text-2xl font-bold text-gray-800 mb-2">Ch√†o m·ª´ng b·∫°n!</h2>
    <p class="text-gray-500 mb-8 leading-relaxed">
      H·ªá th·ªëng ph√°t hi·ªán b·∫°n ch∆∞a c√≥ d·ªØ li·ªáu.
      B·∫°n c√≥ mu·ªën s·ª≠ d·ª•ng <b>D·ªØ li·ªáu M·∫´u (Demo)</b> ƒë·ªÉ tr·∫£i nghi·ªám ngay c√°c t√≠nh nƒÉng kh√¥ng?
    </p>

    <div class="flex flex-col gap-3">
      <button 
        on:click={startDemo}
        class="w-full py-3 px-4 bg-blue-600 hover:bg-blue-700 text-white font-semibold rounded-xl transition-colors shadow-md hover:shadow-lg flex items-center justify-center gap-2"
      >
        <span>üöÄ</span> Tr·∫£i nghi·ªám Demo ngay
      </button>
      
      <button 
        on:click={skipDemo}
        class="w-full py-3 px-4 bg-white border border-gray-200 text-gray-600 hover:bg-gray-50 font-medium rounded-xl transition-colors"
      >
        Kh√¥ng, t√¥i s·∫Ω t·ª± nh·∫≠p li·ªáu
      </button>
    </div>
  </div>
</div>
{/if}
<<< FILE_END: src/components/modals/DemoWelcomeModal.svelte

>>> FILE_START: src/components/modals/LoginModal.svelte
<script>
    import { modalState } from '../../stores.js';
    import { authService } from '../../services/auth.service.js';
    // [FIX] X√≥a import ui t·ª´ ui.js (file ƒë√£ b·ªã x√≥a)
    // import { ui } from '../../ui.js'; 
    
    // State n·ªôi b·ªô
    let email = '';
    let errorMsg = '';
    let isSubmitting = false;

    // Reactive: Ki·ªÉm tra modal c√≥ ƒëang m·ªü kh√¥ng
    $: isOpen = $modalState.activeModal === 'login-modal';

    function close() {
        modalState.update(s => ({ ...s, activeModal: null }));
    }

    async function handleSubmit() {
        errorMsg = '';
        isSubmitting = true;

        try {
            const success = await authService.loginUser(email);
            
            if (success) {
                // [FIX] D√πng alert t·∫°m th·ªùi thay v√¨ ui.showNotification
                // V√¨ modal login ch·ªâ hi·ªán 1 l·∫ßn ƒë·∫ßu, alert l√† ch·∫•p nh·∫≠n ƒë∆∞·ª£c
                // alert(`Ch√†o m·ª´ng ${email}!`); 
                close();
            } else {
                errorMsg = 'Vui l√≤ng nh·∫≠p m·ªôt ƒë·ªãa ch·ªâ email h·ª£p l·ªá.';
            }
        } catch (e) {
            console.error(e);
            errorMsg = 'C√≥ l·ªói x·∫£y ra. Vui l√≤ng th·ª≠ l·∫°i.';
        } finally {
            isSubmitting = false;
        }
    }

    function handleKeydown(event) {
        if (event.key === 'Enter') {
            handleSubmit();
        }
    }
</script>

{#if isOpen}
    <div 
        class="fixed inset-0 bg-gray-900 bg-opacity-60 z-[1100] flex items-center justify-center cursor-not-allowed backdrop-blur-sm"
    >
        <div 
            class="bg-white p-6 rounded-xl shadow-2xl w-full max-w-[420px] mx-4 transform transition-all scale-100 cursor-default"
            on:click|stopPropagation
        >
            <div class="mb-6 border-b border-gray-100 pb-4">
                <h3 class="text-xl font-bold text-gray-800">Ch√†o m·ª´ng ƒë·∫øn v·ªõi C√¥ng c·ª• Ph√¢n t√≠ch</h3>
            </div>
            
            <div class="space-y-4">
                <p class="text-gray-600 text-sm leading-relaxed">
                    Vui l√≤ng nh·∫≠p email c·ªßa b·∫°n ƒë·ªÉ b·∫Øt ƒë·∫ßu s·ª≠ d·ª•ng. Email n√†y s·∫Ω ƒë∆∞·ª£c d√πng ƒë·ªÉ ƒë·ªãnh danh v√† ƒë·ªìng b·ªô d·ªØ li·ªáu trong t∆∞∆°ng lai.
                </p>
                
                <div>
                    <label for="login-email-input" class="block text-sm font-medium text-gray-700 mb-1">Email c·ªßa b·∫°n</label>
                    <input 
                        type="email" 
                        id="login-email-input" 
                        class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition-colors
                               {errorMsg ? 'border-red-500 bg-red-50' : 'border-gray-300'}"
                        placeholder="your.email@example.com"
                        bind:value={email}
                        on:keydown={handleKeydown}
                        disabled={isSubmitting}
                    >
                    {#if errorMsg}
                        <p class="text-red-500 text-sm mt-2 flex items-center animate-pulse">
                            <span class="mr-1">‚ö†Ô∏è</span> {errorMsg}
                        </p>
                    {/if}
                </div>

                <button 
                    id="login-submit-btn" 
                    class="w-full bg-blue-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-blue-700 transition-colors shadow-md disabled:opacity-70 disabled:cursor-not-allowed"
                    on:click={handleSubmit}
                    disabled={isSubmitting}
                >
                    {isSubmitting ? 'ƒêang x·ª≠ l√Ω...' : 'X√°c nh·∫≠n & Ti·∫øp t·ª•c'}
                </button>
            </div>
        </div>
    </div>
{/if}
<<< FILE_END: src/components/modals/LoginModal.svelte

>>> FILE_START: src/components/modals/UnexportedDetailModal.svelte
<script>
    import { modalState } from '../../stores.js';
    import { formatters } from '../../utils/formatters.js';

    $: isOpen = $modalState.activeModal === 'unexported-detail-modal';
    $: unexportedDetails = $modalState.payload?.unexportedDetails || [];

    function close() {
        modalState.update(s => ({ ...s, activeModal: null, payload: null }));
    }
</script>

{#if isOpen}
    <div class="fixed inset-0 bg-gray-900/50 z-[1200] flex items-center justify-center backdrop-blur-sm" on:click={close} role="button" tabindex="0">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-2xl mx-4 flex flex-col max-h-[90vh]" on:click|stopPropagation>
            
            <div class="p-4 border-b flex justify-between items-center bg-yellow-50 rounded-t-xl">
                <h3 class="text-lg font-bold text-yellow-800">Chi ti·∫øt Doanh thu Ch∆∞a xu·∫•t</h3>
                <button class="text-gray-500 hover:text-gray-800 text-2xl leading-none" on:click={close}>&times;</button>
            </div>

            <div class="overflow-y-auto p-4 space-y-3 bg-slate-50/30 flex-grow">
                {#if unexportedDetails.length === 0}
                    <p class="text-center text-gray-500 py-8">Kh√¥ng c√≥ ƒë∆°n h√†ng n√†o ch∆∞a xu·∫•t.</p>
                {:else}
                    {#each unexportedDetails as group, index}
                        <details class="bg-white rounded-lg shadow-sm border border-gray-200 group">
                            <summary class="flex justify-between items-center p-3 cursor-pointer list-none select-none hover:bg-gray-50 transition-colors">
                                <div class="flex items-center gap-2">
                                    <span class="font-bold text-gray-500 text-sm">{index + 1}.</span>
                                    <span class="font-semibold text-gray-800 text-sm">{group.name}</span>
                                </div>
                                
                                <div class="flex items-center gap-3 text-xs text-gray-600">
                                    <span>SL: <strong>{group.totalSL}</strong></span>
                                    <span>DTQƒê: <strong class="text-blue-600">{formatters.formatRevenue(group.totalDTQD, 1)}</strong></span>
                                </div>
                                <span class="text-gray-400 transform group-open:rotate-180 transition-transform ml-2">‚ñº</span>
                            </summary>
                            
                            <div class="p-3 border-t border-gray-100 bg-slate-50/50 text-xs">
                                <table class="w-full">
                                    <tbody>
                                        {#each group.products as p}
                                            <tr class="border-b last:border-0 border-gray-200/50">
                                                <td class="py-1.5 pr-2 text-gray-700">{p.name}</td>
                                                <td class="py-1.5 px-2 text-right whitespace-nowrap">SL: <strong>{p.sl}</strong></td>
                                                <td class="py-1.5 pl-2 text-right whitespace-nowrap">DTQƒê: <strong class="text-blue-600">{formatters.formatRevenue(p.dtqd, 1)}</strong></td>
                                            </tr>
                                        {/each}
                                    </tbody>
                                </table>
                            </div>
                        </details>
                    {/each}
                {/if}
            </div>

            <div class="p-4 border-t bg-white rounded-b-xl flex justify-end">
                <button class="px-4 py-2 bg-gray-100 hover:bg-gray-200 text-gray-700 rounded-lg text-sm font-medium" on:click={close}>ƒê√≥ng</button>
            </div>
        </div>
    </div>
{/if}
<<< FILE_END: src/components/modals/UnexportedDetailModal.svelte

>>> FILE_START: src/components/modals/UserCompetitionModal.svelte
<script>
    import { 
        modalState, 
        localCompetitionConfigs, 
        categoryStructure,
        brandList,
        selectedWarehouse
    } from '../../stores.js';
    import { datasyncService } from '../../services/datasync.service.js';

    $: isOpen = $modalState.activeModal === 'user-competition-modal';

    // --- STATE VIEW ---
    let currentView = 'menu'; 
    let editingIndex = -1;
    let isLoading = false;
    
    // Form data
    let formData = { 
        id: '', name: '', groups: [], brands: [], 
        type: 'doanhthu', minPrice: '', maxPrice: '', excludeApple: false 
    };

    // Search
    let searchGroup = '';
    let searchBrand = '';

    // Data Sources
    $: availableGroups = [...new Set(($categoryStructure || []).map(c => c.nhomHang).filter(Boolean))].sort();
    $: filteredGroups = availableGroups.filter(g => g.toLowerCase().includes(searchGroup.toLowerCase()));
    
    $: availableBrands = $brandList || [];
    $: filteredBrands = availableBrands.filter(b => b.toLowerCase().includes(searchBrand.toLowerCase()));

    // Reset khi m·ªü modal
    $: if (isOpen) {
        // [FIX] N·∫øu c√≥ tham s·ªë editingIndex t·ª´ store (khi b·∫•m s·ª≠a t·ª´ GoalDrawer), v√†o th·∫≥ng form
        if ($modalState.editingIndex !== undefined && $modalState.editingIndex !== -1) {
             openEditForm($modalState.editingIndex);
        } else if ($selectedWarehouse) {
            // M·∫∑c ƒë·ªãnh v√†o list n·∫øu ƒë√£ c√≥ data, menu n·∫øu ch∆∞a
             if ($localCompetitionConfigs.length > 0) currentView = 'list';
             else currentView = 'menu';
        }
    }

    function close() {
        modalState.update(s => ({ ...s, activeModal: null, editingIndex: -1 }));
        resetForm();
        currentView = 'menu';
    }

    // --- NAVIGATION ---
    function goToSpecialProgram() {
        modalState.update(s => ({ ...s, activeModal: 'user-special-program-modal' }));
    }

    function goToBrandCompetition() {
        if ($localCompetitionConfigs.length === 0) {
            openAddForm();
        } else {
            currentView = 'list';
        }
    }

    function backToMenu() { currentView = 'menu'; }
    function backToList() { currentView = 'list'; resetForm(); }

    // --- LOGIC FORM ---
    function resetForm() {
        formData = { 
            id: '', name: '', groups: [], brands: [], 
            type: 'doanhthu', minPrice: '', maxPrice: '', excludeApple: false 
        };
        editingIndex = -1;
        searchGroup = ''; searchBrand = '';
    }

    function openAddForm() { 
        resetForm(); 
        currentView = 'form';
    }

    function openEditForm(index) {
        const config = $localCompetitionConfigs[index];
        if (!config) return;
        
        editingIndex = index;
        formData = {
            id: config.id,
            name: config.name,
            groups: [...(config.groups || [])],
            brands: [...(config.brands || [])],
            type: config.type || 'doanhthu',
            minPrice: config.minPrice ? config.minPrice / 1000000 : '', 
            maxPrice: config.maxPrice ? config.maxPrice / 1000000 : '',
            excludeApple: config.excludeApple || false
        };
        currentView = 'form';
    }

    function toggleSelection(list, item) {
        return list.includes(item) ? list.filter(i => i !== item) : [...list, item];
    }

    async function saveProgram() {
        if (!$selectedWarehouse) return alert("Vui l√≤ng ch·ªçn Kho tr∆∞·ªõc!");
        if (!formData.name) return alert("Vui l√≤ng nh·∫≠p t√™n ch∆∞∆°ng tr√¨nh!");
        if (formData.brands.length === 0) return alert("Vui l√≤ng ch·ªçn √≠t nh·∫•t m·ªôt H√£ng!");
        
        isLoading = true;
        
        const configToSave = {
            id: formData.id || `comp_${Date.now()}`,
            name: formData.name,
            groups: formData.groups,
            brands: formData.brands,
            type: formData.type,
            minPrice: formData.minPrice ? parseFloat(formData.minPrice) * 1000000 : 0,
            maxPrice: formData.maxPrice ? parseFloat(formData.maxPrice) * 1000000 : 0,
            excludeApple: formData.excludeApple,
            target: 0
        };

        let newConfigs = [...$localCompetitionConfigs];
        if (editingIndex >= 0) newConfigs[editingIndex] = configToSave;
        else newConfigs.push(configToSave);

        localCompetitionConfigs.set(newConfigs);

        try {
            await datasyncService.saveCompetitionConfigs($selectedWarehouse, newConfigs);
            if (currentView === 'form') backToList();
        } catch (error) {
            console.error(error);
            alert(`L·ªói l∆∞u: ${error.message}`);
        } finally { 
            isLoading = false;
        }
    }

    async function deleteProgram(index) {
        if (!confirm("X√≥a ch∆∞∆°ng tr√¨nh n√†y?")) return;
        
        let newConfigs = [...$localCompetitionConfigs];
        newConfigs.splice(index, 1);
        localCompetitionConfigs.set(newConfigs);
        
        try {
            await datasyncService.saveCompetitionConfigs($selectedWarehouse, newConfigs);
        } catch(e) { console.error(e); }
    }
</script>

{#if isOpen}
    <div class="fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center z-[1100] backdrop-blur-sm" on:click={close} role="button" tabindex="0">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-2xl mx-4 flex flex-col max-h-[90vh]" on:click|stopPropagation>
     
            <div class="p-5 border-b border-gray-200 flex justify-between items-center bg-blue-50 rounded-t-xl">
                <div>
                    <h3 class="text-lg font-bold text-blue-800 flex items-center gap-2">
                        <i data-feather="award"></i> 
                        {#if currentView === 'menu'}
                            T·∫°o ch∆∞∆°ng tr√¨nh thi ƒëua
                        {:else if currentView === 'list'}
                            Danh s√°ch Thi ƒëua (H√£ng)
                        {:else}
                            {editingIndex >= 0 ? 'S·ª≠a ch∆∞∆°ng tr√¨nh' : 'Th√™m ch∆∞∆°ng tr√¨nh m·ªõi'}
                        {/if}
                    </h3>
                    {#if $selectedWarehouse}
                        <p class="text-xs text-blue-600 mt-1">Kho ƒëang ch·ªçn: <span class="font-bold">{$selectedWarehouse}</span></p>
                    {/if}
                </div>
                <button class="text-gray-500 hover:text-red-500 text-2xl leading-none" on:click={close}>&times;</button>
            </div>
            
            <div class="p-6 overflow-y-auto bg-slate-50/30 flex-grow">
                {#if !$selectedWarehouse}
                    <div class="p-8 text-center bg-yellow-50 border border-yellow-200 rounded-lg">
                        <p class="text-yellow-700 font-semibold">Vui l√≤ng ch·ªçn Kho ·ªü tab "C·∫≠p nh·∫≠t d·ªØ li·ªáu" tr∆∞·ªõc.</p>
                    </div>

                {:else if currentView === 'menu'}
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-4">
                        <button 
                            class="flex flex-col items-center justify-center p-8 bg-white border-2 border-blue-100 rounded-xl shadow-sm hover:shadow-md hover:border-blue-500 hover:bg-blue-50 transition group"
                            on:click={goToBrandCompetition}
                        >
                            <div class="p-4 bg-blue-100 rounded-full text-blue-600 mb-4 group-hover:scale-110 transition-transform">
                                <i data-feather="briefcase" class="w-8 h-8"></i>
                            </div>
                            <h4 class="text-lg font-bold text-gray-800 group-hover:text-blue-700">Thi ƒëua theo H√£ng</h4>
                            <p class="text-sm text-gray-500 text-center mt-2">T·∫°o thi ƒëua d·ª±a tr√™n doanh s·ªë c·ªßa c√°c H√£ng (Apple, Samsung...).</p>
                        </button>

                        <button 
                            class="flex flex-col items-center justify-center p-8 bg-white border-2 border-purple-100 rounded-xl shadow-sm hover:shadow-md hover:border-purple-500 hover:bg-purple-50 transition group"
                            on:click={goToSpecialProgram}
                        >
                            <div class="p-4 bg-purple-100 rounded-full text-purple-600 mb-4 group-hover:scale-110 transition-transform">
                                <i data-feather="star" class="w-8 h-8"></i>
                            </div>
                            <h4 class="text-lg font-bold text-gray-800 group-hover:text-purple-700">Thi ƒëua ƒê·∫∑c Quy·ªÅn</h4>
                            <p class="text-sm text-gray-500 text-center mt-2">Theo d√µi c√°c s·∫£n ph·∫©m tr·ªçng t√¢m (SPƒêQ) ƒë∆∞·ª£c ch·ªâ ƒë·ªãnh ri√™ng.</p>
                        </button>
                    </div>

                {:else if currentView === 'list'}
                    <div class="mb-4">
                        <button on:click={backToMenu} class="text-sm text-gray-500 hover:text-blue-600 flex items-center gap-1 mb-4">
                            <i data-feather="arrow-left" class="w-4 h-4"></i> Quay l·∫°i ch·ªçn lo·∫°i
                        </button>
                    </div>

                    <div class="space-y-3">
                        {#if $localCompetitionConfigs.length === 0}
                            <div class="text-center py-8 bg-gray-50 rounded-lg border-2 border-dashed border-gray-200">
                                <p class="text-gray-500 mb-2">Ch∆∞a c√≥ ch∆∞∆°ng tr√¨nh n√†o.</p>
                                <button on:click={openAddForm} class="text-blue-600 font-bold hover:underline">+ T·∫°o m·ªõi ngay</button>
                            </div>
                        {:else}
                            {#each $localCompetitionConfigs as config, index}
                                <div class="p-4 bg-white rounded-lg border border-gray-200 shadow-sm hover:border-blue-300 hover:shadow-md transition group/item">
                                    <div class="flex justify-between items-start mb-2">
                                        <div class="flex items-center gap-2">
                                            <h4 class="font-bold text-gray-800 text-base">{config.name}</h4>
                                            <span class="text-[10px] uppercase px-2 py-0.5 rounded-full font-bold border {config.type === 'doanhthu' ? 'bg-blue-50 text-blue-700 border-blue-100' : 'bg-yellow-50 text-yellow-700 border-yellow-100'}">
                                                {config.type === 'doanhthu' ? 'Doanh thu' : 'S·ªë l∆∞·ª£ng'}
                                            </span>
                                        </div>
                                        <div class="flex gap-2">
                                            <button on:click={() => openEditForm(index)} class="p-1.5 text-blue-600 hover:bg-blue-50 rounded" title="S·ª≠a"><i data-feather="edit-2" class="w-4 h-4"></i></button>
                                            <button on:click={() => deleteProgram(index)} class="p-1.5 text-red-600 hover:bg-red-50 rounded" title="X√≥a"><i data-feather="trash-2" class="w-4 h-4"></i></button>
                                        </div>
                                    </div>
                                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-2 text-xs text-gray-600 bg-gray-50 p-2 rounded border border-gray-100">
                                        <div class="flex items-start gap-2">
                                            <span class="font-bold min-w-[40px]">H√£ng:</span>
                                            <span class="flex-1 font-medium text-gray-800">{config.brands.join(', ')}</span>
                                        </div>
                                        <div class="flex items-start gap-2">
                                            <span class="font-bold min-w-[40px]">Nh√≥m:</span>
                                            <span class="flex-1 font-medium text-gray-800">
                                                {#if config.groups.length > 0}
                                                    {config.groups.join(', ')}
                                                {:else}
                                                    <span class="text-gray-400 italic">T·∫•t c·∫£ nh√≥m</span>
                                                {/if}
                                            </span>
                                        </div>
                                        {#if config.excludeApple}
                                            <div class="col-span-full flex items-center gap-1 text-red-600 font-bold border-t border-gray-200 pt-1 mt-1">
                                                <i data-feather="alert-circle" class="w-3 h-3"></i> ƒê√£ tr·ª´ Apple
                                            </div>
                                        {/if}
                                    </div>
                                </div>
                            {/each}
                             <button on:click={openAddForm} class="w-full py-3 mt-2 border-2 border-dashed border-blue-200 text-blue-600 rounded-lg font-semibold hover:bg-blue-50 transition flex justify-center items-center gap-2">
                                <i data-feather="plus-circle" class="w-4 h-4"></i> Th√™m ch∆∞∆°ng tr√¨nh m·ªõi
                            </button>
                        {/if}
                    </div>

                {:else if currentView === 'form'}
                    <div class="bg-white p-5 rounded-lg border border-blue-100 shadow-sm">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="font-bold text-lg text-slate-700">{editingIndex >= 0 ? 'Ch·ªânh s·ª≠a' : 'Th√™m m·ªõi'}</h3>
                            <button on:click={backToList} class="text-sm text-gray-500 hover:underline">H·ªßy b·ªè</button>
                        </div>
                        
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-bold text-slate-700 mb-1">T√™n ch∆∞∆°ng tr√¨nh</label>
                                <input type="text" bind:value={formData.name} class="w-full p-2 border rounded-md focus:ring-2 focus:ring-blue-500 outline-none" placeholder="VD: Thi ƒëua Tivi Sony...">
                            </div>

                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-bold text-slate-700 mb-1">H√£ng s·∫£n xu·∫•t <span class="text-red-500">*</span></label>
                                    <input type="text" bind:value={searchBrand} class="w-full mb-2 p-2 border rounded text-xs" placeholder="üîç T√¨m h√£ng..." />
                                    <div class="h-40 overflow-y-auto p-2 border rounded bg-slate-50 grid grid-cols-1 gap-1 custom-scrollbar">
                                        {#each filteredBrands as brand}
                                            <label class="flex items-center space-x-2 text-xs cursor-pointer hover:bg-white p-1 rounded border border-transparent hover:border-gray-200">
                                                <input type="checkbox" checked={formData.brands.includes(brand)} on:change={() => formData.brands = toggleSelection(formData.brands, brand)} class="rounded text-blue-600 focus:ring-blue-500 border-slate-300">
                                                <span class="text-slate-700 truncate" title={brand}>{brand}</span>
                                            </label>
                                        {/each}
                                    </div>
                                </div>
                                <div>
                                    <label class="block text-sm font-bold text-slate-700 mb-1">Nh√≥m h√†ng (T√πy ch·ªçn)</label>
                                    <input type="text" bind:value={searchGroup} class="w-full mb-2 p-2 border rounded text-xs" placeholder="üîç T√¨m nh√≥m h√†ng..." />
                                    <div class="h-40 overflow-y-auto p-2 border rounded bg-slate-50 grid grid-cols-1 gap-1 custom-scrollbar">
                                        {#each filteredGroups as group}
                                            <label class="flex items-center space-x-2 text-xs cursor-pointer hover:bg-white p-1 rounded border border-transparent hover:border-gray-200">
                                                <input type="checkbox" checked={formData.groups.includes(group)} on:change={() => formData.groups = toggleSelection(formData.groups, group)} class="rounded text-blue-600 focus:ring-blue-500 border-slate-300">
                                                <span class="text-slate-700 truncate" title={group}>{group}</span>
                                            </label>
                                        {/each}
                                    </div>
                                </div>
                            </div>
                            
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-3 bg-slate-50 p-3 rounded border border-slate-200">
                                <div>
                                    <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Lo·∫°i ƒëo l∆∞·ªùng</label>
                                    <select bind:value={formData.type} class="w-full p-2 border border-slate-300 rounded-md text-sm bg-white">
                                        <option value="doanhthu">Theo Doanh thu</option>
                                        <option value="soluong">Theo S·ªë l∆∞·ª£ng</option>
                                    </select>
                                </div>
                                {#if formData.type === 'soluong'}
                                    <div>
                                        <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Gi√° t·ª´ (Tr)</label>
                                        <input type="number" bind:value={formData.minPrice} class="w-full p-2 border border-slate-300 rounded-md text-sm" placeholder="VD: 3">
                                    </div>
                                    <div>
                                        <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Gi√° ƒë·∫øn (Tr)</label>
                                        <input type="number" bind:value={formData.maxPrice} class="w-full p-2 border border-slate-300 rounded-md text-sm" placeholder="VD: 10">
                                    </div>
                                {/if}
                            </div>

                            <div class="flex items-center gap-2 pt-2">
                                <input type="checkbox" id="exclude-apple" bind:checked={formData.excludeApple} class="rounded text-blue-600 focus:ring-blue-500 border-slate-300 w-4 h-4">
                                <label for="exclude-apple" class="text-sm text-slate-700 cursor-pointer select-none">Tr·ª´ h√£ng Apple kh·ªèi d·ªØ li·ªáu so s√°nh</label>
                            </div>

                            <div class="flex justify-end gap-3 pt-4 border-t mt-4">
                                <button on:click={backToList} class="px-4 py-2 text-gray-600 bg-white border rounded hover:bg-gray-50">H·ªßy</button>
                                <button on:click={saveProgram} class="px-4 py-2 bg-blue-600 text-white font-bold rounded hover:bg-blue-700 disabled:opacity-50" disabled={isLoading}>{isLoading ? 'ƒêang l∆∞u...' : 'L∆∞u'}</button>
                            </div>
                        </div>
                    </div>
                {/if}
            </div>
        </div>
    </div>
{/if}
<<< FILE_END: src/components/modals/UserCompetitionModal.svelte

>>> FILE_START: src/components/modals/UserSpecialProgramModal.svelte
<script>
    import { 
        modalState, 
        globalSpecialPrograms, 
        categoryStructure,
        selectedWarehouse
    } from '../../stores.js';
    import { datasyncService } from '../../services/datasync.service.js';

    $: isOpen = $modalState.activeModal === 'user-special-program-modal';

    let isFormOpen = false;
    let editingIndex = -1;
    let isLoading = false;
    
    let formData = { id: '', name: '', groups: [] };
    let searchGroup = '';

    // L·∫•y danh s√°ch nh√≥m h√†ng t·ª´ c·∫•u tr√∫c ng√†nh h√†ng
    $: availableGroups = [...new Set(($categoryStructure || []).map(c => c.nhomHang).filter(Boolean))].sort();
    $: filteredGroups = availableGroups.filter(g => g.toLowerCase().includes(searchGroup.toLowerCase()));

    // Khi m·ªü modal, t·∫£i d·ªØ li·ªáu c·ªßa kho hi·ªán t·∫°i
    $: if (isOpen && $selectedWarehouse) {
        loadConfigs();
    }

    // Logic t·∫£i t·ª´ Cloud (Hi·ªán t·∫°i ƒëang gi·∫£ l·∫≠p d√πng bi·∫øn global, th·ª±c t·∫ø s·∫Ω t·∫£i t·ª´ datasyncService)
    async function loadConfigs() {
        // T·∫°m th·ªùi d√πng store globalSpecialPrograms ƒë√£ ƒë∆∞·ª£c load ·ªü main.js
        // V·ªÅ sau s·∫Ω g·ªçi datasyncService.loadSpecialPrograms($selectedWarehouse)
    }

    function close() {
        modalState.update(s => ({ ...s, activeModal: null }));
        closeForm();
    }

    function resetForm() {
        formData = { id: '', name: '', groups: [] };
        editingIndex = -1;
        searchGroup = '';
    }

    function openAddForm() { resetForm(); isFormOpen = true; }

    function openEditForm(index) {
        const config = $globalSpecialPrograms[index];
        editingIndex = index;
        formData = {
            id: config.id,
            name: config.name,
            groups: [...(config.groups || [])]
        };
        isFormOpen = true;
    }

    function closeForm() { isFormOpen = false; resetForm(); }

    function toggleSelection(list, item) {
        return list.includes(item) ? list.filter(i => i !== item) : [...list, item];
    }

    async function saveProgram() {
        if (!$selectedWarehouse) return alert("Vui l√≤ng ch·ªçn Kho ·ªü tab C·∫≠p nh·∫≠t d·ªØ li·ªáu tr∆∞·ªõc!");
        if (!formData.name) return alert("Vui l√≤ng nh·∫≠p t√™n ch∆∞∆°ng tr√¨nh!");
        if (formData.groups.length === 0) return alert("Vui l√≤ng ch·ªçn √≠t nh·∫•t m·ªôt Nh√≥m h√†ng!");

        isLoading = true;
        const configToSave = {
            id: formData.id || `sp_${Date.now()}`,
            name: formData.name,
            groups: formData.groups
        };

        let newConfigs = [...$globalSpecialPrograms];
        if (editingIndex >= 0) newConfigs[editingIndex] = configToSave;
        else newConfigs.push(configToSave);

        // C·∫≠p nh·∫≠t Store
        globalSpecialPrograms.set(newConfigs);

        try {
            // L∆∞u l√™n Cloud th√¥ng qua Service c·ªßa Kho
            // (Gi·∫£ ƒë·ªãnh datasyncService ƒë√£ c√≥ h√†m n√†y ho·∫∑c d√πng chung c∆° ch·∫ø l∆∞u)
            // ·ªû b∆∞·ªõc tr∆∞·ªõc t√¥i ƒë√£ h∆∞·ªõng d·∫´n th√™m saveSpecialPrograms v√†o datasync.service.js
            await datasyncService.saveSpecialPrograms($selectedWarehouse, newConfigs); 
            closeForm();
        } catch (error) {
            console.error(error);
            alert(`L·ªói l∆∞u Cloud: ${error.message}`);
        } finally { isLoading = false; }
    }

    async function deleteProgram(index) {
        if (!confirm("X√≥a ch∆∞∆°ng tr√¨nh n√†y?")) return;
        let newConfigs = [...$globalSpecialPrograms];
        newConfigs.splice(index, 1);
        globalSpecialPrograms.set(newConfigs);
        
        try {
            await datasyncService.saveSpecialPrograms($selectedWarehouse, newConfigs); 
        } catch(e) { console.error(e); }
    }
</script>

{#if isOpen}
    <div class="fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center z-[1100] backdrop-blur-sm" on:click={close} role="button" tabindex="0">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-2xl mx-4 flex flex-col max-h-[90vh]" on:click|stopPropagation>
            <div class="p-5 border-b border-gray-200 flex justify-between items-center bg-purple-50 rounded-t-xl">
                <div>
                    <h3 class="text-lg font-bold text-purple-800 flex items-center gap-2">
                        <i data-feather="star"></i> Qu·∫£n l√Ω SP ƒê·∫∑c Quy·ªÅn (User)
                    </h3>
                    <p class="text-xs text-purple-600 mt-1">D·ªØ li·ªáu ƒë·ªìng b·ªô cho kho: <span class="font-bold">{$selectedWarehouse || '(Ch∆∞a ch·ªçn kho)'}</span></p>
                </div>
                <button class="text-gray-500 hover:text-red-500 text-2xl leading-none" on:click={close}>&times;</button>
            </div>
            
            <div class="p-6 overflow-y-auto">
                {#if !$selectedWarehouse}
                    <div class="p-8 text-center bg-yellow-50 border border-yellow-200 rounded-lg">
                        <p class="text-yellow-700 font-semibold">Vui l√≤ng ch·ªçn Kho ·ªü tab "C·∫≠p nh·∫≠t d·ªØ li·ªáu" ƒë·ªÉ s·ª≠ d·ª•ng t√≠nh nƒÉng n√†y.</p>
                    </div>
                {:else if !isFormOpen}
                    <div class="space-y-3">
                        {#if $globalSpecialPrograms.length === 0}
                            <div class="text-center py-8 bg-gray-50 rounded-lg border-2 border-dashed border-gray-200">
                                <p class="text-gray-500 mb-2">Ch∆∞a c√≥ ch∆∞∆°ng tr√¨nh SPƒêQ n√†o.</p>
                                <button on:click={openAddForm} class="text-purple-600 font-bold hover:underline">+ T·∫°o ch∆∞∆°ng tr√¨nh ƒë·∫ßu ti√™n</button>
                            </div>
                        {:else}
                            {#each $globalSpecialPrograms as config, index}
                                <div class="flex justify-between items-start p-4 bg-white rounded-lg border border-gray-200 shadow-sm hover:shadow-md transition">
                                    <div>
                                        <h4 class="font-bold text-gray-800 text-lg">{config.name}</h4>
                                        <div class="text-sm text-gray-600 mt-1">
                                            <p><strong>Nh√≥m h√†ng:</strong> {config.groups.join(', ')}</p>
                                        </div>
                                    </div>
                                    <div class="flex gap-2">
                                        <button on:click={() => openEditForm(index)} class="p-2 text-blue-600 hover:bg-blue-50 rounded"><i data-feather="edit-2" class="w-4 h-4"></i></button>
                                        <button on:click={() => deleteProgram(index)} class="p-2 text-red-600 hover:bg-red-50 rounded"><i data-feather="trash-2" class="w-4 h-4"></i></button>
                                    </div>
                                </div>
                            {/each}
                             <button on:click={openAddForm} class="w-full py-3 mt-2 border-2 border-dashed border-purple-200 text-purple-600 rounded-lg font-semibold hover:bg-purple-50 transition flex justify-center items-center gap-2">
                                <i data-feather="plus-circle" class="w-4 h-4"></i> Th√™m ch∆∞∆°ng tr√¨nh SPƒêQ
                            </button>
                        {/if}
                    </div>
                {:else}
                    <div class="bg-slate-50 p-5 rounded-lg border border-slate-200">
                        <h3 class="font-bold text-lg mb-4 text-slate-700">{editingIndex >= 0 ? 'Ch·ªânh s·ª≠a' : 'Th√™m m·ªõi'}</h3>
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-bold text-slate-700 mb-1">T√™n ch∆∞∆°ng tr√¨nh</label>
                                <input type="text" bind:value={formData.name} class="w-full p-2 border rounded-md focus:ring-2 focus:ring-purple-500 outline-none" placeholder="VD: Tivi ƒê·∫∑c Quy·ªÅn...">
                            </div>
                            <div>
                                <label class="block text-sm font-bold text-slate-700 mb-2">Ch·ªçn Nh√≥m h√†ng</label>
                                <input type="text" bind:value={searchGroup} class="w-full mb-2 p-2 border rounded text-xs" placeholder="üîç T√¨m nh√≥m h√†ng..." />
                                <div class="h-48 overflow-y-auto p-2 border rounded bg-white grid grid-cols-1 gap-1 custom-scrollbar">
                                    {#each filteredGroups as group}
                                        <label class="flex items-center space-x-2 text-xs cursor-pointer hover:bg-gray-50 p-1 rounded"><input type="checkbox" checked={formData.groups.includes(group)} on:change={() => formData.groups = toggleSelection(formData.groups, group)} class="rounded text-purple-600 focus:ring-purple-500 border-slate-300"><span>{group}</span></label>
                                    {/each}
                                </div>
                            </div>
                            <div class="flex justify-end gap-3 pt-4">
                                <button on:click={closeForm} class="px-4 py-2 text-gray-600 bg-white border rounded hover:bg-gray-50">H·ªßy</button>
                                <button on:click={saveProgram} class="px-4 py-2 bg-purple-600 text-white font-bold rounded hover:bg-purple-700 disabled:opacity-50" disabled={isLoading}>{isLoading ? 'ƒêang l∆∞u...' : 'L∆∞u'}</button>
                            </div>
                        </div>
                    </div>
                {/if}
            </div>
        </div>
    </div>
{/if}
<<< FILE_END: src/components/modals/UserSpecialProgramModal.svelte

>>> FILE_START: src/components/modals/composer/ComposerEditor.svelte
<script>
    import { createEventDispatcher, tick } from 'svelte';
    import { notificationStore } from '../../../stores.js';

    export let subTabs = []; // List subtabs config
    export let activeSubTabId = '';
    export let editorContent = '';
    export let saveStatus = '';

    // State n·ªôi b·ªô cho Preview
    let isPreviewMode = false;
    let previewContent = '';
    let textareaEl;

    const dispatch = createEventDispatcher();

    // H√†m public: ƒê∆∞·ª£c g·ªçi t·ª´ cha ƒë·ªÉ ch√®n tag v√†o textarea
    export async function insertText(textToInsert) {
        if (!textareaEl) return;
        
        const start = textareaEl.selectionStart;
        const end = textareaEl.selectionEnd;
        const value = textareaEl.value;
        
        // C·∫≠p nh·∫≠t n·ªôi dung th√¥ng qua binding 2 chi·ªÅu l√™n cha
        editorContent = value.substring(0, start) + textToInsert + value.substring(end);
        
        // Focus l·∫°i v√† ch·ªânh con tr·ªè
        await tick();
        const newCursorPos = start + textToInsert.length;
        textareaEl.selectionStart = newCursorPos;
        textareaEl.selectionEnd = newCursorPos;
        textareaEl.focus();
    }

    function switchSubTab(id) {
        if (isPreviewMode) isPreviewMode = false;
        dispatch('changeSubTab', id);
    }

    function handleSave() {
        dispatch('save');
    }

    function handlePreview() {
        if (!editorContent.trim()) {
            notificationStore.show('N·ªôi dung tr·ªëng.', 'error');
            return;
        }
        // G·ª≠i y√™u c·∫ßu l√™n cha ƒë·ªÉ x·ª≠ l√Ω text (bi·∫øn tag th√†nh s·ªë li·ªáu)
        dispatch('requestPreview', {
            content: editorContent,
            callback: (processedText) => {
                previewContent = processedText;
                isPreviewMode = true;
                
                // Copy logic
                navigator.clipboard.writeText(processedText).then(() => {
                    // notificationStore.show('ƒê√£ sao ch√©p n·ªôi dung!', 'success');
                }).catch(err => console.error(err));
            }
        });
    }

    function closePreview() {
        isPreviewMode = false;
    }
</script>

<div class="flex-1 flex flex-col border-r border-gray-200 p-4 relative h-full">
    
    <div class="flex space-x-2 overflow-x-auto mb-3 pb-2 border-b border-gray-100">
        {#each subTabs as tab}
            <button 
                class="px-3 py-1.5 text-xs font-medium rounded-md transition-colors whitespace-nowrap
                {activeSubTabId === tab.id ? 'bg-indigo-100 text-indigo-700' : 'bg-gray-100 text-gray-600 hover:bg-gray-200'}"
                on:click={() => switchSubTab(tab.id)}
            >
                {tab.label}
            </button>
        {/each}
    </div>

    <div class="flex-grow relative flex flex-col overflow-hidden">
        {#if isPreviewMode}
            <div class="flex-grow flex flex-col bg-slate-50 rounded-lg border border-gray-300 overflow-hidden animate-fade-in h-full">
                <div class="bg-green-100 text-green-800 px-4 py-2 text-xs font-bold flex justify-between items-center border-b border-green-200 shrink-0">
                    <span class="flex items-center gap-2">
                        <i data-feather="check-circle" class="w-4 h-4"></i>
                        ƒê√£ t·ª± ƒë·ªông sao ch√©p v√†o b·ªô nh·ªõ t·∫°m!
                    </span>
                </div>
                <div class="p-4 overflow-y-auto custom-scrollbar font-mono text-sm whitespace-pre-wrap text-slate-700 flex-grow">
                    {previewContent}
                </div>
            </div>
        {:else}
            <textarea 
                bind:this={textareaEl}
                bind:value={editorContent}
                class="flex-grow w-full p-4 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 outline-none resize-none font-mono text-sm leading-relaxed h-full"
                placeholder="So·∫°n th·∫£o n·ªôi dung t·∫°i ƒë√¢y... S·ª≠ d·ª•ng c√°c th·∫ª b√™n ph·∫£i ƒë·ªÉ ch√®n d·ªØ li·ªáu t·ª± ƒë·ªông."
            ></textarea>
        {/if}
    </div>

    <div class="mt-4 flex justify-between items-center shrink-0">
        {#if isPreviewMode}
            <button on:click={closePreview} class="px-4 py-2 bg-gray-500 text-white rounded-lg font-medium hover:bg-gray-600 flex items-center gap-2 text-sm shadow-sm transition-all">
                <i data-feather="arrow-left" class="w-4 h-4"></i> Quay l·∫°i ch·ªânh s·ª≠a
            </button>
            <span class="text-xs text-green-600 italic font-medium">N·ªôi dung ƒë√£ ƒë∆∞·ª£c sao ch√©p</span>
        {:else}
            <div class="flex items-center gap-3">
                <button on:click={handleSave} class="px-4 py-2 bg-green-600 text-white rounded-lg font-medium hover:bg-green-700 flex items-center gap-2 text-sm transition-all shadow-sm">
                    <i data-feather="save" class="w-4 h-4"></i> L∆∞u m·∫´u
                </button>
                {#if saveStatus}
                    <span class="text-xs text-gray-500 italic animate-fade-in">{saveStatus}</span>
                {/if}
            </div>
            
            <button on:click={handlePreview} class="px-6 py-2 bg-blue-600 text-white rounded-lg font-bold hover:bg-blue-700 flex items-center gap-2 shadow-md transition-all">
                <i data-feather="eye" class="w-4 h-4"></i> Xem tr∆∞·ªõc & Sao ch√©p
            </button>
        {/if}
    </div>
</div>

<style>
    .custom-scrollbar::-webkit-scrollbar { width: 4px; }
    .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
    .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 2px; }

    @keyframes fade-in {
        from { opacity: 0; transform: translateY(5px); }
        to { opacity: 1; transform: translateY(0); }
    }
    .animate-fade-in { animation: fade-in 0.2s ease-out; }
</style>
<<< FILE_END: src/components/modals/composer/ComposerEditor.svelte

>>> FILE_START: src/components/modals/composer/ComposerModal.svelte
<script>
  import { onMount, tick } from 'svelte';
  // [S·ª¨A L·ªñI]: D√πng ../../../ thay v√¨ ../../../../
  import { 
    modalState, composerTemplates, realtimeYCXData, ycxData, 
    selectedWarehouse, competitionData, notificationStore 
  } from '../../../stores.js';
  // [S·ª¨A L·ªñI]: D√πng ../../../ cho services
  import { composerService } from '../../../services/composerService.js';
  import { reportService } from '../../../services/reportService.js';
  import { settingsService } from '../../../services/settings.service.js';
  
  import ComposerEditor from './ComposerEditor.svelte';
  import ComposerSidebar from './ComposerSidebar.svelte';

  const CONFIG = {
      luyke: {
          label: 'S·ª©c kh·ªèe Si√™u th·ªã (L≈©y k·∫ø)',
          subTabs: [
              { id: 'subtab-luyke-sieu-thi', label: 'Si√™u th·ªã L≈©y k·∫ø' },
              { id: 'subtab-luyke-thi-dua', label: 'Thi ƒëua L≈©y k·∫ø' },
              { id: 'subtab-luyke-thidua-vung', label: 'Thi ƒêua V√πng TNB' }
          ]
      },
      sknv: {
          label: 'S·ª©c kh·ªèe Nh√¢n vi√™n',
          subTabs: [
              { id: 'subtab-sknv', label: 'SKNV' },
              { id: 'subtab-doanhthu', label: 'Doanh thu LK' },
              { id: 'subtab-thunhap', label: 'Thu nh·∫≠p' },
              { id: 'subtab-hieuqua', label: 'Hi·ªáu qu·∫£ NV LK' },
              { id: 'subtab-nganhhang', label: 'DT ng√†nh h√†ng' },
              { id: 'subtab-thidua', label: 'Thi ƒëua NV LK' }
          ]
      },
      realtime: {
          label: 'Doanh thu Realtime',
          // [GENESIS]: ƒê√£ ƒë·ªìng b·ªô t√™n Tab ng·∫Øn g·ªçn theo RealtimeSection
          subTabs: [
              { id: 'subtab-realtime-sieu-thi', label: 'Si√™u th·ªã Real' },
              { id: 'subtab-realtime-nhan-vien', label: 'DT NV Real' },
              { id: 'subtab-realtime-hieu-qua-nhan-vien', label: 'Hi·ªáu qu·∫£ NV Real' },
              { id: 'subtab-realtime-nganh-hang', label: 'Ng√†nh h√†ng Real' },
              { id: 'subtab-realtime-hang-ban', label: 'Chi ti·∫øt YCX Real' },
              { id: 'subtab-realtime-thi-dua', label: 'Thi ƒëua NV Real' },
              { id: 'subtab-realtime-tragop', label: 'Tr·∫£ ch·∫≠m Real' }
          ]
      }
  };

  $: isOpen = $modalState.activeModal === 'composer-modal';
  $: context = $modalState.context || 'luyke';
  
  let activeSubTabId = '';
  let editorContent = '';
  let saveStatus = '';
  let isLoading = false; 
  
  let supermarketReport = {};
  let rankingReportData = [];
  let compData = [];
  let currentGoals = {};

  let editorComponent;

  // --- LOGIC ANTI-FREEZE ---
  $: if (isOpen && context) {
      isLoading = true;
      initializeData();
  }

  async function initializeData() {
      if (!activeSubTabId && CONFIG[context]) {
          activeSubTabId = CONFIG[context].subTabs[0].id;
      }
      
      if ($composerTemplates[context] && $composerTemplates[context][activeSubTabId]) {
          editorContent = $composerTemplates[context][activeSubTabId];
      } else {
          editorContent = '';
      }
      saveStatus = '';

      await tick();
      setTimeout(async () => {
          try {
              await calculateReportData();
          } catch (e) {
              console.error("L·ªói t√≠nh to√°n b√°o c√°o:", e);
              notificationStore.show('L·ªói t·∫£i d·ªØ li·ªáu b√°o c√°o', 'error');
          } finally {
              isLoading = false; 
          }
      }, 50);
  }

  async function calculateReportData() {
      const warehouse = $selectedWarehouse;
      let sourceData = [];
      let isRealtime = false;

      if (context === 'realtime') {
          sourceData = $realtimeYCXData;
          const settings = settingsService.getRealtimeGoalSettings(warehouse);
          currentGoals = settings.goals || {};
          isRealtime = true;
      } else {
          sourceData = $ycxData;
          const settings = settingsService.getLuykeGoalSettings(warehouse);
          currentGoals = settings.goals || {};
      }

      const masterReport = reportService.generateMasterReportData(sourceData, currentGoals, isRealtime);
      rankingReportData = warehouse ? masterReport.filter(nv => nv.maKho == warehouse) : masterReport;
      supermarketReport = reportService.aggregateReport(rankingReportData, warehouse);
      compData = (context === 'luyke' || context === 'sknv') ? $competitionData : [];
  }

  function updateTemplateStore() {
      composerTemplates.update(s => {
          if (!s[context]) s[context] = {};
          s[context][activeSubTabId] = editorContent;
          if (typeof localStorage !== 'undefined') {
             localStorage.setItem('composerTemplates', JSON.stringify(s));
          }
          return s;
      });
  }

  function handleSwitchSubTab(event) {
      updateTemplateStore();
      const newTabId = event.detail;
      activeSubTabId = newTabId;
      editorContent = $composerTemplates[context]?.[newTabId] || '';
      saveStatus = '';
  }

  function handleSave() {
      updateTemplateStore();
      const now = new Date();
      saveStatus = `ƒê√£ l∆∞u l√∫c ${now.toLocaleTimeString('vi-VN', { hour: '2-digit', minute: '2-digit' })}`;
  }

  function handleRequestPreview(event) {
      const { content, callback } = event.detail;
      const processedText = composerService.processComposerTemplate(
          content, supermarketReport, currentGoals, rankingReportData, compData, context
      );
      if (callback) callback(processedText);
  }

  function handleInsertTag(event) {
      const tag = event.detail;
      if (editorComponent) {
          editorComponent.insertText(tag);
      }
  }

  function close() {
      modalState.update(s => ({ ...s, activeModal: null }));
  }
</script>

{#if isOpen}
    <div class="fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center z-[1100] backdrop-blur-sm" on:click={close} role="button" tabindex="0">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-5xl mx-4 flex flex-col h-[90vh]" on:click|stopPropagation>
            
            <div class="p-4 border-b border-gray-200 flex justify-between items-center bg-slate-50 rounded-t-xl shrink-0">
                <div>
                    <h3 class="text-lg font-bold text-slate-800 flex items-center gap-2">
                        <i data-feather="pen-tool" class="w-5 h-5 text-indigo-600"></i>
                        Tr√¨nh t·∫°o Nh·∫≠n x√©t - {CONFIG[context]?.label}
                    </h3>
                </div>
                <button class="text-gray-400 hover:text-red-500" on:click={close}>
                    <i data-feather="x" class="w-6 h-6"></i>
                </button>
            </div>

            <div class="flex-grow flex flex-col md:flex-row overflow-hidden relative">
                
                {#if isLoading}
                    <div class="absolute inset-0 bg-white/80 z-50 flex flex-col items-center justify-center backdrop-blur-sm">
                        <div class="animate-spin rounded-full h-10 w-10 border-b-2 border-indigo-600 mb-3"></div>
                        <span class="text-sm font-medium text-indigo-700 animate-pulse">ƒêang x·ª≠ l√Ω d·ªØ li·ªáu b√°o c√°o...</span>
                    </div>
                {/if}

                <div class="flex-grow md:max-w-[70%] h-full flex flex-col min-w-0">
                    <ComposerEditor 
                        bind:this={editorComponent}
                        bind:editorContent
                        subTabs={CONFIG[context]?.subTabs || []}
                        {activeSubTabId}
                        {saveStatus}
                        on:changeSubTab={handleSwitchSubTab}
                        on:save={handleSave}
                        on:requestPreview={handleRequestPreview}
                    />
                </div>

                <div class="shrink-0 h-full border-l border-gray-200 bg-slate-50">
                    <ComposerSidebar 
                        {supermarketReport}
                        on:insertTag={handleInsertTag}
                    />
                </div>
            </div>
        </div>
    </div>
{/if}
<<< FILE_END: src/components/modals/composer/ComposerModal.svelte

>>> FILE_START: src/components/modals/composer/ComposerSidebar.svelte
<script>
    import { createEventDispatcher } from 'svelte';
    import TabGeneral from './tabs/TabGeneral.svelte';
    import TabKPI from './tabs/TabKPI.svelte';
    import TabRanking from './tabs/TabRanking.svelte';
    import TabDetails from './tabs/TabDetails.svelte';

    export let supermarketReport = {}; // Nh·∫≠n t·ª´ cha, truy·ªÅn cho TabDetails

    const dispatch = createEventDispatcher();
    let activeTagTab = 'general'; 

    function handleInsert(event) {
        // Chuy·ªÉn ti·∫øp s·ª± ki·ªán insert l√™n ComposerModal
        dispatch('insertTag', event.detail);
    }
</script>

<div class="w-full md:w-80 bg-slate-50 flex flex-col border-l border-gray-200 h-full">
    <div class="flex border-b border-gray-200 bg-white">
            {#each ['general', 'kpi', 'ranking', 'details'] as tab}
            <button 
                class="flex-1 py-3 text-xs font-bold uppercase tracking-wide text-center hover:bg-slate-50 transition-colors border-b-2 
                {activeTagTab === tab ? 'border-indigo-600 text-indigo-600' : 'border-transparent text-gray-500'}"
                on:click={() => activeTagTab = tab}
            >
                {tab}
            </button>
        {/each}
    </div>

    <div class="flex-grow overflow-y-auto p-4 custom-scrollbar">
        {#if activeTagTab === 'general'}
            <TabGeneral on:insert={handleInsert} />
        {:else if activeTagTab === 'kpi'}
            <TabKPI on:insert={handleInsert} />
        {:else if activeTagTab === 'ranking'}
            <TabRanking on:insert={handleInsert} />
        {:else if activeTagTab === 'details'}
            <TabDetails {supermarketReport} on:insert={handleInsert} />
        {/if}
    </div>
</div>

<style>
    .custom-scrollbar::-webkit-scrollbar { width: 4px; }
    .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
    .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 2px; }
</style>
<<< FILE_END: src/components/modals/composer/ComposerSidebar.svelte

>>> FILE_START: src/components/modals/composer/tabs/TabDetails.svelte
<script>
    import { createEventDispatcher } from 'svelte';
    import { cleanCategoryName } from '../../../../utils.js';

    export let supermarketReport = {}; // Nh·∫≠n d·ªØ li·ªáu t·ª´ cha

    const dispatch = createEventDispatcher();

    function sendTag(tag) {
        dispatch('insert', tag);
    }
</script>

<div class="space-y-4">
    <div>
        <h5 class="text-xs font-bold text-gray-500 uppercase mb-2">Thi ƒëua (L≈©y k·∫ø)</h5>
        <div class="grid grid-cols-2 gap-2">
            <button class="tag-btn" on:click={() => sendTag('[TD_TONG_CT]')}>T·ªïng CT</button>
            <button class="tag-btn" on:click={() => sendTag('[TD_CT_DAT]')}>S·ªë ƒë·∫°t</button>
            <button class="tag-btn" on:click={() => sendTag('[TD_CT_CHUADAT]')}>S·ªë ch∆∞a ƒë·∫°t</button>
            <button class="tag-btn" on:click={() => sendTag('[TD_TYLE_DAT]')}>% ƒê·∫°t</button>
        </div>
    </div>

    <div>
        <h5 class="text-xs font-bold text-gray-500 uppercase mb-2">Nh√≥m QƒêC (C√≥ s·ªë)</h5>
        <button class="tag-btn w-full mb-2 text-indigo-700 bg-indigo-50" on:click={() => sendTag('[TOP_QDC_INFO]')}>
            Ch√®n Top QƒêC (SL & TB/Ng√†y)
        </button>
        <div class="flex flex-wrap gap-2">
            {#if supermarketReport.qdc}
                {#each Object.values(supermarketReport.qdc).filter(i=>i.sl>0).sort((a,b)=>b.dtqd-a.dtqd) as item}
                    <button class="tag-btn text-xs" on:click={() => sendTag(`[QDC_INFO_${item.name}]`)}>{item.name}</button>
                {/each}
            {/if}
        </div>
    </div>

    <div>
        <h5 class="text-xs font-bold text-gray-500 uppercase mb-2">Ng√†nh h√†ng (C√≥ s·ªë)</h5>
        <button class="tag-btn w-full mb-2 text-indigo-700 bg-indigo-50" on:click={() => sendTag('[TOP_NGANHHANG_SL]')}>
            Ch√®n Top SL Ng√†nh h√†ng
        </button>
        <div class="flex flex-wrap gap-2">
            {#if supermarketReport.nganhHangChiTiet}
                {#each Object.values(supermarketReport.nganhHangChiTiet).filter(i=>i.quantity>0).sort((a,b)=>b.revenue-a.revenue).slice(0, 10) as item}
                    <button class="tag-btn text-xs" on:click={() => sendTag(`[NH_INFO_${cleanCategoryName(item.name)}]`)}>{cleanCategoryName(item.name)}</button>
                {/each}
            {/if}
        </div>
    </div>
</div>

<style>
    .tag-btn {
        background-color: #eef2ff; color: #4338ca; border: 1px solid #c7d2fe;
        padding: 0.25rem 0.5rem; border-radius: 0.375rem; font-size: 0.75rem; font-weight: 500; transition: all 0.2s;
    }
    .tag-btn:hover { background-color: #e0e7ff; border-color: #818cf8; }
</style>
<<< FILE_END: src/components/modals/composer/tabs/TabDetails.svelte

>>> FILE_START: src/components/modals/composer/tabs/TabGeneral.svelte
<script>
    import { createEventDispatcher } from 'svelte';
    const dispatch = createEventDispatcher();

    const ICON_SETS = {
        // [GENESIS]: B·ªô s·ªë Traffic Light Style
        numbers: {
            title: 'üî¢ S·ªë th·ª© t·ª± (M√†u)',
            icons: [
                '‚ö´0Ô∏è‚É£', 'üî¥1Ô∏è‚É£', 'üü°2Ô∏è‚É£', 'üü¢3Ô∏è‚É£', 'üîµ4Ô∏è‚É£', 
                'üü£5Ô∏è‚É£', 'üü†6Ô∏è‚É£', 'üü§7Ô∏è‚É£', '‚ö™8Ô∏è‚É£', 'üü¶9Ô∏è‚É£'
            ]
        },
        ranking: {
            title: 'üèÜ X·∫øp h·∫°ng (Top/Bot)',
            icons: ['üèÜ', 'ü•á', 'ü•à', 'ü•â', 'üèÖ', 'üéñÔ∏è', 'üëë', 'üîù', 'üõê', '‚¨ÜÔ∏è', '‚¨áÔ∏è']
        },
        analysis: {
            title: 'üìä ƒê√°nh gi√°/Ph√¢n t√≠ch',
            icons: ['üìà', 'üìâ', 'üìä', 'üìã', 'üìù', 'üîç', 'üí°', 'üìå', 'üìç']
        },
        kpi: {
            title: 'üéØ M·ª•c ti√™u (KPIs)',
            icons: ['üéØ', 'üöÄ', '‚õ≥', 'üèπ', 'üî•', 'üí£', 'üöß', 'üèÅ']
        },
        business: {
            title: 'üí∞ Kinh doanh/Ti·ªÅn t·ªá',
            icons: ['üí∞', 'üíµ', 'üí∏', 'üí≥', 'üíé', 'üè¶', 'üõçÔ∏è', 'üõí']
        },
        positive: {
            title: '‚úÖ T√≠ch c·ª±c (T·ªët)',
            icons: ['‚úÖ', 'üÜó', 'üôÜ‚Äç‚ôÇÔ∏è', 'üÜô', '‚≠ê', 'üåü', '‚ú®', 'üí™', 'üëè']
        },
        negative: {
            title: '‚ö†Ô∏è Ti√™u c·ª±c/C·∫£nh b√°o',
            icons: ['‚ùå', 'üö´', '‚ö†Ô∏è', 'üÜò', 'üìâ', 'üîª', 'üê¢', 'üí§', '‚ùÑÔ∏è', 'üß±']
        }
    };

    function sendTag(tag) {
        dispatch('insert', tag);
    }
</script>

<div class="space-y-6">
    <div>
        <h5 class="text-xs font-bold text-gray-500 uppercase mb-2">Th·ªùi gian</h5>
        <div class="flex flex-wrap gap-2">
            <button class="tag-btn" on:click={() => sendTag('[NGAY]')}>Ng√†y</button>
            <button class="tag-btn" on:click={() => sendTag('[GIO]')}>Gi·ªù</button>
        </div>
    </div>

    {#each Object.values(ICON_SETS) as set}
        <div>
            <h5 class="text-xs font-bold text-gray-500 uppercase mb-2 border-b border-gray-200 pb-1">{set.title}</h5>
            <div class="grid grid-cols-6 gap-2">
                {#each set.icons as icon}
                    <button class="icon-btn" on:click={() => sendTag(icon)}>{icon}</button>
                {/each}
            </div>
        </div>
    {/each}
</div>

<style>
    .tag-btn {
        background-color: #eef2ff;
        color: #4338ca; border: 1px solid #c7d2fe;
        padding: 0.25rem 0.5rem; border-radius: 0.375rem; font-size: 0.75rem; font-weight: 500; transition: all 0.2s;
    }
    .tag-btn:hover { background-color: #e0e7ff; border-color: #818cf8;
    }
    /* [GENESIS]: S·ª≠a style ƒë·ªÉ thu nh·ªè button icon */
    .icon-btn {
        background-color: white; border: 1px solid #e5e7eb;
        border-radius: 0.375rem;
        /* Gi·∫£m padding v√† font-size ƒë·ªÉ v·ª´a v·ªõi icon k√©p */
        padding: 0.25rem; 
        font-size: 1.1rem; 
        white-space: nowrap; /* NgƒÉn xu·ªëng d√≤ng */
        display: flex; align-items: center; justify-content: center;
        transition: all 0.2s; cursor: pointer;
        overflow: hidden; /* ·∫®n ph·∫ßn th·ª´a n·∫øu c√≥ */
    }
    .icon-btn:hover { background-color: #f9fafb; border-color: #d1d5db; transform: scale(1.1); }
</style>
<<< FILE_END: src/components/modals/composer/tabs/TabGeneral.svelte

>>> FILE_START: src/components/modals/composer/tabs/TabKPI.svelte
<script>
    import { createEventDispatcher } from 'svelte';
    const dispatch = createEventDispatcher();

    function sendTag(tag) {
        dispatch('insert', tag);
    }
</script>

<div class="space-y-4">
    <h5 class="text-xs font-bold text-gray-500 uppercase mb-2">KPIs Ch√≠nh</h5>
    <div class="flex flex-col gap-2">
        <button class="tag-btn w-full text-left" on:click={() => sendTag('[DT_THUC]')}>Doanh thu Th·ª±c</button>
        <button class="tag-btn w-full text-left" on:click={() => sendTag('[DTQD]')}>Doanh thu Quy ƒë·ªïi</button>
        <button class="tag-btn w-full text-left" on:click={() => sendTag('[%HT_DTT]')}>% HT DT Th·ª±c</button>
        <button class="tag-btn w-full text-left" on:click={() => sendTag('[%HT_DTQD]')}>% HT DT Qƒê</button>
        <button class="tag-btn w-full text-left" on:click={() => sendTag('[TLQD]')}>T·ª∑ l·ªá Quy ƒë·ªïi</button>
        <button class="tag-btn w-full text-left" on:click={() => sendTag('[TLTC]')}>T·ª∑ l·ªá Tr·∫£ ch·∫≠m</button>
        <button class="tag-btn w-full text-left" on:click={() => sendTag('[DT_CHUAXUAT]')}>DT Ch∆∞a xu·∫•t</button>
        <button class="tag-btn w-full text-left" on:click={() => sendTag('[SS_CUNGKY]')}>So s√°nh C√πng k·ª≥</button>
    </div>
</div>

<style>
    .tag-btn {
        background-color: #eef2ff; color: #4338ca; border: 1px solid #c7d2fe;
        padding: 0.25rem 0.5rem; border-radius: 0.375rem; font-size: 0.75rem; font-weight: 500; transition: all 0.2s;
    }
    .tag-btn:hover { background-color: #e0e7ff; border-color: #818cf8; }
</style>
<<< FILE_END: src/components/modals/composer/tabs/TabKPI.svelte

>>> FILE_START: src/components/modals/composer/tabs/TabRanking.svelte
<script>
    import { createEventDispatcher } from 'svelte';
    import { danhSachNhanVien } from '../../../../stores.js'; 

    const dispatch = createEventDispatcher();
    let rankingDept = 'ALL';
    
    // L·∫•y danh s√°ch b·ªô ph·∫≠n (ƒë√£ ƒë∆∞·ª£c t·ªëi ∆∞u ƒë·ªÉ tr√°nh loop)
    $: uniqueDepartments = $danhSachNhanVien ? [...new Set($danhSachNhanVien.map(nv => nv.boPhan).filter(Boolean))].sort() : [];

    function sendTag(tagTemplate) {
        const finalTag = tagTemplate.replace('{dept}', rankingDept);
        dispatch('insert', finalTag);
    }
</script>

<div class="space-y-5 px-1 pb-4">
    <div class="border-b border-gray-200 pb-3 sticky top-0 bg-white z-10 pt-1">
        <label for="composer-dept" class="text-xs font-bold text-gray-500 uppercase mb-1.5 flex items-center gap-1">
            <i data-feather="filter" class="w-3 h-3"></i> L·ªçc B·ªô ph·∫≠n:
        </label>
        <select id="composer-dept" class="w-full py-1.5 px-2 text-sm border border-gray-300 rounded-md bg-white focus:ring-2 focus:ring-indigo-500 outline-none shadow-sm" bind:value={rankingDept}>
                <option value="ALL">To√†n si√™u th·ªã</option>
            {#each uniqueDepartments as dept}
                <option value={dept}>{dept}</option>
            {/each}
        </select>
    </div>
    
    <div class="space-y-4">
        <div class="ranking-group">
            <h5 class="group-title text-indigo-700">1. Doanh Thu Quy ƒê·ªïi</h5>
            <div class="grid grid-cols-4 gap-1.5">
                <button class="btn-top" on:click={() => sendTag('[TOP3_DTQD_{dept}@msnv]')}>Top 3</button>
                <button class="btn-top" on:click={() => sendTag('[TOP5_DTQD_{dept}@msnv]')}>Top 5</button>
                <button class="btn-bot" on:click={() => sendTag('[BOT3_DTQD_{dept}@msnv]')}>Bot 3</button>
                <button class="btn-bot" on:click={() => sendTag('[BOT5_DTQD_{dept}@msnv]')}>Bot 5</button>
            </div>
        </div>

        <div class="ranking-group">
            <h5 class="group-title text-emerald-700">2. Thu Nh·∫≠p</h5>
            <div class="grid grid-cols-4 gap-1.5">
                <button class="btn-top" on:click={() => sendTag('[TOP3_THUNHAP_{dept}@msnv]')}>Top 3</button>
                <button class="btn-top" on:click={() => sendTag('[TOP5_THUNHAP_{dept}@msnv]')}>Top 5</button>
                <button class="btn-bot" on:click={() => sendTag('[BOT3_THUNHAP_{dept}@msnv]')}>Bot 3</button>
                <button class="btn-bot" on:click={() => sendTag('[BOT5_THUNHAP_{dept}@msnv]')}>Bot 5</button>
            </div>
        </div>

        <div class="ranking-group">
            <h5 class="group-title text-orange-700">3. T·ª∑ L·ªá Quy ƒê·ªïi</h5>
            <div class="grid grid-cols-4 gap-1.5">
                <button class="btn-top" on:click={() => sendTag('[TOP3_TLQD_{dept}@msnv]')}>Top 3</button>
                <button class="btn-top" on:click={() => sendTag('[TOP5_TLQD_{dept}@msnv]')}>Top 5</button>
                <button class="btn-bot" on:click={() => sendTag('[BOT3_TLQD_{dept}@msnv]')}>Bot 3</button>
                <button class="btn-bot" on:click={() => sendTag('[BOT5_TLQD_{dept}@msnv]')}>Bot 5</button>
            </div>
        </div>

        <div class="ranking-group">
            <h5 class="group-title text-rose-700">4. % Tr·∫£ Ch·∫≠m</h5>
            <div class="grid grid-cols-4 gap-1.5">
                <button class="btn-top" on:click={() => sendTag('[TOP3_TLTC_{dept}@msnv]')}>Top 3</button>
                <button class="btn-top" on:click={() => sendTag('[TOP5_TLTC_{dept}@msnv]')}>Top 5</button>
                <button class="btn-bot" on:click={() => sendTag('[BOT3_TLTC_{dept}@msnv]')}>Bot 3</button>
                <button class="btn-bot" on:click={() => sendTag('[BOT5_TLTC_{dept}@msnv]')}>Bot 5</button>
            </div>
        </div>
    </div>

    <div class="pt-3 border-t border-gray-200 mt-2">
        <h5 class="text-xs font-bold text-gray-500 uppercase mb-2 flex items-center gap-1">
            <i data-feather="alert-circle" class="w-3 h-3"></i> D∆∞·ªõi M·ª•c ti√™u
        </h5>
        <div class="grid grid-cols-2 gap-2">
            <button class="btn-target" on:click={() => sendTag('[BOT_TARGET_TLQD_{dept}@msnv]', true)}>% Quy ƒë·ªïi</button>
            <button class="btn-target" on:click={() => sendTag('[BOT_TARGET_TLTC_{dept}@msnv]', true)}>% Tr·∫£ ch·∫≠m</button>
            <button class="btn-target" on:click={() => sendTag('[BOT_TARGET_PK_{dept}@msnv]', true)}>% Ph·ª• ki·ªán</button>
            <button class="btn-target" on:click={() => sendTag('[BOT_TARGET_GD_{dept}@msnv]', true)}>% Gia d·ª•ng</button>
        </div>
    </div>
</div>

<style>
    .group-title { font-size: 0.7rem; font-weight: 800; text-transform: uppercase; margin-bottom: 0.35rem; letter-spacing: 0.02em; }
    
    .btn-top, .btn-bot {
        padding: 0.35rem 0; border-radius: 0.25rem; font-size: 0.7rem; font-weight: 600;
        transition: all 0.15s ease-in-out; border: 1px solid transparent; text-align: center; white-space: nowrap;
    }
    
    /* Top: Indigo Theme */
    .btn-top { background-color: #e0e7ff; color: #4338ca; border-color: #c7d2fe; }
    .btn-top:hover { background-color: #c7d2fe; color: #312e81; transform: translateY(-1px); box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
    
    /* Bot: Rose Theme */
    .btn-bot { background-color: #ffe4e6; color: #be123c; border-color: #fecdd3; }
    .btn-bot:hover { background-color: #fecdd3; color: #881337; transform: translateY(-1px); box-shadow: 0 1px 2px rgba(0,0,0,0.05); }

    .btn-target {
        background-color: #f3f4f6; color: #4b5563; border: 1px solid #d1d5db;
        padding: 0.3rem 0.5rem; border-radius: 0.375rem; font-size: 0.75rem; font-weight: 500; transition: all 0.2s;
    }
    .btn-target:hover { background-color: #e5e7eb; border-color: #9ca3af; color: #1f2937; }
</style>
<<< FILE_END: src/components/modals/composer/tabs/TabRanking.svelte

>>> FILE_START: src/components/common/FileInput.svelte
<script>
  /* global feather */
  import { onMount } from 'svelte';
  // [FIX] Import ƒë√∫ng object dataService
  import { dataService } from '../../services/dataService.js';
  import { 
    danhSachNhanVien, rawGioCongData, ycxData, thuongNongData,
    ycxDataThangTruoc, thuongNongDataThangTruoc,
    fileSyncState 
  } from '../../stores.js';
  
  export let label = "Ch∆∞a c√≥ nh√£n";
  export let icon = "file";
  export let saveKey = "";
  // [ADD] Th√™m prop link ƒë·ªÉ nh·∫≠n ƒë∆∞·ªùng d·∫´n t·ª´ cha
  export let link = "";

  let fileName = "Ch∆∞a th√™m file";
  let statusHTML = ""; 
  let isLoading = false;
  let statusClass = "text-gray-500";
  let localError = ""; // [FIX] Bi·∫øn l∆∞u l·ªói c·ª•c b·ªô
  
  const storeMap = {
    'saved_danhsachnv': danhSachNhanVien,
    'saved_giocong': rawGioCongData,
    'saved_ycx': ycxData,
    'saved_thuongnong': thuongNongData,
    'saved_ycx_thangtruoc': ycxDataThangTruoc,
    'saved_thuongnong_thangtruoc': thuongNongDataThangTruoc
  };
  let dataStore = storeMap[saveKey];

  $: syncState = $fileSyncState[saveKey];
  $: dataCount = $dataStore ? $dataStore.length : 0;
  // Logic hi·ªÉn th·ªã tr·∫°ng th√°i (Reactive)
  $: {
      if (isLoading) {
          statusHTML = "ƒêang x·ª≠ l√Ω...";
          statusClass = "text-blue-600 font-semibold";
      } else if (localError) {
          // [FIX] ∆Øu ti√™n hi·ªÉn th·ªã l·ªói n·∫øu c√≥
          statusHTML = localError;
          statusClass = "text-red-600 font-bold";
      } else if (syncState) {
          if (syncState.status === 'update_available') {
              statusClass = "text-orange-600 font-semibold";
              statusHTML = `
                  <span>${syncState.message}</span>
                  <button class="ml-2 px-2 py-0.5 bg-blue-100 text-blue-700 text-xs rounded hover:bg-blue-200 border border-blue-300 font-bold btn-download-cloud pointer-events-auto">
                      T·∫£i & X·ª≠ l√Ω
                  </button>
      
              `;
          } else if (syncState.status === 'downloading') {
              statusClass = "text-blue-600";
              statusHTML = syncState.message;
          } else if (syncState.status === 'error') {
              statusClass = "text-red-600";
              statusHTML = syncState.message;
          } else {
              // Synced ho·∫∑c Cached
              statusClass = "text-green-600 font-medium";
              statusHTML = syncState.message;
              if (syncState.metadata?.fileName) fileName = syncState.metadata.fileName;
          }
      } else if (dataCount > 0) {
          // Fallback khi ch∆∞a c√≥ syncState nh∆∞ng c√≥ data trong store
          statusClass = "text-green-600";
          statusHTML = `‚úì ƒê√£ t·∫£i ${dataCount} d√≤ng (Local)`;
          
          if (saveKey === 'saved_danhsachnv') {
               const savedName = localStorage.getItem('_localDsnvFilename');
               if(savedName) fileName = savedName;
          }
      } else {
          statusHTML = "";
      }
  }

  async function handleChange(event) {
    const file = event.target.files[0];
    if (!file) return;
    isLoading = true;
    localError = ""; // Reset l·ªói c≈©
    fileName = file.name;
    try {
      // G·ªçi service
      const result = await dataService.handleFileChange(file, saveKey);
      if (!result.success) {
          localError = result.message;
      }
    } catch (err) {
      console.error(err);
      localError = `L·ªói: ${err.message}`;
    } finally {
      isLoading = false;
      event.target.value = null;
    }
  }

  function handleContainerClick(e) {
      // N·∫øu click v√†o th·∫ª a (link) th√¨ kh√¥ng l√†m g√¨ c·∫£, ƒë·ªÉ tr√¨nh duy·ªát m·ªü tab m·ªõi
      if (e.target.closest('a')) return;

      if (e.target.closest('.btn-download-cloud')) {
          e.preventDefault();
          e.stopPropagation();
          dataService.downloadFileFromCloud(saveKey);
      }
  }
  
  onMount(() => {
     if (typeof feather !== 'undefined') feather.replace();
  });
</script>

<div class="data-input-group input-group--yellow" on:click={handleContainerClick}> 
    <div class="data-input-group__label relative z-10"> 
       <i data-feather={icon} class="h-5 w-5 feather"></i>
       
       {#if link}
            <a 
                href={link} 
                target="_blank" 
                class="text-blue-700 underline font-bold cursor-pointer relative z-50 hover:text-blue-900 pointer-events-auto"
                on:click|stopPropagation={() => console.log('Link clicked')}
                title="M·ªü b√°o c√°o ngu·ªìn"
            >
                {label}: <i class="w-3 h-3 inline-block ml-1" data-feather="external-link"></i>
            </a>
       {:else}
            <span>{label}:</span>
       {/if}
    </div> 
    
    <div class="data-input-group__content"> 
        <div class="flex items-center gap-2"> 
            <label for="file-{saveKey}" class="data-input-group__file-trigger" class:opacity-50={isLoading}>
                {isLoading ?
                'ƒêang ch·∫°y...' : 'Th√™m file'}
            </label>
            <span class="data-input-group__file-name" title={fileName}>{fileName}</span> 
        </div> 
        
        {#if saveKey === 'saved_danhsachnv'}
            <button on:click={() => dataService.handleTemplateDownload()} class="data-input-group__link text-left">T·∫£i file m·∫´u</button> 
        {/if}

        <input type="file" id="file-{saveKey}" class="hidden" accept=".xlsx, 
        .xls, .csv" on:change={handleChange} disabled={isLoading}> 
        
        <div class="data-input-group__status-wrapper"> 
            <span class="data-input-group__status-text {statusClass}">{@html statusHTML}</span> 
        </div> 
        
        {#if isLoading ||
        (syncState && syncState.status === 'downloading')}
            <div class="progress-bar-container">
                <div class="progress-bar" style="width: 100%; background-color: #3b82f6;"></div>
            </div>
        {/if}
    </div> 
</div>
<<< FILE_END: src/components/common/FileInput.svelte

>>> FILE_START: src/components/common/GlobalNotification.svelte
<script>
  import { notificationStore } from '../../stores.js';
</script>

{#if $notificationStore.visible}
  <div 
    class="fixed bottom-5 right-5 p-4 rounded-lg shadow-md text-white z-[1200] transition-all duration-500 transform translate-y-0
           {$notificationStore.type === 'success' ? 'bg-green-500' : 'bg-red-500'}"
    role="alert"
  >
    {$notificationStore.message}
  </div>
{/if}
<<< FILE_END: src/components/common/GlobalNotification.svelte

>>> FILE_START: src/components/common/PasteInput.svelte
<script>
  /* global feather */
  import { onMount } from 'svelte';
  import { dataService } from '../../services/dataService.js';
  import { 
    competitionData,
    pastedThiDuaReportData,
    thuongERPData,
    thuongERPDataThangTruoc,
    fileSyncState 
  } from '../../stores.js';

  export let label = "Ch∆∞a c√≥ nh√£n";
  export let icon = "clipboard";
  export let link = "#"; 
  export let saveKeyPaste = ""; 
  export let saveKeyRaw = ""; 
  export let saveKeyProcessed = ""; 

  let textareaEl;
  let pastedText = "";
  let localError = "";

  const storeMap = {
    'daily_paste_luyke': competitionData,
    'daily_paste_thiduanv': pastedThiDuaReportData,
    'daily_paste_thuongerp': thuongERPData,
    'saved_thuongerp_thangtruoc': thuongERPDataThangTruoc
  };
  
  const unitMap = {
    'daily_paste_luyke': 'CT thi ƒëua',
    'daily_paste_thiduanv': 'nh√¢n vi√™n',
    'daily_paste_thuongerp': 'nh√¢n vi√™n',
    'saved_thuongerp_thangtruoc': 'nh√¢n vi√™n'
  };

  const countStore = storeMap[saveKeyProcessed || saveKeyPaste];

  $: syncState = $fileSyncState[saveKeyPaste];
  $: dataCount = countStore ? $countStore?.length || 0 : 0;

  let statusHTML = "";
  let statusClass = "text-gray-500";
  let isLoading = false;

  $: {
      const unit = unitMap[saveKeyPaste] || 'd√≤ng';
      const countDisplay = `(${dataCount} ${unit})`;

      if (isLoading) {
          statusHTML = "ƒêang x·ª≠ l√Ω...";
          statusClass = "text-blue-600 font-semibold";
      } else if (localError) {
          statusHTML = localError;
          statusClass = "text-red-600 font-bold";
      } else if (syncState) {
          if (syncState.status === 'update_available') {
              statusClass = "text-orange-600 font-semibold";
              const msg = syncState.message || "C√≥ d·ªØ li·ªáu m·ªõi";
              statusHTML = `
                  <span class="mr-2">${msg}</span>
                  <button class="px-2 py-0.5 bg-blue-100 text-blue-700 text-xs rounded hover:bg-blue-200 border border-blue-300 font-bold btn-download-cloud pointer-events-auto shadow-sm">
                      T·∫£i & X·ª≠ l√Ω
                  </button>
              `;
          } else if (syncState.status === 'downloading') {
              statusClass = "text-blue-600";
              statusHTML = syncState.message || "ƒêang t·∫£i...";
          } else if (syncState.status === 'error') {
              statusClass = "text-red-600";
              statusHTML = syncState.message;
          } else if (syncState.status === 'synced' || syncState.status === 'cached') {
              // [FIX LOGIC] Ch·ªâ b√°o l·ªói 0 NV n·∫øu ƒê√É C√ì TEXT (pastedText > 0)
              // N·∫øu pastedText tr·ªëng, nghƒ©a l√† ch∆∞a t·∫£i n·ªôi dung v·ªÅ, th√¨ kh√¥ng coi l√† l·ªói
              if (dataCount === 0 && saveKeyPaste === 'daily_paste_thiduanv' && pastedText.length > 0) {
                  statusClass = "text-red-600 font-bold";
                  statusHTML = `‚ö† ƒê√£ x·ª≠ l√Ω 0 NV. Vui l√≤ng ki·ªÉm tra DSNV!`;
              } else {
                  statusClass = "text-green-600 font-medium";
                  const prefix = syncState.status === 'synced' ? '‚úì ƒê√£ ƒë·ªìng b·ªô' : '‚úì ƒê√£ t·∫£i';
                  let cleanMsg = syncState.message
                      .replace('‚úì ƒê√£ ƒë·ªìng b·ªô', '')
                      .replace('‚úì ƒê√£ t·∫£i', '')
                      .replace('(Local)', '')
                      .trim();
                  
                  // Logic hi·ªÉn th·ªã th√¥ng minh: N·∫øu ch∆∞a c√≥ text, g·ª£i √Ω t·∫£i
                  if (pastedText.length === 0 && syncState.status === 'synced') {
                      // ƒê√£ ƒë·ªìng b·ªô metadata nh∆∞ng ch∆∞a c√≥ text -> Hi·ªÉn th·ªã n√∫t t·∫£i l·∫°i cho ch·∫Øc
                       statusHTML = `
                          <span class="mr-2 text-gray-500">‚úì ƒê√£ bi·∫øt c√≥ d·ªØ li·ªáu tr√™n Cloud.</span>
                          <button class="px-2 py-0.5 bg-green-50 text-green-700 text-xs rounded hover:bg-green-100 border border-green-200 font-bold btn-download-cloud pointer-events-auto shadow-sm">
                              T·∫£i v·ªÅ m√°y
                          </button>
                      `;
                  } else {
                       // Hi·ªÉn th·ªã b√¨nh th∆∞·ªùng
                       if (cleanMsg.includes('d√≤ng') || cleanMsg.includes('nh√¢n vi√™n') || cleanMsg.includes('CT')) {
                           if(cleanMsg.includes('tr∆∞·ªõc') || cleanMsg.includes('v·ª´a xong')) {
                               statusHTML = `${prefix} ${countDisplay} ${cleanMsg}`;
                           } else {
                               statusHTML = `${prefix} ${countDisplay}`;
                           }
                      } else {
                           statusHTML = `${prefix} ${countDisplay} ${cleanMsg}`;
                      }
                  }
              }
          } else if (syncState.status === 'checking') {
               statusClass = "text-gray-500 italic";
               statusHTML = "ƒêang ki·ªÉm tra ƒë·ªìng b·ªô...";
          }
      } else if (dataCount > 0) {
          statusClass = "text-green-600";
          statusHTML = `‚úì ƒê√£ t·∫£i ${countDisplay} (Local)`;
      } else {
          statusHTML = "";
      }
  }

  onMount(() => {
    const textLoadKey = saveKeyRaw || saveKeyPaste;
    pastedText = localStorage.getItem(textLoadKey) || "";
    
    window.addEventListener('cloud-paste-loaded', (e) => {
        if (e.detail.key === saveKeyPaste) {
            pastedText = e.detail.text;
        }
    });

    if (typeof feather !== 'undefined') feather.replace();
  });

  let pasteTimer;
  function handleInput(event) {
      const text = event.target.value;
      pastedText = text;
      localError = "";
      clearTimeout(pasteTimer);
      
      if (!text || text.trim().length < 5) return;
      
      isLoading = true;
      pasteTimer = setTimeout(async () => {
          try {
            const result = await dataService.handlePasteChange(
                text, 
                saveKeyPaste, 
                saveKeyRaw, 
                saveKeyProcessed
            );
            if (!result.success) localError = result.message;
          } catch (err) {
            console.error(`L·ªói paste ${label}:`, err);
            localError = `L·ªói: ${err.message}`;
          } finally {
            isLoading = false;
          }
      }, 500);
  }

  function handleContainerClick(e) {
      if (e.target.closest('.btn-download-cloud')) {
          e.preventDefault();
          e.stopPropagation();
          dataService.downloadFileFromCloud(saveKeyPaste);
      }
  }
</script>

<div class="data-input-group input-group--blue h-full" on:click={handleContainerClick}>
    <a href={link} target="_blank" class="data-input-group__label data-input-group__label--link">
        <i data-feather={icon} class="h-5 w-5 feather"></i>
        <span>{label}: <span class="font-normal text-xs text-gray-500 ml-1">(Copy t·ª´ BI)</span></span>
    </a>
    <div class="data-input-group__content flex flex-col flex-grow">
        <textarea 
            bind:this={textareaEl}
            rows="5" 
            class="data-textarea flex-grow mb-1" 
            placeholder="D√°n d·ªØ li·ªáu ƒë√£ sao ch√©p v√†o ƒë√¢y..."
            on:input={handleInput}
            value={pastedText}
            disabled={isLoading}
        ></textarea>
        
        <div class="data-input-group__status-wrapper min-h-[20px]">
            <span class="data-input-group__status-text {statusClass} flex items-center gap-1">
                {@html statusHTML}
            </span>
        </div>
        
        {#if isLoading || (syncState && syncState.status === 'downloading')}
             <div class="progress-bar-container mt-1">
                <div class="progress-bar" style="width: 100%; background-color: #3b82f6;"></div>
            </div>
        {/if}
    </div>
</div>
<<< FILE_END: src/components/common/PasteInput.svelte

>>> FILE_START: src/components/common/SortableTh.svelte
<script>
  import { createEventDispatcher } from 'svelte';
  
  // Props
  export let key = '';           // Key ƒë·ªãnh danh c·ªôt
  export let label = '';         // T√™n hi·ªÉn th·ªã
  export let sortKey = '';       // C·ªôt ƒëang ƒë∆∞·ª£c sort
  export let sortDirection = 'desc'; // H∆∞·ªõng sort
  export let align = 'left';     // CƒÉn l·ªÅ: left, right, center
  export let className = '';     // Class t√πy ch·ªânh th√™m (vd: sticky, width)

  const dispatch = createEventDispatcher();

  function handleClick() {
    dispatch('sort', key);
  }

  $: isActive = sortKey === key;
  
  // Logic cƒÉn l·ªÅ flexbox
  $: alignClass = align === 'right' ? 'justify-end' : 
                  align === 'center' ? 'justify-center' : 
                  'justify-start';

  // Logic cƒÉn l·ªÅ text
  $: textAlignClass = align === 'right' ? 'text-right' : 
                      align === 'center' ? 'text-center' : 
                      'text-left';
</script>

<th 
  class="px-4 py-3 cursor-pointer transition select-none hover:bg-slate-200 {textAlignClass} {className} {isActive ? 'bg-blue-50' : ''}"
  on:click={handleClick}
  role="columnheader"
  aria-sort={isActive ? (sortDirection === 'asc' ? 'ascending' : 'descending') : 'none'}
>
  <div class="flex items-center gap-1 {alignClass}">
    <span class="font-bold uppercase text-xs {isActive ? 'text-blue-800' : 'text-slate-700'}">
      {label}
    </span>
    
    <span class="flex flex-col items-center justify-center w-4 h-4">
      {#if !isActive}
        <svg xmlns="http://www.w3.org/2000/svg" class="w-3 h-3 text-gray-400 opacity-50" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
          <path stroke-linecap="round" stroke-linejoin="round" d="M7 16V4m0 0L3 8m4-4l4 4m6 0v12m0 0l4-4m-4 4l-4-4" />
        </svg>
      {:else if sortDirection === 'asc'}
        <svg xmlns="http://www.w3.org/2000/svg" class="w-3.5 h-3.5 text-blue-700" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="3">
          <path stroke-linecap="round" stroke-linejoin="round" d="M5 15l7-7 7 7" />
        </svg>
      {:else}
        <svg xmlns="http://www.w3.org/2000/svg" class="w-3.5 h-3.5 text-blue-700" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="3">
          <path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7" />
        </svg>
      {/if}
    </span>
  </div>
</th>
<<< FILE_END: src/components/common/SortableTh.svelte

>>> FILE_START: src/components/common/VersionManager.svelte
<script context="module">
    // Store ƒë∆°n gi·∫£n ƒë·ªÉ c√°c component kh√°c c√≥ th·ªÉ g·ªçi popup chi ti·∫øt
    import { writable } from 'svelte/store';
    export const showVersionDetails = writable(false);
</script>

<script>
    import { onMount } from 'svelte';
    import { homeConfig } from '../../stores.js';
    import { adminService } from '../../services/admin.service.js';

    // Bi·∫øn tr·∫°ng th√°i
    let showForceUpdateModal = false;
    let latestVersionData = null;
    let clientVersion = '';

    // L·∫•y tr·∫°ng th√°i hi·ªÉn th·ªã popup chi ti·∫øt t·ª´ store
    let showDetails = false;
    showVersionDetails.subscribe(val => showDetails = val);

    onMount(async () => {
        // 1. L·∫•y version hi·ªán t·∫°i c·ªßa m√°y kh√°ch (trong LocalStorage)
        clientVersion = localStorage.getItem('app_client_version') || '0.0';

        // 2. ƒê·∫£m b·∫£o load config m·ªõi nh·∫•t t·ª´ Cloud
        await adminService.loadHomeConfig();
    });

    // 3. Theo d√µi s·ª± thay ƒë·ªïi c·ªßa Config t·ª´ Server
    $: if ($homeConfig && $homeConfig.changelogs && $homeConfig.changelogs.length > 0) {
        // L·∫•y b·∫£n ghi m·ªõi nh·∫•t (ph·∫ßn t·ª≠ ƒë·∫ßu ti√™n)
        latestVersionData = $homeConfig.changelogs[0];
        
        // Ki·ªÉm tra version
        checkVersion(latestVersionData.version);
    }

    function checkVersion(serverVersion) {
        if (!serverVersion) return;
        
        // N·∫øu version server kh√°c version client -> B·∫ÆT BU·ªòC C·∫¨P NH·∫¨T
        // (So s√°nh chu·ªói ƒë∆°n gi·∫£n, n·∫øu mu·ªën ch·∫∑t ch·∫Ω h∆°n c√≥ th·ªÉ d√πng semver)
        if (serverVersion !== clientVersion) {
            showForceUpdateModal = true;
        }
    }

    function performUpdate() {
        if (!latestVersionData) return;
        
        // 1. L∆∞u version m·ªõi v√†o m√°y kh√°ch
        localStorage.setItem('app_client_version', latestVersionData.version);
        
        // 2. Reload trang ƒë·ªÉ t·∫£i code m·ªõi
        window.location.reload();
    }

    function closeDetails() {
        showVersionDetails.set(false);
    }
</script>

{#if showForceUpdateModal && latestVersionData}
    <div class="fixed inset-0 z-[9999] bg-slate-900/90 backdrop-blur-sm flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl max-w-md w-full overflow-hidden animate-bounce-in">
            <div class="bg-gradient-to-r from-blue-600 to-indigo-700 p-6 text-center">
                <div class="w-16 h-16 bg-white/20 rounded-full flex items-center justify-center mx-auto mb-4 backdrop-blur-sm">
                    <i data-feather="download-cloud" class="w-8 h-8 text-white"></i>
                </div>
                <h2 class="text-2xl font-bold text-white mb-1">C·∫≠p nh·∫≠t h·ªá th·ªëng</h2>
                <p class="text-blue-100 text-sm">ƒê√£ c√≥ phi√™n b·∫£n m·ªõi: <span class=" font-bold bg-white/20 px-2 py-0.5 rounded">{latestVersionData.version}</span></p>
            </div>
            
            <div class="p-6">
                <div class="mb-6">
                    <h3 class="text-sm font-bold text-gray-500 uppercase mb-2">N·ªôi dung thay ƒë·ªïi:</h3>
                    <div class="bg-slate-50 p-4 rounded-lg border border-slate-100 max-h-40 overflow-y-auto text-sm text-slate-600 leading-relaxed custom-content">
                        {@html latestVersionData.content}
                    </div>
                </div>

                <button 
                    on:click={performUpdate}
                    class="w-full py-3.5 bg-blue-600 hover:bg-blue-700 text-white font-bold rounded-xl shadow-lg shadow-blue-200 transition-all transform hover:scale-[1.02] flex items-center justify-center gap-2"
                >
                    <i data-feather="refresh-cw" class="w-4 h-4 animate-spin-slow"></i>
                    C·∫≠p nh·∫≠t ngay
                </button>
                <p class="text-center text-xs text-slate-400 mt-3">Y√™u c·∫ßu t·∫£i l·∫°i trang ƒë·ªÉ √°p d·ª•ng thay ƒë·ªïi.</p>
            </div>
        </div>
    </div>
{/if}

{#if showDetails && !showForceUpdateModal && latestVersionData}
    <div class="fixed inset-0 z-[9000] bg-black/50 backdrop-blur-sm flex items-center justify-center p-4" on:click={closeDetails}>
        <div class="bg-white rounded-xl shadow-xl max-w-lg w-full relative animate-fade-in" on:click|stopPropagation>
            <button class="absolute top-4 right-4 text-gray-400 hover:text-red-500 transition" on:click={closeDetails}>
                <i data-feather="x" class="w-6 h-6"></i>
            </button>

            <div class="p-6 border-b border-gray-100">
                <h3 class="text-xl font-bold text-slate-800 flex items-center gap-2">
                    <span class="bg-green-100 text-green-700 p-1.5 rounded-lg"><i data-feather="info" class="w-5 h-5"></i></span>
                    Th√¥ng tin phi√™n b·∫£n
                </h3>
            </div>

            <div class="p-6 space-y-4">
                <div class="flex justify-between items-center bg-slate-50 p-3 rounded-lg border border-slate-200">
                    <div>
                        <p class="text-xs text-slate-500 uppercase font-bold">Phi√™n b·∫£n hi·ªán t·∫°i</p>
                        <p class="text-lg font-bold text-blue-600 ">{latestVersionData.version}</p>
                    </div>
                    <div class="text-right">
                        <p class="text-xs text-slate-500 uppercase font-bold">Ng√†y c·∫≠p nh·∫≠t</p>
                        <p class="text-sm font-medium text-slate-700">{latestVersionData.date}</p>
                    </div>
                </div>

                <div>
                    <h4 class="text-sm font-bold text-slate-700 mb-2">Chi ti·∫øt thay ƒë·ªïi:</h4>
                    <div class="text-sm text-slate-600 leading-relaxed custom-content pl-2">
                        {@html latestVersionData.content}
                    </div>
                </div>
            </div>
            
            <div class="p-4 bg-gray-50 rounded-b-xl border-t border-gray-100 text-right">
                <button class="px-4 py-2 bg-gray-200 text-gray-700 font-bold rounded-lg hover:bg-gray-300 transition" on:click={closeDetails}>ƒê√≥ng</button>
            </div>
        </div>
    </div>
{/if}

<style>
    .animate-bounce-in { animation: bounceIn 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55); }
    @keyframes bounceIn { from { opacity: 0; transform: scale(0.8); } to { opacity: 1; transform: scale(1); } }
    .animate-spin-slow { animation: spin 3s linear infinite; }
    @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
    
    /* Style cho n·ªôi dung HTML t·ª´ admin */
    :global(.custom-content ul) { list-style-type: disc; padding-left: 1.5rem; margin: 0.5rem 0; }
    :global(.custom-content li) { margin-bottom: 0.25rem; }
    :global(.custom-content strong) { color: #1e293b; font-weight: 700; }
</style>
<<< FILE_END: src/components/common/VersionManager.svelte

>>> FILE_START: src/components/Sidebar.svelte
<script>
  /* global feather */
  import { onMount } from 'svelte';
  // [FIX] Import store isAdmin v√† modalState ƒë·ªÉ ki·ªÉm tra quy·ªÅn
  import { activeTab, drawerState, isAdmin, modalState } from '../stores.js';

  // H√†m chuy·ªÉn tab (C·∫≠p nh·∫≠t store global)
  function navigateTo(targetId) {
    // [LOGIC M·ªöI] T·ª± ƒë·ªông tho√°t quy·ªÅn Admin khi r·ªùi kh·ªèi tab Khai b√°o
    if ($activeTab === 'declaration-section' && targetId !== 'declaration-section') {
        isAdmin.set(false);
        console.log("[Security] ƒê√£ t·ª± ƒë·ªông ƒëƒÉng xu·∫•t quy·ªÅn Admin khi r·ªùi trang Khai b√°o.");
    }

    // N·∫øu v√†o Khai b√°o m√† ch∆∞a ph·∫£i Admin -> B·∫≠t modal ƒëƒÉng nh·∫≠p
    if (targetId === 'declaration-section' && !$isAdmin) {
        modalState.update(s => ({ ...s, activeModal: 'admin-modal' }));
        return;
    }
    activeTab.set(targetId);
  }

  // H√†m m·ªü Drawer (C·∫≠p nh·∫≠t store global)
  function openDrawer(drawerId) {
    drawerState.update(state => ({ ...state, activeDrawer: drawerId }));
  }

  // Reactive: Helper ƒë·ªÉ ki·ªÉm tra tab n√†o ƒëang active (ƒë·ªÉ t√¥ m√†u)
  $: currentTab = $activeTab;

  onMount(() => {
    if (typeof window.feather !== 'undefined') {
      window.feather.replace();
    }
  });
</script>

<nav id="sidebar" class="bg-white/80 backdrop-blur-sm shadow-lg fixed top-0 left-0 h-full z-30 p-3 flex flex-col justify-between">
    <div>
        <button 
           class="nav-link flex items-center p-3 rounded-lg font-semibold mb-4 w-full transition-colors
           {currentTab === 'home-section' ? 'bg-blue-100 text-blue-700' : 'text-gray-700 hover:bg-gray-200'}"
           on:click={() => navigateTo('home-section')}
         >
            <i data-feather="home"></i>
            <span class="menu-text">H∆∞·ªõng D·∫´n & G√≥p √ù</span>
         </button>

        <ul class="space-y-2">
            <li>
                <button 
                  class="nav-link flex items-center p-3 rounded-lg font-semibold w-full transition-colors
                         {currentTab === 'data-section' ? 'bg-blue-100 text-blue-700' : 'text-gray-700 hover:bg-gray-200'}"
                  on:click={() => navigateTo('data-section')}
                >
                    <i data-feather="file-text"></i>
                    <span class="menu-text">C·∫≠p nh·∫≠t d·ªØ li·ªáu</span>
                </button>
            </li>

            <li>
                <button 
                  class="nav-link flex items-center p-3 rounded-lg font-semibold w-full transition-colors
                         {currentTab === 'health-section' ? 'bg-blue-100 text-blue-700' : 'text-gray-700 hover:bg-gray-200'}"
                  on:click={() => navigateTo('health-section')}
                >
                    <i data-feather="activity"></i>
                    <span class="menu-text">S·ª©c kh·ªèe si√™u th·ªã</span>
                </button>
            </li>

            <li>
                <button 
                  class="nav-link flex items-center p-3 rounded-lg font-semibold w-full transition-colors
                         {currentTab === 'health-employee-section' ? 'bg-blue-100 text-blue-700' : 'text-gray-700 hover:bg-gray-200'}"
                  on:click={() => navigateTo('health-employee-section')}
                >
                    <i data-feather="users"></i>
                    <span class="menu-text">S·ª©c kh·ªèe nh√¢n vi√™n</span>
                </button>
            </li>

            <li>
                <button 
                  class="nav-link flex items-center p-3 rounded-lg font-semibold w-full transition-colors
                         {currentTab === 'realtime-section' ? 'bg-blue-100 text-blue-700' : 'text-gray-700 hover:bg-gray-200'}"
                  on:click={() => navigateTo('realtime-section')}
                >
                    <i data-feather="trending-up"></i>
                    <span class="menu-text">Doanh thu realtime</span>
                </button>
            </li>
        </ul>
    </div>

    <div>
        <ul class="space-y-2">
            <li>
                 <button 
                   id="interface-settings-btn" 
                   class="w-full flex items-center p-3 text-gray-700 rounded-lg hover:bg-gray-200 font-semibold"
                   on:click={() => openDrawer('interface-drawer')}
                >
                    <i data-feather="settings"></i>
                    <span class="menu-text">C√†i ƒë·∫∑t giao di·ªán</span>
                </button>
            </li>

            <li>
                 <button 
                  id="goal-settings-btn" 
                  class="w-full flex items-center p-3 text-gray-700 rounded-lg hover:bg-gray-200 font-semibold"
                  on:click={() => openDrawer('goal-drawer')}
                >
                    <i data-feather="target"></i>
                    <span class="menu-text">Thi·∫øt l·∫≠p m·ª•c ti√™u</span>
                </button>
            </li>

            <li>
                <button 
                  id="admin-access-btn" 
                  class="w-full flex items-center p-3 rounded-lg font-semibold transition-colors
                         {currentTab === 'declaration-section' ? 'bg-blue-100 text-blue-700' : 'text-gray-700 hover:bg-gray-200'}"
                  on:click={() => navigateTo('declaration-section')}
                >
                    <i data-feather="edit"></i>
                    <span class="menu-text">Khai b√°o</span>
                </button>
            </li>
        </ul>
    </div>
</nav>

<style>
  #sidebar { 
    width: 68px;
    transition: width 0.3s ease-in-out; 
    overflow-x: hidden; 
  }
  #sidebar:hover { 
    width: 256px;
  }
  #sidebar.menu-locked:hover { 
    width: 68px;
  }

  #sidebar .nav-link, #sidebar button {
    white-space: nowrap;
    gap: 1rem;
    justify-content: flex-start;
  }

  .menu-text {
    transition: opacity 0.2s ease-in-out, width 0.3s ease-in-out;
    opacity: 0;
    white-space: nowrap;
    width: 0;
    overflow: hidden;
  }
  #sidebar:hover .menu-text {
    opacity: 1;
    transition-delay: 0.1s;
    width: auto;
  }
  #sidebar.menu-locked:hover .menu-text {
    opacity: 0;
    width: 0;
  }

  #sidebar :global(.feather) {
    width: 1.5rem;
    height: 1.5rem;
    stroke-width: 2;
    flex-shrink: 0;
  }
</style>
<<< FILE_END: src/components/Sidebar.svelte

>>> FILE_START: src/components/drawers/GoalDrawer.svelte
<script>
  import { onMount, afterUpdate } from 'svelte';
  import { 
      drawerState, warehouseList, luykeGoalSettings, realtimeGoalSettings, 
      modalState, localCompetitionConfigs, selectedWarehouse, efficiencyConfig,
      // [CODEGENESIS] Import Store KPI M·ªõi
      kpiStore 
  } from '../../stores.js';
  
  import { settingsService } from '../../services/settings.service.js';
  import { datasyncService } from '../../services/datasync.service.js';
  import { adminService } from '../../services/admin.service.js';

  let activeTab = 'monthly';
  let localSelectedWarehouse = '';
  let currentLuykeGoals = {};
  let currentRealtimeGoals = { goals: {}, timing: {} };

  $: isOpen = $drawerState.activeDrawer === 'goal-drawer';

  // T·ª± ƒë·ªông ch·ªçn kho
  $: if (isOpen && !localSelectedWarehouse) {
      localSelectedWarehouse = $selectedWarehouse || ($warehouseList.length > 0 ? $warehouseList[0] : '');
  }

  // Khi ƒë·ªïi kho, t·∫£i d·ªØ li·ªáu t·ª´ Cloud
  $: if (isOpen && localSelectedWarehouse) {
      loadGoals(localSelectedWarehouse);
  }

  async function loadGoals(kho) {
      await settingsService.loadGoalsFromCloud(kho);
      currentLuykeGoals = { ...($luykeGoalSettings[kho] || {}) };
      
      const rtSettings = $realtimeGoalSettings[kho] || { goals: {}, timing: {} };
      currentRealtimeGoals = { goals: { ...rtSettings.goals }, timing: { ...rtSettings.timing } };
      
      // [CODEGENESIS] ƒê·ªìng b·ªô ng∆∞·ª£c t·ª´ d·ªØ li·ªáu t·∫£i v·ªÅ v√†o kpiStore ƒë·ªÉ b·∫£ng hi·ªÉn th·ªã ƒë√∫ng ngay khi m·ªü
      updateKpiStore();
  }

  onMount(async () => {
      const configs = await adminService.loadEfficiencyConfig();
      efficiencyConfig.set(configs);
      if (typeof feather !== 'undefined') feather.replace();
  });

  afterUpdate(() => {
      if (typeof feather !== 'undefined') feather.replace();
  });

  function close() {
      drawerState.update(s => ({ ...s, activeDrawer: null }));
  }

  function switchTab(tab) { activeTab = tab; }

  // [FIX] C·∫≠p nh·∫≠t kpiStore khi nh·∫≠p li·ªáu
  function updateKpiStore() {
      kpiStore.update(store => ({
          ...store,
          // C·∫≠p nh·∫≠t settings to√†n c·ª•c ƒë·ªÉ b·∫£ng t√¥ m√†u ngay l·∫≠p t·ª©c
          globalSettings: {
              ...store.globalSettings,
              phanTramQD: Number(currentLuykeGoals.phanTramQD) || 80,
              phanTramTC: Number(currentLuykeGoals.phanTramTC) || 20
          }
      }));
  }

  function saveLuyke() {
      if (!localSelectedWarehouse) return;
      // 1. L∆∞u v√†o kho c≈© (ƒë·ªÉ gi·ªØ logic ƒë·ªìng b·ªô cloud c≈©)
      settingsService.saveLuykeGoalForWarehouse(localSelectedWarehouse, currentLuykeGoals);
      
      // 2. [CODEGENESIS] B·∫Øn t√≠n hi·ªáu sang kho m·ªõi ƒë·ªÉ t√¥ m√†u Realtime
      updateKpiStore();
  }

  function saveRealtime() {
      if (!localSelectedWarehouse) return;
      settingsService.saveRealtimeGoalForWarehouse(localSelectedWarehouse, currentRealtimeGoals);
  }

  // C√°c h√†m qu·∫£n l√Ω thi ƒëua
  function openCompetitionManager() {
      if (localSelectedWarehouse) selectedWarehouse.set(localSelectedWarehouse);
      modalState.update(s => ({ ...s, activeModal: 'user-competition-modal' }));
  }

  function editCompetition(index) {
      if (localSelectedWarehouse) selectedWarehouse.set(localSelectedWarehouse);
      modalState.update(s => ({ ...s, activeModal: 'user-competition-modal', editingIndex: index }));
  }

  async function deleteCompetition(index) {
      if (!confirm("B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a ch∆∞∆°ng tr√¨nh thi ƒëua n√†y?")) return;
      
      let newConfigs = [...$localCompetitionConfigs];
      newConfigs.splice(index, 1);
      localCompetitionConfigs.set(newConfigs);
      
      if (localSelectedWarehouse) {
          try {
              await datasyncService.saveCompetitionConfigs(localSelectedWarehouse, newConfigs);
          } catch(e) { console.error(e); }
      }
  }

  const percentageInputs = [
      { id: 'phanTramQD', label: '% Quy ƒë·ªïi' },
      { id: 'phanTramTC', label: '% Tr·∫£ ch·∫≠m' }
  ];
</script>

{#if isOpen}
  <div class="fixed inset-0 bg-black/40 z-40 transition-opacity" on:click={close} role="button" tabindex="0"></div>
{/if}

<div class="fixed top-0 left-0 h-full bg-white shadow-2xl z-50 p-6 overflow-y-auto w-[500px] max-w-[95vw] transition-transform duration-300 ease-in-out transform {isOpen ? 'translate-x-0' : '-translate-x-full'}">
  
  <div class="flex justify-between items-center mb-6">
      <h3 class="text-xl font-bold text-gray-800">Thi·∫øt l·∫≠p m·ª•c ti√™u</h3>
      <button class="text-gray-500 hover:text-gray-800 text-3xl leading-none" on:click={close}>&times;</button>
  </div>

  <div class="border-b border-gray-200 mb-6 flex space-x-6">
      <button class="pb-2 border-b-2 font-medium text-sm transition-colors {activeTab === 'monthly' ? 'border-blue-600 text-blue-600' : 'border-transparent text-gray-500 hover:text-gray-700'}" on:click={() => switchTab('monthly')}>
          M·ª•c ti√™u Th√°ng (L≈©y k·∫ø)
      </button>
      <button class="pb-2 border-b-2 font-medium text-sm transition-colors {activeTab === 'daily' ? 'border-blue-600 text-blue-600' : 'border-transparent text-gray-500 hover:text-gray-700'}" on:click={() => switchTab('daily')}>
          M·ª•c ti√™u Ng√†y (Realtime)
      </button>
  </div>

  <div class="space-y-8">
      <div>
          <label for="goal-warehouse" class="block text-sm font-bold text-gray-700 mb-1">Thi·∫øt l·∫≠p cho kho</label>
          <select id="goal-warehouse" class="w-full p-2.5 border border-gray-300 rounded-lg text-sm bg-white shadow-sm focus:ring-2 focus:ring-blue-500 outline-none font-semibold text-blue-700" bind:value={localSelectedWarehouse}>
              {#if $warehouseList.length === 0}
                  <option value="">Vui l√≤ng t·∫£i file DSNV...</option>
              {:else}
                  {#each $warehouseList as kho}
                      <option value={kho}>{kho}</option>
                  {/each}
              {/if}
          </select>
      </div>

      {#if activeTab === 'monthly'}
          <div class="space-y-5 animate-fade-in">
              <div class="grid grid-cols-2 gap-4">
                  <div>
                      <label for="luyke-dtt" class="block text-sm font-medium text-gray-700">Target DT Th·ª±c</label>
                      <input type="number" id="luyke-dtt" class="luyke-goal-input mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500" bind:value={currentLuykeGoals.doanhThuThuc} on:input={saveLuyke}>
                  </div>
                  <div>
                      <label for="luyke-dtqd" class="block text-sm font-medium text-gray-700">Target DT Qƒê</label>
                      <input type="number" id="luyke-dtqd" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500" bind:value={currentLuykeGoals.doanhThuQD} on:input={saveLuyke}>
                  </div>
              </div>

              <details class="group border rounded-lg overflow-hidden" open>
                  <summary class="p-3 text-sm font-bold cursor-pointer bg-gray-50 hover:bg-gray-100 flex justify-between items-center select-none">
                      M·ª•c ti√™u khai th√°c (%) <span class="transform group-open:rotate-180 transition-transform">‚ñº</span>
                  </summary>
                  <div class="p-4 bg-white border-t grid grid-cols-2 gap-4">
                      {#each percentageInputs as input}
                          <div>
                              <label for="luyke-{input.id}" class="block text-sm font-medium text-gray-700">{input.label}</label>
                              <input 
                                  type="number" 
                                  id="luyke-{input.id}" 
                                  class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500" 
                                  bind:value={currentLuykeGoals[input.id]} 
                                  on:input={saveLuyke} 
                                  placeholder={input.id === 'phanTramQD' ? '80' : '20'}
                              >
                          </div>
                      {/each}
                      
                      {#each $efficiencyConfig as item}
                          <div>
                              <label for="goal-{item.id}" class="block text-sm font-medium text-gray-700 truncate" title={item.label}>
                                  {item.label} (MT: {item.target}%)
                              </label>
                              <input type="number" id="goal-{item.id}" class="mt-1 block w-full p-2 border border-blue-200 bg-blue-50 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500" placeholder={item.target} bind:value={currentLuykeGoals[item.id]} on:input={saveLuyke} >
                          </div>
                      {/each}
                  </div>
              </details>
          </div>
      {/if}

      {#if activeTab === 'daily'}
          <div class="space-y-5 animate-fade-in">
              <div class="grid grid-cols-2 gap-4 items-end">
                  <div>
                      <label for="rt-open" class="block text-sm font-medium text-gray-700 mb-1">Gi·ªù m·ªü c·ª≠a</label>
                      <input type="time" id="rt-open" class="p-2 border border-gray-300 rounded-md shadow-sm w-full" bind:value={currentRealtimeGoals.timing['rt-open-hour']} on:input={saveRealtime}>
                  </div>
                  <div>
                      <label for="rt-close" class="block text-sm font-medium text-gray-700 mb-1">Gi·ªù ƒë√≥ng c·ª≠a</label>
                      <input type="time" id="rt-close" class="p-2 border border-gray-300 rounded-md shadow-sm w-full" bind:value={currentRealtimeGoals.timing['rt-close-hour']} on:input={saveRealtime}>
                  </div>
              </div>

              <div class="grid grid-cols-2 gap-4">
                  <div>
                      <label for="rt-dtt" class="block text-sm font-medium text-gray-700">DT Th·ª±c (tri·ªáu)</label>
                      <input type="number" id="rt-dtt" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500" bind:value={currentRealtimeGoals.goals.doanhThuThuc} on:input={saveRealtime}>
                  </div>
                  <div>
                      <label for="rt-dtqd" class="block text-sm font-medium text-gray-700">DT Qƒê (tri·ªáu)</label>
                      <input type="number" id="rt-dtqd" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500" bind:value={currentRealtimeGoals.goals.doanhThuQD} on:input={saveRealtime}>
                  </div>
              </div>

              <details class="group border rounded-lg overflow-hidden" open>
                  <summary class="p-3 text-sm font-bold cursor-pointer bg-gray-50 hover:bg-gray-100 flex justify-between items-center select-none">
                      M·ª•c ti√™u t·ª∑ l·ªá Realtime (%) <span class="transform group-open:rotate-180 transition-transform">‚ñº</span>
                  </summary>
                  <div class="p-4 bg-white border-t grid grid-cols-2 gap-4">
                      {#each percentageInputs as input}
                          <div>
                              <label for="rt-{input.id}" class="block text-sm font-medium text-gray-700">{input.label}</label>
                              <input type="number" id="rt-{input.id}" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500" bind:value={currentRealtimeGoals.goals[input.id]} on:input={saveRealtime}>
                          </div>
                      {/each}
                      
                      {#each $efficiencyConfig as item}
                          <div>
                              <label for="rt-goal-{item.id}" class="block text-sm font-medium text-gray-700 truncate" title={item.label}>{item.label}</label>
                              <input type="number" id="rt-goal-{item.id}" class="mt-1 block w-full p-2 border border-blue-200 bg-blue-50 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500" placeholder={item.target} bind:value={currentRealtimeGoals.goals[item.id]} on:input={saveRealtime}>
                          </div>
                      {/each}
                  </div>
              </details>
          </div>
      {/if}

      <div class="border-t pt-6 space-y-4">
          <div class="flex justify-between items-center">
              <h4 class="text-lg font-bold text-gray-800">Qu·∫£n l√Ω Ch∆∞∆°ng tr√¨nh Thi ƒëua</h4>
              <button on:click={openCompetitionManager} class="text-sm bg-blue-600 text-white px-3 py-1.5 rounded-lg hover:bg-blue-700 font-medium flex items-center gap-1 shadow-sm"><i data-feather="plus-circle" class="w-4 h-4"></i> T·∫°o m·ªõi</button>
          </div>
          
          <div class="space-y-3 max-h-[300px] overflow-y-auto pr-1 custom-scrollbar pb-2">
              {#if $localCompetitionConfigs.length === 0}
                  <div class="text-center py-6 bg-gray-50 rounded-lg border border-dashed border-gray-300">
                      <p class="text-gray-500 text-sm italic">Ch∆∞a c√≥ ch∆∞∆°ng tr√¨nh n√†o.</p>
                  </div>
              {:else}
                  {#each $localCompetitionConfigs as config, index}
                      <div class="bg-white border border-gray-200 rounded-xl p-4 shadow-sm relative group hover:border-blue-300 hover:shadow-md transition-all">
                          <div class="flex justify-between items-start mb-2 pr-14">
                              <h4 class="text-base font-bold text-gray-800 leading-tight">{config.name}</h4>
                          </div>
                          
                          <div class="flex flex-wrap gap-2 mb-2">
                              <span class="text-[10px] uppercase px-2 py-0.5 rounded-full font-bold border {config.type === 'doanhthu' ? 'bg-blue-50 text-blue-700 border-blue-100' : 'bg-yellow-50 text-yellow-700 border-yellow-100'}">
                                  {config.type === 'doanhthu' ? 'Doanh thu' : 'S·ªë l∆∞·ª£ng'}
                              </span>
                              {#if config.excludeApple}
                                  <span class="text-[10px] px-2 py-0.5 rounded-full font-bold bg-red-50 text-red-600 border border-red-100">No Apple</span>
                              {/if}
                          </div>

                          <div class="text-xs text-gray-600 bg-gray-50 p-2 rounded border border-gray-100 grid grid-cols-1 gap-1">
                              <div class="flex items-start gap-1">
                                  <span class="font-bold min-w-[35px]">H√£ng:</span>
                                  <span class="text-blue-700 font-medium">{config.brands.join(', ')}</span>
                              </div>
                              <div class="flex items-start gap-1">
                                  <span class="font-bold min-w-[35px]">Nh√≥m:</span>
                                  <span class="text-gray-800">
                                      {#if config.groups.length > 0}
                                          {config.groups.join(', ')}
                                      {:else}
                                          <span class="italic text-gray-400">T·∫•t c·∫£</span>
                                      {/if}
                                  </span>
                              </div>
                          </div>

                          <div class="absolute top-3 right-3 flex gap-1">
                              <button on:click={() => editCompetition(index)} class="p-1.5 text-gray-400 hover:text-blue-600 hover:bg-blue-50 rounded-md transition-colors"><i data-feather="edit-2" class="w-4 h-4"></i></button>
                              <button on:click={() => deleteCompetition(index)} class="p-1.5 text-gray-400 hover:text-red-600 hover:bg-red-50 rounded-md transition-colors"><i data-feather="trash-2" class="w-4 h-4"></i></button>
                          </div>
                      </div>
                  {/each}
              {/if}
          </div>
      </div>
  </div>
</div>

<style>
  @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
  .animate-fade-in { animation: fadeIn 0.3s ease-out; }
  .custom-scrollbar::-webkit-scrollbar { width: 4px; }
  .custom-scrollbar::-webkit-scrollbar-track { background: #f1f1f1; }
  .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 2px; }
  .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
</style>
<<< FILE_END: src/components/drawers/GoalDrawer.svelte

>>> FILE_START: src/components/drawers/InterfaceDrawer.svelte
<script>
    import { drawerState, interfaceSettings } from '../../stores.js';
    // [FIX] C·∫≠p nh·∫≠t ƒë∆∞·ªùng d·∫´n settings service
    import { settingsService } from '../../services/settings.service.js';
    import { onMount } from 'svelte';

    // ... (Gi·ªØ nguy√™n ph·∫ßn code c√≤n l·∫°i)
    $: isOpen = $drawerState.activeDrawer === 'interface-drawer';

    function close() {
        drawerState.update(s => ({ ...s, activeDrawer: null }));
    }

    function onContrastChange(event) {
        const level = event.target.value;
        settingsService.updateContrast(level);
    }

    function onSettingChange() {
        settingsService.updateInterface($interfaceSettings);
    }
    
    onMount(() => {
        settingsService.loadInterfaceSettings();
    });
</script>

{#if isOpen}
    <div 
        class="fixed inset-0 bg-black/40 z-40 transition-opacity"
        on:click={close}
        role="button"
        tabindex="0"
    ></div>
{/if}

<div 
    class="fixed top-0 left-0 h-full bg-white shadow-2xl z-50 p-6 overflow-y-auto w-[400px] max-w-[90vw] transition-transform duration-300 ease-in-out transform {isOpen ? 'translate-x-0' : '-translate-x-full'}"
>
    <div class="flex justify-between items-center mb-6">
        <h3 class="text-xl font-bold text-gray-800">C√†i ƒë·∫∑t giao di·ªán</h3>
        <button 
            class="text-gray-500 hover:text-gray-800 text-3xl leading-none"
            on:click={close}
        >&times;</button>
    </div>
    <div class="space-y-6">
        <div>
            <label for="contrast-selector" class="block text-sm font-medium text-gray-700 mb-2">ƒê·ªô t∆∞∆°ng ph·∫£n</label>
            <select 
                id="contrast-selector" 
                class="w-full p-2 border rounded-lg text-sm bg-white shadow-sm focus:ring-2 focus:ring-blue-500 outline-none"
                value={$interfaceSettings.contrastLevel || '3'}
                on:change={onContrastChange}
            >
                <option value="1">R·∫•t nh·∫π</option>
                <option value="2">Nh·∫π</option>
                <option value="3">B√¨nh th∆∞·ªùng</option>
                <option value="4">Cao</option>
                <option value="5">R·∫•t cao</option>
                <option value="6">Cao nh·∫•t</option>
            </select>
        </div>

        <div>
            <label for="global-font-size-slider" class="flex justify-between text-sm font-medium text-gray-700 mb-2">
                <span>C·ª° ch·ªØ to√†n trang</span>
                <span class="font-bold text-blue-600">{$interfaceSettings.globalFontSize}px</span>
            </label>
            <input 
                type="range" 
                id="global-font-size-slider" 
                min="12" max="25" step="1" 
                class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-blue-600"
                bind:value={$interfaceSettings.globalFontSize}
                on:input={onSettingChange}
            >
        </div>

        <div>
             <label for="kpi-font-size-slider" class="flex justify-between text-sm font-medium text-gray-700 mb-2">
                <span>C·ª° ch·ªØ th·∫ª KPI</span>
                <span class="font-bold text-blue-600">{$interfaceSettings.kpiFontSize}px</span>
            </label>
            <input 
                type="range" 
                id="kpi-font-size-slider" 
                min="24" max="48" step="2" 
                class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-blue-600"
                bind:value={$interfaceSettings.kpiFontSize}
                on:input={onSettingChange}
            >
        </div>

        <div>
            <h4 class="text-sm font-medium text-gray-700 mb-2">M√†u s·∫Øc th·∫ª KPI</h4>
            <div class="grid grid-cols-2 gap-4">
                {#each [1, 2, 3, 4, 5, 6, 7, 8] as num}
                    <div class="flex items-center gap-2">
                        <input 
                            type="color" 
                            id="kpi-color-{num}" 
                            class="p-1 h-10 w-14 block bg-white border border-gray-300 cursor-pointer rounded-lg"
                            bind:value={$interfaceSettings[`kpiCard${num}Bg`]}
                            on:input={onSettingChange}
                        >
                        <label for="kpi-color-{num}" class="text-sm">Th·∫ª {num}</label>
                    </div>
                {/each}
            </div>
        </div>

        <div>
            <h4 class="text-sm font-medium text-gray-700 mb-2">M√†u ch·ªØ th·∫ª KPI</h4>
             <div class="space-y-2">
                 <div class="flex items-center gap-2">
                    <input 
                        type="color" 
                        id="kpi-title-color" 
                        class="p-1 h-10 w-14 block bg-white border border-gray-300 cursor-pointer rounded-lg"
                        bind:value={$interfaceSettings.kpiTitleColor}
                        on:input={onSettingChange}
                    >
                    <label for="kpi-title-color" class="text-sm">Ti√™u ƒë·ªÅ th·∫ª</label>
                </div>
                <div class="flex items-center gap-2">
                    <input 
                        type="color" 
                        id="kpi-main-color" 
                        class="p-1 h-10 w-14 block bg-white border border-gray-300 cursor-pointer rounded-lg"
                        bind:value={$interfaceSettings.kpiMainColor}
                        on:input={onSettingChange}
                    >
                    <label for="kpi-main-color" class="text-sm">Gi√° tr·ªã ch√≠nh</label>
                </div>
                <div class="flex items-center gap-2">
                    <input 
                        type="color" 
                        id="kpi-sub-color" 
                        class="p-1 h-10 w-14 block bg-white border border-gray-300 cursor-pointer rounded-lg"
                        bind:value={$interfaceSettings.kpiSubColor}
                        on:input={onSettingChange}
                    >
                    <label for="kpi-sub-color" class="text-sm">Gi√° tr·ªã ph·ª•</label>
                </div>
            </div>
        </div>
    </div>
</div>
<<< FILE_END: src/components/drawers/InterfaceDrawer.svelte
